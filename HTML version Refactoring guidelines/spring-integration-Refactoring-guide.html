<!DOCTYPE html>
<html>
<head>
<title>spring-integration-Refactoring-guide.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="a-guide-to-refactoring-mock-clones-in-spring-integration">A guide to Refactoring mock clones in spring-integration</h1>
<h2 id="mock-clone-instance-spring-integrationmci1">Mock Clone Instance #spring-integration_MCI_1</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.file.remote.session.SessionFactory</code></li>
<li><strong>Test Case Count</strong>: 12</li>
<li><strong>MO Count</strong>: 12</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest11">Test Case ID #spring-integration_Test_1_1</h4>
<h4 id="test-case-name-testls1dirsfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_1_dirs</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testLs_1_dirs() throws Exception {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
     Session session = mock(Session.class);
<span class="hljs-deletion">-    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");</span>
<span class="hljs-deletion">-    gw.setOptions("-1 -dirs");</span>
<span class="hljs-deletion">-    gw.afterPropertiesSet();</span>
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(session);</span>
<span class="hljs-addition">+    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");</span>
<span class="hljs-addition">+    gw.setOptions("-1 -dirs");</span>
<span class="hljs-addition">+    gw.afterPropertiesSet();</span>
     TestLsEntry[] files = fileList();
     when(session.list("testremote/")).thenReturn(files);
     @SuppressWarnings("unchecked")
     MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote"));
     assertThat(out.getPayload()).hasSize(3);
     assertThat(out.getPayload().get(0)).isEqualTo("f1");
     assertThat(out.getPayload().get(1)).isEqualTo("f2");
     assertThat(out.getPayload().get(2)).isEqualTo("f3");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_1_dirs</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.setOptions(<span class="hljs-string">"-1 -dirs"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] files = fileList();

    when(session.list(<span class="hljs-string">"testremote/"</span>)).thenReturn(files);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote"</span>));

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">3</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>)).isEqualTo(<span class="hljs-string">"f1"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">1</span>)).isEqualTo(<span class="hljs-string">"f2"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">2</span>)).isEqualTo(<span class="hljs-string">"f3"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest12">Test Case ID #spring-integration_Test_1_2</h4>
<h4 id="test-case-name-testls1dirslinksfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_1_dirs_links</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testLs_1_dirs_links() throws Exception {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
    Session session = mock(Session.class);
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(session);</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
    gw.setOptions("-1 -dirs -links");
    gw.afterPropertiesSet();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
    TestLsEntry[] files = fileList();
    when(session.list("testremote/")).thenReturn(files);
    @SuppressWarnings("unchecked")
    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote"));
    assertThat(out.getPayload()).hasSize(4);
    assertThat(out.getPayload().get(0)).isEqualTo("f1");
    assertThat(out.getPayload().get(1)).isEqualTo("f2");
    assertThat(out.getPayload().get(2)).isEqualTo("f3");
    assertThat(out.getPayload().get(3)).isEqualTo("f4");
}
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_1_dirs_links</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.setOptions(<span class="hljs-string">"-1 -dirs -links"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] files = fileList();

    when(session.list(<span class="hljs-string">"testremote/"</span>)).thenReturn(files);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote"</span>));

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">4</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>)).isEqualTo(<span class="hljs-string">"f1"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">1</span>)).isEqualTo(<span class="hljs-string">"f2"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">2</span>)).isEqualTo(<span class="hljs-string">"f3"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">3</span>)).isEqualTo(<span class="hljs-string">"f4"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest13">Test Case ID #spring-integration_Test_1_3</h4>
<h4 id="test-case-name-testls1afdirslinksfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_1_a_f_dirs_links</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testLs_1_a_f_dirs_links() throws Exception {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
     Session session = mock(Session.class);
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(session);</span>
     TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
     gw.setOptions("-1 -a -f -dirs -links");
     gw.afterPropertiesSet();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
     TestLsEntry[] files = fileList();
     when(session.list("testremote/")).thenReturn(files);
     @SuppressWarnings("unchecked")
     MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote"));
     assertThat(out.getPayload()).hasSize(6);
     assertThat(out.getPayload().get(0)).isEqualTo("f2");
     assertThat(out.getPayload().get(1)).isEqualTo("f1");
     assertThat(out.getPayload().get(2)).isEqualTo("f3");
     assertThat(out.getPayload().get(3)).isEqualTo("f4");
     assertThat(out.getPayload().get(4)).isEqualTo(".f5");
     assertThat(out.getPayload().get(5)).isEqualTo(".f6");
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_1_a_f_dirs_links</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.setOptions(<span class="hljs-string">"-1 -a -f -dirs -links"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] files = fileList();

    when(session.list(<span class="hljs-string">"testremote/"</span>)).thenReturn(files);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote"</span>));

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">6</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>)).isEqualTo(<span class="hljs-string">"f2"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">1</span>)).isEqualTo(<span class="hljs-string">"f1"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">2</span>)).isEqualTo(<span class="hljs-string">"f3"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">3</span>)).isEqualTo(<span class="hljs-string">"f4"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">4</span>)).isEqualTo(<span class="hljs-string">".f5"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">5</span>)).isEqualTo(<span class="hljs-string">".f6"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest14">Test Case ID #spring-integration_Test_1_4</h4>
<h4 id="test-case-name-testlsfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testLs() throws Exception {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
     Session session = mock(Session.class);
<span class="hljs-deletion">-    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");</span>
<span class="hljs-deletion">-    gw.afterPropertiesSet();</span>
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(session);</span>
<span class="hljs-addition">+    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");</span>
<span class="hljs-addition">+    gw.afterPropertiesSet();</span>
     TestLsEntry[] files = fileList();
     when(session.list("testremote/x/")).thenReturn(files);
     @SuppressWarnings("unchecked")
     MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote/x"));
     assertThat(out).isNotNull();
     assertThat(out.getPayload()).hasSize(2);
     // sort by default
     assertThat(out.getPayload().get(0)).isSameAs(files[1]);
     assertThat(out.getPayload().get(1)).isSameAs(files[0]);
     assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo("testremote/x/");
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] files = fileList();

    when(session.list(<span class="hljs-string">"testremote/x/"</span>)).thenReturn(files);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote/x"</span>));

    assertThat(out).isNotNull();

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">2</span>);

    <span class="hljs-comment">// sort by default</span>

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>)).isSameAs(files[<span class="hljs-number">1</span>]);

    assertThat(out.getPayload().get(<span class="hljs-number">1</span>)).isSameAs(files[<span class="hljs-number">0</span>]);

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo(<span class="hljs-string">"testremote/x/"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest15">Test Case ID #spring-integration_Test_1_5</h4>
<h4 id="test-case-name-testls1afdirslinksfilteredfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_1_a_f_dirs_links_filtered</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testLs_1_a_f_dirs_links_filtered() throws Exception {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
     Session session = mock(Session.class);
     TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
     gw.setOptions("-1 -a -f -dirs -links");
     gw.setFilter(new TestPatternFilter("*4"));
     gw.afterPropertiesSet();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(session);</span>
     TestLsEntry[] files = fileList();
     when(session.list("testremote/")).thenReturn(files);
     @SuppressWarnings("unchecked")
     MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote"));
     assertThat(out.getPayload()).hasSize(1);
     assertThat(out.getPayload().get(0)).isEqualTo("f4");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_1_a_f_dirs_links_filtered</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.setOptions(<span class="hljs-string">"-1 -a -f -dirs -links"</span>);

    gw.setFilter(<span class="hljs-keyword">new</span> TestPatternFilter(<span class="hljs-string">"*4"</span>));

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] files = fileList();

    when(session.list(<span class="hljs-string">"testremote/"</span>)).thenReturn(files);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote"</span>));

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">1</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>)).isEqualTo(<span class="hljs-string">"f4"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest16">Test Case ID #spring-integration_Test_1_6</h4>
<h4 id="test-case-name-testrmfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testRm</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testRm() throws Exception {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
     Session session = mock(Session.class);
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(session);</span>
     TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "rm", "payload");
     gw.afterPropertiesSet();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
     when(session.remove("testremote/x/f1")).thenReturn(Boolean.TRUE);
     @SuppressWarnings("unchecked")
     MessageBuilder&lt;Boolean&gt; out = (MessageBuilder&lt;Boolean&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote/x/f1"));
     assertThat(out.getPayload()).isTrue();
     verify(session).remove("testremote/x/f1");
     assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo("testremote/x/");
     assertThat(out.getHeaders().get(FileHeaders.REMOTE_FILE)).isEqualTo("f1");
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRm</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"rm"</span>, <span class="hljs-string">"payload"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    when(session.remove(<span class="hljs-string">"testremote/x/f1"</span>)).thenReturn(Boolean.TRUE);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;Boolean&gt; out = (MessageBuilder&lt;Boolean&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote/x/f1"</span>));

    assertThat(out.getPayload()).isTrue();

    verify(session).remove(<span class="hljs-string">"testremote/x/f1"</span>);

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo(<span class="hljs-string">"testremote/x/"</span>);

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_FILE)).isEqualTo(<span class="hljs-string">"f1"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest17">Test Case ID #spring-integration_Test_1_7</h4>
<h4 id="test-case-name-testlsffile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_f</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testLs_f() throws Exception {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
    Session session = mock(Session.class);
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(session);</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
    gw.setOptions("-f");
    gw.afterPropertiesSet();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
    TestLsEntry[] files = fileList();
    when(session.list("testremote/x/")).thenReturn(files);
    @SuppressWarnings("unchecked")
    MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote/x"));
    assertThat(out).isNotNull();
    assertThat(out.getPayload()).hasSize(2);
    assertThat(out.getPayload().get(0)).isSameAs(files[0]);
    assertThat(out.getPayload().get(1)).isSameAs(files[1]);
    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo("testremote/x/");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_f</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.setOptions(<span class="hljs-string">"-f"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] files = fileList();

    when(session.list(<span class="hljs-string">"testremote/x/"</span>)).thenReturn(files);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote/x"</span>));

    assertThat(out).isNotNull();

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">2</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>)).isSameAs(files[<span class="hljs-number">0</span>]);

    assertThat(out.getPayload().get(<span class="hljs-number">1</span>)).isSameAs(files[<span class="hljs-number">1</span>]);

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo(<span class="hljs-string">"testremote/x/"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest18">Test Case ID #spring-integration_Test_1_8</h4>
<h4 id="test-case-name-testlsfrfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_f_R</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testLs_f_R() throws Exception {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
     Session session = mock(Session.class);
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(session);</span>
     TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
     gw.setOptions("-f -R");
     gw.afterPropertiesSet();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
     TestLsEntry[] level1 = level1List();
     TestLsEntry[] level2 = level2List();
     TestLsEntry[] level3 = level3List();
     when(session.list("testremote/x/")).thenReturn(level1);
     when(session.list("testremote/x/d1/")).thenReturn(level2);
     when(session.list("testremote/x/d1/d2/")).thenReturn(level3);
     @SuppressWarnings("unchecked")
     MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote/x"));
     assertThat(out).isNotNull();
     assertThat(out.getPayload()).hasSize(4);
     assertThat(out.getPayload().get(0).getFilename()).isEqualTo("f1");
     assertThat(out.getPayload().get(1).getFilename()).isEqualTo("d1/d2/f4");
     assertThat(out.getPayload().get(2).getFilename()).isEqualTo("d1/f3");
     assertThat(out.getPayload().get(3).getFilename()).isEqualTo("f2");
     assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo("testremote/x/");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_f_R</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.setOptions(<span class="hljs-string">"-f -R"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] level1 = level1List();

    TestLsEntry[] level2 = level2List();

    TestLsEntry[] level3 = level3List();

    when(session.list(<span class="hljs-string">"testremote/x/"</span>)).thenReturn(level1);

    when(session.list(<span class="hljs-string">"testremote/x/d1/"</span>)).thenReturn(level2);

    when(session.list(<span class="hljs-string">"testremote/x/d1/d2/"</span>)).thenReturn(level3);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote/x"</span>));

    assertThat(out).isNotNull();

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">4</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>).getFilename()).isEqualTo(<span class="hljs-string">"f1"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">1</span>).getFilename()).isEqualTo(<span class="hljs-string">"d1/d2/f4"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">2</span>).getFilename()).isEqualTo(<span class="hljs-string">"d1/f3"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">3</span>).getFilename()).isEqualTo(<span class="hljs-string">"f2"</span>);

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo(<span class="hljs-string">"testremote/x/"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest19">Test Case ID #spring-integration_Test_1_9</h4>
<h4 id="test-case-name-testlsfrdirsfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_f_R_dirs</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testLs_f_R_dirs() throws Exception {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
    Session session = mock(Session.class);
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(session);</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
    gw.setOptions("-f -R -dirs");
    gw.afterPropertiesSet();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
    TestLsEntry[] level1 = level1List();
    TestLsEntry[] level2 = level2List();
    TestLsEntry[] level3 = level3List();
    when(session.list("testremote/x/")).thenReturn(level1);
    when(session.list("testremote/x/d1/")).thenReturn(level2);
    when(session.list("testremote/x/d1/d2/")).thenReturn(level3);
    @SuppressWarnings("unchecked")
    MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote/x"));
    assertThat(out).isNotNull();
    assertThat(out.getPayload()).hasSize(6);
    assertThat(out.getPayload().get(0).getFilename()).isEqualTo("f1");
    assertThat(out.getPayload().get(1).getFilename()).isEqualTo("d1");
    assertThat(out.getPayload().get(2).getFilename()).isEqualTo("d1/d2");
    assertThat(out.getPayload().get(3).getFilename()).isEqualTo("d1/d2/f4");
    assertThat(out.getPayload().get(4).getFilename()).isEqualTo("d1/f3");
    assertThat(out.getPayload().get(5).getFilename()).isEqualTo("f2");
    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo("testremote/x/");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_f_R_dirs</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.setOptions(<span class="hljs-string">"-f -R -dirs"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] level1 = level1List();

    TestLsEntry[] level2 = level2List();

    TestLsEntry[] level3 = level3List();

    when(session.list(<span class="hljs-string">"testremote/x/"</span>)).thenReturn(level1);

    when(session.list(<span class="hljs-string">"testremote/x/d1/"</span>)).thenReturn(level2);

    when(session.list(<span class="hljs-string">"testremote/x/d1/d2/"</span>)).thenReturn(level3);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote/x"</span>));

    assertThat(out).isNotNull();

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">6</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>).getFilename()).isEqualTo(<span class="hljs-string">"f1"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">1</span>).getFilename()).isEqualTo(<span class="hljs-string">"d1"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">2</span>).getFilename()).isEqualTo(<span class="hljs-string">"d1/d2"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">3</span>).getFilename()).isEqualTo(<span class="hljs-string">"d1/d2/f4"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">4</span>).getFilename()).isEqualTo(<span class="hljs-string">"d1/f3"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">5</span>).getFilename()).isEqualTo(<span class="hljs-string">"f2"</span>);

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo(<span class="hljs-string">"testremote/x/"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest110">Test Case ID #spring-integration_Test_1_10</h4>
<h4 id="test-case-name-testlsnonefile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_None</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testLs_None() throws Exception {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
    Session session = mock(Session.class);
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(session);</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
    gw.afterPropertiesSet();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
    TestLsEntry[] files = new TestLsEntry[0];
    when(session.list("testremote/")).thenReturn(files);
    @SuppressWarnings("unchecked")
    MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote"));
    assertThat(out).isNotNull();
    assertThat(out.getPayload()).hasSize(0);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_None</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] files = <span class="hljs-keyword">new</span> TestLsEntry[<span class="hljs-number">0</span>];

    when(session.list(<span class="hljs-string">"testremote/"</span>)).thenReturn(files);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote"</span>));

    assertThat(out).isNotNull();

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">0</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest111">Test Case ID #spring-integration_Test_1_11</h4>
<h4 id="test-case-name-testls1file-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_1</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testLs_1() throws Exception {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
    Session session = mock(Session.class);
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
    gw.setOptions("-1");
    gw.afterPropertiesSet();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(session);</span>
    TestLsEntry[] files = fileList();
    when(session.list("testremote/")).thenReturn(files);
    @SuppressWarnings("unchecked")
    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote"));
    assertThat(out).isNotNull();
    assertThat(out.getPayload()).hasSize(2);
    assertThat(out.getPayload().get(0)).isEqualTo("f1");
    assertThat(out.getPayload().get(1)).isEqualTo("f2");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.setOptions(<span class="hljs-string">"-1"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] files = fileList();

    when(session.list(<span class="hljs-string">"testremote/"</span>)).thenReturn(files);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote"</span>));

    assertThat(out).isNotNull();

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">2</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>)).isEqualTo(<span class="hljs-string">"f1"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">1</span>)).isEqualTo(<span class="hljs-string">"f2"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest112">Test Case ID #spring-integration_Test_1_12</h4>
<h4 id="test-case-name-testls1ffile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_1_f</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testLs_1_f() throws Exception {
<span class="hljs-deletion">-    //no sort</span>
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
<span class="hljs-addition">+    //no sort</span>
     Session session = mock(Session.class);
     TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
     gw.setOptions("-1 -f");
     gw.afterPropertiesSet();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(session);</span>
     TestLsEntry[] files = fileList();
     when(session.list("testremote/")).thenReturn(files);
     @SuppressWarnings("unchecked")
     MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote"));
     assertThat(out.getPayload()).hasSize(2);
     assertThat(out.getPayload().get(0)).isEqualTo("f2");
     assertThat(out.getPayload().get(1)).isEqualTo("f1");
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_1_f</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-comment">//no sort</span>

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.setOptions(<span class="hljs-string">"-1 -f"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] files = fileList();

    when(session.list(<span class="hljs-string">"testremote/"</span>)).thenReturn(files);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote"</span>));

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">2</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>)).isEqualTo(<span class="hljs-string">"f2"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">1</span>)).isEqualTo(<span class="hljs-string">"f1"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci2">Mock Clone Instance #spring-integration_MCI_2</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.file.remote.session.SessionFactory</code></li>
<li><strong>Test Case Count</strong>: 8</li>
<li><strong>MO Count</strong>: 8</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest21">Test Case ID #spring-integration_Test_2_1</h4>
<h4 id="test-case-name-testmgetwildgutsfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testMGetWildGuts</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
private void testMGetWildGuts(final String path1, final String path2) {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
<span class="hljs-addition">+    Session session = new TestSession() {</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+        int n;</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+        @Override</span>
<span class="hljs-addition">+        public void read(String source, OutputStream outputStream) throws IOException {</span>
<span class="hljs-addition">+            if (n++ == 0) {</span>
<span class="hljs-addition">+                assertThat(source).isEqualTo("testremote/f1");</span>
<span class="hljs-addition">+            } else {</span>
<span class="hljs-addition">+                assertThat(source).isEqualTo("testremote/f2");</span>
<span class="hljs-addition">+            }</span>
<span class="hljs-addition">+            outputStream.write("testData".getBytes());</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+        @Override</span>
<span class="hljs-addition">+        public TestLsEntry[] list(String path) {</span>
<span class="hljs-addition">+            return new TestLsEntry[] { new TestLsEntry(path1.replaceFirst("testremote/", ""), 123, false, false, 1234, "-r--r--r--"), new TestLsEntry(path2.replaceFirst("testremote/", ""), 123, false, false, 1234, "-r--r--r--") };</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+    };</span>
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(session);</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "mget", "payload");
    gw.setLocalDirectory(new File(this.tmpDir));
    gw.afterPropertiesSet();
    new File(this.tmpDir + "/f1").delete();
    new File(this.tmpDir + "/f2").delete();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(new TestSession() {</span>
<span class="hljs-deletion">-</span>
<span class="hljs-deletion">-        int n;</span>
<span class="hljs-deletion">-</span>
<span class="hljs-deletion">-        @Override</span>
<span class="hljs-deletion">-        public void read(String source, OutputStream outputStream) throws IOException {</span>
<span class="hljs-deletion">-            if (n++ == 0) {</span>
<span class="hljs-deletion">-                assertThat(source).isEqualTo("testremote/f1");</span>
<span class="hljs-deletion">-            } else {</span>
<span class="hljs-deletion">-                assertThat(source).isEqualTo("testremote/f2");</span>
<span class="hljs-deletion">-            }</span>
<span class="hljs-deletion">-            outputStream.write("testData".getBytes());</span>
<span class="hljs-deletion">-        }</span>
<span class="hljs-deletion">-</span>
<span class="hljs-deletion">-        @Override</span>
<span class="hljs-deletion">-        public TestLsEntry[] list(String path) {</span>
<span class="hljs-deletion">-            return new TestLsEntry[] { new TestLsEntry(path1.replaceFirst("testremote/", ""), 123, false, false, 1234, "-r--r--r--"), new TestLsEntry(path2.replaceFirst("testremote/", ""), 123, false, false, 1234, "-r--r--r--") };</span>
<span class="hljs-deletion">-        }</span>
<span class="hljs-deletion">-    });</span>
    @SuppressWarnings("unchecked")
    MessageBuilder&lt;List&lt;File&gt;&gt; out = (MessageBuilder&lt;List&lt;File&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote/*"));
    assertThat(out).isNotNull();
    assertThat(out.getPayload()).hasSize(2);
    assertThat(out.getPayload().get(0).getName()).isEqualTo("f1");
    assertThat(out.getPayload().get(1).getName()).isEqualTo("f2");
    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo("testremote/");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMGetWildGuts</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String path1, <span class="hljs-keyword">final</span> String path2)</span> </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"mget"</span>, <span class="hljs-string">"payload"</span>);

    gw.setLocalDirectory(<span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir));

    gw.afterPropertiesSet();

    <span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir + <span class="hljs-string">"/f1"</span>).delete();

    <span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir + <span class="hljs-string">"/f2"</span>).delete();

    when(sessionFactory.getSession()).thenReturn(<span class="hljs-keyword">new</span> TestSession() {



        <span class="hljs-keyword">int</span> n;



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">read</span><span class="hljs-params">(String source, OutputStream outputStream)</span> <span class="hljs-keyword">throws</span> IOException </span>{

            <span class="hljs-keyword">if</span> (n++ == <span class="hljs-number">0</span>) {

                assertThat(source).isEqualTo(<span class="hljs-string">"testremote/f1"</span>);

            } <span class="hljs-keyword">else</span> {

                assertThat(source).isEqualTo(<span class="hljs-string">"testremote/f2"</span>);

            }

            outputStream.write(<span class="hljs-string">"testData"</span>.getBytes());

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> TestLsEntry[] list(String path) {

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TestLsEntry[] { <span class="hljs-keyword">new</span> TestLsEntry(path1.replaceFirst(<span class="hljs-string">"testremote/"</span>, <span class="hljs-string">""</span>), <span class="hljs-number">123</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">1234</span>, <span class="hljs-string">"-r--r--r--"</span>), <span class="hljs-keyword">new</span> TestLsEntry(path2.replaceFirst(<span class="hljs-string">"testremote/"</span>, <span class="hljs-string">""</span>), <span class="hljs-number">123</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">1234</span>, <span class="hljs-string">"-r--r--r--"</span>) };

        }

    });

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;File&gt;&gt; out = (MessageBuilder&lt;List&lt;File&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote/*"</span>));

    assertThat(out).isNotNull();

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">2</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>).getName()).isEqualTo(<span class="hljs-string">"f1"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">1</span>).getName()).isEqualTo(<span class="hljs-string">"f2"</span>);

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo(<span class="hljs-string">"testremote/"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest22">Test Case ID #spring-integration_Test_2_2</h4>
<h4 id="test-case-name-testgetfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testGet</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testGet() {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
<span class="hljs-addition">+    Session session = new TestSession() {</span>
<span class="hljs-addition">+        @Override</span>
<span class="hljs-addition">+        public TestLsEntry[] list(String path) {</span>
<span class="hljs-addition">+            return new TestLsEntry[] { new TestLsEntry("f1", 1234, false, false, 12345, "-rw-r--r--") };</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+        @Override</span>
<span class="hljs-addition">+        public void read(String source, OutputStream outputStream) throws IOException {</span>
<span class="hljs-addition">+            outputStream.write("testfile".getBytes());</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+    };</span>
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(session);</span>
     TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "get", "payload");
     gw.setLocalDirectory(new File(this.tmpDir));
     gw.afterPropertiesSet();
     new File(this.tmpDir + "/f1").delete();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(new TestSession() {</span>
<span class="hljs-deletion">-</span>
<span class="hljs-deletion">-        @Override</span>
<span class="hljs-deletion">-        public TestLsEntry[] list(String path) {</span>
<span class="hljs-deletion">-            return new TestLsEntry[] { new TestLsEntry("f1", 1234, false, false, 12345, "-rw-r--r--") };</span>
<span class="hljs-deletion">-        }</span>
<span class="hljs-deletion">-</span>
<span class="hljs-deletion">-        @Override</span>
<span class="hljs-deletion">-        public void read(String source, OutputStream outputStream) throws IOException {</span>
<span class="hljs-deletion">-            outputStream.write("testfile".getBytes());</span>
<span class="hljs-deletion">-        }</span>
<span class="hljs-deletion">-    });</span>
     @SuppressWarnings("unchecked")
     MessageBuilder&lt;File&gt; out = (MessageBuilder&lt;File&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("f1"));
     File outFile = new File(this.tmpDir + "/f1");
     assertThat(out.getPayload()).isEqualTo(outFile);
     assertThat(outFile.exists()).isTrue();
     outFile.delete();
     assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isNull();
     assertThat(out.getHeaders().get(FileHeaders.REMOTE_FILE)).isEqualTo("f1");
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGet</span><span class="hljs-params">()</span> </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"get"</span>, <span class="hljs-string">"payload"</span>);

    gw.setLocalDirectory(<span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir));

    gw.afterPropertiesSet();

    <span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir + <span class="hljs-string">"/f1"</span>).delete();

    when(sessionFactory.getSession()).thenReturn(<span class="hljs-keyword">new</span> TestSession() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> TestLsEntry[] list(String path) {

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TestLsEntry[] { <span class="hljs-keyword">new</span> TestLsEntry(<span class="hljs-string">"f1"</span>, <span class="hljs-number">1234</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">12345</span>, <span class="hljs-string">"-rw-r--r--"</span>) };

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">read</span><span class="hljs-params">(String source, OutputStream outputStream)</span> <span class="hljs-keyword">throws</span> IOException </span>{

            outputStream.write(<span class="hljs-string">"testfile"</span>.getBytes());

        }

    });

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;File&gt; out = (MessageBuilder&lt;File&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"f1"</span>));

    File outFile = <span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir + <span class="hljs-string">"/f1"</span>);

    assertThat(out.getPayload()).isEqualTo(outFile);

    assertThat(outFile.exists()).isTrue();

    outFile.delete();

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isNull();

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_FILE)).isEqualTo(<span class="hljs-string">"f1"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest23">Test Case ID #spring-integration_Test_2_3</h4>
<h4 id="test-case-name-testmgetsinglefile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testMGetSingle</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(new TestSession() {</span>
<span class="hljs-addition">+        @Override</span>
<span class="hljs-addition">+        public void read(String source, OutputStream outputStream) throws IOException {</span>
<span class="hljs-addition">+            outputStream.write("testData".getBytes());</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+        @Override</span>
<span class="hljs-addition">+        public TestLsEntry[] list(String path) {</span>
<span class="hljs-addition">+            return new TestLsEntry[] { new TestLsEntry("f1", 123, false, false, 1234, "-r--r--r--") };</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+    });</span>
     TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "mget", "payload");
     gw.setLocalDirectory(new File(this.tmpDir));
     gw.afterPropertiesSet();
     new File(this.tmpDir + "/f1").delete();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(new TestSession() {</span>
<span class="hljs-deletion">-</span>
<span class="hljs-deletion">-        @Override</span>
<span class="hljs-deletion">-        public void read(String source, OutputStream outputStream) throws IOException {</span>
<span class="hljs-deletion">-            outputStream.write("testData".getBytes());</span>
<span class="hljs-deletion">-        }</span>
<span class="hljs-deletion">-</span>
<span class="hljs-deletion">-        @Override</span>
<span class="hljs-deletion">-        public TestLsEntry[] list(String path) {</span>
<span class="hljs-deletion">-            return new TestLsEntry[] { new TestLsEntry("f1", 123, false, false, 1234, "-r--r--r--") };</span>
<span class="hljs-deletion">-        }</span>
<span class="hljs-deletion">-    });</span>
     @SuppressWarnings("unchecked")
     MessageBuilder&lt;List&lt;File&gt;&gt; out = (MessageBuilder&lt;List&lt;File&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote/f1"));
     assertThat(out).isNotNull();
     assertThat(out.getPayload()).hasSize(1);
     assertThat(out.getPayload().get(0).getName()).isEqualTo("f1");
     assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo("testremote/");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMGetSingle</span><span class="hljs-params">()</span> </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"mget"</span>, <span class="hljs-string">"payload"</span>);

    gw.setLocalDirectory(<span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir));

    gw.afterPropertiesSet();

    <span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir + <span class="hljs-string">"/f1"</span>).delete();

    when(sessionFactory.getSession()).thenReturn(<span class="hljs-keyword">new</span> TestSession() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">read</span><span class="hljs-params">(String source, OutputStream outputStream)</span> <span class="hljs-keyword">throws</span> IOException </span>{

            outputStream.write(<span class="hljs-string">"testData"</span>.getBytes());

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> TestLsEntry[] list(String path) {

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TestLsEntry[] { <span class="hljs-keyword">new</span> TestLsEntry(<span class="hljs-string">"f1"</span>, <span class="hljs-number">123</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">1234</span>, <span class="hljs-string">"-r--r--r--"</span>) };

        }

    });

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;File&gt;&gt; out = (MessageBuilder&lt;List&lt;File&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote/f1"</span>));

    assertThat(out).isNotNull();

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">1</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>).getName()).isEqualTo(<span class="hljs-string">"f1"</span>);

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo(<span class="hljs-string">"testremote/"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest24">Test Case ID #spring-integration_Test_2_4</h4>
<h4 id="test-case-name-testgetexistsfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testGetExists</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @SuppressWarnings("unchecked")
 @Test
 public void testGetExists() throws Exception {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(new TestSession() {</span>
<span class="hljs-addition">+        @Override</span>
<span class="hljs-addition">+        public TestLsEntry[] list(String path) {</span>
<span class="hljs-addition">+            return new TestLsEntry[] { new TestLsEntry("f1", 1234, false, false, 12345, "-rw-r--r--") };</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+        @Override</span>
<span class="hljs-addition">+        public void read(String source, OutputStream outputStream) throws IOException {</span>
<span class="hljs-addition">+            outputStream.write("testfile".getBytes());</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+    });</span>
     TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "get", "payload");
     gw.setLocalDirectory(new File(this.tmpDir));
     gw.afterPropertiesSet();
     File outFile = new File(this.tmpDir + "/f1");
     FileOutputStream fos = new FileOutputStream(outFile);
     fos.write("foo".getBytes());
     fos.close();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(new TestSession() {</span>
<span class="hljs-deletion">-</span>
<span class="hljs-deletion">-        @Override</span>
<span class="hljs-deletion">-        public TestLsEntry[] list(String path) {</span>
<span class="hljs-deletion">-            return new TestLsEntry[] { new TestLsEntry("f1", 1234, false, false, 12345, "-rw-r--r--") };</span>
<span class="hljs-deletion">-        }</span>
<span class="hljs-deletion">-</span>
<span class="hljs-deletion">-        @Override</span>
<span class="hljs-deletion">-        public void read(String source, OutputStream outputStream) throws IOException {</span>
<span class="hljs-deletion">-            outputStream.write("testfile".getBytes());</span>
<span class="hljs-deletion">-        }</span>
<span class="hljs-deletion">-    });</span>
     // default (null)
     MessageBuilder&lt;File&gt; out;
     assertThatExceptionOfType(MessageHandlingException.class).isThrownBy(() -&gt; gw.handleRequestMessage(new GenericMessage&lt;&gt;("f1"))).withMessageContaining("already exists");
     gw.setFileExistsMode(FileExistsMode.FAIL);
     assertThatExceptionOfType(MessageHandlingException.class).isThrownBy(() -&gt; gw.handleRequestMessage(new GenericMessage&lt;&gt;("f1"))).withMessageContaining("already exists");
     gw.setFileExistsMode(FileExistsMode.IGNORE);
     out = (MessageBuilder&lt;File&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("f1"));
     assertThat(out.getPayload()).isEqualTo(outFile);
     assertContents("foo", outFile);
     gw.setFileExistsMode(FileExistsMode.APPEND);
     out = (MessageBuilder&lt;File&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("f1"));
     assertThat(out.getPayload()).isEqualTo(outFile);
     assertContents("footestfile", outFile);
     gw.setFileExistsMode(FileExistsMode.REPLACE);
     out = (MessageBuilder&lt;File&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("f1"));
     assertThat(out.getPayload()).isEqualTo(outFile);
     assertContents("testfile", outFile);
     outFile.delete();
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetExists</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"get"</span>, <span class="hljs-string">"payload"</span>);

    gw.setLocalDirectory(<span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir));

    gw.afterPropertiesSet();

    File outFile = <span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir + <span class="hljs-string">"/f1"</span>);

    FileOutputStream fos = <span class="hljs-keyword">new</span> FileOutputStream(outFile);

    fos.write(<span class="hljs-string">"foo"</span>.getBytes());

    fos.close();

    when(sessionFactory.getSession()).thenReturn(<span class="hljs-keyword">new</span> TestSession() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> TestLsEntry[] list(String path) {

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TestLsEntry[] { <span class="hljs-keyword">new</span> TestLsEntry(<span class="hljs-string">"f1"</span>, <span class="hljs-number">1234</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">12345</span>, <span class="hljs-string">"-rw-r--r--"</span>) };

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">read</span><span class="hljs-params">(String source, OutputStream outputStream)</span> <span class="hljs-keyword">throws</span> IOException </span>{

            outputStream.write(<span class="hljs-string">"testfile"</span>.getBytes());

        }

    });

    <span class="hljs-comment">// default (null)</span>

    MessageBuilder&lt;File&gt; out;

    assertThatExceptionOfType(MessageHandlingException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(() -&gt; <span class="hljs-title">gw</span>.<span class="hljs-title">handleRequestMessage</span>(<span class="hljs-title">new</span> <span class="hljs-title">GenericMessage</span>&lt;&gt;("<span class="hljs-title">f1</span>"))).<span class="hljs-title">withMessageContaining</span>("<span class="hljs-title">already</span> <span class="hljs-title">exists</span>")</span>;

    gw.setFileExistsMode(FileExistsMode.FAIL);

    assertThatExceptionOfType(MessageHandlingException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(() -&gt; <span class="hljs-title">gw</span>.<span class="hljs-title">handleRequestMessage</span>(<span class="hljs-title">new</span> <span class="hljs-title">GenericMessage</span>&lt;&gt;("<span class="hljs-title">f1</span>"))).<span class="hljs-title">withMessageContaining</span>("<span class="hljs-title">already</span> <span class="hljs-title">exists</span>")</span>;

    gw.setFileExistsMode(FileExistsMode.IGNORE);

    out = (MessageBuilder&lt;File&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"f1"</span>));

    assertThat(out.getPayload()).isEqualTo(outFile);

    assertContents(<span class="hljs-string">"foo"</span>, outFile);

    gw.setFileExistsMode(FileExistsMode.APPEND);

    out = (MessageBuilder&lt;File&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"f1"</span>));

    assertThat(out.getPayload()).isEqualTo(outFile);

    assertContents(<span class="hljs-string">"footestfile"</span>, outFile);

    gw.setFileExistsMode(FileExistsMode.REPLACE);

    out = (MessageBuilder&lt;File&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"f1"</span>));

    assertThat(out.getPayload()).isEqualTo(outFile);

    assertContents(<span class="hljs-string">"testfile"</span>, outFile);

    outFile.delete();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest25">Test Case ID #spring-integration_Test_2_5</h4>
<h4 id="test-case-name-testmgetemptyfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testMGetEmpty</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testMGetEmpty() {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
     TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "mget", "payload");
     gw.setLocalDirectory(new File(this.tmpDir));
     gw.setOptions("   -x   ");
     gw.afterPropertiesSet();
     new File(this.tmpDir + "/f1").delete();
     new File(this.tmpDir + "/f2").delete();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(new TestSession() {</span>
<span class="hljs-deletion">-</span>
<span class="hljs-deletion">-        @Override</span>
<span class="hljs-deletion">-        public void read(String source, OutputStream outputStream) throws IOException {</span>
<span class="hljs-deletion">-            outputStream.write("testData".getBytes());</span>
<span class="hljs-deletion">-        }</span>
<span class="hljs-deletion">-    });</span>
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(new TestSession() {</span>
<span class="hljs-addition">+        @Override</span>
<span class="hljs-addition">+        public void read(String source, OutputStream outputStream) throws IOException {</span>
<span class="hljs-addition">+            outputStream.write("testData".getBytes());</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+    });</span>
     assertThatExceptionOfType(MessagingException.class).isThrownBy(() -&gt; gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote/*")));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMGetEmpty</span><span class="hljs-params">()</span> </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"mget"</span>, <span class="hljs-string">"payload"</span>);

    gw.setLocalDirectory(<span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir));

    gw.setOptions(<span class="hljs-string">"   -x   "</span>);

    gw.afterPropertiesSet();

    <span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir + <span class="hljs-string">"/f1"</span>).delete();

    <span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir + <span class="hljs-string">"/f2"</span>).delete();

    when(sessionFactory.getSession()).thenReturn(<span class="hljs-keyword">new</span> TestSession() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">read</span><span class="hljs-params">(String source, OutputStream outputStream)</span> <span class="hljs-keyword">throws</span> IOException </span>{

            outputStream.write(<span class="hljs-string">"testData"</span>.getBytes());

        }

    });

    assertThatExceptionOfType(MessagingException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(() -&gt; <span class="hljs-title">gw</span>.<span class="hljs-title">handleRequestMessage</span>(<span class="hljs-title">new</span> <span class="hljs-title">GenericMessage</span>&lt;&gt;("<span class="hljs-title">testremote</span>/*")))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest26">Test Case ID #spring-integration_Test_2_6</h4>
<h4 id="test-case-name-testgetexistsexpressionfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testGetExistsExpression</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 @SuppressWarnings("unchecked")
 public void testGetExistsExpression() throws Exception {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(new TestSession() {</span>
<span class="hljs-addition">+        @Override</span>
<span class="hljs-addition">+        public TestLsEntry[] list(String path) {</span>
<span class="hljs-addition">+            return new TestLsEntry[] { new TestLsEntry("f1", 1234, false, false, 12345, "-rw-r--r--") };</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+        @Override</span>
<span class="hljs-addition">+        public void read(String source, OutputStream outputStream) throws IOException {</span>
<span class="hljs-addition">+            outputStream.write("testfile".getBytes());</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+    });</span>
     TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "get", "payload");
     gw.setFileExistsModeExpressionString("headers[\"file.exists.mode\"]");
     gw.setLocalDirectory(new File(this.tmpDir));
     gw.afterPropertiesSet();
     File outFile = new File(this.tmpDir + "/f1");
     FileOutputStream fos = new FileOutputStream(outFile);
     fos.write("foo".getBytes());
     fos.close();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(new TestSession() {</span>
<span class="hljs-deletion">-</span>
<span class="hljs-deletion">-        @Override</span>
<span class="hljs-deletion">-        public TestLsEntry[] list(String path) {</span>
<span class="hljs-deletion">-            return new TestLsEntry[] { new TestLsEntry("f1", 1234, false, false, 12345, "-rw-r--r--") };</span>
<span class="hljs-deletion">-        }</span>
<span class="hljs-deletion">-</span>
<span class="hljs-deletion">-        @Override</span>
<span class="hljs-deletion">-        public void read(String source, OutputStream outputStream) throws IOException {</span>
<span class="hljs-deletion">-            outputStream.write("testfile".getBytes());</span>
<span class="hljs-deletion">-        }</span>
<span class="hljs-deletion">-    });</span>
     // default (null)
     MessageBuilder&lt;File&gt; out;
     assertThatExceptionOfType(MessageHandlingException.class).isThrownBy(() -&gt; gw.handleRequestMessage(new GenericMessage&lt;&gt;("f1"))).withMessageContaining("already exists");
     assertThatExceptionOfType(MessageHandlingException.class).isThrownBy(() -&gt; gw.handleRequestMessage(new GenericMessage&lt;&gt;("f1", Map.of("file.exists.mode", FileExistsMode.FAIL)))).withMessageContaining("already exists");
     out = (MessageBuilder&lt;File&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("f1", Map.of("file.exists.mode", "IGNORE")));
     assertThat(out.getPayload()).isEqualTo(outFile);
     assertContents("foo", outFile);
     out = (MessageBuilder&lt;File&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("f1", Map.of("file.exists.mode", "append")));
     assertThat(out.getPayload()).isEqualTo(outFile);
     assertContents("footestfile", outFile);
     out = (MessageBuilder&lt;File&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("f1", Map.of("file.exists.mode", FileExistsMode.REPLACE)));
     assertThat(out.getPayload()).isEqualTo(outFile);
     assertContents("testfile", outFile);
     outFile.delete();
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetExistsExpression</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"get"</span>, <span class="hljs-string">"payload"</span>);

    gw.setFileExistsModeExpressionString(<span class="hljs-string">"headers[\"file.exists.mode\"]"</span>);

    gw.setLocalDirectory(<span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir));

    gw.afterPropertiesSet();

    File outFile = <span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir + <span class="hljs-string">"/f1"</span>);

    FileOutputStream fos = <span class="hljs-keyword">new</span> FileOutputStream(outFile);

    fos.write(<span class="hljs-string">"foo"</span>.getBytes());

    fos.close();

    when(sessionFactory.getSession()).thenReturn(<span class="hljs-keyword">new</span> TestSession() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> TestLsEntry[] list(String path) {

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TestLsEntry[] { <span class="hljs-keyword">new</span> TestLsEntry(<span class="hljs-string">"f1"</span>, <span class="hljs-number">1234</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">12345</span>, <span class="hljs-string">"-rw-r--r--"</span>) };

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">read</span><span class="hljs-params">(String source, OutputStream outputStream)</span> <span class="hljs-keyword">throws</span> IOException </span>{

            outputStream.write(<span class="hljs-string">"testfile"</span>.getBytes());

        }

    });

    <span class="hljs-comment">// default (null)</span>

    MessageBuilder&lt;File&gt; out;

    assertThatExceptionOfType(MessageHandlingException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(() -&gt; <span class="hljs-title">gw</span>.<span class="hljs-title">handleRequestMessage</span>(<span class="hljs-title">new</span> <span class="hljs-title">GenericMessage</span>&lt;&gt;("<span class="hljs-title">f1</span>"))).<span class="hljs-title">withMessageContaining</span>("<span class="hljs-title">already</span> <span class="hljs-title">exists</span>")</span>;

    assertThatExceptionOfType(MessageHandlingException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(() -&gt; <span class="hljs-title">gw</span>.<span class="hljs-title">handleRequestMessage</span>(<span class="hljs-title">new</span> <span class="hljs-title">GenericMessage</span>&lt;&gt;("<span class="hljs-title">f1</span>", <span class="hljs-title">Map</span>.<span class="hljs-title">of</span>("<span class="hljs-title">file</span>.<span class="hljs-title">exists</span>.<span class="hljs-title">mode</span>", <span class="hljs-title">FileExistsMode</span>.<span class="hljs-title">FAIL</span>)))).<span class="hljs-title">withMessageContaining</span>("<span class="hljs-title">already</span> <span class="hljs-title">exists</span>")</span>;

    out = (MessageBuilder&lt;File&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"f1"</span>, Map.of(<span class="hljs-string">"file.exists.mode"</span>, <span class="hljs-string">"IGNORE"</span>)));

    assertThat(out.getPayload()).isEqualTo(outFile);

    assertContents(<span class="hljs-string">"foo"</span>, outFile);

    out = (MessageBuilder&lt;File&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"f1"</span>, Map.of(<span class="hljs-string">"file.exists.mode"</span>, <span class="hljs-string">"append"</span>)));

    assertThat(out.getPayload()).isEqualTo(outFile);

    assertContents(<span class="hljs-string">"footestfile"</span>, outFile);

    out = (MessageBuilder&lt;File&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"f1"</span>, Map.of(<span class="hljs-string">"file.exists.mode"</span>, FileExistsMode.REPLACE)));

    assertThat(out.getPayload()).isEqualTo(outFile);

    assertContents(<span class="hljs-string">"testfile"</span>, outFile);

    outFile.delete();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest27">Test Case ID #spring-integration_Test_2_7</h4>
<h4 id="test-case-name-testgetpfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testGet_P</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testGet_P() {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
     TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "get", "payload");
     gw.setLocalDirectory(new File(this.tmpDir));
     gw.setOptions("-P");
     gw.afterPropertiesSet();
     new File(this.tmpDir + "/f1").delete();
     Calendar cal = Calendar.getInstance();
     cal.add(Calendar.MONTH, -1);
     final Date modified = new Date(cal.getTime().getTime() / 1000 * 1000);
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(new TestSession() {</span>
<span class="hljs-deletion">-</span>
<span class="hljs-deletion">-        @Override</span>
<span class="hljs-deletion">-        public TestLsEntry[] list(String path) {</span>
<span class="hljs-deletion">-            return new TestLsEntry[] { new TestLsEntry("f1", 1234, false, false, modified.getTime(), "-rw-r--r--") };</span>
<span class="hljs-deletion">-        }</span>
<span class="hljs-deletion">-</span>
<span class="hljs-deletion">-        @Override</span>
<span class="hljs-deletion">-        public void read(String source, OutputStream outputStream) throws IOException {</span>
<span class="hljs-deletion">-            outputStream.write("testfile".getBytes());</span>
<span class="hljs-deletion">-        }</span>
<span class="hljs-deletion">-    });</span>
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(new TestSession() {</span>
<span class="hljs-addition">+        @Override</span>
<span class="hljs-addition">+        public TestLsEntry[] list(String path) {</span>
<span class="hljs-addition">+            return new TestLsEntry[] { new TestLsEntry("f1", 1234, false, false, modified.getTime(), "-rw-r--r--") };</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+        @Override</span>
<span class="hljs-addition">+        public void read(String source, OutputStream outputStream) throws IOException {</span>
<span class="hljs-addition">+            outputStream.write("testfile".getBytes());</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+    });</span>
     @SuppressWarnings("unchecked")
     MessageBuilder&lt;File&gt; out = (MessageBuilder&lt;File&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("x/f1"));
     File outFile = new File(this.tmpDir + "/f1");
     assertThat(out.getPayload()).isEqualTo(outFile);
     assertThat(outFile.exists()).isTrue();
     assertThat(outFile.lastModified()).isEqualTo(modified.getTime());
     outFile.delete();
     assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo("x/");
     assertThat(out.getHeaders().get(FileHeaders.REMOTE_FILE)).isEqualTo("f1");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGet_P</span><span class="hljs-params">()</span> </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"get"</span>, <span class="hljs-string">"payload"</span>);

    gw.setLocalDirectory(<span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir));

    gw.setOptions(<span class="hljs-string">"-P"</span>);

    gw.afterPropertiesSet();

    <span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir + <span class="hljs-string">"/f1"</span>).delete();

    Calendar cal = Calendar.getInstance();

    cal.add(Calendar.MONTH, -<span class="hljs-number">1</span>);

    <span class="hljs-keyword">final</span> Date modified = <span class="hljs-keyword">new</span> Date(cal.getTime().getTime() / <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span>);

    when(sessionFactory.getSession()).thenReturn(<span class="hljs-keyword">new</span> TestSession() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> TestLsEntry[] list(String path) {

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TestLsEntry[] { <span class="hljs-keyword">new</span> TestLsEntry(<span class="hljs-string">"f1"</span>, <span class="hljs-number">1234</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, modified.getTime(), <span class="hljs-string">"-rw-r--r--"</span>) };

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">read</span><span class="hljs-params">(String source, OutputStream outputStream)</span> <span class="hljs-keyword">throws</span> IOException </span>{

            outputStream.write(<span class="hljs-string">"testfile"</span>.getBytes());

        }

    });

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;File&gt; out = (MessageBuilder&lt;File&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"x/f1"</span>));

    File outFile = <span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir + <span class="hljs-string">"/f1"</span>);

    assertThat(out.getPayload()).isEqualTo(outFile);

    assertThat(outFile.exists()).isTrue();

    assertThat(outFile.lastModified()).isEqualTo(modified.getTime());

    outFile.delete();

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo(<span class="hljs-string">"x/"</span>);

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_FILE)).isEqualTo(<span class="hljs-string">"f1"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest28">Test Case ID #spring-integration_Test_2_8</h4>
<h4 id="test-case-name-testgetcreatedirfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testGet_create_dir</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    new File(this.tmpDir + "/x/f1").delete();
    new File(this.tmpDir + "/x").delete();
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(new TestSession() {</span>
<span class="hljs-addition">+        @Override</span>
<span class="hljs-addition">+        public TestLsEntry[] list(String path) {</span>
<span class="hljs-addition">+            return new TestLsEntry[] { new TestLsEntry("f1", 1234, false, false, 12345, "-rw-r--r--") };</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+        @Override</span>
<span class="hljs-addition">+        public void read(String source, OutputStream outputStream) throws IOException {</span>
<span class="hljs-addition">+            outputStream.write("testfile".getBytes());</span>
<span class="hljs-addition">+        }</span>
<span class="hljs-addition">+    });</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "get", "payload");
    gw.setLocalDirectory(new File(this.tmpDir + "/x"));
    gw.afterPropertiesSet();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(new TestSession() {</span>
<span class="hljs-deletion">-</span>
<span class="hljs-deletion">-        @Override</span>
<span class="hljs-deletion">-        public TestLsEntry[] list(String path) {</span>
<span class="hljs-deletion">-            return new TestLsEntry[] { new TestLsEntry("f1", 1234, false, false, 12345, "-rw-r--r--") };</span>
<span class="hljs-deletion">-        }</span>
<span class="hljs-deletion">-</span>
<span class="hljs-deletion">-        @Override</span>
<span class="hljs-deletion">-        public void read(String source, OutputStream outputStream) throws IOException {</span>
<span class="hljs-deletion">-            outputStream.write("testfile".getBytes());</span>
<span class="hljs-deletion">-        }</span>
<span class="hljs-deletion">-    });</span>
    gw.handleRequestMessage(new GenericMessage&lt;&gt;("f1"));
    File out = new File(this.tmpDir + "/x/f1");
    assertThat(out.exists()).isTrue();
    out.delete();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGet_create_dir</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir + <span class="hljs-string">"/x/f1"</span>).delete();

    <span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir + <span class="hljs-string">"/x"</span>).delete();

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"get"</span>, <span class="hljs-string">"payload"</span>);

    gw.setLocalDirectory(<span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir + <span class="hljs-string">"/x"</span>));

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(<span class="hljs-keyword">new</span> TestSession() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> TestLsEntry[] list(String path) {

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TestLsEntry[] { <span class="hljs-keyword">new</span> TestLsEntry(<span class="hljs-string">"f1"</span>, <span class="hljs-number">1234</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">12345</span>, <span class="hljs-string">"-rw-r--r--"</span>) };

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">read</span><span class="hljs-params">(String source, OutputStream outputStream)</span> <span class="hljs-keyword">throws</span> IOException </span>{

            outputStream.write(<span class="hljs-string">"testfile"</span>.getBytes());

        }

    });

    gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"f1"</span>));

    File out = <span class="hljs-keyword">new</span> File(<span class="hljs-keyword">this</span>.tmpDir + <span class="hljs-string">"/x/f1"</span>);

    assertThat(out.exists()).isTrue();

    out.delete();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci3">Mock Clone Instance #spring-integration_MCI_3</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.file.remote.session.SessionFactory</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session&lt;?&gt; session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest31">Test Case ID #spring-integration_Test_3_1</h4>
<h4 id="test-case-name-testmovefile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testMove</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(session);</span>
     TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "mv", "payload");
     gw.afterPropertiesSet();
     Session&lt;?&gt; session = mock(Session.class);
     final AtomicReference&lt;String&gt; args = new AtomicReference&lt;&gt;();
     doAnswer(invocation -&gt; {
         Object[] arguments = invocation.getArguments();
         args.set((String) arguments[0] + arguments[1]);
         return null;
     }).when(session).rename(anyString(), anyString());
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
     Message&lt;String&gt; requestMessage = MessageBuilder.withPayload("foo").setHeader(FileHeaders.RENAME_TO, "bar").build();
     MessageBuilder&lt;?&gt; out = (MessageBuilder&lt;?&gt;) gw.handleRequestMessage(requestMessage);
     assertThat(out.getHeaders().get(FileHeaders.REMOTE_FILE)).isEqualTo("foo");
     assertThat(args.get()).isEqualTo("foobar");
     assertThat(out.getPayload()).isEqualTo(Boolean.TRUE);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMove</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"mv"</span>, <span class="hljs-string">"payload"</span>);

    gw.afterPropertiesSet();

    Session&lt;?&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> AtomicReference&lt;String&gt; args = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    doAnswer(invocation -&gt; {

        Object[] arguments = invocation.getArguments();

        args.set((String) arguments[<span class="hljs-number">0</span>] + arguments[<span class="hljs-number">1</span>]);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(session).rename(anyString(), anyString());

    when(sessionFactory.getSession()).thenReturn(session);

    Message&lt;String&gt; requestMessage = MessageBuilder.withPayload(<span class="hljs-string">"foo"</span>).setHeader(FileHeaders.RENAME_TO, <span class="hljs-string">"bar"</span>).build();

    MessageBuilder&lt;?&gt; out = (MessageBuilder&lt;?&gt;) gw.handleRequestMessage(requestMessage);

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_FILE)).isEqualTo(<span class="hljs-string">"foo"</span>);

    assertThat(args.get()).isEqualTo(<span class="hljs-string">"foobar"</span>);

    assertThat(out.getPayload()).isEqualTo(Boolean.TRUE);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session&lt;?&gt; session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest32">Test Case ID #spring-integration_Test_3_2</h4>
<h4 id="test-case-name-testmovewithexpressionfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testMoveWithExpression</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testMoveWithExpression() throws Exception {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
     TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "mv", "payload");
     gw.setRenameExpression(PARSER.parseExpression("payload.substring(1)"));
     gw.afterPropertiesSet();
     Session&lt;?&gt; session = mock(Session.class);
     final AtomicReference&lt;String&gt; args = new AtomicReference&lt;&gt;();
     doAnswer(invocation -&gt; {
         Object[] arguments = invocation.getArguments();
         args.set((String) arguments[0] + arguments[1]);
         return null;
     }).when(session).rename(anyString(), anyString());
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(session);</span>
     MessageBuilder&lt;?&gt; out = (MessageBuilder&lt;?&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("foo"));
     assertThat(out.getHeaders().get(FileHeaders.RENAME_TO)).isEqualTo("oo");
     assertThat(out.getHeaders().get(FileHeaders.REMOTE_FILE)).isEqualTo("foo");
     assertThat(args.get()).isEqualTo("foooo");
     assertThat(out.getPayload()).isEqualTo(Boolean.TRUE);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMoveWithExpression</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"mv"</span>, <span class="hljs-string">"payload"</span>);

    gw.setRenameExpression(PARSER.parseExpression(<span class="hljs-string">"payload.substring(1)"</span>));

    gw.afterPropertiesSet();

    Session&lt;?&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> AtomicReference&lt;String&gt; args = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    doAnswer(invocation -&gt; {

        Object[] arguments = invocation.getArguments();

        args.set((String) arguments[<span class="hljs-number">0</span>] + arguments[<span class="hljs-number">1</span>]);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(session).rename(anyString(), anyString());

    when(sessionFactory.getSession()).thenReturn(session);

    MessageBuilder&lt;?&gt; out = (MessageBuilder&lt;?&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>));

    assertThat(out.getHeaders().get(FileHeaders.RENAME_TO)).isEqualTo(<span class="hljs-string">"oo"</span>);

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_FILE)).isEqualTo(<span class="hljs-string">"foo"</span>);

    assertThat(args.get()).isEqualTo(<span class="hljs-string">"foooo"</span>);

    assertThat(out.getPayload()).isEqualTo(Boolean.TRUE);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session&lt;?&gt; session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest33">Test Case ID #spring-integration_Test_3_3</h4>
<h4 id="test-case-name-testmovewithmkdirsfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testMoveWithMkDirs</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testMoveWithMkDirs() throws Exception {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
     TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "mv", "payload");
     gw.setRenameExpression(PARSER.parseExpression("'foo/bar/baz'"));
     gw.afterPropertiesSet();
     Session&lt;?&gt; session = mock(Session.class);
     final AtomicReference&lt;String&gt; args = new AtomicReference&lt;&gt;();
     doAnswer(invocation -&gt; {
         Object[] arguments = invocation.getArguments();
         args.set((String) arguments[0] + arguments[1]);
         return null;
     }).when(session).rename(anyString(), anyString());
     final List&lt;String&gt; madeDirs = new ArrayList&lt;&gt;();
     doAnswer(invocation -&gt; {
         madeDirs.add(invocation.getArgument(0));
         return true;
     }).when(session).mkdir(anyString());
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
<span class="hljs-addition">+    SessionFactory sessionFactory = createMockSessionFactory(session);</span>
     Message&lt;String&gt; requestMessage = MessageBuilder.withPayload("foo").setHeader(FileHeaders.RENAME_TO, "bar").build();
     MessageBuilder&lt;?&gt; out = (MessageBuilder&lt;?&gt;) gw.handleRequestMessage(requestMessage);
     assertThat(out.getHeaders().get(FileHeaders.REMOTE_FILE)).isEqualTo("foo");
     assertThat(args.get()).isEqualTo("foofoo/bar/baz");
     assertThat(out.getPayload()).isEqualTo(Boolean.TRUE);
     assertThat(madeDirs.size()).isEqualTo(2);
     assertThat(madeDirs.get(0)).isEqualTo("foo");
     assertThat(madeDirs.get(1)).isEqualTo("foo/bar");
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMoveWithMkDirs</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"mv"</span>, <span class="hljs-string">"payload"</span>);

    gw.setRenameExpression(PARSER.parseExpression(<span class="hljs-string">"'foo/bar/baz'"</span>));

    gw.afterPropertiesSet();

    Session&lt;?&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> AtomicReference&lt;String&gt; args = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    doAnswer(invocation -&gt; {

        Object[] arguments = invocation.getArguments();

        args.set((String) arguments[<span class="hljs-number">0</span>] + arguments[<span class="hljs-number">1</span>]);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(session).rename(anyString(), anyString());

    <span class="hljs-keyword">final</span> List&lt;String&gt; madeDirs = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    doAnswer(invocation -&gt; {

        madeDirs.add(invocation.getArgument(<span class="hljs-number">0</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;

    }).when(session).mkdir(anyString());

    when(sessionFactory.getSession()).thenReturn(session);

    Message&lt;String&gt; requestMessage = MessageBuilder.withPayload(<span class="hljs-string">"foo"</span>).setHeader(FileHeaders.RENAME_TO, <span class="hljs-string">"bar"</span>).build();

    MessageBuilder&lt;?&gt; out = (MessageBuilder&lt;?&gt;) gw.handleRequestMessage(requestMessage);

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_FILE)).isEqualTo(<span class="hljs-string">"foo"</span>);

    assertThat(args.get()).isEqualTo(<span class="hljs-string">"foofoo/bar/baz"</span>);

    assertThat(out.getPayload()).isEqualTo(Boolean.TRUE);

    assertThat(madeDirs.size()).isEqualTo(<span class="hljs-number">2</span>);

    assertThat(madeDirs.get(<span class="hljs-number">0</span>)).isEqualTo(<span class="hljs-string">"foo"</span>);

    assertThat(madeDirs.get(<span class="hljs-number">1</span>)).isEqualTo(<span class="hljs-string">"foo/bar"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session&lt;?&gt; session)</span> </span>{
    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci4">Mock Clone Instance #spring-integration_MCI_4</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.file.remote.session.SessionFactory</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> SessionFactory sessionFactory;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
sessionFactory;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest41">Test Case ID #spring-integration_Test_4_1</h4>
<h4 id="test-case-name-testbadfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testBad</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
@Test
public void testBad() {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `sessionFactory`</span>
    assertThatIllegalArgumentException().isThrownBy(() -&gt; new TestRemoteFileOutboundGateway(sessionFactory, "bad", "payload"));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testBad</span><span class="hljs-params">()</span> </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    assertThatIllegalArgumentException().isThrownBy(() -&gt; <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"bad"</span>, <span class="hljs-string">"payload"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> SessionFactory sessionFactory;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
sessionFactory;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest42">Test Case ID #spring-integration_Test_4_2</h4>
<h4 id="test-case-name-testbadfiltergetfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testBadFilterGet</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
@Test
public void testBadFilterGet() {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `sessionFactory`</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "get", "payload");
    gw.setFilter(new TestPatternFilter(""));
    assertThatIllegalArgumentException().isThrownBy(gw::afterPropertiesSet).withMessageStartingWith("Filters are not supported");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testBadFilterGet</span><span class="hljs-params">()</span> </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"get"</span>, <span class="hljs-string">"payload"</span>);

    gw.setFilter(<span class="hljs-keyword">new</span> TestPatternFilter(<span class="hljs-string">""</span>));

    assertThatIllegalArgumentException().isThrownBy(gw::afterPropertiesSet).withMessageStartingWith(<span class="hljs-string">"Filters are not supported"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> SessionFactory sessionFactory;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
sessionFactory;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest43">Test Case ID #spring-integration_Test_4_3</h4>
<h4 id="test-case-name-testbadfilterrmfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testBadFilterRm</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
@Test
public void testBadFilterRm() {
<span class="hljs-deletion">-    SessionFactory sessionFactory = mock(SessionFactory.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `sessionFactory`</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "rm", "payload");
    gw.setFilter(new TestPatternFilter(""));
    assertThatIllegalArgumentException().isThrownBy(gw::afterPropertiesSet).withMessageStartingWith("Filters are not supported");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testBadFilterRm</span><span class="hljs-params">()</span> </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"rm"</span>, <span class="hljs-string">"payload"</span>);

    gw.setFilter(<span class="hljs-keyword">new</span> TestPatternFilter(<span class="hljs-string">""</span>));

    assertThatIllegalArgumentException().isThrownBy(gw::afterPropertiesSet).withMessageStartingWith(<span class="hljs-string">"Filters are not supported"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> SessionFactory sessionFactory;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
sessionFactory;

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci5">Mock Clone Instance #spring-integration_MCI_5</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.mqtt.core.Mqttv3ClientManager</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Mqttv3ClientManager <span class="hljs-title">createMockMqttv3ClientManager</span><span class="hljs-params">(MqttAsyncClient client)</span> </span>{
    <span class="hljs-keyword">var</span> clientManager = mock(Mqttv3ClientManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(clientManager.getConnectionInfo()).thenReturn(<span class="hljs-keyword">new</span> MqttConnectOptions());
    given(clientManager.getClient()).willReturn(client);
    <span class="hljs-keyword">return</span> clientManager;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest51">Test Case ID #spring-integration_Test_5_1</h4>
<h4 id="test-case-name-testclientmanagerisnotconnectedandclosedinhandlerfile-cjavaprojectsspringspring-integrationspring-integration-mqttsrctestjavaorgspringframeworkintegrationmqttmqttadaptertestsjava">Test Case Name: <code>testClientManagerIsNotConnectedAndClosedInHandler</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mqtt\src\test\java\org\springframework\integration\mqtt\MqttAdapterTests.java</code>)</h4>
<h4 id="mock-object-variable-name-clientmanager">Mock Object Variable Name: <code>clientManager</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    // given
<span class="hljs-deletion">-    var clientManager = mock(Mqttv3ClientManager.class);</span>
<span class="hljs-deletion">-    when(clientManager.getConnectionInfo()).thenReturn(new MqttConnectOptions());</span>
    var client = mock(MqttAsyncClient.class);
<span class="hljs-deletion">-    given(clientManager.getClient()).willReturn(client);</span>
<span class="hljs-addition">+    var clientManager = createMockMqttv3ClientManager(client);</span>
    var deliveryToken = mock(MqttDeliveryToken.class);
    given(client.publish(anyString(), any(), any(), any())).willReturn(deliveryToken);
    var handler = new MqttPahoMessageHandler(clientManager);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testClientManagerIsNotConnectedAndClosedInHandler</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-comment">// given</span>

    <span class="hljs-keyword">var</span> clientManager = mock(Mqttv3ClientManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(clientManager.getConnectionInfo()).thenReturn(<span class="hljs-keyword">new</span> MqttConnectOptions());

    <span class="hljs-keyword">var</span> client = mock(MqttAsyncClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(clientManager.getClient()).willReturn(client);

    <span class="hljs-keyword">var</span> deliveryToken = mock(MqttDeliveryToken<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(client.publish(anyString(), any(), any(), any())).willReturn(deliveryToken);

    <span class="hljs-keyword">var</span> handler = <span class="hljs-keyword">new</span> MqttPahoMessageHandler(clientManager);

    handler.setDefaultTopic(<span class="hljs-string">"mqtt-foo"</span>);

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    handler.start();

    <span class="hljs-comment">// when</span>

    handler.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"Hello, world!"</span>));

    handler.stop();

    <span class="hljs-comment">// then</span>

    verify(client, never()).connect(any(MqttConnectOptions<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    verify(client).publish(anyString(), any(), any(), any());

    verify(client, never()).disconnect();

    verify(client, never()).disconnect(anyLong());

    verify(client, never()).close();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Mqttv3ClientManager <span class="hljs-title">createMockMqttv3ClientManager</span><span class="hljs-params">(MqttAsyncClient client)</span> </span>{
    <span class="hljs-keyword">var</span> clientManager = mock(Mqttv3ClientManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(clientManager.getConnectionInfo()).thenReturn(<span class="hljs-keyword">new</span> MqttConnectOptions());
    given(clientManager.getClient()).willReturn(client);
    <span class="hljs-keyword">return</span> clientManager;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest52">Test Case ID #spring-integration_Test_5_2</h4>
<h4 id="test-case-name-testclientmanagerisnotconnectedandclosedinadapterfile-cjavaprojectsspringspring-integrationspring-integration-mqttsrctestjavaorgspringframeworkintegrationmqttmqttadaptertestsjava">Test Case Name: <code>testClientManagerIsNotConnectedAndClosedInAdapter</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mqtt\src\test\java\org\springframework\integration\mqtt\MqttAdapterTests.java</code>)</h4>
<h4 id="mock-object-variable-name-clientmanager">Mock Object Variable Name: <code>clientManager</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    // given
<span class="hljs-deletion">-    var clientManager = mock(Mqttv3ClientManager.class);</span>
<span class="hljs-deletion">-    when(clientManager.getConnectionInfo()).thenReturn(new MqttConnectOptions());</span>
    var client = mock(MqttAsyncClient.class);
<span class="hljs-deletion">-    given(clientManager.getClient()).willReturn(client);</span>
<span class="hljs-addition">+    var clientManager = createMockMqttv3ClientManager(client);</span>
    var subscribeToken = mock(MqttToken.class);
    given(subscribeToken.getGrantedQos()).thenReturn(new int[] { 2 });
    given(client.subscribe(any(String[].class), any(int[].class), any())).willReturn(subscribeToken);
    var adapter = new MqttPahoMessageDrivenChannelAdapter(clientManager, "mqtt-foo");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testClientManagerIsNotConnectedAndClosedInAdapter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-comment">// given</span>

    <span class="hljs-keyword">var</span> clientManager = mock(Mqttv3ClientManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(clientManager.getConnectionInfo()).thenReturn(<span class="hljs-keyword">new</span> MqttConnectOptions());

    <span class="hljs-keyword">var</span> client = mock(MqttAsyncClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(clientManager.getClient()).willReturn(client);

    <span class="hljs-keyword">var</span> subscribeToken = mock(MqttToken<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(subscribeToken.getGrantedQos()).willReturn(<span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">2</span> });

    given(client.subscribe(any(String[]<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">int</span>[].<span class="hljs-title">class</span>), <span class="hljs-title">any</span>())).<span class="hljs-title">willReturn</span>(<span class="hljs-title">subscribeToken</span>)</span>;

    <span class="hljs-keyword">var</span> adapter = <span class="hljs-keyword">new</span> MqttPahoMessageDrivenChannelAdapter(clientManager, <span class="hljs-string">"mqtt-foo"</span>);

    adapter.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    adapter.afterPropertiesSet();

    <span class="hljs-comment">// when</span>

    adapter.start();

    adapter.connectComplete(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);

    adapter.stop();

    <span class="hljs-comment">// then</span>

    verify(client, never()).connect(any(MqttConnectOptions<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    verify(client).subscribe(eq(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"mqtt-foo"</span> }), any(<span class="hljs-keyword">int</span>[]<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>())</span>;

    verify(client).unsubscribe(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"mqtt-foo"</span> });

    verify(client, never()).disconnect();

    verify(client, never()).disconnect(anyLong());

    verify(client, never()).close();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Mqttv3ClientManager <span class="hljs-title">createMockMqttv3ClientManager</span><span class="hljs-params">(MqttAsyncClient client)</span> </span>{
    <span class="hljs-keyword">var</span> clientManager = mock(Mqttv3ClientManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(clientManager.getConnectionInfo()).thenReturn(<span class="hljs-keyword">new</span> MqttConnectOptions());
    given(clientManager.getClient()).willReturn(client);
    <span class="hljs-keyword">return</span> clientManager;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci6">Mock Clone Instance #spring-integration_MCI_6</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.rabbitmq.client.Connection</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">createMockConnection</span><span class="hljs-params">(Channel channel)</span> </span>{
    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(<span class="hljs-keyword">true</span>).given(connection).isOpen();
    willReturn(channel).given(connection).createChannel();
    <span class="hljs-keyword">return</span> connection;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest61">Test Case ID #spring-integration_Test_6_1</h4>
<h4 id="test-case-name-testackfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpinboundamqpmessagesourcetestsjava">Test Case Name: <code>testAck</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\inbound\AmqpMessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-connection">Mock Object Variable Name: <code>connection</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    willReturn(getResponse).given(channel).basicGet("foo", false);
<span class="hljs-deletion">-    Connection connection = mock(Connection.class);</span>
<span class="hljs-deletion">-    willReturn(true).given(connection).isOpen();</span>
<span class="hljs-deletion">-    willReturn(channel).given(connection).createChannel();</span>
<span class="hljs-addition">+    Connection connection = createMockConnection(channel);</span>
    ConnectionFactory connectionFactory = mock(ConnectionFactory.class);
    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());
    CachingConnectionFactory ccf = new CachingConnectionFactory(connectionFactory);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAck</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">true</span>).given(channel).isOpen();

    Envelope envelope = <span class="hljs-keyword">new</span> Envelope(<span class="hljs-number">123L</span>, <span class="hljs-keyword">false</span>, <span class="hljs-string">"ex"</span>, <span class="hljs-string">"rk"</span>);

    BasicProperties props = <span class="hljs-keyword">new</span> BasicProperties.Builder().contentType(MessageProperties.DEFAULT_CONTENT_TYPE).build();

    GetResponse getResponse = <span class="hljs-keyword">new</span> GetResponse(envelope, props, <span class="hljs-string">"bar"</span>.getBytes(), <span class="hljs-number">0</span>);

    willReturn(getResponse).given(channel).basicGet(<span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>);

    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">true</span>).given(connection).isOpen();

    willReturn(channel).given(connection).createChannel();

    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());

    CachingConnectionFactory ccf = <span class="hljs-keyword">new</span> CachingConnectionFactory(connectionFactory);

    AmqpMessageSource source = <span class="hljs-keyword">new</span> AmqpMessageSource(ccf, <span class="hljs-string">"foo"</span>);

    source.setRawMessageHeader(<span class="hljs-keyword">true</span>);

    Message&lt;?&gt; received = source.receive();

    assertThat(received.getHeaders().get(AmqpMessageHeaderErrorMessageStrategy.AMQP_RAW_MESSAGE)).isInstanceOf(org.springframework.amqp.core.Message<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    assertThat(received.getHeaders().get(IntegrationMessageHeaderAccessor.SOURCE_DATA)).isSameAs(received.getHeaders().get(AmqpMessageHeaderErrorMessageStrategy.AMQP_RAW_MESSAGE));

    assertThat(received.getHeaders().get(AmqpHeaders.CONSUMER_QUEUE)).isEqualTo(<span class="hljs-string">"foo"</span>);

    <span class="hljs-comment">// make sure channel is not cached</span>

    org.springframework.amqp.rabbit.connection.Connection conn = ccf.createConnection();

    <span class="hljs-comment">// should not have been "closed"</span>

    Channel notCached = conn.createChannel(<span class="hljs-keyword">false</span>);

    verify(connection, times(<span class="hljs-number">2</span>)).createChannel();

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(Status.ACCEPT);

    verify(channel).basicAck(<span class="hljs-number">123L</span>, <span class="hljs-keyword">false</span>);

    <span class="hljs-comment">// should have been "closed"</span>

    Channel cached = conn.createChannel(<span class="hljs-keyword">false</span>);

    verify(connection, times(<span class="hljs-number">2</span>)).createChannel();

    notCached.close();

    cached.close();

    ccf.destroy();

    verify(channel, times(<span class="hljs-number">2</span>)).close();

    verify(connection).close(<span class="hljs-number">30000</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">createMockConnection</span><span class="hljs-params">(Channel channel)</span> </span>{
    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(<span class="hljs-keyword">true</span>).given(connection).isOpen();
    willReturn(channel).given(connection).createChannel();
    <span class="hljs-keyword">return</span> connection;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest62">Test Case ID #spring-integration_Test_6_2</h4>
<h4 id="test-case-name-testnackorrequeuefile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpinboundamqpmessagesourcetestsjava">Test Case Name: <code>testNackOrRequeue</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\inbound\AmqpMessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-connection">Mock Object Variable Name: <code>connection</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    willReturn(getResponse).given(channel).basicGet("foo", false);
<span class="hljs-deletion">-    Connection connection = mock(Connection.class);</span>
<span class="hljs-deletion">-    willReturn(true).given(connection).isOpen();</span>
<span class="hljs-deletion">-    willReturn(channel).given(connection).createChannel();</span>
<span class="hljs-addition">+    Connection connection = createMockConnection(channel);</span>
    ConnectionFactory connectionFactory = mock(ConnectionFactory.class);
    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());
    CachingConnectionFactory ccf = new CachingConnectionFactory(connectionFactory);
    AmqpMessageSource source = new AmqpMessageSource(ccf, "foo");
    Message&lt;?&gt; received = source.receive();
    verify(connection).createChannel();
    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(requeue ? Status.REQUEUE : Status.REJECT);
    verify(channel).basicReject(123L, requeue);
    verify(connection).createChannel();
    ccf.destroy();
    verify(channel).close();
    verify(connection).close(30000);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNackOrRequeue</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> requeue)</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">true</span>).given(channel).isOpen();

    Envelope envelope = <span class="hljs-keyword">new</span> Envelope(<span class="hljs-number">123L</span>, <span class="hljs-keyword">false</span>, <span class="hljs-string">"ex"</span>, <span class="hljs-string">"rk"</span>);

    BasicProperties props = <span class="hljs-keyword">new</span> BasicProperties.Builder().contentType(MessageProperties.DEFAULT_CONTENT_TYPE).build();

    GetResponse getResponse = <span class="hljs-keyword">new</span> GetResponse(envelope, props, <span class="hljs-string">"bar"</span>.getBytes(), <span class="hljs-number">0</span>);

    willReturn(getResponse).given(channel).basicGet(<span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>);

    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">true</span>).given(connection).isOpen();

    willReturn(channel).given(connection).createChannel();

    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());

    CachingConnectionFactory ccf = <span class="hljs-keyword">new</span> CachingConnectionFactory(connectionFactory);

    AmqpMessageSource source = <span class="hljs-keyword">new</span> AmqpMessageSource(ccf, <span class="hljs-string">"foo"</span>);

    Message&lt;?&gt; received = source.receive();

    verify(connection).createChannel();

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(requeue ? Status.REQUEUE : Status.REJECT);

    verify(channel).basicReject(<span class="hljs-number">123L</span>, requeue);

    verify(connection).createChannel();

    ccf.destroy();

    verify(channel).close();

    verify(connection).close(<span class="hljs-number">30000</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">createMockConnection</span><span class="hljs-params">(Channel channel)</span> </span>{
    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(<span class="hljs-keyword">true</span>).given(connection).isOpen();
    willReturn(channel).given(connection).createChannel();
    <span class="hljs-keyword">return</span> connection;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest63">Test Case ID #spring-integration_Test_6_3</h4>
<h4 id="test-case-name-testbatchfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpinboundamqpmessagesourcetestsjava">Test Case Name: <code>testBatch</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\inbound\AmqpMessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-connection">Mock Object Variable Name: <code>connection</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    willReturn(getResponse).given(channel).basicGet("foo", false);
<span class="hljs-deletion">-    Connection connection = mock(Connection.class);</span>
<span class="hljs-deletion">-    willReturn(true).given(connection).isOpen();</span>
<span class="hljs-deletion">-    willReturn(channel).given(connection).createChannel();</span>
<span class="hljs-addition">+    Connection connection = createMockConnection(channel);</span>
    ConnectionFactory connectionFactory = mock(ConnectionFactory.class);
    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());
    CachingConnectionFactory ccf = new CachingConnectionFactory(connectionFactory);
    AmqpMessageSource source = new AmqpMessageSource(ccf, "foo");
    Message&lt;?&gt; received = source.receive();
    assertThat(received).isNotNull();
    assertThat(((List&lt;String&gt;) received.getPayload())).contains("test1", "test2");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testBatch</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SimpleBatchingStrategy bs = <span class="hljs-keyword">new</span> SimpleBatchingStrategy(<span class="hljs-number">2</span>, <span class="hljs-number">10_000</span>, <span class="hljs-number">10_000L</span>);

    MessageProperties messageProperties = <span class="hljs-keyword">new</span> MessageProperties();

    messageProperties.setContentType(<span class="hljs-string">"text/plain"</span>);

    org.springframework.amqp.core.Message message = <span class="hljs-keyword">new</span> org.springframework.amqp.core.Message(<span class="hljs-string">"test1"</span>.getBytes(), messageProperties);

    bs.addToBatch(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>, message);

    message = <span class="hljs-keyword">new</span> org.springframework.amqp.core.Message(<span class="hljs-string">"test2"</span>.getBytes(), messageProperties);

    MessageBatch batched = bs.addToBatch(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>, message);

    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">true</span>).given(channel).isOpen();

    Envelope envelope = <span class="hljs-keyword">new</span> Envelope(<span class="hljs-number">123L</span>, <span class="hljs-keyword">false</span>, <span class="hljs-string">"ex"</span>, <span class="hljs-string">"rk"</span>);

    BasicProperties props = <span class="hljs-keyword">new</span> BasicProperties.Builder().headers(batched.message().getMessageProperties().getHeaders()).contentType(<span class="hljs-string">"text/plain"</span>).build();

    GetResponse getResponse = <span class="hljs-keyword">new</span> GetResponse(envelope, props, batched.message().getBody(), <span class="hljs-number">0</span>);

    willReturn(getResponse).given(channel).basicGet(<span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>);

    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">true</span>).given(connection).isOpen();

    willReturn(channel).given(connection).createChannel();

    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());

    CachingConnectionFactory ccf = <span class="hljs-keyword">new</span> CachingConnectionFactory(connectionFactory);

    AmqpMessageSource source = <span class="hljs-keyword">new</span> AmqpMessageSource(ccf, <span class="hljs-string">"foo"</span>);

    Message&lt;?&gt; received = source.receive();

    assertThat(received).isNotNull();

    assertThat(((List&lt;String&gt;) received.getPayload())).contains(<span class="hljs-string">"test1"</span>, <span class="hljs-string">"test2"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">createMockConnection</span><span class="hljs-params">(Channel channel)</span> </span>{
    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(<span class="hljs-keyword">true</span>).given(connection).isOpen();
    willReturn(channel).given(connection).createChannel();
    <span class="hljs-keyword">return</span> connection;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci7">Mock Clone Instance #spring-integration_MCI_7</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.file.remote.RemoteFileTemplate&lt;java.lang.String&gt;</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RemoteFileTemplate&lt;String&gt; <span class="hljs-title">createMockRemoteFileTemplate</span><span class="hljs-params">(Session&lt;String&gt; session)</span> </span>{
    RemoteFileTemplate&lt;String&gt; remoteFileTemplate = mock();
    when(remoteFileTemplate.getSession()).thenReturn(session);
    when(remoteFileTemplate.list(<span class="hljs-string">"remoteDirectory"</span>)).thenReturn(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"file1"</span>, <span class="hljs-string">"file2"</span> });
    <span class="hljs-keyword">return</span> remoteFileTemplate;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest71">Test Case ID #spring-integration_Test_7_1</h4>
<h4 id="test-case-name-fetchfilesfromremoteafterclearingfetchedcachefile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremoteremotefilestreamingmessagesourcetestsjava">Test Case Name: <code>fetchFilesFromRemoteAfterClearingFetchedCache</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\RemoteFileStreamingMessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-remotefiletemplate">Mock Object Variable Name: <code>remoteFileTemplate</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void fetchFilesFromRemoteAfterClearingFetchedCache() throws IOException {
<span class="hljs-deletion">-    RemoteFileTemplate&lt;String&gt; remoteFileTemplate = mock();</span>
<span class="hljs-deletion">-    when(remoteFileTemplate.list("remoteDirectory")).thenReturn(new String[] { "file1", "file2" });</span>
     Session&lt;String&gt; session = mock();
     when(session.readRaw(anyString())).thenReturn(mock());
<span class="hljs-deletion">-    when(remoteFileTemplate.getSession()).thenReturn(session);</span>
<span class="hljs-addition">+    RemoteFileTemplate&lt;String&gt; remoteFileTemplate = createMockRemoteFileTemplate(session);</span>
     Comparator&lt;String&gt; comparator = mock();
     TestRemoteFileStreamingMessageSource testRemoteFileStreamingMessageSource = new TestRemoteFileStreamingMessageSource(remoteFileTemplate, comparator);
     testRemoteFileStreamingMessageSource.setRemoteDirectory("remoteDirectory");
     testRemoteFileStreamingMessageSource.setBeanFactory(mock());
     testRemoteFileStreamingMessageSource.start();
     assertThat(testRemoteFileStreamingMessageSource.doReceive(2)).isNotNull();
     testRemoteFileStreamingMessageSource.clearFetchedCache();
     assertThat(testRemoteFileStreamingMessageSource.doReceive(2)).isNotNull();
     verify(remoteFileTemplate, times(2)).list("remoteDirectory");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">fetchFilesFromRemoteAfterClearingFetchedCache</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{

    RemoteFileTemplate&lt;String&gt; remoteFileTemplate = mock();

    when(remoteFileTemplate.list(<span class="hljs-string">"remoteDirectory"</span>)).thenReturn(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"file1"</span>, <span class="hljs-string">"file2"</span> });

    Session&lt;String&gt; session = mock();

    when(session.readRaw(anyString())).thenReturn(mock());

    when(remoteFileTemplate.getSession()).thenReturn(session);

    Comparator&lt;String&gt; comparator = mock();

    TestRemoteFileStreamingMessageSource testRemoteFileStreamingMessageSource = <span class="hljs-keyword">new</span> TestRemoteFileStreamingMessageSource(remoteFileTemplate, comparator);

    testRemoteFileStreamingMessageSource.setRemoteDirectory(<span class="hljs-string">"remoteDirectory"</span>);

    testRemoteFileStreamingMessageSource.setBeanFactory(mock());

    testRemoteFileStreamingMessageSource.start();

    assertThat(testRemoteFileStreamingMessageSource.doReceive(<span class="hljs-number">2</span>)).isNotNull();

    testRemoteFileStreamingMessageSource.clearFetchedCache();

    assertThat(testRemoteFileStreamingMessageSource.doReceive(<span class="hljs-number">2</span>)).isNotNull();

    verify(remoteFileTemplate, times(<span class="hljs-number">2</span>)).list(<span class="hljs-string">"remoteDirectory"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RemoteFileTemplate&lt;String&gt; <span class="hljs-title">createMockRemoteFileTemplate</span><span class="hljs-params">(Session&lt;String&gt; session)</span> </span>{
    RemoteFileTemplate&lt;String&gt; remoteFileTemplate = mock();
    when(remoteFileTemplate.getSession()).thenReturn(session);
    when(remoteFileTemplate.list(<span class="hljs-string">"remoteDirectory"</span>)).thenReturn(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"file1"</span>, <span class="hljs-string">"file2"</span> });
    <span class="hljs-keyword">return</span> remoteFileTemplate;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest72">Test Case ID #spring-integration_Test_7_2</h4>
<h4 id="test-case-name-filteroutfilesnotacceptedbyfilterfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremoteremotefilestreamingmessagesourcetestsjava">Test Case Name: <code>filterOutFilesNotAcceptedByFilter</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\RemoteFileStreamingMessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-remotefiletemplate">Mock Object Variable Name: <code>remoteFileTemplate</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void filterOutFilesNotAcceptedByFilter() throws IOException {
<span class="hljs-deletion">-    RemoteFileTemplate&lt;String&gt; remoteFileTemplate = mock();</span>
<span class="hljs-deletion">-    when(remoteFileTemplate.list("remoteDirectory")).thenReturn(new String[] { "file1", "file2" });</span>
     Session&lt;String&gt; session = mock();
     when(session.readRaw(anyString())).thenReturn(mock());
<span class="hljs-deletion">-    when(remoteFileTemplate.getSession()).thenReturn(session);</span>
<span class="hljs-addition">+    RemoteFileTemplate&lt;String&gt; remoteFileTemplate = createMockRemoteFileTemplate(session);</span>
     FileListFilter&lt;String&gt; fileListFilter = mock();
     when(fileListFilter.supportsSingleFileFiltering()).thenReturn(true);
     when(fileListFilter.accept("file1")).thenReturn(false);
     when(fileListFilter.accept("file2")).thenReturn(false);
     Comparator&lt;String&gt; comparator = mock();
     TestRemoteFileStreamingMessageSource testRemoteFileStreamingMessageSource = new TestRemoteFileStreamingMessageSource(remoteFileTemplate, comparator);
     testRemoteFileStreamingMessageSource.setFilter(fileListFilter);
     testRemoteFileStreamingMessageSource.setRemoteDirectory("remoteDirectory");
     testRemoteFileStreamingMessageSource.setBeanFactory(mock());
     testRemoteFileStreamingMessageSource.start();
     assertThat(testRemoteFileStreamingMessageSource.doReceive(-1)).isNull();
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">filterOutFilesNotAcceptedByFilter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{

    RemoteFileTemplate&lt;String&gt; remoteFileTemplate = mock();

    when(remoteFileTemplate.list(<span class="hljs-string">"remoteDirectory"</span>)).thenReturn(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"file1"</span>, <span class="hljs-string">"file2"</span> });

    Session&lt;String&gt; session = mock();

    when(session.readRaw(anyString())).thenReturn(mock());

    when(remoteFileTemplate.getSession()).thenReturn(session);

    FileListFilter&lt;String&gt; fileListFilter = mock();

    when(fileListFilter.supportsSingleFileFiltering()).thenReturn(<span class="hljs-keyword">true</span>);

    when(fileListFilter.accept(<span class="hljs-string">"file1"</span>)).thenReturn(<span class="hljs-keyword">false</span>);

    when(fileListFilter.accept(<span class="hljs-string">"file2"</span>)).thenReturn(<span class="hljs-keyword">false</span>);

    Comparator&lt;String&gt; comparator = mock();

    TestRemoteFileStreamingMessageSource testRemoteFileStreamingMessageSource = <span class="hljs-keyword">new</span> TestRemoteFileStreamingMessageSource(remoteFileTemplate, comparator);

    testRemoteFileStreamingMessageSource.setFilter(fileListFilter);

    testRemoteFileStreamingMessageSource.setRemoteDirectory(<span class="hljs-string">"remoteDirectory"</span>);

    testRemoteFileStreamingMessageSource.setBeanFactory(mock());

    testRemoteFileStreamingMessageSource.start();

    assertThat(testRemoteFileStreamingMessageSource.doReceive(-<span class="hljs-number">1</span>)).isNull();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RemoteFileTemplate&lt;String&gt; <span class="hljs-title">createMockRemoteFileTemplate</span><span class="hljs-params">(Session&lt;String&gt; session)</span> </span>{
    RemoteFileTemplate&lt;String&gt; remoteFileTemplate = mock();
    when(remoteFileTemplate.getSession()).thenReturn(session);
    when(remoteFileTemplate.list(<span class="hljs-string">"remoteDirectory"</span>)).thenReturn(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"file1"</span>, <span class="hljs-string">"file2"</span> });
    <span class="hljs-keyword">return</span> remoteFileTemplate;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci8">Mock Clone Instance #spring-integration_MCI_8</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>java.net.InetAddress</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> InetAddress local;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    local = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
local;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest81">Test Case ID #spring-integration_Test_8_1</h4>
<h4 id="test-case-name-testtomessagefile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpmessagemappertestsjava">Test Case Name: <code>testToMessage</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpMessageMapperTests.java</code>)</h4>
<h4 id="mock-object-variable-name-local">Mock Object Variable Name: <code>local</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testToMessage() {
     TcpMessageMapper mapper = new TcpMessageMapper();
     TcpConnection connection = creatMockTcpConcnection(TEST_PAYLOAD.getBytes(), "MyHost", "1.1.1.1", 1234);
<span class="hljs-deletion">-    InetAddress local = mock(InetAddress.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `local`</span>
     Socket socket = creatMockSocket(local);
     SocketInfo info = new SocketInfo(socket);
     when(connection.getSocketInfo()).thenReturn(info);
     Message&lt;?&gt; message = mapper.toMessage(connection);
     assertThat(new String((byte[]) message.getPayload())).isEqualTo(TEST_PAYLOAD);
     assertThat(message.getHeaders().get(IpHeaders.HOSTNAME)).isEqualTo("MyHost");
     assertThat(message.getHeaders().get(IpHeaders.IP_ADDRESS)).isEqualTo("1.1.1.1");
     assertThat(message.getHeaders().get(IpHeaders.REMOTE_PORT)).isEqualTo(1234);
     assertThat(message.getHeaders().get(IpHeaders.LOCAL_ADDRESS)).isSameAs(local);
     assertThat(message.getHeaders().get(MessageHeaders.CONTENT_TYPE)).isNull();
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testToMessage</span><span class="hljs-params">()</span> </span>{

    TcpMessageMapper mapper = <span class="hljs-keyword">new</span> TcpMessageMapper();

    TcpConnection connection = creatMockTcpConcnection(TEST_PAYLOAD.getBytes(), <span class="hljs-string">"MyHost"</span>, <span class="hljs-string">"1.1.1.1"</span>, <span class="hljs-number">1234</span>);

    InetAddress local = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Socket socket = creatMockSocket(local);

    SocketInfo info = <span class="hljs-keyword">new</span> SocketInfo(socket);

    when(connection.getSocketInfo()).thenReturn(info);

    Message&lt;?&gt; message = mapper.toMessage(connection);

    assertThat(<span class="hljs-keyword">new</span> String((<span class="hljs-keyword">byte</span>[]) message.getPayload())).isEqualTo(TEST_PAYLOAD);

    assertThat(message.getHeaders().get(IpHeaders.HOSTNAME)).isEqualTo(<span class="hljs-string">"MyHost"</span>);

    assertThat(message.getHeaders().get(IpHeaders.IP_ADDRESS)).isEqualTo(<span class="hljs-string">"1.1.1.1"</span>);

    assertThat(message.getHeaders().get(IpHeaders.REMOTE_PORT)).isEqualTo(<span class="hljs-number">1234</span>);

    assertThat(message.getHeaders().get(IpHeaders.LOCAL_ADDRESS)).isSameAs(local);

    assertThat(message.getHeaders().get(MessageHeaders.CONTENT_TYPE)).isNull();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> InetAddress local;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    local = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
local;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest82">Test Case ID #spring-integration_Test_8_2</h4>
<h4 id="test-case-name-testtomessagewithcontenttypefile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpmessagemappertestsjava">Test Case Name: <code>testToMessageWithContentType</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpMessageMapperTests.java</code>)</h4>
<h4 id="mock-object-variable-name-local">Mock Object Variable Name: <code>local</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testToMessageWithContentType() {
     TcpMessageMapper mapper = new TcpMessageMapper();
     mapper.setAddContentTypeHeader(true);
     TcpConnection connection = creatMockTcpConcnection(TEST_PAYLOAD.getBytes(), "MyHost", "1.1.1.1", 1234);
<span class="hljs-deletion">-    InetAddress local = mock(InetAddress.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `local`</span>
     Socket socket = creatMockSocket(local);
     SocketInfo info = new SocketInfo(socket);
     when(connection.getSocketInfo()).thenReturn(info);
     Message&lt;?&gt; message = mapper.toMessage(connection);
     assertThat(new String((byte[]) message.getPayload())).isEqualTo(TEST_PAYLOAD);
     assertThat(message.getHeaders().get(IpHeaders.HOSTNAME)).isEqualTo("MyHost");
     assertThat(message.getHeaders().get(IpHeaders.IP_ADDRESS)).isEqualTo("1.1.1.1");
     assertThat(message.getHeaders().get(IpHeaders.REMOTE_PORT)).isEqualTo(1234);
     assertThat(message.getHeaders().get(IpHeaders.LOCAL_ADDRESS)).isSameAs(local);
     assertThat(message.getHeaders().get(MessageHeaders.CONTENT_TYPE)).isEqualTo("application/octet-stream;charset=UTF-8");
     MimeType parseOk = MimeType.valueOf((String) message.getHeaders().get(MessageHeaders.CONTENT_TYPE));
     assertThat(parseOk.toString()).isEqualTo(message.getHeaders().get(MessageHeaders.CONTENT_TYPE));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testToMessageWithContentType</span><span class="hljs-params">()</span> </span>{

    TcpMessageMapper mapper = <span class="hljs-keyword">new</span> TcpMessageMapper();

    mapper.setAddContentTypeHeader(<span class="hljs-keyword">true</span>);

    TcpConnection connection = creatMockTcpConcnection(TEST_PAYLOAD.getBytes(), <span class="hljs-string">"MyHost"</span>, <span class="hljs-string">"1.1.1.1"</span>, <span class="hljs-number">1234</span>);

    InetAddress local = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Socket socket = creatMockSocket(local);

    SocketInfo info = <span class="hljs-keyword">new</span> SocketInfo(socket);

    when(connection.getSocketInfo()).thenReturn(info);

    Message&lt;?&gt; message = mapper.toMessage(connection);

    assertThat(<span class="hljs-keyword">new</span> String((<span class="hljs-keyword">byte</span>[]) message.getPayload())).isEqualTo(TEST_PAYLOAD);

    assertThat(message.getHeaders().get(IpHeaders.HOSTNAME)).isEqualTo(<span class="hljs-string">"MyHost"</span>);

    assertThat(message.getHeaders().get(IpHeaders.IP_ADDRESS)).isEqualTo(<span class="hljs-string">"1.1.1.1"</span>);

    assertThat(message.getHeaders().get(IpHeaders.REMOTE_PORT)).isEqualTo(<span class="hljs-number">1234</span>);

    assertThat(message.getHeaders().get(IpHeaders.LOCAL_ADDRESS)).isSameAs(local);

    assertThat(message.getHeaders().get(MessageHeaders.CONTENT_TYPE)).isEqualTo(<span class="hljs-string">"application/octet-stream;charset=UTF-8"</span>);

    MimeType parseOk = MimeType.valueOf((String) message.getHeaders().get(MessageHeaders.CONTENT_TYPE));

    assertThat(parseOk.toString()).isEqualTo(message.getHeaders().get(MessageHeaders.CONTENT_TYPE));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> InetAddress local;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    local = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
local;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest83">Test Case ID #spring-integration_Test_8_3</h4>
<h4 id="test-case-name-testtomessagewithcustomcontenttypefile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpmessagemappertestsjava">Test Case Name: <code>testToMessageWithCustomContentType</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpMessageMapperTests.java</code>)</h4>
<h4 id="mock-object-variable-name-local">Mock Object Variable Name: <code>local</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testToMessageWithCustomContentType() {
     TcpMessageMapper mapper = new TcpMessageMapper();
     mapper.setAddContentTypeHeader(true);
     mapper.setContentType("application/octet-stream;charset=ISO-8859-1");
     TcpConnection connection = creatMockTcpConcnection(TEST_PAYLOAD.getBytes(), "MyHost", "1.1.1.1", 1234);
<span class="hljs-deletion">-    InetAddress local = mock(InetAddress.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `local`</span>
     Socket socket = creatMockSocket(local);
     SocketInfo info = new SocketInfo(socket);
     when(connection.getSocketInfo()).thenReturn(info);
     Message&lt;?&gt; message = mapper.toMessage(connection);
     assertThat(new String((byte[]) message.getPayload())).isEqualTo(TEST_PAYLOAD);
     assertThat(message.getHeaders().get(IpHeaders.HOSTNAME)).isEqualTo("MyHost");
     assertThat(message.getHeaders().get(IpHeaders.IP_ADDRESS)).isEqualTo("1.1.1.1");
     assertThat(message.getHeaders().get(IpHeaders.REMOTE_PORT)).isEqualTo(1234);
     assertThat(message.getHeaders().get(IpHeaders.LOCAL_ADDRESS)).isSameAs(local);
     assertThat(message.getHeaders().get(MessageHeaders.CONTENT_TYPE)).isEqualTo("application/octet-stream;charset=ISO-8859-1");
     MimeType parseOk = MimeType.valueOf((String) message.getHeaders().get(MessageHeaders.CONTENT_TYPE));
     assertThat(parseOk.toString()).isEqualTo(message.getHeaders().get(MessageHeaders.CONTENT_TYPE));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testToMessageWithCustomContentType</span><span class="hljs-params">()</span> </span>{

    TcpMessageMapper mapper = <span class="hljs-keyword">new</span> TcpMessageMapper();

    mapper.setAddContentTypeHeader(<span class="hljs-keyword">true</span>);

    mapper.setContentType(<span class="hljs-string">"application/octet-stream;charset=ISO-8859-1"</span>);

    TcpConnection connection = creatMockTcpConcnection(TEST_PAYLOAD.getBytes(), <span class="hljs-string">"MyHost"</span>, <span class="hljs-string">"1.1.1.1"</span>, <span class="hljs-number">1234</span>);

    InetAddress local = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Socket socket = creatMockSocket(local);

    SocketInfo info = <span class="hljs-keyword">new</span> SocketInfo(socket);

    when(connection.getSocketInfo()).thenReturn(info);

    Message&lt;?&gt; message = mapper.toMessage(connection);

    assertThat(<span class="hljs-keyword">new</span> String((<span class="hljs-keyword">byte</span>[]) message.getPayload())).isEqualTo(TEST_PAYLOAD);

    assertThat(message.getHeaders().get(IpHeaders.HOSTNAME)).isEqualTo(<span class="hljs-string">"MyHost"</span>);

    assertThat(message.getHeaders().get(IpHeaders.IP_ADDRESS)).isEqualTo(<span class="hljs-string">"1.1.1.1"</span>);

    assertThat(message.getHeaders().get(IpHeaders.REMOTE_PORT)).isEqualTo(<span class="hljs-number">1234</span>);

    assertThat(message.getHeaders().get(IpHeaders.LOCAL_ADDRESS)).isSameAs(local);

    assertThat(message.getHeaders().get(MessageHeaders.CONTENT_TYPE)).isEqualTo(<span class="hljs-string">"application/octet-stream;charset=ISO-8859-1"</span>);

    MimeType parseOk = MimeType.valueOf((String) message.getHeaders().get(MessageHeaders.CONTENT_TYPE));

    assertThat(parseOk.toString()).isEqualTo(message.getHeaders().get(MessageHeaders.CONTENT_TYPE));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> InetAddress local;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    local = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
local;

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci9">Mock Clone Instance #spring-integration_MCI_9</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.ip.tcp.connection.TcpSocketFactorySupport</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TcpSocketFactorySupport <span class="hljs-title">createMockTcpSocketFactorySupport</span><span class="hljs-params">(SocketFactory socketFactory)</span> </span>{
    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factorySupport.getSocketFactory()).thenReturn(socketFactory);
    <span class="hljs-keyword">return</span> factorySupport;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest91">Test Case ID #spring-integration_Test_9_1</h4>
<h4 id="test-case-name-testnetclientfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionsocketsupporttestsjava">Test Case Name: <code>testNetClient</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\SocketSupportTests.java</code>)</h4>
<h4 id="mock-object-variable-name-factorysupport">Mock Object Variable Name: <code>factorySupport</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testNetClient() throws Exception {
<span class="hljs-deletion">-    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport.class);</span>
     SocketFactory factory = Mockito.mock(SocketFactory.class);
<span class="hljs-deletion">-    when(factorySupport.getSocketFactory()).thenReturn(factory);</span>
<span class="hljs-addition">+    TcpSocketFactorySupport factorySupport = createMockTcpSocketFactorySupport(factory);</span>
     Socket socket = mock(Socket.class);
     InputStream is = mock(InputStream.class);
     when(is.read()).thenReturn(-1);
     when(socket.getInputStream()).thenReturn(is);
     InetAddress inetAddress = InetAddress.getLocalHost();
     when(socket.getInetAddress()).thenReturn(inetAddress);
     when(factory.createSocket()).thenReturn(socket);
     TcpSocketSupport socketSupport = Mockito.mock(TcpSocketSupport.class);
     TcpNetClientConnectionFactory connectionFactory = new TcpNetClientConnectionFactory("x", 0);
     connectionFactory.setTcpSocketFactorySupport(factorySupport);
     connectionFactory.setTcpSocketSupport(socketSupport);
     connectionFactory.start();
     connectionFactory.getConnection();
     verify(socketSupport).postProcessSocket(socket);
     connectionFactory.stop();
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNetClient</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketFactory factory = Mockito.mock(SocketFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factorySupport.getSocketFactory()).thenReturn(factory);

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    InputStream is = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(is.read()).thenReturn(-<span class="hljs-number">1</span>);

    when(socket.getInputStream()).thenReturn(is);

    InetAddress inetAddress = InetAddress.getLocalHost();

    when(socket.getInetAddress()).thenReturn(inetAddress);

    when(factory.createSocket()).thenReturn(socket);

    TcpSocketSupport socketSupport = Mockito.mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNetClientConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> TcpNetClientConnectionFactory(<span class="hljs-string">"x"</span>, <span class="hljs-number">0</span>);

    connectionFactory.setTcpSocketFactorySupport(factorySupport);

    connectionFactory.setTcpSocketSupport(socketSupport);

    connectionFactory.start();

    connectionFactory.getConnection();

    verify(socketSupport).postProcessSocket(socket);

    connectionFactory.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TcpSocketFactorySupport <span class="hljs-title">createMockTcpSocketFactorySupport</span><span class="hljs-params">(SocketFactory socketFactory)</span> </span>{
    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factorySupport.getSocketFactory()).thenReturn(socketFactory);
    <span class="hljs-keyword">return</span> factorySupport;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest92">Test Case ID #spring-integration_Test_9_2</h4>
<h4 id="test-case-name-testnetclientsockettimeoutfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionsocketsupporttestsjava">Test Case Name: <code>testNetClientSocketTimeout</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\SocketSupportTests.java</code>)</h4>
<h4 id="mock-object-variable-name-factorysupport">Mock Object Variable Name: <code>factorySupport</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testNetClientSocketTimeout() throws Exception {
<span class="hljs-deletion">-    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport.class);</span>
     SocketFactory factory = Mockito.mock(SocketFactory.class);
<span class="hljs-addition">+    TcpSocketFactorySupport factorySupport = createMockTcpSocketFactorySupport(factory);</span>
     Socket socket = mock(Socket.class);
     InputStream is = mock(InputStream.class);
     when(is.read()).thenReturn(-1);
     when(socket.getInputStream()).thenReturn(is);
     InetAddress inetAddress = InetAddress.getLocalHost();
     when(socket.getInetAddress()).thenReturn(inetAddress);
     when(factory.createSocket()).thenReturn(socket);
     doThrow(new SocketTimeoutException()).when(socket).connect(any(), eq(1000));
     TcpSocketSupport socketSupport = Mockito.mock(TcpSocketSupport.class);
     TcpNetClientConnectionFactory connectionFactory = new TcpNetClientConnectionFactory("x", 0);
     connectionFactory.setConnectTimeout(1);
     connectionFactory.setTcpSocketFactorySupport(factorySupport);
     connectionFactory.setTcpSocketSupport(socketSupport);
     connectionFactory.start();
     assertThatThrownBy(connectionFactory::getConnection).isInstanceOf(UncheckedIOException.class).hasCauseInstanceOf(SocketTimeoutException.class);
     connectionFactory.stop();
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNetClientSocketTimeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketFactory factory = Mockito.mock(SocketFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factorySupport.getSocketFactory()).thenReturn(factory);

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    InputStream is = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(is.read()).thenReturn(-<span class="hljs-number">1</span>);

    when(socket.getInputStream()).thenReturn(is);

    InetAddress inetAddress = InetAddress.getLocalHost();

    when(socket.getInetAddress()).thenReturn(inetAddress);

    when(factory.createSocket()).thenReturn(socket);

    doThrow(<span class="hljs-keyword">new</span> SocketTimeoutException()).when(socket).connect(any(), eq(<span class="hljs-number">1000</span>));

    TcpSocketSupport socketSupport = Mockito.mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNetClientConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> TcpNetClientConnectionFactory(<span class="hljs-string">"x"</span>, <span class="hljs-number">0</span>);

    connectionFactory.setConnectTimeout(<span class="hljs-number">1</span>);

    connectionFactory.setTcpSocketFactorySupport(factorySupport);

    connectionFactory.setTcpSocketSupport(socketSupport);

    connectionFactory.start();

    assertThatThrownBy(connectionFactory::getConnection).isInstanceOf(UncheckedIOException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">hasCauseInstanceOf</span>(<span class="hljs-title">SocketTimeoutException</span>.<span class="hljs-title">class</span>)</span>;

    connectionFactory.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TcpSocketFactorySupport <span class="hljs-title">createMockTcpSocketFactorySupport</span><span class="hljs-params">(SocketFactory socketFactory)</span> </span>{
    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factorySupport.getSocketFactory()).thenReturn(socketFactory);
    <span class="hljs-keyword">return</span> factorySupport;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci10">Mock Clone Instance #spring-integration_MCI_10</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.file.remote.session.Session&lt;?&gt;</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session&lt;?&gt; createMockSession(AtomicReference&lt;String&gt; args) {
    Session&lt;?&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(invocation -&gt; {
        Object[] arguments = invocation.getArguments();
        args.set((String) arguments[<span class="hljs-number">0</span>] + arguments[<span class="hljs-number">1</span>]);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).when(session).rename(anyString(), anyString());
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest101">Test Case ID #spring-integration_Test_10_1</h4>
<h4 id="test-case-name-testmovefile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testMove</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    gw.afterPropertiesSet();
<span class="hljs-deletion">-    Session&lt;?&gt; session = mock(Session.class);</span>
    final AtomicReference&lt;String&gt; args = new AtomicReference&lt;&gt;();
<span class="hljs-deletion">-    doAnswer(invocation -&gt; {</span>
<span class="hljs-deletion">-        Object[] arguments = invocation.getArguments();</span>
<span class="hljs-deletion">-        args.set((String) arguments[0] + arguments[1]);</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).when(session).rename(anyString(), anyString());</span>
<span class="hljs-addition">+    Session&lt;?&gt; session = createMockSession(args);</span>
    when(sessionFactory.getSession()).thenReturn(session);
    Message&lt;String&gt; requestMessage = MessageBuilder.withPayload("foo").setHeader(FileHeaders.RENAME_TO, "bar").build();
    MessageBuilder&lt;?&gt; out = (MessageBuilder&lt;?&gt;) gw.handleRequestMessage(requestMessage);
    assertThat(out.getHeaders().get(FileHeaders.REMOTE_FILE)).isEqualTo("foo");
    assertThat(args.get()).isEqualTo("foobar");
    assertThat(out.getPayload()).isEqualTo(Boolean.TRUE);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMove</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"mv"</span>, <span class="hljs-string">"payload"</span>);

    gw.afterPropertiesSet();

    Session&lt;?&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> AtomicReference&lt;String&gt; args = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    doAnswer(invocation -&gt; {

        Object[] arguments = invocation.getArguments();

        args.set((String) arguments[<span class="hljs-number">0</span>] + arguments[<span class="hljs-number">1</span>]);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(session).rename(anyString(), anyString());

    when(sessionFactory.getSession()).thenReturn(session);

    Message&lt;String&gt; requestMessage = MessageBuilder.withPayload(<span class="hljs-string">"foo"</span>).setHeader(FileHeaders.RENAME_TO, <span class="hljs-string">"bar"</span>).build();

    MessageBuilder&lt;?&gt; out = (MessageBuilder&lt;?&gt;) gw.handleRequestMessage(requestMessage);

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_FILE)).isEqualTo(<span class="hljs-string">"foo"</span>);

    assertThat(args.get()).isEqualTo(<span class="hljs-string">"foobar"</span>);

    assertThat(out.getPayload()).isEqualTo(Boolean.TRUE);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session&lt;?&gt; createMockSession(AtomicReference&lt;String&gt; args) {
    Session&lt;?&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(invocation -&gt; {
        Object[] arguments = invocation.getArguments();
        args.set((String) arguments[<span class="hljs-number">0</span>] + arguments[<span class="hljs-number">1</span>]);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).when(session).rename(anyString(), anyString());
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest102">Test Case ID #spring-integration_Test_10_2</h4>
<h4 id="test-case-name-testmovewithexpressionfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testMoveWithExpression</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    gw.setRenameExpression(PARSER.parseExpression("payload.substring(1)"));
    gw.afterPropertiesSet();
<span class="hljs-deletion">-    Session&lt;?&gt; session = mock(Session.class);</span>
    final AtomicReference&lt;String&gt; args = new AtomicReference&lt;&gt;();
<span class="hljs-deletion">-    doAnswer(invocation -&gt; {</span>
<span class="hljs-deletion">-        Object[] arguments = invocation.getArguments();</span>
<span class="hljs-deletion">-        args.set((String) arguments[0] + arguments[1]);</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).when(session).rename(anyString(), anyString());</span>
<span class="hljs-addition">+    Session&lt;?&gt; session = createMockSession(args);</span>
    when(sessionFactory.getSession()).thenReturn(session);
    MessageBuilder&lt;?&gt; out = (MessageBuilder&lt;?&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("foo"));
    assertThat(out.getHeaders().get(FileHeaders.RENAME_TO)).isEqualTo("oo");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMoveWithExpression</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"mv"</span>, <span class="hljs-string">"payload"</span>);

    gw.setRenameExpression(PARSER.parseExpression(<span class="hljs-string">"payload.substring(1)"</span>));

    gw.afterPropertiesSet();

    Session&lt;?&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> AtomicReference&lt;String&gt; args = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    doAnswer(invocation -&gt; {

        Object[] arguments = invocation.getArguments();

        args.set((String) arguments[<span class="hljs-number">0</span>] + arguments[<span class="hljs-number">1</span>]);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(session).rename(anyString(), anyString());

    when(sessionFactory.getSession()).thenReturn(session);

    MessageBuilder&lt;?&gt; out = (MessageBuilder&lt;?&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>));

    assertThat(out.getHeaders().get(FileHeaders.RENAME_TO)).isEqualTo(<span class="hljs-string">"oo"</span>);

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_FILE)).isEqualTo(<span class="hljs-string">"foo"</span>);

    assertThat(args.get()).isEqualTo(<span class="hljs-string">"foooo"</span>);

    assertThat(out.getPayload()).isEqualTo(Boolean.TRUE);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session&lt;?&gt; createMockSession(AtomicReference&lt;String&gt; args) {
    Session&lt;?&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(invocation -&gt; {
        Object[] arguments = invocation.getArguments();
        args.set((String) arguments[<span class="hljs-number">0</span>] + arguments[<span class="hljs-number">1</span>]);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).when(session).rename(anyString(), anyString());
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest103">Test Case ID #spring-integration_Test_10_3</h4>
<h4 id="test-case-name-testmovewithmkdirsfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testMoveWithMkDirs</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    gw.afterPropertiesSet();
<span class="hljs-deletion">-    Session&lt;?&gt; session = mock(Session.class);</span>
    final AtomicReference&lt;String&gt; args = new AtomicReference&lt;&gt;();
<span class="hljs-deletion">-    doAnswer(invocation -&gt; {</span>
<span class="hljs-deletion">-        Object[] arguments = invocation.getArguments();</span>
<span class="hljs-deletion">-        args.set((String) arguments[0] + arguments[1]);</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).when(session).rename(anyString(), anyString());</span>
<span class="hljs-addition">+    Session&lt;?&gt; session = createMockSession(args);</span>
    final List&lt;String&gt; madeDirs = new ArrayList&lt;&gt;();
    doAnswer(invocation -&gt; {
        madeDirs.add(invocation.getArgument(0));
        return true;
    }).when(session).mkdir(anyString());
    when(sessionFactory.getSession()).thenReturn(session);
    Message&lt;String&gt; requestMessage = MessageBuilder.withPayload("foo").setHeader(FileHeaders.RENAME_TO, "bar").build();
    MessageBuilder&lt;?&gt; out = (MessageBuilder&lt;?&gt;) gw.handleRequestMessage(requestMessage);
    assertThat(out.getHeaders().get(FileHeaders.REMOTE_FILE)).isEqualTo("foo");
    assertThat(args.get()).isEqualTo("foofoo/bar/baz");
    assertThat(out.getPayload()).isEqualTo(Boolean.TRUE);
    assertThat(madeDirs.size()).isEqualTo(2);
    assertThat(madeDirs.get(0)).isEqualTo("foo");
    assertThat(madeDirs.get(1)).isEqualTo("foo/bar");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMoveWithMkDirs</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"mv"</span>, <span class="hljs-string">"payload"</span>);

    gw.setRenameExpression(PARSER.parseExpression(<span class="hljs-string">"'foo/bar/baz'"</span>));

    gw.afterPropertiesSet();

    Session&lt;?&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> AtomicReference&lt;String&gt; args = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    doAnswer(invocation -&gt; {

        Object[] arguments = invocation.getArguments();

        args.set((String) arguments[<span class="hljs-number">0</span>] + arguments[<span class="hljs-number">1</span>]);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(session).rename(anyString(), anyString());

    <span class="hljs-keyword">final</span> List&lt;String&gt; madeDirs = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    doAnswer(invocation -&gt; {

        madeDirs.add(invocation.getArgument(<span class="hljs-number">0</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;

    }).when(session).mkdir(anyString());

    when(sessionFactory.getSession()).thenReturn(session);

    Message&lt;String&gt; requestMessage = MessageBuilder.withPayload(<span class="hljs-string">"foo"</span>).setHeader(FileHeaders.RENAME_TO, <span class="hljs-string">"bar"</span>).build();

    MessageBuilder&lt;?&gt; out = (MessageBuilder&lt;?&gt;) gw.handleRequestMessage(requestMessage);

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_FILE)).isEqualTo(<span class="hljs-string">"foo"</span>);

    assertThat(args.get()).isEqualTo(<span class="hljs-string">"foofoo/bar/baz"</span>);

    assertThat(out.getPayload()).isEqualTo(Boolean.TRUE);

    assertThat(madeDirs.size()).isEqualTo(<span class="hljs-number">2</span>);

    assertThat(madeDirs.get(<span class="hljs-number">0</span>)).isEqualTo(<span class="hljs-string">"foo"</span>);

    assertThat(madeDirs.get(<span class="hljs-number">1</span>)).isEqualTo(<span class="hljs-string">"foo/bar"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session&lt;?&gt; createMockSession(AtomicReference&lt;String&gt; args) {
    Session&lt;?&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(invocation -&gt; {
        Object[] arguments = invocation.getArguments();
        args.set((String) arguments[<span class="hljs-number">0</span>] + arguments[<span class="hljs-number">1</span>]);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).when(session).rename(anyString(), anyString());
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci11">Mock Clone Instance #spring-integration_MCI_11</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.support.locks.LockRegistry</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> LockRegistry <span class="hljs-title">createMockLockRegistry</span><span class="hljs-params">(Lock lock)</span> </span>{
    LockRegistry registry = mock(LockRegistry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(registry.obtain(anyString())).willReturn(lock);
    <span class="hljs-keyword">return</span> registry;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest111">Test Case ID #spring-integration_Test_11_1</h4>
<h4 id="test-case-name-competingwithlockfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationsupportleaderlockregistryleaderinitiatortestsjava">Test Case Name: <code>competingWithLock</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\support\leader\LockRegistryLeaderInitiatorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-firstregistry">Mock Object Variable Name: <code>firstRegistry</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    // switch used to toggle which registry obtains lock
    AtomicBoolean firstLocked = new AtomicBoolean(true);
    // set up first registry instance - this one will be able to obtain lock initially
<span class="hljs-deletion">-    LockRegistry firstRegistry = mock(LockRegistry.class);</span>
    Lock firstLock = mock(Lock.class);
<span class="hljs-deletion">-    given(firstRegistry.obtain(anyString())).willReturn(firstLock);</span>
<span class="hljs-addition">+    LockRegistry firstRegistry = createMockLockRegistry(firstLock);</span>
    given(firstLock.tryLock(anyLong(), any(TimeUnit.class))).willAnswer(i -&gt; firstLocked.get());
    // set up first initiator instance using first LockRegistry
    LockRegistryLeaderInitiator first = new LockRegistryLeaderInitiator(firstRegistry, new DefaultCandidate());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">competingWithLock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-comment">// switch used to toggle which registry obtains lock</span>

    AtomicBoolean firstLocked = <span class="hljs-keyword">new</span> AtomicBoolean(<span class="hljs-keyword">true</span>);

    <span class="hljs-comment">// set up first registry instance - this one will be able to obtain lock initially</span>

    LockRegistry firstRegistry = mock(LockRegistry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Lock firstLock = mock(Lock<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(firstRegistry.obtain(anyString())).willReturn(firstLock);

    given(firstLock.tryLock(anyLong(), any(TimeUnit<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willAnswer</span>(<span class="hljs-title">i</span> -&gt; <span class="hljs-title">firstLocked</span>.<span class="hljs-title">get</span>())</span>;

    <span class="hljs-comment">// set up first initiator instance using first LockRegistry</span>

    LockRegistryLeaderInitiator first = <span class="hljs-keyword">new</span> LockRegistryLeaderInitiator(firstRegistry, <span class="hljs-keyword">new</span> DefaultCandidate());

    CountDownLatch firstGranted = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    CountDownLatch firstRevoked = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    CountDownLatch firstAquireLockFailed = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    first.setHeartBeatMillis(<span class="hljs-number">10</span>);

    first.setBusyWaitMillis(<span class="hljs-number">1</span>);

    first.setLeaderEventPublisher(<span class="hljs-keyword">new</span> CountingPublisher(firstGranted, firstRevoked, firstAquireLockFailed));

    <span class="hljs-comment">// set up second registry instance - this one will NOT be able to obtain lock initially</span>

    LockRegistry secondRegistry = mock(LockRegistry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Lock secondLock = mock(Lock<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(secondRegistry.obtain(anyString())).willReturn(secondLock);

    given(secondLock.tryLock(anyLong(), any(TimeUnit<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willAnswer</span>(<span class="hljs-title">i</span> -&gt; !<span class="hljs-title">firstLocked</span>.<span class="hljs-title">get</span>())</span>;

    <span class="hljs-comment">// set up second initiator instance using second LockRegistry</span>

    LockRegistryLeaderInitiator second = <span class="hljs-keyword">new</span> LockRegistryLeaderInitiator(secondRegistry, <span class="hljs-keyword">new</span> DefaultCandidate());

    CountDownLatch secondGranted = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    CountDownLatch secondRevoked = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    CountDownLatch secondAquireLockFailed = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    second.setHeartBeatMillis(<span class="hljs-number">10</span>);

    second.setBusyWaitMillis(<span class="hljs-number">1</span>);

    second.setLeaderEventPublisher(<span class="hljs-keyword">new</span> CountingPublisher(secondGranted, secondRevoked, secondAquireLockFailed));

    <span class="hljs-comment">// start initiators</span>

    first.start();

    second.start();

    <span class="hljs-comment">// first initiator should lead and publish granted event</span>

    assertThat(firstGranted.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    assertThat(first.getContext().isLeader()).isTrue();

    assertThat(second.getContext().isLeader()).isFalse();

    <span class="hljs-comment">// simulate first registry instance unable to obtain lock, for example due to lock timeout</span>

    firstLocked.set(<span class="hljs-keyword">false</span>);

    <span class="hljs-comment">// second initiator should take lead and publish granted event, first initiator should publish revoked event</span>

    assertThat(secondGranted.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    assertThat(firstRevoked.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    assertThat(second.getContext().isLeader()).isTrue();

    assertThat(first.getContext().isLeader()).isFalse();

    first.stop();

    second.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> LockRegistry <span class="hljs-title">createMockLockRegistry</span><span class="hljs-params">(Lock lock)</span> </span>{
    LockRegistry registry = mock(LockRegistry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(registry.obtain(anyString())).willReturn(lock);
    <span class="hljs-keyword">return</span> registry;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest112">Test Case ID #spring-integration_Test_11_2</h4>
<h4 id="test-case-name-competingwithlockfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationsupportleaderlockregistryleaderinitiatortestsjava">Test Case Name: <code>competingWithLock</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\support\leader\LockRegistryLeaderInitiatorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-secondregistry">Mock Object Variable Name: <code>secondRegistry</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    second.setHeartBeatMillis(10);
    second.setBusyWaitMillis(1);
    second.setLeaderEventPublisher(new CountingPublisher(secondGranted, secondRevoked, secondAquireLockFailed));
    // start initiators
    first.start();
    second.start();
@@
    // set up second registry instance - this one will NOT be able to obtain lock initially
<span class="hljs-deletion">-    LockRegistry secondRegistry = mock(LockRegistry.class);</span>
    Lock secondLock = mock(Lock.class);
<span class="hljs-addition">+    LockRegistry secondRegistry = createMockLockRegistry(secondLock);</span>
    given(secondLock.tryLock(anyLong(), any(TimeUnit.class))).willAnswer(i -&gt; !firstLocked.get());
    // set up second initiator instance using second LockRegistry
    LockRegistryLeaderInitiator second = new LockRegistryLeaderInitiator(secondRegistry, new DefaultCandidate());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">competingWithLock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-comment">// switch used to toggle which registry obtains lock</span>

    AtomicBoolean firstLocked = <span class="hljs-keyword">new</span> AtomicBoolean(<span class="hljs-keyword">true</span>);

    <span class="hljs-comment">// set up first registry instance - this one will be able to obtain lock initially</span>

    LockRegistry firstRegistry = mock(LockRegistry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Lock firstLock = mock(Lock<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(firstRegistry.obtain(anyString())).willReturn(firstLock);

    given(firstLock.tryLock(anyLong(), any(TimeUnit<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willAnswer</span>(<span class="hljs-title">i</span> -&gt; <span class="hljs-title">firstLocked</span>.<span class="hljs-title">get</span>())</span>;

    <span class="hljs-comment">// set up first initiator instance using first LockRegistry</span>

    LockRegistryLeaderInitiator first = <span class="hljs-keyword">new</span> LockRegistryLeaderInitiator(firstRegistry, <span class="hljs-keyword">new</span> DefaultCandidate());

    CountDownLatch firstGranted = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    CountDownLatch firstRevoked = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    CountDownLatch firstAquireLockFailed = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    first.setHeartBeatMillis(<span class="hljs-number">10</span>);

    first.setBusyWaitMillis(<span class="hljs-number">1</span>);

    first.setLeaderEventPublisher(<span class="hljs-keyword">new</span> CountingPublisher(firstGranted, firstRevoked, firstAquireLockFailed));

    <span class="hljs-comment">// set up second registry instance - this one will NOT be able to obtain lock initially</span>

    LockRegistry secondRegistry = mock(LockRegistry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Lock secondLock = mock(Lock<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(secondRegistry.obtain(anyString())).willReturn(secondLock);

    given(secondLock.tryLock(anyLong(), any(TimeUnit<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willAnswer</span>(<span class="hljs-title">i</span> -&gt; !<span class="hljs-title">firstLocked</span>.<span class="hljs-title">get</span>())</span>;

    <span class="hljs-comment">// set up second initiator instance using second LockRegistry</span>

    LockRegistryLeaderInitiator second = <span class="hljs-keyword">new</span> LockRegistryLeaderInitiator(secondRegistry, <span class="hljs-keyword">new</span> DefaultCandidate());

    CountDownLatch secondGranted = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    CountDownLatch secondRevoked = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    CountDownLatch secondAquireLockFailed = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    second.setHeartBeatMillis(<span class="hljs-number">10</span>);

    second.setBusyWaitMillis(<span class="hljs-number">1</span>);

    second.setLeaderEventPublisher(<span class="hljs-keyword">new</span> CountingPublisher(secondGranted, secondRevoked, secondAquireLockFailed));

    <span class="hljs-comment">// start initiators</span>

    first.start();

    second.start();

    <span class="hljs-comment">// first initiator should lead and publish granted event</span>

    assertThat(firstGranted.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    assertThat(first.getContext().isLeader()).isTrue();

    assertThat(second.getContext().isLeader()).isFalse();

    <span class="hljs-comment">// simulate first registry instance unable to obtain lock, for example due to lock timeout</span>

    firstLocked.set(<span class="hljs-keyword">false</span>);

    <span class="hljs-comment">// second initiator should take lead and publish granted event, first initiator should publish revoked event</span>

    assertThat(secondGranted.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    assertThat(firstRevoked.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    assertThat(second.getContext().isLeader()).isTrue();

    assertThat(first.getContext().isLeader()).isFalse();

    first.stop();

    second.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> LockRegistry <span class="hljs-title">createMockLockRegistry</span><span class="hljs-params">(Lock lock)</span> </span>{
    LockRegistry registry = mock(LockRegistry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(registry.obtain(anyString())).willReturn(lock);
    <span class="hljs-keyword">return</span> registry;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest113">Test Case ID #spring-integration_Test_11_3</h4>
<h4 id="test-case-name-testgracefulleaderselectorexitfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationsupportleaderlockregistryleaderinitiatortestsjava">Test Case Name: <code>testGracefulLeaderSelectorExit</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\support\leader\LockRegistryLeaderInitiatorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-registry">Mock Object Variable Name: <code>registry</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    AtomicReference&lt;Throwable&gt; throwableAtomicReference = new AtomicReference&lt;&gt;();
<span class="hljs-deletion">-    LockRegistry registry = mock(LockRegistry.class);</span>
    Lock lock = spy(new ReentrantLock());
    willAnswer(invocation -&gt; {
        try {
            return invocation.callRealMethod();
        } catch (Throwable e) {
            throwableAtomicReference.set(e);
            throw e;
        }
    }).given(lock).unlock();
<span class="hljs-deletion">-    given(registry.obtain(anyString())).willReturn(lock);</span>
<span class="hljs-addition">+    LockRegistry registry = createMockLockRegistry(lock);</span>
    LockRegistryLeaderInitiator another = new LockRegistryLeaderInitiator(registry);
    willAnswer(invocation -&gt; {
        another.stop();
        return false;
    }).given(lock).tryLock(anyLong(), eq(TimeUnit.MILLISECONDS));
    new DirectFieldAccessor(another).setPropertyValue("taskExecutor", new TaskExecutorAdapter(new SyncTaskExecutor()));
    another.start();
    Throwable throwable = throwableAtomicReference.get();
    assertThat(throwable).isNull();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGracefulLeaderSelectorExit</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AtomicReference&lt;Throwable&gt; throwableAtomicReference = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    LockRegistry registry = mock(LockRegistry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Lock lock = spy(<span class="hljs-keyword">new</span> ReentrantLock());

    willAnswer(invocation -&gt; {

        <span class="hljs-keyword">try</span> {

            <span class="hljs-keyword">return</span> invocation.callRealMethod();

        } <span class="hljs-keyword">catch</span> (Throwable e) {

            throwableAtomicReference.set(e);

            <span class="hljs-keyword">throw</span> e;

        }

    }).given(lock).unlock();

    given(registry.obtain(anyString())).willReturn(lock);

    LockRegistryLeaderInitiator another = <span class="hljs-keyword">new</span> LockRegistryLeaderInitiator(registry);

    willAnswer(invocation -&gt; {

        another.stop();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;

    }).given(lock).tryLock(anyLong(), eq(TimeUnit.MILLISECONDS));

    <span class="hljs-keyword">new</span> DirectFieldAccessor(another).setPropertyValue(<span class="hljs-string">"taskExecutor"</span>, <span class="hljs-keyword">new</span> TaskExecutorAdapter(<span class="hljs-keyword">new</span> SyncTaskExecutor()));

    another.start();

    Throwable throwable = throwableAtomicReference.get();

    assertThat(throwable).isNull();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> LockRegistry <span class="hljs-title">createMockLockRegistry</span><span class="hljs-params">(Lock lock)</span> </span>{
    LockRegistry registry = mock(LockRegistry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(registry.obtain(anyString())).willReturn(lock);
    <span class="hljs-keyword">return</span> registry;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci12">Mock Clone Instance #spring-integration_MCI_12</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>java.nio.channels.SocketChannel</code></li>
<li><strong>Test Case Count</strong>: 7</li>
<li><strong>MO Count</strong>: 8</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockSocketChannel</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SocketChannel <span class="hljs-title">createMockSocketChannel</span><span class="hljs-params">(Socket socket)</span> </span>{
        SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(socketChannel.socket()).thenReturn(socket);
        <span class="hljs-keyword">return</span> socketChannel;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest121">Test Case ID #spring-integration_Test_12_1</h4>
<h4 id="test-case-name-testbinaryfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpnetconnectiontestsjava">Test Case Name: <code>testBinary</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpNetConnectionTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socketchannel">Mock Object Variable Name: <code>socketChannel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testBinary() throws Exception {
<span class="hljs-deletion">-    SocketChannel socketChannel = mock(SocketChannel.class);</span>
     Socket socket = mock(Socket.class);
<span class="hljs-deletion">-    when(socketChannel.socket()).thenReturn(socket);</span>
<span class="hljs-addition">+    SocketChannel socketChannel = MockSocketChannel.createMockSocketChannel(socket);</span>
     TcpNioConnection connection = new TcpNioConnection(socketChannel, true, false, e -&gt; {
     }, null);
     ChannelInputStream inputStream = TestUtils.getPropertyValue(connection, "channelInputStream", ChannelInputStream.class);
     inputStream.write(ByteBuffer.wrap(new byte[] { (byte) 0x80 }));
     assertThat(inputStream.read()).isEqualTo(0x80);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testBinary</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(socketChannel.socket()).thenReturn(socket);

    TcpNioConnection connection = <span class="hljs-keyword">new</span> TcpNioConnection(socketChannel, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, e -&gt; {

    }, <span class="hljs-keyword">null</span>);

    ChannelInputStream inputStream = TestUtils.getPropertyValue(connection, <span class="hljs-string">"channelInputStream"</span>, ChannelInputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    inputStream.write(ByteBuffer.wrap(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[] { (<span class="hljs-keyword">byte</span>) <span class="hljs-number">0x80</span> }));

    assertThat(inputStream.read()).isEqualTo(<span class="hljs-number">0x80</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockSocketChannel</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SocketChannel <span class="hljs-title">createMockSocketChannel</span><span class="hljs-params">(Socket socket)</span> </span>{
        SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(socketChannel.socket()).thenReturn(socket);
        <span class="hljs-keyword">return</span> socketChannel;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest122">Test Case ID #spring-integration_Test_12_2</h4>
<h4 id="test-case-name-testbytearrayreadfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpnioconnectiontestsjava">Test Case Name: <code>testByteArrayRead</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpNioConnectionTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socketchannel">Mock Object Variable Name: <code>socketChannel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testByteArrayRead() throws Exception {
<span class="hljs-deletion">-    SocketChannel socketChannel = mock(SocketChannel.class);</span>
     Socket socket = mock(Socket.class);
<span class="hljs-deletion">-    when(socketChannel.socket()).thenReturn(socket);</span>
<span class="hljs-addition">+    SocketChannel socketChannel = MockSocketChannel.createMockSocketChannel(socket);</span>
     TcpNioConnection connection = new TcpNioConnection(socketChannel, false, false, null, null);
     TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) new DirectFieldAccessor(connection).getPropertyValue("channelInputStream");
     stream.write(ByteBuffer.wrap("foo".getBytes()));
     byte[] out = new byte[2];
     int n = stream.read(out);
     assertThat(n).isEqualTo(2);
     assertThat(new String(out)).isEqualTo("fo");
     out = new byte[2];
     n = stream.read(out);
     assertThat(n).isEqualTo(1);
     assertThat(new String(out)).isEqualTo("o\u0000");
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testByteArrayRead</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(socketChannel.socket()).thenReturn(socket);

    TcpNioConnection connection = <span class="hljs-keyword">new</span> TcpNioConnection(socketChannel, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

    TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) <span class="hljs-keyword">new</span> DirectFieldAccessor(connection).getPropertyValue(<span class="hljs-string">"channelInputStream"</span>);

    stream.write(ByteBuffer.wrap(<span class="hljs-string">"foo"</span>.getBytes()));

    <span class="hljs-keyword">byte</span>[] out = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">2</span>];

    <span class="hljs-keyword">int</span> n = stream.read(out);

    assertThat(n).isEqualTo(<span class="hljs-number">2</span>);

    assertThat(<span class="hljs-keyword">new</span> String(out)).isEqualTo(<span class="hljs-string">"fo"</span>);

    out = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">2</span>];

    n = stream.read(out);

    assertThat(n).isEqualTo(<span class="hljs-number">1</span>);

    assertThat(<span class="hljs-keyword">new</span> String(out)).isEqualTo(<span class="hljs-string">"o\u0000"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockSocketChannel</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SocketChannel <span class="hljs-title">createMockSocketChannel</span><span class="hljs-params">(Socket socket)</span> </span>{
        SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(socketChannel.socket()).thenReturn(socket);
        <span class="hljs-keyword">return</span> socketChannel;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest123">Test Case ID #spring-integration_Test_12_3</h4>
<h4 id="test-case-name-testbytearrayreadmultifile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpnioconnectiontestsjava">Test Case Name: <code>testByteArrayReadMulti</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpNioConnectionTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socketchannel">Mock Object Variable Name: <code>socketChannel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testByteArrayReadMulti() throws Exception {
<span class="hljs-deletion">-    SocketChannel socketChannel = mock(SocketChannel.class);</span>
     Socket socket = mock(Socket.class);
<span class="hljs-deletion">-    when(socketChannel.socket()).thenReturn(socket);</span>
<span class="hljs-addition">+    SocketChannel socketChannel = MockSocketChannel.createMockSocketChannel(socket);</span>
     TcpNioConnection connection = new TcpNioConnection(socketChannel, false, false, null, null);
     TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) new DirectFieldAccessor(connection).getPropertyValue("channelInputStream");
     stream.write(ByteBuffer.wrap("foo".getBytes()));
     stream.write(ByteBuffer.wrap("bar".getBytes()));
     byte[] out = new byte[6];
     int n = stream.read(out);
     assertThat(n).isEqualTo(6);
     assertThat(new String(out)).isEqualTo("foobar");
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testByteArrayReadMulti</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(socketChannel.socket()).thenReturn(socket);

    TcpNioConnection connection = <span class="hljs-keyword">new</span> TcpNioConnection(socketChannel, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

    TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) <span class="hljs-keyword">new</span> DirectFieldAccessor(connection).getPropertyValue(<span class="hljs-string">"channelInputStream"</span>);

    stream.write(ByteBuffer.wrap(<span class="hljs-string">"foo"</span>.getBytes()));

    stream.write(ByteBuffer.wrap(<span class="hljs-string">"bar"</span>.getBytes()));

    <span class="hljs-keyword">byte</span>[] out = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">6</span>];

    <span class="hljs-keyword">int</span> n = stream.read(out);

    assertThat(n).isEqualTo(<span class="hljs-number">6</span>);

    assertThat(<span class="hljs-keyword">new</span> String(out)).isEqualTo(<span class="hljs-string">"foobar"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockSocketChannel</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SocketChannel <span class="hljs-title">createMockSocketChannel</span><span class="hljs-params">(Socket socket)</span> </span>{
        SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(socketChannel.socket()).thenReturn(socket);
        <span class="hljs-keyword">return</span> socketChannel;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest124">Test Case ID #spring-integration_Test_12_4</h4>
<h4 id="test-case-name-testbytearrayreadwithoffsetfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpnioconnectiontestsjava">Test Case Name: <code>testByteArrayReadWithOffset</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpNioConnectionTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socketchannel">Mock Object Variable Name: <code>socketChannel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testByteArrayReadWithOffset() throws Exception {
<span class="hljs-deletion">-    SocketChannel socketChannel = mock(SocketChannel.class);</span>
     Socket socket = mock(Socket.class);
<span class="hljs-deletion">-    when(socketChannel.socket()).thenReturn(socket);</span>
<span class="hljs-addition">+    SocketChannel socketChannel = MockSocketChannel.createMockSocketChannel(socket);</span>
     TcpNioConnection connection = new TcpNioConnection(socketChannel, false, false, null, null);
     TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) new DirectFieldAccessor(connection).getPropertyValue("channelInputStream");
     stream.write(ByteBuffer.wrap("foo".getBytes()));
     byte[] out = new byte[5];
     int n = stream.read(out, 1, 4);
     assertThat(n).isEqualTo(3);
     assertThat(new String(out)).isEqualTo("\u0000foo\u0000");
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testByteArrayReadWithOffset</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(socketChannel.socket()).thenReturn(socket);

    TcpNioConnection connection = <span class="hljs-keyword">new</span> TcpNioConnection(socketChannel, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

    TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) <span class="hljs-keyword">new</span> DirectFieldAccessor(connection).getPropertyValue(<span class="hljs-string">"channelInputStream"</span>);

    stream.write(ByteBuffer.wrap(<span class="hljs-string">"foo"</span>.getBytes()));

    <span class="hljs-keyword">byte</span>[] out = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">5</span>];

    <span class="hljs-keyword">int</span> n = stream.read(out, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>);

    assertThat(n).isEqualTo(<span class="hljs-number">3</span>);

    assertThat(<span class="hljs-keyword">new</span> String(out)).isEqualTo(<span class="hljs-string">"\u0000foo\u0000"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockSocketChannel</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SocketChannel <span class="hljs-title">createMockSocketChannel</span><span class="hljs-params">(Socket socket)</span> </span>{
        SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(socketChannel.socket()).thenReturn(socket);
        <span class="hljs-keyword">return</span> socketChannel;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest125">Test Case ID #spring-integration_Test_12_5</h4>
<h4 id="test-case-name-testbytearrayreadwithbadargsfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpnioconnectiontestsjava">Test Case Name: <code>testByteArrayReadWithBadArgs</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpNioConnectionTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socketchannel">Mock Object Variable Name: <code>socketChannel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testByteArrayReadWithBadArgs() throws Exception {
<span class="hljs-deletion">-    SocketChannel socketChannel = mock(SocketChannel.class);</span>
     Socket socket = mock(Socket.class);
<span class="hljs-deletion">-    when(socketChannel.socket()).thenReturn(socket);</span>
<span class="hljs-addition">+    SocketChannel socketChannel = MockSocketChannel.createMockSocketChannel(socket);</span>
     TcpNioConnection connection = new TcpNioConnection(socketChannel, false, false, null, null);
     TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) new DirectFieldAccessor(connection).getPropertyValue("channelInputStream");
     stream.write(ByteBuffer.wrap("foo".getBytes()));
     byte[] out = new byte[5];
     assertThatExceptionOfType(IndexOutOfBoundsException.class).isThrownBy(() -&gt; stream.read(out, 1, 5));
     assertThatIllegalArgumentException().isThrownBy(() -&gt; stream.read(null, 1, 5));
     assertThat(stream.read(out, 0, 0)).isEqualTo(0);
     assertThat(stream.read(out)).isEqualTo(3);
}
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testByteArrayReadWithBadArgs</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(socketChannel.socket()).thenReturn(socket);

    TcpNioConnection connection = <span class="hljs-keyword">new</span> TcpNioConnection(socketChannel, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

    TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) <span class="hljs-keyword">new</span> DirectFieldAccessor(connection).getPropertyValue(<span class="hljs-string">"channelInputStream"</span>);

    stream.write(ByteBuffer.wrap(<span class="hljs-string">"foo"</span>.getBytes()));

    <span class="hljs-keyword">byte</span>[] out = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">5</span>];

    assertThatExceptionOfType(IndexOutOfBoundsException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(() -&gt; <span class="hljs-title">stream</span>.<span class="hljs-title">read</span>(<span class="hljs-title">out</span>, 1, 5))</span>;

    assertThatIllegalArgumentException().isThrownBy(() -&gt; stream.read(<span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>));

    assertThat(stream.read(out, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)).isEqualTo(<span class="hljs-number">0</span>);

    assertThat(stream.read(out)).isEqualTo(<span class="hljs-number">3</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockSocketChannel</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SocketChannel <span class="hljs-title">createMockSocketChannel</span><span class="hljs-params">(Socket socket)</span> </span>{
        SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(socketChannel.socket()).thenReturn(socket);
        <span class="hljs-keyword">return</span> socketChannel;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest126">Test Case ID #spring-integration_Test_12_6</h4>
<h4 id="test-case-name-testbytearrayblocksforzeroreadfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpnioconnectiontestsjava">Test Case Name: <code>testByteArrayBlocksForZeroRead</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpNioConnectionTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socketchannel">Mock Object Variable Name: <code>socketChannel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testByteArrayBlocksForZeroRead() throws Exception {
<span class="hljs-deletion">-    SocketChannel socketChannel = mock(SocketChannel.class);</span>
     Socket socket = mock(Socket.class);
<span class="hljs-deletion">-    when(socketChannel.socket()).thenReturn(socket);</span>
<span class="hljs-addition">+    SocketChannel socketChannel = MockSocketChannel.createMockSocketChannel(socket);</span>
     TcpNioConnection connection = new TcpNioConnection(socketChannel, false, false, null, null);
     final TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) new DirectFieldAccessor(connection).getPropertyValue("channelInputStream");
     final CountDownLatch latch = new CountDownLatch(1);
     final byte[] out = new byte[4];
     this.executor.execute(() -&gt; {
         try {
             stream.read(out);
         } catch (IOException e) {
             throw new UncheckedIOException(e);
         }
         latch.countDown();
     });
     Thread.sleep(1000);
     assertThat(out[0]).isEqualTo((byte) 0x00);
     stream.write(ByteBuffer.wrap("foo".getBytes()));
     assertThat(latch.await(10, TimeUnit.SECONDS)).isTrue();
     assertThat(new String(out)).isEqualTo("foo\u0000");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testByteArrayBlocksForZeroRead</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(socketChannel.socket()).thenReturn(socket);

    TcpNioConnection connection = <span class="hljs-keyword">new</span> TcpNioConnection(socketChannel, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

    <span class="hljs-keyword">final</span> TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) <span class="hljs-keyword">new</span> DirectFieldAccessor(connection).getPropertyValue(<span class="hljs-string">"channelInputStream"</span>);

    <span class="hljs-keyword">final</span> CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] out = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">4</span>];

    <span class="hljs-keyword">this</span>.executor.execute(() -&gt; {

        <span class="hljs-keyword">try</span> {

            stream.read(out);

        } <span class="hljs-keyword">catch</span> (IOException e) {

            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UncheckedIOException(e);

        }

        latch.countDown();

    });

    Thread.sleep(<span class="hljs-number">1000</span>);

    assertThat(out[<span class="hljs-number">0</span>]).isEqualTo((<span class="hljs-keyword">byte</span>) <span class="hljs-number">0x00</span>);

    stream.write(ByteBuffer.wrap(<span class="hljs-string">"foo"</span>.getBytes()));

    assertThat(latch.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    assertThat(<span class="hljs-keyword">new</span> String(out)).isEqualTo(<span class="hljs-string">"foo\u0000"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockSocketChannel</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SocketChannel <span class="hljs-title">createMockSocketChannel</span><span class="hljs-params">(Socket socket)</span> </span>{
        SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(socketChannel.socket()).thenReturn(socket);
        <span class="hljs-keyword">return</span> socketChannel;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest127">Test Case ID #spring-integration_Test_12_7</h4>
<h4 id="test-case-name-transferheadersfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpnioconnectiontestsjava">Test Case Name: <code>transferHeaders</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpNioConnectionTests.java</code>)</h4>
<h4 id="mock-object-variable-name-inchannel">Mock Object Variable Name: <code>inChannel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Socket inSocket = mock(Socket.class);
<span class="hljs-deletion">-    SocketChannel inChannel = mock(SocketChannel.class);</span>
<span class="hljs-deletion">-    when(inChannel.socket()).thenReturn(inSocket);</span>
<span class="hljs-addition">+    SocketChannel inChannel = MockSocketChannel.createMockSocketChannel(inSocket);</span>
    TcpNioConnection inboundConnection = new TcpNioConnection(inChannel, true, false, nullPublisher, null);
    inboundConnection.setDeserializer(new MapJsonSerializer());
    MapMessageConverter inConverter = new MapMessageConverter();
    MessageConvertingTcpMessageMapper inMapper = new MessageConvertingTcpMessageMapper(inConverter);
    inboundConnection.setMapper(inMapper);
    final ByteArrayOutputStream written = new ByteArrayOutputStream();
    doAnswer(new Answer&lt;Integer&gt;() {

        @Override
        public Integer answer(InvocationOnMock invocation) {
            ByteBuffer buff = invocation.getArgument(0);
            byte[] bytes = written.toByteArray();
            buff.put(bytes);
            return bytes.length;
        }
    }).when(inChannel).read(any(ByteBuffer.class));
    Socket outSocket = mock(Socket.class);
    SocketChannel outChannel = mock(SocketChannel.class);
    when(outChannel.socket()).thenReturn(outSocket);
    TcpNioConnection outboundConnection = new TcpNioConnection(outChannel, true, false, nullPublisher, null);
    doAnswer(invocation -&gt; {
        ByteBuffer buff = invocation.getArgument(0);
        byte[] bytes = new byte[buff.limit()];
        buff.get(bytes);
        written.write(bytes);
        return null;
    }).when(outChannel).write(any(ByteBuffer.class));
    MapMessageConverter outConverter = new MapMessageConverter();
    outConverter.setHeaderNames("bar");
    MessageConvertingTcpMessageMapper outMapper = new MessageConvertingTcpMessageMapper(outConverter);
    outboundConnection.setMapper(outMapper);
    outboundConnection.setSerializer(new MapJsonSerializer());
    Message&lt;String&gt; message = MessageBuilder.withPayload("foo").setHeader("bar", "baz").build();
    outboundConnection.send(message);
    final AtomicReference&lt;Message&lt;?&gt;&gt; inboundMessage = new AtomicReference&lt;Message&lt;?&gt;&gt;();
    final CountDownLatch latch = new CountDownLatch(1);
    TcpListener listener = message1 -&gt; {
        inboundMessage.set(message1);
        latch.countDown();
        return false;
    };
    inboundConnection.registerListener(listener);
    inboundConnection.readPacket();
    assertThat(latch.await(10, TimeUnit.SECONDS)).isTrue();
    assertThat(inboundMessage.get()).isNotNull();
    assertThat(inboundMessage.get().getPayload()).isEqualTo("foo");
    assertThat(inboundMessage.get().getHeaders().get("bar")).isEqualTo("baz");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">transferHeaders</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Socket inSocket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketChannel inChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(inChannel.socket()).thenReturn(inSocket);

    TcpNioConnection inboundConnection = <span class="hljs-keyword">new</span> TcpNioConnection(inChannel, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, nullPublisher, <span class="hljs-keyword">null</span>);

    inboundConnection.setDeserializer(<span class="hljs-keyword">new</span> MapJsonSerializer());

    MapMessageConverter inConverter = <span class="hljs-keyword">new</span> MapMessageConverter();

    MessageConvertingTcpMessageMapper inMapper = <span class="hljs-keyword">new</span> MessageConvertingTcpMessageMapper(inConverter);

    inboundConnection.setMapper(inMapper);

    <span class="hljs-keyword">final</span> ByteArrayOutputStream written = <span class="hljs-keyword">new</span> ByteArrayOutputStream();

    doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Integer&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">answer</span><span class="hljs-params">(InvocationOnMock invocation)</span> </span>{

            ByteBuffer buff = invocation.getArgument(<span class="hljs-number">0</span>);

            <span class="hljs-keyword">byte</span>[] bytes = written.toByteArray();

            buff.put(bytes);

            <span class="hljs-keyword">return</span> bytes.length;

        }

    }).when(inChannel).read(any(ByteBuffer<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Socket outSocket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketChannel outChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(outChannel.socket()).thenReturn(outSocket);

    TcpNioConnection outboundConnection = <span class="hljs-keyword">new</span> TcpNioConnection(outChannel, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, nullPublisher, <span class="hljs-keyword">null</span>);

    doAnswer(invocation -&gt; {

        ByteBuffer buff = invocation.getArgument(<span class="hljs-number">0</span>);

        <span class="hljs-keyword">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[buff.limit()];

        buff.get(bytes);

        written.write(bytes);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(outChannel).write(any(ByteBuffer<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    MapMessageConverter outConverter = <span class="hljs-keyword">new</span> MapMessageConverter();

    outConverter.setHeaderNames(<span class="hljs-string">"bar"</span>);

    MessageConvertingTcpMessageMapper outMapper = <span class="hljs-keyword">new</span> MessageConvertingTcpMessageMapper(outConverter);

    outboundConnection.setMapper(outMapper);

    outboundConnection.setSerializer(<span class="hljs-keyword">new</span> MapJsonSerializer());

    Message&lt;String&gt; message = MessageBuilder.withPayload(<span class="hljs-string">"foo"</span>).setHeader(<span class="hljs-string">"bar"</span>, <span class="hljs-string">"baz"</span>).build();

    outboundConnection.send(message);

    <span class="hljs-keyword">final</span> AtomicReference&lt;Message&lt;?&gt;&gt; inboundMessage = <span class="hljs-keyword">new</span> AtomicReference&lt;Message&lt;?&gt;&gt;();

    <span class="hljs-keyword">final</span> CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    TcpListener listener = message1 -&gt; {

        inboundMessage.set(message1);

        latch.countDown();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;

    };

    inboundConnection.registerListener(listener);

    inboundConnection.readPacket();

    assertThat(latch.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    assertThat(inboundMessage.get()).isNotNull();

    assertThat(inboundMessage.get().getPayload()).isEqualTo(<span class="hljs-string">"foo"</span>);

    assertThat(inboundMessage.get().getHeaders().get(<span class="hljs-string">"bar"</span>)).isEqualTo(<span class="hljs-string">"baz"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockSocketChannel</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SocketChannel <span class="hljs-title">createMockSocketChannel</span><span class="hljs-params">(Socket socket)</span> </span>{
        SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(socketChannel.socket()).thenReturn(socket);
        <span class="hljs-keyword">return</span> socketChannel;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest128">Test Case ID #spring-integration_Test_12_8</h4>
<h4 id="test-case-name-transferheadersfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpnioconnectiontestsjava">Test Case Name: <code>transferHeaders</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpNioConnectionTests.java</code>)</h4>
<h4 id="mock-object-variable-name-outchannel">Mock Object Variable Name: <code>outChannel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Socket outSocket = mock(Socket.class);
<span class="hljs-deletion">-    SocketChannel outChannel = mock(SocketChannel.class);</span>
<span class="hljs-deletion">-    when(outChannel.socket()).thenReturn(outSocket);</span>
<span class="hljs-addition">+    SocketChannel outChannel = MockSocketChannel.createMockSocketChannel(outSocket);</span>
    TcpNioConnection outboundConnection = new TcpNioConnection(outChannel, true, false, nullPublisher, null);
    doAnswer(invocation -&gt; {
        ByteBuffer buff = invocation.getArgument(0);
        byte[] bytes = new byte[buff.limit()];
        buff.get(bytes);
        written.write(bytes);
        return null;
    }).when(outChannel).write(any(ByteBuffer.class));
    MapMessageConverter outConverter = new MapMessageConverter();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">transferHeaders</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Socket inSocket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketChannel inChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(inChannel.socket()).thenReturn(inSocket);

    TcpNioConnection inboundConnection = <span class="hljs-keyword">new</span> TcpNioConnection(inChannel, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, nullPublisher, <span class="hljs-keyword">null</span>);

    inboundConnection.setDeserializer(<span class="hljs-keyword">new</span> MapJsonSerializer());

    MapMessageConverter inConverter = <span class="hljs-keyword">new</span> MapMessageConverter();

    MessageConvertingTcpMessageMapper inMapper = <span class="hljs-keyword">new</span> MessageConvertingTcpMessageMapper(inConverter);

    inboundConnection.setMapper(inMapper);

    <span class="hljs-keyword">final</span> ByteArrayOutputStream written = <span class="hljs-keyword">new</span> ByteArrayOutputStream();

    doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Integer&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">answer</span><span class="hljs-params">(InvocationOnMock invocation)</span> </span>{

            ByteBuffer buff = invocation.getArgument(<span class="hljs-number">0</span>);

            <span class="hljs-keyword">byte</span>[] bytes = written.toByteArray();

            buff.put(bytes);

            <span class="hljs-keyword">return</span> bytes.length;

        }

    }).when(inChannel).read(any(ByteBuffer<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Socket outSocket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketChannel outChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(outChannel.socket()).thenReturn(outSocket);

    TcpNioConnection outboundConnection = <span class="hljs-keyword">new</span> TcpNioConnection(outChannel, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, nullPublisher, <span class="hljs-keyword">null</span>);

    doAnswer(invocation -&gt; {

        ByteBuffer buff = invocation.getArgument(<span class="hljs-number">0</span>);

        <span class="hljs-keyword">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[buff.limit()];

        buff.get(bytes);

        written.write(bytes);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(outChannel).write(any(ByteBuffer<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    MapMessageConverter outConverter = <span class="hljs-keyword">new</span> MapMessageConverter();

    outConverter.setHeaderNames(<span class="hljs-string">"bar"</span>);

    MessageConvertingTcpMessageMapper outMapper = <span class="hljs-keyword">new</span> MessageConvertingTcpMessageMapper(outConverter);

    outboundConnection.setMapper(outMapper);

    outboundConnection.setSerializer(<span class="hljs-keyword">new</span> MapJsonSerializer());

    Message&lt;String&gt; message = MessageBuilder.withPayload(<span class="hljs-string">"foo"</span>).setHeader(<span class="hljs-string">"bar"</span>, <span class="hljs-string">"baz"</span>).build();

    outboundConnection.send(message);

    <span class="hljs-keyword">final</span> AtomicReference&lt;Message&lt;?&gt;&gt; inboundMessage = <span class="hljs-keyword">new</span> AtomicReference&lt;Message&lt;?&gt;&gt;();

    <span class="hljs-keyword">final</span> CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    TcpListener listener = message1 -&gt; {

        inboundMessage.set(message1);

        latch.countDown();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;

    };

    inboundConnection.registerListener(listener);

    inboundConnection.readPacket();

    assertThat(latch.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    assertThat(inboundMessage.get()).isNotNull();

    assertThat(inboundMessage.get().getPayload()).isEqualTo(<span class="hljs-string">"foo"</span>);

    assertThat(inboundMessage.get().getHeaders().get(<span class="hljs-string">"bar"</span>)).isEqualTo(<span class="hljs-string">"baz"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockSocketChannel</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SocketChannel <span class="hljs-title">createMockSocketChannel</span><span class="hljs-params">(Socket socket)</span> </span>{
        SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(socketChannel.socket()).thenReturn(socket);
        <span class="hljs-keyword">return</span> socketChannel;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci13">Mock Clone Instance #spring-integration_MCI_13</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>java.nio.channels.SocketChannel</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SocketChannel <span class="hljs-title">createMockSocketChannel</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isOpenReturn)</span> </span>{
    SocketChannel channel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(isOpenReturn).given(channel).isOpen();
    <span class="hljs-keyword">return</span> channel;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest131">Test Case ID #spring-integration_Test_13_1</h4>
<h4 id="test-case-name-testcleanupfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpnioconnectiontestsjava">Test Case Name: <code>testCleanup</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpNioConnectionTests.java</code>)</h4>
<h4 id="mock-object-variable-name-chan1">Mock Object Variable Name: <code>chan1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Map&lt;SocketChannel, TcpNioConnection&gt; connections = new HashMap&lt;&gt;();
<span class="hljs-deletion">-    SocketChannel chan1 = mock(SocketChannel.class);</span>
<span class="hljs-addition">+    SocketChannel chan1 = createMockSocketChannel(true);</span>
    SocketChannel chan2 = mock(SocketChannel.class);
    SocketChannel chan3 = mock(SocketChannel.class);
    TcpNioConnection conn1 = mock(TcpNioConnection.class);
    TcpNioConnection conn2 = mock(TcpNioConnection.class);
    TcpNioConnection conn3 = mock(TcpNioConnection.class);
    connections.put(chan1, conn1);
    connections.put(chan2, conn2);
    connections.put(chan3, conn3);
<span class="hljs-deletion">-    willReturn(true).given(chan1).isOpen();</span>
    willReturn(true).given(chan2).isOpen();
    willReturn(true).given(chan3).isOpen();
    Selector selector = mock(Selector.class);
    HashSet&lt;SelectionKey&gt; keys = new HashSet&lt;&gt;();
    when(selector.selectedKeys()).thenReturn(keys);
    factory.processNioSelections(1, selector, null, connections);
    // all open
    assertThat(connections.size()).isEqualTo(3);
    DirectFieldAccessor factoryFieldAccessor = new DirectFieldAccessor(factory);
<span class="hljs-deletion">-    willReturn(false).given(chan1).isOpen();</span>
<span class="hljs-addition">+    willReturn(false).given(chan1).isOpen();</span>
    factory.processNioSelections(1, selector, null, connections);
    // interval didn't pass
    assertThat(connections.size()).isEqualTo(3);
    factoryFieldAccessor.setPropertyValue("nextCheckForClosedNioConnections", System.currentTimeMillis() - 10);
    factory.processNioSelections(1, selector, null, connections);
    // first is closed
    assertThat(connections.size()).isEqualTo(2);
    willReturn(false).given(chan2).isOpen();
    factory.processNioSelections(1, selector, null, connections);
    // interval didn't pass
    assertThat(connections.size()).isEqualTo(2);
    factoryFieldAccessor.setPropertyValue("nextCheckForClosedNioConnections", System.currentTimeMillis() - 10);
    factory.processNioSelections(1, selector, null, connections);
    // second is closed
    assertThat(connections.size()).isEqualTo(1);
    willReturn(false).given(chan3).isOpen();
    factory.processNioSelections(1, selector, null, connections);
    // interval didn't pass
    assertThat(connections.size()).isEqualTo(1);
    factoryFieldAccessor.setPropertyValue("nextCheckForClosedNioConnections", System.currentTimeMillis() - 10);
    factory.processNioSelections(1, selector, null, connections);
    // third is closed
    assertThat(connections.size()).isEqualTo(0);
    assertThat(TestUtils.getPropertyValue(factory, "connections", Map.class).size()).isEqualTo(0);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCleanup</span><span class="hljs-params">()</span> </span>{

    TcpNioClientConnectionFactory factory = <span class="hljs-keyword">new</span> TcpNioClientConnectionFactory(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">0</span>);

    factory.setApplicationEventPublisher(nullPublisher);

    Map&lt;SocketChannel, TcpNioConnection&gt; connections = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    SocketChannel chan1 = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketChannel chan2 = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketChannel chan3 = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNioConnection conn1 = mock(TcpNioConnection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNioConnection conn2 = mock(TcpNioConnection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNioConnection conn3 = mock(TcpNioConnection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    connections.put(chan1, conn1);

    connections.put(chan2, conn2);

    connections.put(chan3, conn3);

    willReturn(<span class="hljs-keyword">true</span>).given(chan1).isOpen();

    willReturn(<span class="hljs-keyword">true</span>).given(chan2).isOpen();

    willReturn(<span class="hljs-keyword">true</span>).given(chan3).isOpen();

    Selector selector = mock(Selector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HashSet&lt;SelectionKey&gt; keys = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    when(selector.selectedKeys()).thenReturn(keys);

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// all open</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">3</span>);

    DirectFieldAccessor factoryFieldAccessor = <span class="hljs-keyword">new</span> DirectFieldAccessor(factory);

    willReturn(<span class="hljs-keyword">false</span>).given(chan1).isOpen();

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// interval didn't pass</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">3</span>);

    factoryFieldAccessor.setPropertyValue(<span class="hljs-string">"nextCheckForClosedNioConnections"</span>, System.currentTimeMillis() - <span class="hljs-number">10</span>);

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// first is closed</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">2</span>);

    willReturn(<span class="hljs-keyword">false</span>).given(chan2).isOpen();

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// interval didn't pass</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">2</span>);

    factoryFieldAccessor.setPropertyValue(<span class="hljs-string">"nextCheckForClosedNioConnections"</span>, System.currentTimeMillis() - <span class="hljs-number">10</span>);

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// second is closed</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">1</span>);

    willReturn(<span class="hljs-keyword">false</span>).given(chan3).isOpen();

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// interval didn't pass</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">1</span>);

    factoryFieldAccessor.setPropertyValue(<span class="hljs-string">"nextCheckForClosedNioConnections"</span>, System.currentTimeMillis() - <span class="hljs-number">10</span>);

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// third is closed</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">0</span>);

    assertThat(TestUtils.getPropertyValue(factory, <span class="hljs-string">"connections"</span>, Map<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">size</span>()).<span class="hljs-title">isEqualTo</span>(0)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SocketChannel <span class="hljs-title">createMockSocketChannel</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isOpenReturn)</span> </span>{
    SocketChannel channel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(isOpenReturn).given(channel).isOpen();
    <span class="hljs-keyword">return</span> channel;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest132">Test Case ID #spring-integration_Test_13_2</h4>
<h4 id="test-case-name-testcleanupfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpnioconnectiontestsjava">Test Case Name: <code>testCleanup</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpNioConnectionTests.java</code>)</h4>
<h4 id="mock-object-variable-name-chan2">Mock Object Variable Name: <code>chan2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SocketChannel chan1 = mock(SocketChannel.class);
<span class="hljs-deletion">-    SocketChannel chan2 = mock(SocketChannel.class);</span>
<span class="hljs-addition">+    SocketChannel chan2 = createMockSocketChannel(true);</span>
    SocketChannel chan3 = mock(SocketChannel.class);
    TcpNioConnection conn1 = mock(TcpNioConnection.class);
    TcpNioConnection conn2 = mock(TcpNioConnection.class);
    TcpNioConnection conn3 = mock(TcpNioConnection.class);
    connections.put(chan1, conn1);
    connections.put(chan2, conn2);
    connections.put(chan3, conn3);
    willReturn(true).given(chan1).isOpen();
<span class="hljs-deletion">-    willReturn(true).given(chan2).isOpen();</span>
    willReturn(true).given(chan3).isOpen();
    Selector selector = mock(Selector.class);
    HashSet&lt;SelectionKey&gt; keys = new HashSet&lt;&gt;();
    when(selector.selectedKeys()).thenReturn(keys);
    factory.processNioSelections(1, selector, null, connections);
    // all open
    assertThat(connections.size()).isEqualTo(3);
    DirectFieldAccessor factoryFieldAccessor = new DirectFieldAccessor(factory);
    willReturn(false).given(chan1).isOpen();
    factory.processNioSelections(1, selector, null, connections);
    // interval didn't pass
    assertThat(connections.size()).isEqualTo(3);
    factoryFieldAccessor.setPropertyValue("nextCheckForClosedNioConnections", System.currentTimeMillis() - 10);
    factory.processNioSelections(1, selector, null, connections);
    // first is closed
    assertThat(connections.size()).isEqualTo(2);
<span class="hljs-deletion">-    willReturn(false).given(chan2).isOpen();</span>
<span class="hljs-addition">+    willReturn(false).given(chan2).isOpen();</span>
    factory.processNioSelections(1, selector, null, connections);
    // interval didn't pass
    assertThat(connections.size()).isEqualTo(2);
    factoryFieldAccessor.setPropertyValue("nextCheckForClosedNioConnections", System.currentTimeMillis() - 10);
    factory.processNioSelections(1, selector, null, connections);
    // second is closed
    assertThat(connections.size()).isEqualTo(1);
    willReturn(false).given(chan3).isOpen();
    factory.processNioSelections(1, selector, null, connections);
    // interval didn't pass
    assertThat(connections.size()).isEqualTo(1);
    factoryFieldAccessor.setPropertyValue("nextCheckForClosedNioConnections", System.currentTimeMillis() - 10);
    factory.processNioSelections(1, selector, null, connections);
    // third is closed
    assertThat(connections.size()).isEqualTo(0);
    assertThat(TestUtils.getPropertyValue(factory, "connections", Map.class).size()).isEqualTo(0);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCleanup</span><span class="hljs-params">()</span> </span>{

    TcpNioClientConnectionFactory factory = <span class="hljs-keyword">new</span> TcpNioClientConnectionFactory(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">0</span>);

    factory.setApplicationEventPublisher(nullPublisher);

    Map&lt;SocketChannel, TcpNioConnection&gt; connections = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    SocketChannel chan1 = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketChannel chan2 = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketChannel chan3 = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNioConnection conn1 = mock(TcpNioConnection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNioConnection conn2 = mock(TcpNioConnection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNioConnection conn3 = mock(TcpNioConnection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    connections.put(chan1, conn1);

    connections.put(chan2, conn2);

    connections.put(chan3, conn3);

    willReturn(<span class="hljs-keyword">true</span>).given(chan1).isOpen();

    willReturn(<span class="hljs-keyword">true</span>).given(chan2).isOpen();

    willReturn(<span class="hljs-keyword">true</span>).given(chan3).isOpen();

    Selector selector = mock(Selector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HashSet&lt;SelectionKey&gt; keys = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    when(selector.selectedKeys()).thenReturn(keys);

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// all open</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">3</span>);

    DirectFieldAccessor factoryFieldAccessor = <span class="hljs-keyword">new</span> DirectFieldAccessor(factory);

    willReturn(<span class="hljs-keyword">false</span>).given(chan1).isOpen();

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// interval didn't pass</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">3</span>);

    factoryFieldAccessor.setPropertyValue(<span class="hljs-string">"nextCheckForClosedNioConnections"</span>, System.currentTimeMillis() - <span class="hljs-number">10</span>);

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// first is closed</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">2</span>);

    willReturn(<span class="hljs-keyword">false</span>).given(chan2).isOpen();

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// interval didn't pass</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">2</span>);

    factoryFieldAccessor.setPropertyValue(<span class="hljs-string">"nextCheckForClosedNioConnections"</span>, System.currentTimeMillis() - <span class="hljs-number">10</span>);

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// second is closed</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">1</span>);

    willReturn(<span class="hljs-keyword">false</span>).given(chan3).isOpen();

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// interval didn't pass</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">1</span>);

    factoryFieldAccessor.setPropertyValue(<span class="hljs-string">"nextCheckForClosedNioConnections"</span>, System.currentTimeMillis() - <span class="hljs-number">10</span>);

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// third is closed</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">0</span>);

    assertThat(TestUtils.getPropertyValue(factory, <span class="hljs-string">"connections"</span>, Map<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">size</span>()).<span class="hljs-title">isEqualTo</span>(0)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SocketChannel <span class="hljs-title">createMockSocketChannel</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isOpenReturn)</span> </span>{
    SocketChannel channel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(isOpenReturn).given(channel).isOpen();
    <span class="hljs-keyword">return</span> channel;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest133">Test Case ID #spring-integration_Test_13_3</h4>
<h4 id="test-case-name-testcleanupfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpnioconnectiontestsjava">Test Case Name: <code>testCleanup</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpNioConnectionTests.java</code>)</h4>
<h4 id="mock-object-variable-name-chan3">Mock Object Variable Name: <code>chan3</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SocketChannel chan1 = mock(SocketChannel.class);
    SocketChannel chan2 = mock(SocketChannel.class);
<span class="hljs-deletion">-    SocketChannel chan3 = mock(SocketChannel.class);</span>
<span class="hljs-addition">+    SocketChannel chan3 = createMockSocketChannel(true);</span>
    TcpNioConnection conn1 = mock(TcpNioConnection.class);
    TcpNioConnection conn2 = mock(TcpNioConnection.class);
    TcpNioConnection conn3 = mock(TcpNioConnection.class);
    connections.put(chan1, conn1);
    connections.put(chan2, conn2);
    connections.put(chan3, conn3);
    willReturn(true).given(chan1).isOpen();
    willReturn(true).given(chan2).isOpen();
<span class="hljs-deletion">-    willReturn(true).given(chan3).isOpen();</span>
    Selector selector = mock(Selector.class);
    HashSet&lt;SelectionKey&gt; keys = new HashSet&lt;&gt;();
    when(selector.selectedKeys()).thenReturn(keys);
    factory.processNioSelections(1, selector, null, connections);
    // all open
    assertThat(connections.size()).isEqualTo(3);
    DirectFieldAccessor factoryFieldAccessor = new DirectFieldAccessor(factory);
    willReturn(false).given(chan1).isOpen();
    factory.processNioSelections(1, selector, null, connections);
    // interval didn't pass
    assertThat(connections.size()).isEqualTo(3);
    factoryFieldAccessor.setPropertyValue("nextCheckForClosedNioConnections", System.currentTimeMillis() - 10);
    factory.processNioSelections(1, selector, null, connections);
    // first is closed
    assertThat(connections.size()).isEqualTo(2);
    willReturn(false).given(chan2).isOpen();
    factory.processNioSelections(1, selector, null, connections);
    // interval didn't pass
    assertThat(connections.size()).isEqualTo(2);
    factoryFieldAccessor.setPropertyValue("nextCheckForClosedNioConnections", System.currentTimeMillis() - 10);
    factory.processNioSelections(1, selector, null, connections);
    // second is closed
    assertThat(connections.size()).isEqualTo(1);
<span class="hljs-deletion">-    willReturn(false).given(chan3).isOpen();</span>
<span class="hljs-addition">+    willReturn(false).given(chan3).isOpen();</span>
    factory.processNioSelections(1, selector, null, connections);
    // interval didn't pass
    assertThat(connections.size()).isEqualTo(1);
    factoryFieldAccessor.setPropertyValue("nextCheckForClosedNioConnections", System.currentTimeMillis() - 10);
    factory.processNioSelections(1, selector, null, connections);
    // third is closed
    assertThat(connections.size()).isEqualTo(0);
    assertThat(TestUtils.getPropertyValue(factory, "connections", Map.class).size()).isEqualTo(0);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCleanup</span><span class="hljs-params">()</span> </span>{

    TcpNioClientConnectionFactory factory = <span class="hljs-keyword">new</span> TcpNioClientConnectionFactory(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">0</span>);

    factory.setApplicationEventPublisher(nullPublisher);

    Map&lt;SocketChannel, TcpNioConnection&gt; connections = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    SocketChannel chan1 = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketChannel chan2 = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketChannel chan3 = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNioConnection conn1 = mock(TcpNioConnection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNioConnection conn2 = mock(TcpNioConnection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNioConnection conn3 = mock(TcpNioConnection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    connections.put(chan1, conn1);

    connections.put(chan2, conn2);

    connections.put(chan3, conn3);

    willReturn(<span class="hljs-keyword">true</span>).given(chan1).isOpen();

    willReturn(<span class="hljs-keyword">true</span>).given(chan2).isOpen();

    willReturn(<span class="hljs-keyword">true</span>).given(chan3).isOpen();

    Selector selector = mock(Selector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HashSet&lt;SelectionKey&gt; keys = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    when(selector.selectedKeys()).thenReturn(keys);

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// all open</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">3</span>);

    DirectFieldAccessor factoryFieldAccessor = <span class="hljs-keyword">new</span> DirectFieldAccessor(factory);

    willReturn(<span class="hljs-keyword">false</span>).given(chan1).isOpen();

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// interval didn't pass</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">3</span>);

    factoryFieldAccessor.setPropertyValue(<span class="hljs-string">"nextCheckForClosedNioConnections"</span>, System.currentTimeMillis() - <span class="hljs-number">10</span>);

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// first is closed</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">2</span>);

    willReturn(<span class="hljs-keyword">false</span>).given(chan2).isOpen();

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// interval didn't pass</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">2</span>);

    factoryFieldAccessor.setPropertyValue(<span class="hljs-string">"nextCheckForClosedNioConnections"</span>, System.currentTimeMillis() - <span class="hljs-number">10</span>);

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// second is closed</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">1</span>);

    willReturn(<span class="hljs-keyword">false</span>).given(chan3).isOpen();

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// interval didn't pass</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">1</span>);

    factoryFieldAccessor.setPropertyValue(<span class="hljs-string">"nextCheckForClosedNioConnections"</span>, System.currentTimeMillis() - <span class="hljs-number">10</span>);

    factory.processNioSelections(<span class="hljs-number">1</span>, selector, <span class="hljs-keyword">null</span>, connections);

    <span class="hljs-comment">// third is closed</span>

    assertThat(connections.size()).isEqualTo(<span class="hljs-number">0</span>);

    assertThat(TestUtils.getPropertyValue(factory, <span class="hljs-string">"connections"</span>, Map<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">size</span>()).<span class="hljs-title">isEqualTo</span>(0)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SocketChannel <span class="hljs-title">createMockSocketChannel</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isOpenReturn)</span> </span>{
    SocketChannel channel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(isOpenReturn).given(channel).isOpen();
    <span class="hljs-keyword">return</span> channel;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci14">Mock Clone Instance #spring-integration_MCI_14</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.file.remote.session.Session</code></li>
<li><strong>Test Case Count</strong>: 11</li>
<li><strong>MO Count</strong>: 11</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session <span class="hljs-title">createMockSession</span><span class="hljs-params">(String path, TestLsEntry[] entries)</span> </span>{
    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(session.list(path)).thenReturn(entries);
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest141">Test Case ID #spring-integration_Test_14_1</h4>
<h4 id="test-case-name-testlsfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SessionFactory sessionFactory = mock(SessionFactory.class);
<span class="hljs-deletion">-    Session session = mock(Session.class);</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
    gw.afterPropertiesSet();
    when(sessionFactory.getSession()).thenReturn(session);
    TestLsEntry[] files = fileList();
<span class="hljs-deletion">-    when(session.list("testremote/x/")).thenReturn(files);</span>
<span class="hljs-addition">+    Session session = createMockSession("testremote/x/", files);</span>
    @SuppressWarnings("unchecked")
    MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote/x"));
    assertThat(out).isNotNull();
    assertThat(out.getPayload()).hasSize(2);
    // sort by default
    assertThat(out.getPayload().get(0)).isSameAs(files[1]);
    assertThat(out.getPayload().get(1)).isSameAs(files[0]);
    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo("testremote/x/");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] files = fileList();

    when(session.list(<span class="hljs-string">"testremote/x/"</span>)).thenReturn(files);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote/x"</span>));

    assertThat(out).isNotNull();

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">2</span>);

    <span class="hljs-comment">// sort by default</span>

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>)).isSameAs(files[<span class="hljs-number">1</span>]);

    assertThat(out.getPayload().get(<span class="hljs-number">1</span>)).isSameAs(files[<span class="hljs-number">0</span>]);

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo(<span class="hljs-string">"testremote/x/"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session <span class="hljs-title">createMockSession</span><span class="hljs-params">(String path, TestLsEntry[] entries)</span> </span>{
    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(session.list(path)).thenReturn(entries);
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest142">Test Case ID #spring-integration_Test_14_2</h4>
<h4 id="test-case-name-testlsffile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_f</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SessionFactory sessionFactory = mock(SessionFactory.class);
<span class="hljs-deletion">-    Session session = mock(Session.class);</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
    gw.setOptions("-f");
    gw.afterPropertiesSet();
    when(sessionFactory.getSession()).thenReturn(session);
    TestLsEntry[] files = fileList();
<span class="hljs-deletion">-    when(session.list("testremote/x/")).thenReturn(files);</span>
<span class="hljs-addition">+    Session session = createMockSession("testremote/x/", files);</span>
    @SuppressWarnings("unchecked")
    MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote/x"));
    assertThat(out).isNotNull();
    assertThat(out.getPayload()).hasSize(2);
    assertThat(out.getPayload().get(0)).isSameAs(files[0]);
    assertThat(out.getPayload().get(1)).isSameAs(files[1]);
    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo("testremote/x/");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_f</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.setOptions(<span class="hljs-string">"-f"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] files = fileList();

    when(session.list(<span class="hljs-string">"testremote/x/"</span>)).thenReturn(files);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote/x"</span>));

    assertThat(out).isNotNull();

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">2</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>)).isSameAs(files[<span class="hljs-number">0</span>]);

    assertThat(out.getPayload().get(<span class="hljs-number">1</span>)).isSameAs(files[<span class="hljs-number">1</span>]);

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo(<span class="hljs-string">"testremote/x/"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session <span class="hljs-title">createMockSession</span><span class="hljs-params">(String path, TestLsEntry[] entries)</span> </span>{
    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(session.list(path)).thenReturn(entries);
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest143">Test Case ID #spring-integration_Test_14_3</h4>
<h4 id="test-case-name-testlsfrfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_f_R</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SessionFactory sessionFactory = mock(SessionFactory.class);
<span class="hljs-deletion">-    Session session = mock(Session.class);</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
    gw.setOptions("-f -R");
    gw.afterPropertiesSet();
    when(sessionFactory.getSession()).thenReturn(session);
    TestLsEntry[] level1 = level1List();
    TestLsEntry[] level2 = level2List();
    TestLsEntry[] level3 = level3List();
<span class="hljs-addition">+    Session session = createMockSession("testremote/x/", level1);</span>
<span class="hljs-addition">+    when(session.list("testremote/x/d1/")).thenReturn(level2);</span>
<span class="hljs-addition">+    when(session.list("testremote/x/d1/d2/")).thenReturn(level3);</span>
    @SuppressWarnings("unchecked")
    MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote/x"));
    assertThat(out).isNotNull();
    assertThat(out.getPayload()).hasSize(4);
    assertThat(out.getPayload().get(0).getFilename()).isEqualTo("f1");
    assertThat(out.getPayload().get(1).getFilename()).isEqualTo("d1/d2/f4");
    assertThat(out.getPayload().get(2).getFilename()).isEqualTo("d1/f3");
    assertThat(out.getPayload().get(3).getFilename()).isEqualTo("f2");
    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo("testremote/x/");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_f_R</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.setOptions(<span class="hljs-string">"-f -R"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] level1 = level1List();

    TestLsEntry[] level2 = level2List();

    TestLsEntry[] level3 = level3List();

    when(session.list(<span class="hljs-string">"testremote/x/"</span>)).thenReturn(level1);

    when(session.list(<span class="hljs-string">"testremote/x/d1/"</span>)).thenReturn(level2);

    when(session.list(<span class="hljs-string">"testremote/x/d1/d2/"</span>)).thenReturn(level3);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote/x"</span>));

    assertThat(out).isNotNull();

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">4</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>).getFilename()).isEqualTo(<span class="hljs-string">"f1"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">1</span>).getFilename()).isEqualTo(<span class="hljs-string">"d1/d2/f4"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">2</span>).getFilename()).isEqualTo(<span class="hljs-string">"d1/f3"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">3</span>).getFilename()).isEqualTo(<span class="hljs-string">"f2"</span>);

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo(<span class="hljs-string">"testremote/x/"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session <span class="hljs-title">createMockSession</span><span class="hljs-params">(String path, TestLsEntry[] entries)</span> </span>{
    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(session.list(path)).thenReturn(entries);
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest144">Test Case ID #spring-integration_Test_14_4</h4>
<h4 id="test-case-name-testlsfrdirsfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_f_R_dirs</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SessionFactory sessionFactory = mock(SessionFactory.class);
<span class="hljs-deletion">-    Session session = mock(Session.class);</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
    gw.setOptions("-f -R -dirs");
    gw.afterPropertiesSet();
    when(sessionFactory.getSession()).thenReturn(session);
    TestLsEntry[] level1 = level1List();
    TestLsEntry[] level2 = level2List();
    TestLsEntry[] level3 = level3List();
<span class="hljs-addition">+    Session session = createMockSession("testremote/x/", level1);</span>
<span class="hljs-addition">+    when(session.list("testremote/x/d1/")).thenReturn(level2);</span>
<span class="hljs-addition">+    when(session.list("testremote/x/d1/d2/")).thenReturn(level3);</span>
    @SuppressWarnings("unchecked")
    MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote/x"));
    assertThat(out).isNotNull();
    assertThat(out.getPayload()).hasSize(6);
    assertThat(out.getPayload().get(0).getFilename()).isEqualTo("f1");
    assertThat(out.getPayload().get(1).getFilename()).isEqualTo("d1");
    assertThat(out.getPayload().get(2).getFilename()).isEqualTo("d1/d2");
    assertThat(out.getPayload().get(3).getFilename()).isEqualTo("d1/d2/f4");
    assertThat(out.getPayload().get(4).getFilename()).isEqualTo("d1/f3");
    assertThat(out.getPayload().get(5).getFilename()).isEqualTo("f2");
    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo("testremote/x/");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_f_R_dirs</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.setOptions(<span class="hljs-string">"-f -R -dirs"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] level1 = level1List();

    TestLsEntry[] level2 = level2List();

    TestLsEntry[] level3 = level3List();

    when(session.list(<span class="hljs-string">"testremote/x/"</span>)).thenReturn(level1);

    when(session.list(<span class="hljs-string">"testremote/x/d1/"</span>)).thenReturn(level2);

    when(session.list(<span class="hljs-string">"testremote/x/d1/d2/"</span>)).thenReturn(level3);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote/x"</span>));

    assertThat(out).isNotNull();

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">6</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>).getFilename()).isEqualTo(<span class="hljs-string">"f1"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">1</span>).getFilename()).isEqualTo(<span class="hljs-string">"d1"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">2</span>).getFilename()).isEqualTo(<span class="hljs-string">"d1/d2"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">3</span>).getFilename()).isEqualTo(<span class="hljs-string">"d1/d2/f4"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">4</span>).getFilename()).isEqualTo(<span class="hljs-string">"d1/f3"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">5</span>).getFilename()).isEqualTo(<span class="hljs-string">"f2"</span>);

    assertThat(out.getHeaders().get(FileHeaders.REMOTE_DIRECTORY)).isEqualTo(<span class="hljs-string">"testremote/x/"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session <span class="hljs-title">createMockSession</span><span class="hljs-params">(String path, TestLsEntry[] entries)</span> </span>{
    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(session.list(path)).thenReturn(entries);
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest145">Test Case ID #spring-integration_Test_14_5</h4>
<h4 id="test-case-name-testlsnonefile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_None</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SessionFactory sessionFactory = mock(SessionFactory.class);
<span class="hljs-deletion">-    Session session = mock(Session.class);</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
    gw.afterPropertiesSet();
    when(sessionFactory.getSession()).thenReturn(session);
    TestLsEntry[] files = new TestLsEntry[0];
<span class="hljs-deletion">-    when(session.list("testremote/")).thenReturn(files);</span>
<span class="hljs-addition">+    Session session = createMockSession("testremote/", files);</span>
    @SuppressWarnings("unchecked")
    MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote"));
    assertThat(out).isNotNull();
    assertThat(out.getPayload()).hasSize(0);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_None</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] files = <span class="hljs-keyword">new</span> TestLsEntry[<span class="hljs-number">0</span>];

    when(session.list(<span class="hljs-string">"testremote/"</span>)).thenReturn(files);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt; out = (MessageBuilder&lt;List&lt;TestLsEntry&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote"</span>));

    assertThat(out).isNotNull();

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">0</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session <span class="hljs-title">createMockSession</span><span class="hljs-params">(String path, TestLsEntry[] entries)</span> </span>{
    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(session.list(path)).thenReturn(entries);
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest146">Test Case ID #spring-integration_Test_14_6</h4>
<h4 id="test-case-name-testls1file-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_1</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SessionFactory sessionFactory = mock(SessionFactory.class);
<span class="hljs-deletion">-    Session session = mock(Session.class);</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
    gw.setOptions("-1");
    gw.afterPropertiesSet();
    when(sessionFactory.getSession()).thenReturn(session);
    TestLsEntry[] files = fileList();
<span class="hljs-deletion">-    when(session.list("testremote/")).thenReturn(files);</span>
<span class="hljs-addition">+    Session session = createMockSession("testremote/", files);</span>
    @SuppressWarnings("unchecked")
    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote"));
    assertThat(out).isNotNull();
    assertThat(out.getPayload()).hasSize(2);
    assertThat(out.getPayload().get(0)).isEqualTo("f1");
    assertThat(out.getPayload().get(1)).isEqualTo("f2");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.setOptions(<span class="hljs-string">"-1"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] files = fileList();

    when(session.list(<span class="hljs-string">"testremote/"</span>)).thenReturn(files);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote"</span>));

    assertThat(out).isNotNull();

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">2</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>)).isEqualTo(<span class="hljs-string">"f1"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">1</span>)).isEqualTo(<span class="hljs-string">"f2"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session <span class="hljs-title">createMockSession</span><span class="hljs-params">(String path, TestLsEntry[] entries)</span> </span>{
    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(session.list(path)).thenReturn(entries);
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest147">Test Case ID #spring-integration_Test_14_7</h4>
<h4 id="test-case-name-testls1ffile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_1_f</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SessionFactory sessionFactory = mock(SessionFactory.class);
<span class="hljs-deletion">-    Session session = mock(Session.class);</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
    gw.setOptions("-1 -f");
    gw.afterPropertiesSet();
    when(sessionFactory.getSession()).thenReturn(session);
    TestLsEntry[] files = fileList();
<span class="hljs-addition">+    Session session = createMockSession("testremote/", files);</span>
    @SuppressWarnings("unchecked")
    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote"));
    assertThat(out.getPayload()).hasSize(2);
    assertThat(out.getPayload().get(0)).isEqualTo("f2");
    assertThat(out.getPayload().get(1)).isEqualTo("f1");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_1_f</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-comment">//no sort</span>

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.setOptions(<span class="hljs-string">"-1 -f"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] files = fileList();

    when(session.list(<span class="hljs-string">"testremote/"</span>)).thenReturn(files);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote"</span>));

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">2</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>)).isEqualTo(<span class="hljs-string">"f2"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">1</span>)).isEqualTo(<span class="hljs-string">"f1"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session <span class="hljs-title">createMockSession</span><span class="hljs-params">(String path, TestLsEntry[] entries)</span> </span>{
    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(session.list(path)).thenReturn(entries);
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest148">Test Case ID #spring-integration_Test_14_8</h4>
<h4 id="test-case-name-testls1dirsfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_1_dirs</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SessionFactory sessionFactory = mock(SessionFactory.class);
<span class="hljs-deletion">-    Session session = mock(Session.class);</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
    gw.setOptions("-1 -dirs");
    gw.afterPropertiesSet();
    when(sessionFactory.getSession()).thenReturn(session);
    TestLsEntry[] files = fileList();
<span class="hljs-deletion">-    when(session.list("testremote/")).thenReturn(files);</span>
<span class="hljs-addition">+    Session session = createMockSession("testremote/", files);</span>
    @SuppressWarnings("unchecked")
    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote"));
    assertThat(out.getPayload()).hasSize(3);
    assertThat(out.getPayload().get(0)).isEqualTo("f1");
    assertThat(out.getPayload().get(1)).isEqualTo("f2");
    assertThat(out.getPayload().get(2)).isEqualTo("f3");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_1_dirs</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.setOptions(<span class="hljs-string">"-1 -dirs"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] files = fileList();

    when(session.list(<span class="hljs-string">"testremote/"</span>)).thenReturn(files);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote"</span>));

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">3</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>)).isEqualTo(<span class="hljs-string">"f1"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">1</span>)).isEqualTo(<span class="hljs-string">"f2"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">2</span>)).isEqualTo(<span class="hljs-string">"f3"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session <span class="hljs-title">createMockSession</span><span class="hljs-params">(String path, TestLsEntry[] entries)</span> </span>{
    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(session.list(path)).thenReturn(entries);
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest149">Test Case ID #spring-integration_Test_14_9</h4>
<h4 id="test-case-name-testls1dirslinksfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_1_dirs_links</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SessionFactory sessionFactory = mock(SessionFactory.class);
<span class="hljs-deletion">-    Session session = mock(Session.class);</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
    gw.setOptions("-1 -dirs -links");
    gw.afterPropertiesSet();
    when(sessionFactory.getSession()).thenReturn(session);
    TestLsEntry[] files = fileList();
<span class="hljs-deletion">-    when(session.list("testremote/")).thenReturn(files);</span>
<span class="hljs-addition">+    Session session = createMockSession("testremote/", files);</span>
    @SuppressWarnings("unchecked")
    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote"));
    assertThat(out.getPayload()).hasSize(4);
    assertThat(out.getPayload().get(0)).isEqualTo("f1");
    assertThat(out.getPayload().get(1)).isEqualTo("f2");
    assertThat(out.getPayload().get(2)).isEqualTo("f3");
    assertThat(out.getPayload().get(3)).isEqualTo("f4");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_1_dirs_links</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.setOptions(<span class="hljs-string">"-1 -dirs -links"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] files = fileList();

    when(session.list(<span class="hljs-string">"testremote/"</span>)).thenReturn(files);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote"</span>));

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">4</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>)).isEqualTo(<span class="hljs-string">"f1"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">1</span>)).isEqualTo(<span class="hljs-string">"f2"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">2</span>)).isEqualTo(<span class="hljs-string">"f3"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">3</span>)).isEqualTo(<span class="hljs-string">"f4"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session <span class="hljs-title">createMockSession</span><span class="hljs-params">(String path, TestLsEntry[] entries)</span> </span>{
    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(session.list(path)).thenReturn(entries);
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest1410">Test Case ID #spring-integration_Test_14_10</h4>
<h4 id="test-case-name-testls1afdirslinksfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_1_a_f_dirs_links</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SessionFactory sessionFactory = mock(SessionFactory.class);
<span class="hljs-deletion">-    Session session = mock(Session.class);</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
    gw.setOptions("-1 -a -f -dirs -links");
    gw.afterPropertiesSet();
    when(sessionFactory.getSession()).thenReturn(session);
    TestLsEntry[] files = fileList();
<span class="hljs-deletion">-    when(session.list("testremote/")).thenReturn(files);</span>
<span class="hljs-addition">+    Session session = createMockSession("testremote/", files);</span>
    @SuppressWarnings("unchecked")
    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote"));
    assertThat(out.getPayload()).hasSize(6);
    assertThat(out.getPayload().get(0)).isEqualTo("f2");
    assertThat(out.getPayload().get(1)).isEqualTo("f1");
    assertThat(out.getPayload().get(2)).isEqualTo("f3");
    assertThat(out.getPayload().get(3)).isEqualTo("f4");
    assertThat(out.getPayload().get(4)).isEqualTo(".f5");
    assertThat(out.getPayload().get(5)).isEqualTo(".f6");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_1_a_f_dirs_links</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.setOptions(<span class="hljs-string">"-1 -a -f -dirs -links"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] files = fileList();

    when(session.list(<span class="hljs-string">"testremote/"</span>)).thenReturn(files);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote"</span>));

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">6</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>)).isEqualTo(<span class="hljs-string">"f2"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">1</span>)).isEqualTo(<span class="hljs-string">"f1"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">2</span>)).isEqualTo(<span class="hljs-string">"f3"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">3</span>)).isEqualTo(<span class="hljs-string">"f4"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">4</span>)).isEqualTo(<span class="hljs-string">".f5"</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">5</span>)).isEqualTo(<span class="hljs-string">".f6"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session <span class="hljs-title">createMockSession</span><span class="hljs-params">(String path, TestLsEntry[] entries)</span> </span>{
    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(session.list(path)).thenReturn(entries);
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest1411">Test Case ID #spring-integration_Test_14_11</h4>
<h4 id="test-case-name-testls1afdirslinksfilteredfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testLs_1_a_f_dirs_links_filtered</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SessionFactory sessionFactory = mock(SessionFactory.class);
<span class="hljs-deletion">-    Session session = mock(Session.class);</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "ls", "payload");
    gw.setOptions("-1 -a -f -dirs -links");
    gw.setFilter(new TestPatternFilter("*4"));
    gw.afterPropertiesSet();
    when(sessionFactory.getSession()).thenReturn(session);
    TestLsEntry[] files = fileList();
<span class="hljs-deletion">-    when(session.list("testremote/")).thenReturn(files);</span>
<span class="hljs-addition">+    Session session = createMockSession("testremote/", files);</span>
    @SuppressWarnings("unchecked")
    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(new GenericMessage&lt;&gt;("testremote"));
    assertThat(out.getPayload()).hasSize(1);
    assertThat(out.getPayload().get(0)).isEqualTo("f4");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLs_1_a_f_dirs_links_filtered</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"payload"</span>);

    gw.setOptions(<span class="hljs-string">"-1 -a -f -dirs -links"</span>);

    gw.setFilter(<span class="hljs-keyword">new</span> TestPatternFilter(<span class="hljs-string">"*4"</span>));

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    TestLsEntry[] files = fileList();

    when(session.list(<span class="hljs-string">"testremote/"</span>)).thenReturn(files);

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    MessageBuilder&lt;List&lt;String&gt;&gt; out = (MessageBuilder&lt;List&lt;String&gt;&gt;) gw.handleRequestMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"testremote"</span>));

    assertThat(out.getPayload()).hasSize(<span class="hljs-number">1</span>);

    assertThat(out.getPayload().get(<span class="hljs-number">0</span>)).isEqualTo(<span class="hljs-string">"f4"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session <span class="hljs-title">createMockSession</span><span class="hljs-params">(String path, TestLsEntry[] entries)</span> </span>{
    Session session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(session.list(path)).thenReturn(entries);
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci15">Mock Clone Instance #spring-integration_MCI_15</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.context.ApplicationEventPublisher</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApplicationEventPublisher <span class="hljs-title">createMockApplicationEventPublisher</span><span class="hljs-params">(CountDownLatch latch)</span> </span>{
    ApplicationEventPublisher publisher = mock(ApplicationEventPublisher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(invocation -&gt; {
        latch.countDown();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).when(publisher).publishEvent(any(ApplicationEvent<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    <span class="hljs-keyword">return</span> publisher;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest151">Test Case ID #spring-integration_Test_15_1</h4>
<h4 id="test-case-name-testtcpfile-cjavaprojectsspringspring-integrationspring-integration-syslogsrctestjavaorgspringframeworkintegrationsysloginboundsyslogreceivingchanneladaptertestsjava">Test Case Name: <code>testTcp</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-syslog\src\test\java\org\springframework\integration\syslog\inbound\SyslogReceivingChannelAdapterTests.java</code>)</h4>
<h4 id="mock-object-variable-name-publisher">Mock Object Variable Name: <code>publisher</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    factory.setPort(0);
    PollableChannel outputChannel = new QueueChannel();
    factory.setOutputChannel(outputChannel);
<span class="hljs-deletion">-    ApplicationEventPublisher publisher = mock(ApplicationEventPublisher.class);</span>
    final CountDownLatch latch = new CountDownLatch(2);
<span class="hljs-deletion">-    doAnswer(invocation -&gt; {</span>
<span class="hljs-deletion">-        latch.countDown();</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).when(publisher).publishEvent(any(ApplicationEvent.class));</span>
<span class="hljs-addition">+    ApplicationEventPublisher publisher = createMockApplicationEventPublisher(latch);</span>
    factory.setApplicationEventPublisher(publisher);
    factory.setBeanFactory(mock(BeanFactory.class));
    factory.afterPropertiesSet();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testTcp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SyslogReceivingChannelAdapterFactoryBean factory = <span class="hljs-keyword">new</span> SyslogReceivingChannelAdapterFactoryBean(SyslogReceivingChannelAdapterFactoryBean.Protocol.tcp);

    factory.setPort(<span class="hljs-number">0</span>);

    PollableChannel outputChannel = <span class="hljs-keyword">new</span> QueueChannel();

    factory.setOutputChannel(outputChannel);

    ApplicationEventPublisher publisher = mock(ApplicationEventPublisher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">2</span>);

    doAnswer(invocation -&gt; {

        latch.countDown();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(publisher).publishEvent(any(ApplicationEvent<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    factory.setApplicationEventPublisher(publisher);

    factory.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    factory.afterPropertiesSet();

    factory.start();

    AbstractServerConnectionFactory server = TestUtils.getPropertyValue(factory, <span class="hljs-string">"syslogAdapter.connectionFactory"</span>, AbstractServerConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestingUtilities.waitListening(server, <span class="hljs-keyword">null</span>);

    TcpSyslogReceivingChannelAdapter adapter = (TcpSyslogReceivingChannelAdapter) factory.getObject();

    LogAccessor logger = spy(TestUtils.getPropertyValue(adapter, <span class="hljs-string">"logger"</span>, LogAccessor<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    doReturn(<span class="hljs-keyword">true</span>).when(logger).isDebugEnabled();

    <span class="hljs-keyword">final</span> CountDownLatch sawLog = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    doAnswer(invocation -&gt; {

        <span class="hljs-keyword">if</span> (((String) invocation.getArgument(<span class="hljs-number">0</span>)).contains(<span class="hljs-string">"Error on syslog socket"</span>)) {

            sawLog.countDown();

        }

        invocation.callRealMethod();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(logger).debug(anyString());

    <span class="hljs-keyword">new</span> DirectFieldAccessor(adapter).setPropertyValue(<span class="hljs-string">"logger"</span>, logger);

    <span class="hljs-keyword">byte</span>[] buf = <span class="hljs-string">"&lt;157&gt;JUL 26 22:08:35 WEBERN TESTING[70729]: TEST SYSLOG MESSAGE\n"</span>.getBytes(StandardCharsets.UTF_8);

    Socket socket = SocketFactory.getDefault().createSocket(<span class="hljs-string">"localhost"</span>, server.getPort());

    socket.getOutputStream().write(buf);

    socket.close();

    assertThat(sawLog.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    Message&lt;?&gt; message = outputChannel.receive(<span class="hljs-number">10000</span>);

    assertThat(message).isNotNull();

    assertThat(message.getHeaders().get(<span class="hljs-string">"syslog_HOST"</span>)).isEqualTo(<span class="hljs-string">"WEBERN"</span>);

    assertThat(message.getHeaders().get(IpHeaders.IP_ADDRESS)).isNotNull();

    adapter.stop();

    assertThat(latch.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApplicationEventPublisher <span class="hljs-title">createMockApplicationEventPublisher</span><span class="hljs-params">(CountDownLatch latch)</span> </span>{
    ApplicationEventPublisher publisher = mock(ApplicationEventPublisher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(invocation -&gt; {
        latch.countDown();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).when(publisher).publishEvent(any(ApplicationEvent<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    <span class="hljs-keyword">return</span> publisher;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest152">Test Case ID #spring-integration_Test_15_2</h4>
<h4 id="test-case-name-testtcprfc5424file-cjavaprojectsspringspring-integrationspring-integration-syslogsrctestjavaorgspringframeworkintegrationsysloginboundsyslogreceivingchanneladaptertestsjava">Test Case Name: <code>testTcpRFC5424</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-syslog\src\test\java\org\springframework\integration\syslog\inbound\SyslogReceivingChannelAdapterTests.java</code>)</h4>
<h4 id="mock-object-variable-name-publisher">Mock Object Variable Name: <code>publisher</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    factory.setOutputChannel(outputChannel);
<span class="hljs-deletion">-    ApplicationEventPublisher publisher = mock(ApplicationEventPublisher.class);</span>
     final CountDownLatch latch = new CountDownLatch(2);
<span class="hljs-deletion">-    doAnswer(invocation -&gt; {</span>
<span class="hljs-deletion">-        latch.countDown();</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).when(publisher).publishEvent(any(ApplicationEvent.class));</span>
<span class="hljs-addition">+    ApplicationEventPublisher publisher = createMockApplicationEventPublisher(latch);</span>
     factory.setBeanFactory(mock(BeanFactory.class));
     AbstractServerConnectionFactory connectionFactory = new TcpNioServerConnectionFactory(0);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testTcpRFC5424</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SyslogReceivingChannelAdapterFactoryBean factory = <span class="hljs-keyword">new</span> SyslogReceivingChannelAdapterFactoryBean(SyslogReceivingChannelAdapterFactoryBean.Protocol.tcp);

    PollableChannel outputChannel = <span class="hljs-keyword">new</span> QueueChannel();

    factory.setOutputChannel(outputChannel);

    ApplicationEventPublisher publisher = mock(ApplicationEventPublisher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">2</span>);

    doAnswer(invocation -&gt; {

        latch.countDown();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(publisher).publishEvent(any(ApplicationEvent<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    factory.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    AbstractServerConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> TcpNioServerConnectionFactory(<span class="hljs-number">0</span>);

    connectionFactory.setDeserializer(<span class="hljs-keyword">new</span> RFC6587SyslogDeserializer());

    connectionFactory.setApplicationEventPublisher(publisher);

    factory.setConnectionFactory(connectionFactory);

    factory.setConverter(<span class="hljs-keyword">new</span> RFC5424MessageConverter());

    factory.afterPropertiesSet();

    factory.start();

    TestingUtilities.waitListening(connectionFactory, <span class="hljs-keyword">null</span>);

    TcpSyslogReceivingChannelAdapter adapter = (TcpSyslogReceivingChannelAdapter) factory.getObject();

    LogAccessor logger = spy(TestUtils.getPropertyValue(adapter, <span class="hljs-string">"logger"</span>, LogAccessor<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    doReturn(<span class="hljs-keyword">true</span>).when(logger).isDebugEnabled();

    <span class="hljs-keyword">final</span> CountDownLatch sawLog = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    doAnswer(invocation -&gt; {

        <span class="hljs-keyword">if</span> (((String) invocation.getArgument(<span class="hljs-number">0</span>)).contains(<span class="hljs-string">"Error on syslog socket"</span>)) {

            sawLog.countDown();

        }

        invocation.callRealMethod();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(logger).debug(anyString());

    <span class="hljs-keyword">new</span> DirectFieldAccessor(adapter).setPropertyValue(<span class="hljs-string">"logger"</span>, logger);

    <span class="hljs-keyword">byte</span>[] buf = (<span class="hljs-string">"253 &lt;14&gt;1 2014-06-20T09:14:07+00:00 loggregator d0602076-b14a-4c55-852a-981e7afeed38 DEA - "</span> + <span class="hljs-string">"[exampleSDID@32473 iut=\\\"3\\\" eventSource=\\\"Application\\\" eventID=\\\"1011\\\"]"</span> + <span class="hljs-string">"[exampleSDID@32473 iut=\\\"3\\\" eventSource=\\\"Application\\\" eventID=\\\"1011\\\"] Removing instance"</span>).getBytes(StandardCharsets.UTF_8);

    Socket socket = SocketFactory.getDefault().createSocket(<span class="hljs-string">"localhost"</span>, connectionFactory.getPort());

    socket.getOutputStream().write(buf);

    socket.close();

    assertThat(sawLog.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    Message&lt;Map&lt;String, ?&gt;&gt; message = (Message&lt;Map&lt;String, ?&gt;&gt;) outputChannel.receive(<span class="hljs-number">10000</span>);

    assertThat(message).isNotNull();

    assertThat(message.getPayload().get(<span class="hljs-string">"syslog_HOST"</span>)).isEqualTo(<span class="hljs-string">"loggregator"</span>);

    assertThat(message.getHeaders().get(IpHeaders.IP_ADDRESS)).isNotNull();

    adapter.stop();

    assertThat(latch.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApplicationEventPublisher <span class="hljs-title">createMockApplicationEventPublisher</span><span class="hljs-params">(CountDownLatch latch)</span> </span>{
    ApplicationEventPublisher publisher = mock(ApplicationEventPublisher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(invocation -&gt; {
        latch.countDown();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).when(publisher).publishEvent(any(ApplicationEvent<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    <span class="hljs-keyword">return</span> publisher;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci16">Mock Clone Instance #spring-integration_MCI_16</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.kafka.clients.consumer.Consumer</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;K, V&gt; <span class="hljs-function">Consumer&lt;K, V&gt; <span class="hljs-title">createMockConsumer</span><span class="hljs-params">(<span class="hljs-keyword">final</span> TopicPartition topicPartition, <span class="hljs-keyword">final</span> AtomicReference&lt;Set&lt;TopicPartition&gt;&gt; paused, <span class="hljs-keyword">final</span> Answer&lt;?&gt; pausedAnswer)</span> </span>{
    Consumer&lt;K, V&gt; consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willAnswer(i -&gt; {
        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    willAnswer(i -&gt; {
        paused.set(<span class="hljs-keyword">new</span> HashSet&lt;&gt;(i.getArgument(<span class="hljs-number">0</span>)));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(consumer).pause(anyCollection());
    willAnswer(pausedAnswer).given(consumer).paused();
    <span class="hljs-keyword">return</span> consumer;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest161">Test Case ID #spring-integration_Test_16_1</h4>
<h4 id="test-case-name-testackoutoforderfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkainboundmessagesourcetestsjava">Test Case Name: <code>testAckOutOfOrder</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\inbound\MessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-consumer">Mock Object Variable Name: <code>consumer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testAckOutOfOrder() {
<span class="hljs-deletion">-    Consumer consumer = mock(Consumer.class);</span>
<span class="hljs-deletion">-    TopicPartition topicPartition = new TopicPartition("foo", 0);</span>
<span class="hljs-deletion">-    willAnswer(i -&gt; {</span>
<span class="hljs-deletion">-        ((ConsumerRebalanceListener) i.getArgument(1)).onPartitionsAssigned(Collections.singletonList(topicPartition));</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener.class));</span>
<span class="hljs-addition">+    TopicPartition topicPartition = new TopicPartition("foo", 0);</span>
     AtomicReference&lt;Set&lt;TopicPartition&gt;&gt; paused = new AtomicReference&lt;&gt;(new HashSet&lt;&gt;());
<span class="hljs-addition">+    Consumer consumer = createMockConsumer(topicPartition, paused, i -&gt; paused.get());</span>
     Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records1 = new LinkedHashMap&lt;&gt;();
     records1.put(topicPartition, Collections.singletonList(new ConsumerRecord("foo", 0, 0L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "foo", new RecordHeaders(), Optional.empty())));
     Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records2 = new LinkedHashMap&lt;&gt;();
     records2.put(topicPartition, Collections.singletonList(new ConsumerRecord("foo", 0, 1L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "bar", new RecordHeaders(), Optional.empty())));
     Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records3 = new LinkedHashMap&lt;&gt;();
     records3.put(topicPartition, Collections.singletonList(new ConsumerRecord("foo", 0, 2L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "baz", new RecordHeaders(), Optional.empty())));
     Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records4 = new LinkedHashMap&lt;&gt;();
     records4.put(topicPartition, Collections.singletonList(new ConsumerRecord("foo", 0, 3L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "qux", new RecordHeaders(), Optional.empty())));
     Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records5 = new LinkedHashMap&lt;&gt;();
     records5.put(topicPartition, Collections.singletonList(new ConsumerRecord("foo", 0, 4L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "fiz", new RecordHeaders(), Optional.empty())));
     Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records6 = new LinkedHashMap&lt;&gt;();
     records6.put(topicPartition, Collections.singletonList(new ConsumerRecord("foo", 0, 5L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "buz", new RecordHeaders(), Optional.empty())));
     ConsumerRecords cr1 = new ConsumerRecords(records1);
     ConsumerRecords cr2 = new ConsumerRecords(records2);
     ConsumerRecords cr3 = new ConsumerRecords(records3);
     ConsumerRecords cr4 = new ConsumerRecords(records4);
     ConsumerRecords cr5 = new ConsumerRecords(records5);
     ConsumerRecords cr6 = new ConsumerRecords(records6);
     ConsumerRecords cr7 = new ConsumerRecords(Collections.emptyMap());
     given(consumer.poll(any(Duration.class))).willReturn(cr1, cr2, cr3, cr4, cr5, cr6, cr7);
     ConsumerFactory consumerFactory = mock(ConsumerFactory.class);
     willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 1)).given(consumerFactory).getConfigurationProperties();
     given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);
     KafkaMessageSource source = new KafkaMessageSource(consumerFactory, new ConsumerProperties("foo"));
     Message&lt;?&gt; received1 = source.receive();
     // need some other interaction with mock between polls for InOrder
     consumer.paused();
     Message&lt;?&gt; received2 = source.receive();
     // need some other interaction with mock between polls for InOrder
     consumer.paused();
     Message&lt;?&gt; received3 = source.receive();
     // need some other interaction with mock between polls for InOrder
     consumer.paused();
     Message&lt;?&gt; received4 = source.receive();
     // need some other interaction with mock between polls for InOrder
     consumer.paused();
     Message&lt;?&gt; received5 = source.receive();
     // need some other interaction with mock between polls for InOrder
     consumer.paused();
     Message&lt;?&gt; received6 = source.receive();
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received3).acknowledge(AcknowledgmentCallback.Status.ACCEPT);
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received2).acknowledge(AcknowledgmentCallback.Status.ACCEPT);
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received5).acknowledge(AcknowledgmentCallback.Status.ACCEPT);
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received1).acknowledge(// should commit offset 3 (received 3)
     AcknowledgmentCallback.Status.ACCEPT);
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received6).acknowledge(AcknowledgmentCallback.Status.ACCEPT);
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received4).acknowledge(// should commit offset 6 (received 6).
     AcknowledgmentCallback.Status.ACCEPT);
     assertThat(source.receive()).isNull();
     source.destroy();
     InOrder inOrder = inOrder(consumer);
     inOrder.verify(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener.class));
     inOrder.verify(consumer).poll(any(Duration.class));
     inOrder.verify(consumer).paused();
     inOrder.verify(consumer).poll(any(Duration.class));
     inOrder.verify(consumer).paused();
     inOrder.verify(consumer).poll(any(Duration.class));
     inOrder.verify(consumer).paused();
     inOrder.verify(consumer).poll(any(Duration.class));
     inOrder.verify(consumer).paused();
     inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, new OffsetAndMetadata(3L)));
     inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, new OffsetAndMetadata(6L)));
     inOrder.verify(consumer).poll(any(Duration.class));
     inOrder.verify(consumer).close(any());
     inOrder.verifyNoMoreInteractions();
}
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAckOutOfOrder</span><span class="hljs-params">()</span> </span>{

    Consumer consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    willAnswer(i -&gt; {

        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    AtomicReference&lt;Set&lt;TopicPartition&gt;&gt; paused = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;(<span class="hljs-keyword">new</span> HashSet&lt;&gt;());

    willAnswer(i -&gt; {

        paused.set(<span class="hljs-keyword">new</span> HashSet&lt;&gt;(i.getArgument(<span class="hljs-number">0</span>)));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).pause(anyCollection());

    willAnswer(i -&gt; paused.get()).given(consumer).paused();

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records1 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records1.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records2 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records2.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records3 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records3.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"baz"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records4 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records4.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"qux"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records5 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records5.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"fiz"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records6 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records6.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"buz"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    ConsumerRecords cr1 = <span class="hljs-keyword">new</span> ConsumerRecords(records1);

    ConsumerRecords cr2 = <span class="hljs-keyword">new</span> ConsumerRecords(records2);

    ConsumerRecords cr3 = <span class="hljs-keyword">new</span> ConsumerRecords(records3);

    ConsumerRecords cr4 = <span class="hljs-keyword">new</span> ConsumerRecords(records4);

    ConsumerRecords cr5 = <span class="hljs-keyword">new</span> ConsumerRecords(records5);

    ConsumerRecords cr6 = <span class="hljs-keyword">new</span> ConsumerRecords(records6);

    ConsumerRecords cr7 = <span class="hljs-keyword">new</span> ConsumerRecords(Collections.emptyMap());

    given(consumer.poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">cr1</span>, <span class="hljs-title">cr2</span>, <span class="hljs-title">cr3</span>, <span class="hljs-title">cr4</span>, <span class="hljs-title">cr5</span>, <span class="hljs-title">cr6</span>, <span class="hljs-title">cr7</span>)</span>;

    ConsumerFactory consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">1</span>)).given(consumerFactory).getConfigurationProperties();

    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);

    KafkaMessageSource source = <span class="hljs-keyword">new</span> KafkaMessageSource(consumerFactory, <span class="hljs-keyword">new</span> ConsumerProperties(<span class="hljs-string">"foo"</span>));

    Message&lt;?&gt; received1 = source.receive();

    <span class="hljs-comment">// need some other interaction with mock between polls for InOrder</span>

    consumer.paused();

    Message&lt;?&gt; received2 = source.receive();

    <span class="hljs-comment">// need some other interaction with mock between polls for InOrder</span>

    consumer.paused();

    Message&lt;?&gt; received3 = source.receive();

    <span class="hljs-comment">// need some other interaction with mock between polls for InOrder</span>

    consumer.paused();

    Message&lt;?&gt; received4 = source.receive();

    <span class="hljs-comment">// need some other interaction with mock between polls for InOrder</span>

    consumer.paused();

    Message&lt;?&gt; received5 = source.receive();

    <span class="hljs-comment">// need some other interaction with mock between polls for InOrder</span>

    consumer.paused();

    Message&lt;?&gt; received6 = source.receive();

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received3).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received2).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received5).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received1).acknowledge(<span class="hljs-comment">// should commit offset 3 (received 3)</span>

    AcknowledgmentCallback.Status.ACCEPT);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received6).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received4).acknowledge(<span class="hljs-comment">// should commit offset 6 (received 6).</span>

    AcknowledgmentCallback.Status.ACCEPT);

    assertThat(source.receive()).isNull();

    source.destroy();

    InOrder inOrder = inOrder(consumer);

    inOrder.verify(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).paused();

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).paused();

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).paused();

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).paused();

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">3L</span>)));

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">6L</span>)));

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).close(any());

    inOrder.verifyNoMoreInteractions();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;K, V&gt; <span class="hljs-function">Consumer&lt;K, V&gt; <span class="hljs-title">createMockConsumer</span><span class="hljs-params">(<span class="hljs-keyword">final</span> TopicPartition topicPartition, <span class="hljs-keyword">final</span> AtomicReference&lt;Set&lt;TopicPartition&gt;&gt; paused, <span class="hljs-keyword">final</span> Answer&lt;?&gt; pausedAnswer)</span> </span>{
    Consumer&lt;K, V&gt; consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willAnswer(i -&gt; {
        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    willAnswer(i -&gt; {
        paused.set(<span class="hljs-keyword">new</span> HashSet&lt;&gt;(i.getArgument(<span class="hljs-number">0</span>)));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(consumer).pause(anyCollection());
    willAnswer(pausedAnswer).given(consumer).paused();
    <span class="hljs-keyword">return</span> consumer;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest162">Test Case ID #spring-integration_Test_16_2</h4>
<h4 id="test-case-name-testnackfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkainboundmessagesourcetestsjava">Test Case Name: <code>testNack</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\inbound\MessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-consumer">Mock Object Variable Name: <code>consumer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testNack() {
<span class="hljs-deletion">-    Consumer consumer = mock(Consumer.class);</span>
     TopicPartition topicPartition = new TopicPartition("foo", 0);
<span class="hljs-deletion">-    willAnswer(i -&gt; {</span>
<span class="hljs-deletion">-        ((ConsumerRebalanceListener) i.getArgument(1)).onPartitionsAssigned(Collections.singletonList(topicPartition));</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener.class));</span>
     AtomicReference&lt;Set&lt;TopicPartition&gt;&gt; paused = new AtomicReference&lt;&gt;(new HashSet&lt;&gt;());
<span class="hljs-deletion">-    willAnswer(i -&gt; {</span>
<span class="hljs-deletion">-        paused.set(new HashSet&lt;&gt;(i.getArgument(0)));</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).given(consumer).pause(anyCollection());</span>
<span class="hljs-deletion">-    willAnswer(i -&gt; paused.get()).given(consumer).paused();</span>
<span class="hljs-addition">+    Consumer consumer = createMockConsumer(topicPartition, paused, i -&gt; paused.get());</span>
     Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records1 = new LinkedHashMap&lt;&gt;();
     records1.put(topicPartition, Collections.singletonList(new ConsumerRecord("foo", 0, 0L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "foo", new RecordHeaders(), Optional.empty())));
     ConsumerRecords cr1 = new ConsumerRecords(records1);
     Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records2 = new LinkedHashMap&lt;&gt;();
     records2.put(topicPartition, Collections.singletonList(new ConsumerRecord("foo", 0, 1L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "bar", new RecordHeaders(), Optional.empty())));
     ConsumerRecords cr2 = new ConsumerRecords(records2);
     ConsumerRecords cr3 = new ConsumerRecords(Collections.emptyMap());
     given(consumer.poll(any(Duration.class))).willReturn(cr1, cr1, cr2, cr2, cr3);
     ConsumerFactory consumerFactory = mock(ConsumerFactory.class);
     willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 1)).given(consumerFactory).getConfigurationProperties();
     given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);
     ConsumerProperties consumerProperties = new ConsumerProperties("foo");
     consumerProperties.setSyncCommitTimeout(Duration.ofSeconds(30));
     KafkaMessageSource source = new KafkaMessageSource(consumerFactory, consumerProperties);
     Message&lt;?&gt; received = source.receive();
     assertThat(received.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(0L);
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.REQUEUE);
     received = source.receive();
     assertThat(received.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(0L);
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);
     received = source.receive();
     assertThat(received.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(1L);
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.REQUEUE);
     received = source.receive();
     assertThat(received.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(1L);
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);
     received = source.receive();
     source.destroy();
     assertThat(received).isNull();
     InOrder inOrder = inOrder(consumer);
     inOrder.verify(consumer).poll(any(Duration.class));
     // rollback
     inOrder.verify(consumer).seek(topicPartition, 0L);
     inOrder.verify(consumer).poll(any(Duration.class));
     inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, new OffsetAndMetadata(1L)), Duration.ofSeconds(30));
     inOrder.verify(consumer).poll(any(Duration.class));
     // rollback
     inOrder.verify(consumer).seek(topicPartition, 1L);
     inOrder.verify(consumer).poll(any(Duration.class));
     inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, new OffsetAndMetadata(2L)), Duration.ofSeconds(30));
     inOrder.verify(consumer).poll(any(Duration.class));
     inOrder.verify(consumer).close(any());
     inOrder.verifyNoMoreInteractions();
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testNack</span><span class="hljs-params">()</span> </span>{

    Consumer consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    willAnswer(i -&gt; {

        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    AtomicReference&lt;Set&lt;TopicPartition&gt;&gt; paused = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;(<span class="hljs-keyword">new</span> HashSet&lt;&gt;());

    willAnswer(i -&gt; {

        paused.set(<span class="hljs-keyword">new</span> HashSet&lt;&gt;(i.getArgument(<span class="hljs-number">0</span>)));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).pause(anyCollection());

    willAnswer(i -&gt; paused.get()).given(consumer).paused();

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records1 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records1.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    ConsumerRecords cr1 = <span class="hljs-keyword">new</span> ConsumerRecords(records1);

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records2 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records2.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    ConsumerRecords cr2 = <span class="hljs-keyword">new</span> ConsumerRecords(records2);

    ConsumerRecords cr3 = <span class="hljs-keyword">new</span> ConsumerRecords(Collections.emptyMap());

    given(consumer.poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">cr1</span>, <span class="hljs-title">cr1</span>, <span class="hljs-title">cr2</span>, <span class="hljs-title">cr2</span>, <span class="hljs-title">cr3</span>)</span>;

    ConsumerFactory consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">1</span>)).given(consumerFactory).getConfigurationProperties();

    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);

    ConsumerProperties consumerProperties = <span class="hljs-keyword">new</span> ConsumerProperties(<span class="hljs-string">"foo"</span>);

    consumerProperties.setSyncCommitTimeout(Duration.ofSeconds(<span class="hljs-number">30</span>));

    KafkaMessageSource source = <span class="hljs-keyword">new</span> KafkaMessageSource(consumerFactory, consumerProperties);

    Message&lt;?&gt; received = source.receive();

    assertThat(received.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(<span class="hljs-number">0L</span>);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.REQUEUE);

    received = source.receive();

    assertThat(received.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(<span class="hljs-number">0L</span>);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    assertThat(received.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(<span class="hljs-number">1L</span>);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.REQUEUE);

    received = source.receive();

    assertThat(received.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(<span class="hljs-number">1L</span>);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    source.destroy();

    assertThat(received).isNull();

    InOrder inOrder = inOrder(consumer);

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-comment">// rollback</span>

    inOrder.verify(consumer).seek(topicPartition, <span class="hljs-number">0L</span>);

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">1L</span>)), Duration.ofSeconds(<span class="hljs-number">30</span>));

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-comment">// rollback</span>

    inOrder.verify(consumer).seek(topicPartition, <span class="hljs-number">1L</span>);

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">2L</span>)), Duration.ofSeconds(<span class="hljs-number">30</span>));

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).close(any());

    inOrder.verifyNoMoreInteractions();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;K, V&gt; <span class="hljs-function">Consumer&lt;K, V&gt; <span class="hljs-title">createMockConsumer</span><span class="hljs-params">(<span class="hljs-keyword">final</span> TopicPartition topicPartition, <span class="hljs-keyword">final</span> AtomicReference&lt;Set&lt;TopicPartition&gt;&gt; paused, <span class="hljs-keyword">final</span> Answer&lt;?&gt; pausedAnswer)</span> </span>{
    Consumer&lt;K, V&gt; consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willAnswer(i -&gt; {
        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    willAnswer(i -&gt; {
        paused.set(<span class="hljs-keyword">new</span> HashSet&lt;&gt;(i.getArgument(<span class="hljs-number">0</span>)));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(consumer).pause(anyCollection());
    willAnswer(pausedAnswer).given(consumer).paused();
    <span class="hljs-keyword">return</span> consumer;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest163">Test Case ID #spring-integration_Test_16_3</h4>
<h4 id="test-case-name-testnackwithlaterinflightfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkainboundmessagesourcetestsjava">Test Case Name: <code>testNackWithLaterInflight</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\inbound\MessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-consumer">Mock Object Variable Name: <code>consumer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testNackWithLaterInflight() {
<span class="hljs-deletion">-    Consumer consumer = mock(Consumer.class);</span>
     TopicPartition topicPartition = new TopicPartition("foo", 0);
<span class="hljs-deletion">-    willAnswer(i -&gt; {</span>
<span class="hljs-deletion">-        ((ConsumerRebalanceListener) i.getArgument(1)).onPartitionsAssigned(Collections.singletonList(topicPartition));</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener.class));</span>
     AtomicReference&lt;Set&lt;TopicPartition&gt;&gt; paused = new AtomicReference&lt;&gt;(new HashSet&lt;&gt;());
<span class="hljs-deletion">-    willAnswer(i -&gt; {</span>
<span class="hljs-deletion">-        paused.set(new HashSet&lt;&gt;(i.getArgument(0)));</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).given(consumer).pause(anyCollection());</span>
<span class="hljs-deletion">-    willAnswer(i -&gt; paused.get()).given(consumer).paused();</span>
<span class="hljs-addition">+    Answer&lt;?&gt; pausedAnswer = i -&gt; paused.get();</span>
<span class="hljs-addition">+    Consumer consumer = createMockConsumer(topicPartition, paused, pausedAnswer);</span>
     Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records1 = new LinkedHashMap&lt;&gt;();
     records1.put(topicPartition, Collections.singletonList(new ConsumerRecord("foo", 0, 0L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "foo", new RecordHeaders(), Optional.empty())));
     ConsumerRecords cr1 = new ConsumerRecords(records1);
     Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records2 = new LinkedHashMap&lt;&gt;();
     records2.put(topicPartition, Collections.singletonList(new ConsumerRecord("foo", 0, 1L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "bar", new RecordHeaders(), Optional.empty())));
     ConsumerRecords cr2 = new ConsumerRecords(records2);
     ConsumerRecords cr3 = new ConsumerRecords(Collections.emptyMap());
     given(consumer.poll(any(Duration.class))).willReturn(cr1, cr2, cr1, cr2, cr3);
     ConsumerFactory consumerFactory = mock(ConsumerFactory.class);
     willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 1)).given(consumerFactory).getConfigurationProperties();
     given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);
     KafkaMessageSource source = new KafkaMessageSource(consumerFactory, new ConsumerProperties("foo"));
     Message&lt;?&gt; received1 = source.receive();
     // need some other interaction with mock between polls for InOrder
     consumer.paused();
     // inflight
     Message&lt;?&gt; received2 = source.receive();
     assertThat(received1.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(0L);
     AcknowledgmentCallback ack1 = StaticMessageHeaderAccessor.getAcknowledgmentCallback(received1);
     Log log1 = spy(KafkaTestUtils.getPropertyValue(ack1, "logger.log", Log.class));
     new DirectFieldAccessor(ack1).setPropertyValue("logger.log", log1);
     given(log1.isWarnEnabled()).willReturn(true);
     willDoNothing().given(log1).warn(any());
     ack1.acknowledge(AcknowledgmentCallback.Status.REQUEUE);
     assertThat(received2.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(1L);
     AcknowledgmentCallback ack2 = StaticMessageHeaderAccessor.getAcknowledgmentCallback(received2);
     Log log2 = spy(KafkaTestUtils.getPropertyValue(ack2, "logger.log", Log.class));
     new DirectFieldAccessor(ack2).setPropertyValue("logger.log", log2);
     given(log2.isWarnEnabled()).willReturn(true);
     willDoNothing().given(log2).warn(any());
     ack2.acknowledge(AcknowledgmentCallback.Status.ACCEPT);
     received1 = source.receive();
     assertThat(received1.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(0L);
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received1).acknowledge(AcknowledgmentCallback.Status.ACCEPT);
     received2 = source.receive();
     assertThat(received2.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(1L);
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received2).acknowledge(AcknowledgmentCallback.Status.ACCEPT);
     received1 = source.receive();
     source.destroy();
     assertThat(received1).isNull();
     InOrder inOrder = inOrder(consumer, log1, log2);
     inOrder.verify(consumer).poll(any(Duration.class));
     inOrder.verify(consumer).paused();
     inOrder.verify(consumer).poll(any(Duration.class));
     // rollback
     inOrder.verify(consumer).seek(topicPartition, 0L);
     inOrder.verify(log1).isWarnEnabled();
     ArgumentCaptor&lt;LogMessage&gt; captor = ArgumentCaptor.forClass(LogMessage.class);
     inOrder.verify(log1).warn(captor.capture());
     assertThat(captor.getValue().toString()).contains("Rolled back").contains("later in-flight offsets [1] will also be re-fetched");
     inOrder.verify(log2).isWarnEnabled();
     captor = ArgumentCaptor.forClass(LogMessage.class);
     inOrder.verify(log2).warn(captor.capture());
     assertThat(captor.getValue().toString()).contains("Cannot commit offset for").contains("; an earlier offset was rolled back");
     inOrder.verify(consumer).poll(any(Duration.class));
     inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, new OffsetAndMetadata(1L)));
     inOrder.verify(consumer).poll(any(Duration.class));
     inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, new OffsetAndMetadata(2L)));
     inOrder.verify(consumer).poll(any(Duration.class));
     inOrder.verify(consumer).close(any());
     inOrder.verifyNoMoreInteractions();
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testNackWithLaterInflight</span><span class="hljs-params">()</span> </span>{

    Consumer consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    willAnswer(i -&gt; {

        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    AtomicReference&lt;Set&lt;TopicPartition&gt;&gt; paused = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;(<span class="hljs-keyword">new</span> HashSet&lt;&gt;());

    willAnswer(i -&gt; {

        paused.set(<span class="hljs-keyword">new</span> HashSet&lt;&gt;(i.getArgument(<span class="hljs-number">0</span>)));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).pause(anyCollection());

    willAnswer(i -&gt; paused.get()).given(consumer).paused();

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records1 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records1.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    ConsumerRecords cr1 = <span class="hljs-keyword">new</span> ConsumerRecords(records1);

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records2 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records2.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    ConsumerRecords cr2 = <span class="hljs-keyword">new</span> ConsumerRecords(records2);

    ConsumerRecords cr3 = <span class="hljs-keyword">new</span> ConsumerRecords(Collections.emptyMap());

    given(consumer.poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">cr1</span>, <span class="hljs-title">cr2</span>, <span class="hljs-title">cr1</span>, <span class="hljs-title">cr2</span>, <span class="hljs-title">cr3</span>)</span>;

    ConsumerFactory consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">1</span>)).given(consumerFactory).getConfigurationProperties();

    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);

    KafkaMessageSource source = <span class="hljs-keyword">new</span> KafkaMessageSource(consumerFactory, <span class="hljs-keyword">new</span> ConsumerProperties(<span class="hljs-string">"foo"</span>));

    Message&lt;?&gt; received1 = source.receive();

    <span class="hljs-comment">// need some other interaction with mock between polls for InOrder</span>

    consumer.paused();

    <span class="hljs-comment">// inflight</span>

    Message&lt;?&gt; received2 = source.receive();

    assertThat(received1.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(<span class="hljs-number">0L</span>);

    AcknowledgmentCallback ack1 = StaticMessageHeaderAccessor.getAcknowledgmentCallback(received1);

    Log log1 = spy(KafkaTestUtils.getPropertyValue(ack1, <span class="hljs-string">"logger.log"</span>, Log<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">new</span> DirectFieldAccessor(ack1).setPropertyValue(<span class="hljs-string">"logger.log"</span>, log1);

    given(log1.isWarnEnabled()).willReturn(<span class="hljs-keyword">true</span>);

    willDoNothing().given(log1).warn(any());

    ack1.acknowledge(AcknowledgmentCallback.Status.REQUEUE);

    assertThat(received2.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(<span class="hljs-number">1L</span>);

    AcknowledgmentCallback ack2 = StaticMessageHeaderAccessor.getAcknowledgmentCallback(received2);

    Log log2 = spy(KafkaTestUtils.getPropertyValue(ack2, <span class="hljs-string">"logger.log"</span>, Log<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">new</span> DirectFieldAccessor(ack2).setPropertyValue(<span class="hljs-string">"logger.log"</span>, log2);

    given(log2.isWarnEnabled()).willReturn(<span class="hljs-keyword">true</span>);

    willDoNothing().given(log2).warn(any());

    ack2.acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received1 = source.receive();

    assertThat(received1.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(<span class="hljs-number">0L</span>);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received1).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received2 = source.receive();

    assertThat(received2.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(<span class="hljs-number">1L</span>);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received2).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received1 = source.receive();

    source.destroy();

    assertThat(received1).isNull();

    InOrder inOrder = inOrder(consumer, log1, log2);

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).paused();

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-comment">// rollback</span>

    inOrder.verify(consumer).seek(topicPartition, <span class="hljs-number">0L</span>);

    inOrder.verify(log1).isWarnEnabled();

    ArgumentCaptor&lt;LogMessage&gt; captor = ArgumentCaptor.forClass(LogMessage<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    inOrder.verify(log1).warn(captor.capture());

    assertThat(captor.getValue().toString()).contains(<span class="hljs-string">"Rolled back"</span>).contains(<span class="hljs-string">"later in-flight offsets [1] will also be re-fetched"</span>);

    inOrder.verify(log2).isWarnEnabled();

    captor = ArgumentCaptor.forClass(LogMessage<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    inOrder.verify(log2).warn(captor.capture());

    assertThat(captor.getValue().toString()).contains(<span class="hljs-string">"Cannot commit offset for"</span>).contains(<span class="hljs-string">"; an earlier offset was rolled back"</span>);

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">1L</span>)));

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">2L</span>)));

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).close(any());

    inOrder.verifyNoMoreInteractions();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;K, V&gt; <span class="hljs-function">Consumer&lt;K, V&gt; <span class="hljs-title">createMockConsumer</span><span class="hljs-params">(<span class="hljs-keyword">final</span> TopicPartition topicPartition, <span class="hljs-keyword">final</span> AtomicReference&lt;Set&lt;TopicPartition&gt;&gt; paused, <span class="hljs-keyword">final</span> Answer&lt;?&gt; pausedAnswer)</span> </span>{
    Consumer&lt;K, V&gt; consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willAnswer(i -&gt; {
        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    willAnswer(i -&gt; {
        paused.set(<span class="hljs-keyword">new</span> HashSet&lt;&gt;(i.getArgument(<span class="hljs-number">0</span>)));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(consumer).pause(anyCollection());
    willAnswer(pausedAnswer).given(consumer).paused();
    <span class="hljs-keyword">return</span> consumer;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci17">Mock Clone Instance #spring-integration_MCI_17</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.kafka.clients.consumer.Consumer</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function">Consumer&lt;T&gt; <span class="hljs-title">createMockConsumer</span><span class="hljs-params">(List&lt;TopicPartition&gt; assigned)</span> </span>{
    Consumer&lt;T&gt; consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willAnswer(i -&gt; {
        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(assigned);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    willDoNothing().given(consumer).pause(anyCollection());
    willDoNothing().given(consumer).resume(anyCollection());
    <span class="hljs-keyword">return</span> consumer;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest171">Test Case ID #spring-integration_Test_17_1</h4>
<h4 id="test-case-name-testackcommonfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkainboundmessagesourcetestsjava">Test Case Name: <code>testAckCommon</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\inbound\MessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-consumer">Mock Object Variable Name: <code>consumer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @SuppressWarnings({ "rawtypes", "unchecked" })
 private void testAckCommon(boolean sync, boolean timeout) {
<span class="hljs-deletion">-    Consumer consumer = mock(Consumer.class);</span>
<span class="hljs-addition">+    Consumer consumer = createMockConsumer(assigned);</span>
     TopicPartition topicPartition = new TopicPartition("foo", 0);
     List&lt;TopicPartition&gt; assigned = Collections.singletonList(topicPartition);
<span class="hljs-deletion">-    willAnswer(i -&gt; {</span>
<span class="hljs-deletion">-        ((ConsumerRebalanceListener) i.getArgument(1)).onPartitionsAssigned(assigned);</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener.class));</span>
     ArgumentCaptor&lt;Collection&lt;TopicPartition&gt;&gt; partitions = ArgumentCaptor.forClass(Collection.class);
<span class="hljs-deletion">-    willDoNothing().given(consumer).pause(partitions.capture());</span>
<span class="hljs-deletion">-    willDoNothing().given(consumer).resume(partitions.capture());</span>
     willAnswer(invoc -&gt; {
         OffsetCommitCallback callback = invoc.getArgument(1);
         callback.onComplete(null, null);
         return null;
     }).given(consumer).commitAsync(any(), any());
     Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records1 = new LinkedHashMap&lt;&gt;();
     records1.put(topicPartition, Collections.singletonList(new ConsumerRecord("foo", 0, 0L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "foo", new RecordHeaders(), Optional.empty())));
     Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records2 = new LinkedHashMap&lt;&gt;();
     records2.put(topicPartition, Collections.singletonList(new ConsumerRecord("foo", 0, 1L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "bar", new RecordHeaders(), Optional.empty())));
     Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records3 = new LinkedHashMap&lt;&gt;();
     records3.put(topicPartition, Collections.singletonList(new ConsumerRecord("foo", 0, 2L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "baz", new RecordHeaders(), Optional.empty())));
     Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records4 = new LinkedHashMap&lt;&gt;();
     records4.put(topicPartition, Collections.singletonList(new ConsumerRecord("foo", 0, 3L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "qux", new RecordHeaders(), Optional.empty())));
     ConsumerRecords cr1 = new ConsumerRecords(records1);
     ConsumerRecords cr2 = new ConsumerRecords(records2);
     ConsumerRecords cr3 = new ConsumerRecords(records3);
     ConsumerRecords cr4 = new ConsumerRecords(records4);
     ConsumerRecords cr5 = new ConsumerRecords(Collections.emptyMap());
     given(consumer.poll(any(Duration.class))).willReturn(cr1, cr2, cr3, cr4, cr5);
     ConsumerFactory consumerFactory = mock(ConsumerFactory.class);
     willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 1)).given(consumerFactory).getConfigurationProperties();
     given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);
     ConsumerProperties consumerProperties = new ConsumerProperties("foo");
     AtomicInteger callbackCount = new AtomicInteger();
     OffsetCommitCallback commitCallback = (offsets, ex) -&gt; {
         callbackCount.incrementAndGet();
     };
     if (!sync) {
         consumerProperties.setSyncCommits(false);
         consumerProperties.setCommitCallback(commitCallback);
     }
     if (timeout) {
         consumerProperties.setSyncCommitTimeout(Duration.ofSeconds(5));
     }
     consumerProperties.setCommitLogLevel(Level.INFO);
     KafkaMessageSource source = new KafkaMessageSource(consumerFactory, consumerProperties);
     source.setRawMessageHeader(true);
     Message&lt;?&gt; received = source.receive();
     assertThat(received).isNotNull();
     assertThat(received.getHeaders().get(KafkaHeaders.RAW_DATA)).isInstanceOf(ConsumerRecord.class);
     assertThat(received.getHeaders().get(IntegrationMessageHeaderAccessor.SOURCE_DATA)).isSameAs(received.getHeaders().get(KafkaHeaders.RAW_DATA));
     assertThat(received.getHeaders()).containsKeys(MessageHeaders.TIMESTAMP, MessageHeaders.ID);
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);
     received = source.receive();
     assertThat(received).isNotNull();
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);
     received = source.receive();
     assertThat(received).isNotNull();
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);
     received = source.receive();
     assertThat(received).isNotNull();
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);
     received = source.receive();
     assertThat(received).isNull();
     source.pause();
     source.receive();
     source.resume();
     source.receive();
     source.destroy();
     InOrder inOrder = inOrder(consumer);
     inOrder.verify(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener.class));
     inOrder.verify(consumer).poll(any(Duration.class));
     checkCommit(sync, timeout, consumer, topicPartition, commitCallback, inOrder, 1L);
     inOrder.verify(consumer).poll(any(Duration.class));
     checkCommit(sync, timeout, consumer, topicPartition, commitCallback, inOrder, 2L);
     inOrder.verify(consumer).poll(any(Duration.class));
     checkCommit(sync, timeout, consumer, topicPartition, commitCallback, inOrder, 3L);
     inOrder.verify(consumer).poll(any(Duration.class));
     checkCommit(sync, timeout, consumer, topicPartition, commitCallback, inOrder, 4L);
     inOrder.verify(consumer).poll(any(Duration.class));
     inOrder.verify(consumer).pause(partitions.getAllValues().get(0));
     inOrder.verify(consumer).poll(any(Duration.class));
     inOrder.verify(consumer).resume(partitions.getAllValues().get(1));
     inOrder.verify(consumer).poll(any(Duration.class));
     inOrder.verify(consumer).close(any());
     inOrder.verifyNoMoreInteractions();
     if (!sync) {
         assertThat(callbackCount.get()).isEqualTo(4);
     }
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAckCommon</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> sync, <span class="hljs-keyword">boolean</span> timeout)</span> </span>{

    Consumer consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    List&lt;TopicPartition&gt; assigned = Collections.singletonList(topicPartition);

    willAnswer(i -&gt; {

        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(assigned);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ArgumentCaptor&lt;Collection&lt;TopicPartition&gt;&gt; partitions = ArgumentCaptor.forClass(Collection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willDoNothing().given(consumer).pause(partitions.capture());

    willDoNothing().given(consumer).resume(partitions.capture());

    willAnswer(invoc -&gt; {

        OffsetCommitCallback callback = invoc.getArgument(<span class="hljs-number">1</span>);

        callback.onComplete(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).commitAsync(any(), any());

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records1 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records1.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records2 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records2.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records3 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records3.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"baz"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records4 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records4.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"qux"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    ConsumerRecords cr1 = <span class="hljs-keyword">new</span> ConsumerRecords(records1);

    ConsumerRecords cr2 = <span class="hljs-keyword">new</span> ConsumerRecords(records2);

    ConsumerRecords cr3 = <span class="hljs-keyword">new</span> ConsumerRecords(records3);

    ConsumerRecords cr4 = <span class="hljs-keyword">new</span> ConsumerRecords(records4);

    ConsumerRecords cr5 = <span class="hljs-keyword">new</span> ConsumerRecords(Collections.emptyMap());

    given(consumer.poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">cr1</span>, <span class="hljs-title">cr2</span>, <span class="hljs-title">cr3</span>, <span class="hljs-title">cr4</span>, <span class="hljs-title">cr5</span>)</span>;

    ConsumerFactory consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">1</span>)).given(consumerFactory).getConfigurationProperties();

    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);

    ConsumerProperties consumerProperties = <span class="hljs-keyword">new</span> ConsumerProperties(<span class="hljs-string">"foo"</span>);

    AtomicInteger callbackCount = <span class="hljs-keyword">new</span> AtomicInteger();

    OffsetCommitCallback commitCallback = (offsets, ex) -&gt; {

        callbackCount.incrementAndGet();

    };

    <span class="hljs-keyword">if</span> (!sync) {

        consumerProperties.setSyncCommits(<span class="hljs-keyword">false</span>);

        consumerProperties.setCommitCallback(commitCallback);

    }

    <span class="hljs-keyword">if</span> (timeout) {

        consumerProperties.setSyncCommitTimeout(Duration.ofSeconds(<span class="hljs-number">5</span>));

    }

    consumerProperties.setCommitLogLevel(Level.INFO);

    KafkaMessageSource source = <span class="hljs-keyword">new</span> KafkaMessageSource(consumerFactory, consumerProperties);

    source.setRawMessageHeader(<span class="hljs-keyword">true</span>);

    Message&lt;?&gt; received = source.receive();

    assertThat(received).isNotNull();

    assertThat(received.getHeaders().get(KafkaHeaders.RAW_DATA)).isInstanceOf(ConsumerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    assertThat(received.getHeaders().get(IntegrationMessageHeaderAccessor.SOURCE_DATA)).isSameAs(received.getHeaders().get(KafkaHeaders.RAW_DATA));

    assertThat(received.getHeaders()).containsKeys(MessageHeaders.TIMESTAMP, MessageHeaders.ID);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    assertThat(received).isNotNull();

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    assertThat(received).isNotNull();

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    assertThat(received).isNotNull();

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    assertThat(received).isNull();

    source.pause();

    source.receive();

    source.resume();

    source.receive();

    source.destroy();

    InOrder inOrder = inOrder(consumer);

    inOrder.verify(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    checkCommit(sync, timeout, consumer, topicPartition, commitCallback, inOrder, <span class="hljs-number">1L</span>);

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    checkCommit(sync, timeout, consumer, topicPartition, commitCallback, inOrder, <span class="hljs-number">2L</span>);

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    checkCommit(sync, timeout, consumer, topicPartition, commitCallback, inOrder, <span class="hljs-number">3L</span>);

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    checkCommit(sync, timeout, consumer, topicPartition, commitCallback, inOrder, <span class="hljs-number">4L</span>);

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).pause(partitions.getAllValues().get(<span class="hljs-number">0</span>));

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).resume(partitions.getAllValues().get(<span class="hljs-number">1</span>));

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).close(any());

    inOrder.verifyNoMoreInteractions();

    <span class="hljs-keyword">if</span> (!sync) {

        assertThat(callbackCount.get()).isEqualTo(<span class="hljs-number">4</span>);

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function">Consumer&lt;T&gt; <span class="hljs-title">createMockConsumer</span><span class="hljs-params">(List&lt;TopicPartition&gt; assigned)</span> </span>{
    Consumer&lt;T&gt; consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willAnswer(i -&gt; {
        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(assigned);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    willDoNothing().given(consumer).pause(anyCollection());
    willDoNothing().given(consumer).resume(anyCollection());
    <span class="hljs-keyword">return</span> consumer;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest172">Test Case ID #spring-integration_Test_17_2</h4>
<h4 id="test-case-name-testallowmultifile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkainboundmessagesourcetestsjava">Test Case Name: <code>testAllowMulti</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\inbound\MessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-consumer">Mock Object Variable Name: <code>consumer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testAllowMulti() {
<span class="hljs-deletion">-    Consumer consumer = mock(Consumer.class);</span>
     TopicPartition topicPartition = new TopicPartition("foo", 0);
     List&lt;TopicPartition&gt; assigned = Collections.singletonList(topicPartition);
<span class="hljs-deletion">-    willAnswer(i -&gt; {</span>
<span class="hljs-deletion">-        ((ConsumerRebalanceListener) i.getArgument(1)).onPartitionsAssigned(assigned);</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener.class));</span>
<span class="hljs-addition">+    Consumer consumer = createMockConsumer(assigned);</span>
     ArgumentCaptor&lt;Collection&lt;TopicPartition&gt;&gt; partitions = ArgumentCaptor.forClass(Collection.class);
<span class="hljs-deletion">-    willDoNothing().given(consumer).pause(partitions.capture());</span>
<span class="hljs-deletion">-    willDoNothing().given(consumer).resume(partitions.capture());</span>
     Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records = new LinkedHashMap&lt;&gt;();
     records.put(topicPartition, Arrays.asList(new ConsumerRecord("foo", 0, 0L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "foo", new RecordHeaders(), Optional.empty()), new ConsumerRecord("foo", 0, 1L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "bar", new RecordHeaders(), Optional.empty()), new ConsumerRecord("foo", 0, 2L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "baz", new RecordHeaders(), Optional.empty()), new ConsumerRecord("foo", 0, 3L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "qux", new RecordHeaders(), Optional.empty())));
     ConsumerRecords cr1 = new ConsumerRecords(records);
     ConsumerRecords cr2 = new ConsumerRecords(Collections.emptyMap());
     given(consumer.poll(any(Duration.class))).willReturn(cr1, cr2);
     ConsumerFactory consumerFactory = mock(ConsumerFactory.class);
     willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 4)).given(consumerFactory).getConfigurationProperties();
     given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);
     KafkaMessageSource source = new KafkaMessageSource(consumerFactory, new ConsumerProperties("foo"), true);
     source.setRawMessageHeader(true);
     Message&lt;?&gt; received = source.receive();
     assertThat(received).isNotNull();
     assertThat(received.getHeaders().get(KafkaMessageSource.REMAINING_RECORDS, Integer.class)).isEqualTo(3);
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);
     received = source.receive();
     assertThat(received).isNotNull();
     assertThat(received.getHeaders().get(KafkaMessageSource.REMAINING_RECORDS, Integer.class)).isEqualTo(2);
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);
     received = source.receive();
     assertThat(received).isNotNull();
     assertThat(received.getHeaders().get(KafkaMessageSource.REMAINING_RECORDS, Integer.class)).isEqualTo(1);
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);
     received = source.receive();
     assertThat(received).isNotNull();
     assertThat(received.getHeaders().get(KafkaMessageSource.REMAINING_RECORDS, Integer.class)).isEqualTo(0);
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);
     received = source.receive();
     assertThat(received).isNull();
     source.destroy();
     InOrder inOrder = inOrder(consumer);
     inOrder.verify(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener.class));
     inOrder.verify(consumer).poll(any(Duration.class));
     inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, new OffsetAndMetadata(1L)));
     inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, new OffsetAndMetadata(2L)));
     inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, new OffsetAndMetadata(3L)));
     inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, new OffsetAndMetadata(4L)));
     inOrder.verify(consumer).poll(any(Duration.class));
     inOrder.verify(consumer).close(any());
     inOrder.verifyNoMoreInteractions();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAllowMulti</span><span class="hljs-params">()</span> </span>{

    Consumer consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    List&lt;TopicPartition&gt; assigned = Collections.singletonList(topicPartition);

    willAnswer(i -&gt; {

        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(assigned);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ArgumentCaptor&lt;Collection&lt;TopicPartition&gt;&gt; partitions = ArgumentCaptor.forClass(Collection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willDoNothing().given(consumer).pause(partitions.capture());

    willDoNothing().given(consumer).resume(partitions.capture());

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records.put(topicPartition, Arrays.asList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty()), <span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty()), <span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"baz"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty()), <span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"qux"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    ConsumerRecords cr1 = <span class="hljs-keyword">new</span> ConsumerRecords(records);

    ConsumerRecords cr2 = <span class="hljs-keyword">new</span> ConsumerRecords(Collections.emptyMap());

    given(consumer.poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">cr1</span>, <span class="hljs-title">cr2</span>)</span>;

    ConsumerFactory consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">4</span>)).given(consumerFactory).getConfigurationProperties();

    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);

    KafkaMessageSource source = <span class="hljs-keyword">new</span> KafkaMessageSource(consumerFactory, <span class="hljs-keyword">new</span> ConsumerProperties(<span class="hljs-string">"foo"</span>), <span class="hljs-keyword">true</span>);

    source.setRawMessageHeader(<span class="hljs-keyword">true</span>);

    Message&lt;?&gt; received = source.receive();

    assertThat(received).isNotNull();

    assertThat(received.getHeaders().get(KafkaMessageSource.REMAINING_RECORDS, Integer<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">isEqualTo</span>(3)</span>;

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    assertThat(received).isNotNull();

    assertThat(received.getHeaders().get(KafkaMessageSource.REMAINING_RECORDS, Integer<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">isEqualTo</span>(2)</span>;

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    assertThat(received).isNotNull();

    assertThat(received.getHeaders().get(KafkaMessageSource.REMAINING_RECORDS, Integer<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">isEqualTo</span>(1)</span>;

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    assertThat(received).isNotNull();

    assertThat(received.getHeaders().get(KafkaMessageSource.REMAINING_RECORDS, Integer<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">isEqualTo</span>(0)</span>;

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    assertThat(received).isNull();

    source.destroy();

    InOrder inOrder = inOrder(consumer);

    inOrder.verify(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">1L</span>)));

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">2L</span>)));

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">3L</span>)));

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">4L</span>)));

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).close(any());

    inOrder.verifyNoMoreInteractions();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function">Consumer&lt;T&gt; <span class="hljs-title">createMockConsumer</span><span class="hljs-params">(List&lt;TopicPartition&gt; assigned)</span> </span>{
    Consumer&lt;T&gt; consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willAnswer(i -&gt; {
        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(assigned);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    willDoNothing().given(consumer).pause(anyCollection());
    willDoNothing().given(consumer).resume(anyCollection());
    <span class="hljs-keyword">return</span> consumer;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci18">Mock Clone Instance #spring-integration_MCI_18</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.kafka.clients.consumer.Consumer</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;K, V&gt; <span class="hljs-function">Consumer&lt;K, V&gt; <span class="hljs-title">createMockConsumerWithSubscribeListener</span><span class="hljs-params">(AtomicReference&lt;ConsumerRebalanceListener&gt; listener)</span> </span>{
    Consumer&lt;K, V&gt; consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willAnswer(i -&gt; {
        listener.set(i.getArgument(<span class="hljs-number">1</span>));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    <span class="hljs-keyword">return</span> consumer;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest181">Test Case ID #spring-integration_Test_18_1</h4>
<h4 id="test-case-name-testconsumerawarerebalancelistenerfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkainboundmessagesourcetestsjava">Test Case Name: <code>testConsumerAwareRebalanceListener</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\inbound\MessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-consumer">Mock Object Variable Name: <code>consumer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testConsumerAwareRebalanceListener() {
<span class="hljs-deletion">-    Consumer consumer = mock(Consumer.class);</span>
     TopicPartition topicPartition = new TopicPartition("foo", 0);
     List&lt;TopicPartition&gt; assigned = Collections.singletonList(topicPartition);
     AtomicReference&lt;ConsumerRebalanceListener&gt; listener = new AtomicReference&lt;&gt;();
<span class="hljs-addition">+    Consumer consumer = createMockConsumerWithSubscribeListener(listener);</span>
     ConsumerFactory consumerFactory = mock(ConsumerFactory.class);
     willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 1)).given(consumerFactory).getConfigurationProperties();
     given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);
     ConsumerProperties consumerProperties = new ConsumerProperties("foo");
     AtomicBoolean partitionsAssignedCalled = new AtomicBoolean();
     AtomicReference&lt;Consumer&gt; partitionsAssignedConsumer = new AtomicReference&lt;&gt;();
     AtomicBoolean partitionsRevokedCalled = new AtomicBoolean();
     AtomicReference&lt;Consumer&gt; partitionsRevokedConsumer = new AtomicReference&lt;&gt;();
     consumerProperties.setConsumerRebalanceListener(new ConsumerAwareRebalanceListener() {

         @Override
         public void onPartitionsRevokedAfterCommit(Consumer&lt;?, ?&gt; cons, Collection&lt;TopicPartition&gt; partitions) {
             partitionsRevokedCalled.getAndSet(true);
             partitionsRevokedConsumer.set(cons);
         }

         @Override
         public void onPartitionsAssigned(Consumer&lt;?, ?&gt; cons, Collection&lt;TopicPartition&gt; partitions) {
             partitionsAssignedCalled.getAndSet(true);
             partitionsAssignedConsumer.set(cons);
         }
     });
     KafkaMessageSource source = new KafkaMessageSource(consumerFactory, consumerProperties);
     source.setRawMessageHeader(true);
     source.receive();
     listener.get().onPartitionsAssigned(assigned);
     assertThat(partitionsAssignedCalled.get()).isTrue();
     assertThat(partitionsAssignedConsumer.get()).isEqualTo(consumer);
     listener.get().onPartitionsRevoked(assigned);
     assertThat(partitionsRevokedCalled.get()).isTrue();
     assertThat(partitionsRevokedConsumer.get()).isEqualTo(consumer);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"unchecked"</span>, <span class="hljs-string">"rawtypes"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumerAwareRebalanceListener</span><span class="hljs-params">()</span> </span>{

    Consumer consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    List&lt;TopicPartition&gt; assigned = Collections.singletonList(topicPartition);

    AtomicReference&lt;ConsumerRebalanceListener&gt; listener = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    willAnswer(i -&gt; {

        listener.set(i.getArgument(<span class="hljs-number">1</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ConsumerFactory consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">1</span>)).given(consumerFactory).getConfigurationProperties();

    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);

    ConsumerProperties consumerProperties = <span class="hljs-keyword">new</span> ConsumerProperties(<span class="hljs-string">"foo"</span>);

    AtomicBoolean partitionsAssignedCalled = <span class="hljs-keyword">new</span> AtomicBoolean();

    AtomicReference&lt;Consumer&gt; partitionsAssignedConsumer = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    AtomicBoolean partitionsRevokedCalled = <span class="hljs-keyword">new</span> AtomicBoolean();

    AtomicReference&lt;Consumer&gt; partitionsRevokedConsumer = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    consumerProperties.setConsumerRebalanceListener(<span class="hljs-keyword">new</span> ConsumerAwareRebalanceListener() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onPartitionsRevokedAfterCommit</span><span class="hljs-params">(Consumer&lt;?, ?&gt; cons, Collection&lt;TopicPartition&gt; partitions)</span> </span>{

            partitionsRevokedCalled.getAndSet(<span class="hljs-keyword">true</span>);

            partitionsRevokedConsumer.set(cons);

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onPartitionsAssigned</span><span class="hljs-params">(Consumer&lt;?, ?&gt; cons, Collection&lt;TopicPartition&gt; partitions)</span> </span>{

            partitionsAssignedCalled.getAndSet(<span class="hljs-keyword">true</span>);

            partitionsAssignedConsumer.set(cons);

        }

    });

    KafkaMessageSource source = <span class="hljs-keyword">new</span> KafkaMessageSource(consumerFactory, consumerProperties);

    source.setRawMessageHeader(<span class="hljs-keyword">true</span>);

    source.receive();

    listener.get().onPartitionsAssigned(assigned);

    assertThat(partitionsAssignedCalled.get()).isTrue();

    assertThat(partitionsAssignedConsumer.get()).isEqualTo(consumer);

    listener.get().onPartitionsRevoked(assigned);

    assertThat(partitionsRevokedCalled.get()).isTrue();

    assertThat(partitionsRevokedConsumer.get()).isEqualTo(consumer);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;K, V&gt; <span class="hljs-function">Consumer&lt;K, V&gt; <span class="hljs-title">createMockConsumerWithSubscribeListener</span><span class="hljs-params">(AtomicReference&lt;ConsumerRebalanceListener&gt; listener)</span> </span>{
    Consumer&lt;K, V&gt; consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willAnswer(i -&gt; {
        listener.set(i.getArgument(<span class="hljs-number">1</span>));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    <span class="hljs-keyword">return</span> consumer;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest182">Test Case ID #spring-integration_Test_18_2</h4>
<h4 id="test-case-name-testrebalancelistenerfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkainboundmessagesourcetestsjava">Test Case Name: <code>testRebalanceListener</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\inbound\MessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-consumer">Mock Object Variable Name: <code>consumer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testRebalanceListener() {
<span class="hljs-deletion">-    Consumer consumer = mock(Consumer.class);</span>
     TopicPartition topicPartition1 = new TopicPartition("foo", 0);
     List&lt;TopicPartition&gt; assigned1 = new ArrayList&lt;&gt;(Collections.singletonList(topicPartition1));
     TopicPartition topicPartition2 = new TopicPartition("foo", 1);
     List&lt;TopicPartition&gt; assigned2 = new ArrayList&lt;&gt;(Collections.singletonList(topicPartition2));
     AtomicReference&lt;ConsumerRebalanceListener&gt; listener = new AtomicReference&lt;&gt;();
<span class="hljs-addition">+    Consumer consumer = createMockConsumerWithSubscribeListener(listener);</span>
<span class="hljs-deletion">-    willAnswer(i -&gt; {</span>
<span class="hljs-deletion">-        listener.set(i.getArgument(1));</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener.class));</span>
     ConsumerFactory consumerFactory = mock(ConsumerFactory.class);
     willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 1)).given(consumerFactory).getConfigurationProperties();
     given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);
     ConsumerProperties consumerProperties = new ConsumerProperties("foo");
     AtomicBoolean partitionsAssignedCalled = new AtomicBoolean();
     AtomicBoolean partitionsRevokedCalled = new AtomicBoolean();
     consumerProperties.setConsumerRebalanceListener(new ConsumerRebalanceListener() {

         @Override
         public void onPartitionsRevoked(Collection&lt;TopicPartition&gt; partitions) {
             partitionsRevokedCalled.getAndSet(true);
         }

         @Override
         public void onPartitionsAssigned(Collection&lt;TopicPartition&gt; partitions) {
             partitionsAssignedCalled.getAndSet(true);
         }
     });
     KafkaMessageSource source = new KafkaMessageSource(consumerFactory, consumerProperties);
     source.setRawMessageHeader(true);
     source.receive();
     listener.get().onPartitionsAssigned(assigned1);
     assertThat(partitionsAssignedCalled.get()).isTrue();
     assertThat(new ArrayList&lt;&gt;(source.getAssignedPartitions())).isEqualTo(assigned1);
     listener.get().onPartitionsAssigned(assigned2);
     List&lt;TopicPartition&gt; temp = new ArrayList&lt;&gt;(assigned1);
     temp.addAll(assigned2);
     assertThat(new ArrayList&lt;&gt;(source.getAssignedPartitions())).isEqualTo(temp);
     listener.get().onPartitionsRevoked(assigned1);
     assertThat(partitionsRevokedCalled.get()).isTrue();
     assertThat(new ArrayList&lt;&gt;(source.getAssignedPartitions())).isEqualTo(assigned2);
     source.pause();
     assertThat(source.isPaused()).isFalse();
     InOrder inOrder = inOrder(consumer);
     source.receive();
     assertThat(source.isPaused()).isTrue();
     inOrder.verify(consumer).pause(new LinkedHashSet&lt;&gt;(assigned2));
     inOrder.verify(consumer).poll(any());
     listener.get().onPartitionsAssigned(assigned1);
     inOrder.verify(consumer).pause(new LinkedHashSet&lt;&gt;(temp));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"unchecked"</span>, <span class="hljs-string">"rawtypes"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRebalanceListener</span><span class="hljs-params">()</span> </span>{

    Consumer consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TopicPartition topicPartition1 = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    List&lt;TopicPartition&gt; assigned1 = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(Collections.singletonList(topicPartition1));

    TopicPartition topicPartition2 = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">1</span>);

    List&lt;TopicPartition&gt; assigned2 = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(Collections.singletonList(topicPartition2));

    AtomicReference&lt;ConsumerRebalanceListener&gt; listener = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    willAnswer(i -&gt; {

        listener.set(i.getArgument(<span class="hljs-number">1</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ConsumerFactory consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">1</span>)).given(consumerFactory).getConfigurationProperties();

    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);

    ConsumerProperties consumerProperties = <span class="hljs-keyword">new</span> ConsumerProperties(<span class="hljs-string">"foo"</span>);

    AtomicBoolean partitionsAssignedCalled = <span class="hljs-keyword">new</span> AtomicBoolean();

    AtomicBoolean partitionsRevokedCalled = <span class="hljs-keyword">new</span> AtomicBoolean();

    consumerProperties.setConsumerRebalanceListener(<span class="hljs-keyword">new</span> ConsumerRebalanceListener() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onPartitionsRevoked</span><span class="hljs-params">(Collection&lt;TopicPartition&gt; partitions)</span> </span>{

            partitionsRevokedCalled.getAndSet(<span class="hljs-keyword">true</span>);

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onPartitionsAssigned</span><span class="hljs-params">(Collection&lt;TopicPartition&gt; partitions)</span> </span>{

            partitionsAssignedCalled.getAndSet(<span class="hljs-keyword">true</span>);

        }

    });

    KafkaMessageSource source = <span class="hljs-keyword">new</span> KafkaMessageSource(consumerFactory, consumerProperties);

    source.setRawMessageHeader(<span class="hljs-keyword">true</span>);

    source.receive();

    listener.get().onPartitionsAssigned(assigned1);

    assertThat(partitionsAssignedCalled.get()).isTrue();

    assertThat(<span class="hljs-keyword">new</span> ArrayList&lt;&gt;(source.getAssignedPartitions())).isEqualTo(assigned1);

    listener.get().onPartitionsAssigned(assigned2);

    List&lt;TopicPartition&gt; temp = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(assigned1);

    temp.addAll(assigned2);

    assertThat(<span class="hljs-keyword">new</span> ArrayList&lt;&gt;(source.getAssignedPartitions())).isEqualTo(temp);

    listener.get().onPartitionsRevoked(assigned1);

    assertThat(partitionsRevokedCalled.get()).isTrue();

    assertThat(<span class="hljs-keyword">new</span> ArrayList&lt;&gt;(source.getAssignedPartitions())).isEqualTo(assigned2);

    source.pause();

    assertThat(source.isPaused()).isFalse();

    InOrder inOrder = inOrder(consumer);

    source.receive();

    assertThat(source.isPaused()).isTrue();

    inOrder.verify(consumer).pause(<span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;(assigned2));

    inOrder.verify(consumer).poll(any());

    listener.get().onPartitionsAssigned(assigned1);

    inOrder.verify(consumer).pause(<span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;(temp));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;K, V&gt; <span class="hljs-function">Consumer&lt;K, V&gt; <span class="hljs-title">createMockConsumerWithSubscribeListener</span><span class="hljs-params">(AtomicReference&lt;ConsumerRebalanceListener&gt; listener)</span> </span>{
    Consumer&lt;K, V&gt; consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willAnswer(i -&gt; {
        listener.set(i.getArgument(<span class="hljs-number">1</span>));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    <span class="hljs-keyword">return</span> consumer;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest183">Test Case ID #spring-integration_Test_18_3</h4>
<h4 id="test-case-name-testpolltimeoutsfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkainboundmessagesourcetestsjava">Test Case Name: <code>testPollTimeouts</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\inbound\MessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-consumer">Mock Object Variable Name: <code>consumer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @SuppressWarnings({ "rawtypes", "unchecked" })
 @Test
 void testPollTimeouts() {
<span class="hljs-deletion">-    Consumer consumer = mock(Consumer.class);</span>
<span class="hljs-addition">+    Consumer consumer = createMockConsumerWithSubscribeListener(listener);</span>
     TopicPartition topicPartition = new TopicPartition("foo", 0);
     List&lt;TopicPartition&gt; assigned = Collections.singletonList(topicPartition);
     AtomicReference&lt;ConsumerRebalanceListener&gt; listener = new AtomicReference&lt;&gt;();
<span class="hljs-deletion">-    willAnswer(i -&gt; {</span>
<span class="hljs-deletion">-        listener.set(i.getArgument(1));</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener.class));</span>
     Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records1 = new LinkedHashMap&lt;&gt;();
     records1.put(topicPartition, Collections.singletonList(new ConsumerRecord("foo", 0, 0L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "foo", new RecordHeaders(), Optional.empty())));
     ConsumerRecords cr1 = new ConsumerRecords(records1);
     given(consumer.poll(Duration.of(20 * 5000, ChronoUnit.MILLIS))).willReturn(cr1, ConsumerRecords.EMPTY);
     Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records2 = new LinkedHashMap&lt;&gt;();
     records2.put(topicPartition, Collections.singletonList(new ConsumerRecord("foo", 0, 1L, 0L, TimestampType.NO_TIMESTAMP_TYPE, 0, 0, null, "foo", new RecordHeaders(), Optional.empty())));
     ConsumerRecords cr2 = new ConsumerRecords(records2);
     given(consumer.poll(Duration.of(5000, ChronoUnit.MILLIS))).willReturn(cr2, ConsumerRecords.EMPTY);
     ConsumerFactory consumerFactory = mock(ConsumerFactory.class);
     willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 1)).given(consumerFactory).getConfigurationProperties();
     given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);
     KafkaMessageSource source = new KafkaMessageSource(consumerFactory, new ConsumerProperties("foo"));
     source.setRawMessageHeader(true);
     Message&lt;?&gt; received = source.receive();
     assertThat(received).isNotNull();
     assertThat(received).isNotNull();
     assertThat(received.getHeaders().get(KafkaHeaders.RAW_DATA)).isInstanceOf(ConsumerRecord.class);
     assertThat(received.getHeaders().get(KafkaHeaders.RAW_DATA)).isEqualTo(cr1.records(topicPartition).get(0));
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);
     listener.get().onPartitionsAssigned(assigned);
     received = source.receive();
     assertThat(received).isNotNull();
     assertThat(received.getHeaders().get(KafkaHeaders.RAW_DATA)).isInstanceOf(ConsumerRecord.class);
     assertThat(received.getHeaders().get(KafkaHeaders.RAW_DATA)).isEqualTo(cr2.records(topicPartition).get(0));
     StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);
     listener.get().onPartitionsRevoked(assigned);
     received = source.receive();
     assertThat(received).isNull();
     InOrder inOrder = inOrder(consumer);
     inOrder.verify(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener.class));
     // assignTimeout used on initial poll (before partition assigned)
     inOrder.verify(consumer).poll(Duration.of(20 * 5000, ChronoUnit.MILLIS));
     inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, new OffsetAndMetadata(1L)));
     // pollTimeout used on subsequent polls
     inOrder.verify(consumer).poll(Duration.of(5000, ChronoUnit.MILLIS));
     inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, new OffsetAndMetadata(2L)));
     // assignTimeout used after partitions revoked
     inOrder.verify(consumer).poll(Duration.of(20 * 5000, ChronoUnit.MILLIS));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testPollTimeouts</span><span class="hljs-params">()</span> </span>{

    Consumer consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    List&lt;TopicPartition&gt; assigned = Collections.singletonList(topicPartition);

    AtomicReference&lt;ConsumerRebalanceListener&gt; listener = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    willAnswer(i -&gt; {

        listener.set(i.getArgument(<span class="hljs-number">1</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records1 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records1.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    ConsumerRecords cr1 = <span class="hljs-keyword">new</span> ConsumerRecords(records1);

    given(consumer.poll(Duration.of(<span class="hljs-number">20</span> * <span class="hljs-number">5000</span>, ChronoUnit.MILLIS))).willReturn(cr1, ConsumerRecords.EMPTY);

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records2 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records2.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    ConsumerRecords cr2 = <span class="hljs-keyword">new</span> ConsumerRecords(records2);

    given(consumer.poll(Duration.of(<span class="hljs-number">5000</span>, ChronoUnit.MILLIS))).willReturn(cr2, ConsumerRecords.EMPTY);

    ConsumerFactory consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">1</span>)).given(consumerFactory).getConfigurationProperties();

    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);

    KafkaMessageSource source = <span class="hljs-keyword">new</span> KafkaMessageSource(consumerFactory, <span class="hljs-keyword">new</span> ConsumerProperties(<span class="hljs-string">"foo"</span>));

    source.setRawMessageHeader(<span class="hljs-keyword">true</span>);

    Message&lt;?&gt; received = source.receive();

    assertThat(received).isNotNull();

    assertThat(received).isNotNull();

    assertThat(received.getHeaders().get(KafkaHeaders.RAW_DATA)).isInstanceOf(ConsumerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    assertThat(received.getHeaders().get(KafkaHeaders.RAW_DATA)).isEqualTo(cr1.records(topicPartition).get(<span class="hljs-number">0</span>));

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    listener.get().onPartitionsAssigned(assigned);

    received = source.receive();

    assertThat(received).isNotNull();

    assertThat(received.getHeaders().get(KafkaHeaders.RAW_DATA)).isInstanceOf(ConsumerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    assertThat(received.getHeaders().get(KafkaHeaders.RAW_DATA)).isEqualTo(cr2.records(topicPartition).get(<span class="hljs-number">0</span>));

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    listener.get().onPartitionsRevoked(assigned);

    received = source.receive();

    assertThat(received).isNull();

    InOrder inOrder = inOrder(consumer);

    inOrder.verify(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-comment">// assignTimeout used on initial poll (before partition assigned)</span>

    inOrder.verify(consumer).poll(Duration.of(<span class="hljs-number">20</span> * <span class="hljs-number">5000</span>, ChronoUnit.MILLIS));

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">1L</span>)));

    <span class="hljs-comment">// pollTimeout used on subsequent polls</span>

    inOrder.verify(consumer).poll(Duration.of(<span class="hljs-number">5000</span>, ChronoUnit.MILLIS));

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">2L</span>)));

    <span class="hljs-comment">// assignTimeout used after partitions revoked</span>

    inOrder.verify(consumer).poll(Duration.of(<span class="hljs-number">20</span> * <span class="hljs-number">5000</span>, ChronoUnit.MILLIS));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;K, V&gt; <span class="hljs-function">Consumer&lt;K, V&gt; <span class="hljs-title">createMockConsumerWithSubscribeListener</span><span class="hljs-params">(AtomicReference&lt;ConsumerRebalanceListener&gt; listener)</span> </span>{
    Consumer&lt;K, V&gt; consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willAnswer(i -&gt; {
        listener.set(i.getArgument(<span class="hljs-number">1</span>));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    <span class="hljs-keyword">return</span> consumer;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci19">Mock Clone Instance #spring-integration_MCI_19</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.kafka.clients.consumer.Consumer</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Consumer&lt;String, String&gt; <span class="hljs-title">createMockConsumer</span><span class="hljs-params">(
        TopicPartition topicPartition,
        AtomicBoolean done,
        ConsumerRecords&lt;String, String&gt; records,
        ConsumerGroupMetadata meta)</span> </span>{
    Consumer&lt;String, String&gt; mockConsumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willAnswer(i -&gt; {
        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(mockConsumer).subscribe(any(Collection<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">ConsumerRebalanceListener</span>.<span class="hljs-title">class</span>))</span>;
    willAnswer(i -&gt; {
        <span class="hljs-keyword">if</span> (done.compareAndSet(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>)) {
            <span class="hljs-keyword">return</span> records;
        } <span class="hljs-keyword">else</span> {
            Thread.sleep(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        }
    }).given(mockConsumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    given(mockConsumer.groupMetadata()).willReturn(meta);
    <span class="hljs-keyword">return</span> mockConsumer;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest191">Test Case ID #spring-integration_Test_19_1</h4>
<h4 id="test-case-name-testconsumeandproducetransactionfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkaoutboundkafkaproducermessagehandlertestsjava">Test Case Name: <code>testConsumeAndProduceTransaction</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\outbound\KafkaProducerMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-mockconsumer">Mock Object Variable Name: <code>mockConsumer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testConsumeAndProduceTransaction() throws Exception {
<span class="hljs-deletion">-    Consumer mockConsumer = mock(Consumer.class);</span>
     final TopicPartition topicPartition = new TopicPartition("foo", 0);
<span class="hljs-addition">+    final AtomicBoolean done = new AtomicBoolean();</span>
<span class="hljs-addition">+    ConsumerRecords records = new ConsumerRecords(Collections.singletonMap(topicPartition, Collections.singletonList(new ConsumerRecord&lt;&gt;("foo", 0, 0, "key", "value"))));</span>
<span class="hljs-addition">+    ConsumerGroupMetadata meta = new ConsumerGroupMetadata("group");</span>
<span class="hljs-addition">+    Consumer mockConsumer = createMockConsumer(topicPartition, done, records, meta);</span>
     willAnswer(i -&gt; {
         ((ConsumerRebalanceListener) i.getArgument(1)).onPartitionsAssigned(Collections.singletonList(topicPartition));
         return null;
     }).given(mockConsumer).subscribe(any(Collection.class), any(ConsumerRebalanceListener.class));
     ConsumerRecords records = new ConsumerRecords(Collections.singletonMap(topicPartition, Collections.singletonList(new ConsumerRecord&lt;&gt;("foo", 0, 0, "key", "value"))));
<span class="hljs-deletion">-    final AtomicBoolean done = new AtomicBoolean();</span>
<span class="hljs-deletion">-    willAnswer(i -&gt; {</span>
<span class="hljs-deletion">-        if (done.compareAndSet(false, true)) {</span>
<span class="hljs-deletion">-            return records;</span>
<span class="hljs-deletion">-        } else {</span>
<span class="hljs-deletion">-            Thread.sleep(500);</span>
<span class="hljs-deletion">-            return null;</span>
<span class="hljs-deletion">-        }</span>
<span class="hljs-deletion">-    }).given(mockConsumer).poll(any(Duration.class));</span>
<span class="hljs-deletion">-    ConsumerGroupMetadata meta = new ConsumerGroupMetadata("group");</span>
<span class="hljs-deletion">-    given(mockConsumer.groupMetadata()).willReturn(meta);</span>
     ConsumerFactory cf = mock(ConsumerFactory.class);
     willReturn(mockConsumer).given(cf).createConsumer("group", "", null, KafkaTestUtils.defaultPropertyOverrides());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"unchecked"</span>, <span class="hljs-string">"rawtypes"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumeAndProduceTransaction</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Consumer mockConsumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    willAnswer(i -&gt; {

        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(mockConsumer).subscribe(any(Collection<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">ConsumerRebalanceListener</span>.<span class="hljs-title">class</span>))</span>;

    ConsumerRecords records = <span class="hljs-keyword">new</span> ConsumerRecords(Collections.singletonMap(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord&lt;&gt;(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>))));

    <span class="hljs-keyword">final</span> AtomicBoolean done = <span class="hljs-keyword">new</span> AtomicBoolean();

    willAnswer(i -&gt; {

        <span class="hljs-keyword">if</span> (done.compareAndSet(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>)) {

            <span class="hljs-keyword">return</span> records;

        } <span class="hljs-keyword">else</span> {

            Thread.sleep(<span class="hljs-number">500</span>);

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

        }

    }).given(mockConsumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ConsumerGroupMetadata meta = <span class="hljs-keyword">new</span> ConsumerGroupMetadata(<span class="hljs-string">"group"</span>);

    given(mockConsumer.groupMetadata()).willReturn(meta);

    ConsumerFactory cf = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(mockConsumer).given(cf).createConsumer(<span class="hljs-string">"group"</span>, <span class="hljs-string">""</span>, <span class="hljs-keyword">null</span>, KafkaTestUtils.defaultPropertyOverrides());

    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(producer.send(any(), any())).willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">final</span> CountDownLatch closeLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">2</span>);

    willAnswer(i -&gt; {

        closeLatch.countDown();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(producer).close(any());

    ProducerFactory pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(pf.transactionCapable()).willReturn(<span class="hljs-keyword">true</span>);

    willReturn(producer).given(pf).createProducer(isNull());

    KafkaTransactionManager ptm = <span class="hljs-keyword">new</span> KafkaTransactionManager(pf);

    ContainerProperties props = <span class="hljs-keyword">new</span> ContainerProperties(<span class="hljs-string">"foo"</span>);

    props.setGroupId(<span class="hljs-string">"group"</span>);

    props.setKafkaAwareTransactionManager(ptm);

    props.setAssignmentCommitOption(AssignmentCommitOption.ALWAYS);

    <span class="hljs-keyword">final</span> KafkaTemplate template = <span class="hljs-keyword">new</span> KafkaTemplate(pf);

    KafkaMessageListenerContainer container = <span class="hljs-keyword">new</span> KafkaMessageListenerContainer&lt;&gt;(cf, props);

    container.setBeanName(<span class="hljs-string">"commit"</span>);

    KafkaMessageDrivenChannelAdapter inbound = <span class="hljs-keyword">new</span> KafkaMessageDrivenChannelAdapter&lt;&gt;(container);

    DirectChannel channel = <span class="hljs-keyword">new</span> DirectChannel();

    inbound.setOutputChannel(channel);

    KafkaProducerMessageHandler handler = <span class="hljs-keyword">new</span> KafkaProducerMessageHandler(template);

    handler.setMessageKeyExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    handler.setTopicExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"topic"</span>));

    channel.subscribe(handler);

    inbound.afterPropertiesSet();

    inbound.start();

    assertThat(closeLatch.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    InOrder inOrder = inOrder(producer);

    inOrder.verify(producer).beginTransaction();

    inOrder.verify(producer).sendOffsetsToTransaction(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">0</span>)), meta);

    inOrder.verify(producer).commitTransaction();

    inOrder.verify(producer).close(any());

    inOrder.verify(producer).beginTransaction();

    ArgumentCaptor&lt;ProducerRecord&gt; captor = ArgumentCaptor.forClass(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    inOrder.verify(producer).send(captor.capture(), any(Callback<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-keyword">new</span> ProducerRecord(<span class="hljs-string">"topic"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-string">"value"</span>));

    inOrder.verify(producer).sendOffsetsToTransaction(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">1</span>)), meta);

    inOrder.verify(producer).commitTransaction();

    inOrder.verify(producer).close(any());

    container.stop();

    verify(pf, times(<span class="hljs-number">2</span>)).createProducer(isNull());

    verifyNoMoreInteractions(producer);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Consumer&lt;String, String&gt; <span class="hljs-title">createMockConsumer</span><span class="hljs-params">(
        TopicPartition topicPartition,
        AtomicBoolean done,
        ConsumerRecords&lt;String, String&gt; records,
        ConsumerGroupMetadata meta)</span> </span>{
    Consumer&lt;String, String&gt; mockConsumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willAnswer(i -&gt; {
        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(mockConsumer).subscribe(any(Collection<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">ConsumerRebalanceListener</span>.<span class="hljs-title">class</span>))</span>;
    willAnswer(i -&gt; {
        <span class="hljs-keyword">if</span> (done.compareAndSet(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>)) {
            <span class="hljs-keyword">return</span> records;
        } <span class="hljs-keyword">else</span> {
            Thread.sleep(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        }
    }).given(mockConsumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    given(mockConsumer.groupMetadata()).willReturn(meta);
    <span class="hljs-keyword">return</span> mockConsumer;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest192">Test Case ID #spring-integration_Test_19_2</h4>
<h4 id="test-case-name-testconsumeandproducetransactiontxidoverridefile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkaoutboundkafkaproducermessagehandlertestsjava">Test Case Name: <code>testConsumeAndProduceTransactionTxIdOverride</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\outbound\KafkaProducerMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-mockconsumer">Mock Object Variable Name: <code>mockConsumer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @SuppressWarnings({ "unchecked", "rawtypes" })
 @Test
 void testConsumeAndProduceTransactionTxIdOverride() throws Exception {
<span class="hljs-deletion">-    Consumer mockConsumer = mock(Consumer.class);</span>
     final TopicPartition topicPartition = new TopicPartition("foo", 0);
<span class="hljs-addition">+    final TopicPartition topicPartition = new TopicPartition("foo", 0);</span>
     willAnswer(i -&gt; {
         ((ConsumerRebalanceListener) i.getArgument(1)).onPartitionsAssigned(Collections.singletonList(topicPartition));
         return null;
     }).given(mockConsumer).subscribe(any(Collection.class), any(ConsumerRebalanceListener.class));
     ConsumerRecords records = new ConsumerRecords(Collections.singletonMap(topicPartition, Collections.singletonList(new ConsumerRecord&lt;&gt;("foo", 0, 0, "key", "value"))));
     final AtomicBoolean done = new AtomicBoolean();
     willAnswer(i -&gt; {
         if (done.compareAndSet(false, true)) {
             return records;
         } else {
             Thread.sleep(500);
             return null;
         }
     }).given(mockConsumer).poll(any(Duration.class));
     ConsumerGroupMetadata meta = new ConsumerGroupMetadata("group");
<span class="hljs-deletion">-    given(mockConsumer.groupMetadata()).willReturn(meta);</span>
<span class="hljs-addition">+    Consumer mockConsumer = createMockConsumer(topicPartition, done, records, meta);</span>
     ConsumerFactory cf = mock(ConsumerFactory.class);
     willReturn(mockConsumer).given(cf).createConsumer("group", "", null, KafkaTestUtils.defaultPropertyOverrides());
     Producer producer = mock(Producer.class);
     given(producer.send(any(), any())).willReturn(mock(Future.class));
     final CountDownLatch closeLatch = new CountDownLatch(2);
     willAnswer(i -&gt; {
         closeLatch.countDown();
         return null;
     }).given(producer).close(any());
     AtomicReference&lt;String&gt; txId = new AtomicReference&lt;&gt;();
     DefaultKafkaProducerFactory pf = new DefaultKafkaProducerFactory(Collections.emptyMap()) {

         @Override
         protected Producer createTransactionalProducer(String txIdPrefix) {
             txId.set(txIdPrefix);
             return producer;
         }
     };
     pf.setTransactionIdPrefix("default.tx.id.");
     KafkaTransactionManager tm = new KafkaTransactionManager(pf);
     tm.setTransactionIdPrefix("tm.tx.id.");
     ContainerProperties props = new ContainerProperties("foo");
     props.setGroupId("group");
     props.setKafkaAwareTransactionManager(tm);
     props.setAssignmentCommitOption(AssignmentCommitOption.ALWAYS);
     final KafkaTemplate template = new KafkaTemplate(pf);
     template.setTransactionIdPrefix("template.tx.id.");
     KafkaMessageListenerContainer container = new KafkaMessageListenerContainer&lt;&gt;(cf, props);
     container.setBeanName("commit");
     KafkaMessageDrivenChannelAdapter inbound = new KafkaMessageDrivenChannelAdapter&lt;&gt;(container);
     DirectChannel channel = new DirectChannel();
     inbound.setOutputChannel(channel);
     KafkaProducerMessageHandler handler = new KafkaProducerMessageHandler(template);
     handler.setMessageKeyExpression(new LiteralExpression("bar"));
     handler.setTopicExpression(new LiteralExpression("topic"));
     channel.subscribe(handler);
     inbound.afterPropertiesSet();
     inbound.start();
     assertThat(closeLatch.await(10, TimeUnit.SECONDS)).isTrue();
     InOrder inOrder = inOrder(producer);
     inOrder.verify(producer).beginTransaction();
     inOrder.verify(producer).sendOffsetsToTransaction(Collections.singletonMap(topicPartition, new OffsetAndMetadata(0)), meta);
     inOrder.verify(producer).commitTransaction();
     inOrder.verify(producer).close(any());
     inOrder.verify(producer).beginTransaction();
     ArgumentCaptor&lt;ProducerRecord&gt; captor = ArgumentCaptor.forClass(ProducerRecord.class);
     inOrder.verify(producer).send(captor.capture(), any(Callback.class));
     assertThat(captor.getValue()).isEqualTo(new ProducerRecord("topic", null, "bar", "value"));
     inOrder.verify(producer).sendOffsetsToTransaction(Collections.singletonMap(topicPartition, new OffsetAndMetadata(1)), meta);
     inOrder.verify(producer).commitTransaction();
     inOrder.verify(producer).close(any());
     container.stop();
     verifyNoMoreInteractions(producer);
     assertThat(txId.get()).isEqualTo("tm.tx.id.");
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"unchecked"</span>, <span class="hljs-string">"rawtypes"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumeAndProduceTransactionTxIdOverride</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Consumer mockConsumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    willAnswer(i -&gt; {

        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(mockConsumer).subscribe(any(Collection<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">ConsumerRebalanceListener</span>.<span class="hljs-title">class</span>))</span>;

    ConsumerRecords records = <span class="hljs-keyword">new</span> ConsumerRecords(Collections.singletonMap(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord&lt;&gt;(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>))));

    <span class="hljs-keyword">final</span> AtomicBoolean done = <span class="hljs-keyword">new</span> AtomicBoolean();

    willAnswer(i -&gt; {

        <span class="hljs-keyword">if</span> (done.compareAndSet(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>)) {

            <span class="hljs-keyword">return</span> records;

        } <span class="hljs-keyword">else</span> {

            Thread.sleep(<span class="hljs-number">500</span>);

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

        }

    }).given(mockConsumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ConsumerGroupMetadata meta = <span class="hljs-keyword">new</span> ConsumerGroupMetadata(<span class="hljs-string">"group"</span>);

    given(mockConsumer.groupMetadata()).willReturn(meta);

    ConsumerFactory cf = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(mockConsumer).given(cf).createConsumer(<span class="hljs-string">"group"</span>, <span class="hljs-string">""</span>, <span class="hljs-keyword">null</span>, KafkaTestUtils.defaultPropertyOverrides());

    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(producer.send(any(), any())).willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">final</span> CountDownLatch closeLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">2</span>);

    willAnswer(i -&gt; {

        closeLatch.countDown();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(producer).close(any());

    AtomicReference&lt;String&gt; txId = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    DefaultKafkaProducerFactory pf = <span class="hljs-keyword">new</span> DefaultKafkaProducerFactory(Collections.emptyMap()) {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">protected</span> Producer <span class="hljs-title">createTransactionalProducer</span><span class="hljs-params">(String txIdPrefix)</span> </span>{

            txId.set(txIdPrefix);

            <span class="hljs-keyword">return</span> producer;

        }

    };

    pf.setTransactionIdPrefix(<span class="hljs-string">"default.tx.id."</span>);

    KafkaTransactionManager tm = <span class="hljs-keyword">new</span> KafkaTransactionManager(pf);

    tm.setTransactionIdPrefix(<span class="hljs-string">"tm.tx.id."</span>);

    ContainerProperties props = <span class="hljs-keyword">new</span> ContainerProperties(<span class="hljs-string">"foo"</span>);

    props.setGroupId(<span class="hljs-string">"group"</span>);

    props.setKafkaAwareTransactionManager(tm);

    props.setAssignmentCommitOption(AssignmentCommitOption.ALWAYS);

    <span class="hljs-keyword">final</span> KafkaTemplate template = <span class="hljs-keyword">new</span> KafkaTemplate(pf);

    template.setTransactionIdPrefix(<span class="hljs-string">"template.tx.id."</span>);

    KafkaMessageListenerContainer container = <span class="hljs-keyword">new</span> KafkaMessageListenerContainer&lt;&gt;(cf, props);

    container.setBeanName(<span class="hljs-string">"commit"</span>);

    KafkaMessageDrivenChannelAdapter inbound = <span class="hljs-keyword">new</span> KafkaMessageDrivenChannelAdapter&lt;&gt;(container);

    DirectChannel channel = <span class="hljs-keyword">new</span> DirectChannel();

    inbound.setOutputChannel(channel);

    KafkaProducerMessageHandler handler = <span class="hljs-keyword">new</span> KafkaProducerMessageHandler(template);

    handler.setMessageKeyExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    handler.setTopicExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"topic"</span>));

    channel.subscribe(handler);

    inbound.afterPropertiesSet();

    inbound.start();

    assertThat(closeLatch.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    InOrder inOrder = inOrder(producer);

    inOrder.verify(producer).beginTransaction();

    inOrder.verify(producer).sendOffsetsToTransaction(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">0</span>)), meta);

    inOrder.verify(producer).commitTransaction();

    inOrder.verify(producer).close(any());

    inOrder.verify(producer).beginTransaction();

    ArgumentCaptor&lt;ProducerRecord&gt; captor = ArgumentCaptor.forClass(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    inOrder.verify(producer).send(captor.capture(), any(Callback<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-keyword">new</span> ProducerRecord(<span class="hljs-string">"topic"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-string">"value"</span>));

    inOrder.verify(producer).sendOffsetsToTransaction(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">1</span>)), meta);

    inOrder.verify(producer).commitTransaction();

    inOrder.verify(producer).close(any());

    container.stop();

    verifyNoMoreInteractions(producer);

    assertThat(txId.get()).isEqualTo(<span class="hljs-string">"tm.tx.id."</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Consumer&lt;String, String&gt; <span class="hljs-title">createMockConsumer</span><span class="hljs-params">(
        TopicPartition topicPartition,
        AtomicBoolean done,
        ConsumerRecords&lt;String, String&gt; records,
        ConsumerGroupMetadata meta)</span> </span>{
    Consumer&lt;String, String&gt; mockConsumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willAnswer(i -&gt; {
        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(mockConsumer).subscribe(any(Collection<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">ConsumerRebalanceListener</span>.<span class="hljs-title">class</span>))</span>;
    willAnswer(i -&gt; {
        <span class="hljs-keyword">if</span> (done.compareAndSet(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>)) {
            <span class="hljs-keyword">return</span> records;
        } <span class="hljs-keyword">else</span> {
            Thread.sleep(<span class="hljs-number">500</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        }
    }).given(mockConsumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    given(mockConsumer.groupMetadata()).willReturn(meta);
    <span class="hljs-keyword">return</span> mockConsumer;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci20">Mock Clone Instance #spring-integration_MCI_20</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.amqp.rabbit.connection.Connection</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">createMockConnection</span><span class="hljs-params">(Channel channel)</span> </span>{
    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(invocation -&gt; channel).when(connection).createChannel(anyBoolean());
    <span class="hljs-keyword">return</span> connection;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest201">Test Case ID #spring-integration_Test_20_1</h4>
<h4 id="test-case-name-testptpfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpchanneldispatcherhasnosubscriberstestsjava">Test Case Name: <code>testPtP</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\channel\DispatcherHasNoSubscribersTests.java</code>)</h4>
<h4 id="mock-object-variable-name-connection">Mock Object Variable Name: <code>connection</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(channel.queueDeclare(anyString(), anyBoolean(), anyBoolean(), anyBoolean(), isNull())).thenReturn(declareOk);
<span class="hljs-deletion">-    Connection connection = mock(Connection.class);</span>
<span class="hljs-deletion">-    doAnswer(invocation -&gt; channel).when(connection).createChannel(anyBoolean());</span>
<span class="hljs-addition">+    Connection connection = createMockConnection(channel);</span>
    ConnectionFactory connectionFactory = mock(ConnectionFactory.class);
    when(connectionFactory.createConnection()).thenReturn(connection);
    SimpleMessageListenerContainer container = new SimpleMessageListenerContainer();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testPtP</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-keyword">final</span> Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DeclareOk declareOk = mock(DeclareOk<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(declareOk.getQueue()).thenReturn(<span class="hljs-string">"noSubscribersChannel"</span>);

    when(channel.queueDeclare(anyString(), anyBoolean(), anyBoolean(), anyBoolean(), isNull())).thenReturn(declareOk);

    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    doAnswer(invocation -&gt; channel).when(connection).createChannel(anyBoolean());

    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(connectionFactory.createConnection()).thenReturn(connection);

    SimpleMessageListenerContainer container = <span class="hljs-keyword">new</span> SimpleMessageListenerContainer();

    container.setConnectionFactory(connectionFactory);

    AmqpTemplate amqpTemplate = mock(AmqpTemplate<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    PointToPointSubscribableAmqpChannel amqpChannel = <span class="hljs-keyword">new</span> PointToPointSubscribableAmqpChannel(<span class="hljs-string">"noSubscribersChannel"</span>, container, amqpTemplate);

    amqpChannel.setBeanName(<span class="hljs-string">"noSubscribersChannel"</span>);

    amqpChannel.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    amqpChannel.afterPropertiesSet();

    MessageListener listener = container.getMessageListener();

    assertThatExceptionOfType(MessageDeliveryException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(() -&gt; <span class="hljs-title">listener</span>.<span class="hljs-title">onMessage</span>(<span class="hljs-title">new</span> <span class="hljs-title">Message</span>("<span class="hljs-title">Hello</span> <span class="hljs-title">world</span>!".<span class="hljs-title">getBytes</span>()))).<span class="hljs-title">withMessageContaining</span>("<span class="hljs-title">Dispatcher</span> <span class="hljs-title">has</span> <span class="hljs-title">no</span> <span class="hljs-title">subscribers</span> <span class="hljs-title">for</span> <span class="hljs-title">amqp</span>-<span class="hljs-title">channel</span> '<span class="hljs-title">noSubscribersChannel</span>'.")</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">createMockConnection</span><span class="hljs-params">(Channel channel)</span> </span>{
    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(invocation -&gt; channel).when(connection).createChannel(anyBoolean());
    <span class="hljs-keyword">return</span> connection;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest202">Test Case ID #spring-integration_Test_20_2</h4>
<h4 id="test-case-name-testpubsubfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpchanneldispatcherhasnosubscriberstestsjava">Test Case Name: <code>testPubSub</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\channel\DispatcherHasNoSubscribersTests.java</code>)</h4>
<h4 id="mock-object-variable-name-connection">Mock Object Variable Name: <code>connection</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final Channel channel = mock(Channel.class);
<span class="hljs-deletion">-    Connection connection = mock(Connection.class);</span>
<span class="hljs-deletion">-    doAnswer(invocation -&gt; channel).when(connection).createChannel(anyBoolean());</span>
<span class="hljs-addition">+    Connection connection = createMockConnection(channel);</span>
    ConnectionFactory connectionFactory = mock(ConnectionFactory.class);
    when(connectionFactory.createConnection()).thenReturn(connection);
    SimpleMessageListenerContainer container = new SimpleMessageListenerContainer();
    container.setConnectionFactory(connectionFactory);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testPubSub</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    doAnswer(invocation -&gt; channel).when(connection).createChannel(anyBoolean());

    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(connectionFactory.createConnection()).thenReturn(connection);

    SimpleMessageListenerContainer container = <span class="hljs-keyword">new</span> SimpleMessageListenerContainer();

    container.setConnectionFactory(connectionFactory);

    AmqpTemplate amqpTemplate = mock(AmqpTemplate<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    PublishSubscribeAmqpChannel amqpChannel = <span class="hljs-keyword">new</span> PublishSubscribeAmqpChannel(<span class="hljs-string">"noSubscribersChannel"</span>, container, amqpTemplate);

    amqpChannel.setBeanName(<span class="hljs-string">"noSubscribersChannel"</span>);

    amqpChannel.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    amqpChannel.afterPropertiesSet();

    List&lt;String&gt; logList = insertMockLoggerInListener(amqpChannel);

    MessageListener listener = container.getMessageListener();

    listener.onMessage(<span class="hljs-keyword">new</span> Message(<span class="hljs-string">"Hello world!"</span>.getBytes()));

    verifyLogReceived(logList);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">createMockConnection</span><span class="hljs-params">(Channel channel)</span> </span>{
    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(invocation -&gt; channel).when(connection).createChannel(anyBoolean());
    <span class="hljs-keyword">return</span> connection;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci21">Mock Clone Instance #spring-integration_MCI_21</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.amqp.rabbit.connection.Connection</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">createMockConnection</span><span class="hljs-params">(PublisherCallbackChannelImpl publisherCallbackChannel)</span> </span>{
    Connection mockConnection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(mockConnection.createChannel(<span class="hljs-keyword">false</span>)).thenReturn(publisherCallbackChannel);
    <span class="hljs-keyword">return</span> mockConnection;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest211">Test Case ID #spring-integration_Test_21_1</h4>
<h4 id="test-case-name-testint2773usedefaultamqptemplateexchangeandroutingleyfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpconfigamqpoutboundchanneladapterparsertestsjava">Test Case Name: <code>testInt2773UseDefaultAmqpTemplateExchangeAndRoutingLey</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\config\AmqpOutboundChannelAdapterParserTests.java</code>)</h4>
<h4 id="mock-object-variable-name-mockconnection">Mock Object Variable Name: <code>mockConnection</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ConnectionFactory connectionFactory = context.getBean(ConnectionFactory.class);
<span class="hljs-deletion">-    Connection mockConnection = mock(Connection.class);</span>
    Channel mockChannel = mock(Channel.class);
    when(connectionFactory.createConnection()).thenReturn(mockConnection);
    PublisherCallbackChannelImpl publisherCallbackChannel = new PublisherCallbackChannelImpl(mockChannel, mock(ExecutorService.class));
<span class="hljs-deletion">-    when(mockConnection.createChannel(false)).thenReturn(publisherCallbackChannel);</span>
<span class="hljs-addition">+    Connection mockConnection = createMockConnection(publisherCallbackChannel);</span>
    MessageChannel requestChannel = context.getBean("toRabbitOnlyWithTemplateChannel", MessageChannel.class);
    requestChannel.send(MessageBuilder.withPayload("test").build());
    Mockito.verify(mockChannel, Mockito.times(1)).basicPublish(Mockito.eq("default.test.exchange"), Mockito.eq("default.routing.key"), Mockito.anyBoolean(), Mockito.any(BasicProperties.class), Mockito.any(byte[].class));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInt2773UseDefaultAmqpTemplateExchangeAndRoutingLey</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{

    ConnectionFactory connectionFactory = context.getBean(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Connection mockConnection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Channel mockChannel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(connectionFactory.createConnection()).thenReturn(mockConnection);

    PublisherCallbackChannelImpl publisherCallbackChannel = <span class="hljs-keyword">new</span> PublisherCallbackChannelImpl(mockChannel, mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    when(mockConnection.createChannel(<span class="hljs-keyword">false</span>)).thenReturn(publisherCallbackChannel);

    MessageChannel requestChannel = context.getBean(<span class="hljs-string">"toRabbitOnlyWithTemplateChannel"</span>, MessageChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    requestChannel.send(MessageBuilder.withPayload(<span class="hljs-string">"test"</span>).build());

    Mockito.verify(mockChannel, Mockito.times(<span class="hljs-number">1</span>)).basicPublish(Mockito.eq(<span class="hljs-string">"default.test.exchange"</span>), Mockito.eq(<span class="hljs-string">"default.routing.key"</span>), Mockito.anyBoolean(), Mockito.any(BasicProperties<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">Mockito</span>.<span class="hljs-title">any</span>(<span class="hljs-title">byte</span>[].<span class="hljs-title">class</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">createMockConnection</span><span class="hljs-params">(PublisherCallbackChannelImpl publisherCallbackChannel)</span> </span>{
    Connection mockConnection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(mockConnection.createChannel(<span class="hljs-keyword">false</span>)).thenReturn(publisherCallbackChannel);
    <span class="hljs-keyword">return</span> mockConnection;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest212">Test Case ID #spring-integration_Test_21_2</h4>
<h4 id="test-case-name-testint2773withdefaultamqptemplateexchangeandroutingkeyfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpconfigamqpoutboundchanneladapterparsertestsjava">Test Case Name: <code>testInt2773WithDefaultAmqpTemplateExchangeAndRoutingKey</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\config\AmqpOutboundChannelAdapterParserTests.java</code>)</h4>
<h4 id="mock-object-variable-name-mockconnection">Mock Object Variable Name: <code>mockConnection</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ConnectionFactory connectionFactory = context.getBean(ConnectionFactory.class);
<span class="hljs-deletion">-    Connection mockConnection = mock(Connection.class);</span>
    Channel mockChannel = mock(Channel.class);
    when(connectionFactory.createConnection()).thenReturn(mockConnection);
    PublisherCallbackChannelImpl publisherCallbackChannel = new PublisherCallbackChannelImpl(mockChannel, mock(ExecutorService.class));
<span class="hljs-deletion">-    when(mockConnection.createChannel(false)).thenReturn(publisherCallbackChannel);</span>
<span class="hljs-addition">+    Connection mockConnection = createMockConnection(publisherCallbackChannel);</span>
    MessageChannel requestChannel = context.getBean("withDefaultAmqpTemplateExchangeAndRoutingKey", MessageChannel.class);
    requestChannel.send(MessageBuilder.withPayload("test").build());
    Mockito.verify(mockChannel, Mockito.times(1)).basicPublish(Mockito.eq(""), Mockito.eq(""), Mockito.anyBoolean(), Mockito.any(BasicProperties.class), Mockito.any(byte[].class));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInt2773WithDefaultAmqpTemplateExchangeAndRoutingKey</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{

    ConnectionFactory connectionFactory = context.getBean(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Connection mockConnection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Channel mockChannel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(connectionFactory.createConnection()).thenReturn(mockConnection);

    PublisherCallbackChannelImpl publisherCallbackChannel = <span class="hljs-keyword">new</span> PublisherCallbackChannelImpl(mockChannel, mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    when(mockConnection.createChannel(<span class="hljs-keyword">false</span>)).thenReturn(publisherCallbackChannel);

    MessageChannel requestChannel = context.getBean(<span class="hljs-string">"withDefaultAmqpTemplateExchangeAndRoutingKey"</span>, MessageChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    requestChannel.send(MessageBuilder.withPayload(<span class="hljs-string">"test"</span>).build());

    Mockito.verify(mockChannel, Mockito.times(<span class="hljs-number">1</span>)).basicPublish(Mockito.eq(<span class="hljs-string">""</span>), Mockito.eq(<span class="hljs-string">""</span>), Mockito.anyBoolean(), Mockito.any(BasicProperties<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">Mockito</span>.<span class="hljs-title">any</span>(<span class="hljs-title">byte</span>[].<span class="hljs-title">class</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">createMockConnection</span><span class="hljs-params">(PublisherCallbackChannelImpl publisherCallbackChannel)</span> </span>{
    Connection mockConnection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(mockConnection.createChannel(<span class="hljs-keyword">false</span>)).thenReturn(publisherCallbackChannel);
    <span class="hljs-keyword">return</span> mockConnection;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest213">Test Case ID #spring-integration_Test_21_3</h4>
<h4 id="test-case-name-testint2773withoverridetodefaultamqptemplateexchangeandroutingleyfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpconfigamqpoutboundchanneladapterparsertestsjava">Test Case Name: <code>testInt2773WithOverrideToDefaultAmqpTemplateExchangeAndRoutingLey</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\config\AmqpOutboundChannelAdapterParserTests.java</code>)</h4>
<h4 id="mock-object-variable-name-mockconnection">Mock Object Variable Name: <code>mockConnection</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ConnectionFactory connectionFactory = context.getBean(ConnectionFactory.class);
<span class="hljs-deletion">-    Connection mockConnection = mock(Connection.class);</span>
    Channel mockChannel = mock(Channel.class);
    when(connectionFactory.createConnection()).thenReturn(mockConnection);
    PublisherCallbackChannelImpl publisherCallbackChannel = new PublisherCallbackChannelImpl(mockChannel, mock(ExecutorService.class));
<span class="hljs-deletion">-    when(mockConnection.createChannel(false)).thenReturn(publisherCallbackChannel);</span>
<span class="hljs-addition">+    Connection mockConnection = createMockConnection(publisherCallbackChannel);</span>
    MessageChannel requestChannel = context.getBean("overrideTemplateAttributesToEmpty", MessageChannel.class);
    requestChannel.send(MessageBuilder.withPayload("test").build());
    Mockito.verify(mockChannel, Mockito.times(1)).basicPublish(Mockito.eq(""), Mockito.eq(""), Mockito.anyBoolean(), Mockito.any(BasicProperties.class), Mockito.any(byte[].class));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInt2773WithOverrideToDefaultAmqpTemplateExchangeAndRoutingLey</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{

    ConnectionFactory connectionFactory = context.getBean(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Connection mockConnection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Channel mockChannel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(connectionFactory.createConnection()).thenReturn(mockConnection);

    PublisherCallbackChannelImpl publisherCallbackChannel = <span class="hljs-keyword">new</span> PublisherCallbackChannelImpl(mockChannel, mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    when(mockConnection.createChannel(<span class="hljs-keyword">false</span>)).thenReturn(publisherCallbackChannel);

    MessageChannel requestChannel = context.getBean(<span class="hljs-string">"overrideTemplateAttributesToEmpty"</span>, MessageChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    requestChannel.send(MessageBuilder.withPayload(<span class="hljs-string">"test"</span>).build());

    Mockito.verify(mockChannel, Mockito.times(<span class="hljs-number">1</span>)).basicPublish(Mockito.eq(<span class="hljs-string">""</span>), Mockito.eq(<span class="hljs-string">""</span>), Mockito.anyBoolean(), Mockito.any(BasicProperties<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">Mockito</span>.<span class="hljs-title">any</span>(<span class="hljs-title">byte</span>[].<span class="hljs-title">class</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">createMockConnection</span><span class="hljs-params">(PublisherCallbackChannelImpl publisherCallbackChannel)</span> </span>{
    Connection mockConnection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(mockConnection.createChannel(<span class="hljs-keyword">false</span>)).thenReturn(publisherCallbackChannel);
    <span class="hljs-keyword">return</span> mockConnection;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci22">Mock Clone Instance #spring-integration_MCI_22</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>jakarta.mail.Store</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Store <span class="hljs-title">createMockStore</span><span class="hljs-params">(IMAPFolder folder, <span class="hljs-keyword">boolean</span> isConnected)</span> </span>{
    Store store = mock(Store<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(store.isConnected()).willReturn(isConnected);
    given(store.getFolder(Mockito.any(URLName<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">folder</span>)</span>;
    <span class="hljs-keyword">return</span> store;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest221">Test Case ID #spring-integration_Test_22_1</h4>
<h4 id="test-case-name-testnoinitialidledelaywhenrecentnotsupportedfile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailimapmailreceivertestsjava">Test Case Name: <code>testNoInitialIdleDelayWhenRecentNotSupported</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\ImapMailReceiverTests.java</code>)</h4>
<h4 id="mock-object-variable-name-store">Mock Object Variable Name: <code>store</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Field storeField = AbstractMailReceiver.class.getDeclaredField("store");
    storeField.setAccessible(true);
<span class="hljs-deletion">-    Store store = mock(Store.class);</span>
<span class="hljs-deletion">-    given(store.isConnected()).willReturn(true);</span>
<span class="hljs-deletion">-    given(store.getFolder(Mockito.any(URLName.class))).willReturn(folder);</span>
<span class="hljs-addition">+    Store store = createMockStore(folder, true);</span>
    storeField.set(receiver, store);
    receiver.afterPropertiesSet();
    DirectFieldAccessor adapterAccessor = new DirectFieldAccessor(adapter);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"resource"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNoInitialIdleDelayWhenRecentNotSupported</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    ImapIdleChannelAdapter adapter = <span class="hljs-keyword">this</span>.context.getBean(<span class="hljs-string">"simpleAdapter"</span>, ImapIdleChannelAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    QueueChannel channel = <span class="hljs-keyword">new</span> QueueChannel();

    adapter.setOutputChannel(channel);

    adapter.setReconnectDelay(<span class="hljs-number">10</span>);

    ImapMailReceiver receiver = <span class="hljs-keyword">new</span> ImapMailReceiver(<span class="hljs-string">"imap:foo"</span>);

    ThreadPoolTaskScheduler taskScheduler = <span class="hljs-keyword">new</span> ThreadPoolTaskScheduler();

    setUpScheduler(receiver, taskScheduler);

    <span class="hljs-keyword">final</span> IMAPFolder folder = mock(IMAPFolder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(folder.getPermanentFlags()).willReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));

    given(folder.isOpen()).willReturn(<span class="hljs-keyword">false</span>).willReturn(<span class="hljs-keyword">true</span>);

    given(folder.exists()).willReturn(<span class="hljs-keyword">true</span>);

    Field storeField = AbstractMailReceiver<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredField</span>("<span class="hljs-title">store</span>")</span>;

    storeField.setAccessible(<span class="hljs-keyword">true</span>);

    Store store = mock(Store<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(store.isConnected()).willReturn(<span class="hljs-keyword">true</span>);

    given(store.getFolder(Mockito.any(URLName<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">folder</span>)</span>;

    storeField.set(receiver, store);

    receiver.afterPropertiesSet();

    DirectFieldAccessor adapterAccessor = <span class="hljs-keyword">new</span> DirectFieldAccessor(adapter);

    adapterAccessor.setPropertyValue(<span class="hljs-string">"mailReceiver"</span>, receiver);

    Message mailMessage = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test1"</span>);

    <span class="hljs-keyword">final</span> Message[] messages = <span class="hljs-keyword">new</span> Message[] { mailMessage };

    <span class="hljs-keyword">final</span> AtomicInteger shouldFindMessagesCounter = <span class="hljs-keyword">new</span> AtomicInteger(<span class="hljs-number">2</span>);

    willAnswer(invocation -&gt; {

        <span class="hljs-comment">/*

			 * Return the message from first invocation of waitForMessages()

			 * and in receive(); then return false in the next call to

			 * waitForMessages() so we enter idle(); counter will be reset

			 * to 1 in the mocked idle().

			 */</span>

        <span class="hljs-keyword">if</span> (shouldFindMessagesCounter.decrementAndGet() &gt;= <span class="hljs-number">0</span>) {

            <span class="hljs-keyword">return</span> messages;

        } <span class="hljs-keyword">else</span> {

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Message[<span class="hljs-number">0</span>];

        }

    }).given(folder).search(any(SearchTerm<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    willAnswer(invocation -&gt; {

        Thread.sleep(<span class="hljs-number">300</span>);

        shouldFindMessagesCounter.set(<span class="hljs-number">1</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(folder).idle(<span class="hljs-keyword">true</span>);

    adapter.start();

    <span class="hljs-comment">/*

		 * Idle takes 5 seconds; if all is well, we should receive the first message

		 * before then.

		 */</span>

    assertThat(channel.receive(<span class="hljs-number">20000</span>)).isNotNull();

    <span class="hljs-comment">// We should not receive any more until the next idle elapses</span>

    assertThat(channel.receive(<span class="hljs-number">100</span>)).isNull();

    assertThat(channel.receive(<span class="hljs-number">10000</span>)).isNotNull();

    adapter.stop();

    taskScheduler.shutdown();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Store <span class="hljs-title">createMockStore</span><span class="hljs-params">(IMAPFolder folder, <span class="hljs-keyword">boolean</span> isConnected)</span> </span>{
    Store store = mock(Store<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(store.isConnected()).willReturn(isConnected);
    given(store.getFolder(Mockito.any(URLName<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">folder</span>)</span>;
    <span class="hljs-keyword">return</span> store;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest222">Test Case ID #spring-integration_Test_22_2</h4>
<h4 id="test-case-name-testinitialidledelaywhenrecentissupportedfile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailimapmailreceivertestsjava">Test Case Name: <code>testInitialIdleDelayWhenRecentIsSupported</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\ImapMailReceiverTests.java</code>)</h4>
<h4 id="mock-object-variable-name-store">Mock Object Variable Name: <code>store</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    Field storeField = AbstractMailReceiver.class.getDeclaredField("store");
    storeField.setAccessible(true);
<span class="hljs-deletion">-    Store store = mock(Store.class);</span>
<span class="hljs-deletion">-    given(store.isConnected()).willReturn(true);</span>
<span class="hljs-deletion">-    given(store.getFolder(Mockito.any(URLName.class))).willReturn(folder);</span>
<span class="hljs-addition">+    Store store = createMockStore(folder, true);</span>
    storeField.set(receiver, store);
    receiver.afterPropertiesSet();
    DirectFieldAccessor adapterAccessor = new DirectFieldAccessor(adapter);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInitialIdleDelayWhenRecentIsSupported</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    ImapIdleChannelAdapter adapter = <span class="hljs-keyword">this</span>.context.getBean(<span class="hljs-string">"simpleAdapter"</span>, ImapIdleChannelAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    QueueChannel channel = <span class="hljs-keyword">new</span> QueueChannel();

    adapter.setOutputChannel(channel);

    adapter.setReconnectDelay(<span class="hljs-number">100</span>);

    adapter.afterPropertiesSet();

    ImapMailReceiver receiver = <span class="hljs-keyword">new</span> ImapMailReceiver(<span class="hljs-string">"imap:foo"</span>);

    receiver.setCancelIdleInterval(<span class="hljs-number">10</span>);

    ThreadPoolTaskScheduler taskScheduler = <span class="hljs-keyword">new</span> ThreadPoolTaskScheduler();

    setUpScheduler(receiver, taskScheduler);

    IMAPFolder folder = mock(IMAPFolder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(folder.getPermanentFlags()).willReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.RECENT));

    given(folder.isOpen()).willReturn(<span class="hljs-keyword">false</span>).willReturn(<span class="hljs-keyword">true</span>);

    given(folder.exists()).willReturn(<span class="hljs-keyword">true</span>);

    Field storeField = AbstractMailReceiver<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredField</span>("<span class="hljs-title">store</span>")</span>;

    storeField.setAccessible(<span class="hljs-keyword">true</span>);

    Store store = mock(Store<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(store.isConnected()).willReturn(<span class="hljs-keyword">true</span>);

    given(store.getFolder(Mockito.any(URLName<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">folder</span>)</span>;

    storeField.set(receiver, store);

    receiver.afterPropertiesSet();

    DirectFieldAccessor adapterAccessor = <span class="hljs-keyword">new</span> DirectFieldAccessor(adapter);

    adapterAccessor.setPropertyValue(<span class="hljs-string">"mailReceiver"</span>, receiver);

    Message mailMessage = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test1"</span>);

    Message[] messages = <span class="hljs-keyword">new</span> Message[] { mailMessage };

    willAnswer(invocation -&gt; messages).given(folder).search(any(SearchTerm<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    CountDownLatch idles = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">2</span>);

    willAnswer(invocation -&gt; {

        idles.countDown();

        Thread.sleep(<span class="hljs-number">500</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(folder).idle(<span class="hljs-keyword">true</span>);

    adapter.start();

    <span class="hljs-comment">/*

		 * Idle takes 5 seconds; since this server supports RECENT, we should

		 * not receive any early messages.

		 */</span>

    assertThat(channel.receive(<span class="hljs-number">100</span>)).isNull();

    assertThat(channel.receive(<span class="hljs-number">20000</span>)).isNotNull();

    assertThat(idles.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    adapter.stop();

    taskScheduler.shutdown();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Store <span class="hljs-title">createMockStore</span><span class="hljs-params">(IMAPFolder folder, <span class="hljs-keyword">boolean</span> isConnected)</span> </span>{
    Store store = mock(Store<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(store.isConnected()).willReturn(isConnected);
    given(store.getFolder(Mockito.any(URLName<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">folder</span>)</span>;
    <span class="hljs-keyword">return</span> store;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest223">Test Case ID #spring-integration_Test_22_3</h4>
<h4 id="test-case-name-testidlereconnectsfile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailimapmailreceivertestsjava">Test Case Name: <code>testIdleReconnects</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\ImapMailReceiverTests.java</code>)</h4>
<h4 id="mock-object-variable-name-store">Mock Object Variable Name: <code>store</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Field storeField = AbstractMailReceiver.class.getDeclaredField("store");
    storeField.setAccessible(true);
<span class="hljs-deletion">-    Store store = mock(Store.class);</span>
<span class="hljs-deletion">-    given(store.isConnected()).willReturn(false);</span>
<span class="hljs-deletion">-    given(store.getFolder(Mockito.any(URLName.class))).willReturn(folder);</span>
<span class="hljs-addition">+    Store store = createMockStore(folder, false);</span>
    storeField.set(receiver, store);
    ImapIdleChannelAdapter adapter = new ImapIdleChannelAdapter(receiver);
    LogAccessor logger = spy(TestUtils.getPropertyValue(adapter, "logger", LogAccessor.class));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testIdleReconnects</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    ImapMailReceiver receiver = spy(<span class="hljs-keyword">new</span> ImapMailReceiver(<span class="hljs-string">"imap:foo"</span>));

    receiver.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    receiver.afterPropertiesSet();

    IMAPFolder folder = mock(IMAPFolder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(folder.getPermanentFlags()).willReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));

    given(folder.isOpen()).willReturn(<span class="hljs-keyword">false</span>).willReturn(<span class="hljs-keyword">true</span>);

    given(folder.exists()).willReturn(<span class="hljs-keyword">true</span>);

    given(folder.hasNewMessages()).willReturn(<span class="hljs-keyword">true</span>);

    Field storeField = AbstractMailReceiver<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredField</span>("<span class="hljs-title">store</span>")</span>;

    storeField.setAccessible(<span class="hljs-keyword">true</span>);

    Store store = mock(Store<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(store.isConnected()).willReturn(<span class="hljs-keyword">false</span>);

    given(store.getFolder(Mockito.any(URLName<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">folder</span>)</span>;

    storeField.set(receiver, store);

    ImapIdleChannelAdapter adapter = <span class="hljs-keyword">new</span> ImapIdleChannelAdapter(receiver);

    LogAccessor logger = spy(TestUtils.getPropertyValue(adapter, <span class="hljs-string">"logger"</span>, LogAccessor<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">new</span> DirectFieldAccessor(adapter).setPropertyValue(<span class="hljs-string">"logger"</span>, logger);

    willDoNothing().given(logger).warn(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;

    willAnswer(i -&gt; {

        i.callRealMethod();

        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FolderClosedException(folder, <span class="hljs-string">"test"</span>);

    }).given(receiver).waitForNewMessages();

    adapter.setReconnectDelay(<span class="hljs-number">10</span>);

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">3</span>);

    adapter.setApplicationEventPublisher(e -&gt; latch.countDown());

    adapter.afterPropertiesSet();

    adapter.start();

    assertThat(latch.await(<span class="hljs-number">60</span>, TimeUnit.SECONDS)).isTrue();

    verify(store, atLeast(<span class="hljs-number">3</span>)).connect();

    adapter.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Store <span class="hljs-title">createMockStore</span><span class="hljs-params">(IMAPFolder folder, <span class="hljs-keyword">boolean</span> isConnected)</span> </span>{
    Store store = mock(Store<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(store.isConnected()).willReturn(isConnected);
    given(store.getFolder(Mockito.any(URLName<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">folder</span>)</span>;
    <span class="hljs-keyword">return</span> store;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci23">Mock Clone Instance #spring-integration_MCI_23</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.file.remote.session.Session&lt;org.apache.commons.net.ftp.FTPFile&gt;</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session&lt;FTPFile&gt; <span class="hljs-title">createMockSession</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isOpenReturn)</span> </span>{
    Session&lt;FTPFile&gt; session = Mockito.mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(session.isOpen()).thenReturn(isOpenReturn);
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest231">Test Case ID #spring-integration_Test_23_1</h4>
<h4 id="test-case-name-teststaleconnectionfile-cjavaprojectsspringspring-integrationspring-integration-ftpsrctestjavaorgspringframeworkintegrationftpsessionsessionfactorytestsjava">Test Case Name: <code>testStaleConnection</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ftp\src\test\java\org\springframework\integration\ftp\session\SessionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessiona">Mock Object Variable Name: <code>sessionA</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SessionFactory&lt;FTPFile&gt; sessionFactory = Mockito.mock(SessionFactory.class);
<span class="hljs-deletion">-    Session&lt;FTPFile&gt; sessionA = Mockito.mock(Session.class);</span>
<span class="hljs-addition">+    Session&lt;FTPFile&gt; sessionA = createMockSession(true);</span>
    Session&lt;FTPFile&gt; sessionB = Mockito.mock(Session.class);
<span class="hljs-deletion">-    Mockito.when(sessionA.isOpen()).thenReturn(true);</span>
    Mockito.when(sessionB.isOpen()).thenReturn(false);
    Mockito.when(sessionFactory.getSession()).thenReturn(sessionA);
    Mockito.when(sessionFactory.getSession()).thenReturn(sessionB);
    CachingSessionFactory&lt;FTPFile&gt; cachingFactory = new CachingSessionFactory&lt;&gt;(sessionFactory, 2);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testStaleConnection</span><span class="hljs-params">()</span> </span>{

    SessionFactory&lt;FTPFile&gt; sessionFactory = Mockito.mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;FTPFile&gt; sessionA = Mockito.mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;FTPFile&gt; sessionB = Mockito.mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(sessionA.isOpen()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(sessionB.isOpen()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(sessionFactory.getSession()).thenReturn(sessionA);

    Mockito.when(sessionFactory.getSession()).thenReturn(sessionB);

    CachingSessionFactory&lt;FTPFile&gt; cachingFactory = <span class="hljs-keyword">new</span> CachingSessionFactory&lt;&gt;(sessionFactory, <span class="hljs-number">2</span>);

    Session&lt;FTPFile&gt; firstSession = cachingFactory.getSession();

    Session&lt;FTPFile&gt; secondSession = cachingFactory.getSession();

    secondSession.close();

    Session&lt;FTPFile&gt; nonStaleSession = cachingFactory.getSession();

    assertThat(TestUtils.getPropertyValue(nonStaleSession, <span class="hljs-string">"targetSession"</span>)).isEqualTo(TestUtils.getPropertyValue(firstSession, <span class="hljs-string">"targetSession"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session&lt;FTPFile&gt; <span class="hljs-title">createMockSession</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isOpenReturn)</span> </span>{
    Session&lt;FTPFile&gt; session = Mockito.mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(session.isOpen()).thenReturn(isOpenReturn);
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest232">Test Case ID #spring-integration_Test_23_2</h4>
<h4 id="test-case-name-teststaleconnectionfile-cjavaprojectsspringspring-integrationspring-integration-ftpsrctestjavaorgspringframeworkintegrationftpsessionsessionfactorytestsjava">Test Case Name: <code>testStaleConnection</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ftp\src\test\java\org\springframework\integration\ftp\session\SessionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionb">Mock Object Variable Name: <code>sessionB</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SessionFactory&lt;FTPFile&gt; sessionFactory = Mockito.mock(SessionFactory.class);
    Session&lt;FTPFile&gt; sessionA = Mockito.mock(Session.class);
<span class="hljs-deletion">-    Session&lt;FTPFile&gt; sessionB = Mockito.mock(Session.class);</span>
    Mockito.when(sessionA.isOpen()).thenReturn(true);
<span class="hljs-deletion">-    Mockito.when(sessionB.isOpen()).thenReturn(false);</span>
<span class="hljs-addition">+    Session&lt;FTPFile&gt; sessionB = createMockSession(false);</span>
    Mockito.when(sessionFactory.getSession()).thenReturn(sessionA);
    Mockito.when(sessionFactory.getSession()).thenReturn(sessionB);
    CachingSessionFactory&lt;FTPFile&gt; cachingFactory = new CachingSessionFactory&lt;&gt;(sessionFactory, 2);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testStaleConnection</span><span class="hljs-params">()</span> </span>{

    SessionFactory&lt;FTPFile&gt; sessionFactory = Mockito.mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;FTPFile&gt; sessionA = Mockito.mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;FTPFile&gt; sessionB = Mockito.mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(sessionA.isOpen()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(sessionB.isOpen()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(sessionFactory.getSession()).thenReturn(sessionA);

    Mockito.when(sessionFactory.getSession()).thenReturn(sessionB);

    CachingSessionFactory&lt;FTPFile&gt; cachingFactory = <span class="hljs-keyword">new</span> CachingSessionFactory&lt;&gt;(sessionFactory, <span class="hljs-number">2</span>);

    Session&lt;FTPFile&gt; firstSession = cachingFactory.getSession();

    Session&lt;FTPFile&gt; secondSession = cachingFactory.getSession();

    secondSession.close();

    Session&lt;FTPFile&gt; nonStaleSession = cachingFactory.getSession();

    assertThat(TestUtils.getPropertyValue(nonStaleSession, <span class="hljs-string">"targetSession"</span>)).isEqualTo(TestUtils.getPropertyValue(firstSession, <span class="hljs-string">"targetSession"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session&lt;FTPFile&gt; <span class="hljs-title">createMockSession</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isOpenReturn)</span> </span>{
    Session&lt;FTPFile&gt; session = Mockito.mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(session.isOpen()).thenReturn(isOpenReturn);
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci24">Mock Clone Instance #spring-integration_MCI_24</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.core.log.LogAccessor</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> LogAccessor <span class="hljs-title">createMockLogAccessor</span><span class="hljs-params">()</span> </span>{
    LogAccessor logger = mock(LogAccessor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(logger.isInfoEnabled()).thenReturn(<span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> logger;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest241">Test Case ID #spring-integration_Test_24_1</h4>
<h4 id="test-case-name-testexecutorchannelloggingwithmorethenonesubscriberfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationchannelp2pchanneltestsjava">Test Case Name: <code>testExecutorChannelLoggingWithMoreThenOneSubscriber</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\channel\P2pChannelTests.java</code>)</h4>
<h4 id="mock-object-variable-name-logger">Mock Object Variable Name: <code>logger</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    channel.setBeanName("executorChannel");
<span class="hljs-deletion">-    final LogAccessor logger = mock(LogAccessor.class);</span>
<span class="hljs-deletion">-    when(logger.isInfoEnabled()).thenReturn(true);</span>
<span class="hljs-addition">+    final LogAccessor logger = createMockLogAccessor();</span>
    ReflectionUtils.doWithFields(AbstractMessageChannel.class, field -&gt; {
        if ("logger".equals(field.getName())) {
            field.setAccessible(true);
            field.set(channel, logger);
        }
    });
    channel.subscribe(mock(MessageHandler.class));
    channel.subscribe(mock(MessageHandler.class));
    verify(logger, times(2)).info(Mockito.anyString());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testExecutorChannelLoggingWithMoreThenOneSubscriber</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> ExecutorChannel channel = <span class="hljs-keyword">new</span> ExecutorChannel(mock(Executor<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    channel.setBeanName(<span class="hljs-string">"executorChannel"</span>);

    <span class="hljs-keyword">final</span> LogAccessor logger = mock(LogAccessor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(logger.isInfoEnabled()).thenReturn(<span class="hljs-keyword">true</span>);

    ReflectionUtils.doWithFields(AbstractMessageChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">field</span> -&gt; </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-string">"logger"</span>.equals(field.getName())) {

            field.setAccessible(<span class="hljs-keyword">true</span>);

            field.set(channel, logger);

        }

    });

    channel.subscribe(mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    channel.subscribe(mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    verify(logger, times(<span class="hljs-number">2</span>)).info(Mockito.anyString());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> LogAccessor <span class="hljs-title">createMockLogAccessor</span><span class="hljs-params">()</span> </span>{
    LogAccessor logger = mock(LogAccessor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(logger.isInfoEnabled()).thenReturn(<span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> logger;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest242">Test Case ID #spring-integration_Test_24_2</h4>
<h4 id="test-case-name-testpubsubchannelloggingwithmorethenonesubscriberfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationchannelp2pchanneltestsjava">Test Case Name: <code>testPubSubChannelLoggingWithMoreThenOneSubscriber</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\channel\P2pChannelTests.java</code>)</h4>
<h4 id="mock-object-variable-name-logger">Mock Object Variable Name: <code>logger</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     final PublishSubscribeChannel channel = new PublishSubscribeChannel();
     channel.setBeanName("pubSubChannel");
<span class="hljs-deletion">-    final LogAccessor logger = mock(LogAccessor.class);</span>
<span class="hljs-deletion">-    when(logger.isInfoEnabled()).thenReturn(true);</span>
<span class="hljs-addition">+    final LogAccessor logger = createMockLogAccessor();</span>
     ReflectionUtils.doWithFields(AbstractMessageChannel.class, field -&gt; {
         if ("logger".equals(field.getName())) {
             field.setAccessible(true);
             field.set(channel, logger);
         }
     });
     channel.subscribe(mock(MessageHandler.class));
     channel.subscribe(mock(MessageHandler.class));
     verify(logger, times(2)).info(Mockito.anyString());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testPubSubChannelLoggingWithMoreThenOneSubscriber</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> PublishSubscribeChannel channel = <span class="hljs-keyword">new</span> PublishSubscribeChannel();

    channel.setBeanName(<span class="hljs-string">"pubSubChannel"</span>);

    <span class="hljs-keyword">final</span> LogAccessor logger = mock(LogAccessor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(logger.isInfoEnabled()).thenReturn(<span class="hljs-keyword">true</span>);

    ReflectionUtils.doWithFields(AbstractMessageChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">field</span> -&gt; </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-string">"logger"</span>.equals(field.getName())) {

            field.setAccessible(<span class="hljs-keyword">true</span>);

            field.set(channel, logger);

        }

    });

    channel.subscribe(mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    channel.subscribe(mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    verify(logger, times(<span class="hljs-number">2</span>)).info(Mockito.anyString());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> LogAccessor <span class="hljs-title">createMockLogAccessor</span><span class="hljs-params">()</span> </span>{
    LogAccessor logger = mock(LogAccessor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(logger.isInfoEnabled()).thenReturn(<span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> logger;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci25">Mock Clone Instance #spring-integration_MCI_25</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.file.remote.session.SessionFactory&lt;F&gt;</code></li>
<li><strong>Test Case Count</strong>: 5</li>
<li><strong>MO Count</strong>: 5</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;F&gt; <span class="hljs-function">SessionFactory&lt;F&gt; <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session&lt;F&gt; session)</span> </span>{
    SessionFactory&lt;F&gt; sf = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sf.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sf;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest251">Test Case ID #spring-integration_Test_25_1</h4>
<h4 id="test-case-name-testremotedirwithemptystringfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotehandlerfiletransferringmessagehandlertestsjava">Test Case Name: <code>testRemoteDirWithEmptyString</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\handler\FileTransferringMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sf">Mock Object Variable Name: <code>sf</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public &lt;F&gt; void testRemoteDirWithEmptyString() throws Exception {
<span class="hljs-deletion">-    SessionFactory&lt;F&gt; sf = mock(SessionFactory.class);</span>
    Session&lt;F&gt; session = mock(Session.class);
<span class="hljs-deletion">-    when(sf.getSession()).thenReturn(session);</span>
<span class="hljs-addition">+    SessionFactory&lt;F&gt; sf = createMockSessionFactory(session);</span>
    doAnswer(invocation -&gt; {
        String path = invocation.getArgument(1);
        assertThat(path.startsWith("/")).isFalse();
        return null;
    }).when(session).rename(Mockito.anyString(), Mockito.anyString());
    ExpressionParser parser = new SpelExpressionParser();
    FileTransferringMessageHandler&lt;F&gt; handler = new FileTransferringMessageHandler&lt;F&gt;(sf);
    handler.setRemoteDirectoryExpression(parser.parseExpression("''"));
    handler.setBeanFactory(mock(BeanFactory.class));
    handler.afterPropertiesSet();
    handler.handleMessage(new GenericMessage&lt;String&gt;("hello"));
    verify(session, times(1)).write(Mockito.any(InputStream.class), Mockito.anyString());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-keyword">public</span> &lt;F&gt; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRemoteDirWithEmptyString</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory&lt;F&gt; sf = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;F&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(sf.getSession()).thenReturn(session);

    doAnswer(invocation -&gt; {

        String path = invocation.getArgument(<span class="hljs-number">1</span>);

        assertThat(path.startsWith(<span class="hljs-string">"/"</span>)).isFalse();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(session).rename(Mockito.anyString(), Mockito.anyString());

    ExpressionParser parser = <span class="hljs-keyword">new</span> SpelExpressionParser();

    FileTransferringMessageHandler&lt;F&gt; handler = <span class="hljs-keyword">new</span> FileTransferringMessageHandler&lt;F&gt;(sf);

    handler.setRemoteDirectoryExpression(parser.parseExpression(<span class="hljs-string">"''"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    handler.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;String&gt;(<span class="hljs-string">"hello"</span>));

    verify(session, times(<span class="hljs-number">1</span>)).write(Mockito.any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">Mockito</span>.<span class="hljs-title">anyString</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;F&gt; <span class="hljs-function">SessionFactory&lt;F&gt; <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session&lt;F&gt; session)</span> </span>{
    SessionFactory&lt;F&gt; sf = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sf.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sf;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest252">Test Case ID #spring-integration_Test_25_2</h4>
<h4 id="test-case-name-testtemporaryremotedirfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotehandlerfiletransferringmessagehandlertestsjava">Test Case Name: <code>testTemporaryRemoteDir</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\handler\FileTransferringMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sf">Mock Object Variable Name: <code>sf</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @SuppressWarnings("unchecked")
 @Test
 public &lt;F&gt; void testTemporaryRemoteDir() throws Exception {
<span class="hljs-deletion">-    SessionFactory&lt;F&gt; sf = mock(SessionFactory.class);</span>
     Session&lt;F&gt; session = mock(Session.class);
     final AtomicReference&lt;String&gt; temporaryPath = new AtomicReference&lt;String&gt;();
     final AtomicReference&lt;String&gt; finalPath = new AtomicReference&lt;String&gt;();
<span class="hljs-deletion">-    when(sf.getSession()).thenReturn(session);</span>
<span class="hljs-addition">+    SessionFactory&lt;F&gt; sf = createMockSessionFactory(session);</span>
     doAnswer(invocation -&gt; {
         temporaryPath.set(invocation.getArgument(0));
         finalPath.set(invocation.getArgument(1));
         return null;
     }).when(session).rename(Mockito.anyString(), Mockito.anyString());
     FileTransferringMessageHandler&lt;F&gt; handler = new FileTransferringMessageHandler&lt;F&gt;(sf);
     handler.setRemoteDirectoryExpression(new LiteralExpression("foo"));
     handler.setTemporaryRemoteDirectoryExpression(new LiteralExpression("bar"));
     handler.setBeanFactory(mock(BeanFactory.class));
     handler.afterPropertiesSet();
     handler.handleMessage(new GenericMessage&lt;String&gt;("hello"));
     verify(session, times(1)).write(Mockito.any(InputStream.class), Mockito.anyString());
     assertThat(temporaryPath.get().substring(0, 3)).isEqualTo("bar");
     assertThat(finalPath.get().substring(0, 3)).isEqualTo("foo");
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-keyword">public</span> &lt;F&gt; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testTemporaryRemoteDir</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory&lt;F&gt; sf = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;F&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> AtomicReference&lt;String&gt; temporaryPath = <span class="hljs-keyword">new</span> AtomicReference&lt;String&gt;();

    <span class="hljs-keyword">final</span> AtomicReference&lt;String&gt; finalPath = <span class="hljs-keyword">new</span> AtomicReference&lt;String&gt;();

    when(sf.getSession()).thenReturn(session);

    doAnswer(invocation -&gt; {

        temporaryPath.set(invocation.getArgument(<span class="hljs-number">0</span>));

        finalPath.set(invocation.getArgument(<span class="hljs-number">1</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(session).rename(Mockito.anyString(), Mockito.anyString());

    FileTransferringMessageHandler&lt;F&gt; handler = <span class="hljs-keyword">new</span> FileTransferringMessageHandler&lt;F&gt;(sf);

    handler.setRemoteDirectoryExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"foo"</span>));

    handler.setTemporaryRemoteDirectoryExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    handler.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;String&gt;(<span class="hljs-string">"hello"</span>));

    verify(session, times(<span class="hljs-number">1</span>)).write(Mockito.any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">Mockito</span>.<span class="hljs-title">anyString</span>())</span>;

    assertThat(temporaryPath.get().substring(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>)).isEqualTo(<span class="hljs-string">"bar"</span>);

    assertThat(finalPath.get().substring(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>)).isEqualTo(<span class="hljs-string">"foo"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;F&gt; <span class="hljs-function">SessionFactory&lt;F&gt; <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session&lt;F&gt; session)</span> </span>{
    SessionFactory&lt;F&gt; sf = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sf.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sf;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest253">Test Case ID #spring-integration_Test_25_3</h4>
<h4 id="test-case-name-testremotedirwithnullfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotehandlerfiletransferringmessagehandlertestsjava">Test Case Name: <code>testRemoteDirWithNull</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\handler\FileTransferringMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sf">Mock Object Variable Name: <code>sf</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public &lt;F&gt; void testRemoteDirWithNull() throws Exception {
<span class="hljs-deletion">-    SessionFactory&lt;F&gt; sf = mock(SessionFactory.class);</span>
     Session&lt;F&gt; session = mock(Session.class);
<span class="hljs-deletion">-    when(sf.getSession()).thenReturn(session);</span>
<span class="hljs-addition">+    SessionFactory&lt;F&gt; sf = createMockSessionFactory(session);</span>
     doAnswer(invocation -&gt; {
         String path = invocation.getArgument(1);
         assertThat(path.startsWith("/")).isFalse();
         return null;
     }).when(session).rename(Mockito.anyString(), Mockito.anyString());
     ExpressionParser parser = new SpelExpressionParser();
     FileTransferringMessageHandler&lt;F&gt; handler = new FileTransferringMessageHandler&lt;F&gt;(sf);
     handler.setRemoteDirectoryExpression(parser.parseExpression("headers['path']"));
     handler.setBeanFactory(mock(BeanFactory.class));
     handler.afterPropertiesSet();
     Message&lt;?&gt; message = MessageBuilder.withPayload("hello").setHeader("path", null).build();
     handler.handleMessage(message);
     verify(session, times(1)).write(Mockito.any(InputStream.class), Mockito.anyString());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-keyword">public</span> &lt;F&gt; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRemoteDirWithNull</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory&lt;F&gt; sf = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;F&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(sf.getSession()).thenReturn(session);

    doAnswer(invocation -&gt; {

        String path = invocation.getArgument(<span class="hljs-number">1</span>);

        assertThat(path.startsWith(<span class="hljs-string">"/"</span>)).isFalse();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(session).rename(Mockito.anyString(), Mockito.anyString());

    ExpressionParser parser = <span class="hljs-keyword">new</span> SpelExpressionParser();

    FileTransferringMessageHandler&lt;F&gt; handler = <span class="hljs-keyword">new</span> FileTransferringMessageHandler&lt;F&gt;(sf);

    handler.setRemoteDirectoryExpression(parser.parseExpression(<span class="hljs-string">"headers['path']"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    Message&lt;?&gt; message = MessageBuilder.withPayload(<span class="hljs-string">"hello"</span>).setHeader(<span class="hljs-string">"path"</span>, <span class="hljs-keyword">null</span>).build();

    handler.handleMessage(message);

    verify(session, times(<span class="hljs-number">1</span>)).write(Mockito.any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">Mockito</span>.<span class="hljs-title">anyString</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;F&gt; <span class="hljs-function">SessionFactory&lt;F&gt; <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session&lt;F&gt; session)</span> </span>{
    SessionFactory&lt;F&gt; sf = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sf.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sf;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest254">Test Case ID #spring-integration_Test_25_4</h4>
<h4 id="test-case-name-testemptytemporaryfilesuffixcannotbenullfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotehandlerfiletransferringmessagehandlertestsjava">Test Case Name: <code>testEmptyTemporaryFileSuffixCannotBeNull</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\handler\FileTransferringMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sf">Mock Object Variable Name: <code>sf</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @SuppressWarnings("unchecked")
 @Test
 public &lt;F&gt; void testEmptyTemporaryFileSuffixCannotBeNull() throws Exception {
<span class="hljs-deletion">-    SessionFactory&lt;F&gt; sf = mock(SessionFactory.class);</span>
     Session&lt;F&gt; session = mock(Session.class);
<span class="hljs-deletion">-    when(sf.getSession()).thenReturn(session);</span>
<span class="hljs-addition">+    SessionFactory&lt;F&gt; sf = createMockSessionFactory(session);</span>
     FileTransferringMessageHandler&lt;F&gt; handler = new FileTransferringMessageHandler&lt;F&gt;(sf);
     handler.setBeanFactory(mock(BeanFactory.class));
     handler.setRemoteDirectoryExpressionString("headers['path']");
     assertThatIllegalArgumentException().isThrownBy(() -&gt; handler.setTemporaryFileSuffix(null));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-keyword">public</span> &lt;F&gt; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testEmptyTemporaryFileSuffixCannotBeNull</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory&lt;F&gt; sf = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;F&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(sf.getSession()).thenReturn(session);

    FileTransferringMessageHandler&lt;F&gt; handler = <span class="hljs-keyword">new</span> FileTransferringMessageHandler&lt;F&gt;(sf);

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.setRemoteDirectoryExpressionString(<span class="hljs-string">"headers['path']"</span>);

    assertThatIllegalArgumentException().isThrownBy(() -&gt; handler.setTemporaryFileSuffix(<span class="hljs-keyword">null</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;F&gt; <span class="hljs-function">SessionFactory&lt;F&gt; <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session&lt;F&gt; session)</span> </span>{
    SessionFactory&lt;F&gt; sf = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sf.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sf;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest255">Test Case ID #spring-integration_Test_25_5</h4>
<h4 id="test-case-name-testusetemporaryfilenamefalsefile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotehandlerfiletransferringmessagehandlertestsjava">Test Case Name: <code>testUseTemporaryFileNameFalse</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\handler\FileTransferringMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sf">Mock Object Variable Name: <code>sf</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public &lt;F&gt; void testUseTemporaryFileNameFalse() throws Exception {
<span class="hljs-deletion">-    SessionFactory&lt;F&gt; sf = mock(SessionFactory.class);</span>
    Session&lt;F&gt; session = mock(Session.class);
<span class="hljs-deletion">-    when(sf.getSession()).thenReturn(session);</span>
<span class="hljs-addition">+    SessionFactory&lt;F&gt; sf = createMockSessionFactory(session);</span>
    ExpressionParser parser = new SpelExpressionParser();
    FileTransferringMessageHandler&lt;F&gt; handler = new FileTransferringMessageHandler&lt;F&gt;(sf);
    handler.setRemoteDirectoryExpression(parser.parseExpression("headers['path']"));
    handler.setUseTemporaryFileName(false);
    handler.setBeanFactory(mock(BeanFactory.class));
    handler.afterPropertiesSet();
    Message&lt;?&gt; message = MessageBuilder.withPayload("hello").setHeader("path", null).build();
    handler.handleMessage(message);
    verify(session, times(1)).write(Mockito.any(InputStream.class), Mockito.anyString());
    verify(session, times(0)).rename(Mockito.anyString(), Mockito.anyString());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-keyword">public</span> &lt;F&gt; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testUseTemporaryFileNameFalse</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory&lt;F&gt; sf = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;F&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(sf.getSession()).thenReturn(session);

    ExpressionParser parser = <span class="hljs-keyword">new</span> SpelExpressionParser();

    FileTransferringMessageHandler&lt;F&gt; handler = <span class="hljs-keyword">new</span> FileTransferringMessageHandler&lt;F&gt;(sf);

    handler.setRemoteDirectoryExpression(parser.parseExpression(<span class="hljs-string">"headers['path']"</span>));

    handler.setUseTemporaryFileName(<span class="hljs-keyword">false</span>);

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    Message&lt;?&gt; message = MessageBuilder.withPayload(<span class="hljs-string">"hello"</span>).setHeader(<span class="hljs-string">"path"</span>, <span class="hljs-keyword">null</span>).build();

    handler.handleMessage(message);

    verify(session, times(<span class="hljs-number">1</span>)).write(Mockito.any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">Mockito</span>.<span class="hljs-title">anyString</span>())</span>;

    verify(session, times(<span class="hljs-number">0</span>)).rename(Mockito.anyString(), Mockito.anyString());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;F&gt; <span class="hljs-function">SessionFactory&lt;F&gt; <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session&lt;F&gt; session)</span> </span>{
    SessionFactory&lt;F&gt; sf = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sf.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sf;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci26">Mock Clone Instance #spring-integration_MCI_26</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.eclipse.paho.client.mqttv3.MqttAsyncClient</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MqttAsyncClient <span class="hljs-title">createMockMqttAsyncClient</span><span class="hljs-params">(IMqttToken connectToken, IMqttToken subscribeToken)</span> </span>{
    MqttAsyncClient client = mock(MqttAsyncClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(client.isConnected()).willReturn(<span class="hljs-keyword">true</span>);
    willReturn(connectToken).given(client).connect(any(MqttConnectOptions<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    willReturn(subscribeToken).given(client).subscribe(any(String[]<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">int</span>[].<span class="hljs-title">class</span>), <span class="hljs-title">any</span>())</span>;
    <span class="hljs-keyword">return</span> client;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest261">Test Case ID #spring-integration_Test_26_1</h4>
<h4 id="test-case-name-testsubscribefailurefile-cjavaprojectsspringspring-integrationspring-integration-mqttsrctestjavaorgspringframeworkintegrationmqttmqttadaptertestsjava">Test Case Name: <code>testSubscribeFailure</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mqtt\src\test\java\org\springframework\integration\mqtt\MqttAdapterTests.java</code>)</h4>
<h4 id="mock-object-variable-name-client">Mock Object Variable Name: <code>client</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    factory = spy(factory);
<span class="hljs-deletion">-    final MqttAsyncClient client = mock(MqttAsyncClient.class);</span>
<span class="hljs-deletion">-    willReturn(client).given(factory).getAsyncClientInstance(anyString(), anyString());</span>
<span class="hljs-deletion">-    given(client.isConnected()).willReturn(true);</span>
<span class="hljs-deletion">-    willReturn(alwaysComplete).given(client).connect(any(MqttConnectOptions.class));</span>
    IMqttToken token = mock(IMqttToken.class);
    given(token.getGrantedQos()).willReturn(new int[] { 0x80 });
<span class="hljs-deletion">-    willReturn(token).given(client).subscribe(any(String[].class), any(int[].class), any());</span>
<span class="hljs-addition">+    final MqttAsyncClient client = createMockMqttAsyncClient(alwaysComplete, token);</span>
<span class="hljs-addition">+    willReturn(client).given(factory).getAsyncClientInstance(anyString(), anyString());</span>
    MqttPahoMessageDrivenChannelAdapter adapter = new MqttPahoMessageDrivenChannelAdapter("foo", "bar", factory, "baz", "fix");
    AtomicReference&lt;Method&gt; method = new AtomicReference&lt;&gt;();
    ReflectionUtils.doWithMethods(MqttPahoMessageDrivenChannelAdapter.class, m -&gt; {
        m.setAccessible(true);
        method.set(m);
    }, m -&gt; m.getName().equals("connect"));
    assertThat(method.get()).isNotNull();
    method.get().invoke(adapter);
    ReflectionUtils.doWithMethods(MqttPahoMessageDrivenChannelAdapter.class, m -&gt; {
        m.setAccessible(true);
        method.set(m);
    }, m -&gt; m.getName().equals("subscribe"));
    assertThat(method.get()).isNotNull();
    ApplicationEventPublisher eventPublisher = mock(ApplicationEventPublisher.class);
    adapter.setApplicationEventPublisher(eventPublisher);
    method.get().invoke(adapter);
    verify(eventPublisher).publishEvent(any(MqttConnectionFailedEvent.class));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSubscribeFailure</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    DefaultMqttPahoClientFactory factory = <span class="hljs-keyword">new</span> DefaultMqttPahoClientFactory();

    MqttConnectOptions connectOptions = <span class="hljs-keyword">new</span> MqttConnectOptions();

    connectOptions.setCleanSession(<span class="hljs-keyword">false</span>);

    connectOptions.setConnectionTimeout(<span class="hljs-number">23</span>);

    connectOptions.setKeepAliveInterval(<span class="hljs-number">45</span>);

    connectOptions.setPassword(<span class="hljs-string">"pass"</span>.toCharArray());

    MemoryPersistence persistence = <span class="hljs-keyword">new</span> MemoryPersistence();

    factory.setPersistence(persistence);

    <span class="hljs-keyword">final</span> SocketFactory socketFactory = SocketFactory.getDefault();

    connectOptions.setSocketFactory(socketFactory);

    <span class="hljs-keyword">final</span> Properties props = <span class="hljs-keyword">new</span> Properties();

    connectOptions.setSSLProperties(props);

    connectOptions.setUserName(<span class="hljs-string">"user"</span>);

    connectOptions.setWill(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>.getBytes(), <span class="hljs-number">2</span>, <span class="hljs-keyword">true</span>);

    factory = spy(factory);

    <span class="hljs-keyword">final</span> MqttAsyncClient client = mock(MqttAsyncClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(client).given(factory).getAsyncClientInstance(anyString(), anyString());

    given(client.isConnected()).willReturn(<span class="hljs-keyword">true</span>);

    willReturn(alwaysComplete).given(client).connect(any(MqttConnectOptions<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    IMqttToken token = mock(IMqttToken<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(token.getGrantedQos()).willReturn(<span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">0x80</span> });

    willReturn(token).given(client).subscribe(any(String[]<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">int</span>[].<span class="hljs-title">class</span>), <span class="hljs-title">any</span>())</span>;

    MqttPahoMessageDrivenChannelAdapter adapter = <span class="hljs-keyword">new</span> MqttPahoMessageDrivenChannelAdapter(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>, factory, <span class="hljs-string">"baz"</span>, <span class="hljs-string">"fix"</span>);

    AtomicReference&lt;Method&gt; method = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    ReflectionUtils.doWithMethods(MqttPahoMessageDrivenChannelAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">m</span> -&gt; </span>{

        m.setAccessible(<span class="hljs-keyword">true</span>);

        method.set(m);

    }, m -&gt; m.getName().equals(<span class="hljs-string">"connect"</span>));

    assertThat(method.get()).isNotNull();

    method.get().invoke(adapter);

    ReflectionUtils.doWithMethods(MqttPahoMessageDrivenChannelAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">m</span> -&gt; </span>{

        m.setAccessible(<span class="hljs-keyword">true</span>);

        method.set(m);

    }, m -&gt; m.getName().equals(<span class="hljs-string">"subscribe"</span>));

    assertThat(method.get()).isNotNull();

    ApplicationEventPublisher eventPublisher = mock(ApplicationEventPublisher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    adapter.setApplicationEventPublisher(eventPublisher);

    method.get().invoke(adapter);

    verify(eventPublisher).publishEvent(any(MqttConnectionFailedEvent<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MqttAsyncClient <span class="hljs-title">createMockMqttAsyncClient</span><span class="hljs-params">(IMqttToken connectToken, IMqttToken subscribeToken)</span> </span>{
    MqttAsyncClient client = mock(MqttAsyncClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(client.isConnected()).willReturn(<span class="hljs-keyword">true</span>);
    willReturn(connectToken).given(client).connect(any(MqttConnectOptions<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    willReturn(subscribeToken).given(client).subscribe(any(String[]<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">int</span>[].<span class="hljs-title">class</span>), <span class="hljs-title">any</span>())</span>;
    <span class="hljs-keyword">return</span> client;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest262">Test Case ID #spring-integration_Test_26_2</h4>
<h4 id="test-case-name-testdifferentqosfile-cjavaprojectsspringspring-integrationspring-integration-mqttsrctestjavaorgspringframeworkintegrationmqttmqttadaptertestsjava">Test Case Name: <code>testDifferentQos</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mqtt\src\test\java\org\springframework\integration\mqtt\MqttAdapterTests.java</code>)</h4>
<h4 id="mock-object-variable-name-client">Mock Object Variable Name: <code>client</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    factory = spy(factory);
<span class="hljs-deletion">-    final MqttAsyncClient client = mock(MqttAsyncClient.class);</span>
<span class="hljs-deletion">-    willReturn(client).given(factory).getAsyncClientInstance(anyString(), anyString());</span>
<span class="hljs-deletion">-    given(client.isConnected()).willReturn(true);</span>
<span class="hljs-deletion">-    willReturn(alwaysComplete).given(client).connect(any(MqttConnectOptions.class));</span>
    IMqttToken token = mock(IMqttToken.class);
    given(token.getGrantedQos()).willReturn(new int[] { 2, 0 });
<span class="hljs-deletion">-    willReturn(token).given(client).subscribe(any(String[].class), any(int[].class), any());</span>
<span class="hljs-addition">+    final MqttAsyncClient client = createMockMqttAsyncClient(alwaysComplete, token);</span>
<span class="hljs-addition">+    willReturn(client).given(factory).getAsyncClientInstance(anyString(), anyString());</span>
    MqttPahoMessageDrivenChannelAdapter adapter = new MqttPahoMessageDrivenChannelAdapter("tcp://mqtt.host", "bar", factory, "baz", "fix");
    AtomicReference&lt;Method&gt; method = new AtomicReference&lt;&gt;();
    ReflectionUtils.doWithMethods(MqttPahoMessageDrivenChannelAdapter.class, m -&gt; {
        m.setAccessible(true);
        method.set(m);
    }, m -&gt; m.getName().equals("connect"));
    assertThat(method.get()).isNotNull();
    method.get().invoke(adapter);
    ReflectionUtils.doWithMethods(MqttPahoMessageDrivenChannelAdapter.class, m -&gt; {
        m.setAccessible(true);
        method.set(m);
    }, m -&gt; m.getName().equals("subscribe"));
    assertThat(method.get()).isNotNull();
    LogAccessor logger = spy(TestUtils.getPropertyValue(adapter, "logger", LogAccessor.class));
    new DirectFieldAccessor(adapter).setPropertyValue("logger", logger);
    given(logger.isWarnEnabled()).willReturn(true);
    method.get().invoke(adapter);
    verify(logger, atLeastOnce()).warn(ArgumentMatchers.&lt;Supplier&lt;? extends CharSequence&gt;&gt;argThat(logMessage -&gt; logMessage.get().equals("Granted QOS different to Requested QOS; topics: [baz, fix] " + "requested: [1, 1] granted: [2, 0]")));
    new DirectFieldAccessor(adapter).setPropertyValue("running", Boolean.TRUE);
    adapter.stop();
    verify(client).disconnectForcibly(5_000L);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDifferentQos</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    DefaultMqttPahoClientFactory factory = <span class="hljs-keyword">new</span> DefaultMqttPahoClientFactory();

    MqttConnectOptions connectOptions = <span class="hljs-keyword">new</span> MqttConnectOptions();

    connectOptions.setCleanSession(<span class="hljs-keyword">false</span>);

    connectOptions.setConnectionTimeout(<span class="hljs-number">23</span>);

    connectOptions.setKeepAliveInterval(<span class="hljs-number">45</span>);

    connectOptions.setPassword(<span class="hljs-string">"pass"</span>.toCharArray());

    MemoryPersistence persistence = <span class="hljs-keyword">new</span> MemoryPersistence();

    factory.setPersistence(persistence);

    <span class="hljs-keyword">final</span> SocketFactory socketFactory = SocketFactory.getDefault();

    connectOptions.setSocketFactory(socketFactory);

    <span class="hljs-keyword">final</span> Properties props = <span class="hljs-keyword">new</span> Properties();

    connectOptions.setSSLProperties(props);

    connectOptions.setUserName(<span class="hljs-string">"user"</span>);

    connectOptions.setWill(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>.getBytes(), <span class="hljs-number">2</span>, <span class="hljs-keyword">true</span>);

    factory = spy(factory);

    <span class="hljs-keyword">final</span> MqttAsyncClient client = mock(MqttAsyncClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(client).given(factory).getAsyncClientInstance(anyString(), anyString());

    given(client.isConnected()).willReturn(<span class="hljs-keyword">true</span>);

    willReturn(alwaysComplete).given(client).connect(any(MqttConnectOptions<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    IMqttToken token = mock(IMqttToken<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(token.getGrantedQos()).willReturn(<span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">2</span>, <span class="hljs-number">0</span> });

    willReturn(token).given(client).subscribe(any(String[]<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">int</span>[].<span class="hljs-title">class</span>), <span class="hljs-title">any</span>())</span>;

    MqttPahoMessageDrivenChannelAdapter adapter = <span class="hljs-keyword">new</span> MqttPahoMessageDrivenChannelAdapter(<span class="hljs-string">"tcp://mqtt.host"</span>, <span class="hljs-string">"bar"</span>, factory, <span class="hljs-string">"baz"</span>, <span class="hljs-string">"fix"</span>);

    AtomicReference&lt;Method&gt; method = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    ReflectionUtils.doWithMethods(MqttPahoMessageDrivenChannelAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">m</span> -&gt; </span>{

        m.setAccessible(<span class="hljs-keyword">true</span>);

        method.set(m);

    }, m -&gt; m.getName().equals(<span class="hljs-string">"connect"</span>));

    assertThat(method.get()).isNotNull();

    method.get().invoke(adapter);

    ReflectionUtils.doWithMethods(MqttPahoMessageDrivenChannelAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">m</span> -&gt; </span>{

        m.setAccessible(<span class="hljs-keyword">true</span>);

        method.set(m);

    }, m -&gt; m.getName().equals(<span class="hljs-string">"subscribe"</span>));

    assertThat(method.get()).isNotNull();

    LogAccessor logger = spy(TestUtils.getPropertyValue(adapter, <span class="hljs-string">"logger"</span>, LogAccessor<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">new</span> DirectFieldAccessor(adapter).setPropertyValue(<span class="hljs-string">"logger"</span>, logger);

    given(logger.isWarnEnabled()).willReturn(<span class="hljs-keyword">true</span>);

    method.get().invoke(adapter);

    verify(logger, atLeastOnce()).warn(ArgumentMatchers.&lt;Supplier&lt;? extends CharSequence&gt;&gt;argThat(logMessage -&gt; logMessage.get().equals(<span class="hljs-string">"Granted QOS different to Requested QOS; topics: [baz, fix] "</span> + <span class="hljs-string">"requested: [1, 1] granted: [2, 0]"</span>)));

    <span class="hljs-keyword">new</span> DirectFieldAccessor(adapter).setPropertyValue(<span class="hljs-string">"running"</span>, Boolean.TRUE);

    adapter.stop();

    verify(client).disconnectForcibly(<span class="hljs-number">5_000L</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MqttAsyncClient <span class="hljs-title">createMockMqttAsyncClient</span><span class="hljs-params">(IMqttToken connectToken, IMqttToken subscribeToken)</span> </span>{
    MqttAsyncClient client = mock(MqttAsyncClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(client.isConnected()).willReturn(<span class="hljs-keyword">true</span>);
    willReturn(connectToken).given(client).connect(any(MqttConnectOptions<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    willReturn(subscribeToken).given(client).subscribe(any(String[]<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">int</span>[].<span class="hljs-title">class</span>), <span class="hljs-title">any</span>())</span>;
    <span class="hljs-keyword">return</span> client;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci27">Mock Clone Instance #spring-integration_MCI_27</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>javax.net.SocketFactory</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SocketFactory <span class="hljs-title">createMockSocketFactory</span><span class="hljs-params">(Socket socket)</span> </span>{
    SocketFactory factory = Mockito.mock(SocketFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.createSocket()).thenReturn(socket);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest271">Test Case ID #spring-integration_Test_27_1</h4>
<h4 id="test-case-name-testnetclientfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionsocketsupporttestsjava">Test Case Name: <code>testNetClient</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\SocketSupportTests.java</code>)</h4>
<h4 id="mock-object-variable-name-factory">Mock Object Variable Name: <code>factory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport.class);
<span class="hljs-deletion">-    SocketFactory factory = Mockito.mock(SocketFactory.class);</span>
     when(factorySupport.getSocketFactory()).thenReturn(factory);
     Socket socket = mock(Socket.class);
     InputStream is = mock(InputStream.class);
     when(is.read()).thenReturn(-1);
     when(socket.getInputStream()).thenReturn(is);
     InetAddress inetAddress = InetAddress.getLocalHost();
     when(socket.getInetAddress()).thenReturn(inetAddress);
<span class="hljs-deletion">-    when(factory.createSocket()).thenReturn(socket);</span>
<span class="hljs-addition">+    SocketFactory factory = createMockSocketFactory(socket);</span>
     TcpSocketSupport socketSupport = Mockito.mock(TcpSocketSupport.class);
     TcpNetClientConnectionFactory connectionFactory = new TcpNetClientConnectionFactory("x", 0);
     connectionFactory.setTcpSocketFactorySupport(factorySupport);
     connectionFactory.setTcpSocketSupport(socketSupport);
     connectionFactory.start();
     connectionFactory.getConnection();
     verify(socketSupport).postProcessSocket(socket);
     connectionFactory.stop();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNetClient</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketFactory factory = Mockito.mock(SocketFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factorySupport.getSocketFactory()).thenReturn(factory);

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    InputStream is = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(is.read()).thenReturn(-<span class="hljs-number">1</span>);

    when(socket.getInputStream()).thenReturn(is);

    InetAddress inetAddress = InetAddress.getLocalHost();

    when(socket.getInetAddress()).thenReturn(inetAddress);

    when(factory.createSocket()).thenReturn(socket);

    TcpSocketSupport socketSupport = Mockito.mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNetClientConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> TcpNetClientConnectionFactory(<span class="hljs-string">"x"</span>, <span class="hljs-number">0</span>);

    connectionFactory.setTcpSocketFactorySupport(factorySupport);

    connectionFactory.setTcpSocketSupport(socketSupport);

    connectionFactory.start();

    connectionFactory.getConnection();

    verify(socketSupport).postProcessSocket(socket);

    connectionFactory.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SocketFactory <span class="hljs-title">createMockSocketFactory</span><span class="hljs-params">(Socket socket)</span> </span>{
    SocketFactory factory = Mockito.mock(SocketFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.createSocket()).thenReturn(socket);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest272">Test Case ID #spring-integration_Test_27_2</h4>
<h4 id="test-case-name-testnetclientsockettimeoutfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionsocketsupporttestsjava">Test Case Name: <code>testNetClientSocketTimeout</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\SocketSupportTests.java</code>)</h4>
<h4 id="mock-object-variable-name-factory">Mock Object Variable Name: <code>factory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport.class);
<span class="hljs-deletion">-    SocketFactory factory = Mockito.mock(SocketFactory.class);</span>
<span class="hljs-addition">+    SocketFactory factory = createMockSocketFactory(socket);</span>
    when(factorySupport.getSocketFactory()).thenReturn(factory);
    Socket socket = mock(Socket.class);
    InputStream is = mock(InputStream.class);
    when(is.read()).thenReturn(-1);
    when(socket.getInputStream()).thenReturn(is);
    InetAddress inetAddress = InetAddress.getLocalHost();
    when(socket.getInetAddress()).thenReturn(inetAddress);
<span class="hljs-deletion">-    when(factory.createSocket()).thenReturn(socket);</span>
    doThrow(new SocketTimeoutException()).when(socket).connect(any(), eq(1000));
    TcpSocketSupport socketSupport = Mockito.mock(TcpSocketSupport.class);
    TcpNetClientConnectionFactory connectionFactory = new TcpNetClientConnectionFactory("x", 0);
    connectionFactory.setConnectTimeout(1);
    connectionFactory.setTcpSocketFactorySupport(factorySupport);
    connectionFactory.setTcpSocketSupport(socketSupport);
    connectionFactory.start();
    assertThatThrownBy(connectionFactory::getConnection).isInstanceOf(UncheckedIOException.class).hasCauseInstanceOf(SocketTimeoutException.class);
    connectionFactory.stop();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNetClientSocketTimeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketFactory factory = Mockito.mock(SocketFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factorySupport.getSocketFactory()).thenReturn(factory);

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    InputStream is = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(is.read()).thenReturn(-<span class="hljs-number">1</span>);

    when(socket.getInputStream()).thenReturn(is);

    InetAddress inetAddress = InetAddress.getLocalHost();

    when(socket.getInetAddress()).thenReturn(inetAddress);

    when(factory.createSocket()).thenReturn(socket);

    doThrow(<span class="hljs-keyword">new</span> SocketTimeoutException()).when(socket).connect(any(), eq(<span class="hljs-number">1000</span>));

    TcpSocketSupport socketSupport = Mockito.mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNetClientConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> TcpNetClientConnectionFactory(<span class="hljs-string">"x"</span>, <span class="hljs-number">0</span>);

    connectionFactory.setConnectTimeout(<span class="hljs-number">1</span>);

    connectionFactory.setTcpSocketFactorySupport(factorySupport);

    connectionFactory.setTcpSocketSupport(socketSupport);

    connectionFactory.start();

    assertThatThrownBy(connectionFactory::getConnection).isInstanceOf(UncheckedIOException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">hasCauseInstanceOf</span>(<span class="hljs-title">SocketTimeoutException</span>.<span class="hljs-title">class</span>)</span>;

    connectionFactory.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SocketFactory <span class="hljs-title">createMockSocketFactory</span><span class="hljs-params">(Socket socket)</span> </span>{
    SocketFactory factory = Mockito.mock(SocketFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.createSocket()).thenReturn(socket);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci28">Mock Clone Instance #spring-integration_MCI_28</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.messaging.MessageHandler</code></li>
<li><strong>Test Case Count</strong>: 9</li>
<li><strong>MO Count</strong>: 9</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MessageHandler handler;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    handler = mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
handler;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest281">Test Case ID #spring-integration_Test_28_1</h4>
<h4 id="test-case-name-testwithserviceannotatedmethodfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationgatewaygatewayinterfacetestsjava">Test Case Name: <code>testWithServiceAnnotatedMethod</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\gateway\GatewayInterfaceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-handler">Mock Object Variable Name: <code>handler</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testWithServiceAnnotatedMethod() {
     ConfigurableApplicationContext ac = new ClassPathXmlApplicationContext("GatewayInterfaceTests-context.xml", getClass());
     DirectChannel channel = ac.getBean("requestChannelBar", DirectChannel.class);
<span class="hljs-deletion">-    MessageHandler handler = mock(MessageHandler.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `handler`</span>
     channel.subscribe(handler);
     Bar bar = ac.getBean(Bar.class);
     bar.bar("hello");
     verify(handler, times(1)).handleMessage(Mockito.any(Message.class));
     ac.close();
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testWithServiceAnnotatedMethod</span><span class="hljs-params">()</span> </span>{

    ConfigurableApplicationContext ac = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">"GatewayInterfaceTests-context.xml"</span>, getClass());

    DirectChannel channel = ac.getBean(<span class="hljs-string">"requestChannelBar"</span>, DirectChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MessageHandler handler = mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    channel.subscribe(handler);

    Bar bar = ac.getBean(Bar<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    bar.bar(<span class="hljs-string">"hello"</span>);

    verify(handler, times(<span class="hljs-number">1</span>)).handleMessage(Mockito.any(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ac.close();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MessageHandler handler;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    handler = mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
handler;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest282">Test Case ID #spring-integration_Test_28_2</h4>
<h4 id="test-case-name-testwithservicecastassuperclassannotatedmethodfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationgatewaygatewayinterfacetestsjava">Test Case Name: <code>testWithServiceCastAsSuperclassAnnotatedMethod</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\gateway\GatewayInterfaceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-handler">Mock Object Variable Name: <code>handler</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testWithServiceCastAsSuperclassAnnotatedMethod() {
     ConfigurableApplicationContext ac = new ClassPathXmlApplicationContext("GatewayInterfaceTests-context.xml", getClass());
     DirectChannel channel = ac.getBean("requestChannelFoo", DirectChannel.class);
<span class="hljs-deletion">-    MessageHandler handler = mock(MessageHandler.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `handler`</span>
     channel.subscribe(handler);
     Foo foo = ac.getBean(Foo.class);
     foo.foo("hello");
     verify(handler, times(1)).handleMessage(Mockito.any(Message.class));
     ac.close();
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testWithServiceCastAsSuperclassAnnotatedMethod</span><span class="hljs-params">()</span> </span>{

    ConfigurableApplicationContext ac = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">"GatewayInterfaceTests-context.xml"</span>, getClass());

    DirectChannel channel = ac.getBean(<span class="hljs-string">"requestChannelFoo"</span>, DirectChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MessageHandler handler = mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    channel.subscribe(handler);

    Foo foo = ac.getBean(Foo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    foo.foo(<span class="hljs-string">"hello"</span>);

    verify(handler, times(<span class="hljs-number">1</span>)).handleMessage(Mockito.any(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ac.close();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MessageHandler handler;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    handler = mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
handler;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest283">Test Case ID #spring-integration_Test_28_3</h4>
<h4 id="test-case-name-testwithservicecastassuperclassunannotatedmethodfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationgatewaygatewayinterfacetestsjava">Test Case Name: <code>testWithServiceCastAsSuperclassUnAnnotatedMethod</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\gateway\GatewayInterfaceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-handler">Mock Object Variable Name: <code>handler</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testWithServiceCastAsSuperclassUnAnnotatedMethod() {
     ConfigurableApplicationContext ac = new ClassPathXmlApplicationContext("GatewayInterfaceTests-context.xml", getClass());
     DirectChannel channel = ac.getBean("requestChannelBaz", DirectChannel.class);
<span class="hljs-deletion">-    MessageHandler handler = mock(MessageHandler.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `handler`</span>
     channel.subscribe(handler);
     Foo foo = ac.getBean(Foo.class);
     foo.baz("hello");
     verify(handler, times(1)).handleMessage(Mockito.any(Message.class));
     ac.close();
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testWithServiceCastAsSuperclassUnAnnotatedMethod</span><span class="hljs-params">()</span> </span>{

    ConfigurableApplicationContext ac = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">"GatewayInterfaceTests-context.xml"</span>, getClass());

    DirectChannel channel = ac.getBean(<span class="hljs-string">"requestChannelBaz"</span>, DirectChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MessageHandler handler = mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    channel.subscribe(handler);

    Foo foo = ac.getBean(Foo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    foo.baz(<span class="hljs-string">"hello"</span>);

    verify(handler, times(<span class="hljs-number">1</span>)).handleMessage(Mockito.any(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ac.close();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MessageHandler handler;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    handler = mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
handler;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest284">Test Case ID #spring-integration_Test_28_4</h4>
<h4 id="test-case-name-testwithservicehashcodefile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationgatewaygatewayinterfacetestsjava">Test Case Name: <code>testWithServiceHashcode</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\gateway\GatewayInterfaceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-handler">Mock Object Variable Name: <code>handler</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testWithServiceHashcode() {
     ConfigurableApplicationContext ac = new ClassPathXmlApplicationContext("GatewayInterfaceTests-context.xml", getClass());
     DirectChannel channel = ac.getBean("requestChannelBaz", DirectChannel.class);
<span class="hljs-deletion">-    MessageHandler handler = mock(MessageHandler.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `handler`</span>
     channel.subscribe(handler);
     Bar bar = ac.getBean(Bar.class);
     assertThat(ac.getBean(Bar.class).hashCode()).isEqualTo(bar.hashCode());
     verify(handler, times(0)).handleMessage(Mockito.any(Message.class));
     ac.close();
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testWithServiceHashcode</span><span class="hljs-params">()</span> </span>{

    ConfigurableApplicationContext ac = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">"GatewayInterfaceTests-context.xml"</span>, getClass());

    DirectChannel channel = ac.getBean(<span class="hljs-string">"requestChannelBaz"</span>, DirectChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MessageHandler handler = mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    channel.subscribe(handler);

    Bar bar = ac.getBean(Bar<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    assertThat(ac.getBean(Bar<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">hashCode</span>()).<span class="hljs-title">isEqualTo</span>(<span class="hljs-title">bar</span>.<span class="hljs-title">hashCode</span>())</span>;

    verify(handler, times(<span class="hljs-number">0</span>)).handleMessage(Mockito.any(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ac.close();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MessageHandler handler;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    handler = mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
handler;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest285">Test Case ID #spring-integration_Test_28_5</h4>
<h4 id="test-case-name-testwithservicetostringfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationgatewaygatewayinterfacetestsjava">Test Case Name: <code>testWithServiceToString</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\gateway\GatewayInterfaceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-handler">Mock Object Variable Name: <code>handler</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testWithServiceToString() {
     ConfigurableApplicationContext ac = new ClassPathXmlApplicationContext("GatewayInterfaceTests-context.xml", getClass());
     DirectChannel channel = ac.getBean("requestChannelBaz", DirectChannel.class);
<span class="hljs-deletion">-    MessageHandler handler = mock(MessageHandler.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `handler`</span>
     channel.subscribe(handler);
     Bar bar = ac.getBean(Bar.class);
     bar.toString();
<span class="hljs-deletion">-    verify(handler, times(0)).handleMessage(Mockito.any(Message.class));</span>
<span class="hljs-addition">+    verify(handler, times(0)).handleMessage(Mockito.any(Message.class));</span>
     ac.close();
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testWithServiceToString</span><span class="hljs-params">()</span> </span>{

    ConfigurableApplicationContext ac = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">"GatewayInterfaceTests-context.xml"</span>, getClass());

    DirectChannel channel = ac.getBean(<span class="hljs-string">"requestChannelBaz"</span>, DirectChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MessageHandler handler = mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    channel.subscribe(handler);

    Bar bar = ac.getBean(Bar<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    bar.toString();

    verify(handler, times(<span class="hljs-number">0</span>)).handleMessage(Mockito.any(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ac.close();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MessageHandler handler;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    handler = mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
handler;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest286">Test Case ID #spring-integration_Test_28_6</h4>
<h4 id="test-case-name-testwithserviceequalsfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationgatewaygatewayinterfacetestsjava">Test Case Name: <code>testWithServiceEquals</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\gateway\GatewayInterfaceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-handler">Mock Object Variable Name: <code>handler</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testWithServiceEquals() {
     ConfigurableApplicationContext ac = new ClassPathXmlApplicationContext("GatewayInterfaceTests-context.xml", getClass());
     DirectChannel channel = ac.getBean("requestChannelBaz", DirectChannel.class);
<span class="hljs-deletion">-    MessageHandler handler = mock(MessageHandler.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `handler`</span>
     channel.subscribe(handler);
     Bar bar = ac.getBean(Bar.class);
     assertThat(ac.getBean(Bar.class)).isSameAs(bar);
     GatewayProxyFactoryBean&lt;Bar&gt; fb = new GatewayProxyFactoryBean&lt;&gt;(Bar.class);
     DefaultListableBeanFactory bf = new DefaultListableBeanFactory();
     bf.registerSingleton("requestChannelBar", channel);
     bf.registerSingleton("requestChannelBaz", channel);
     bf.registerSingleton("requestChannelFoo", channel);
     fb.setBeanFactory(bf);
     fb.afterPropertiesSet();
     assertThat(fb.getObject()).isNotSameAs(bar);
<span class="hljs-deletion">-    verify(handler, times(0)).handleMessage(Mockito.any(Message.class));</span>
<span class="hljs-addition">+    verify(handler, times(0)).handleMessage(Mockito.any(Message.class));</span>
     ac.close();
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testWithServiceEquals</span><span class="hljs-params">()</span> </span>{

    ConfigurableApplicationContext ac = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">"GatewayInterfaceTests-context.xml"</span>, getClass());

    DirectChannel channel = ac.getBean(<span class="hljs-string">"requestChannelBaz"</span>, DirectChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MessageHandler handler = mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    channel.subscribe(handler);

    Bar bar = ac.getBean(Bar<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    assertThat(ac.getBean(Bar<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">isSameAs</span>(<span class="hljs-title">bar</span>)</span>;

    GatewayProxyFactoryBean&lt;Bar&gt; fb = <span class="hljs-keyword">new</span> GatewayProxyFactoryBean&lt;&gt;(Bar<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DefaultListableBeanFactory bf = <span class="hljs-keyword">new</span> DefaultListableBeanFactory();

    bf.registerSingleton(<span class="hljs-string">"requestChannelBar"</span>, channel);

    bf.registerSingleton(<span class="hljs-string">"requestChannelBaz"</span>, channel);

    bf.registerSingleton(<span class="hljs-string">"requestChannelFoo"</span>, channel);

    fb.setBeanFactory(bf);

    fb.afterPropertiesSet();

    assertThat(fb.getObject()).isNotSameAs(bar);

    verify(handler, times(<span class="hljs-number">0</span>)).handleMessage(Mockito.any(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ac.close();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MessageHandler handler;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    handler = mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
handler;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest287">Test Case ID #spring-integration_Test_28_7</h4>
<h4 id="test-case-name-testwithservicegetclassfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationgatewaygatewayinterfacetestsjava">Test Case Name: <code>testWithServiceGetClass</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\gateway\GatewayInterfaceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-handler">Mock Object Variable Name: <code>handler</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testWithServiceGetClass() {
     ConfigurableApplicationContext ac = new ClassPathXmlApplicationContext("GatewayInterfaceTests-context.xml", getClass());
     DirectChannel channel = ac.getBean("requestChannelBaz", DirectChannel.class);
<span class="hljs-deletion">-    MessageHandler handler = mock(MessageHandler.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `handler`</span>
     channel.subscribe(handler);
     Bar bar = ac.getBean(Bar.class);
     bar.getClass();
<span class="hljs-deletion">-    verify(handler, times(0)).handleMessage(Mockito.any(Message.class));</span>
<span class="hljs-addition">+    verify(handler, times(0)).handleMessage(Mockito.any(Message.class));</span>
     ac.close();
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testWithServiceGetClass</span><span class="hljs-params">()</span> </span>{

    ConfigurableApplicationContext ac = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">"GatewayInterfaceTests-context.xml"</span>, getClass());

    DirectChannel channel = ac.getBean(<span class="hljs-string">"requestChannelBaz"</span>, DirectChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MessageHandler handler = mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    channel.subscribe(handler);

    Bar bar = ac.getBean(Bar<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    bar.getClass();

    verify(handler, times(<span class="hljs-number">0</span>)).handleMessage(Mockito.any(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ac.close();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MessageHandler handler;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    handler = mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
handler;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest288">Test Case ID #spring-integration_Test_28_8</h4>
<h4 id="test-case-name-testignoredheaderfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationgatewaygatewayinterfacetestsjava">Test Case Name: <code>testIgnoredHeader</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\gateway\GatewayInterfaceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-messagehandler">Mock Object Variable Name: <code>messageHandler</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 @SuppressWarnings("unchecked")
 public void testIgnoredHeader() {
<span class="hljs-deletion">-    MessageHandler messageHandler = mock(MessageHandler.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `handler`</span>
     ((SubscribableChannel) this.errorChannel).subscribe(handler);
     this.ignoredHeaderGateway.service("foo", "theHeaderValue");
     ArgumentCaptor&lt;Message&lt;?&gt;&gt; messageArgumentCaptor = ArgumentCaptor.forClass(Message.class);
<span class="hljs-deletion">-    verify(messageHandler).handleMessage(messageArgumentCaptor.capture());</span>
<span class="hljs-addition">+    verify(handler).handleMessage(messageArgumentCaptor.capture());</span>
     Message&lt;?&gt; message = messageArgumentCaptor.getValue();
     assertThat(message.getHeaders().containsKey(IGNORE_HEADER)).isFalse();
<span class="hljs-deletion">-    ((SubscribableChannel) this.errorChannel).unsubscribe(messageHandler);</span>
<span class="hljs-addition">+    ((SubscribableChannel) this.errorChannel).unsubscribe(handler);</span>
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testIgnoredHeader</span><span class="hljs-params">()</span> </span>{

    MessageHandler messageHandler = mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ((SubscribableChannel) <span class="hljs-keyword">this</span>.errorChannel).subscribe(messageHandler);

    <span class="hljs-keyword">this</span>.ignoredHeaderGateway.service(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"theHeaderValue"</span>);

    ArgumentCaptor&lt;Message&lt;?&gt;&gt; messageArgumentCaptor = ArgumentCaptor.forClass(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(messageHandler).handleMessage(messageArgumentCaptor.capture());

    Message&lt;?&gt; message = messageArgumentCaptor.getValue();

    assertThat(message.getHeaders().containsKey(IGNORE_HEADER)).isFalse();

    ((SubscribableChannel) <span class="hljs-keyword">this</span>.errorChannel).unsubscribe(messageHandler);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MessageHandler handler;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    handler = mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
handler;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest289">Test Case ID #spring-integration_Test_28_9</h4>
<h4 id="test-case-name-primarymarkerwinsfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationgatewaygatewayinterfacetestsjava">Test Case Name: <code>primaryMarkerWins</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\gateway\GatewayInterfaceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-messagehandler">Mock Object Variable Name: <code>messageHandler</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 @SuppressWarnings("unchecked")
 void primaryMarkerWins() {
     PrimaryGateway primaryGateway = this.beanFactory.getBean(PrimaryGateway.class);
     assertThat(AopUtils.isAopProxy(primaryGateway)).isTrue();
<span class="hljs-deletion">-    MessageHandler messageHandler = mock(MessageHandler.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `handler`</span>
     ((SubscribableChannel) this.errorChannel).subscribe(handler);
     primaryGateway.testGateway("test data");
     ArgumentCaptor&lt;Message&lt;?&gt;&gt; messageArgumentCaptor = ArgumentCaptor.forClass(Message.class);
<span class="hljs-deletion">-    verify(messageHandler).handleMessage(messageArgumentCaptor.capture());</span>
<span class="hljs-addition">+    verify(handler).handleMessage(messageArgumentCaptor.capture());</span>
     Message&lt;?&gt; receive = messageArgumentCaptor.getValue();
     assertThat(receive).isNotNull().extracting(Message::getPayload).isEqualTo("test data");
     PrimaryGateway notPrimaryGateway = this.beanFactory.getBean("notPrimaryGatewayInstance", PrimaryGateway.class);
     assertThat(AopUtils.isAopProxy(notPrimaryGateway)).isFalse();
<span class="hljs-deletion">-    ((SubscribableChannel) this.errorChannel).unsubscribe(messageHandler);</span>
<span class="hljs-addition">+    ((SubscribableChannel) this.errorChannel).unsubscribe(handler);</span>
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">primaryMarkerWins</span><span class="hljs-params">()</span> </span>{

    PrimaryGateway primaryGateway = <span class="hljs-keyword">this</span>.beanFactory.getBean(PrimaryGateway<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    assertThat(AopUtils.isAopProxy(primaryGateway)).isTrue();

    MessageHandler messageHandler = mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ((SubscribableChannel) <span class="hljs-keyword">this</span>.errorChannel).subscribe(messageHandler);

    primaryGateway.testGateway(<span class="hljs-string">"test data"</span>);

    ArgumentCaptor&lt;Message&lt;?&gt;&gt; messageArgumentCaptor = ArgumentCaptor.forClass(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(messageHandler).handleMessage(messageArgumentCaptor.capture());

    Message&lt;?&gt; receive = messageArgumentCaptor.getValue();

    assertThat(receive).isNotNull().extracting(Message::getPayload).isEqualTo(<span class="hljs-string">"test data"</span>);

    PrimaryGateway notPrimaryGateway = <span class="hljs-keyword">this</span>.beanFactory.getBean(<span class="hljs-string">"notPrimaryGatewayInstance"</span>, PrimaryGateway<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    assertThat(AopUtils.isAopProxy(notPrimaryGateway)).isFalse();

    ((SubscribableChannel) <span class="hljs-keyword">this</span>.errorChannel).unsubscribe(messageHandler);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MessageHandler handler;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    handler = mock(MessageHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
handler;

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci29">Mock Clone Instance #spring-integration_MCI_29</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.ws.SoapHeaderMapper</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> SoapHeaderMapper headerMapper;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    headerMapper = mock(SoapHeaderMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
headerMapper

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest291">Test Case ID #spring-integration_Test_29_1</h4>
<h4 id="test-case-name-marshallingoutboundfile-cjavaprojectsspringspring-integrationspring-integration-wssrctestjavaorgspringframeworkintegrationwsdslwsdsltestsjava">Test Case Name: <code>marshallingOutbound</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ws\src\test\java\org\springframework\integration\ws\dsl\WsDslTests.java</code>)</h4>
<h4 id="mock-object-variable-name-headermapper">Mock Object Variable Name: <code>headerMapper</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void marshallingOutbound() {
     DestinationProvider destinationProvider = mock(DestinationProvider.class);
     Marshaller marshaller = mock(Marshaller.class);
     Unmarshaller unmarshaller = mock(Unmarshaller.class);
     WebServiceMessageFactory messageFactory = mock(WebServiceMessageFactory.class);
     FaultMessageResolver faultMessageResolver = mock(FaultMessageResolver.class);
<span class="hljs-deletion">-    SoapHeaderMapper headerMapper = mock(SoapHeaderMapper.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `headerMapper`</span>
     ClientInterceptor interceptor = mock(ClientInterceptor.class);
     WebServiceMessageSender messageSender = mock(WebServiceMessageSender.class);
     WebServiceMessageCallback requestCallback = msg -&gt; {
     };
     Map&lt;String, Expression&gt; uriVariableExpressions = new HashMap&lt;&gt;();
     uriVariableExpressions.put("foo", new LiteralExpression("bar"));
     MarshallingWebServiceOutboundGateway gateway = Ws.marshallingOutboundGateway().destinationProvider(destinationProvider).marshaller(marshaller).unmarshaller(unmarshaller).messageFactory(messageFactory).faultMessageResolver(faultMessageResolver).headerMapper(headerMapper).ignoreEmptyResponses(true).interceptors(interceptor).messageSenders(messageSender).requestCallback(requestCallback).uriVariableExpressions(uriVariableExpressions).getObject();
     assertThat(TestUtils.getPropertyValue(gateway, "webServiceTemplate.marshaller")).isSameAs(marshaller);
     assertThat(TestUtils.getPropertyValue(gateway, "webServiceTemplate.unmarshaller")).isSameAs(unmarshaller);
     assertThat(TestUtils.getPropertyValue(gateway, "webServiceTemplate.messageFactory")).isSameAs(messageFactory);
     assertThat(TestUtils.getPropertyValue(gateway, "webServiceTemplate.faultMessageResolver")).isSameAs(faultMessageResolver);
     assertThat(TestUtils.getPropertyValue(gateway, "headerMapper")).isSameAs(headerMapper);
     assertThat(TestUtils.getPropertyValue(gateway, "webServiceTemplate.interceptors", ClientInterceptor[].class)[0]).isSameAs(interceptor);
     assertThat(TestUtils.getPropertyValue(gateway, "webServiceTemplate.messageSenders", WebServiceMessageSender[].class)[0]).isSameAs(messageSender);
     assertThat(TestUtils.getPropertyValue(gateway, "requestCallback")).isSameAs(requestCallback);
     assertThat(TestUtils.getPropertyValue(gateway, "uriVariableExpressions")).isEqualTo(uriVariableExpressions);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">marshallingOutbound</span><span class="hljs-params">()</span> </span>{

    DestinationProvider destinationProvider = mock(DestinationProvider<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Marshaller marshaller = mock(Marshaller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Unmarshaller unmarshaller = mock(Unmarshaller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    WebServiceMessageFactory messageFactory = mock(WebServiceMessageFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    FaultMessageResolver faultMessageResolver = mock(FaultMessageResolver<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SoapHeaderMapper headerMapper = mock(SoapHeaderMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClientInterceptor interceptor = mock(ClientInterceptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    WebServiceMessageSender messageSender = mock(WebServiceMessageSender<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    WebServiceMessageCallback requestCallback = msg -&gt; {

    };

    Map&lt;String, Expression&gt; uriVariableExpressions = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    uriVariableExpressions.put(<span class="hljs-string">"foo"</span>, <span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    MarshallingWebServiceOutboundGateway gateway = Ws.marshallingOutboundGateway().destinationProvider(destinationProvider).marshaller(marshaller).unmarshaller(unmarshaller).messageFactory(messageFactory).faultMessageResolver(faultMessageResolver).headerMapper(headerMapper).ignoreEmptyResponses(<span class="hljs-keyword">true</span>).interceptors(interceptor).messageSenders(messageSender).requestCallback(requestCallback).uriVariableExpressions(uriVariableExpressions).getObject();

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"webServiceTemplate.marshaller"</span>)).isSameAs(marshaller);

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"webServiceTemplate.unmarshaller"</span>)).isSameAs(unmarshaller);

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"webServiceTemplate.messageFactory"</span>)).isSameAs(messageFactory);

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"webServiceTemplate.faultMessageResolver"</span>)).isSameAs(faultMessageResolver);

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"headerMapper"</span>)).isSameAs(headerMapper);

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"webServiceTemplate.interceptors"</span>, ClientInterceptor[]<span class="hljs-class">.<span class="hljs-keyword">class</span>)[0]).<span class="hljs-title">isSameAs</span>(<span class="hljs-title">interceptor</span>)</span>;

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"webServiceTemplate.messageSenders"</span>, WebServiceMessageSender[]<span class="hljs-class">.<span class="hljs-keyword">class</span>)[0]).<span class="hljs-title">isSameAs</span>(<span class="hljs-title">messageSender</span>)</span>;

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"requestCallback"</span>)).isSameAs(requestCallback);

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"uriVariableExpressions"</span>)).isEqualTo(uriVariableExpressions);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> SoapHeaderMapper headerMapper;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    headerMapper = mock(SoapHeaderMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
headerMapper

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest292">Test Case ID #spring-integration_Test_29_2</h4>
<h4 id="test-case-name-simpleoutboundfile-cjavaprojectsspringspring-integrationspring-integration-wssrctestjavaorgspringframeworkintegrationwsdslwsdsltestsjava">Test Case Name: <code>simpleOutbound</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ws\src\test\java\org\springframework\integration\ws\dsl\WsDslTests.java</code>)</h4>
<h4 id="mock-object-variable-name-headermapper">Mock Object Variable Name: <code>headerMapper</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void simpleOutbound() {
     DestinationProvider destinationProvider = mock(DestinationProvider.class);
     WebServiceMessageFactory messageFactory = mock(WebServiceMessageFactory.class);
     FaultMessageResolver faultMessageResolver = mock(FaultMessageResolver.class);
<span class="hljs-deletion">-    SoapHeaderMapper headerMapper = mock(SoapHeaderMapper.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `headerMapper`</span>
     ClientInterceptor interceptor = mock(ClientInterceptor.class);
     WebServiceMessageSender messageSender = mock(WebServiceMessageSender.class);
     WebServiceMessageCallback requestCallback = msg -&gt; {
     };
     Map&lt;String, Expression&gt; uriVariableExpressions = new HashMap&lt;&gt;();
     uriVariableExpressions.put("foo", new LiteralExpression("bar"));
     SourceExtractor&lt;?&gt; sourceExtractor = mock(SourceExtractor.class);
     SimpleWebServiceOutboundGateway gateway = Ws.simpleOutboundGateway()
         .destinationProvider(destinationProvider)
         .sourceExtractor(sourceExtractor)
         .messageFactory(messageFactory)
         .encodingMode(DefaultUriBuilderFactory.EncodingMode.VALUES_ONLY)
         .faultMessageResolver(faultMessageResolver)
<span class="hljs-deletion">-        .headerMapper(headerMapper)</span>
<span class="hljs-addition">+        .headerMapper(headerMapper)</span>
         .ignoreEmptyResponses(true)
         .interceptors(interceptor)
         .messageSenders(messageSender)
         .requestCallback(requestCallback)
         .uriVariableExpressions(uriVariableExpressions)
         .extractPayload(false)
         .getObject();
     assertThat(TestUtils.getPropertyValue(gateway, "webServiceTemplate.messageFactory")).isSameAs(messageFactory);
     assertThat(TestUtils.getPropertyValue(gateway, "webServiceTemplate.faultMessageResolver")).isSameAs(faultMessageResolver);
<span class="hljs-deletion">-    assertThat(TestUtils.getPropertyValue(gateway, "headerMapper")).isSameAs(headerMapper);</span>
<span class="hljs-addition">+    assertThat(TestUtils.getPropertyValue(gateway, "headerMapper")).isSameAs(headerMapper);</span>
     assertThat(TestUtils.getPropertyValue(gateway, "webServiceTemplate.interceptors", ClientInterceptor[].class)[0]).isSameAs(interceptor);
     assertThat(TestUtils.getPropertyValue(gateway, "webServiceTemplate.messageSenders", WebServiceMessageSender[].class)[0]).isSameAs(messageSender);
     assertThat(TestUtils.getPropertyValue(gateway, "requestCallback")).isSameAs(requestCallback);
     assertThat(TestUtils.getPropertyValue(gateway, "uriVariableExpressions")).isEqualTo(uriVariableExpressions);
     assertThat(TestUtils.getPropertyValue(gateway, "extractPayload", Boolean.class)).isFalse();
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">simpleOutbound</span><span class="hljs-params">()</span> </span>{

    DestinationProvider destinationProvider = mock(DestinationProvider<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    WebServiceMessageFactory messageFactory = mock(WebServiceMessageFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    FaultMessageResolver faultMessageResolver = mock(FaultMessageResolver<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SoapHeaderMapper headerMapper = mock(SoapHeaderMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClientInterceptor interceptor = mock(ClientInterceptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    WebServiceMessageSender messageSender = mock(WebServiceMessageSender<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    WebServiceMessageCallback requestCallback = msg -&gt; {

    };

    Map&lt;String, Expression&gt; uriVariableExpressions = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    uriVariableExpressions.put(<span class="hljs-string">"foo"</span>, <span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    SourceExtractor&lt;?&gt; sourceExtractor = mock(SourceExtractor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SimpleWebServiceOutboundGateway gateway = Ws.simpleOutboundGateway().destinationProvider(destinationProvider).sourceExtractor(sourceExtractor).messageFactory(messageFactory).encodingMode(DefaultUriBuilderFactory.EncodingMode.VALUES_ONLY).faultMessageResolver(faultMessageResolver).headerMapper(headerMapper).ignoreEmptyResponses(<span class="hljs-keyword">true</span>).interceptors(interceptor).messageSenders(messageSender).requestCallback(requestCallback).uriVariableExpressions(uriVariableExpressions).extractPayload(<span class="hljs-keyword">false</span>).getObject();

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"webServiceTemplate.messageFactory"</span>)).isSameAs(messageFactory);

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"webServiceTemplate.faultMessageResolver"</span>)).isSameAs(faultMessageResolver);

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"headerMapper"</span>)).isSameAs(headerMapper);

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"webServiceTemplate.interceptors"</span>, ClientInterceptor[]<span class="hljs-class">.<span class="hljs-keyword">class</span>)[0]).<span class="hljs-title">isSameAs</span>(<span class="hljs-title">interceptor</span>)</span>;

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"webServiceTemplate.messageSenders"</span>, WebServiceMessageSender[]<span class="hljs-class">.<span class="hljs-keyword">class</span>)[0]).<span class="hljs-title">isSameAs</span>(<span class="hljs-title">messageSender</span>)</span>;

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"requestCallback"</span>)).isSameAs(requestCallback);

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"uriVariableExpressions"</span>)).isEqualTo(uriVariableExpressions);

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"extractPayload"</span>, Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">isFalse</span>()</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> SoapHeaderMapper headerMapper;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    headerMapper = mock(SoapHeaderMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
headerMapper

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest293">Test Case ID #spring-integration_Test_29_3</h4>
<h4 id="test-case-name-marshallingoutboundtemplatefile-cjavaprojectsspringspring-integrationspring-integration-wssrctestjavaorgspringframeworkintegrationwsdslwsdsltestsjava">Test Case Name: <code>marshallingOutboundTemplate</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ws\src\test\java\org\springframework\integration\ws\dsl\WsDslTests.java</code>)</h4>
<h4 id="mock-object-variable-name-headermapper">Mock Object Variable Name: <code>headerMapper</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void marshallingOutboundTemplate() {
<span class="hljs-deletion">-    SoapHeaderMapper headerMapper = mock(SoapHeaderMapper.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `headerMapper`</span>
     WebServiceMessageCallback requestCallback = msg -&gt; {
     };
     Map&lt;String, Expression&gt; uriVariableExpressions = new HashMap&lt;&gt;();
     uriVariableExpressions.put("foo", new LiteralExpression("bar"));
     WebServiceTemplate template = mock(WebServiceTemplate.class);
     String uri = "foo";
     MarshallingWebServiceOutboundGateway gateway = Ws.marshallingOutboundGateway(template).uri(uri).headerMapper(headerMapper).ignoreEmptyResponses(true).requestCallback(requestCallback).uriVariableExpressions(uriVariableExpressions).getObject();
     assertThat(TestUtils.getPropertyValue(gateway, "uri")).isSameAs(uri);
     assertThat(TestUtils.getPropertyValue(gateway, "headerMapper")).isSameAs(headerMapper);
     assertThat(TestUtils.getPropertyValue(gateway, "requestCallback")).isSameAs(requestCallback);
     assertThat(TestUtils.getPropertyValue(gateway, "uriVariableExpressions")).isEqualTo(uriVariableExpressions);
     assertThat(TestUtils.getPropertyValue(gateway, "uriFactory.encodingMode", DefaultUriBuilderFactory.EncodingMode.class)).isEqualTo(DefaultUriBuilderFactory.EncodingMode.TEMPLATE_AND_VALUES);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">marshallingOutboundTemplate</span><span class="hljs-params">()</span> </span>{

    SoapHeaderMapper headerMapper = mock(SoapHeaderMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    WebServiceMessageCallback requestCallback = msg -&gt; {

    };

    Map&lt;String, Expression&gt; uriVariableExpressions = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    uriVariableExpressions.put(<span class="hljs-string">"foo"</span>, <span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    WebServiceTemplate template = mock(WebServiceTemplate<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    String uri = <span class="hljs-string">"foo"</span>;

    MarshallingWebServiceOutboundGateway gateway = Ws.marshallingOutboundGateway(template).uri(uri).headerMapper(headerMapper).ignoreEmptyResponses(<span class="hljs-keyword">true</span>).requestCallback(requestCallback).uriVariableExpressions(uriVariableExpressions).getObject();

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"uri"</span>)).isSameAs(uri);

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"headerMapper"</span>)).isSameAs(headerMapper);

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"requestCallback"</span>)).isSameAs(requestCallback);

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"uriVariableExpressions"</span>)).isEqualTo(uriVariableExpressions);

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"uriFactory.encodingMode"</span>, DefaultUriBuilderFactory.EncodingMode<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">isEqualTo</span>(<span class="hljs-title">DefaultUriBuilderFactory</span>.<span class="hljs-title">EncodingMode</span>.<span class="hljs-title">TEMPLATE_AND_VALUES</span>)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> SoapHeaderMapper headerMapper;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    headerMapper = mock(SoapHeaderMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
headerMapper

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest294">Test Case ID #spring-integration_Test_29_4</h4>
<h4 id="test-case-name-simpleoutboundtemplatefile-cjavaprojectsspringspring-integrationspring-integration-wssrctestjavaorgspringframeworkintegrationwsdslwsdsltestsjava">Test Case Name: <code>simpleOutboundTemplate</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ws\src\test\java\org\springframework\integration\ws\dsl\WsDslTests.java</code>)</h4>
<h4 id="mock-object-variable-name-headermapper">Mock Object Variable Name: <code>headerMapper</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void simpleOutboundTemplate() {
<span class="hljs-deletion">-    SoapHeaderMapper headerMapper = mock(SoapHeaderMapper.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `headerMapper`</span>
     WebServiceMessageCallback requestCallback = msg -&gt; {
     };
     Map&lt;String, Expression&gt; uriVariableExpressions = new HashMap&lt;&gt;();
     uriVariableExpressions.put("foo", new LiteralExpression("bar"));
     SourceExtractor&lt;?&gt; sourceExtractor = mock(SourceExtractor.class);
     WebServiceTemplate template = mock(WebServiceTemplate.class);
     String uri = "foo";
     SimpleWebServiceOutboundGateway gateway = Ws.simpleOutboundGateway(template).uri(uri).sourceExtractor(sourceExtractor).encodingMode(DefaultUriBuilderFactory.EncodingMode.VALUES_ONLY).headerMapper(headerMapper).ignoreEmptyResponses(true).requestCallback(requestCallback).uriVariableExpressions(uriVariableExpressions).extractPayload(false).getObject();
     assertThat(TestUtils.getPropertyValue(gateway, "headerMapper")).isSameAs(headerMapper);
     assertThat(TestUtils.getPropertyValue(gateway, "requestCallback")).isSameAs(requestCallback);
     assertThat(TestUtils.getPropertyValue(gateway, "uriVariableExpressions")).isEqualTo(uriVariableExpressions);
     assertThat(TestUtils.getPropertyValue(gateway, "extractPayload", Boolean.class)).isFalse();
     assertThat(TestUtils.getPropertyValue(gateway, "uriFactory.encodingMode", DefaultUriBuilderFactory.EncodingMode.class)).isEqualTo(DefaultUriBuilderFactory.EncodingMode.VALUES_ONLY);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">simpleOutboundTemplate</span><span class="hljs-params">()</span> </span>{

    SoapHeaderMapper headerMapper = mock(SoapHeaderMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    WebServiceMessageCallback requestCallback = msg -&gt; {

    };

    Map&lt;String, Expression&gt; uriVariableExpressions = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    uriVariableExpressions.put(<span class="hljs-string">"foo"</span>, <span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    SourceExtractor&lt;?&gt; sourceExtractor = mock(SourceExtractor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    WebServiceTemplate template = mock(WebServiceTemplate<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    String uri = <span class="hljs-string">"foo"</span>;

    SimpleWebServiceOutboundGateway gateway = Ws.simpleOutboundGateway(template).uri(uri).sourceExtractor(sourceExtractor).encodingMode(DefaultUriBuilderFactory.EncodingMode.VALUES_ONLY).headerMapper(headerMapper).ignoreEmptyResponses(<span class="hljs-keyword">true</span>).requestCallback(requestCallback).uriVariableExpressions(uriVariableExpressions).extractPayload(<span class="hljs-keyword">false</span>).getObject();

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"headerMapper"</span>)).isSameAs(headerMapper);

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"requestCallback"</span>)).isSameAs(requestCallback);

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"uriVariableExpressions"</span>)).isEqualTo(uriVariableExpressions);

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"extractPayload"</span>, Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">isFalse</span>()</span>;

    assertThat(TestUtils.getPropertyValue(gateway, <span class="hljs-string">"uriFactory.encodingMode"</span>, DefaultUriBuilderFactory.EncodingMode<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">isEqualTo</span>(<span class="hljs-title">DefaultUriBuilderFactory</span>.<span class="hljs-title">EncodingMode</span>.<span class="hljs-title">VALUES_ONLY</span>)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> SoapHeaderMapper headerMapper;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    headerMapper = mock(SoapHeaderMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
headerMapper

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci30">Mock Clone Instance #spring-integration_MCI_30</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.file.remote.session.SessionFactory&lt;org.apache.commons.net.ftp.FTPFile&gt;</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory&lt;FTPFile&gt; <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session&lt;FTPFile&gt; sessionToReturn)</span> </span>{
    SessionFactory&lt;FTPFile&gt; sessionFactory = Mockito.mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(sessionFactory.getSession()).thenReturn(sessionToReturn);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest301">Test Case ID #spring-integration_Test_30_1</h4>
<h4 id="test-case-name-teststaleconnectionfile-cjavaprojectsspringspring-integrationspring-integration-ftpsrctestjavaorgspringframeworkintegrationftpsessionsessionfactorytestsjava">Test Case Name: <code>testStaleConnection</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ftp\src\test\java\org\springframework\integration\ftp\session\SessionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 void testStaleConnection() {
<span class="hljs-deletion">-    SessionFactory&lt;FTPFile&gt; sessionFactory = Mockito.mock(SessionFactory.class);</span>
     Session&lt;FTPFile&gt; sessionA = Mockito.mock(Session.class);
     Session&lt;FTPFile&gt; sessionB = Mockito.mock(Session.class);
     Mockito.when(sessionA.isOpen()).thenReturn(true);
     Mockito.when(sessionB.isOpen()).thenReturn(false);
<span class="hljs-addition">+    SessionFactory&lt;FTPFile&gt; sessionFactory = createMockSessionFactory(sessionA);</span>
     Mockito.when(sessionFactory.getSession()).thenReturn(sessionB);
     CachingSessionFactory&lt;FTPFile&gt; cachingFactory = new CachingSessionFactory&lt;&gt;(sessionFactory, 2);
     Session&lt;FTPFile&gt; firstSession = cachingFactory.getSession();
     Session&lt;FTPFile&gt; secondSession = cachingFactory.getSession();
     secondSession.close();
     Session&lt;FTPFile&gt; nonStaleSession = cachingFactory.getSession();
     assertThat(TestUtils.getPropertyValue(nonStaleSession, "targetSession")).isEqualTo(TestUtils.getPropertyValue(firstSession, "targetSession"));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testStaleConnection</span><span class="hljs-params">()</span> </span>{

    SessionFactory&lt;FTPFile&gt; sessionFactory = Mockito.mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;FTPFile&gt; sessionA = Mockito.mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;FTPFile&gt; sessionB = Mockito.mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(sessionA.isOpen()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(sessionB.isOpen()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(sessionFactory.getSession()).thenReturn(sessionA);

    Mockito.when(sessionFactory.getSession()).thenReturn(sessionB);

    CachingSessionFactory&lt;FTPFile&gt; cachingFactory = <span class="hljs-keyword">new</span> CachingSessionFactory&lt;&gt;(sessionFactory, <span class="hljs-number">2</span>);

    Session&lt;FTPFile&gt; firstSession = cachingFactory.getSession();

    Session&lt;FTPFile&gt; secondSession = cachingFactory.getSession();

    secondSession.close();

    Session&lt;FTPFile&gt; nonStaleSession = cachingFactory.getSession();

    assertThat(TestUtils.getPropertyValue(nonStaleSession, <span class="hljs-string">"targetSession"</span>)).isEqualTo(TestUtils.getPropertyValue(firstSession, <span class="hljs-string">"targetSession"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory&lt;FTPFile&gt; <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session&lt;FTPFile&gt; sessionToReturn)</span> </span>{
    SessionFactory&lt;FTPFile&gt; sessionFactory = Mockito.mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(sessionFactory.getSession()).thenReturn(sessionToReturn);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest302">Test Case ID #spring-integration_Test_30_2</h4>
<h4 id="test-case-name-testsamesessionfromthepoolfile-cjavaprojectsspringspring-integrationspring-integration-ftpsrctestjavaorgspringframeworkintegrationftpsessionsessionfactorytestsjava">Test Case Name: <code>testSameSessionFromThePool</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ftp\src\test\java\org\springframework\integration\ftp\session\SessionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testSameSessionFromThePool() {
<span class="hljs-deletion">-    SessionFactory&lt;FTPFile&gt; sessionFactory = Mockito.mock(SessionFactory.class);</span>
     Session&lt;FTPFile&gt; session = Mockito.mock(Session.class);
<span class="hljs-deletion">-    Mockito.when(sessionFactory.getSession()).thenReturn(session);</span>
<span class="hljs-addition">+    SessionFactory&lt;FTPFile&gt; sessionFactory = createMockSessionFactory(session);</span>
     CachingSessionFactory&lt;FTPFile&gt; cachingFactory = new CachingSessionFactory&lt;&gt;(sessionFactory, 2);
     Session&lt;FTPFile&gt; s1 = cachingFactory.getSession();
     s1.close();
     Session&lt;FTPFile&gt; s2 = cachingFactory.getSession();
     s2.close();
     assertThat(TestUtils.getPropertyValue(s2, "targetSession")).isEqualTo(TestUtils.getPropertyValue(s1, "targetSession"));
     Mockito.verify(sessionFactory, Mockito.times(2)).getSession();
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testSameSessionFromThePool</span><span class="hljs-params">()</span> </span>{

    SessionFactory&lt;FTPFile&gt; sessionFactory = Mockito.mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;FTPFile&gt; session = Mockito.mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(sessionFactory.getSession()).thenReturn(session);

    CachingSessionFactory&lt;FTPFile&gt; cachingFactory = <span class="hljs-keyword">new</span> CachingSessionFactory&lt;&gt;(sessionFactory, <span class="hljs-number">2</span>);

    Session&lt;FTPFile&gt; s1 = cachingFactory.getSession();

    s1.close();

    Session&lt;FTPFile&gt; s2 = cachingFactory.getSession();

    s2.close();

    assertThat(TestUtils.getPropertyValue(s2, <span class="hljs-string">"targetSession"</span>)).isEqualTo(TestUtils.getPropertyValue(s1, <span class="hljs-string">"targetSession"</span>));

    Mockito.verify(sessionFactory, Mockito.times(<span class="hljs-number">2</span>)).getSession();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory&lt;FTPFile&gt; <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session&lt;FTPFile&gt; sessionToReturn)</span> </span>{
    SessionFactory&lt;FTPFile&gt; sessionFactory = Mockito.mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(sessionFactory.getSession()).thenReturn(sessionToReturn);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest303">Test Case ID #spring-integration_Test_30_3</h4>
<h4 id="test-case-name-testsessionwaitexpirefile-cjavaprojectsspringspring-integrationspring-integration-ftpsrctestjavaorgspringframeworkintegrationftpsessionsessionfactorytestsjava">Test Case Name: <code>testSessionWaitExpire</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ftp\src\test\java\org\springframework\integration\ftp\session\SessionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testSessionWaitExpire() {
<span class="hljs-deletion">-    SessionFactory&lt;FTPFile&gt; sessionFactory = Mockito.mock(SessionFactory.class);</span>
    Session&lt;FTPFile&gt; session = Mockito.mock(Session.class);
<span class="hljs-deletion">-    Mockito.when(sessionFactory.getSession()).thenReturn(session);</span>
<span class="hljs-addition">+    SessionFactory&lt;FTPFile&gt; sessionFactory = createMockSessionFactory(session);</span>
    CachingSessionFactory&lt;FTPFile&gt; cachingFactory = new CachingSessionFactory&lt;&gt;(sessionFactory, 2);
    cachingFactory.setSessionWaitTimeout(3000);
    cachingFactory.getSession();
    cachingFactory.getSession();
    // timeout expire
    assertThatExceptionOfType(PoolItemNotAvailableException.class).isThrownBy(cachingFactory::getSession);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testSessionWaitExpire</span><span class="hljs-params">()</span> </span>{

    SessionFactory&lt;FTPFile&gt; sessionFactory = Mockito.mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;FTPFile&gt; session = Mockito.mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(sessionFactory.getSession()).thenReturn(session);

    CachingSessionFactory&lt;FTPFile&gt; cachingFactory = <span class="hljs-keyword">new</span> CachingSessionFactory&lt;&gt;(sessionFactory, <span class="hljs-number">2</span>);

    cachingFactory.setSessionWaitTimeout(<span class="hljs-number">3000</span>);

    cachingFactory.getSession();

    cachingFactory.getSession();

    <span class="hljs-comment">// timeout expire</span>

    assertThatExceptionOfType(PoolItemNotAvailableException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(<span class="hljs-title">cachingFactory</span>::<span class="hljs-title">getSession</span>)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory&lt;FTPFile&gt; <span class="hljs-title">createMockSessionFactory</span><span class="hljs-params">(Session&lt;FTPFile&gt; sessionToReturn)</span> </span>{
    SessionFactory&lt;FTPFile&gt; sessionFactory = Mockito.mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(sessionFactory.getSession()).thenReturn(sessionToReturn);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci31">Mock Clone Instance #spring-integration_MCI_31</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.rabbitmq.client.Channel</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Channel <span class="hljs-title">createMockChannel</span><span class="hljs-params">(GetResponse getResponse)</span> </span>{
    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(<span class="hljs-keyword">true</span>).given(channel).isOpen();
    willReturn(getResponse).given(channel).basicGet(<span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>);
    <span class="hljs-keyword">return</span> channel;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest311">Test Case ID #spring-integration_Test_31_1</h4>
<h4 id="test-case-name-testackfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpinboundamqpmessagesourcetestsjava">Test Case Name: <code>testAck</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\inbound\AmqpMessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-channel">Mock Object Variable Name: <code>channel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testAck() throws Exception {
<span class="hljs-deletion">-    Channel channel = mock(Channel.class);</span>
<span class="hljs-deletion">-    willReturn(true).given(channel).isOpen();</span>
    Envelope envelope = new Envelope(123L, false, "ex", "rk");
    BasicProperties props = new BasicProperties.Builder().contentType(MessageProperties.DEFAULT_CONTENT_TYPE).build();
    GetResponse getResponse = new GetResponse(envelope, props, "bar".getBytes(), 0);
<span class="hljs-addition">+    Channel channel = createMockChannel(getResponse);</span>
    Connection connection = mock(Connection.class);
    willReturn(true).given(connection).isOpen();
    willReturn(channel).given(connection).createChannel();
    ConnectionFactory connectionFactory = mock(ConnectionFactory.class);
    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());
    CachingConnectionFactory ccf = new CachingConnectionFactory(connectionFactory);
    AmqpMessageSource source = new AmqpMessageSource(ccf, "foo");
    source.setRawMessageHeader(true);
    Message&lt;?&gt; received = source.receive();
    assertThat(received.getHeaders().get(AmqpMessageHeaderErrorMessageStrategy.AMQP_RAW_MESSAGE)).isInstanceOf(org.springframework.amqp.core.Message.class);
    assertThat(received.getHeaders().get(IntegrationMessageHeaderAccessor.SOURCE_DATA)).isSameAs(received.getHeaders().get(AmqpMessageHeaderErrorMessageStrategy.AMQP_RAW_MESSAGE));
    assertThat(received.getHeaders().get(AmqpHeaders.CONSUMER_QUEUE)).isEqualTo("foo");
    // make sure channel is not cached
    org.springframework.amqp.rabbit.connection.Connection conn = ccf.createConnection();
    // should not have been "closed"
    Channel notCached = conn.createChannel(false);
    verify(connection, times(2)).createChannel();
    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(Status.ACCEPT);
    verify(channel).basicAck(123L, false);
    // should have been "closed"
    Channel cached = conn.createChannel(false);
    verify(connection, times(2)).createChannel();
    notCached.close();
    cached.close();
    ccf.destroy();
    verify(channel, times(2)).close();
    verify(connection).close(30000);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAck</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">true</span>).given(channel).isOpen();

    Envelope envelope = <span class="hljs-keyword">new</span> Envelope(<span class="hljs-number">123L</span>, <span class="hljs-keyword">false</span>, <span class="hljs-string">"ex"</span>, <span class="hljs-string">"rk"</span>);

    BasicProperties props = <span class="hljs-keyword">new</span> BasicProperties.Builder().contentType(MessageProperties.DEFAULT_CONTENT_TYPE).build();

    GetResponse getResponse = <span class="hljs-keyword">new</span> GetResponse(envelope, props, <span class="hljs-string">"bar"</span>.getBytes(), <span class="hljs-number">0</span>);

    willReturn(getResponse).given(channel).basicGet(<span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>);

    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">true</span>).given(connection).isOpen();

    willReturn(channel).given(connection).createChannel();

    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());

    CachingConnectionFactory ccf = <span class="hljs-keyword">new</span> CachingConnectionFactory(connectionFactory);

    AmqpMessageSource source = <span class="hljs-keyword">new</span> AmqpMessageSource(ccf, <span class="hljs-string">"foo"</span>);

    source.setRawMessageHeader(<span class="hljs-keyword">true</span>);

    Message&lt;?&gt; received = source.receive();

    assertThat(received.getHeaders().get(AmqpMessageHeaderErrorMessageStrategy.AMQP_RAW_MESSAGE)).isInstanceOf(org.springframework.amqp.core.Message<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    assertThat(received.getHeaders().get(IntegrationMessageHeaderAccessor.SOURCE_DATA)).isSameAs(received.getHeaders().get(AmqpMessageHeaderErrorMessageStrategy.AMQP_RAW_MESSAGE));

    assertThat(received.getHeaders().get(AmqpHeaders.CONSUMER_QUEUE)).isEqualTo(<span class="hljs-string">"foo"</span>);

    <span class="hljs-comment">// make sure channel is not cached</span>

    org.springframework.amqp.rabbit.connection.Connection conn = ccf.createConnection();

    <span class="hljs-comment">// should not have been "closed"</span>

    Channel notCached = conn.createChannel(<span class="hljs-keyword">false</span>);

    verify(connection, times(<span class="hljs-number">2</span>)).createChannel();

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(Status.ACCEPT);

    verify(channel).basicAck(<span class="hljs-number">123L</span>, <span class="hljs-keyword">false</span>);

    <span class="hljs-comment">// should have been "closed"</span>

    Channel cached = conn.createChannel(<span class="hljs-keyword">false</span>);

    verify(connection, times(<span class="hljs-number">2</span>)).createChannel();

    notCached.close();

    cached.close();

    ccf.destroy();

    verify(channel, times(<span class="hljs-number">2</span>)).close();

    verify(connection).close(<span class="hljs-number">30000</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Channel <span class="hljs-title">createMockChannel</span><span class="hljs-params">(GetResponse getResponse)</span> </span>{
    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(<span class="hljs-keyword">true</span>).given(channel).isOpen();
    willReturn(getResponse).given(channel).basicGet(<span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>);
    <span class="hljs-keyword">return</span> channel;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest312">Test Case ID #spring-integration_Test_31_2</h4>
<h4 id="test-case-name-testnackorrequeuefile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpinboundamqpmessagesourcetestsjava">Test Case Name: <code>testNackOrRequeue</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\inbound\AmqpMessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-channel">Mock Object Variable Name: <code>channel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
private void testNackOrRequeue(boolean requeue) throws Exception {
<span class="hljs-deletion">-    Channel channel = mock(Channel.class);</span>
<span class="hljs-deletion">-    willReturn(true).given(channel).isOpen();</span>
    Envelope envelope = new Envelope(123L, false, "ex", "rk");
    BasicProperties props = new BasicProperties.Builder().contentType(MessageProperties.DEFAULT_CONTENT_TYPE).build();
    GetResponse getResponse = new GetResponse(envelope, props, "bar".getBytes(), 0);
<span class="hljs-deletion">-    willReturn(getResponse).given(channel).basicGet("foo", false);</span>
<span class="hljs-addition">+    Channel channel = createMockChannel(getResponse);</span>
    Connection connection = mock(Connection.class);
    willReturn(true).given(connection).isOpen();
    willReturn(channel).given(connection).createChannel();
    ConnectionFactory connectionFactory = mock(ConnectionFactory.class);
    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());
    CachingConnectionFactory ccf = new CachingConnectionFactory(connectionFactory);
    AmqpMessageSource source = new AmqpMessageSource(ccf, "foo");
    Message&lt;?&gt; received = source.receive();
    verify(connection).createChannel();
    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(requeue ? Status.REQUEUE : Status.REJECT);
    verify(channel).basicReject(123L, requeue);
    verify(connection).createChannel();
    ccf.destroy();
    verify(channel).close();
    verify(connection).close(30000);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNackOrRequeue</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> requeue)</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">true</span>).given(channel).isOpen();

    Envelope envelope = <span class="hljs-keyword">new</span> Envelope(<span class="hljs-number">123L</span>, <span class="hljs-keyword">false</span>, <span class="hljs-string">"ex"</span>, <span class="hljs-string">"rk"</span>);

    BasicProperties props = <span class="hljs-keyword">new</span> BasicProperties.Builder().contentType(MessageProperties.DEFAULT_CONTENT_TYPE).build();

    GetResponse getResponse = <span class="hljs-keyword">new</span> GetResponse(envelope, props, <span class="hljs-string">"bar"</span>.getBytes(), <span class="hljs-number">0</span>);

    willReturn(getResponse).given(channel).basicGet(<span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>);

    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">true</span>).given(connection).isOpen();

    willReturn(channel).given(connection).createChannel();

    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());

    CachingConnectionFactory ccf = <span class="hljs-keyword">new</span> CachingConnectionFactory(connectionFactory);

    AmqpMessageSource source = <span class="hljs-keyword">new</span> AmqpMessageSource(ccf, <span class="hljs-string">"foo"</span>);

    Message&lt;?&gt; received = source.receive();

    verify(connection).createChannel();

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(requeue ? Status.REQUEUE : Status.REJECT);

    verify(channel).basicReject(<span class="hljs-number">123L</span>, requeue);

    verify(connection).createChannel();

    ccf.destroy();

    verify(channel).close();

    verify(connection).close(<span class="hljs-number">30000</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Channel <span class="hljs-title">createMockChannel</span><span class="hljs-params">(GetResponse getResponse)</span> </span>{
    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(<span class="hljs-keyword">true</span>).given(channel).isOpen();
    willReturn(getResponse).given(channel).basicGet(<span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>);
    <span class="hljs-keyword">return</span> channel;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest313">Test Case ID #spring-integration_Test_31_3</h4>
<h4 id="test-case-name-testbatchfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpinboundamqpmessagesourcetestsjava">Test Case Name: <code>testBatch</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\inbound\AmqpMessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-channel">Mock Object Variable Name: <code>channel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    MessageBatch batched = bs.addToBatch("foo", "bar", message);
<span class="hljs-deletion">-    Channel channel = mock(Channel.class);</span>
<span class="hljs-deletion">-    willReturn(true).given(channel).isOpen();</span>
    Envelope envelope = new Envelope(123L, false, "ex", "rk");
    BasicProperties props = new BasicProperties.Builder().headers(batched.message().getMessageProperties().getHeaders()).contentType("text/plain").build();
    GetResponse getResponse = new GetResponse(envelope, props, batched.message().getBody(), 0);
<span class="hljs-deletion">-    willReturn(getResponse).given(channel).basicGet("foo", false);</span>
<span class="hljs-addition">+    Channel channel = createMockChannel(getResponse);</span>
    Connection connection = mock(Connection.class);
    willReturn(true).given(connection).isOpen();
    willReturn(channel).given(connection).createChannel();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testBatch</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SimpleBatchingStrategy bs = <span class="hljs-keyword">new</span> SimpleBatchingStrategy(<span class="hljs-number">2</span>, <span class="hljs-number">10_000</span>, <span class="hljs-number">10_000L</span>);

    MessageProperties messageProperties = <span class="hljs-keyword">new</span> MessageProperties();

    messageProperties.setContentType(<span class="hljs-string">"text/plain"</span>);

    org.springframework.amqp.core.Message message = <span class="hljs-keyword">new</span> org.springframework.amqp.core.Message(<span class="hljs-string">"test1"</span>.getBytes(), messageProperties);

    bs.addToBatch(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>, message);

    message = <span class="hljs-keyword">new</span> org.springframework.amqp.core.Message(<span class="hljs-string">"test2"</span>.getBytes(), messageProperties);

    MessageBatch batched = bs.addToBatch(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>, message);

    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">true</span>).given(channel).isOpen();

    Envelope envelope = <span class="hljs-keyword">new</span> Envelope(<span class="hljs-number">123L</span>, <span class="hljs-keyword">false</span>, <span class="hljs-string">"ex"</span>, <span class="hljs-string">"rk"</span>);

    BasicProperties props = <span class="hljs-keyword">new</span> BasicProperties.Builder().headers(batched.message().getMessageProperties().getHeaders()).contentType(<span class="hljs-string">"text/plain"</span>).build();

    GetResponse getResponse = <span class="hljs-keyword">new</span> GetResponse(envelope, props, batched.message().getBody(), <span class="hljs-number">0</span>);

    willReturn(getResponse).given(channel).basicGet(<span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>);

    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">true</span>).given(connection).isOpen();

    willReturn(channel).given(connection).createChannel();

    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());

    CachingConnectionFactory ccf = <span class="hljs-keyword">new</span> CachingConnectionFactory(connectionFactory);

    AmqpMessageSource source = <span class="hljs-keyword">new</span> AmqpMessageSource(ccf, <span class="hljs-string">"foo"</span>);

    Message&lt;?&gt; received = source.receive();

    assertThat(received).isNotNull();

    assertThat(((List&lt;String&gt;) received.getPayload())).contains(<span class="hljs-string">"test1"</span>, <span class="hljs-string">"test2"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Channel <span class="hljs-title">createMockChannel</span><span class="hljs-params">(GetResponse getResponse)</span> </span>{
    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(<span class="hljs-keyword">true</span>).given(channel).isOpen();
    willReturn(getResponse).given(channel).basicGet(<span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>);
    <span class="hljs-keyword">return</span> channel;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci32">Mock Clone Instance #spring-integration_MCI_32</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.rabbitmq.client.Channel</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Channel mockChannel;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockChannel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockChannel;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest321">Test Case ID #spring-integration_Test_32_1</h4>
<h4 id="test-case-name-testint2773usedefaultamqptemplateexchangeandroutingleyfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpconfigamqpoutboundchanneladapterparsertestsjava">Test Case Name: <code>testInt2773UseDefaultAmqpTemplateExchangeAndRoutingLey</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\config\AmqpOutboundChannelAdapterParserTests.java</code>)</h4>
<h4 id="mock-object-variable-name-mockchannel">Mock Object Variable Name: <code>mockChannel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testInt2773UseDefaultAmqpTemplateExchangeAndRoutingLey() throws IOException {
     ConnectionFactory connectionFactory = context.getBean(ConnectionFactory.class);
     Connection mockConnection = mock(Connection.class);
<span class="hljs-deletion">-    Channel mockChannel = mock(Channel.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockChannel`</span>
     when(connectionFactory.createConnection()).thenReturn(mockConnection);
     PublisherCallbackChannelImpl publisherCallbackChannel = new PublisherCallbackChannelImpl(mockChannel, mock(ExecutorService.class));
     when(mockConnection.createChannel(false)).thenReturn(publisherCallbackChannel);
     MessageChannel requestChannel = context.getBean("toRabbitOnlyWithTemplateChannel", MessageChannel.class);
     requestChannel.send(MessageBuilder.withPayload("test").build());
<span class="hljs-deletion">-    Mockito.verify(mockChannel, Mockito.times(1)).basicPublish(Mockito.eq("default.test.exchange"), Mockito.eq("default.routing.key"), Mockito.anyBoolean(), Mockito.any(BasicProperties.class), Mockito.any(byte[].class));</span>
<span class="hljs-addition">+    Mockito.verify(mockChannel, Mockito.times(1)).basicPublish(Mockito.eq("default.test.exchange"), Mockito.eq("default.routing.key"), Mockito.anyBoolean(), Mockito.any(BasicProperties.class), Mockito.any(byte[].class));</span>
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInt2773UseDefaultAmqpTemplateExchangeAndRoutingLey</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{

    ConnectionFactory connectionFactory = context.getBean(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Connection mockConnection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Channel mockChannel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(connectionFactory.createConnection()).thenReturn(mockConnection);

    PublisherCallbackChannelImpl publisherCallbackChannel = <span class="hljs-keyword">new</span> PublisherCallbackChannelImpl(mockChannel, mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    when(mockConnection.createChannel(<span class="hljs-keyword">false</span>)).thenReturn(publisherCallbackChannel);

    MessageChannel requestChannel = context.getBean(<span class="hljs-string">"toRabbitOnlyWithTemplateChannel"</span>, MessageChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    requestChannel.send(MessageBuilder.withPayload(<span class="hljs-string">"test"</span>).build());

    Mockito.verify(mockChannel, Mockito.times(<span class="hljs-number">1</span>)).basicPublish(Mockito.eq(<span class="hljs-string">"default.test.exchange"</span>), Mockito.eq(<span class="hljs-string">"default.routing.key"</span>), Mockito.anyBoolean(), Mockito.any(BasicProperties<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">Mockito</span>.<span class="hljs-title">any</span>(<span class="hljs-title">byte</span>[].<span class="hljs-title">class</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Channel mockChannel;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockChannel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockChannel;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest322">Test Case ID #spring-integration_Test_32_2</h4>
<h4 id="test-case-name-testint2773withdefaultamqptemplateexchangeandroutingkeyfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpconfigamqpoutboundchanneladapterparsertestsjava">Test Case Name: <code>testInt2773WithDefaultAmqpTemplateExchangeAndRoutingKey</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\config\AmqpOutboundChannelAdapterParserTests.java</code>)</h4>
<h4 id="mock-object-variable-name-mockchannel">Mock Object Variable Name: <code>mockChannel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testInt2773WithDefaultAmqpTemplateExchangeAndRoutingKey() throws IOException {
     ConnectionFactory connectionFactory = context.getBean(ConnectionFactory.class);
     Connection mockConnection = mock(Connection.class);
<span class="hljs-deletion">-    Channel mockChannel = mock(Channel.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockChannel`</span>
     when(connectionFactory.createConnection()).thenReturn(mockConnection);
     PublisherCallbackChannelImpl publisherCallbackChannel = new PublisherCallbackChannelImpl(mockChannel, mock(ExecutorService.class));
     when(mockConnection.createChannel(false)).thenReturn(publisherCallbackChannel);
     MessageChannel requestChannel = context.getBean("withDefaultAmqpTemplateExchangeAndRoutingKey", MessageChannel.class);
     requestChannel.send(MessageBuilder.withPayload("test").build());
<span class="hljs-deletion">-    Mockito.verify(mockChannel, Mockito.times(1)).basicPublish(Mockito.eq(""), Mockito.eq(""), Mockito.anyBoolean(), Mockito.any(BasicProperties.class), Mockito.any(byte[].class));</span>
<span class="hljs-addition">+    Mockito.verify(mockChannel, Mockito.times(1)).basicPublish(Mockito.eq(""), Mockito.eq(""), Mockito.anyBoolean(), Mockito.any(BasicProperties.class), Mockito.any(byte[].class));</span>
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInt2773WithDefaultAmqpTemplateExchangeAndRoutingKey</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{

    ConnectionFactory connectionFactory = context.getBean(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Connection mockConnection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Channel mockChannel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(connectionFactory.createConnection()).thenReturn(mockConnection);

    PublisherCallbackChannelImpl publisherCallbackChannel = <span class="hljs-keyword">new</span> PublisherCallbackChannelImpl(mockChannel, mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    when(mockConnection.createChannel(<span class="hljs-keyword">false</span>)).thenReturn(publisherCallbackChannel);

    MessageChannel requestChannel = context.getBean(<span class="hljs-string">"withDefaultAmqpTemplateExchangeAndRoutingKey"</span>, MessageChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    requestChannel.send(MessageBuilder.withPayload(<span class="hljs-string">"test"</span>).build());

    Mockito.verify(mockChannel, Mockito.times(<span class="hljs-number">1</span>)).basicPublish(Mockito.eq(<span class="hljs-string">""</span>), Mockito.eq(<span class="hljs-string">""</span>), Mockito.anyBoolean(), Mockito.any(BasicProperties<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">Mockito</span>.<span class="hljs-title">any</span>(<span class="hljs-title">byte</span>[].<span class="hljs-title">class</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Channel mockChannel;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockChannel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockChannel;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest323">Test Case ID #spring-integration_Test_32_3</h4>
<h4 id="test-case-name-testint2773withoverridetodefaultamqptemplateexchangeandroutingleyfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpconfigamqpoutboundchanneladapterparsertestsjava">Test Case Name: <code>testInt2773WithOverrideToDefaultAmqpTemplateExchangeAndRoutingLey</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\config\AmqpOutboundChannelAdapterParserTests.java</code>)</h4>
<h4 id="mock-object-variable-name-mockchannel">Mock Object Variable Name: <code>mockChannel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testInt2773WithOverrideToDefaultAmqpTemplateExchangeAndRoutingLey() throws IOException {
     ConnectionFactory connectionFactory = context.getBean(ConnectionFactory.class);
     Connection mockConnection = mock(Connection.class);
<span class="hljs-deletion">-    Channel mockChannel = mock(Channel.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockChannel`</span>
     when(connectionFactory.createConnection()).thenReturn(mockConnection);
     PublisherCallbackChannelImpl publisherCallbackChannel = new PublisherCallbackChannelImpl(mockChannel, mock(ExecutorService.class));
     when(mockConnection.createChannel(false)).thenReturn(publisherCallbackChannel);
     MessageChannel requestChannel = context.getBean("overrideTemplateAttributesToEmpty", MessageChannel.class);
     requestChannel.send(MessageBuilder.withPayload("test").build());
<span class="hljs-deletion">-    Mockito.verify(mockChannel, Mockito.times(1)).basicPublish(Mockito.eq(""), Mockito.eq(""), Mockito.anyBoolean(), Mockito.any(BasicProperties.class), Mockito.any(byte[].class));</span>
<span class="hljs-addition">+    Mockito.verify(mockChannel, Mockito.times(1)).basicPublish(Mockito.eq(""), Mockito.eq(""), Mockito.anyBoolean(), Mockito.any(BasicProperties.class), Mockito.any(byte[].class));</span>
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInt2773WithOverrideToDefaultAmqpTemplateExchangeAndRoutingLey</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{

    ConnectionFactory connectionFactory = context.getBean(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Connection mockConnection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Channel mockChannel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(connectionFactory.createConnection()).thenReturn(mockConnection);

    PublisherCallbackChannelImpl publisherCallbackChannel = <span class="hljs-keyword">new</span> PublisherCallbackChannelImpl(mockChannel, mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    when(mockConnection.createChannel(<span class="hljs-keyword">false</span>)).thenReturn(publisherCallbackChannel);

    MessageChannel requestChannel = context.getBean(<span class="hljs-string">"overrideTemplateAttributesToEmpty"</span>, MessageChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    requestChannel.send(MessageBuilder.withPayload(<span class="hljs-string">"test"</span>).build());

    Mockito.verify(mockChannel, Mockito.times(<span class="hljs-number">1</span>)).basicPublish(Mockito.eq(<span class="hljs-string">""</span>), Mockito.eq(<span class="hljs-string">""</span>), Mockito.anyBoolean(), Mockito.any(BasicProperties<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">Mockito</span>.<span class="hljs-title">any</span>(<span class="hljs-title">byte</span>[].<span class="hljs-title">class</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Channel mockChannel;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockChannel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockChannel;

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci33">Mock Clone Instance #spring-integration_MCI_33</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.eclipse.paho.client.mqttv3.IMqttToken</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> IMqttToken <span class="hljs-title">createMockIMqttToken</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] grantedQos)</span> </span>{
    IMqttToken token = mock(IMqttToken<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(token.getGrantedQos()).willReturn(grantedQos);
    <span class="hljs-keyword">return</span> token;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest331">Test Case ID #spring-integration_Test_33_1</h4>
<h4 id="test-case-name-testinboundoptionsappliedfile-cjavaprojectsspringspring-integrationspring-integration-mqttsrctestjavaorgspringframeworkintegrationmqttmqttadaptertestsjava">Test Case Name: <code>testInboundOptionsApplied</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mqtt\src\test\java\org\springframework\integration\mqtt\MqttAdapterTests.java</code>)</h4>
<h4 id="mock-object-variable-name-token">Mock Object Variable Name: <code>token</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final AtomicBoolean connectCalled = new AtomicBoolean();
<span class="hljs-deletion">-    IMqttToken token = mock(IMqttToken.class);</span>
<span class="hljs-addition">+    IMqttToken token = createMockIMqttToken(new int[] { 2 });</span>
    willAnswer(invocation -&gt; {
        MqttConnectOptions options = invocation.getArgument(0);
        assertThat(options.getConnectionTimeout()).isEqualTo(23);
        assertThat(options.getKeepAliveInterval()).isEqualTo(45);
        assertThat(new String(options.getPassword())).isEqualTo("pass");
        assertThat(options.getSocketFactory()).isSameAs(socketFactory);
        assertThat(options.getSSLProperties()).isSameAs(props);
        assertThat(options.getUserName()).isEqualTo("user");
        assertThat(options.getWillDestination()).isEqualTo("foo");
        assertThat(new String(options.getWillMessage().getPayload())).isEqualTo("bar");
        assertThat(options.getWillMessage().getQos()).isEqualTo(2);
        connectCalled.set(true);
        return token;
    }).given(client).connect(any(MqttConnectOptions.class));
    given(client.subscribe(any(String[].class), any(int[].class), any())).willReturn(token);
<span class="hljs-deletion">-    given(token.getGrantedQos()).willReturn(new int[] { 2 });</span>
    final AtomicReference&lt;MqttCallbackExtended&gt; callback = new AtomicReference&lt;&gt;();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInboundOptionsApplied</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    DefaultMqttPahoClientFactory factory = <span class="hljs-keyword">new</span> DefaultMqttPahoClientFactory();

    MqttConnectOptions connectOptions = <span class="hljs-keyword">new</span> MqttConnectOptions();

    connectOptions.setCleanSession(<span class="hljs-keyword">false</span>);

    connectOptions.setConnectionTimeout(<span class="hljs-number">23</span>);

    connectOptions.setKeepAliveInterval(<span class="hljs-number">45</span>);

    connectOptions.setPassword(<span class="hljs-string">"pass"</span>.toCharArray());

    MemoryPersistence persistence = <span class="hljs-keyword">new</span> MemoryPersistence();

    factory.setPersistence(persistence);

    <span class="hljs-keyword">final</span> SocketFactory socketFactory = SocketFactory.getDefault();

    connectOptions.setSocketFactory(socketFactory);

    <span class="hljs-keyword">final</span> Properties props = <span class="hljs-keyword">new</span> Properties();

    connectOptions.setSSLProperties(props);

    connectOptions.setUserName(<span class="hljs-string">"user"</span>);

    connectOptions.setWill(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>.getBytes(), <span class="hljs-number">2</span>, <span class="hljs-keyword">true</span>);

    factory.setConnectionOptions(connectOptions);

    factory = spy(factory);

    <span class="hljs-keyword">final</span> IMqttAsyncClient client = mock(IMqttAsyncClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(client).given(factory).getAsyncClientInstance(anyString(), anyString());

    <span class="hljs-keyword">final</span> AtomicBoolean connectCalled = <span class="hljs-keyword">new</span> AtomicBoolean();

    IMqttToken token = mock(IMqttToken<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willAnswer(invocation -&gt; {

        MqttConnectOptions options = invocation.getArgument(<span class="hljs-number">0</span>);

        assertThat(options.getConnectionTimeout()).isEqualTo(<span class="hljs-number">23</span>);

        assertThat(options.getKeepAliveInterval()).isEqualTo(<span class="hljs-number">45</span>);

        assertThat(<span class="hljs-keyword">new</span> String(options.getPassword())).isEqualTo(<span class="hljs-string">"pass"</span>);

        assertThat(options.getSocketFactory()).isSameAs(socketFactory);

        assertThat(options.getSSLProperties()).isSameAs(props);

        assertThat(options.getUserName()).isEqualTo(<span class="hljs-string">"user"</span>);

        assertThat(options.getWillDestination()).isEqualTo(<span class="hljs-string">"foo"</span>);

        assertThat(<span class="hljs-keyword">new</span> String(options.getWillMessage().getPayload())).isEqualTo(<span class="hljs-string">"bar"</span>);

        assertThat(options.getWillMessage().getQos()).isEqualTo(<span class="hljs-number">2</span>);

        connectCalled.set(<span class="hljs-keyword">true</span>);

        <span class="hljs-keyword">return</span> token;

    }).given(client).connect(any(MqttConnectOptions<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    given(client.subscribe(any(String[]<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">int</span>[].<span class="hljs-title">class</span>), <span class="hljs-title">any</span>())).<span class="hljs-title">willReturn</span>(<span class="hljs-title">token</span>)</span>;

    given(token.getGrantedQos()).willReturn(<span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">2</span> });

    <span class="hljs-keyword">final</span> AtomicReference&lt;MqttCallbackExtended&gt; callback = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    willAnswer(invocation -&gt; {

        callback.set(invocation.getArgument(<span class="hljs-number">0</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(client).setCallback(any(MqttCallbackExtended<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    given(client.isConnected()).willReturn(<span class="hljs-keyword">true</span>);

    MqttPahoMessageDrivenChannelAdapter adapter = <span class="hljs-keyword">new</span> MqttPahoMessageDrivenChannelAdapter(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>, factory, <span class="hljs-string">"baz"</span>, <span class="hljs-string">"fix"</span>);

    adapter.setManualAcks(<span class="hljs-keyword">true</span>);

    QueueChannel outputChannel = <span class="hljs-keyword">new</span> QueueChannel();

    adapter.setOutputChannel(outputChannel);

    QueueChannel errorChannel = <span class="hljs-keyword">new</span> QueueChannel();

    adapter.setErrorChannel(errorChannel);

    adapter.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ApplicationEventPublisher applicationEventPublisher = mock(ApplicationEventPublisher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> BlockingQueue&lt;MqttIntegrationEvent&gt; events = <span class="hljs-keyword">new</span> LinkedBlockingQueue&lt;&gt;();

    willAnswer(invocation -&gt; {

        events.add(invocation.getArgument(<span class="hljs-number">0</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(applicationEventPublisher).publishEvent(any(MqttIntegrationEvent<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    adapter.setApplicationEventPublisher(applicationEventPublisher);

    adapter.afterPropertiesSet();

    adapter.start();

    adapter.connectComplete(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);

    verify(client, times(<span class="hljs-number">1</span>)).connect(any(MqttConnectOptions<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    assertThat(connectCalled.get()).isTrue();

    MqttMessage message = <span class="hljs-keyword">new</span> MqttMessage(<span class="hljs-string">"qux"</span>.getBytes());

    callback.get().messageArrived(<span class="hljs-string">"baz"</span>, message);

    Message&lt;?&gt; outMessage = outputChannel.receive(<span class="hljs-number">0</span>);

    assertThat(outMessage).isNotNull();

    assertThat(outMessage.getPayload()).isEqualTo(<span class="hljs-string">"qux"</span>);

    StaticMessageHeaderAccessor.getAcknowledgment(outMessage).acknowledge();

    verify(client).setManualAcks(<span class="hljs-keyword">true</span>);

    verify(client).messageArrivedComplete(MqttHeaderAccessor.id(outMessage), MqttHeaderAccessor.receivedQos(outMessage));

    MqttIntegrationEvent event = events.poll(<span class="hljs-number">10</span>, TimeUnit.SECONDS);

    assertThat(event).isInstanceOf(MqttSubscribedEvent<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    assertThat(((MqttSubscribedEvent) event).getMessage()).isEqualTo(<span class="hljs-string">"Connected and subscribed to [baz, fix]"</span>);

    adapter.setConverter(<span class="hljs-keyword">new</span> MqttMessageConverter() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> AbstractIntegrationMessageBuilder&lt;?&gt; toMessageBuilder(String topic, MqttMessage mqttMessage) {

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">fromMessage</span><span class="hljs-params">(Message&lt;?&gt; message, Class&lt;?&gt; targetClass)</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> Message&lt;?&gt; toMessage(Object payload, MessageHeaders headers) {

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

        }

    });

    callback.get().messageArrived(<span class="hljs-string">"baz"</span>, message);

    ErrorMessage errorMessage = (ErrorMessage) errorChannel.receive(<span class="hljs-number">0</span>);

    assertThat(errorMessage).isNotNull().extracting(Message::getPayload).isInstanceOf(IllegalStateException<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    IllegalStateException exception = (IllegalStateException) errorMessage.getPayload();

    assertThat(exception).hasMessage(<span class="hljs-string">"'MqttMessageConverter' returned 'null'"</span>);

    assertThat(errorMessage.getOriginalMessage().getPayload()).isSameAs(message);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> IMqttToken <span class="hljs-title">createMockIMqttToken</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] grantedQos)</span> </span>{
    IMqttToken token = mock(IMqttToken<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(token.getGrantedQos()).willReturn(grantedQos);
    <span class="hljs-keyword">return</span> token;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest332">Test Case ID #spring-integration_Test_33_2</h4>
<h4 id="test-case-name-testsubscribefailurefile-cjavaprojectsspringspring-integrationspring-integration-mqttsrctestjavaorgspringframeworkintegrationmqttmqttadaptertestsjava">Test Case Name: <code>testSubscribeFailure</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mqtt\src\test\java\org\springframework\integration\mqtt\MqttAdapterTests.java</code>)</h4>
<h4 id="mock-object-variable-name-token">Mock Object Variable Name: <code>token</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     willReturn(alwaysComplete).given(client).connect(any(MqttConnectOptions.class));
<span class="hljs-deletion">-    IMqttToken token = mock(IMqttToken.class);</span>
<span class="hljs-deletion">-    given(token.getGrantedQos()).willReturn(new int[] { 0x80 });</span>
<span class="hljs-addition">+    IMqttToken token = createMockIMqttToken(new int[] { 0x80 });</span>
     willReturn(token).given(client).subscribe(any(String[].class), any(int[].class), any());
     MqttPahoMessageDrivenChannelAdapter adapter = new MqttPahoMessageDrivenChannelAdapter("foo", "bar", factory, "baz", "fix");
     AtomicReference&lt;Method&gt; method = new AtomicReference&lt;&gt;();
     ReflectionUtils.doWithMethods(MqttPahoMessageDrivenChannelAdapter.class, m -&gt; {
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSubscribeFailure</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    DefaultMqttPahoClientFactory factory = <span class="hljs-keyword">new</span> DefaultMqttPahoClientFactory();

    MqttConnectOptions connectOptions = <span class="hljs-keyword">new</span> MqttConnectOptions();

    connectOptions.setCleanSession(<span class="hljs-keyword">false</span>);

    connectOptions.setConnectionTimeout(<span class="hljs-number">23</span>);

    connectOptions.setKeepAliveInterval(<span class="hljs-number">45</span>);

    connectOptions.setPassword(<span class="hljs-string">"pass"</span>.toCharArray());

    MemoryPersistence persistence = <span class="hljs-keyword">new</span> MemoryPersistence();

    factory.setPersistence(persistence);

    <span class="hljs-keyword">final</span> SocketFactory socketFactory = SocketFactory.getDefault();

    connectOptions.setSocketFactory(socketFactory);

    <span class="hljs-keyword">final</span> Properties props = <span class="hljs-keyword">new</span> Properties();

    connectOptions.setSSLProperties(props);

    connectOptions.setUserName(<span class="hljs-string">"user"</span>);

    connectOptions.setWill(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>.getBytes(), <span class="hljs-number">2</span>, <span class="hljs-keyword">true</span>);

    factory = spy(factory);

    <span class="hljs-keyword">final</span> MqttAsyncClient client = mock(MqttAsyncClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(client).given(factory).getAsyncClientInstance(anyString(), anyString());

    given(client.isConnected()).willReturn(<span class="hljs-keyword">true</span>);

    willReturn(alwaysComplete).given(client).connect(any(MqttConnectOptions<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    IMqttToken token = mock(IMqttToken<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(token.getGrantedQos()).willReturn(<span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">0x80</span> });

    willReturn(token).given(client).subscribe(any(String[]<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">int</span>[].<span class="hljs-title">class</span>), <span class="hljs-title">any</span>())</span>;

    MqttPahoMessageDrivenChannelAdapter adapter = <span class="hljs-keyword">new</span> MqttPahoMessageDrivenChannelAdapter(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>, factory, <span class="hljs-string">"baz"</span>, <span class="hljs-string">"fix"</span>);

    AtomicReference&lt;Method&gt; method = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    ReflectionUtils.doWithMethods(MqttPahoMessageDrivenChannelAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">m</span> -&gt; </span>{

        m.setAccessible(<span class="hljs-keyword">true</span>);

        method.set(m);

    }, m -&gt; m.getName().equals(<span class="hljs-string">"connect"</span>));

    assertThat(method.get()).isNotNull();

    method.get().invoke(adapter);

    ReflectionUtils.doWithMethods(MqttPahoMessageDrivenChannelAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">m</span> -&gt; </span>{

        m.setAccessible(<span class="hljs-keyword">true</span>);

        method.set(m);

    }, m -&gt; m.getName().equals(<span class="hljs-string">"subscribe"</span>));

    assertThat(method.get()).isNotNull();

    ApplicationEventPublisher eventPublisher = mock(ApplicationEventPublisher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    adapter.setApplicationEventPublisher(eventPublisher);

    method.get().invoke(adapter);

    verify(eventPublisher).publishEvent(any(MqttConnectionFailedEvent<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> IMqttToken <span class="hljs-title">createMockIMqttToken</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] grantedQos)</span> </span>{
    IMqttToken token = mock(IMqttToken<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(token.getGrantedQos()).willReturn(grantedQos);
    <span class="hljs-keyword">return</span> token;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest333">Test Case ID #spring-integration_Test_33_3</h4>
<h4 id="test-case-name-testdifferentqosfile-cjavaprojectsspringspring-integrationspring-integration-mqttsrctestjavaorgspringframeworkintegrationmqttmqttadaptertestsjava">Test Case Name: <code>testDifferentQos</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mqtt\src\test\java\org\springframework\integration\mqtt\MqttAdapterTests.java</code>)</h4>
<h4 id="mock-object-variable-name-token">Mock Object Variable Name: <code>token</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     willReturn(alwaysComplete).given(client).connect(any(MqttConnectOptions.class));
<span class="hljs-deletion">-    IMqttToken token = mock(IMqttToken.class);</span>
<span class="hljs-deletion">-    given(token.getGrantedQos()).willReturn(new int[] { 2, 0 });</span>
<span class="hljs-addition">+    IMqttToken token = createMockIMqttToken(new int[] { 2, 0 });</span>
     willReturn(token).given(client).subscribe(any(String[].class), any(int[].class), any());
     MqttPahoMessageDrivenChannelAdapter adapter = new MqttPahoMessageDrivenChannelAdapter("tcp://mqtt.host", "bar", factory, "baz", "fix");
     AtomicReference&lt;Method&gt; method = new AtomicReference&lt;&gt;();
     ReflectionUtils.doWithMethods(MqttPahoMessageDrivenChannelAdapter.class, m -&gt; {
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDifferentQos</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    DefaultMqttPahoClientFactory factory = <span class="hljs-keyword">new</span> DefaultMqttPahoClientFactory();

    MqttConnectOptions connectOptions = <span class="hljs-keyword">new</span> MqttConnectOptions();

    connectOptions.setCleanSession(<span class="hljs-keyword">false</span>);

    connectOptions.setConnectionTimeout(<span class="hljs-number">23</span>);

    connectOptions.setKeepAliveInterval(<span class="hljs-number">45</span>);

    connectOptions.setPassword(<span class="hljs-string">"pass"</span>.toCharArray());

    MemoryPersistence persistence = <span class="hljs-keyword">new</span> MemoryPersistence();

    factory.setPersistence(persistence);

    <span class="hljs-keyword">final</span> SocketFactory socketFactory = SocketFactory.getDefault();

    connectOptions.setSocketFactory(socketFactory);

    <span class="hljs-keyword">final</span> Properties props = <span class="hljs-keyword">new</span> Properties();

    connectOptions.setSSLProperties(props);

    connectOptions.setUserName(<span class="hljs-string">"user"</span>);

    connectOptions.setWill(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>.getBytes(), <span class="hljs-number">2</span>, <span class="hljs-keyword">true</span>);

    factory = spy(factory);

    <span class="hljs-keyword">final</span> MqttAsyncClient client = mock(MqttAsyncClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(client).given(factory).getAsyncClientInstance(anyString(), anyString());

    given(client.isConnected()).willReturn(<span class="hljs-keyword">true</span>);

    willReturn(alwaysComplete).given(client).connect(any(MqttConnectOptions<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    IMqttToken token = mock(IMqttToken<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(token.getGrantedQos()).willReturn(<span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] { <span class="hljs-number">2</span>, <span class="hljs-number">0</span> });

    willReturn(token).given(client).subscribe(any(String[]<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">int</span>[].<span class="hljs-title">class</span>), <span class="hljs-title">any</span>())</span>;

    MqttPahoMessageDrivenChannelAdapter adapter = <span class="hljs-keyword">new</span> MqttPahoMessageDrivenChannelAdapter(<span class="hljs-string">"tcp://mqtt.host"</span>, <span class="hljs-string">"bar"</span>, factory, <span class="hljs-string">"baz"</span>, <span class="hljs-string">"fix"</span>);

    AtomicReference&lt;Method&gt; method = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    ReflectionUtils.doWithMethods(MqttPahoMessageDrivenChannelAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">m</span> -&gt; </span>{

        m.setAccessible(<span class="hljs-keyword">true</span>);

        method.set(m);

    }, m -&gt; m.getName().equals(<span class="hljs-string">"connect"</span>));

    assertThat(method.get()).isNotNull();

    method.get().invoke(adapter);

    ReflectionUtils.doWithMethods(MqttPahoMessageDrivenChannelAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">m</span> -&gt; </span>{

        m.setAccessible(<span class="hljs-keyword">true</span>);

        method.set(m);

    }, m -&gt; m.getName().equals(<span class="hljs-string">"subscribe"</span>));

    assertThat(method.get()).isNotNull();

    LogAccessor logger = spy(TestUtils.getPropertyValue(adapter, <span class="hljs-string">"logger"</span>, LogAccessor<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">new</span> DirectFieldAccessor(adapter).setPropertyValue(<span class="hljs-string">"logger"</span>, logger);

    given(logger.isWarnEnabled()).willReturn(<span class="hljs-keyword">true</span>);

    method.get().invoke(adapter);

    verify(logger, atLeastOnce()).warn(ArgumentMatchers.&lt;Supplier&lt;? extends CharSequence&gt;&gt;argThat(logMessage -&gt; logMessage.get().equals(<span class="hljs-string">"Granted QOS different to Requested QOS; topics: [baz, fix] "</span> + <span class="hljs-string">"requested: [1, 1] granted: [2, 0]"</span>)));

    <span class="hljs-keyword">new</span> DirectFieldAccessor(adapter).setPropertyValue(<span class="hljs-string">"running"</span>, Boolean.TRUE);

    adapter.stop();

    verify(client).disconnectForcibly(<span class="hljs-number">5_000L</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> IMqttToken <span class="hljs-title">createMockIMqttToken</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] grantedQos)</span> </span>{
    IMqttToken token = mock(IMqttToken<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(token.getGrantedQos()).willReturn(grantedQos);
    <span class="hljs-keyword">return</span> token;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci34">Mock Clone Instance #spring-integration_MCI_34</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>java.net.Socket</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Socket <span class="hljs-title">createMockSocket</span><span class="hljs-params">(InputStream inputStream, InetAddress inetAddress)</span> </span>{
    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(socket.getInputStream()).thenReturn(inputStream);
    when(socket.getInetAddress()).thenReturn(inetAddress);
    <span class="hljs-keyword">return</span> socket;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest341">Test Case ID #spring-integration_Test_34_1</h4>
<h4 id="test-case-name-testnetclientfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionsocketsupporttestsjava">Test Case Name: <code>testNetClient</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\SocketSupportTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socket">Mock Object Variable Name: <code>socket</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SocketFactory factory = Mockito.mock(SocketFactory.class);
    when(factorySupport.getSocketFactory()).thenReturn(factory);
<span class="hljs-deletion">-    Socket socket = mock(Socket.class);</span>
    InputStream is = mock(InputStream.class);
    when(is.read()).thenReturn(-1);
<span class="hljs-deletion">-    when(socket.getInputStream()).thenReturn(is);</span>
    InetAddress inetAddress = InetAddress.getLocalHost();
<span class="hljs-deletion">-    when(socket.getInetAddress()).thenReturn(inetAddress);</span>
<span class="hljs-addition">+    Socket socket = createMockSocket(is, inetAddress);</span>
    when(factory.createSocket()).thenReturn(socket);
    TcpSocketSupport socketSupport = Mockito.mock(TcpSocketSupport.class);
    TcpNetClientConnectionFactory connectionFactory = new TcpNetClientConnectionFactory("x", 0);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNetClient</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketFactory factory = Mockito.mock(SocketFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factorySupport.getSocketFactory()).thenReturn(factory);

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    InputStream is = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(is.read()).thenReturn(-<span class="hljs-number">1</span>);

    when(socket.getInputStream()).thenReturn(is);

    InetAddress inetAddress = InetAddress.getLocalHost();

    when(socket.getInetAddress()).thenReturn(inetAddress);

    when(factory.createSocket()).thenReturn(socket);

    TcpSocketSupport socketSupport = Mockito.mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNetClientConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> TcpNetClientConnectionFactory(<span class="hljs-string">"x"</span>, <span class="hljs-number">0</span>);

    connectionFactory.setTcpSocketFactorySupport(factorySupport);

    connectionFactory.setTcpSocketSupport(socketSupport);

    connectionFactory.start();

    connectionFactory.getConnection();

    verify(socketSupport).postProcessSocket(socket);

    connectionFactory.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Socket <span class="hljs-title">createMockSocket</span><span class="hljs-params">(InputStream inputStream, InetAddress inetAddress)</span> </span>{
    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(socket.getInputStream()).thenReturn(inputStream);
    when(socket.getInetAddress()).thenReturn(inetAddress);
    <span class="hljs-keyword">return</span> socket;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest342">Test Case ID #spring-integration_Test_34_2</h4>
<h4 id="test-case-name-testnetclientsockettimeoutfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionsocketsupporttestsjava">Test Case Name: <code>testNetClientSocketTimeout</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\SocketSupportTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socket">Mock Object Variable Name: <code>socket</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SocketFactory factory = Mockito.mock(SocketFactory.class);
    when(factorySupport.getSocketFactory()).thenReturn(factory);
<span class="hljs-deletion">-    Socket socket = mock(Socket.class);</span>
    InputStream is = mock(InputStream.class);
    when(is.read()).thenReturn(-1);
<span class="hljs-deletion">-    when(socket.getInputStream()).thenReturn(is);</span>
    InetAddress inetAddress = InetAddress.getLocalHost();
<span class="hljs-deletion">-    when(socket.getInetAddress()).thenReturn(inetAddress);</span>
<span class="hljs-addition">+    Socket socket = createMockSocket(is, inetAddress);</span>
    when(factory.createSocket()).thenReturn(socket);
    doThrow(new SocketTimeoutException()).when(socket).connect(any(), eq(1000));
    TcpSocketSupport socketSupport = Mockito.mock(TcpSocketSupport.class);
    TcpNetClientConnectionFactory connectionFactory = new TcpNetClientConnectionFactory("x", 0);
    connectionFactory.setConnectTimeout(1);
    connectionFactory.setTcpSocketFactorySupport(factorySupport);
    connectionFactory.setTcpSocketSupport(socketSupport);
    connectionFactory.start();
    assertThatThrownBy(connectionFactory::getConnection).isInstanceOf(UncheckedIOException.class).hasCauseInstanceOf(SocketTimeoutException.class);
    connectionFactory.stop();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNetClientSocketTimeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketFactory factory = Mockito.mock(SocketFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factorySupport.getSocketFactory()).thenReturn(factory);

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    InputStream is = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(is.read()).thenReturn(-<span class="hljs-number">1</span>);

    when(socket.getInputStream()).thenReturn(is);

    InetAddress inetAddress = InetAddress.getLocalHost();

    when(socket.getInetAddress()).thenReturn(inetAddress);

    when(factory.createSocket()).thenReturn(socket);

    doThrow(<span class="hljs-keyword">new</span> SocketTimeoutException()).when(socket).connect(any(), eq(<span class="hljs-number">1000</span>));

    TcpSocketSupport socketSupport = Mockito.mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNetClientConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> TcpNetClientConnectionFactory(<span class="hljs-string">"x"</span>, <span class="hljs-number">0</span>);

    connectionFactory.setConnectTimeout(<span class="hljs-number">1</span>);

    connectionFactory.setTcpSocketFactorySupport(factorySupport);

    connectionFactory.setTcpSocketSupport(socketSupport);

    connectionFactory.start();

    assertThatThrownBy(connectionFactory::getConnection).isInstanceOf(UncheckedIOException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">hasCauseInstanceOf</span>(<span class="hljs-title">SocketTimeoutException</span>.<span class="hljs-title">class</span>)</span>;

    connectionFactory.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Socket <span class="hljs-title">createMockSocket</span><span class="hljs-params">(InputStream inputStream, InetAddress inetAddress)</span> </span>{
    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(socket.getInputStream()).thenReturn(inputStream);
    when(socket.getInetAddress()).thenReturn(inetAddress);
    <span class="hljs-keyword">return</span> socket;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest343">Test Case ID #spring-integration_Test_34_3</h4>
<h4 id="test-case-name-testnetserverfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionsocketsupporttestsjava">Test Case Name: <code>testNetServer</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\SocketSupportTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socket">Mock Object Variable Name: <code>socket</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    when(factorySupport.getServerSocketFactory()).thenReturn(factory);
<span class="hljs-deletion">-    Socket socket = mock(Socket.class);</span>
<span class="hljs-addition">+    Socket socket = createMockSocket(is, inetAddress);</span>
    Socket socket1 = mock(Socket.class);
    InputStream is = mock(InputStream.class);
    when(is.read()).thenReturn(-1);
<span class="hljs-deletion">-    when(socket.getInputStream()).thenReturn(is);</span>
    when(socket1.getInputStream()).thenReturn(is);
    InetAddress inetAddress = InetAddress.getLocalHost();
<span class="hljs-deletion">-    when(socket.getInetAddress()).thenReturn(inetAddress);</span>
    when(socket1.getInetAddress()).thenReturn(inetAddress);
    ServerSocket serverSocket = mock(ServerSocket.class);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNetServer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServerSocketFactory factory = mock(ServerSocketFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factorySupport.getServerSocketFactory()).thenReturn(factory);

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Socket socket1 = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    InputStream is = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(is.read()).thenReturn(-<span class="hljs-number">1</span>);

    when(socket.getInputStream()).thenReturn(is);

    when(socket1.getInputStream()).thenReturn(is);

    InetAddress inetAddress = InetAddress.getLocalHost();

    when(socket.getInetAddress()).thenReturn(inetAddress);

    when(socket1.getInetAddress()).thenReturn(inetAddress);

    ServerSocket serverSocket = mock(ServerSocket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AtomicBoolean closed = <span class="hljs-keyword">new</span> AtomicBoolean();

    doAnswer(invoc -&gt; {

        closed.set(<span class="hljs-keyword">true</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(serverSocket).close();

    when(serverSocket.getInetAddress()).thenReturn(inetAddress);

    when(factory.createServerSocket(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>)).thenReturn(serverSocket);

    <span class="hljs-keyword">final</span> CountDownLatch latch1 = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">final</span> CountDownLatch latch2 = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    when(serverSocket.accept()).thenReturn(socket).then(invocation -&gt; {

        <span class="hljs-keyword">if</span> (closed.get()) {

            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> SocketException();

        }

        latch1.countDown();

        latch2.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS);

        Thread.sleep(<span class="hljs-number">50</span>);

        <span class="hljs-keyword">return</span> socket1;

    });

    TcpSocketSupport socketSupport = mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNetServerConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> TcpNetServerConnectionFactory(<span class="hljs-number">0</span>);

    connectionFactory.setTcpSocketFactorySupport(factorySupport);

    connectionFactory.setTcpSocketSupport(socketSupport);

    connectionFactory.registerListener(mock(TcpListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    connectionFactory.start();

    assertThat(latch1.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    verify(socketSupport).postProcessServerSocket(serverSocket);

    verify(socketSupport).postProcessSocket(socket);

    latch2.countDown();

    connectionFactory.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Socket <span class="hljs-title">createMockSocket</span><span class="hljs-params">(InputStream inputStream, InetAddress inetAddress)</span> </span>{
    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(socket.getInputStream()).thenReturn(inputStream);
    when(socket.getInetAddress()).thenReturn(inetAddress);
    <span class="hljs-keyword">return</span> socket;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest344">Test Case ID #spring-integration_Test_34_4</h4>
<h4 id="test-case-name-testnetserverfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionsocketsupporttestsjava">Test Case Name: <code>testNetServer</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\SocketSupportTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socket1">Mock Object Variable Name: <code>socket1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Socket socket = mock(Socket.class);
<span class="hljs-deletion">-    Socket socket1 = mock(Socket.class);</span>
    InputStream is = mock(InputStream.class);
    when(is.read()).thenReturn(-1);
    when(socket.getInputStream()).thenReturn(is);
<span class="hljs-addition">+    Socket socket1 = createMockSocket(is, inetAddress);</span>
    InetAddress inetAddress = InetAddress.getLocalHost();
    when(socket.getInetAddress()).thenReturn(inetAddress);
<span class="hljs-deletion">-    when(socket1.getInputStream()).thenReturn(is);</span>
<span class="hljs-deletion">-    when(socket1.getInetAddress()).thenReturn(inetAddress);</span>
    ServerSocket serverSocket = mock(ServerSocket.class);
    AtomicBoolean closed = new AtomicBoolean();
    doAnswer(invoc -&gt; {
        closed.set(true);
        return null;
    }).when(serverSocket).close();
    when(serverSocket.getInetAddress()).thenReturn(inetAddress);
    when(factory.createServerSocket(0, 5)).thenReturn(serverSocket);
    final CountDownLatch latch1 = new CountDownLatch(1);
    final CountDownLatch latch2 = new CountDownLatch(1);
    when(serverSocket.accept()).thenReturn(socket).then(invocation -&gt; {
        if (closed.get()) {
            throw new SocketException();
        }
        latch1.countDown();
        latch2.await(10, TimeUnit.SECONDS);
        Thread.sleep(50);
        return socket1;
    });
    TcpSocketSupport socketSupport = mock(TcpSocketSupport.class);
    TcpNetServerConnectionFactory connectionFactory = new TcpNetServerConnectionFactory(0);
    connectionFactory.setTcpSocketFactorySupport(factorySupport);
    connectionFactory.setTcpSocketSupport(socketSupport);
    connectionFactory.registerListener(mock(TcpListener.class));
    connectionFactory.start();
    assertThat(latch1.await(10, TimeUnit.SECONDS)).isTrue();
    verify(socketSupport).postProcessServerSocket(serverSocket);
    verify(socketSupport).postProcessSocket(socket);
    latch2.countDown();
    connectionFactory.stop();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNetServer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServerSocketFactory factory = mock(ServerSocketFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factorySupport.getServerSocketFactory()).thenReturn(factory);

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Socket socket1 = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    InputStream is = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(is.read()).thenReturn(-<span class="hljs-number">1</span>);

    when(socket.getInputStream()).thenReturn(is);

    when(socket1.getInputStream()).thenReturn(is);

    InetAddress inetAddress = InetAddress.getLocalHost();

    when(socket.getInetAddress()).thenReturn(inetAddress);

    when(socket1.getInetAddress()).thenReturn(inetAddress);

    ServerSocket serverSocket = mock(ServerSocket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AtomicBoolean closed = <span class="hljs-keyword">new</span> AtomicBoolean();

    doAnswer(invoc -&gt; {

        closed.set(<span class="hljs-keyword">true</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(serverSocket).close();

    when(serverSocket.getInetAddress()).thenReturn(inetAddress);

    when(factory.createServerSocket(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>)).thenReturn(serverSocket);

    <span class="hljs-keyword">final</span> CountDownLatch latch1 = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">final</span> CountDownLatch latch2 = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    when(serverSocket.accept()).thenReturn(socket).then(invocation -&gt; {

        <span class="hljs-keyword">if</span> (closed.get()) {

            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> SocketException();

        }

        latch1.countDown();

        latch2.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS);

        Thread.sleep(<span class="hljs-number">50</span>);

        <span class="hljs-keyword">return</span> socket1;

    });

    TcpSocketSupport socketSupport = mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNetServerConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> TcpNetServerConnectionFactory(<span class="hljs-number">0</span>);

    connectionFactory.setTcpSocketFactorySupport(factorySupport);

    connectionFactory.setTcpSocketSupport(socketSupport);

    connectionFactory.registerListener(mock(TcpListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    connectionFactory.start();

    assertThat(latch1.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    verify(socketSupport).postProcessServerSocket(serverSocket);

    verify(socketSupport).postProcessSocket(socket);

    latch2.countDown();

    connectionFactory.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Socket <span class="hljs-title">createMockSocket</span><span class="hljs-params">(InputStream inputStream, InetAddress inetAddress)</span> </span>{
    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(socket.getInputStream()).thenReturn(inputStream);
    when(socket.getInetAddress()).thenReturn(inetAddress);
    <span class="hljs-keyword">return</span> socket;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci35">Mock Clone Instance #spring-integration_MCI_35</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>java.net.Socket</code></li>
<li><strong>Test Case Count</strong>: 6</li>
<li><strong>MO Count</strong>: 6</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Socket socket;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
socket;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest351">Test Case ID #spring-integration_Test_35_1</h4>
<h4 id="test-case-name-testbytearrayreadfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpnioconnectiontestsjava">Test Case Name: <code>testByteArrayRead</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpNioConnectionTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socket">Mock Object Variable Name: <code>socket</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testByteArrayRead() throws Exception {
     SocketChannel socketChannel = mock(SocketChannel.class);
<span class="hljs-deletion">-    Socket socket = mock(Socket.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `socket`</span>
     when(socketChannel.socket()).thenReturn(socket);
     TcpNioConnection connection = new TcpNioConnection(socketChannel, false, false, null, null);
     TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) new DirectFieldAccessor(connection).getPropertyValue("channelInputStream");
     stream.write(ByteBuffer.wrap("foo".getBytes()));
     byte[] out = new byte[2];
     int n = stream.read(out);
     assertThat(n).isEqualTo(2);
     assertThat(new String(out)).isEqualTo("fo");
     out = new byte[2];
     n = stream.read(out);
     assertThat(n).isEqualTo(1);
     assertThat(new String(out)).isEqualTo("o\u0000");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testByteArrayRead</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(socketChannel.socket()).thenReturn(socket);

    TcpNioConnection connection = <span class="hljs-keyword">new</span> TcpNioConnection(socketChannel, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

    TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) <span class="hljs-keyword">new</span> DirectFieldAccessor(connection).getPropertyValue(<span class="hljs-string">"channelInputStream"</span>);

    stream.write(ByteBuffer.wrap(<span class="hljs-string">"foo"</span>.getBytes()));

    <span class="hljs-keyword">byte</span>[] out = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">2</span>];

    <span class="hljs-keyword">int</span> n = stream.read(out);

    assertThat(n).isEqualTo(<span class="hljs-number">2</span>);

    assertThat(<span class="hljs-keyword">new</span> String(out)).isEqualTo(<span class="hljs-string">"fo"</span>);

    out = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">2</span>];

    n = stream.read(out);

    assertThat(n).isEqualTo(<span class="hljs-number">1</span>);

    assertThat(<span class="hljs-keyword">new</span> String(out)).isEqualTo(<span class="hljs-string">"o\u0000"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Socket socket;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
socket;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest352">Test Case ID #spring-integration_Test_35_2</h4>
<h4 id="test-case-name-testbytearrayreadmultifile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpnioconnectiontestsjava">Test Case Name: <code>testByteArrayReadMulti</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpNioConnectionTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socket">Mock Object Variable Name: <code>socket</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testByteArrayReadMulti() throws Exception {
     SocketChannel socketChannel = mock(SocketChannel.class);
<span class="hljs-deletion">-    Socket socket = mock(Socket.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `socket`</span>
     when(socketChannel.socket()).thenReturn(socket);
     TcpNioConnection connection = new TcpNioConnection(socketChannel, false, false, null, null);
     TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) new DirectFieldAccessor(connection).getPropertyValue("channelInputStream");
     stream.write(ByteBuffer.wrap("foo".getBytes()));
     stream.write(ByteBuffer.wrap("bar".getBytes()));
     byte[] out = new byte[6];
     int n = stream.read(out);
     assertThat(n).isEqualTo(6);
     assertThat(new String(out)).isEqualTo("foobar");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testByteArrayReadMulti</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(socketChannel.socket()).thenReturn(socket);

    TcpNioConnection connection = <span class="hljs-keyword">new</span> TcpNioConnection(socketChannel, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

    TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) <span class="hljs-keyword">new</span> DirectFieldAccessor(connection).getPropertyValue(<span class="hljs-string">"channelInputStream"</span>);

    stream.write(ByteBuffer.wrap(<span class="hljs-string">"foo"</span>.getBytes()));

    stream.write(ByteBuffer.wrap(<span class="hljs-string">"bar"</span>.getBytes()));

    <span class="hljs-keyword">byte</span>[] out = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">6</span>];

    <span class="hljs-keyword">int</span> n = stream.read(out);

    assertThat(n).isEqualTo(<span class="hljs-number">6</span>);

    assertThat(<span class="hljs-keyword">new</span> String(out)).isEqualTo(<span class="hljs-string">"foobar"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Socket socket;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
socket;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest353">Test Case ID #spring-integration_Test_35_3</h4>
<h4 id="test-case-name-testbytearrayreadwithoffsetfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpnioconnectiontestsjava">Test Case Name: <code>testByteArrayReadWithOffset</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpNioConnectionTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socket">Mock Object Variable Name: <code>socket</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testByteArrayReadWithOffset() throws Exception {
     SocketChannel socketChannel = mock(SocketChannel.class);
<span class="hljs-deletion">-    Socket socket = mock(Socket.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `socket`</span>
     when(socketChannel.socket()).thenReturn(socket);
     TcpNioConnection connection = new TcpNioConnection(socketChannel, false, false, null, null);
     TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) new DirectFieldAccessor(connection).getPropertyValue("channelInputStream");
     stream.write(ByteBuffer.wrap("foo".getBytes()));
     byte[] out = new byte[5];
     int n = stream.read(out, 1, 4);
     assertThat(n).isEqualTo(3);
     assertThat(new String(out)).isEqualTo("\u0000foo\u0000");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testByteArrayReadWithOffset</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(socketChannel.socket()).thenReturn(socket);

    TcpNioConnection connection = <span class="hljs-keyword">new</span> TcpNioConnection(socketChannel, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

    TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) <span class="hljs-keyword">new</span> DirectFieldAccessor(connection).getPropertyValue(<span class="hljs-string">"channelInputStream"</span>);

    stream.write(ByteBuffer.wrap(<span class="hljs-string">"foo"</span>.getBytes()));

    <span class="hljs-keyword">byte</span>[] out = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">5</span>];

    <span class="hljs-keyword">int</span> n = stream.read(out, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>);

    assertThat(n).isEqualTo(<span class="hljs-number">3</span>);

    assertThat(<span class="hljs-keyword">new</span> String(out)).isEqualTo(<span class="hljs-string">"\u0000foo\u0000"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Socket socket;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
socket;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest354">Test Case ID #spring-integration_Test_35_4</h4>
<h4 id="test-case-name-testbytearrayreadwithbadargsfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpnioconnectiontestsjava">Test Case Name: <code>testByteArrayReadWithBadArgs</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpNioConnectionTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socket">Mock Object Variable Name: <code>socket</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testByteArrayReadWithBadArgs() throws Exception {
     SocketChannel socketChannel = mock(SocketChannel.class);
<span class="hljs-deletion">-    Socket socket = mock(Socket.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `socket`</span>
     when(socketChannel.socket()).thenReturn(socket);
     TcpNioConnection connection = new TcpNioConnection(socketChannel, false, false, null, null);
     TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) new DirectFieldAccessor(connection).getPropertyValue("channelInputStream");
     stream.write(ByteBuffer.wrap("foo".getBytes()));
     byte[] out = new byte[5];
     assertThatExceptionOfType(IndexOutOfBoundsException.class).isThrownBy(() -&gt; stream.read(out, 1, 5));
     assertThatIllegalArgumentException().isThrownBy(() -&gt; stream.read(null, 1, 5));
     assertThat(stream.read(out, 0, 0)).isEqualTo(0);
     assertThat(stream.read(out)).isEqualTo(3);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testByteArrayReadWithBadArgs</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(socketChannel.socket()).thenReturn(socket);

    TcpNioConnection connection = <span class="hljs-keyword">new</span> TcpNioConnection(socketChannel, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

    TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) <span class="hljs-keyword">new</span> DirectFieldAccessor(connection).getPropertyValue(<span class="hljs-string">"channelInputStream"</span>);

    stream.write(ByteBuffer.wrap(<span class="hljs-string">"foo"</span>.getBytes()));

    <span class="hljs-keyword">byte</span>[] out = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">5</span>];

    assertThatExceptionOfType(IndexOutOfBoundsException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(() -&gt; <span class="hljs-title">stream</span>.<span class="hljs-title">read</span>(<span class="hljs-title">out</span>, 1, 5))</span>;

    assertThatIllegalArgumentException().isThrownBy(() -&gt; stream.read(<span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>));

    assertThat(stream.read(out, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)).isEqualTo(<span class="hljs-number">0</span>);

    assertThat(stream.read(out)).isEqualTo(<span class="hljs-number">3</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Socket socket;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
socket;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest355">Test Case ID #spring-integration_Test_35_5</h4>
<h4 id="test-case-name-testbytearrayblocksforzeroreadfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpnioconnectiontestsjava">Test Case Name: <code>testByteArrayBlocksForZeroRead</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpNioConnectionTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socket">Mock Object Variable Name: <code>socket</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testByteArrayBlocksForZeroRead() throws Exception {
     SocketChannel socketChannel = mock(SocketChannel.class);
<span class="hljs-deletion">-    Socket socket = mock(Socket.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `socket`</span>
     when(socketChannel.socket()).thenReturn(socket);
     TcpNioConnection connection = new TcpNioConnection(socketChannel, false, false, null, null);
     final TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) new DirectFieldAccessor(connection).getPropertyValue("channelInputStream");
     final CountDownLatch latch = new CountDownLatch(1);
     final byte[] out = new byte[4];
     this.executor.execute(() -&gt; {
         try {
             stream.read(out);
         } catch (IOException e) {
             throw new UncheckedIOException(e);
         }
         latch.countDown();
     });
     Thread.sleep(1000);
     assertThat(out[0]).isEqualTo((byte) 0x00);
     stream.write(ByteBuffer.wrap("foo".getBytes()));
     assertThat(latch.await(10, TimeUnit.SECONDS)).isTrue();
     assertThat(new String(out)).isEqualTo("foo\u0000");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testByteArrayBlocksForZeroRead</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SocketChannel socketChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(socketChannel.socket()).thenReturn(socket);

    TcpNioConnection connection = <span class="hljs-keyword">new</span> TcpNioConnection(socketChannel, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

    <span class="hljs-keyword">final</span> TcpNioConnection.ChannelInputStream stream = (ChannelInputStream) <span class="hljs-keyword">new</span> DirectFieldAccessor(connection).getPropertyValue(<span class="hljs-string">"channelInputStream"</span>);

    <span class="hljs-keyword">final</span> CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] out = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">4</span>];

    <span class="hljs-keyword">this</span>.executor.execute(() -&gt; {

        <span class="hljs-keyword">try</span> {

            stream.read(out);

        } <span class="hljs-keyword">catch</span> (IOException e) {

            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UncheckedIOException(e);

        }

        latch.countDown();

    });

    Thread.sleep(<span class="hljs-number">1000</span>);

    assertThat(out[<span class="hljs-number">0</span>]).isEqualTo((<span class="hljs-keyword">byte</span>) <span class="hljs-number">0x00</span>);

    stream.write(ByteBuffer.wrap(<span class="hljs-string">"foo"</span>.getBytes()));

    assertThat(latch.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    assertThat(<span class="hljs-keyword">new</span> String(out)).isEqualTo(<span class="hljs-string">"foo\u0000"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Socket socket;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
socket;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest356">Test Case ID #spring-integration_Test_35_6</h4>
<h4 id="test-case-name-transferheadersfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpnioconnectiontestsjava">Test Case Name: <code>transferHeaders</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpNioConnectionTests.java</code>)</h4>
<h4 id="mock-object-variable-name-insocket">Mock Object Variable Name: <code>inSocket</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void transferHeaders() throws Exception {
<span class="hljs-deletion">-    Socket inSocket = mock(Socket.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `socket`</span>
     SocketChannel inChannel = mock(SocketChannel.class);
     when(inChannel.socket()).thenReturn(inSocket);
@@
<span class="hljs-deletion">-    when(inChannel.socket()).thenReturn(inSocket);</span>
<span class="hljs-addition">+    when(inChannel.socket()).thenReturn(socket);</span>
     TcpNioConnection inboundConnection = new TcpNioConnection(inChannel, true, false, nullPublisher, null);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">transferHeaders</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Socket inSocket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketChannel inChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(inChannel.socket()).thenReturn(inSocket);

    TcpNioConnection inboundConnection = <span class="hljs-keyword">new</span> TcpNioConnection(inChannel, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, nullPublisher, <span class="hljs-keyword">null</span>);

    inboundConnection.setDeserializer(<span class="hljs-keyword">new</span> MapJsonSerializer());

    MapMessageConverter inConverter = <span class="hljs-keyword">new</span> MapMessageConverter();

    MessageConvertingTcpMessageMapper inMapper = <span class="hljs-keyword">new</span> MessageConvertingTcpMessageMapper(inConverter);

    inboundConnection.setMapper(inMapper);

    <span class="hljs-keyword">final</span> ByteArrayOutputStream written = <span class="hljs-keyword">new</span> ByteArrayOutputStream();

    doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Integer&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">answer</span><span class="hljs-params">(InvocationOnMock invocation)</span> </span>{

            ByteBuffer buff = invocation.getArgument(<span class="hljs-number">0</span>);

            <span class="hljs-keyword">byte</span>[] bytes = written.toByteArray();

            buff.put(bytes);

            <span class="hljs-keyword">return</span> bytes.length;

        }

    }).when(inChannel).read(any(ByteBuffer<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Socket outSocket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketChannel outChannel = mock(SocketChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(outChannel.socket()).thenReturn(outSocket);

    TcpNioConnection outboundConnection = <span class="hljs-keyword">new</span> TcpNioConnection(outChannel, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, nullPublisher, <span class="hljs-keyword">null</span>);

    doAnswer(invocation -&gt; {

        ByteBuffer buff = invocation.getArgument(<span class="hljs-number">0</span>);

        <span class="hljs-keyword">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[buff.limit()];

        buff.get(bytes);

        written.write(bytes);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(outChannel).write(any(ByteBuffer<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    MapMessageConverter outConverter = <span class="hljs-keyword">new</span> MapMessageConverter();

    outConverter.setHeaderNames(<span class="hljs-string">"bar"</span>);

    MessageConvertingTcpMessageMapper outMapper = <span class="hljs-keyword">new</span> MessageConvertingTcpMessageMapper(outConverter);

    outboundConnection.setMapper(outMapper);

    outboundConnection.setSerializer(<span class="hljs-keyword">new</span> MapJsonSerializer());

    Message&lt;String&gt; message = MessageBuilder.withPayload(<span class="hljs-string">"foo"</span>).setHeader(<span class="hljs-string">"bar"</span>, <span class="hljs-string">"baz"</span>).build();

    outboundConnection.send(message);

    <span class="hljs-keyword">final</span> AtomicReference&lt;Message&lt;?&gt;&gt; inboundMessage = <span class="hljs-keyword">new</span> AtomicReference&lt;Message&lt;?&gt;&gt;();

    <span class="hljs-keyword">final</span> CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    TcpListener listener = message1 -&gt; {

        inboundMessage.set(message1);

        latch.countDown();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;

    };

    inboundConnection.registerListener(listener);

    inboundConnection.readPacket();

    assertThat(latch.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    assertThat(inboundMessage.get()).isNotNull();

    assertThat(inboundMessage.get().getPayload()).isEqualTo(<span class="hljs-string">"foo"</span>);

    assertThat(inboundMessage.get().getHeaders().get(<span class="hljs-string">"bar"</span>)).isEqualTo(<span class="hljs-string">"baz"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Socket socket;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
socket;

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci36">Mock Clone Instance #spring-integration_MCI_36</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.kafka.core.ProducerFactory</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProducerFactory&lt;?, ?&gt; createMockProducerFactory(Producer&lt;?, ?&gt; producer) {
    ProducerFactory&lt;?, ?&gt; pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(pf.createProducer()).willReturn(producer);
    <span class="hljs-keyword">return</span> pf;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest361">Test Case ID #spring-integration_Test_36_1</h4>
<h4 id="test-case-name-immediatefailurefile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkaoutboundkafkaproducermessagehandlertestsjava">Test Case Name: <code>immediateFailure</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\outbound\KafkaProducerMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-pf">Mock Object Variable Name: <code>pf</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    given(producer.send(any(), any())).willReturn(cf);
<span class="hljs-deletion">-    ProducerFactory pf = mock(ProducerFactory.class);</span>
<span class="hljs-deletion">-    given(pf.createProducer()).willReturn(producer);</span>
<span class="hljs-addition">+    ProducerFactory pf = createMockProducerFactory(producer);</span>
    KafkaTemplate template = new KafkaTemplate(pf);
    template.setDefaultTopic("foo");
    KafkaProducerMessageHandler handler = new KafkaProducerMessageHandler&lt;&gt;(template);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">immediateFailure</span><span class="hljs-params">()</span> </span>{

    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    CompletableFuture cf = <span class="hljs-keyword">new</span> CompletableFuture();

    RuntimeException rte = <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"test.immediate"</span>);

    cf.completeExceptionally(rte);

    given(producer.send(any(), any())).willReturn(cf);

    ProducerFactory pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(pf.createProducer()).willReturn(producer);

    KafkaTemplate template = <span class="hljs-keyword">new</span> KafkaTemplate(pf);

    template.setDefaultTopic(<span class="hljs-string">"foo"</span>);

    KafkaProducerMessageHandler handler = <span class="hljs-keyword">new</span> KafkaProducerMessageHandler&lt;&gt;(template);

    QueueChannel fails = <span class="hljs-keyword">new</span> QueueChannel();

    handler.setSendFailureChannel(fails);

    assertThatExceptionOfType(MessageHandlingException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(() -&gt; <span class="hljs-title">handler</span>.<span class="hljs-title">handleMessage</span>(<span class="hljs-title">new</span> <span class="hljs-title">GenericMessage</span>&lt;&gt;(""))).<span class="hljs-title">withCauseExactlyInstanceOf</span>(<span class="hljs-title">KafkaException</span>.<span class="hljs-title">class</span>).<span class="hljs-title">withStackTraceContaining</span>("<span class="hljs-title">test</span>.<span class="hljs-title">immediate</span>")</span>;

    Message&lt;?&gt; fail = fails.receive(<span class="hljs-number">0</span>);

    assertThat(fail).isNotNull();

    assertThat(fail.getPayload()).asInstanceOf(throwable(KafkaSendFailureException<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">cause</span>().<span class="hljs-title">isInstanceOf</span>(<span class="hljs-title">KafkaException</span>.<span class="hljs-title">class</span>).<span class="hljs-title">cause</span>().<span class="hljs-title">isEqualTo</span>(<span class="hljs-title">rte</span>)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProducerFactory&lt;?, ?&gt; createMockProducerFactory(Producer&lt;?, ?&gt; producer) {
    ProducerFactory&lt;?, ?&gt; pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(pf.createProducer()).willReturn(producer);
    <span class="hljs-keyword">return</span> pf;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest362">Test Case ID #spring-integration_Test_36_2</h4>
<h4 id="test-case-name-testflushfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkaoutboundkafkaproducermessagehandlertestsjava">Test Case Name: <code>testFlush</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\outbound\KafkaProducerMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-pf">Mock Object Variable Name: <code>pf</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testFlush() {
<span class="hljs-deletion">-    ProducerFactory pf = mock(ProducerFactory.class);</span>
     Producer producer = mock(Producer.class);
<span class="hljs-deletion">-    given(pf.createProducer()).willReturn(producer);</span>
<span class="hljs-addition">+    ProducerFactory pf = createMockProducerFactory(producer);</span>
     willReturn(mock(Future.class)).given(producer).send(any(ProducerRecord.class), any(Callback.class));
     KafkaTemplate template = new KafkaTemplate(pf);
     KafkaProducerMessageHandler handler = new KafkaProducerMessageHandler(template);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testFlush</span><span class="hljs-params">()</span> </span>{

    ProducerFactory pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(pf.createProducer()).willReturn(producer);

    willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">given</span>(<span class="hljs-title">producer</span>).<span class="hljs-title">send</span>(<span class="hljs-title">any</span>(<span class="hljs-title">ProducerRecord</span>.<span class="hljs-title">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;

    KafkaTemplate template = <span class="hljs-keyword">new</span> KafkaTemplate(pf);

    KafkaProducerMessageHandler handler = <span class="hljs-keyword">new</span> KafkaProducerMessageHandler(template);

    handler.setTopicExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    handler.start();

    handler.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>, Collections.singletonMap(KafkaIntegrationHeaders.FLUSH, Boolean.TRUE)));

    InOrder inOrder = inOrder(producer);

    ArgumentCaptor&lt;ProducerRecord&gt; captor = ArgumentCaptor.forClass(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    inOrder.verify(producer).send(captor.capture(), any(Callback<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(producer).flush();

    handler.stop();

    assertThat(captor.getValue().headers().lastHeader(KafkaIntegrationHeaders.FLUSH)).isNull();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProducerFactory&lt;?, ?&gt; createMockProducerFactory(Producer&lt;?, ?&gt; producer) {
    ProducerFactory&lt;?, ?&gt; pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(pf.createProducer()).willReturn(producer);
    <span class="hljs-keyword">return</span> pf;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest363">Test Case ID #spring-integration_Test_36_3</h4>
<h4 id="test-case-name-testnoflushfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkaoutboundkafkaproducermessagehandlertestsjava">Test Case Name: <code>testNoFlush</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\outbound\KafkaProducerMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-pf">Mock Object Variable Name: <code>pf</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @SuppressWarnings({ "rawtypes", "unchecked" })
 @Test
 void testNoFlush() {
<span class="hljs-deletion">-    ProducerFactory pf = mock(ProducerFactory.class);</span>
     Producer producer = mock(Producer.class);
<span class="hljs-deletion">-    given(pf.createProducer()).willReturn(producer);</span>
<span class="hljs-addition">+    ProducerFactory pf = createMockProducerFactory(producer);</span>
     willReturn(mock(Future.class)).given(producer).send(any(ProducerRecord.class), any(Callback.class));
     KafkaTemplate template = new KafkaTemplate(pf);
     KafkaProducerMessageHandler handler = new KafkaProducerMessageHandler(template);
     handler.setTopicExpression(new LiteralExpression("bar"));
     handler.setBeanFactory(mock(BeanFactory.class));
     handler.afterPropertiesSet();
     handler.start();
     handler.handleMessage(new GenericMessage&lt;&gt;("foo"));
     InOrder inOrder = inOrder(producer);
     inOrder.verify(producer).send(any(ProducerRecord.class), any(Callback.class));
     inOrder.verify(producer, never()).flush();
     handler.stop();
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testNoFlush</span><span class="hljs-params">()</span> </span>{

    ProducerFactory pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(pf.createProducer()).willReturn(producer);

    willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">given</span>(<span class="hljs-title">producer</span>).<span class="hljs-title">send</span>(<span class="hljs-title">any</span>(<span class="hljs-title">ProducerRecord</span>.<span class="hljs-title">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;

    KafkaTemplate template = <span class="hljs-keyword">new</span> KafkaTemplate(pf);

    KafkaProducerMessageHandler handler = <span class="hljs-keyword">new</span> KafkaProducerMessageHandler(template);

    handler.setTopicExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    handler.start();

    handler.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>));

    InOrder inOrder = inOrder(producer);

    inOrder.verify(producer).send(any(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;

    inOrder.verify(producer, never()).flush();

    handler.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProducerFactory&lt;?, ?&gt; createMockProducerFactory(Producer&lt;?, ?&gt; producer) {
    ProducerFactory&lt;?, ?&gt; pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(pf.createProducer()).willReturn(producer);
    <span class="hljs-keyword">return</span> pf;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest364">Test Case ID #spring-integration_Test_36_4</h4>
<h4 id="test-case-name-conversionfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkaoutboundkafkaproducermessagehandlertestsjava">Test Case Name: <code>conversion</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\outbound\KafkaProducerMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-pf">Mock Object Variable Name: <code>pf</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @SuppressWarnings({ "rawtypes", "unchecked" })
 @Test
 void conversion() {
<span class="hljs-deletion">-    ProducerFactory pf = mock(ProducerFactory.class);</span>
     Producer producer = mock(Producer.class);
<span class="hljs-deletion">-    given(pf.createProducer()).willReturn(producer);</span>
<span class="hljs-addition">+    ProducerFactory pf = createMockProducerFactory(producer);</span>
     willReturn(mock(Future.class)).given(producer).send(any(ProducerRecord.class), any(Callback.class));
     KafkaTemplate template = new KafkaTemplate(pf);
     RecordMessageConverter converter = mock(RecordMessageConverter.class);
     ProducerRecord recordFromConverter = mock(ProducerRecord.class);
     given(converter.fromMessage(any(), any())).willReturn(recordFromConverter);
     template.setMessageConverter(converter);
     KafkaProducerMessageHandler handler = new KafkaProducerMessageHandler(template);
     handler.setTopicExpression(new LiteralExpression("bar"));
     handler.setBeanFactory(mock(BeanFactory.class));
     ProducerRecordCreator creator = mock(ProducerRecordCreator.class);
     ProducerRecord recordFromCreator = mock(ProducerRecord.class);
     given(creator.create(any(), any(), any(), any(), any(), any(), any())).willReturn(recordFromCreator);
     handler.setProducerRecordCreator(creator);
     handler.afterPropertiesSet();
     handler.start();
     handler.handleMessage(new GenericMessage&lt;&gt;("foo"));
     ArgumentCaptor&lt;ProducerRecord&gt; captor = ArgumentCaptor.forClass(ProducerRecord.class);
     verify(producer).send(captor.capture(), any(Callback.class));
     assertThat(captor.getValue()).isSameAs(recordFromCreator);
     handler.setUseTemplateConverter(true);
     handler.handleMessage(new GenericMessage&lt;&gt;("foo"));
     verify(producer, times(2)).send(captor.capture(), any(Callback.class));
     assertThat(captor.getValue()).isSameAs(recordFromConverter);
     handler.stop();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">conversion</span><span class="hljs-params">()</span> </span>{

    ProducerFactory pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(pf.createProducer()).willReturn(producer);

    willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">given</span>(<span class="hljs-title">producer</span>).<span class="hljs-title">send</span>(<span class="hljs-title">any</span>(<span class="hljs-title">ProducerRecord</span>.<span class="hljs-title">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;

    KafkaTemplate template = <span class="hljs-keyword">new</span> KafkaTemplate(pf);

    RecordMessageConverter converter = mock(RecordMessageConverter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ProducerRecord recordFromConverter = mock(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(converter.fromMessage(any(), any())).willReturn(recordFromConverter);

    template.setMessageConverter(converter);

    KafkaProducerMessageHandler handler = <span class="hljs-keyword">new</span> KafkaProducerMessageHandler(template);

    handler.setTopicExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ProducerRecordCreator creator = mock(ProducerRecordCreator<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ProducerRecord recordFromCreator = mock(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(creator.create(any(), any(), any(), any(), any(), any(), any())).willReturn(recordFromCreator);

    handler.setProducerRecordCreator(creator);

    handler.afterPropertiesSet();

    handler.start();

    handler.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>));

    ArgumentCaptor&lt;ProducerRecord&gt; captor = ArgumentCaptor.forClass(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(producer).send(captor.capture(), any(Callback<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    assertThat(captor.getValue()).isSameAs(recordFromCreator);

    handler.setUseTemplateConverter(<span class="hljs-keyword">true</span>);

    handler.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>));

    verify(producer, times(<span class="hljs-number">2</span>)).send(captor.capture(), any(Callback<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    assertThat(captor.getValue()).isSameAs(recordFromConverter);

    handler.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProducerFactory&lt;?, ?&gt; createMockProducerFactory(Producer&lt;?, ?&gt; producer) {
    ProducerFactory&lt;?, ?&gt; pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(pf.createProducer()).willReturn(producer);
    <span class="hljs-keyword">return</span> pf;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci37">Mock Clone Instance #spring-integration_MCI_37</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.kafka.core.ProducerFactory</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProducerFactory&lt;?, ?&gt; createMockProducerFactory() {
    ProducerFactory&lt;?, ?&gt; pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(pf.transactionCapable()).willReturn(<span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> pf;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest371">Test Case ID #spring-integration_Test_37_1</h4>
<h4 id="test-case-name-testtransactionfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkaoutboundkafkaproducermessagehandlertestsjava">Test Case Name: <code>testTransaction</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\outbound\KafkaProducerMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-pf">Mock Object Variable Name: <code>pf</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testTransaction() {
<span class="hljs-deletion">-    ProducerFactory pf = mock(ProducerFactory.class);</span>
<span class="hljs-deletion">-    given(pf.transactionCapable()).willReturn(true);</span>
<span class="hljs-addition">+    ProducerFactory pf = createMockProducerFactory();</span>
    Producer producer = mock(Producer.class);
<span class="hljs-deletion">-    given(pf.createProducer(isNull())).willReturn(producer);</span>
<span class="hljs-addition">+    given(pf.createProducer(isNull())).willReturn(producer);</span>
    willReturn(mock(Future.class)).given(producer).send(any(ProducerRecord.class), any(Callback.class));
    KafkaTemplate template = new KafkaTemplate(pf);
    KafkaProducerMessageHandler handler = new KafkaProducerMessageHandler(template);
    handler.setTopicExpression(new LiteralExpression("bar"));
    handler.setBeanFactory(mock(BeanFactory.class));
    handler.afterPropertiesSet();
    handler.start();
    handler.handleMessage(new GenericMessage&lt;&gt;("foo"));
    handler.stop();
    InOrder inOrder = inOrder(producer);
    inOrder.verify(producer).beginTransaction();
    inOrder.verify(producer).send(any(ProducerRecord.class), any(Callback.class));
    inOrder.verify(producer).commitTransaction();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testTransaction</span><span class="hljs-params">()</span> </span>{

    ProducerFactory pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(pf.transactionCapable()).willReturn(<span class="hljs-keyword">true</span>);

    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(pf.createProducer(isNull())).willReturn(producer);

    willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">given</span>(<span class="hljs-title">producer</span>).<span class="hljs-title">send</span>(<span class="hljs-title">any</span>(<span class="hljs-title">ProducerRecord</span>.<span class="hljs-title">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;

    KafkaTemplate template = <span class="hljs-keyword">new</span> KafkaTemplate(pf);

    KafkaProducerMessageHandler handler = <span class="hljs-keyword">new</span> KafkaProducerMessageHandler(template);

    handler.setTopicExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    handler.start();

    handler.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>));

    handler.stop();

    InOrder inOrder = inOrder(producer);

    inOrder.verify(producer).beginTransaction();

    inOrder.verify(producer).send(any(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;

    inOrder.verify(producer).commitTransaction();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProducerFactory&lt;?, ?&gt; createMockProducerFactory() {
    ProducerFactory&lt;?, ?&gt; pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(pf.transactionCapable()).willReturn(<span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> pf;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest372">Test Case ID #spring-integration_Test_37_2</h4>
<h4 id="test-case-name-testconsumeandproducetransactionfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkaoutboundkafkaproducermessagehandlertestsjava">Test Case Name: <code>testConsumeAndProduceTransaction</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\outbound\KafkaProducerMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-pf">Mock Object Variable Name: <code>pf</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    willAnswer(i -&gt; {
        closeLatch.countDown();
        return null;
    }).given(producer).close(any());
<span class="hljs-deletion">-    ProducerFactory pf = mock(ProducerFactory.class);</span>
<span class="hljs-deletion">-    given(pf.transactionCapable()).willReturn(true);</span>
<span class="hljs-addition">+    ProducerFactory pf = createMockProducerFactory();</span>
    willReturn(producer).given(pf).createProducer(isNull());
    KafkaTransactionManager ptm = new KafkaTransactionManager(pf);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"unchecked"</span>, <span class="hljs-string">"rawtypes"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumeAndProduceTransaction</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Consumer mockConsumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    willAnswer(i -&gt; {

        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(mockConsumer).subscribe(any(Collection<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">ConsumerRebalanceListener</span>.<span class="hljs-title">class</span>))</span>;

    ConsumerRecords records = <span class="hljs-keyword">new</span> ConsumerRecords(Collections.singletonMap(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord&lt;&gt;(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>))));

    <span class="hljs-keyword">final</span> AtomicBoolean done = <span class="hljs-keyword">new</span> AtomicBoolean();

    willAnswer(i -&gt; {

        <span class="hljs-keyword">if</span> (done.compareAndSet(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>)) {

            <span class="hljs-keyword">return</span> records;

        } <span class="hljs-keyword">else</span> {

            Thread.sleep(<span class="hljs-number">500</span>);

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

        }

    }).given(mockConsumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ConsumerGroupMetadata meta = <span class="hljs-keyword">new</span> ConsumerGroupMetadata(<span class="hljs-string">"group"</span>);

    given(mockConsumer.groupMetadata()).willReturn(meta);

    ConsumerFactory cf = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(mockConsumer).given(cf).createConsumer(<span class="hljs-string">"group"</span>, <span class="hljs-string">""</span>, <span class="hljs-keyword">null</span>, KafkaTestUtils.defaultPropertyOverrides());

    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(producer.send(any(), any())).willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">final</span> CountDownLatch closeLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">2</span>);

    willAnswer(i -&gt; {

        closeLatch.countDown();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(producer).close(any());

    ProducerFactory pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(pf.transactionCapable()).willReturn(<span class="hljs-keyword">true</span>);

    willReturn(producer).given(pf).createProducer(isNull());

    KafkaTransactionManager ptm = <span class="hljs-keyword">new</span> KafkaTransactionManager(pf);

    ContainerProperties props = <span class="hljs-keyword">new</span> ContainerProperties(<span class="hljs-string">"foo"</span>);

    props.setGroupId(<span class="hljs-string">"group"</span>);

    props.setKafkaAwareTransactionManager(ptm);

    props.setAssignmentCommitOption(AssignmentCommitOption.ALWAYS);

    <span class="hljs-keyword">final</span> KafkaTemplate template = <span class="hljs-keyword">new</span> KafkaTemplate(pf);

    KafkaMessageListenerContainer container = <span class="hljs-keyword">new</span> KafkaMessageListenerContainer&lt;&gt;(cf, props);

    container.setBeanName(<span class="hljs-string">"commit"</span>);

    KafkaMessageDrivenChannelAdapter inbound = <span class="hljs-keyword">new</span> KafkaMessageDrivenChannelAdapter&lt;&gt;(container);

    DirectChannel channel = <span class="hljs-keyword">new</span> DirectChannel();

    inbound.setOutputChannel(channel);

    KafkaProducerMessageHandler handler = <span class="hljs-keyword">new</span> KafkaProducerMessageHandler(template);

    handler.setMessageKeyExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    handler.setTopicExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"topic"</span>));

    channel.subscribe(handler);

    inbound.afterPropertiesSet();

    inbound.start();

    assertThat(closeLatch.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    InOrder inOrder = inOrder(producer);

    inOrder.verify(producer).beginTransaction();

    inOrder.verify(producer).sendOffsetsToTransaction(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">0</span>)), meta);

    inOrder.verify(producer).commitTransaction();

    inOrder.verify(producer).close(any());

    inOrder.verify(producer).beginTransaction();

    ArgumentCaptor&lt;ProducerRecord&gt; captor = ArgumentCaptor.forClass(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    inOrder.verify(producer).send(captor.capture(), any(Callback<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-keyword">new</span> ProducerRecord(<span class="hljs-string">"topic"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-string">"value"</span>));

    inOrder.verify(producer).sendOffsetsToTransaction(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">1</span>)), meta);

    inOrder.verify(producer).commitTransaction();

    inOrder.verify(producer).close(any());

    container.stop();

    verify(pf, times(<span class="hljs-number">2</span>)).createProducer(isNull());

    verifyNoMoreInteractions(producer);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProducerFactory&lt;?, ?&gt; createMockProducerFactory() {
    ProducerFactory&lt;?, ?&gt; pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(pf.transactionCapable()).willReturn(<span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> pf;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest373">Test Case ID #spring-integration_Test_37_3</h4>
<h4 id="test-case-name-testtransactionsynchfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkaoutboundkafkaproducermessagehandlertestsjava">Test Case Name: <code>testTransactionSynch</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\outbound\KafkaProducerMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-pf">Mock Object Variable Name: <code>pf</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Producer producer = mock(Producer.class);
<span class="hljs-deletion">-    ProducerFactory pf = mock(ProducerFactory.class);</span>
<span class="hljs-deletion">-    given(pf.transactionCapable()).willReturn(true);</span>
<span class="hljs-deletion">-    given(pf.createProducer(isNull())).willReturn(producer);</span>
<span class="hljs-addition">+    ProducerFactory pf = createMockProducerFactory();</span>
<span class="hljs-addition">+    given(pf.createProducer(isNull())).willReturn(producer);</span>
    willReturn(mock(Future.class)).given(producer).send(any(ProducerRecord.class), any(Callback.class));
    KafkaTemplate template = new KafkaTemplate(pf);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testTransactionSynch</span><span class="hljs-params">()</span> </span>{

    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ProducerFactory pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(pf.transactionCapable()).willReturn(<span class="hljs-keyword">true</span>);

    given(pf.createProducer(isNull())).willReturn(producer);

    willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">given</span>(<span class="hljs-title">producer</span>).<span class="hljs-title">send</span>(<span class="hljs-title">any</span>(<span class="hljs-title">ProducerRecord</span>.<span class="hljs-title">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;

    KafkaTemplate template = <span class="hljs-keyword">new</span> KafkaTemplate(pf);

    KafkaProducerMessageHandler handler = <span class="hljs-keyword">new</span> KafkaProducerMessageHandler(template);

    handler.setTopicExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    handler.start();

    <span class="hljs-keyword">try</span> {

        <span class="hljs-keyword">new</span> TransactionTemplate(<span class="hljs-keyword">new</span> SomeOtherTransactionManager()).executeWithoutResult(status -&gt; {

            handler.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>));

            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"test"</span>);

        });

    } <span class="hljs-keyword">catch</span> (IllegalStateException ex) {

    }

    handler.stop();

    verify(producer).beginTransaction();

    verify(producer).send(any(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;

    verify(producer).abortTransaction();

    verify(producer).close(any());

    verifyNoMoreInteractions(producer);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProducerFactory&lt;?, ?&gt; createMockProducerFactory() {
    ProducerFactory&lt;?, ?&gt; pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(pf.transactionCapable()).willReturn(<span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> pf;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci38">Mock Clone Instance #spring-integration_MCI_38</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.amqp.rabbit.connection.ConnectionFactory</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConnectionFactory <span class="hljs-title">createMockConnectionFactory</span><span class="hljs-params">(Connection connection)</span> </span>{
    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(connectionFactory.createConnection()).thenReturn(connection);
    <span class="hljs-keyword">return</span> connectionFactory;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest381">Test Case ID #spring-integration_Test_38_1</h4>
<h4 id="test-case-name-testptpfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpchanneldispatcherhasnosubscriberstestsjava">Test Case Name: <code>testPtP</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\channel\DispatcherHasNoSubscribersTests.java</code>)</h4>
<h4 id="mock-object-variable-name-connectionfactory">Mock Object Variable Name: <code>connectionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    doAnswer(invocation -&gt; channel).when(connection).createChannel(anyBoolean());
<span class="hljs-deletion">-    ConnectionFactory connectionFactory = mock(ConnectionFactory.class);</span>
<span class="hljs-deletion">-    when(connectionFactory.createConnection()).thenReturn(connection);</span>
<span class="hljs-addition">+    ConnectionFactory connectionFactory = createMockConnectionFactory(connection);</span>
    SimpleMessageListenerContainer container = new SimpleMessageListenerContainer();
    container.setConnectionFactory(connectionFactory);
    AmqpTemplate amqpTemplate = mock(AmqpTemplate.class);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testPtP</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-keyword">final</span> Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DeclareOk declareOk = mock(DeclareOk<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(declareOk.getQueue()).thenReturn(<span class="hljs-string">"noSubscribersChannel"</span>);

    when(channel.queueDeclare(anyString(), anyBoolean(), anyBoolean(), anyBoolean(), isNull())).thenReturn(declareOk);

    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    doAnswer(invocation -&gt; channel).when(connection).createChannel(anyBoolean());

    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(connectionFactory.createConnection()).thenReturn(connection);

    SimpleMessageListenerContainer container = <span class="hljs-keyword">new</span> SimpleMessageListenerContainer();

    container.setConnectionFactory(connectionFactory);

    AmqpTemplate amqpTemplate = mock(AmqpTemplate<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    PointToPointSubscribableAmqpChannel amqpChannel = <span class="hljs-keyword">new</span> PointToPointSubscribableAmqpChannel(<span class="hljs-string">"noSubscribersChannel"</span>, container, amqpTemplate);

    amqpChannel.setBeanName(<span class="hljs-string">"noSubscribersChannel"</span>);

    amqpChannel.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    amqpChannel.afterPropertiesSet();

    MessageListener listener = container.getMessageListener();

    assertThatExceptionOfType(MessageDeliveryException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(() -&gt; <span class="hljs-title">listener</span>.<span class="hljs-title">onMessage</span>(<span class="hljs-title">new</span> <span class="hljs-title">Message</span>("<span class="hljs-title">Hello</span> <span class="hljs-title">world</span>!".<span class="hljs-title">getBytes</span>()))).<span class="hljs-title">withMessageContaining</span>("<span class="hljs-title">Dispatcher</span> <span class="hljs-title">has</span> <span class="hljs-title">no</span> <span class="hljs-title">subscribers</span> <span class="hljs-title">for</span> <span class="hljs-title">amqp</span>-<span class="hljs-title">channel</span> '<span class="hljs-title">noSubscribersChannel</span>'.")</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConnectionFactory <span class="hljs-title">createMockConnectionFactory</span><span class="hljs-params">(Connection connection)</span> </span>{
    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(connectionFactory.createConnection()).thenReturn(connection);
    <span class="hljs-keyword">return</span> connectionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest382">Test Case ID #spring-integration_Test_38_2</h4>
<h4 id="test-case-name-testpubsubfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpchanneldispatcherhasnosubscriberstestsjava">Test Case Name: <code>testPubSub</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\channel\DispatcherHasNoSubscribersTests.java</code>)</h4>
<h4 id="mock-object-variable-name-connectionfactory">Mock Object Variable Name: <code>connectionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    doAnswer(invocation -&gt; channel).when(connection).createChannel(anyBoolean());
<span class="hljs-deletion">-    ConnectionFactory connectionFactory = mock(ConnectionFactory.class);</span>
<span class="hljs-deletion">-    when(connectionFactory.createConnection()).thenReturn(connection);</span>
<span class="hljs-addition">+    ConnectionFactory connectionFactory = createMockConnectionFactory(connection);</span>
    SimpleMessageListenerContainer container = new SimpleMessageListenerContainer();
    container.setConnectionFactory(connectionFactory);
    AmqpTemplate amqpTemplate = mock(AmqpTemplate.class);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testPubSub</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    doAnswer(invocation -&gt; channel).when(connection).createChannel(anyBoolean());

    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(connectionFactory.createConnection()).thenReturn(connection);

    SimpleMessageListenerContainer container = <span class="hljs-keyword">new</span> SimpleMessageListenerContainer();

    container.setConnectionFactory(connectionFactory);

    AmqpTemplate amqpTemplate = mock(AmqpTemplate<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    PublishSubscribeAmqpChannel amqpChannel = <span class="hljs-keyword">new</span> PublishSubscribeAmqpChannel(<span class="hljs-string">"noSubscribersChannel"</span>, container, amqpTemplate);

    amqpChannel.setBeanName(<span class="hljs-string">"noSubscribersChannel"</span>);

    amqpChannel.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    amqpChannel.afterPropertiesSet();

    List&lt;String&gt; logList = insertMockLoggerInListener(amqpChannel);

    MessageListener listener = container.getMessageListener();

    listener.onMessage(<span class="hljs-keyword">new</span> Message(<span class="hljs-string">"Hello world!"</span>.getBytes()));

    verifyLogReceived(logList);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConnectionFactory <span class="hljs-title">createMockConnectionFactory</span><span class="hljs-params">(Connection connection)</span> </span>{
    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(connectionFactory.createConnection()).thenReturn(connection);
    <span class="hljs-keyword">return</span> connectionFactory;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci39">Mock Clone Instance #spring-integration_MCI_39</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.amqp.rabbit.connection.ConnectionFactory</code></li>
<li><strong>Test Case Count</strong>: 5</li>
<li><strong>MO Count</strong>: 5</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ConnectionFactory connectionFactory;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
connectionFactory

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest391">Test Case ID #spring-integration_Test_39_1</h4>
<h4 id="test-case-name-testdelayexpressionfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpoutboundoutboundendpointtestsjava">Test Case Name: <code>testDelayExpression</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\outbound\OutboundEndpointTests.java</code>)</h4>
<h4 id="mock-object-variable-name-connectionfactory">Mock Object Variable Name: <code>connectionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testDelayExpression() {
<span class="hljs-deletion">-    ConnectionFactory connectionFactory = mock(ConnectionFactory.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `connectionFactory`</span>
     RabbitTemplate amqpTemplate = spy(new RabbitTemplate(connectionFactory));
     AmqpOutboundEndpoint endpoint = new AmqpOutboundEndpoint(amqpTemplate);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDelayExpression</span><span class="hljs-params">()</span> </span>{

    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RabbitTemplate amqpTemplate = spy(<span class="hljs-keyword">new</span> RabbitTemplate(connectionFactory));

    AmqpOutboundEndpoint endpoint = <span class="hljs-keyword">new</span> AmqpOutboundEndpoint(amqpTemplate);

    willDoNothing().given(amqpTemplate).send(anyString(), anyString(), any(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">isNull</span>())</span>;

    willAnswer(invocation -&gt; invocation.getArgument(<span class="hljs-number">2</span>)).given(amqpTemplate).sendAndReceive(anyString(), anyString(), any(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">isNull</span>())</span>;

    endpoint.setExchangeName(<span class="hljs-string">"foo"</span>);

    endpoint.setRoutingKey(<span class="hljs-string">"bar"</span>);

    endpoint.setDelayExpressionString(<span class="hljs-string">"42"</span>);

    endpoint.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    endpoint.afterPropertiesSet();

    endpoint.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>));

    ArgumentCaptor&lt;Message&gt; captor = ArgumentCaptor.forClass(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(amqpTemplate).send(eq(<span class="hljs-string">"foo"</span>), eq(<span class="hljs-string">"bar"</span>), captor.capture(), isNull());

    assertThat(captor.getValue().getMessageProperties().getDelayLong()).isEqualTo(<span class="hljs-number">42</span>);

    endpoint.setExpectReply(<span class="hljs-keyword">true</span>);

    endpoint.setOutputChannel(<span class="hljs-keyword">new</span> NullChannel());

    endpoint.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>));

    verify(amqpTemplate).sendAndReceive(eq(<span class="hljs-string">"foo"</span>), eq(<span class="hljs-string">"bar"</span>), captor.capture(), isNull());

    assertThat(captor.getValue().getMessageProperties().getDelayLong()).isEqualTo(<span class="hljs-number">42</span>);

    endpoint.setDelay(<span class="hljs-number">23</span>);

    endpoint.setRoutingKey(<span class="hljs-string">"baz"</span>);

    endpoint.afterPropertiesSet();

    endpoint.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>));

    verify(amqpTemplate).sendAndReceive(eq(<span class="hljs-string">"foo"</span>), eq(<span class="hljs-string">"baz"</span>), captor.capture(), isNull());

    assertThat(captor.getValue().getMessageProperties().getDelayLong()).isEqualTo(<span class="hljs-number">23</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ConnectionFactory connectionFactory;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
connectionFactory

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest392">Test Case ID #spring-integration_Test_39_2</h4>
<h4 id="test-case-name-testasyncdelayexpressionfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpoutboundoutboundendpointtestsjava">Test Case Name: <code>testAsyncDelayExpression</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\outbound\OutboundEndpointTests.java</code>)</h4>
<h4 id="mock-object-variable-name-connectionfactory">Mock Object Variable Name: <code>connectionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testAsyncDelayExpression() {
<span class="hljs-deletion">-    ConnectionFactory connectionFactory = mock(ConnectionFactory.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `connectionFactory`</span>
     AsyncRabbitTemplate amqpTemplate = spy(new AsyncRabbitTemplate(new RabbitTemplate(connectionFactory), new SimpleMessageListenerContainer(connectionFactory), "replyTo"));
     amqpTemplate.setTaskScheduler(mock(TaskScheduler.class));
     AsyncAmqpOutboundGateway gateway = new AsyncAmqpOutboundGateway(amqpTemplate);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAsyncDelayExpression</span><span class="hljs-params">()</span> </span>{

    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AsyncRabbitTemplate amqpTemplate = spy(<span class="hljs-keyword">new</span> AsyncRabbitTemplate(<span class="hljs-keyword">new</span> RabbitTemplate(connectionFactory), <span class="hljs-keyword">new</span> SimpleMessageListenerContainer(connectionFactory), <span class="hljs-string">"replyTo"</span>));

    amqpTemplate.setTaskScheduler(mock(TaskScheduler<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    AsyncAmqpOutboundGateway gateway = <span class="hljs-keyword">new</span> AsyncAmqpOutboundGateway(amqpTemplate);

    willReturn(mock(RabbitMessageFuture<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">given</span>(<span class="hljs-title">amqpTemplate</span>).<span class="hljs-title">sendAndReceive</span>(<span class="hljs-title">anyString</span>(), <span class="hljs-title">anyString</span>(), <span class="hljs-title">any</span>(<span class="hljs-title">Message</span>.<span class="hljs-title">class</span>))</span>;

    gateway.setExchangeName(<span class="hljs-string">"foo"</span>);

    gateway.setRoutingKey(<span class="hljs-string">"bar"</span>);

    gateway.setDelayExpressionString(<span class="hljs-string">"42"</span>);

    gateway.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    gateway.setOutputChannel(<span class="hljs-keyword">new</span> NullChannel());

    gateway.afterPropertiesSet();

    gateway.start();

    ArgumentCaptor&lt;Message&gt; captor = ArgumentCaptor.forClass(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    gateway.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>));

    verify(amqpTemplate).sendAndReceive(eq(<span class="hljs-string">"foo"</span>), eq(<span class="hljs-string">"bar"</span>), captor.capture());

    assertThat(captor.getValue().getMessageProperties().getDelayLong()).isEqualTo(<span class="hljs-number">42</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ConnectionFactory connectionFactory;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
connectionFactory

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest393">Test Case ID #spring-integration_Test_39_3</h4>
<h4 id="test-case-name-testheadermapperwinsadapterfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpoutboundoutboundendpointtestsjava">Test Case Name: <code>testHeaderMapperWinsAdapter</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\outbound\OutboundEndpointTests.java</code>)</h4>
<h4 id="mock-object-variable-name-connectionfactory">Mock Object Variable Name: <code>connectionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testHeaderMapperWinsAdapter() {
<span class="hljs-deletion">-    ConnectionFactory connectionFactory = mock(ConnectionFactory.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `connectionFactory`</span>
     RabbitTemplate amqpTemplate = spy(new RabbitTemplate(connectionFactory));
     AmqpOutboundEndpoint endpoint = new AmqpOutboundEndpoint(amqpTemplate);
     endpoint.setHeadersMappedLast(true);
     final AtomicReference&lt;Message&gt; amqpMessage = new AtomicReference&lt;&gt;();
     willAnswer(invocation -&gt; {
         amqpMessage.set(invocation.getArgument(2));
         return null;
     }).given(amqpTemplate).send(isNull(), isNull(), any(Message.class), isNull());
     org.springframework.messaging.Message&lt;?&gt; message = MessageBuilder.withPayload("foo").setHeader(MessageHeaders.CONTENT_TYPE, "bar").build();
     endpoint.handleMessage(message);
     assertThat(amqpMessage.get()).isNotNull();
     assertThat(amqpMessage.get().getMessageProperties().getContentType()).isEqualTo("bar");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHeaderMapperWinsAdapter</span><span class="hljs-params">()</span> </span>{

    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RabbitTemplate amqpTemplate = spy(<span class="hljs-keyword">new</span> RabbitTemplate(connectionFactory));

    AmqpOutboundEndpoint endpoint = <span class="hljs-keyword">new</span> AmqpOutboundEndpoint(amqpTemplate);

    endpoint.setHeadersMappedLast(<span class="hljs-keyword">true</span>);

    <span class="hljs-keyword">final</span> AtomicReference&lt;Message&gt; amqpMessage = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    willAnswer(invocation -&gt; {

        amqpMessage.set(invocation.getArgument(<span class="hljs-number">2</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(amqpTemplate).send(isNull(), isNull(), any(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">isNull</span>())</span>;

    org.springframework.messaging.Message&lt;?&gt; message = MessageBuilder.withPayload(<span class="hljs-string">"foo"</span>).setHeader(MessageHeaders.CONTENT_TYPE, <span class="hljs-string">"bar"</span>).build();

    endpoint.handleMessage(message);

    assertThat(amqpMessage.get()).isNotNull();

    assertThat(amqpMessage.get().getMessageProperties().getContentType()).isEqualTo(<span class="hljs-string">"bar"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ConnectionFactory connectionFactory;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
connectionFactory

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest394">Test Case ID #spring-integration_Test_39_4</h4>
<h4 id="test-case-name-testheadermapperwinsgatewayfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpoutboundoutboundendpointtestsjava">Test Case Name: <code>testHeaderMapperWinsGateway</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\outbound\OutboundEndpointTests.java</code>)</h4>
<h4 id="mock-object-variable-name-connectionfactory">Mock Object Variable Name: <code>connectionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testHeaderMapperWinsGateway() {
<span class="hljs-deletion">-    ConnectionFactory connectionFactory = mock(ConnectionFactory.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `connectionFactory`</span>
     TestRabbitTemplate amqpTemplate = spy(new TestRabbitTemplate(connectionFactory));
     amqpTemplate.setUseTemporaryReplyQueues(true);
     AmqpOutboundEndpoint endpoint = new AmqpOutboundEndpoint(amqpTemplate);
     endpoint.setHeadersMappedLast(true);
     endpoint.setExpectReply(true);
     DefaultAmqpHeaderMapper mapper = DefaultAmqpHeaderMapper.inboundMapper();
     mapper.setRequestHeaderNames("*");
     endpoint.setHeaderMapper(mapper);
     final AtomicReference&lt;Message&gt; amqpMessage = new AtomicReference&lt;&gt;();
     willAnswer(invocation -&gt; {
         amqpMessage.set(invocation.getArgument(2));
         return null;
     }).given(amqpTemplate).doSendAndReceiveWithTemporary(isNull(), isNull(), any(Message.class), isNull());
     org.springframework.messaging.Message&lt;?&gt; message = MessageBuilder.withPayload("foo").setHeader(MessageHeaders.CONTENT_TYPE, "bar").setReplyChannel(new QueueChannel()).build();
     endpoint.handleMessage(message);
     assertThat(amqpMessage.get()).isNotNull();
     assertThat(amqpMessage.get().getMessageProperties().getContentType()).isEqualTo("bar");
     assertThat(amqpMessage.get().getMessageProperties().getHeaders().get(MessageHeaders.REPLY_CHANNEL)).isNull();
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHeaderMapperWinsGateway</span><span class="hljs-params">()</span> </span>{

    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRabbitTemplate amqpTemplate = spy(<span class="hljs-keyword">new</span> TestRabbitTemplate(connectionFactory));

    amqpTemplate.setUseTemporaryReplyQueues(<span class="hljs-keyword">true</span>);

    AmqpOutboundEndpoint endpoint = <span class="hljs-keyword">new</span> AmqpOutboundEndpoint(amqpTemplate);

    endpoint.setHeadersMappedLast(<span class="hljs-keyword">true</span>);

    endpoint.setExpectReply(<span class="hljs-keyword">true</span>);

    DefaultAmqpHeaderMapper mapper = DefaultAmqpHeaderMapper.inboundMapper();

    mapper.setRequestHeaderNames(<span class="hljs-string">"*"</span>);

    endpoint.setHeaderMapper(mapper);

    <span class="hljs-keyword">final</span> AtomicReference&lt;Message&gt; amqpMessage = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    willAnswer(invocation -&gt; {

        amqpMessage.set(invocation.getArgument(<span class="hljs-number">2</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(amqpTemplate).doSendAndReceiveWithTemporary(isNull(), isNull(), any(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">isNull</span>())</span>;

    org.springframework.messaging.Message&lt;?&gt; message = MessageBuilder.withPayload(<span class="hljs-string">"foo"</span>).setHeader(MessageHeaders.CONTENT_TYPE, <span class="hljs-string">"bar"</span>).setReplyChannel(<span class="hljs-keyword">new</span> QueueChannel()).build();

    endpoint.handleMessage(message);

    assertThat(amqpMessage.get()).isNotNull();

    assertThat(amqpMessage.get().getMessageProperties().getContentType()).isEqualTo(<span class="hljs-string">"bar"</span>);

    assertThat(amqpMessage.get().getMessageProperties().getHeaders().get(MessageHeaders.REPLY_CHANNEL)).isNull();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ConnectionFactory connectionFactory;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
connectionFactory

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest395">Test Case ID #spring-integration_Test_39_5</h4>
<h4 id="test-case-name-testreplyheaderswinfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpoutboundoutboundendpointtestsjava">Test Case Name: <code>testReplyHeadersWin</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\outbound\OutboundEndpointTests.java</code>)</h4>
<h4 id="mock-object-variable-name-connectionfactory">Mock Object Variable Name: <code>connectionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testReplyHeadersWin() {
<span class="hljs-deletion">-    ConnectionFactory connectionFactory = mock(ConnectionFactory.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `connectionFactory`</span>
     TestRabbitTemplate amqpTemplate = spy(new TestRabbitTemplate(connectionFactory));
     amqpTemplate.setUseTemporaryReplyQueues(true);
     AmqpOutboundEndpoint endpoint = new AmqpOutboundEndpoint(amqpTemplate);
     endpoint.setExpectReply(true);
     willAnswer(invocation -&gt; org.springframework.amqp.core.MessageBuilder.withBody(new byte[0]).setHeader(AbstractJavaTypeMapper.DEFAULT_CLASSID_FIELD_NAME, String.class.getName()).build()).given(amqpTemplate).doSendAndReceiveWithTemporary(isNull(), isNull(), any(Message.class), isNull());
     QueueChannel replyChannel = new QueueChannel();
     org.springframework.messaging.Message&lt;?&gt; message = MessageBuilder.withPayload("foo").setHeader(JsonHeaders.RESOLVABLE_TYPE, ResolvableType.forClass(Date.class)).setReplyChannel(replyChannel).build();
     endpoint.handleMessage(message);
     org.springframework.messaging.Message&lt;?&gt; receive = replyChannel.receive(10_000);
     assertThat(receive).isNotNull();
     assertThat(receive.getHeaders()).containsEntry(AbstractJavaTypeMapper.DEFAULT_CLASSID_FIELD_NAME, String.class.getName()).containsEntry(JsonHeaders.TYPE_ID, String.class.getName()).containsEntry(JsonHeaders.RESOLVABLE_TYPE, ResolvableType.forClass(String.class));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testReplyHeadersWin</span><span class="hljs-params">()</span> </span>{

    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRabbitTemplate amqpTemplate = spy(<span class="hljs-keyword">new</span> TestRabbitTemplate(connectionFactory));

    amqpTemplate.setUseTemporaryReplyQueues(<span class="hljs-keyword">true</span>);

    AmqpOutboundEndpoint endpoint = <span class="hljs-keyword">new</span> AmqpOutboundEndpoint(amqpTemplate);

    endpoint.setExpectReply(<span class="hljs-keyword">true</span>);

    willAnswer(invocation -&gt; org.springframework.amqp.core.MessageBuilder.withBody(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">0</span>]).setHeader(AbstractJavaTypeMapper.DEFAULT_CLASSID_FIELD_NAME, String<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>()).<span class="hljs-title">build</span>()).<span class="hljs-title">given</span>(<span class="hljs-title">amqpTemplate</span>).<span class="hljs-title">doSendAndReceiveWithTemporary</span>(<span class="hljs-title">isNull</span>(), <span class="hljs-title">isNull</span>(), <span class="hljs-title">any</span>(<span class="hljs-title">Message</span>.<span class="hljs-title">class</span>), <span class="hljs-title">isNull</span>())</span>;

    QueueChannel replyChannel = <span class="hljs-keyword">new</span> QueueChannel();

    org.springframework.messaging.Message&lt;?&gt; message = MessageBuilder.withPayload(<span class="hljs-string">"foo"</span>).setHeader(JsonHeaders.RESOLVABLE_TYPE, ResolvableType.forClass(Date<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">setReplyChannel</span>(<span class="hljs-title">replyChannel</span>).<span class="hljs-title">build</span>()</span>;

    endpoint.handleMessage(message);

    org.springframework.messaging.Message&lt;?&gt; receive = replyChannel.receive(<span class="hljs-number">10_000</span>);

    assertThat(receive).isNotNull();

    assertThat(receive.getHeaders()).containsEntry(AbstractJavaTypeMapper.DEFAULT_CLASSID_FIELD_NAME, String<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>()).<span class="hljs-title">containsEntry</span>(<span class="hljs-title">JsonHeaders</span>.<span class="hljs-title">TYPE_ID</span>, <span class="hljs-title">String</span>.<span class="hljs-title">class</span>.<span class="hljs-title">getName</span>()).<span class="hljs-title">containsEntry</span>(<span class="hljs-title">JsonHeaders</span>.<span class="hljs-title">RESOLVABLE_TYPE</span>, <span class="hljs-title">ResolvableType</span>.<span class="hljs-title">forClass</span>(<span class="hljs-title">String</span>.<span class="hljs-title">class</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ConnectionFactory connectionFactory;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
connectionFactory

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci40">Mock Clone Instance #spring-integration_MCI_40</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.ip.tcp.connection.TcpSocketSupport</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> TcpSocketSupport sockSupp;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    sockSupp = mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
sockSupp

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest401">Test Case ID #spring-integration_Test_40_1</h4>
<h4 id="test-case-name-netcustomserverfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationipdslconnectionfactorytestsjava">Test Case Name: <code>netCustomServer</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\dsl\ConnectionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socksupp">Mock Object Variable Name: <code>sockSupp</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void netCustomServer() {
<span class="hljs-deletion">-    TcpSocketSupport sockSupp = mock(TcpSocketSupport.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `sockSupp`</span>
     TcpNetConnectionSupport conSupp = mock(TcpNetConnectionSupport.class);
     TcpSocketFactorySupport factSupp = mock(TcpSocketFactorySupport.class);
     TcpNetServerConnectionFactory server = Tcp.netServer(0).socketSupport(sockSupp).connectionSupport(conSupp).socketFactorySupport(factSupp).getObject();
     assertThat(TestUtils.getPropertyValue(server, "tcpSocketSupport")).isSameAs(sockSupp);
     assertThat(TestUtils.getPropertyValue(server, "tcpNetConnectionSupport")).isSameAs(conSupp);
     assertThat(TestUtils.getPropertyValue(server, "tcpSocketFactorySupport")).isSameAs(factSupp);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">netCustomServer</span><span class="hljs-params">()</span> </span>{

    TcpSocketSupport sockSupp = mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNetConnectionSupport conSupp = mock(TcpNetConnectionSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpSocketFactorySupport factSupp = mock(TcpSocketFactorySupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNetServerConnectionFactory server = Tcp.netServer(<span class="hljs-number">0</span>).socketSupport(sockSupp).connectionSupport(conSupp).socketFactorySupport(factSupp).getObject();

    assertThat(TestUtils.getPropertyValue(server, <span class="hljs-string">"tcpSocketSupport"</span>)).isSameAs(sockSupp);

    assertThat(TestUtils.getPropertyValue(server, <span class="hljs-string">"tcpNetConnectionSupport"</span>)).isSameAs(conSupp);

    assertThat(TestUtils.getPropertyValue(server, <span class="hljs-string">"tcpSocketFactorySupport"</span>)).isSameAs(factSupp);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> TcpSocketSupport sockSupp;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    sockSupp = mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
sockSupp

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest402">Test Case ID #spring-integration_Test_40_2</h4>
<h4 id="test-case-name-niocustomserverfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationipdslconnectionfactorytestsjava">Test Case Name: <code>nioCustomServer</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\dsl\ConnectionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socksupp">Mock Object Variable Name: <code>sockSupp</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void nioCustomServer() {
<span class="hljs-deletion">-    TcpSocketSupport sockSupp = mock(TcpSocketSupport.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `sockSupp`</span>
     TcpNioConnectionSupport conSupp = mock(TcpNioConnectionSupport.class);
     TcpNioServerConnectionFactory server = Tcp.nioServer(0).socketSupport(sockSupp).directBuffers(true).connectionSupport(conSupp).getObject();
     assertThat(TestUtils.getPropertyValue(server, "tcpSocketSupport")).isSameAs(sockSupp);
     assertThat(TestUtils.getPropertyValue(server, "usingDirectBuffers", Boolean.class)).isTrue();
     assertThat(TestUtils.getPropertyValue(server, "tcpNioConnectionSupport")).isSameAs(conSupp);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">nioCustomServer</span><span class="hljs-params">()</span> </span>{

    TcpSocketSupport sockSupp = mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNioConnectionSupport conSupp = mock(TcpNioConnectionSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNioServerConnectionFactory server = Tcp.nioServer(<span class="hljs-number">0</span>).socketSupport(sockSupp).directBuffers(<span class="hljs-keyword">true</span>).connectionSupport(conSupp).getObject();

    assertThat(TestUtils.getPropertyValue(server, <span class="hljs-string">"tcpSocketSupport"</span>)).isSameAs(sockSupp);

    assertThat(TestUtils.getPropertyValue(server, <span class="hljs-string">"usingDirectBuffers"</span>, Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">isTrue</span>()</span>;

    assertThat(TestUtils.getPropertyValue(server, <span class="hljs-string">"tcpNioConnectionSupport"</span>)).isSameAs(conSupp);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> TcpSocketSupport sockSupp;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    sockSupp = mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
sockSupp

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest403">Test Case ID #spring-integration_Test_40_3</h4>
<h4 id="test-case-name-netcustomclientfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationipdslconnectionfactorytestsjava">Test Case Name: <code>netCustomClient</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\dsl\ConnectionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socksupp">Mock Object Variable Name: <code>sockSupp</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
@Test
void netCustomClient() {
<span class="hljs-deletion">-    TcpSocketSupport sockSupp = mock(TcpSocketSupport.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `sockSupp`</span>
    TcpNetConnectionSupport conSupp = mock(TcpNetConnectionSupport.class);
    TcpSocketFactorySupport factSupp = mock(TcpSocketFactorySupport.class);
    TcpNetClientConnectionFactory client = Tcp.netClient("localhost", 0).socketSupport(sockSupp).connectionSupport(conSupp).socketFactorySupport(factSupp).getObject();
    assertThat(TestUtils.getPropertyValue(client, "tcpSocketSupport")).isSameAs(sockSupp);
    assertThat(TestUtils.getPropertyValue(client, "tcpNetConnectionSupport")).isSameAs(conSupp);
    assertThat(TestUtils.getPropertyValue(client, "tcpSocketFactorySupport")).isSameAs(factSupp);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">netCustomClient</span><span class="hljs-params">()</span> </span>{

    TcpSocketSupport sockSupp = mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNetConnectionSupport conSupp = mock(TcpNetConnectionSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpSocketFactorySupport factSupp = mock(TcpSocketFactorySupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNetClientConnectionFactory client = Tcp.netClient(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">0</span>).socketSupport(sockSupp).connectionSupport(conSupp).socketFactorySupport(factSupp).getObject();

    assertThat(TestUtils.getPropertyValue(client, <span class="hljs-string">"tcpSocketSupport"</span>)).isSameAs(sockSupp);

    assertThat(TestUtils.getPropertyValue(client, <span class="hljs-string">"tcpNetConnectionSupport"</span>)).isSameAs(conSupp);

    assertThat(TestUtils.getPropertyValue(client, <span class="hljs-string">"tcpSocketFactorySupport"</span>)).isSameAs(factSupp);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> TcpSocketSupport sockSupp;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    sockSupp = mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
sockSupp

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest404">Test Case ID #spring-integration_Test_40_4</h4>
<h4 id="test-case-name-niocustomclientfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationipdslconnectionfactorytestsjava">Test Case Name: <code>nioCustomClient</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\dsl\ConnectionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socksupp">Mock Object Variable Name: <code>sockSupp</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void nioCustomClient() {
<span class="hljs-deletion">-    TcpSocketSupport sockSupp = mock(TcpSocketSupport.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `sockSupp`</span>
     TcpNioConnectionSupport conSupp = mock(TcpNioConnectionSupport.class);
     TcpNioClientConnectionFactory client = Tcp.nioClient("localhost", 0).socketSupport(sockSupp).directBuffers(true).connectionSupport(conSupp).getObject();
<span class="hljs-deletion">-    assertThat(TestUtils.getPropertyValue(client, "tcpSocketSupport")).isSameAs(sockSupp);</span>
<span class="hljs-addition">+    assertThat(TestUtils.getPropertyValue(client, "tcpSocketSupport")).isSameAs(sockSupp);</span>
     assertThat(TestUtils.getPropertyValue(client, "usingDirectBuffers", Boolean.class)).isTrue();
     assertThat(TestUtils.getPropertyValue(client, "tcpNioConnectionSupport")).isSameAs(conSupp);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">nioCustomClient</span><span class="hljs-params">()</span> </span>{

    TcpSocketSupport sockSupp = mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNioConnectionSupport conSupp = mock(TcpNioConnectionSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNioClientConnectionFactory client = Tcp.nioClient(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">0</span>).socketSupport(sockSupp).directBuffers(<span class="hljs-keyword">true</span>).connectionSupport(conSupp).getObject();

    assertThat(TestUtils.getPropertyValue(client, <span class="hljs-string">"tcpSocketSupport"</span>)).isSameAs(sockSupp);

    assertThat(TestUtils.getPropertyValue(client, <span class="hljs-string">"usingDirectBuffers"</span>, Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">isTrue</span>()</span>;

    assertThat(TestUtils.getPropertyValue(client, <span class="hljs-string">"tcpNioConnectionSupport"</span>)).isSameAs(conSupp);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> TcpSocketSupport sockSupp;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    sockSupp = mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
sockSupp

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci41">Mock Clone Instance #spring-integration_MCI_41</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.ip.tcp.connection.TcpSocketSupport</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> TcpSocketSupport socketSupport;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    socketSupport = Mockito.mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
socketSupport

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest411">Test Case ID #spring-integration_Test_41_1</h4>
<h4 id="test-case-name-testnetclientfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionsocketsupporttestsjava">Test Case Name: <code>testNetClient</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\SocketSupportTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socketsupport">Mock Object Variable Name: <code>socketSupport</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     when(factory.createSocket()).thenReturn(socket);
<span class="hljs-deletion">-    TcpSocketSupport socketSupport = Mockito.mock(TcpSocketSupport.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `socketSupport`</span>
     TcpNetClientConnectionFactory connectionFactory = new TcpNetClientConnectionFactory("x", 0);
     connectionFactory.setTcpSocketFactorySupport(factorySupport);
     connectionFactory.setTcpSocketSupport(socketSupport);
     connectionFactory.start();
     connectionFactory.getConnection();
<span class="hljs-deletion">-    verify(socketSupport).postProcessSocket(socket);</span>
<span class="hljs-addition">+    verify(socketSupport).postProcessSocket(socket);</span>
     connectionFactory.stop();
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNetClient</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketFactory factory = Mockito.mock(SocketFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factorySupport.getSocketFactory()).thenReturn(factory);

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    InputStream is = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(is.read()).thenReturn(-<span class="hljs-number">1</span>);

    when(socket.getInputStream()).thenReturn(is);

    InetAddress inetAddress = InetAddress.getLocalHost();

    when(socket.getInetAddress()).thenReturn(inetAddress);

    when(factory.createSocket()).thenReturn(socket);

    TcpSocketSupport socketSupport = Mockito.mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNetClientConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> TcpNetClientConnectionFactory(<span class="hljs-string">"x"</span>, <span class="hljs-number">0</span>);

    connectionFactory.setTcpSocketFactorySupport(factorySupport);

    connectionFactory.setTcpSocketSupport(socketSupport);

    connectionFactory.start();

    connectionFactory.getConnection();

    verify(socketSupport).postProcessSocket(socket);

    connectionFactory.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> TcpSocketSupport socketSupport;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    socketSupport = Mockito.mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
socketSupport

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest412">Test Case ID #spring-integration_Test_41_2</h4>
<h4 id="test-case-name-testnetclientsockettimeoutfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionsocketsupporttestsjava">Test Case Name: <code>testNetClientSocketTimeout</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\SocketSupportTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socketsupport">Mock Object Variable Name: <code>socketSupport</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     doThrow(new SocketTimeoutException()).when(socket).connect(any(), eq(1000));
<span class="hljs-deletion">-    TcpSocketSupport socketSupport = Mockito.mock(TcpSocketSupport.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `socketSupport`</span>
     TcpNetClientConnectionFactory connectionFactory = new TcpNetClientConnectionFactory("x", 0);
     connectionFactory.setConnectTimeout(1);
     connectionFactory.setTcpSocketFactorySupport(factorySupport);
     connectionFactory.setTcpSocketSupport(socketSupport);
     connectionFactory.start();
     assertThatThrownBy(connectionFactory::getConnection).isInstanceOf(UncheckedIOException.class).hasCauseInstanceOf(SocketTimeoutException.class);
     connectionFactory.stop();
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNetClientSocketTimeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketFactory factory = Mockito.mock(SocketFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factorySupport.getSocketFactory()).thenReturn(factory);

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    InputStream is = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(is.read()).thenReturn(-<span class="hljs-number">1</span>);

    when(socket.getInputStream()).thenReturn(is);

    InetAddress inetAddress = InetAddress.getLocalHost();

    when(socket.getInetAddress()).thenReturn(inetAddress);

    when(factory.createSocket()).thenReturn(socket);

    doThrow(<span class="hljs-keyword">new</span> SocketTimeoutException()).when(socket).connect(any(), eq(<span class="hljs-number">1000</span>));

    TcpSocketSupport socketSupport = Mockito.mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNetClientConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> TcpNetClientConnectionFactory(<span class="hljs-string">"x"</span>, <span class="hljs-number">0</span>);

    connectionFactory.setConnectTimeout(<span class="hljs-number">1</span>);

    connectionFactory.setTcpSocketFactorySupport(factorySupport);

    connectionFactory.setTcpSocketSupport(socketSupport);

    connectionFactory.start();

    assertThatThrownBy(connectionFactory::getConnection).isInstanceOf(UncheckedIOException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">hasCauseInstanceOf</span>(<span class="hljs-title">SocketTimeoutException</span>.<span class="hljs-title">class</span>)</span>;

    connectionFactory.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> TcpSocketSupport socketSupport;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    socketSupport = Mockito.mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
socketSupport

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest413">Test Case ID #spring-integration_Test_41_3</h4>
<h4 id="test-case-name-testnetserverfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionsocketsupporttestsjava">Test Case Name: <code>testNetServer</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\SocketSupportTests.java</code>)</h4>
<h4 id="mock-object-variable-name-socketsupport">Mock Object Variable Name: <code>socketSupport</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     when(serverSocket.accept()).thenReturn(socket).then(invocation -&gt; {
         if (closed.get()) {
             throw new SocketException();
         }
         latch1.countDown();
         latch2.await(10, TimeUnit.SECONDS);
         Thread.sleep(50);
         return socket1;
     });
<span class="hljs-deletion">-    TcpSocketSupport socketSupport = mock(TcpSocketSupport.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `socketSupport`</span>
     TcpNetServerConnectionFactory connectionFactory = new TcpNetServerConnectionFactory(0);
     connectionFactory.setTcpSocketFactorySupport(factorySupport);
     connectionFactory.setTcpSocketSupport(socketSupport);
     connectionFactory.registerListener(mock(TcpListener.class));
     connectionFactory.start();
     assertThat(latch1.await(10, TimeUnit.SECONDS)).isTrue();
<span class="hljs-deletion">-    verify(socketSupport).postProcessServerSocket(serverSocket);</span>
<span class="hljs-addition">+    verify(socketSupport).postProcessServerSocket(serverSocket);</span>
<span class="hljs-deletion">-    verify(socketSupport).postProcessSocket(socket);</span>
<span class="hljs-addition">+    verify(socketSupport).postProcessSocket(socket);</span>
     latch2.countDown();
     connectionFactory.stop();
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNetServer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServerSocketFactory factory = mock(ServerSocketFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factorySupport.getServerSocketFactory()).thenReturn(factory);

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Socket socket1 = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    InputStream is = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(is.read()).thenReturn(-<span class="hljs-number">1</span>);

    when(socket.getInputStream()).thenReturn(is);

    when(socket1.getInputStream()).thenReturn(is);

    InetAddress inetAddress = InetAddress.getLocalHost();

    when(socket.getInetAddress()).thenReturn(inetAddress);

    when(socket1.getInetAddress()).thenReturn(inetAddress);

    ServerSocket serverSocket = mock(ServerSocket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AtomicBoolean closed = <span class="hljs-keyword">new</span> AtomicBoolean();

    doAnswer(invoc -&gt; {

        closed.set(<span class="hljs-keyword">true</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(serverSocket).close();

    when(serverSocket.getInetAddress()).thenReturn(inetAddress);

    when(factory.createServerSocket(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>)).thenReturn(serverSocket);

    <span class="hljs-keyword">final</span> CountDownLatch latch1 = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">final</span> CountDownLatch latch2 = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    when(serverSocket.accept()).thenReturn(socket).then(invocation -&gt; {

        <span class="hljs-keyword">if</span> (closed.get()) {

            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> SocketException();

        }

        latch1.countDown();

        latch2.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS);

        Thread.sleep(<span class="hljs-number">50</span>);

        <span class="hljs-keyword">return</span> socket1;

    });

    TcpSocketSupport socketSupport = mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNetServerConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> TcpNetServerConnectionFactory(<span class="hljs-number">0</span>);

    connectionFactory.setTcpSocketFactorySupport(factorySupport);

    connectionFactory.setTcpSocketSupport(socketSupport);

    connectionFactory.registerListener(mock(TcpListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    connectionFactory.start();

    assertThat(latch1.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    verify(socketSupport).postProcessServerSocket(serverSocket);

    verify(socketSupport).postProcessSocket(socket);

    latch2.countDown();

    connectionFactory.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> TcpSocketSupport socketSupport;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    socketSupport = Mockito.mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
socketSupport

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci42">Mock Clone Instance #spring-integration_MCI_42</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.messaging.support.ChannelInterceptor</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ChannelInterceptor channelInterceptor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    channelInterceptor = mock(ChannelInterceptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
channelInterceptor;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest421">Test Case ID #spring-integration_Test_42_1</h4>
<h4 id="test-case-name-testprocessorwithinterceptordefaultpatternfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationconfigglobalchannelinterceptorprocessortestsjava">Test Case Name: <code>testProcessorWithInterceptorDefaultPattern</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\config\GlobalChannelInterceptorProcessorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-channelinterceptor">Mock Object Variable Name: <code>channelInterceptor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testProcessorWithInterceptorDefaultPattern() {
     Map&lt;String, GlobalChannelInterceptorWrapper&gt; interceptors = new HashMap&lt;&gt;();
     Map&lt;String, InterceptableChannel&gt; channels = new HashMap&lt;&gt;();
<span class="hljs-deletion">-    ChannelInterceptor channelInterceptor = mock();</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `channelInterceptor`</span>
     GlobalChannelInterceptorWrapper globalChannelInterceptorWrapper = new GlobalChannelInterceptorWrapper(channelInterceptor);
     InterceptableChannel channel = mock();
     interceptors.put("Test-1", globalChannelInterceptorWrapper);
     channels.put("Test-1", channel);
     when(this.beanFactory.getBeansOfType(GlobalChannelInterceptorWrapper.class)).thenReturn(interceptors);
     when(this.beanFactory.getBeansOfType(InterceptableChannel.class)).thenReturn(channels);
     this.globalChannelInterceptorProcessor.afterSingletonsInstantiated();
     verify(channel).addInterceptor(channelInterceptor);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcessorWithInterceptorDefaultPattern</span><span class="hljs-params">()</span> </span>{

    Map&lt;String, GlobalChannelInterceptorWrapper&gt; interceptors = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    Map&lt;String, InterceptableChannel&gt; channels = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ChannelInterceptor channelInterceptor = mock();

    GlobalChannelInterceptorWrapper globalChannelInterceptorWrapper = <span class="hljs-keyword">new</span> GlobalChannelInterceptorWrapper(channelInterceptor);

    InterceptableChannel channel = mock();

    interceptors.put(<span class="hljs-string">"Test-1"</span>, globalChannelInterceptorWrapper);

    channels.put(<span class="hljs-string">"Test-1"</span>, channel);

    when(<span class="hljs-keyword">this</span>.beanFactory.getBeansOfType(GlobalChannelInterceptorWrapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">interceptors</span>)</span>;

    when(<span class="hljs-keyword">this</span>.beanFactory.getBeansOfType(InterceptableChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">channels</span>)</span>;

    <span class="hljs-keyword">this</span>.globalChannelInterceptorProcessor.afterSingletonsInstantiated();

    verify(channel).addInterceptor(channelInterceptor);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ChannelInterceptor channelInterceptor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    channelInterceptor = mock(ChannelInterceptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
channelInterceptor;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest422">Test Case ID #spring-integration_Test_42_2</h4>
<h4 id="test-case-name-testprocessorwithinterceptormatchingpatternfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationconfigglobalchannelinterceptorprocessortestsjava">Test Case Name: <code>testProcessorWithInterceptorMatchingPattern</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\config\GlobalChannelInterceptorProcessorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-channelinterceptor">Mock Object Variable Name: <code>channelInterceptor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testProcessorWithInterceptorMatchingPattern() {
     Map&lt;String, GlobalChannelInterceptorWrapper&gt; interceptors = new HashMap&lt;&gt;();
     Map&lt;String, InterceptableChannel&gt; channels = new HashMap&lt;&gt;();
<span class="hljs-deletion">-    ChannelInterceptor channelInterceptor = mock();</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `channelInterceptor`</span>
     GlobalChannelInterceptorWrapper globalChannelInterceptorWrapper = new GlobalChannelInterceptorWrapper(channelInterceptor);
     InterceptableChannel channel = mock();
     globalChannelInterceptorWrapper.setPatterns(new String[] { "Te*" });
     interceptors.put("Test-1", globalChannelInterceptorWrapper);
     channels.put("Test-1", channel);
     when(this.beanFactory.getBeansOfType(GlobalChannelInterceptorWrapper.class)).thenReturn(interceptors);
     when(this.beanFactory.getBeansOfType(InterceptableChannel.class)).thenReturn(channels);
     this.globalChannelInterceptorProcessor.afterSingletonsInstantiated();
     verify(channel).addInterceptor(channelInterceptor);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcessorWithInterceptorMatchingPattern</span><span class="hljs-params">()</span> </span>{

    Map&lt;String, GlobalChannelInterceptorWrapper&gt; interceptors = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    Map&lt;String, InterceptableChannel&gt; channels = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ChannelInterceptor channelInterceptor = mock();

    GlobalChannelInterceptorWrapper globalChannelInterceptorWrapper = <span class="hljs-keyword">new</span> GlobalChannelInterceptorWrapper(channelInterceptor);

    InterceptableChannel channel = mock();

    globalChannelInterceptorWrapper.setPatterns(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"Te*"</span> });

    interceptors.put(<span class="hljs-string">"Test-1"</span>, globalChannelInterceptorWrapper);

    channels.put(<span class="hljs-string">"Test-1"</span>, channel);

    when(<span class="hljs-keyword">this</span>.beanFactory.getBeansOfType(GlobalChannelInterceptorWrapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">interceptors</span>)</span>;

    when(<span class="hljs-keyword">this</span>.beanFactory.getBeansOfType(InterceptableChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">channels</span>)</span>;

    <span class="hljs-keyword">this</span>.globalChannelInterceptorProcessor.afterSingletonsInstantiated();

    verify(channel).addInterceptor(channelInterceptor);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ChannelInterceptor channelInterceptor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    channelInterceptor = mock(ChannelInterceptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
channelInterceptor;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest423">Test Case ID #spring-integration_Test_42_3</h4>
<h4 id="test-case-name-testprocessorwithinterceptornotmatchingpatternfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationconfigglobalchannelinterceptorprocessortestsjava">Test Case Name: <code>testProcessorWithInterceptorNotMatchingPattern</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\config\GlobalChannelInterceptorProcessorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-channelinterceptor">Mock Object Variable Name: <code>channelInterceptor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testProcessorWithInterceptorNotMatchingPattern() {
     Map&lt;String, GlobalChannelInterceptorWrapper&gt; interceptors = new HashMap&lt;&gt;();
     Map&lt;String, InterceptableChannel&gt; channels = new HashMap&lt;&gt;();
<span class="hljs-deletion">-    ChannelInterceptor channelInterceptor = mock();</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `channelInterceptor`</span>
     GlobalChannelInterceptorWrapper globalChannelInterceptorWrapper = new GlobalChannelInterceptorWrapper(channelInterceptor);
     InterceptableChannel channel = mock();
     globalChannelInterceptorWrapper.setPatterns(new String[] { "te*" });
     interceptors.put("Test-1", globalChannelInterceptorWrapper);
     channels.put("Test-1", channel);
     when(this.beanFactory.getBeansOfType(GlobalChannelInterceptorWrapper.class)).thenReturn(interceptors);
     when(this.beanFactory.getBeansOfType(InterceptableChannel.class)).thenReturn(channels);
     this.globalChannelInterceptorProcessor.afterSingletonsInstantiated();
<span class="hljs-deletion">-    verify(channel, never()).addInterceptor(channelInterceptor);</span>
<span class="hljs-addition">+    verify(channel, never()).addInterceptor(channelInterceptor);</span>
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcessorWithInterceptorNotMatchingPattern</span><span class="hljs-params">()</span> </span>{

    Map&lt;String, GlobalChannelInterceptorWrapper&gt; interceptors = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    Map&lt;String, InterceptableChannel&gt; channels = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ChannelInterceptor channelInterceptor = mock();

    GlobalChannelInterceptorWrapper globalChannelInterceptorWrapper = <span class="hljs-keyword">new</span> GlobalChannelInterceptorWrapper(channelInterceptor);

    InterceptableChannel channel = mock();

    globalChannelInterceptorWrapper.setPatterns(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"te*"</span> });

    interceptors.put(<span class="hljs-string">"Test-1"</span>, globalChannelInterceptorWrapper);

    channels.put(<span class="hljs-string">"Test-1"</span>, channel);

    when(<span class="hljs-keyword">this</span>.beanFactory.getBeansOfType(GlobalChannelInterceptorWrapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">interceptors</span>)</span>;

    when(<span class="hljs-keyword">this</span>.beanFactory.getBeansOfType(InterceptableChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">channels</span>)</span>;

    <span class="hljs-keyword">this</span>.globalChannelInterceptorProcessor.afterSingletonsInstantiated();

    verify(channel, never()).addInterceptor(channelInterceptor);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ChannelInterceptor channelInterceptor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    channelInterceptor = mock(ChannelInterceptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
channelInterceptor;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest424">Test Case ID #spring-integration_Test_42_4</h4>
<h4 id="test-case-name-testprocessorwithinterceptormatchingnegativepatternfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationconfigglobalchannelinterceptorprocessortestsjava">Test Case Name: <code>testProcessorWithInterceptorMatchingNegativePattern</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\config\GlobalChannelInterceptorProcessorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-channelinterceptor">Mock Object Variable Name: <code>channelInterceptor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testProcessorWithInterceptorMatchingNegativePattern() {
     Map&lt;String, GlobalChannelInterceptorWrapper&gt; interceptors = new HashMap&lt;&gt;();
     Map&lt;String, InterceptableChannel&gt; channels = new HashMap&lt;&gt;();
<span class="hljs-deletion">-    ChannelInterceptor channelInterceptor = mock();</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `channelInterceptor`</span>
     GlobalChannelInterceptorWrapper globalChannelInterceptorWrapper = new GlobalChannelInterceptorWrapper(channelInterceptor);
     InterceptableChannel channel = mock();
     globalChannelInterceptorWrapper.setPatterns(new String[] { "!te*", "!Te*" });
     interceptors.put("Test-1", globalChannelInterceptorWrapper);
     channels.put("Test-1", channel);
     when(this.beanFactory.getBeansOfType(GlobalChannelInterceptorWrapper.class)).thenReturn(interceptors);
     when(this.beanFactory.getBeansOfType(InterceptableChannel.class)).thenReturn(channels);
     this.globalChannelInterceptorProcessor.afterSingletonsInstantiated();
     verify(channel, never()).addInterceptor(channelInterceptor);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcessorWithInterceptorMatchingNegativePattern</span><span class="hljs-params">()</span> </span>{

    Map&lt;String, GlobalChannelInterceptorWrapper&gt; interceptors = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    Map&lt;String, InterceptableChannel&gt; channels = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ChannelInterceptor channelInterceptor = mock();

    GlobalChannelInterceptorWrapper globalChannelInterceptorWrapper = <span class="hljs-keyword">new</span> GlobalChannelInterceptorWrapper(channelInterceptor);

    InterceptableChannel channel = mock();

    globalChannelInterceptorWrapper.setPatterns(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"!te*"</span>, <span class="hljs-string">"!Te*"</span> });

    interceptors.put(<span class="hljs-string">"Test-1"</span>, globalChannelInterceptorWrapper);

    channels.put(<span class="hljs-string">"Test-1"</span>, channel);

    when(<span class="hljs-keyword">this</span>.beanFactory.getBeansOfType(GlobalChannelInterceptorWrapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">interceptors</span>)</span>;

    when(<span class="hljs-keyword">this</span>.beanFactory.getBeansOfType(InterceptableChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">channels</span>)</span>;

    <span class="hljs-keyword">this</span>.globalChannelInterceptorProcessor.afterSingletonsInstantiated();

    verify(channel, never()).addInterceptor(channelInterceptor);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ChannelInterceptor channelInterceptor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    channelInterceptor = mock(ChannelInterceptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
channelInterceptor;

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci43">Mock Clone Instance #spring-integration_MCI_43</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.web.socket.WebSocketSession</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> WebSocketSession <span class="hljs-title">createMockWebSocketSession</span><span class="hljs-params">(String protocol, String secondReturn)</span> </span>{
    WebSocketSession session = mock(WebSocketSession<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(session.getAcceptedProtocol()).thenReturn(protocol, secondReturn);
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest431">Test Case ID #spring-integration_Test_43_1</h4>
<h4 id="test-case-name-testprotocolhandlersfile-cjavaprojectsspringspring-integrationspring-integration-websocketsrctestjavaorgspringframeworkintegrationwebsocketsupportsubprotocolhandlerregistrytestsjava">Test Case Name: <code>testProtocolHandlers</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-websocket\src\test\java\org\springframework\integration\websocket\support\SubProtocolHandlerRegistryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SubProtocolHandler defaultProtocolHandler = mock(SubProtocolHandler.class);
    SubProtocolHandlerRegistry subProtocolHandlerRegistry = new SubProtocolHandlerRegistry(Collections.singletonList(new StompSubProtocolHandler()), defaultProtocolHandler);
<span class="hljs-deletion">-    WebSocketSession session = mock(WebSocketSession.class);</span>
<span class="hljs-deletion">-    when(session.getAcceptedProtocol()).thenReturn("v10.stomp", (String) null);</span>
<span class="hljs-addition">+    WebSocketSession session = createMockWebSocketSession("v10.stomp", (String) null);</span>
    SubProtocolHandler protocolHandler = subProtocolHandlerRegistry.findProtocolHandler(session);
    assertThat(protocolHandler).isNotNull();
    assertThat(protocolHandler).isInstanceOf(StompSubProtocolHandler.class);
    protocolHandler = subProtocolHandlerRegistry.findProtocolHandler(session);
    assertThat(protocolHandler).isNotNull();
    assertThat(defaultProtocolHandler).isSameAs(protocolHandler);
    assertThat(new StompSubProtocolHandler().getSupportedProtocols()).isEqualTo(subProtocolHandlerRegistry.getSubProtocols());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProtocolHandlers</span><span class="hljs-params">()</span> </span>{

    SubProtocolHandler defaultProtocolHandler = mock(SubProtocolHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SubProtocolHandlerRegistry subProtocolHandlerRegistry = <span class="hljs-keyword">new</span> SubProtocolHandlerRegistry(Collections.singletonList(<span class="hljs-keyword">new</span> StompSubProtocolHandler()), defaultProtocolHandler);

    WebSocketSession session = mock(WebSocketSession<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(session.getAcceptedProtocol()).thenReturn(<span class="hljs-string">"v10.stomp"</span>, (String) <span class="hljs-keyword">null</span>);

    SubProtocolHandler protocolHandler = subProtocolHandlerRegistry.findProtocolHandler(session);

    assertThat(protocolHandler).isNotNull();

    assertThat(protocolHandler).isInstanceOf(StompSubProtocolHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    protocolHandler = subProtocolHandlerRegistry.findProtocolHandler(session);

    assertThat(protocolHandler).isNotNull();

    assertThat(defaultProtocolHandler).isSameAs(protocolHandler);

    assertThat(<span class="hljs-keyword">new</span> StompSubProtocolHandler().getSupportedProtocols()).isEqualTo(subProtocolHandlerRegistry.getSubProtocols());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> WebSocketSession <span class="hljs-title">createMockWebSocketSession</span><span class="hljs-params">(String protocol, String secondReturn)</span> </span>{
    WebSocketSession session = mock(WebSocketSession<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(session.getAcceptedProtocol()).thenReturn(protocol, secondReturn);
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest432">Test Case ID #spring-integration_Test_43_2</h4>
<h4 id="test-case-name-testsinglehandlerfile-cjavaprojectsspringspring-integrationspring-integration-websocketsrctestjavaorgspringframeworkintegrationwebsocketsupportsubprotocolhandlerregistrytestsjava">Test Case Name: <code>testSingleHandler</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-websocket\src\test\java\org\springframework\integration\websocket\support\SubProtocolHandlerRegistryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SubProtocolHandlerRegistry subProtocolHandlerRegistry = new SubProtocolHandlerRegistry(Collections.singletonList(testProtocolHandler));
<span class="hljs-deletion">-    WebSocketSession session = mock(WebSocketSession.class);</span>
<span class="hljs-deletion">-    when(session.getAcceptedProtocol()).thenReturn("foo", (String) null);</span>
<span class="hljs-addition">+    WebSocketSession session = createMockWebSocketSession("foo", (String) null);</span>
    SubProtocolHandler protocolHandler = subProtocolHandlerRegistry.findProtocolHandler(session);
    assertThat(protocolHandler).isNotNull();
    assertThat(testProtocolHandler).isSameAs(protocolHandler);
    protocolHandler = subProtocolHandlerRegistry.findProtocolHandler(session);
    assertThat(protocolHandler).isNotNull();
    assertThat(testProtocolHandler).isSameAs(protocolHandler);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSingleHandler</span><span class="hljs-params">()</span> </span>{

    SubProtocolHandler testProtocolHandler = spy(<span class="hljs-keyword">new</span> StompSubProtocolHandler());

    when(testProtocolHandler.getSupportedProtocols()).thenReturn(Collections.singletonList(<span class="hljs-string">"foo"</span>));

    SubProtocolHandlerRegistry subProtocolHandlerRegistry = <span class="hljs-keyword">new</span> SubProtocolHandlerRegistry(Collections.singletonList(testProtocolHandler));

    WebSocketSession session = mock(WebSocketSession<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(session.getAcceptedProtocol()).thenReturn(<span class="hljs-string">"foo"</span>, (String) <span class="hljs-keyword">null</span>);

    SubProtocolHandler protocolHandler = subProtocolHandlerRegistry.findProtocolHandler(session);

    assertThat(protocolHandler).isNotNull();

    assertThat(testProtocolHandler).isSameAs(protocolHandler);

    protocolHandler = subProtocolHandlerRegistry.findProtocolHandler(session);

    assertThat(protocolHandler).isNotNull();

    assertThat(testProtocolHandler).isSameAs(protocolHandler);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> WebSocketSession <span class="hljs-title">createMockWebSocketSession</span><span class="hljs-params">(String protocol, String secondReturn)</span> </span>{
    WebSocketSession session = mock(WebSocketSession<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(session.getAcceptedProtocol()).thenReturn(protocol, secondReturn);
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci44">Mock Clone Instance #spring-integration_MCI_44</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.kafka.core.ConsumerFactory</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConsumerFactory&lt;String, String&gt; <span class="hljs-title">createMockConsumerFactory</span><span class="hljs-params">(Consumer&lt;String, String&gt; mockConsumer)</span> </span>{
    ConsumerFactory&lt;String, String&gt; cf = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(mockConsumer).given(cf).createConsumer(<span class="hljs-string">"group"</span>, <span class="hljs-string">""</span>, <span class="hljs-keyword">null</span>, KafkaTestUtils.defaultPropertyOverrides());
    <span class="hljs-keyword">return</span> cf;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest441">Test Case ID #spring-integration_Test_44_1</h4>
<h4 id="test-case-name-testconsumeandproducetransactionfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkaoutboundkafkaproducermessagehandlertestsjava">Test Case Name: <code>testConsumeAndProduceTransaction</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\outbound\KafkaProducerMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-cf">Mock Object Variable Name: <code>cf</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    given(mockConsumer.groupMetadata()).willReturn(meta);
<span class="hljs-deletion">-    ConsumerFactory cf = mock(ConsumerFactory.class);</span>
<span class="hljs-deletion">-    willReturn(mockConsumer).given(cf).createConsumer("group", "", null, KafkaTestUtils.defaultPropertyOverrides());</span>
<span class="hljs-addition">+    ConsumerFactory cf = createMockConsumerFactory(mockConsumer);</span>
    Producer producer = mock(Producer.class);
    given(producer.send(any(), any())).willReturn(mock(Future.class));
    final CountDownLatch closeLatch = new CountDownLatch(2);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"unchecked"</span>, <span class="hljs-string">"rawtypes"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumeAndProduceTransaction</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Consumer mockConsumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    willAnswer(i -&gt; {

        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(mockConsumer).subscribe(any(Collection<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">ConsumerRebalanceListener</span>.<span class="hljs-title">class</span>))</span>;

    ConsumerRecords records = <span class="hljs-keyword">new</span> ConsumerRecords(Collections.singletonMap(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord&lt;&gt;(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>))));

    <span class="hljs-keyword">final</span> AtomicBoolean done = <span class="hljs-keyword">new</span> AtomicBoolean();

    willAnswer(i -&gt; {

        <span class="hljs-keyword">if</span> (done.compareAndSet(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>)) {

            <span class="hljs-keyword">return</span> records;

        } <span class="hljs-keyword">else</span> {

            Thread.sleep(<span class="hljs-number">500</span>);

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

        }

    }).given(mockConsumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ConsumerGroupMetadata meta = <span class="hljs-keyword">new</span> ConsumerGroupMetadata(<span class="hljs-string">"group"</span>);

    given(mockConsumer.groupMetadata()).willReturn(meta);

    ConsumerFactory cf = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(mockConsumer).given(cf).createConsumer(<span class="hljs-string">"group"</span>, <span class="hljs-string">""</span>, <span class="hljs-keyword">null</span>, KafkaTestUtils.defaultPropertyOverrides());

    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(producer.send(any(), any())).willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">final</span> CountDownLatch closeLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">2</span>);

    willAnswer(i -&gt; {

        closeLatch.countDown();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(producer).close(any());

    ProducerFactory pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(pf.transactionCapable()).willReturn(<span class="hljs-keyword">true</span>);

    willReturn(producer).given(pf).createProducer(isNull());

    KafkaTransactionManager ptm = <span class="hljs-keyword">new</span> KafkaTransactionManager(pf);

    ContainerProperties props = <span class="hljs-keyword">new</span> ContainerProperties(<span class="hljs-string">"foo"</span>);

    props.setGroupId(<span class="hljs-string">"group"</span>);

    props.setKafkaAwareTransactionManager(ptm);

    props.setAssignmentCommitOption(AssignmentCommitOption.ALWAYS);

    <span class="hljs-keyword">final</span> KafkaTemplate template = <span class="hljs-keyword">new</span> KafkaTemplate(pf);

    KafkaMessageListenerContainer container = <span class="hljs-keyword">new</span> KafkaMessageListenerContainer&lt;&gt;(cf, props);

    container.setBeanName(<span class="hljs-string">"commit"</span>);

    KafkaMessageDrivenChannelAdapter inbound = <span class="hljs-keyword">new</span> KafkaMessageDrivenChannelAdapter&lt;&gt;(container);

    DirectChannel channel = <span class="hljs-keyword">new</span> DirectChannel();

    inbound.setOutputChannel(channel);

    KafkaProducerMessageHandler handler = <span class="hljs-keyword">new</span> KafkaProducerMessageHandler(template);

    handler.setMessageKeyExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    handler.setTopicExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"topic"</span>));

    channel.subscribe(handler);

    inbound.afterPropertiesSet();

    inbound.start();

    assertThat(closeLatch.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    InOrder inOrder = inOrder(producer);

    inOrder.verify(producer).beginTransaction();

    inOrder.verify(producer).sendOffsetsToTransaction(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">0</span>)), meta);

    inOrder.verify(producer).commitTransaction();

    inOrder.verify(producer).close(any());

    inOrder.verify(producer).beginTransaction();

    ArgumentCaptor&lt;ProducerRecord&gt; captor = ArgumentCaptor.forClass(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    inOrder.verify(producer).send(captor.capture(), any(Callback<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-keyword">new</span> ProducerRecord(<span class="hljs-string">"topic"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-string">"value"</span>));

    inOrder.verify(producer).sendOffsetsToTransaction(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">1</span>)), meta);

    inOrder.verify(producer).commitTransaction();

    inOrder.verify(producer).close(any());

    container.stop();

    verify(pf, times(<span class="hljs-number">2</span>)).createProducer(isNull());

    verifyNoMoreInteractions(producer);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConsumerFactory&lt;String, String&gt; <span class="hljs-title">createMockConsumerFactory</span><span class="hljs-params">(Consumer&lt;String, String&gt; mockConsumer)</span> </span>{
    ConsumerFactory&lt;String, String&gt; cf = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(mockConsumer).given(cf).createConsumer(<span class="hljs-string">"group"</span>, <span class="hljs-string">""</span>, <span class="hljs-keyword">null</span>, KafkaTestUtils.defaultPropertyOverrides());
    <span class="hljs-keyword">return</span> cf;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest442">Test Case ID #spring-integration_Test_44_2</h4>
<h4 id="test-case-name-testconsumeandproducetransactiontxidoverridefile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkaoutboundkafkaproducermessagehandlertestsjava">Test Case Name: <code>testConsumeAndProduceTransactionTxIdOverride</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\outbound\KafkaProducerMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-cf">Mock Object Variable Name: <code>cf</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    given(mockConsumer.groupMetadata()).willReturn(meta);
<span class="hljs-deletion">-    ConsumerFactory cf = mock(ConsumerFactory.class);</span>
<span class="hljs-deletion">-    willReturn(mockConsumer).given(cf).createConsumer("group", "", null, KafkaTestUtils.defaultPropertyOverrides());</span>
<span class="hljs-addition">+    ConsumerFactory cf = createMockConsumerFactory(mockConsumer);</span>
    Producer producer = mock(Producer.class);
    given(producer.send(any(), any())).willReturn(mock(Future.class));
    final CountDownLatch closeLatch = new CountDownLatch(2);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"unchecked"</span>, <span class="hljs-string">"rawtypes"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumeAndProduceTransactionTxIdOverride</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Consumer mockConsumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    willAnswer(i -&gt; {

        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(mockConsumer).subscribe(any(Collection<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">ConsumerRebalanceListener</span>.<span class="hljs-title">class</span>))</span>;

    ConsumerRecords records = <span class="hljs-keyword">new</span> ConsumerRecords(Collections.singletonMap(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord&lt;&gt;(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>))));

    <span class="hljs-keyword">final</span> AtomicBoolean done = <span class="hljs-keyword">new</span> AtomicBoolean();

    willAnswer(i -&gt; {

        <span class="hljs-keyword">if</span> (done.compareAndSet(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>)) {

            <span class="hljs-keyword">return</span> records;

        } <span class="hljs-keyword">else</span> {

            Thread.sleep(<span class="hljs-number">500</span>);

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

        }

    }).given(mockConsumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ConsumerGroupMetadata meta = <span class="hljs-keyword">new</span> ConsumerGroupMetadata(<span class="hljs-string">"group"</span>);

    given(mockConsumer.groupMetadata()).willReturn(meta);

    ConsumerFactory cf = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(mockConsumer).given(cf).createConsumer(<span class="hljs-string">"group"</span>, <span class="hljs-string">""</span>, <span class="hljs-keyword">null</span>, KafkaTestUtils.defaultPropertyOverrides());

    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(producer.send(any(), any())).willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">final</span> CountDownLatch closeLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">2</span>);

    willAnswer(i -&gt; {

        closeLatch.countDown();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(producer).close(any());

    AtomicReference&lt;String&gt; txId = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    DefaultKafkaProducerFactory pf = <span class="hljs-keyword">new</span> DefaultKafkaProducerFactory(Collections.emptyMap()) {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">protected</span> Producer <span class="hljs-title">createTransactionalProducer</span><span class="hljs-params">(String txIdPrefix)</span> </span>{

            txId.set(txIdPrefix);

            <span class="hljs-keyword">return</span> producer;

        }

    };

    pf.setTransactionIdPrefix(<span class="hljs-string">"default.tx.id."</span>);

    KafkaTransactionManager tm = <span class="hljs-keyword">new</span> KafkaTransactionManager(pf);

    tm.setTransactionIdPrefix(<span class="hljs-string">"tm.tx.id."</span>);

    ContainerProperties props = <span class="hljs-keyword">new</span> ContainerProperties(<span class="hljs-string">"foo"</span>);

    props.setGroupId(<span class="hljs-string">"group"</span>);

    props.setKafkaAwareTransactionManager(tm);

    props.setAssignmentCommitOption(AssignmentCommitOption.ALWAYS);

    <span class="hljs-keyword">final</span> KafkaTemplate template = <span class="hljs-keyword">new</span> KafkaTemplate(pf);

    template.setTransactionIdPrefix(<span class="hljs-string">"template.tx.id."</span>);

    KafkaMessageListenerContainer container = <span class="hljs-keyword">new</span> KafkaMessageListenerContainer&lt;&gt;(cf, props);

    container.setBeanName(<span class="hljs-string">"commit"</span>);

    KafkaMessageDrivenChannelAdapter inbound = <span class="hljs-keyword">new</span> KafkaMessageDrivenChannelAdapter&lt;&gt;(container);

    DirectChannel channel = <span class="hljs-keyword">new</span> DirectChannel();

    inbound.setOutputChannel(channel);

    KafkaProducerMessageHandler handler = <span class="hljs-keyword">new</span> KafkaProducerMessageHandler(template);

    handler.setMessageKeyExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    handler.setTopicExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"topic"</span>));

    channel.subscribe(handler);

    inbound.afterPropertiesSet();

    inbound.start();

    assertThat(closeLatch.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    InOrder inOrder = inOrder(producer);

    inOrder.verify(producer).beginTransaction();

    inOrder.verify(producer).sendOffsetsToTransaction(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">0</span>)), meta);

    inOrder.verify(producer).commitTransaction();

    inOrder.verify(producer).close(any());

    inOrder.verify(producer).beginTransaction();

    ArgumentCaptor&lt;ProducerRecord&gt; captor = ArgumentCaptor.forClass(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    inOrder.verify(producer).send(captor.capture(), any(Callback<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-keyword">new</span> ProducerRecord(<span class="hljs-string">"topic"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-string">"value"</span>));

    inOrder.verify(producer).sendOffsetsToTransaction(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">1</span>)), meta);

    inOrder.verify(producer).commitTransaction();

    inOrder.verify(producer).close(any());

    container.stop();

    verifyNoMoreInteractions(producer);

    assertThat(txId.get()).isEqualTo(<span class="hljs-string">"tm.tx.id."</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConsumerFactory&lt;String, String&gt; <span class="hljs-title">createMockConsumerFactory</span><span class="hljs-params">(Consumer&lt;String, String&gt; mockConsumer)</span> </span>{
    ConsumerFactory&lt;String, String&gt; cf = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(mockConsumer).given(cf).createConsumer(<span class="hljs-string">"group"</span>, <span class="hljs-string">""</span>, <span class="hljs-keyword">null</span>, KafkaTestUtils.defaultPropertyOverrides());
    <span class="hljs-keyword">return</span> cf;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci45">Mock Clone Instance #spring-integration_MCI_45</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.kafka.core.ConsumerFactory</code></li>
<li><strong>Test Case Count</strong>: 8</li>
<li><strong>MO Count</strong>: 8</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConsumerFactory&lt;?, ?&gt; createMockConsumerFactory(Consumer&lt;?, ?&gt; consumer, <span class="hljs-keyword">int</span> maxPollRecords) {
    ConsumerFactory&lt;?, ?&gt; consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, maxPollRecords))
        .given(consumerFactory).getConfigurationProperties();
    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any()))
        .willReturn(consumer);
    <span class="hljs-keyword">return</span> consumerFactory;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest451">Test Case ID #spring-integration_Test_45_1</h4>
<h4 id="test-case-name-testconsumerawarerebalancelistenerfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkainboundmessagesourcetestsjava">Test Case Name: <code>testConsumerAwareRebalanceListener</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\inbound\MessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-consumerfactory">Mock Object Variable Name: <code>consumerFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    willAnswer(i -&gt; {
        listener.set(i.getArgument(1));
        return null;
    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener.class));
<span class="hljs-deletion">-    ConsumerFactory consumerFactory = mock(ConsumerFactory.class);</span>
<span class="hljs-deletion">-    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 1)).given(consumerFactory).getConfigurationProperties();</span>
<span class="hljs-deletion">-    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);</span>
<span class="hljs-addition">+    ConsumerFactory consumerFactory = createMockConsumerFactory(consumer, 1);</span>
    ConsumerProperties consumerProperties = new ConsumerProperties("foo");
    AtomicBoolean partitionsAssignedCalled = new AtomicBoolean();
    AtomicReference&lt;Consumer&gt; partitionsAssignedConsumer = new AtomicReference&lt;&gt;();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"unchecked"</span>, <span class="hljs-string">"rawtypes"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumerAwareRebalanceListener</span><span class="hljs-params">()</span> </span>{

    Consumer consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    List&lt;TopicPartition&gt; assigned = Collections.singletonList(topicPartition);

    AtomicReference&lt;ConsumerRebalanceListener&gt; listener = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    willAnswer(i -&gt; {

        listener.set(i.getArgument(<span class="hljs-number">1</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ConsumerFactory consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">1</span>)).given(consumerFactory).getConfigurationProperties();

    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);

    ConsumerProperties consumerProperties = <span class="hljs-keyword">new</span> ConsumerProperties(<span class="hljs-string">"foo"</span>);

    AtomicBoolean partitionsAssignedCalled = <span class="hljs-keyword">new</span> AtomicBoolean();

    AtomicReference&lt;Consumer&gt; partitionsAssignedConsumer = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    AtomicBoolean partitionsRevokedCalled = <span class="hljs-keyword">new</span> AtomicBoolean();

    AtomicReference&lt;Consumer&gt; partitionsRevokedConsumer = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    consumerProperties.setConsumerRebalanceListener(<span class="hljs-keyword">new</span> ConsumerAwareRebalanceListener() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onPartitionsRevokedAfterCommit</span><span class="hljs-params">(Consumer&lt;?, ?&gt; cons, Collection&lt;TopicPartition&gt; partitions)</span> </span>{

            partitionsRevokedCalled.getAndSet(<span class="hljs-keyword">true</span>);

            partitionsRevokedConsumer.set(cons);

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onPartitionsAssigned</span><span class="hljs-params">(Consumer&lt;?, ?&gt; cons, Collection&lt;TopicPartition&gt; partitions)</span> </span>{

            partitionsAssignedCalled.getAndSet(<span class="hljs-keyword">true</span>);

            partitionsAssignedConsumer.set(cons);

        }

    });

    KafkaMessageSource source = <span class="hljs-keyword">new</span> KafkaMessageSource(consumerFactory, consumerProperties);

    source.setRawMessageHeader(<span class="hljs-keyword">true</span>);

    source.receive();

    listener.get().onPartitionsAssigned(assigned);

    assertThat(partitionsAssignedCalled.get()).isTrue();

    assertThat(partitionsAssignedConsumer.get()).isEqualTo(consumer);

    listener.get().onPartitionsRevoked(assigned);

    assertThat(partitionsRevokedCalled.get()).isTrue();

    assertThat(partitionsRevokedConsumer.get()).isEqualTo(consumer);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConsumerFactory&lt;?, ?&gt; createMockConsumerFactory(Consumer&lt;?, ?&gt; consumer, <span class="hljs-keyword">int</span> maxPollRecords) {
    ConsumerFactory&lt;?, ?&gt; consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, maxPollRecords))
        .given(consumerFactory).getConfigurationProperties();
    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any()))
        .willReturn(consumer);
    <span class="hljs-keyword">return</span> consumerFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest452">Test Case ID #spring-integration_Test_45_2</h4>
<h4 id="test-case-name-testrebalancelistenerfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkainboundmessagesourcetestsjava">Test Case Name: <code>testRebalanceListener</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\inbound\MessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-consumerfactory">Mock Object Variable Name: <code>consumerFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    willAnswer(i -&gt; {
        listener.set(i.getArgument(1));
        return null;
    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener.class));
<span class="hljs-deletion">-    ConsumerFactory consumerFactory = mock(ConsumerFactory.class);</span>
<span class="hljs-deletion">-    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 1)).given(consumerFactory).getConfigurationProperties();</span>
<span class="hljs-deletion">-    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);</span>
<span class="hljs-addition">+    ConsumerFactory consumerFactory = createMockConsumerFactory(consumer, 1);</span>
    ConsumerProperties consumerProperties = new ConsumerProperties("foo");
    AtomicBoolean partitionsAssignedCalled = new AtomicBoolean();
    AtomicBoolean partitionsRevokedCalled = new AtomicBoolean();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"unchecked"</span>, <span class="hljs-string">"rawtypes"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRebalanceListener</span><span class="hljs-params">()</span> </span>{

    Consumer consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TopicPartition topicPartition1 = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    List&lt;TopicPartition&gt; assigned1 = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(Collections.singletonList(topicPartition1));

    TopicPartition topicPartition2 = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">1</span>);

    List&lt;TopicPartition&gt; assigned2 = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(Collections.singletonList(topicPartition2));

    AtomicReference&lt;ConsumerRebalanceListener&gt; listener = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    willAnswer(i -&gt; {

        listener.set(i.getArgument(<span class="hljs-number">1</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ConsumerFactory consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">1</span>)).given(consumerFactory).getConfigurationProperties();

    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);

    ConsumerProperties consumerProperties = <span class="hljs-keyword">new</span> ConsumerProperties(<span class="hljs-string">"foo"</span>);

    AtomicBoolean partitionsAssignedCalled = <span class="hljs-keyword">new</span> AtomicBoolean();

    AtomicBoolean partitionsRevokedCalled = <span class="hljs-keyword">new</span> AtomicBoolean();

    consumerProperties.setConsumerRebalanceListener(<span class="hljs-keyword">new</span> ConsumerRebalanceListener() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onPartitionsRevoked</span><span class="hljs-params">(Collection&lt;TopicPartition&gt; partitions)</span> </span>{

            partitionsRevokedCalled.getAndSet(<span class="hljs-keyword">true</span>);

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onPartitionsAssigned</span><span class="hljs-params">(Collection&lt;TopicPartition&gt; partitions)</span> </span>{

            partitionsAssignedCalled.getAndSet(<span class="hljs-keyword">true</span>);

        }

    });

    KafkaMessageSource source = <span class="hljs-keyword">new</span> KafkaMessageSource(consumerFactory, consumerProperties);

    source.setRawMessageHeader(<span class="hljs-keyword">true</span>);

    source.receive();

    listener.get().onPartitionsAssigned(assigned1);

    assertThat(partitionsAssignedCalled.get()).isTrue();

    assertThat(<span class="hljs-keyword">new</span> ArrayList&lt;&gt;(source.getAssignedPartitions())).isEqualTo(assigned1);

    listener.get().onPartitionsAssigned(assigned2);

    List&lt;TopicPartition&gt; temp = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(assigned1);

    temp.addAll(assigned2);

    assertThat(<span class="hljs-keyword">new</span> ArrayList&lt;&gt;(source.getAssignedPartitions())).isEqualTo(temp);

    listener.get().onPartitionsRevoked(assigned1);

    assertThat(partitionsRevokedCalled.get()).isTrue();

    assertThat(<span class="hljs-keyword">new</span> ArrayList&lt;&gt;(source.getAssignedPartitions())).isEqualTo(assigned2);

    source.pause();

    assertThat(source.isPaused()).isFalse();

    InOrder inOrder = inOrder(consumer);

    source.receive();

    assertThat(source.isPaused()).isTrue();

    inOrder.verify(consumer).pause(<span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;(assigned2));

    inOrder.verify(consumer).poll(any());

    listener.get().onPartitionsAssigned(assigned1);

    inOrder.verify(consumer).pause(<span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;(temp));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConsumerFactory&lt;?, ?&gt; createMockConsumerFactory(Consumer&lt;?, ?&gt; consumer, <span class="hljs-keyword">int</span> maxPollRecords) {
    ConsumerFactory&lt;?, ?&gt; consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, maxPollRecords))
        .given(consumerFactory).getConfigurationProperties();
    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any()))
        .willReturn(consumer);
    <span class="hljs-keyword">return</span> consumerFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest453">Test Case ID #spring-integration_Test_45_3</h4>
<h4 id="test-case-name-testackcommonfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkainboundmessagesourcetestsjava">Test Case Name: <code>testAckCommon</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\inbound\MessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-consumerfactory">Mock Object Variable Name: <code>consumerFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    given(consumer.poll(any(Duration.class))).willReturn(cr1, cr2, cr3, cr4, cr5);
<span class="hljs-deletion">-    ConsumerFactory consumerFactory = mock(ConsumerFactory.class);</span>
<span class="hljs-deletion">-    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 1)).given(consumerFactory).getConfigurationProperties();</span>
<span class="hljs-deletion">-    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);</span>
<span class="hljs-addition">+    ConsumerFactory consumerFactory = createMockConsumerFactory(consumer, 1);</span>
    ConsumerProperties consumerProperties = new ConsumerProperties("foo");
    AtomicInteger callbackCount = new AtomicInteger();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAckCommon</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> sync, <span class="hljs-keyword">boolean</span> timeout)</span> </span>{

    Consumer consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    List&lt;TopicPartition&gt; assigned = Collections.singletonList(topicPartition);

    willAnswer(i -&gt; {

        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(assigned);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ArgumentCaptor&lt;Collection&lt;TopicPartition&gt;&gt; partitions = ArgumentCaptor.forClass(Collection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willDoNothing().given(consumer).pause(partitions.capture());

    willDoNothing().given(consumer).resume(partitions.capture());

    willAnswer(invoc -&gt; {

        OffsetCommitCallback callback = invoc.getArgument(<span class="hljs-number">1</span>);

        callback.onComplete(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).commitAsync(any(), any());

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records1 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records1.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records2 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records2.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records3 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records3.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"baz"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records4 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records4.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"qux"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    ConsumerRecords cr1 = <span class="hljs-keyword">new</span> ConsumerRecords(records1);

    ConsumerRecords cr2 = <span class="hljs-keyword">new</span> ConsumerRecords(records2);

    ConsumerRecords cr3 = <span class="hljs-keyword">new</span> ConsumerRecords(records3);

    ConsumerRecords cr4 = <span class="hljs-keyword">new</span> ConsumerRecords(records4);

    ConsumerRecords cr5 = <span class="hljs-keyword">new</span> ConsumerRecords(Collections.emptyMap());

    given(consumer.poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">cr1</span>, <span class="hljs-title">cr2</span>, <span class="hljs-title">cr3</span>, <span class="hljs-title">cr4</span>, <span class="hljs-title">cr5</span>)</span>;

    ConsumerFactory consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">1</span>)).given(consumerFactory).getConfigurationProperties();

    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);

    ConsumerProperties consumerProperties = <span class="hljs-keyword">new</span> ConsumerProperties(<span class="hljs-string">"foo"</span>);

    AtomicInteger callbackCount = <span class="hljs-keyword">new</span> AtomicInteger();

    OffsetCommitCallback commitCallback = (offsets, ex) -&gt; {

        callbackCount.incrementAndGet();

    };

    <span class="hljs-keyword">if</span> (!sync) {

        consumerProperties.setSyncCommits(<span class="hljs-keyword">false</span>);

        consumerProperties.setCommitCallback(commitCallback);

    }

    <span class="hljs-keyword">if</span> (timeout) {

        consumerProperties.setSyncCommitTimeout(Duration.ofSeconds(<span class="hljs-number">5</span>));

    }

    consumerProperties.setCommitLogLevel(Level.INFO);

    KafkaMessageSource source = <span class="hljs-keyword">new</span> KafkaMessageSource(consumerFactory, consumerProperties);

    source.setRawMessageHeader(<span class="hljs-keyword">true</span>);

    Message&lt;?&gt; received = source.receive();

    assertThat(received).isNotNull();

    assertThat(received.getHeaders().get(KafkaHeaders.RAW_DATA)).isInstanceOf(ConsumerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    assertThat(received.getHeaders().get(IntegrationMessageHeaderAccessor.SOURCE_DATA)).isSameAs(received.getHeaders().get(KafkaHeaders.RAW_DATA));

    assertThat(received.getHeaders()).containsKeys(MessageHeaders.TIMESTAMP, MessageHeaders.ID);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    assertThat(received).isNotNull();

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    assertThat(received).isNotNull();

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    assertThat(received).isNotNull();

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    assertThat(received).isNull();

    source.pause();

    source.receive();

    source.resume();

    source.receive();

    source.destroy();

    InOrder inOrder = inOrder(consumer);

    inOrder.verify(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    checkCommit(sync, timeout, consumer, topicPartition, commitCallback, inOrder, <span class="hljs-number">1L</span>);

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    checkCommit(sync, timeout, consumer, topicPartition, commitCallback, inOrder, <span class="hljs-number">2L</span>);

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    checkCommit(sync, timeout, consumer, topicPartition, commitCallback, inOrder, <span class="hljs-number">3L</span>);

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    checkCommit(sync, timeout, consumer, topicPartition, commitCallback, inOrder, <span class="hljs-number">4L</span>);

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).pause(partitions.getAllValues().get(<span class="hljs-number">0</span>));

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).resume(partitions.getAllValues().get(<span class="hljs-number">1</span>));

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).close(any());

    inOrder.verifyNoMoreInteractions();

    <span class="hljs-keyword">if</span> (!sync) {

        assertThat(callbackCount.get()).isEqualTo(<span class="hljs-number">4</span>);

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConsumerFactory&lt;?, ?&gt; createMockConsumerFactory(Consumer&lt;?, ?&gt; consumer, <span class="hljs-keyword">int</span> maxPollRecords) {
    ConsumerFactory&lt;?, ?&gt; consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, maxPollRecords))
        .given(consumerFactory).getConfigurationProperties();
    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any()))
        .willReturn(consumer);
    <span class="hljs-keyword">return</span> consumerFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest454">Test Case ID #spring-integration_Test_45_4</h4>
<h4 id="test-case-name-testackoutoforderfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkainboundmessagesourcetestsjava">Test Case Name: <code>testAckOutOfOrder</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\inbound\MessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-consumerfactory">Mock Object Variable Name: <code>consumerFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     given(consumer.poll(any(Duration.class))).willReturn(cr1, cr2, cr3, cr4, cr5, cr6, cr7);
<span class="hljs-deletion">-    ConsumerFactory consumerFactory = mock(ConsumerFactory.class);</span>
<span class="hljs-deletion">-    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 1)).given(consumerFactory).getConfigurationProperties();</span>
<span class="hljs-deletion">-    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);</span>
<span class="hljs-addition">+    ConsumerFactory consumerFactory = createMockConsumerFactory(consumer, 1);</span>
     KafkaMessageSource source = new KafkaMessageSource(consumerFactory, new ConsumerProperties("foo"));
     Message&lt;?&gt; received1 = source.receive();
     // need some other interaction with mock between polls for InOrder
     consumer.paused();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAckOutOfOrder</span><span class="hljs-params">()</span> </span>{

    Consumer consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    willAnswer(i -&gt; {

        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    AtomicReference&lt;Set&lt;TopicPartition&gt;&gt; paused = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;(<span class="hljs-keyword">new</span> HashSet&lt;&gt;());

    willAnswer(i -&gt; {

        paused.set(<span class="hljs-keyword">new</span> HashSet&lt;&gt;(i.getArgument(<span class="hljs-number">0</span>)));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).pause(anyCollection());

    willAnswer(i -&gt; paused.get()).given(consumer).paused();

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records1 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records1.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records2 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records2.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records3 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records3.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"baz"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records4 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records4.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"qux"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records5 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records5.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"fiz"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records6 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records6.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"buz"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    ConsumerRecords cr1 = <span class="hljs-keyword">new</span> ConsumerRecords(records1);

    ConsumerRecords cr2 = <span class="hljs-keyword">new</span> ConsumerRecords(records2);

    ConsumerRecords cr3 = <span class="hljs-keyword">new</span> ConsumerRecords(records3);

    ConsumerRecords cr4 = <span class="hljs-keyword">new</span> ConsumerRecords(records4);

    ConsumerRecords cr5 = <span class="hljs-keyword">new</span> ConsumerRecords(records5);

    ConsumerRecords cr6 = <span class="hljs-keyword">new</span> ConsumerRecords(records6);

    ConsumerRecords cr7 = <span class="hljs-keyword">new</span> ConsumerRecords(Collections.emptyMap());

    given(consumer.poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">cr1</span>, <span class="hljs-title">cr2</span>, <span class="hljs-title">cr3</span>, <span class="hljs-title">cr4</span>, <span class="hljs-title">cr5</span>, <span class="hljs-title">cr6</span>, <span class="hljs-title">cr7</span>)</span>;

    ConsumerFactory consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">1</span>)).given(consumerFactory).getConfigurationProperties();

    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);

    KafkaMessageSource source = <span class="hljs-keyword">new</span> KafkaMessageSource(consumerFactory, <span class="hljs-keyword">new</span> ConsumerProperties(<span class="hljs-string">"foo"</span>));

    Message&lt;?&gt; received1 = source.receive();

    <span class="hljs-comment">// need some other interaction with mock between polls for InOrder</span>

    consumer.paused();

    Message&lt;?&gt; received2 = source.receive();

    <span class="hljs-comment">// need some other interaction with mock between polls for InOrder</span>

    consumer.paused();

    Message&lt;?&gt; received3 = source.receive();

    <span class="hljs-comment">// need some other interaction with mock between polls for InOrder</span>

    consumer.paused();

    Message&lt;?&gt; received4 = source.receive();

    <span class="hljs-comment">// need some other interaction with mock between polls for InOrder</span>

    consumer.paused();

    Message&lt;?&gt; received5 = source.receive();

    <span class="hljs-comment">// need some other interaction with mock between polls for InOrder</span>

    consumer.paused();

    Message&lt;?&gt; received6 = source.receive();

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received3).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received2).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received5).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received1).acknowledge(<span class="hljs-comment">// should commit offset 3 (received 3)</span>

    AcknowledgmentCallback.Status.ACCEPT);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received6).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received4).acknowledge(<span class="hljs-comment">// should commit offset 6 (received 6).</span>

    AcknowledgmentCallback.Status.ACCEPT);

    assertThat(source.receive()).isNull();

    source.destroy();

    InOrder inOrder = inOrder(consumer);

    inOrder.verify(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).paused();

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).paused();

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).paused();

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).paused();

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">3L</span>)));

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">6L</span>)));

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).close(any());

    inOrder.verifyNoMoreInteractions();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConsumerFactory&lt;?, ?&gt; createMockConsumerFactory(Consumer&lt;?, ?&gt; consumer, <span class="hljs-keyword">int</span> maxPollRecords) {
    ConsumerFactory&lt;?, ?&gt; consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, maxPollRecords))
        .given(consumerFactory).getConfigurationProperties();
    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any()))
        .willReturn(consumer);
    <span class="hljs-keyword">return</span> consumerFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest455">Test Case ID #spring-integration_Test_45_5</h4>
<h4 id="test-case-name-testnackfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkainboundmessagesourcetestsjava">Test Case Name: <code>testNack</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\inbound\MessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-consumerfactory">Mock Object Variable Name: <code>consumerFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    given(consumer.poll(any(Duration.class))).willReturn(cr1, cr1, cr2, cr2, cr3);
<span class="hljs-deletion">-    ConsumerFactory consumerFactory = mock(ConsumerFactory.class);</span>
<span class="hljs-deletion">-    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 1)).given(consumerFactory).getConfigurationProperties();</span>
<span class="hljs-deletion">-    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);</span>
<span class="hljs-addition">+    ConsumerFactory consumerFactory = createMockConsumerFactory(consumer, 1);</span>
    ConsumerProperties consumerProperties = new ConsumerProperties("foo");
    consumerProperties.setSyncCommitTimeout(Duration.ofSeconds(30));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testNack</span><span class="hljs-params">()</span> </span>{

    Consumer consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    willAnswer(i -&gt; {

        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    AtomicReference&lt;Set&lt;TopicPartition&gt;&gt; paused = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;(<span class="hljs-keyword">new</span> HashSet&lt;&gt;());

    willAnswer(i -&gt; {

        paused.set(<span class="hljs-keyword">new</span> HashSet&lt;&gt;(i.getArgument(<span class="hljs-number">0</span>)));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).pause(anyCollection());

    willAnswer(i -&gt; paused.get()).given(consumer).paused();

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records1 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records1.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    ConsumerRecords cr1 = <span class="hljs-keyword">new</span> ConsumerRecords(records1);

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records2 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records2.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    ConsumerRecords cr2 = <span class="hljs-keyword">new</span> ConsumerRecords(records2);

    ConsumerRecords cr3 = <span class="hljs-keyword">new</span> ConsumerRecords(Collections.emptyMap());

    given(consumer.poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">cr1</span>, <span class="hljs-title">cr1</span>, <span class="hljs-title">cr2</span>, <span class="hljs-title">cr2</span>, <span class="hljs-title">cr3</span>)</span>;

    ConsumerFactory consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">1</span>)).given(consumerFactory).getConfigurationProperties();

    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);

    ConsumerProperties consumerProperties = <span class="hljs-keyword">new</span> ConsumerProperties(<span class="hljs-string">"foo"</span>);

    consumerProperties.setSyncCommitTimeout(Duration.ofSeconds(<span class="hljs-number">30</span>));

    KafkaMessageSource source = <span class="hljs-keyword">new</span> KafkaMessageSource(consumerFactory, consumerProperties);

    Message&lt;?&gt; received = source.receive();

    assertThat(received.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(<span class="hljs-number">0L</span>);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.REQUEUE);

    received = source.receive();

    assertThat(received.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(<span class="hljs-number">0L</span>);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    assertThat(received.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(<span class="hljs-number">1L</span>);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.REQUEUE);

    received = source.receive();

    assertThat(received.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(<span class="hljs-number">1L</span>);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    source.destroy();

    assertThat(received).isNull();

    InOrder inOrder = inOrder(consumer);

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-comment">// rollback</span>

    inOrder.verify(consumer).seek(topicPartition, <span class="hljs-number">0L</span>);

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">1L</span>)), Duration.ofSeconds(<span class="hljs-number">30</span>));

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-comment">// rollback</span>

    inOrder.verify(consumer).seek(topicPartition, <span class="hljs-number">1L</span>);

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">2L</span>)), Duration.ofSeconds(<span class="hljs-number">30</span>));

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).close(any());

    inOrder.verifyNoMoreInteractions();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConsumerFactory&lt;?, ?&gt; createMockConsumerFactory(Consumer&lt;?, ?&gt; consumer, <span class="hljs-keyword">int</span> maxPollRecords) {
    ConsumerFactory&lt;?, ?&gt; consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, maxPollRecords))
        .given(consumerFactory).getConfigurationProperties();
    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any()))
        .willReturn(consumer);
    <span class="hljs-keyword">return</span> consumerFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest456">Test Case ID #spring-integration_Test_45_6</h4>
<h4 id="test-case-name-testnackwithlaterinflightfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkainboundmessagesourcetestsjava">Test Case Name: <code>testNackWithLaterInflight</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\inbound\MessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-consumerfactory">Mock Object Variable Name: <code>consumerFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    given(consumer.poll(any(Duration.class))).willReturn(cr1, cr2, cr1, cr2, cr3);
<span class="hljs-deletion">-    ConsumerFactory consumerFactory = mock(ConsumerFactory.class);</span>
<span class="hljs-deletion">-    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 1)).given(consumerFactory).getConfigurationProperties();</span>
<span class="hljs-deletion">-    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);</span>
<span class="hljs-addition">+    ConsumerFactory consumerFactory = createMockConsumerFactory(consumer, 1);</span>
    KafkaMessageSource source = new KafkaMessageSource(consumerFactory, new ConsumerProperties("foo"));
    Message&lt;?&gt; received1 = source.receive();
    // need some other interaction with mock between polls for InOrder
    consumer.paused();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testNackWithLaterInflight</span><span class="hljs-params">()</span> </span>{

    Consumer consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    willAnswer(i -&gt; {

        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    AtomicReference&lt;Set&lt;TopicPartition&gt;&gt; paused = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;(<span class="hljs-keyword">new</span> HashSet&lt;&gt;());

    willAnswer(i -&gt; {

        paused.set(<span class="hljs-keyword">new</span> HashSet&lt;&gt;(i.getArgument(<span class="hljs-number">0</span>)));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).pause(anyCollection());

    willAnswer(i -&gt; paused.get()).given(consumer).paused();

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records1 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records1.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    ConsumerRecords cr1 = <span class="hljs-keyword">new</span> ConsumerRecords(records1);

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records2 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records2.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    ConsumerRecords cr2 = <span class="hljs-keyword">new</span> ConsumerRecords(records2);

    ConsumerRecords cr3 = <span class="hljs-keyword">new</span> ConsumerRecords(Collections.emptyMap());

    given(consumer.poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">cr1</span>, <span class="hljs-title">cr2</span>, <span class="hljs-title">cr1</span>, <span class="hljs-title">cr2</span>, <span class="hljs-title">cr3</span>)</span>;

    ConsumerFactory consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">1</span>)).given(consumerFactory).getConfigurationProperties();

    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);

    KafkaMessageSource source = <span class="hljs-keyword">new</span> KafkaMessageSource(consumerFactory, <span class="hljs-keyword">new</span> ConsumerProperties(<span class="hljs-string">"foo"</span>));

    Message&lt;?&gt; received1 = source.receive();

    <span class="hljs-comment">// need some other interaction with mock between polls for InOrder</span>

    consumer.paused();

    <span class="hljs-comment">// inflight</span>

    Message&lt;?&gt; received2 = source.receive();

    assertThat(received1.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(<span class="hljs-number">0L</span>);

    AcknowledgmentCallback ack1 = StaticMessageHeaderAccessor.getAcknowledgmentCallback(received1);

    Log log1 = spy(KafkaTestUtils.getPropertyValue(ack1, <span class="hljs-string">"logger.log"</span>, Log<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">new</span> DirectFieldAccessor(ack1).setPropertyValue(<span class="hljs-string">"logger.log"</span>, log1);

    given(log1.isWarnEnabled()).willReturn(<span class="hljs-keyword">true</span>);

    willDoNothing().given(log1).warn(any());

    ack1.acknowledge(AcknowledgmentCallback.Status.REQUEUE);

    assertThat(received2.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(<span class="hljs-number">1L</span>);

    AcknowledgmentCallback ack2 = StaticMessageHeaderAccessor.getAcknowledgmentCallback(received2);

    Log log2 = spy(KafkaTestUtils.getPropertyValue(ack2, <span class="hljs-string">"logger.log"</span>, Log<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">new</span> DirectFieldAccessor(ack2).setPropertyValue(<span class="hljs-string">"logger.log"</span>, log2);

    given(log2.isWarnEnabled()).willReturn(<span class="hljs-keyword">true</span>);

    willDoNothing().given(log2).warn(any());

    ack2.acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received1 = source.receive();

    assertThat(received1.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(<span class="hljs-number">0L</span>);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received1).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received2 = source.receive();

    assertThat(received2.getHeaders().get(KafkaHeaders.OFFSET)).isEqualTo(<span class="hljs-number">1L</span>);

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received2).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received1 = source.receive();

    source.destroy();

    assertThat(received1).isNull();

    InOrder inOrder = inOrder(consumer, log1, log2);

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).paused();

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-comment">// rollback</span>

    inOrder.verify(consumer).seek(topicPartition, <span class="hljs-number">0L</span>);

    inOrder.verify(log1).isWarnEnabled();

    ArgumentCaptor&lt;LogMessage&gt; captor = ArgumentCaptor.forClass(LogMessage<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    inOrder.verify(log1).warn(captor.capture());

    assertThat(captor.getValue().toString()).contains(<span class="hljs-string">"Rolled back"</span>).contains(<span class="hljs-string">"later in-flight offsets [1] will also be re-fetched"</span>);

    inOrder.verify(log2).isWarnEnabled();

    captor = ArgumentCaptor.forClass(LogMessage<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    inOrder.verify(log2).warn(captor.capture());

    assertThat(captor.getValue().toString()).contains(<span class="hljs-string">"Cannot commit offset for"</span>).contains(<span class="hljs-string">"; an earlier offset was rolled back"</span>);

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">1L</span>)));

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">2L</span>)));

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).close(any());

    inOrder.verifyNoMoreInteractions();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConsumerFactory&lt;?, ?&gt; createMockConsumerFactory(Consumer&lt;?, ?&gt; consumer, <span class="hljs-keyword">int</span> maxPollRecords) {
    ConsumerFactory&lt;?, ?&gt; consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, maxPollRecords))
        .given(consumerFactory).getConfigurationProperties();
    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any()))
        .willReturn(consumer);
    <span class="hljs-keyword">return</span> consumerFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest457">Test Case ID #spring-integration_Test_45_7</h4>
<h4 id="test-case-name-testpolltimeoutsfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkainboundmessagesourcetestsjava">Test Case Name: <code>testPollTimeouts</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\inbound\MessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-consumerfactory">Mock Object Variable Name: <code>consumerFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    given(consumer.poll(Duration.of(5000, ChronoUnit.MILLIS))).willReturn(cr2, ConsumerRecords.EMPTY);
<span class="hljs-deletion">-    ConsumerFactory consumerFactory = mock(ConsumerFactory.class);</span>
<span class="hljs-deletion">-    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 1)).given(consumerFactory).getConfigurationProperties();</span>
<span class="hljs-deletion">-    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);</span>
<span class="hljs-addition">+    ConsumerFactory consumerFactory = createMockConsumerFactory(consumer, 1);</span>
    KafkaMessageSource source = new KafkaMessageSource(consumerFactory, new ConsumerProperties("foo"));
    source.setRawMessageHeader(true);
    Message&lt;?&gt; received = source.receive();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testPollTimeouts</span><span class="hljs-params">()</span> </span>{

    Consumer consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    List&lt;TopicPartition&gt; assigned = Collections.singletonList(topicPartition);

    AtomicReference&lt;ConsumerRebalanceListener&gt; listener = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    willAnswer(i -&gt; {

        listener.set(i.getArgument(<span class="hljs-number">1</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records1 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records1.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    ConsumerRecords cr1 = <span class="hljs-keyword">new</span> ConsumerRecords(records1);

    given(consumer.poll(Duration.of(<span class="hljs-number">20</span> * <span class="hljs-number">5000</span>, ChronoUnit.MILLIS))).willReturn(cr1, ConsumerRecords.EMPTY);

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records2 = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records2.put(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    ConsumerRecords cr2 = <span class="hljs-keyword">new</span> ConsumerRecords(records2);

    given(consumer.poll(Duration.of(<span class="hljs-number">5000</span>, ChronoUnit.MILLIS))).willReturn(cr2, ConsumerRecords.EMPTY);

    ConsumerFactory consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">1</span>)).given(consumerFactory).getConfigurationProperties();

    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);

    KafkaMessageSource source = <span class="hljs-keyword">new</span> KafkaMessageSource(consumerFactory, <span class="hljs-keyword">new</span> ConsumerProperties(<span class="hljs-string">"foo"</span>));

    source.setRawMessageHeader(<span class="hljs-keyword">true</span>);

    Message&lt;?&gt; received = source.receive();

    assertThat(received).isNotNull();

    assertThat(received).isNotNull();

    assertThat(received.getHeaders().get(KafkaHeaders.RAW_DATA)).isInstanceOf(ConsumerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    assertThat(received.getHeaders().get(KafkaHeaders.RAW_DATA)).isEqualTo(cr1.records(topicPartition).get(<span class="hljs-number">0</span>));

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    listener.get().onPartitionsAssigned(assigned);

    received = source.receive();

    assertThat(received).isNotNull();

    assertThat(received.getHeaders().get(KafkaHeaders.RAW_DATA)).isInstanceOf(ConsumerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    assertThat(received.getHeaders().get(KafkaHeaders.RAW_DATA)).isEqualTo(cr2.records(topicPartition).get(<span class="hljs-number">0</span>));

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    listener.get().onPartitionsRevoked(assigned);

    received = source.receive();

    assertThat(received).isNull();

    InOrder inOrder = inOrder(consumer);

    inOrder.verify(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-comment">// assignTimeout used on initial poll (before partition assigned)</span>

    inOrder.verify(consumer).poll(Duration.of(<span class="hljs-number">20</span> * <span class="hljs-number">5000</span>, ChronoUnit.MILLIS));

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">1L</span>)));

    <span class="hljs-comment">// pollTimeout used on subsequent polls</span>

    inOrder.verify(consumer).poll(Duration.of(<span class="hljs-number">5000</span>, ChronoUnit.MILLIS));

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">2L</span>)));

    <span class="hljs-comment">// assignTimeout used after partitions revoked</span>

    inOrder.verify(consumer).poll(Duration.of(<span class="hljs-number">20</span> * <span class="hljs-number">5000</span>, ChronoUnit.MILLIS));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConsumerFactory&lt;?, ?&gt; createMockConsumerFactory(Consumer&lt;?, ?&gt; consumer, <span class="hljs-keyword">int</span> maxPollRecords) {
    ConsumerFactory&lt;?, ?&gt; consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, maxPollRecords))
        .given(consumerFactory).getConfigurationProperties();
    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any()))
        .willReturn(consumer);
    <span class="hljs-keyword">return</span> consumerFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest458">Test Case ID #spring-integration_Test_45_8</h4>
<h4 id="test-case-name-testallowmultifile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkainboundmessagesourcetestsjava">Test Case Name: <code>testAllowMulti</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\inbound\MessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-consumerfactory">Mock Object Variable Name: <code>consumerFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    given(consumer.poll(any(Duration.class))).willReturn(cr1, cr2);
<span class="hljs-deletion">-    ConsumerFactory consumerFactory = mock(ConsumerFactory.class);</span>
<span class="hljs-deletion">-    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 4)).given(consumerFactory).getConfigurationProperties();</span>
<span class="hljs-deletion">-    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);</span>
<span class="hljs-addition">+    ConsumerFactory consumerFactory = createMockConsumerFactory(consumer, 4);</span>
    KafkaMessageSource source = new KafkaMessageSource(consumerFactory, new ConsumerProperties("foo"), true);
    source.setRawMessageHeader(true);
    Message&lt;?&gt; received = source.receive();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAllowMulti</span><span class="hljs-params">()</span> </span>{

    Consumer consumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    List&lt;TopicPartition&gt; assigned = Collections.singletonList(topicPartition);

    willAnswer(i -&gt; {

        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(assigned);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ArgumentCaptor&lt;Collection&lt;TopicPartition&gt;&gt; partitions = ArgumentCaptor.forClass(Collection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willDoNothing().given(consumer).pause(partitions.capture());

    willDoNothing().given(consumer).resume(partitions.capture());

    Map&lt;TopicPartition, List&lt;ConsumerRecord&gt;&gt; records = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();

    records.put(topicPartition, Arrays.asList(<span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty()), <span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty()), <span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"baz"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty()), <span class="hljs-keyword">new</span> ConsumerRecord(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">3L</span>, <span class="hljs-number">0L</span>, TimestampType.NO_TIMESTAMP_TYPE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"qux"</span>, <span class="hljs-keyword">new</span> RecordHeaders(), Optional.empty())));

    ConsumerRecords cr1 = <span class="hljs-keyword">new</span> ConsumerRecords(records);

    ConsumerRecords cr2 = <span class="hljs-keyword">new</span> ConsumerRecords(Collections.emptyMap());

    given(consumer.poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">cr1</span>, <span class="hljs-title">cr2</span>)</span>;

    ConsumerFactory consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">4</span>)).given(consumerFactory).getConfigurationProperties();

    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any())).willReturn(consumer);

    KafkaMessageSource source = <span class="hljs-keyword">new</span> KafkaMessageSource(consumerFactory, <span class="hljs-keyword">new</span> ConsumerProperties(<span class="hljs-string">"foo"</span>), <span class="hljs-keyword">true</span>);

    source.setRawMessageHeader(<span class="hljs-keyword">true</span>);

    Message&lt;?&gt; received = source.receive();

    assertThat(received).isNotNull();

    assertThat(received.getHeaders().get(KafkaMessageSource.REMAINING_RECORDS, Integer<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">isEqualTo</span>(3)</span>;

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    assertThat(received).isNotNull();

    assertThat(received.getHeaders().get(KafkaMessageSource.REMAINING_RECORDS, Integer<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">isEqualTo</span>(2)</span>;

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    assertThat(received).isNotNull();

    assertThat(received.getHeaders().get(KafkaMessageSource.REMAINING_RECORDS, Integer<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">isEqualTo</span>(1)</span>;

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    assertThat(received).isNotNull();

    assertThat(received.getHeaders().get(KafkaMessageSource.REMAINING_RECORDS, Integer<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">isEqualTo</span>(0)</span>;

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(AcknowledgmentCallback.Status.ACCEPT);

    received = source.receive();

    assertThat(received).isNull();

    source.destroy();

    InOrder inOrder = inOrder(consumer);

    inOrder.verify(consumer).subscribe(anyCollection(), any(ConsumerRebalanceListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">1L</span>)));

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">2L</span>)));

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">3L</span>)));

    inOrder.verify(consumer).commitSync(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">4L</span>)));

    inOrder.verify(consumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(consumer).close(any());

    inOrder.verifyNoMoreInteractions();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConsumerFactory&lt;?, ?&gt; createMockConsumerFactory(Consumer&lt;?, ?&gt; consumer, <span class="hljs-keyword">int</span> maxPollRecords) {
    ConsumerFactory&lt;?, ?&gt; consumerFactory = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(Collections.singletonMap(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, maxPollRecords))
        .given(consumerFactory).getConfigurationProperties();
    given(consumerFactory.createConsumer(isNull(), anyString(), isNull(), any()))
        .willReturn(consumer);
    <span class="hljs-keyword">return</span> consumerFactory;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci46">Mock Clone Instance #spring-integration_MCI_46</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>javax.sql.DataSource</code></li>
<li><strong>Test Case Count</strong>: 15</li>
<li><strong>MO Count</strong>: 15</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> DataSource datasource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
datasource;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest461">Test Case ID #spring-integration_Test_46_1</h4>
<h4 id="test-case-name-teststoredprocexecutorwithnullprocedurenamefile-cjavaprojectsspringspring-integrationspring-integration-jdbcsrctestjavaorgspringframeworkintegrationjdbcstoredprocexecutortestsjava">Test Case Name: <code>testStoredProcExecutorWithNullProcedureName</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-jdbc\src\test\java\org\springframework\integration\jdbc\StoredProcExecutorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-datasource">Mock Object Variable Name: <code>datasource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testStoredProcExecutorWithNullProcedureName() {
<span class="hljs-deletion">-    DataSource datasource = mock(DataSource.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `datasource`</span>
     StoredProcExecutor storedProcExecutor = new StoredProcExecutor(datasource);
     storedProcExecutor.setBeanFactory(mock(BeanFactory.class));
     assertThatIllegalArgumentException().isThrownBy(storedProcExecutor::afterPropertiesSet).withMessage("You must either provide a " + "Stored Procedure Name or a Stored Procedure Name Expression.");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStoredProcExecutorWithNullProcedureName</span><span class="hljs-params">()</span> </span>{

    DataSource datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    StoredProcExecutor storedProcExecutor = <span class="hljs-keyword">new</span> StoredProcExecutor(datasource);

    storedProcExecutor.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    assertThatIllegalArgumentException().isThrownBy(storedProcExecutor::afterPropertiesSet).withMessage(<span class="hljs-string">"You must either provide a "</span> + <span class="hljs-string">"Stored Procedure Name or a Stored Procedure Name Expression."</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> DataSource datasource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
datasource;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest462">Test Case ID #spring-integration_Test_46_2</h4>
<h4 id="test-case-name-teststoredprocexecutorwithemptyprocedurenamefile-cjavaprojectsspringspring-integrationspring-integration-jdbcsrctestjavaorgspringframeworkintegrationjdbcstoredprocexecutortestsjava">Test Case Name: <code>testStoredProcExecutorWithEmptyProcedureName</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-jdbc\src\test\java\org\springframework\integration\jdbc\StoredProcExecutorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-datasource">Mock Object Variable Name: <code>datasource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
@Test
public void testStoredProcExecutorWithEmptyProcedureName() {
<span class="hljs-deletion">-    DataSource datasource = mock(DataSource.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `datasource`</span>
    StoredProcExecutor storedProcExecutor = new StoredProcExecutor(datasource);
    assertThatIllegalArgumentException().isThrownBy(() -&gt; storedProcExecutor.setStoredProcedureName("      ")).withMessage("storedProcedureName must not be null and cannot be empty.");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStoredProcExecutorWithEmptyProcedureName</span><span class="hljs-params">()</span> </span>{

    DataSource datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    StoredProcExecutor storedProcExecutor = <span class="hljs-keyword">new</span> StoredProcExecutor(datasource);

    assertThatIllegalArgumentException().isThrownBy(() -&gt; storedProcExecutor.setStoredProcedureName(<span class="hljs-string">"      "</span>)).withMessage(<span class="hljs-string">"storedProcedureName must not be null and cannot be empty."</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> DataSource datasource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
datasource;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest463">Test Case ID #spring-integration_Test_46_3</h4>
<h4 id="test-case-name-testgetstoredprocedurenameexpressionasstringfile-cjavaprojectsspringspring-integrationspring-integration-jdbcsrctestjavaorgspringframeworkintegrationjdbcstoredprocexecutortestsjava">Test Case Name: <code>testGetStoredProcedureNameExpressionAsString</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-jdbc\src\test\java\org\springframework\integration\jdbc\StoredProcExecutorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-datasource">Mock Object Variable Name: <code>datasource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testGetStoredProcedureNameExpressionAsString() throws Exception {
<span class="hljs-deletion">-    DataSource datasource = mock(DataSource.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `datasource`</span>
     StoredProcExecutor storedProcExecutor = new StoredProcExecutor(datasource);
     final ExpressionFactoryBean efb = new ExpressionFactoryBean("headers['stored_procedure_name']");
     efb.afterPropertiesSet();
     final Expression expression = efb.getObject();
     storedProcExecutor.setStoredProcedureNameExpression(expression);
     storedProcExecutor.setBeanFactory(mock(BeanFactory.class));
     storedProcExecutor.afterPropertiesSet();
     assertThat(storedProcExecutor.getStoredProcedureNameExpressionAsString()).isEqualTo("headers['stored_procedure_name']");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetStoredProcedureNameExpressionAsString</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    DataSource datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    StoredProcExecutor storedProcExecutor = <span class="hljs-keyword">new</span> StoredProcExecutor(datasource);

    <span class="hljs-keyword">final</span> ExpressionFactoryBean efb = <span class="hljs-keyword">new</span> ExpressionFactoryBean(<span class="hljs-string">"headers['stored_procedure_name']"</span>);

    efb.afterPropertiesSet();

    <span class="hljs-keyword">final</span> Expression expression = efb.getObject();

    storedProcExecutor.setStoredProcedureNameExpression(expression);

    storedProcExecutor.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    storedProcExecutor.afterPropertiesSet();

    assertThat(storedProcExecutor.getStoredProcedureNameExpressionAsString()).isEqualTo(<span class="hljs-string">"headers['stored_procedure_name']"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> DataSource datasource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
datasource;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest464">Test Case ID #spring-integration_Test_46_4</h4>
<h4 id="test-case-name-testgetstoredprocedurenameexpressionasstring2file-cjavaprojectsspringspring-integrationspring-integration-jdbcsrctestjavaorgspringframeworkintegrationjdbcstoredprocexecutortestsjava">Test Case Name: <code>testGetStoredProcedureNameExpressionAsString2</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-jdbc\src\test\java\org\springframework\integration\jdbc\StoredProcExecutorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-datasource">Mock Object Variable Name: <code>datasource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testGetStoredProcedureNameExpressionAsString2() {
<span class="hljs-deletion">-    DataSource datasource = mock(DataSource.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `datasource`</span>
     StoredProcExecutor storedProcExecutor = new StoredProcExecutor(datasource);
     storedProcExecutor.setStoredProcedureName("123");
     storedProcExecutor.setBeanFactory(mock(BeanFactory.class));
     storedProcExecutor.afterPropertiesSet();
     assertThat(storedProcExecutor.getStoredProcedureName()).isEqualTo("123");
     assertThat(storedProcExecutor.getStoredProcedureNameExpressionAsString()).isEqualTo("123");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetStoredProcedureNameExpressionAsString2</span><span class="hljs-params">()</span> </span>{

    DataSource datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    StoredProcExecutor storedProcExecutor = <span class="hljs-keyword">new</span> StoredProcExecutor(datasource);

    storedProcExecutor.setStoredProcedureName(<span class="hljs-string">"123"</span>);

    storedProcExecutor.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    storedProcExecutor.afterPropertiesSet();

    assertThat(storedProcExecutor.getStoredProcedureName()).isEqualTo(<span class="hljs-string">"123"</span>);

    assertThat(storedProcExecutor.getStoredProcedureNameExpressionAsString()).isEqualTo(<span class="hljs-string">"123"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> DataSource datasource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
datasource;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest465">Test Case ID #spring-integration_Test_46_5</h4>
<h4 id="test-case-name-testsetreturningresultsetrowmapperswithnullmapfile-cjavaprojectsspringspring-integrationspring-integration-jdbcsrctestjavaorgspringframeworkintegrationjdbcstoredprocexecutortestsjava">Test Case Name: <code>testSetReturningResultSetRowMappersWithNullMap</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-jdbc\src\test\java\org\springframework\integration\jdbc\StoredProcExecutorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-datasource">Mock Object Variable Name: <code>datasource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testSetReturningResultSetRowMappersWithNullMap() {
<span class="hljs-deletion">-    DataSource datasource = mock(DataSource.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `datasource`</span>
     StoredProcExecutor storedProcExecutor = new StoredProcExecutor(datasource);
     assertThatIllegalArgumentException().isThrownBy(() -&gt; storedProcExecutor.setReturningResultSetRowMappers(null)).withMessage("'returningResultSetRowMappers' must not be null.");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSetReturningResultSetRowMappersWithNullMap</span><span class="hljs-params">()</span> </span>{

    DataSource datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    StoredProcExecutor storedProcExecutor = <span class="hljs-keyword">new</span> StoredProcExecutor(datasource);

    assertThatIllegalArgumentException().isThrownBy(() -&gt; storedProcExecutor.setReturningResultSetRowMappers(<span class="hljs-keyword">null</span>)).withMessage(<span class="hljs-string">"'returningResultSetRowMappers' must not be null."</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> DataSource datasource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
datasource;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest466">Test Case ID #spring-integration_Test_46_6</h4>
<h4 id="test-case-name-testsetreturningresultsetrowmapperswithmapcontainingnullvaluesfile-cjavaprojectsspringspring-integrationspring-integration-jdbcsrctestjavaorgspringframeworkintegrationjdbcstoredprocexecutortestsjava">Test Case Name: <code>testSetReturningResultSetRowMappersWithMapContainingNullValues</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-jdbc\src\test\java\org\springframework\integration\jdbc\StoredProcExecutorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-datasource">Mock Object Variable Name: <code>datasource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testSetReturningResultSetRowMappersWithMapContainingNullValues() {
<span class="hljs-deletion">-    DataSource datasource = mock(DataSource.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `datasource`</span>
     StoredProcExecutor storedProcExecutor = new StoredProcExecutor(datasource);
     Map&lt;String, RowMapper&lt;?&gt;&gt; rowMappers = new HashMap&lt;&gt;();
     rowMappers.put("results", null);
     assertThatIllegalArgumentException().isThrownBy(() -&gt; storedProcExecutor.setReturningResultSetRowMappers(rowMappers)).withMessage("'returningResultSetRowMappers' cannot contain null values.");
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSetReturningResultSetRowMappersWithMapContainingNullValues</span><span class="hljs-params">()</span> </span>{

    DataSource datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    StoredProcExecutor storedProcExecutor = <span class="hljs-keyword">new</span> StoredProcExecutor(datasource);

    Map&lt;String, RowMapper&lt;?&gt;&gt; rowMappers = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    rowMappers.put(<span class="hljs-string">"results"</span>, <span class="hljs-keyword">null</span>);

    assertThatIllegalArgumentException().isThrownBy(() -&gt; storedProcExecutor.setReturningResultSetRowMappers(rowMappers)).withMessage(<span class="hljs-string">"'returningResultSetRowMappers' cannot contain null values."</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> DataSource datasource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
datasource;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest467">Test Case ID #spring-integration_Test_46_7</h4>
<h4 id="test-case-name-testsetreturningresultsetrowmapperswithemptymapfile-cjavaprojectsspringspring-integrationspring-integration-jdbcsrctestjavaorgspringframeworkintegrationjdbcstoredprocexecutortestsjava">Test Case Name: <code>testSetReturningResultSetRowMappersWithEmptyMap</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-jdbc\src\test\java\org\springframework\integration\jdbc\StoredProcExecutorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-datasource">Mock Object Variable Name: <code>datasource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testSetReturningResultSetRowMappersWithEmptyMap() {
<span class="hljs-deletion">-    DataSource datasource = mock(DataSource.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `datasource`</span>
     StoredProcExecutor storedProcExecutor = new StoredProcExecutor(datasource);
     Map&lt;String, RowMapper&lt;?&gt;&gt; rowmappers = new HashMap&lt;String, RowMapper&lt;?&gt;&gt;();
     storedProcExecutor.setReturningResultSetRowMappers(rowmappers);
     //Should Successfully finish
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSetReturningResultSetRowMappersWithEmptyMap</span><span class="hljs-params">()</span> </span>{

    DataSource datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    StoredProcExecutor storedProcExecutor = <span class="hljs-keyword">new</span> StoredProcExecutor(datasource);

    Map&lt;String, RowMapper&lt;?&gt;&gt; rowmappers = <span class="hljs-keyword">new</span> HashMap&lt;String, RowMapper&lt;?&gt;&gt;();

    storedProcExecutor.setReturningResultSetRowMappers(rowmappers);

    <span class="hljs-comment">//Should Successfully finish</span>

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> DataSource datasource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
datasource;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest468">Test Case ID #spring-integration_Test_46_8</h4>
<h4 id="test-case-name-testsetsqlparametersourcefactorywithnullparameterfile-cjavaprojectsspringspring-integrationspring-integration-jdbcsrctestjavaorgspringframeworkintegrationjdbcstoredprocexecutortestsjava">Test Case Name: <code>testSetSqlParameterSourceFactoryWithNullParameter</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-jdbc\src\test\java\org\springframework\integration\jdbc\StoredProcExecutorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-datasource">Mock Object Variable Name: <code>datasource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testSetSqlParameterSourceFactoryWithNullParameter() {
<span class="hljs-deletion">-    DataSource datasource = mock(DataSource.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `datasource`</span>
     StoredProcExecutor storedProcExecutor = new StoredProcExecutor(datasource);
     try {
         storedProcExecutor.setSqlParameterSourceFactory(null);
     } catch (IllegalArgumentException e) {
         assertThat(e.getMessage()).isEqualTo("sqlParameterSourceFactory must not be null.");
         return;
     }
     fail("Exception expected.");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSetSqlParameterSourceFactoryWithNullParameter</span><span class="hljs-params">()</span> </span>{

    DataSource datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    StoredProcExecutor storedProcExecutor = <span class="hljs-keyword">new</span> StoredProcExecutor(datasource);

    <span class="hljs-keyword">try</span> {

        storedProcExecutor.setSqlParameterSourceFactory(<span class="hljs-keyword">null</span>);

    } <span class="hljs-keyword">catch</span> (IllegalArgumentException e) {

        assertThat(e.getMessage()).isEqualTo(<span class="hljs-string">"sqlParameterSourceFactory must not be null."</span>);

        <span class="hljs-keyword">return</span>;

    }

    fail(<span class="hljs-string">"Exception expected."</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> DataSource datasource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
datasource;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest469">Test Case ID #spring-integration_Test_46_9</h4>
<h4 id="test-case-name-testsetsqlparameterswithnullvalueinlistfile-cjavaprojectsspringspring-integrationspring-integration-jdbcsrctestjavaorgspringframeworkintegrationjdbcstoredprocexecutortestsjava">Test Case Name: <code>testSetSqlParametersWithNullValueInList</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-jdbc\src\test\java\org\springframework\integration\jdbc\StoredProcExecutorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-datasource">Mock Object Variable Name: <code>datasource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testSetSqlParametersWithNullValueInList() {
<span class="hljs-deletion">-    DataSource datasource = mock(DataSource.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `datasource`</span>
     StoredProcExecutor storedProcExecutor = new StoredProcExecutor(datasource);
     List&lt;SqlParameter&gt; sqlParameters = new ArrayList&lt;&gt;();
     sqlParameters.add(null);
     assertThatIllegalArgumentException().isThrownBy(() -&gt; storedProcExecutor.setSqlParameters(sqlParameters)).withMessage("'sqlParameters' cannot contain null values.");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSetSqlParametersWithNullValueInList</span><span class="hljs-params">()</span> </span>{

    DataSource datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    StoredProcExecutor storedProcExecutor = <span class="hljs-keyword">new</span> StoredProcExecutor(datasource);

    List&lt;SqlParameter&gt; sqlParameters = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    sqlParameters.add(<span class="hljs-keyword">null</span>);

    assertThatIllegalArgumentException().isThrownBy(() -&gt; storedProcExecutor.setSqlParameters(sqlParameters)).withMessage(<span class="hljs-string">"'sqlParameters' cannot contain null values."</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> DataSource datasource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
datasource;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest4610">Test Case ID #spring-integration_Test_46_10</h4>
<h4 id="test-case-name-testsetsqlparameterswithemptylistfile-cjavaprojectsspringspring-integrationspring-integration-jdbcsrctestjavaorgspringframeworkintegrationjdbcstoredprocexecutortestsjava">Test Case Name: <code>testSetSqlParametersWithEmptyList</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-jdbc\src\test\java\org\springframework\integration\jdbc\StoredProcExecutorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-datasource">Mock Object Variable Name: <code>datasource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testSetSqlParametersWithEmptyList() {
<span class="hljs-deletion">-    DataSource datasource = mock(DataSource.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `datasource`</span>
     StoredProcExecutor storedProcExecutor = new StoredProcExecutor(datasource);
     List&lt;SqlParameter&gt; sqlParameters = new ArrayList&lt;&gt;();
     assertThatIllegalArgumentException().isThrownBy(() -&gt; storedProcExecutor.setSqlParameters(sqlParameters)).withMessage("'sqlParameters' must not be null or empty.");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSetSqlParametersWithEmptyList</span><span class="hljs-params">()</span> </span>{

    DataSource datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    StoredProcExecutor storedProcExecutor = <span class="hljs-keyword">new</span> StoredProcExecutor(datasource);

    List&lt;SqlParameter&gt; sqlParameters = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    assertThatIllegalArgumentException().isThrownBy(() -&gt; storedProcExecutor.setSqlParameters(sqlParameters)).withMessage(<span class="hljs-string">"'sqlParameters' must not be null or empty."</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> DataSource datasource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
datasource;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest4611">Test Case ID #spring-integration_Test_46_11</h4>
<h4 id="test-case-name-testsetsqlparameterswithnulllistfile-cjavaprojectsspringspring-integrationspring-integration-jdbcsrctestjavaorgspringframeworkintegrationjdbcstoredprocexecutortestsjava">Test Case Name: <code>testSetSqlParametersWithNullList</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-jdbc\src\test\java\org\springframework\integration\jdbc\StoredProcExecutorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-datasource">Mock Object Variable Name: <code>datasource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testSetSqlParametersWithNullList() {
<span class="hljs-deletion">-    DataSource datasource = mock(DataSource.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `datasource`</span>
     StoredProcExecutor storedProcExecutor = new StoredProcExecutor(datasource);
     assertThatIllegalArgumentException().isThrownBy(() -&gt; storedProcExecutor.setSqlParameters(null)).withMessage("'sqlParameters' must not be null or empty.");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSetSqlParametersWithNullList</span><span class="hljs-params">()</span> </span>{

    DataSource datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    StoredProcExecutor storedProcExecutor = <span class="hljs-keyword">new</span> StoredProcExecutor(datasource);

    assertThatIllegalArgumentException().isThrownBy(() -&gt; storedProcExecutor.setSqlParameters(<span class="hljs-keyword">null</span>)).withMessage(<span class="hljs-string">"'sqlParameters' must not be null or empty."</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> DataSource datasource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
datasource;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest4612">Test Case ID #spring-integration_Test_46_12</h4>
<h4 id="test-case-name-testsetprocedureparameterswithnullvalueinlistfile-cjavaprojectsspringspring-integrationspring-integration-jdbcsrctestjavaorgspringframeworkintegrationjdbcstoredprocexecutortestsjava">Test Case Name: <code>testSetProcedureParametersWithNullValueInList</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-jdbc\src\test\java\org\springframework\integration\jdbc\StoredProcExecutorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-datasource">Mock Object Variable Name: <code>datasource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testSetProcedureParametersWithNullValueInList() {
<span class="hljs-deletion">-    DataSource datasource = mock(DataSource.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `datasource`</span>
     StoredProcExecutor storedProcExecutor = new StoredProcExecutor(datasource);
     List&lt;ProcedureParameter&gt; procedureParameters = new ArrayList&lt;&gt;();
     procedureParameters.add(null);
     assertThatIllegalArgumentException().isThrownBy(() -&gt; storedProcExecutor.setProcedureParameters(procedureParameters)).withMessage("'procedureParameters' cannot contain null values.");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSetProcedureParametersWithNullValueInList</span><span class="hljs-params">()</span> </span>{

    DataSource datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    StoredProcExecutor storedProcExecutor = <span class="hljs-keyword">new</span> StoredProcExecutor(datasource);

    List&lt;ProcedureParameter&gt; procedureParameters = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    procedureParameters.add(<span class="hljs-keyword">null</span>);

    assertThatIllegalArgumentException().isThrownBy(() -&gt; storedProcExecutor.setProcedureParameters(procedureParameters)).withMessage(<span class="hljs-string">"'procedureParameters' cannot contain null values."</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> DataSource datasource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
datasource;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest4613">Test Case ID #spring-integration_Test_46_13</h4>
<h4 id="test-case-name-testsetprocedureparameterswithemptylistfile-cjavaprojectsspringspring-integrationspring-integration-jdbcsrctestjavaorgspringframeworkintegrationjdbcstoredprocexecutortestsjava">Test Case Name: <code>testSetProcedureParametersWithEmptyList</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-jdbc\src\test\java\org\springframework\integration\jdbc\StoredProcExecutorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-datasource">Mock Object Variable Name: <code>datasource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
@Test
public void testSetProcedureParametersWithEmptyList() {
<span class="hljs-deletion">-    DataSource datasource = mock(DataSource.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `datasource`</span>
    StoredProcExecutor storedProcExecutor = new StoredProcExecutor(datasource);
    List&lt;ProcedureParameter&gt; procedureParameters = new ArrayList&lt;&gt;();
    assertThatIllegalArgumentException().isThrownBy(() -&gt; storedProcExecutor.setProcedureParameters(procedureParameters)).withMessage("'procedureParameters' must not be null or empty.");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSetProcedureParametersWithEmptyList</span><span class="hljs-params">()</span> </span>{

    DataSource datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    StoredProcExecutor storedProcExecutor = <span class="hljs-keyword">new</span> StoredProcExecutor(datasource);

    List&lt;ProcedureParameter&gt; procedureParameters = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    assertThatIllegalArgumentException().isThrownBy(() -&gt; storedProcExecutor.setProcedureParameters(procedureParameters)).withMessage(<span class="hljs-string">"'procedureParameters' must not be null or empty."</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> DataSource datasource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
datasource;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest4614">Test Case ID #spring-integration_Test_46_14</h4>
<h4 id="test-case-name-testsetprocedureparameterswithnulllistfile-cjavaprojectsspringspring-integrationspring-integration-jdbcsrctestjavaorgspringframeworkintegrationjdbcstoredprocexecutortestsjava">Test Case Name: <code>testSetProcedureParametersWithNullList</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-jdbc\src\test\java\org\springframework\integration\jdbc\StoredProcExecutorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-datasource">Mock Object Variable Name: <code>datasource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
@Test
public void testSetProcedureParametersWithNullList() {
<span class="hljs-deletion">-    DataSource datasource = mock(DataSource.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `datasource`</span>
    StoredProcExecutor storedProcExecutor = new StoredProcExecutor(datasource);
    assertThatIllegalArgumentException().isThrownBy(() -&gt; storedProcExecutor.setProcedureParameters(null)).withMessage("'procedureParameters' must not be null or empty.");
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSetProcedureParametersWithNullList</span><span class="hljs-params">()</span> </span>{

    DataSource datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    StoredProcExecutor storedProcExecutor = <span class="hljs-keyword">new</span> StoredProcExecutor(datasource);

    assertThatIllegalArgumentException().isThrownBy(() -&gt; storedProcExecutor.setProcedureParameters(<span class="hljs-keyword">null</span>)).withMessage(<span class="hljs-string">"'procedureParameters' must not be null or empty."</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> DataSource datasource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
datasource;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest4615">Test Case ID #spring-integration_Test_46_15</h4>
<h4 id="test-case-name-teststoredprocexecutorwithnonresolvingexpressionfile-cjavaprojectsspringspring-integrationspring-integration-jdbcsrctestjavaorgspringframeworkintegrationjdbcstoredprocexecutortestsjava">Test Case Name: <code>testStoredProcExecutorWithNonResolvingExpression</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-jdbc\src\test\java\org\springframework\integration\jdbc\StoredProcExecutorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-datasource">Mock Object Variable Name: <code>datasource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testStoredProcExecutorWithNonResolvingExpression() throws Exception {
<span class="hljs-deletion">-    final DataSource datasource = mock(DataSource.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `datasource`</span>
     final StoredProcExecutor storedProcExecutor = new StoredProcExecutor(datasource);
     final ExpressionFactoryBean efb = new ExpressionFactoryBean("headers['stored_procedure_name']");
     efb.afterPropertiesSet();
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStoredProcExecutorWithNonResolvingExpression</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-keyword">final</span> DataSource datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> StoredProcExecutor storedProcExecutor = <span class="hljs-keyword">new</span> StoredProcExecutor(datasource);

    <span class="hljs-keyword">final</span> ExpressionFactoryBean efb = <span class="hljs-keyword">new</span> ExpressionFactoryBean(<span class="hljs-string">"headers['stored_procedure_name']"</span>);

    efb.afterPropertiesSet();

    <span class="hljs-keyword">final</span> Expression expression = efb.getObject();

    storedProcExecutor.setStoredProcedureNameExpression(expression);

    storedProcExecutor.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    storedProcExecutor.afterPropertiesSet();

    Map&lt;String, SimpleJdbcCallOperations&gt; jdbcCallOperationsMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    jdbcCallOperationsMap.put(<span class="hljs-string">"123"</span>, mock(SimpleJdbcCallOperations<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">new</span> DirectFieldAccessor(storedProcExecutor).setPropertyValue(<span class="hljs-string">"jdbcCallOperationsMap"</span>, jdbcCallOperationsMap);

    <span class="hljs-comment">//This should work</span>

    storedProcExecutor.executeStoredProcedure(MessageBuilder.withPayload(<span class="hljs-string">"test"</span>).setHeader(<span class="hljs-string">"stored_procedure_name"</span>, <span class="hljs-string">"123"</span>).build());

    <span class="hljs-comment">//This should cause an exception</span>

    assertThatIllegalArgumentException().isThrownBy(() -&gt; storedProcExecutor.executeStoredProcedure(MessageBuilder.withPayload(<span class="hljs-string">"test"</span>).setHeader(<span class="hljs-string">"some_other_header"</span>, <span class="hljs-string">"123"</span>).build())).withMessage(<span class="hljs-string">"Unable to resolve Stored Procedure/Function name for the provided Expression "</span> + <span class="hljs-string">"'headers['stored_procedure_name']'."</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> DataSource datasource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    datasource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
datasource;

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci47">Mock Clone Instance #spring-integration_MCI_47</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.file.remote.session.SessionFactory&lt;org.springframework.integration.file.remote.gateway.RemoteFileOutboundGatewayTests.TestLsEntry&gt;</code></li>
<li><strong>Test Case Count</strong>: 6</li>
<li><strong>MO Count</strong>: 6</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; createMockSessionFactory(Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; session) {
    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)
    SessionFactory&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest471">Test Case ID #spring-integration_Test_47_1</h4>
<h4 id="test-case-name-testputfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testPut</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    @SuppressWarnings("unchecked")
<span class="hljs-deletion">-    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory.class);</span>
    @SuppressWarnings("unchecked")
    Session&lt;TestLsEntry&gt; session = mock(Session.class);
    RemoteFileTemplate&lt;TestLsEntry&gt; template = new RemoteFileTemplate&lt;TestLsEntry&gt;(sessionFactory) {

        @Override
        public boolean exists(String path) {
            return false;
        }
    };
    template.setRemoteDirectoryExpression(new LiteralExpression("foo/"));
    template.setBeanFactory(mock(BeanFactory.class));
    template.afterPropertiesSet();
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(template, "put", "payload");
    FileTransferringMessageHandler&lt;TestLsEntry&gt; handler = new FileTransferringMessageHandler&lt;&gt;(sessionFactory);
    handler.setRemoteDirectoryExpressionString("'foo/'");
    handler.setBeanFactory(mock(BeanFactory.class));
    handler.afterPropertiesSet();
    gw.afterPropertiesSet();
<span class="hljs-addition">+    SessionFactory&lt;TestLsEntry&gt; sessionFactory = createMockSessionFactory(session);</span>
    Message&lt;String&gt; requestMessage = MessageBuilder.withPayload("hello").setHeader(FileHeaders.FILENAME, "bar.txt").build();
    String path = (String) gw.handleRequestMessage(requestMessage);
    assertThat(path).isEqualTo("foo/bar.txt");
    ArgumentCaptor&lt;String&gt; captor = ArgumentCaptor.forClass(String.class);
    verify(session).write(any(InputStream.class), captor.capture());
    assertThat(captor.getValue()).isEqualTo("foo/bar.txt.writing");
    verify(session).rename("foo/bar.txt.writing", "foo/bar.txt");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testPut</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    Session&lt;TestLsEntry&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RemoteFileTemplate&lt;TestLsEntry&gt; template = <span class="hljs-keyword">new</span> RemoteFileTemplate&lt;TestLsEntry&gt;(sessionFactory) {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">exists</span><span class="hljs-params">(String path)</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;

        }

    };

    template.setRemoteDirectoryExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"foo/"</span>));

    template.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    template.afterPropertiesSet();

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(template, <span class="hljs-string">"put"</span>, <span class="hljs-string">"payload"</span>);

    FileTransferringMessageHandler&lt;TestLsEntry&gt; handler = <span class="hljs-keyword">new</span> FileTransferringMessageHandler&lt;&gt;(sessionFactory);

    handler.setRemoteDirectoryExpressionString(<span class="hljs-string">"'foo/'"</span>);

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    Message&lt;String&gt; requestMessage = MessageBuilder.withPayload(<span class="hljs-string">"hello"</span>).setHeader(FileHeaders.FILENAME, <span class="hljs-string">"bar.txt"</span>).build();

    String path = (String) gw.handleRequestMessage(requestMessage);

    assertThat(path).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    ArgumentCaptor&lt;String&gt; captor = ArgumentCaptor.forClass(String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(session).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">captor</span>.<span class="hljs-title">capture</span>())</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-string">"foo/bar.txt.writing"</span>);

    verify(session).rename(<span class="hljs-string">"foo/bar.txt.writing"</span>, <span class="hljs-string">"foo/bar.txt"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; createMockSessionFactory(Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; session) {
    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)
    SessionFactory&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest472">Test Case ID #spring-integration_Test_47_2</h4>
<h4 id="test-case-name-testputexistsfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testPutExists</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testPutExists() throws Exception {
     @SuppressWarnings("unchecked")
<span class="hljs-deletion">-    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory.class);</span>
     @SuppressWarnings("unchecked")
     Session&lt;TestLsEntry&gt; session = mock(Session.class);
     willReturn(Boolean.TRUE).given(session).exists(anyString());
     RemoteFileTemplate&lt;TestLsEntry&gt; template = new RemoteFileTemplate&lt;&gt;(sessionFactory);
     template.setRemoteDirectoryExpression(new LiteralExpression("foo/"));
     template.setBeanFactory(mock(BeanFactory.class));
     template.afterPropertiesSet();
     TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(template, "put", "payload");
     FileTransferringMessageHandler&lt;TestLsEntry&gt; handler = new FileTransferringMessageHandler&lt;&gt;(sessionFactory);
     handler.setRemoteDirectoryExpression(new LiteralExpression("foo/"));
     handler.setBeanFactory(mock(BeanFactory.class));
     handler.afterPropertiesSet();
     gw.afterPropertiesSet();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
<span class="hljs-addition">+    SessionFactory&lt;TestLsEntry&gt; sessionFactory = createMockSessionFactory(session);</span>
     Message&lt;String&gt; requestMessage = MessageBuilder.withPayload("hello").setHeader(FileHeaders.FILENAME, "bar.txt").build();
     // default (null) == REPLACE
     String path = (String) gw.handleRequestMessage(requestMessage);
     assertThat(path).isEqualTo("foo/bar.txt");
     ArgumentCaptor&lt;String&gt; captor = ArgumentCaptor.forClass(String.class);
     verify(session).write(any(InputStream.class), captor.capture());
     assertThat(captor.getValue()).isEqualTo("foo/bar.txt.writing");
     verify(session).rename("foo/bar.txt.writing", "foo/bar.txt");
     gw.setFileExistsMode(FileExistsMode.FAIL);
     assertThatExceptionOfType(MessageDeliveryException.class).isThrownBy(() -&gt; gw.handleRequestMessage(requestMessage)).withStackTraceContaining("The destination file already exists");
     gw.setFileExistsMode(FileExistsMode.REPLACE);
     path = (String) gw.handleRequestMessage(requestMessage);
     assertThat(path).isEqualTo("foo/bar.txt");
     captor = ArgumentCaptor.forClass(String.class);
     verify(session, times(2)).write(any(InputStream.class), captor.capture());
     assertThat(captor.getValue()).isEqualTo("foo/bar.txt.writing");
     verify(session, times(2)).rename("foo/bar.txt.writing", "foo/bar.txt");
     gw.setFileExistsMode(FileExistsMode.APPEND);
     path = (String) gw.handleRequestMessage(requestMessage);
     assertThat(path).isEqualTo("foo/bar.txt");
     captor = ArgumentCaptor.forClass(String.class);
     verify(session).append(any(InputStream.class), captor.capture());
     assertThat(captor.getValue()).isEqualTo("foo/bar.txt");
     gw.setFileExistsMode(FileExistsMode.IGNORE);
     path = (String) gw.handleRequestMessage(requestMessage);
     assertThat(path).isEqualTo("foo/bar.txt");
     // no more writes/appends
     verify(session, times(2)).write(any(InputStream.class), anyString());
     verify(session, times(1)).append(any(InputStream.class), anyString());
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testPutExists</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    Session&lt;TestLsEntry&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Boolean.TRUE).given(session).exists(anyString());

    RemoteFileTemplate&lt;TestLsEntry&gt; template = <span class="hljs-keyword">new</span> RemoteFileTemplate&lt;&gt;(sessionFactory);

    template.setRemoteDirectoryExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"foo/"</span>));

    template.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    template.afterPropertiesSet();

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(template, <span class="hljs-string">"put"</span>, <span class="hljs-string">"payload"</span>);

    FileTransferringMessageHandler&lt;TestLsEntry&gt; handler = <span class="hljs-keyword">new</span> FileTransferringMessageHandler&lt;&gt;(sessionFactory);

    handler.setRemoteDirectoryExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"foo/"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    Message&lt;String&gt; requestMessage = MessageBuilder.withPayload(<span class="hljs-string">"hello"</span>).setHeader(FileHeaders.FILENAME, <span class="hljs-string">"bar.txt"</span>).build();

    <span class="hljs-comment">// default (null) == REPLACE</span>

    String path = (String) gw.handleRequestMessage(requestMessage);

    assertThat(path).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    ArgumentCaptor&lt;String&gt; captor = ArgumentCaptor.forClass(String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(session).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">captor</span>.<span class="hljs-title">capture</span>())</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-string">"foo/bar.txt.writing"</span>);

    verify(session).rename(<span class="hljs-string">"foo/bar.txt.writing"</span>, <span class="hljs-string">"foo/bar.txt"</span>);

    gw.setFileExistsMode(FileExistsMode.FAIL);

    assertThatExceptionOfType(MessageDeliveryException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(() -&gt; <span class="hljs-title">gw</span>.<span class="hljs-title">handleRequestMessage</span>(<span class="hljs-title">requestMessage</span>)).<span class="hljs-title">withStackTraceContaining</span>("<span class="hljs-title">The</span> <span class="hljs-title">destination</span> <span class="hljs-title">file</span> <span class="hljs-title">already</span> <span class="hljs-title">exists</span>")</span>;

    gw.setFileExistsMode(FileExistsMode.REPLACE);

    path = (String) gw.handleRequestMessage(requestMessage);

    assertThat(path).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    captor = ArgumentCaptor.forClass(String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(session, times(<span class="hljs-number">2</span>)).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">captor</span>.<span class="hljs-title">capture</span>())</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-string">"foo/bar.txt.writing"</span>);

    verify(session, times(<span class="hljs-number">2</span>)).rename(<span class="hljs-string">"foo/bar.txt.writing"</span>, <span class="hljs-string">"foo/bar.txt"</span>);

    gw.setFileExistsMode(FileExistsMode.APPEND);

    path = (String) gw.handleRequestMessage(requestMessage);

    assertThat(path).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    captor = ArgumentCaptor.forClass(String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(session).append(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">captor</span>.<span class="hljs-title">capture</span>())</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    gw.setFileExistsMode(FileExistsMode.IGNORE);

    path = (String) gw.handleRequestMessage(requestMessage);

    assertThat(path).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    <span class="hljs-comment">// no more writes/appends</span>

    verify(session, times(<span class="hljs-number">2</span>)).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;

    verify(session, times(<span class="hljs-number">1</span>)).append(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; createMockSessionFactory(Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; session) {
    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)
    SessionFactory&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest473">Test Case ID #spring-integration_Test_47_3</h4>
<h4 id="test-case-name-testputexistsexpressionfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testPutExistsExpression</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 @SuppressWarnings("unchecked")
 public void testPutExistsExpression() throws Exception {
<span class="hljs-deletion">-    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory.class);</span>
     Session&lt;TestLsEntry&gt; session = mock(Session.class);
     willReturn(Boolean.TRUE).given(session).exists(anyString());
     RemoteFileTemplate&lt;TestLsEntry&gt; template = new RemoteFileTemplate&lt;&gt;(sessionFactory);
     template.setRemoteDirectoryExpression(new LiteralExpression("foo/"));
     template.setBeanFactory(mock(BeanFactory.class));
     template.afterPropertiesSet();
     TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(template, "put", "payload");
     FileTransferringMessageHandler&lt;TestLsEntry&gt; handler = new FileTransferringMessageHandler&lt;&gt;(sessionFactory);
     handler.setRemoteDirectoryExpression(new LiteralExpression("foo/"));
     handler.setBeanFactory(mock(BeanFactory.class));
     handler.afterPropertiesSet();
     gw.afterPropertiesSet();
     gw.setFileExistsModeExpressionString("headers[\"file.exists.mode\"]");
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
<span class="hljs-addition">+    SessionFactory&lt;TestLsEntry&gt; sessionFactory = createMockSessionFactory(session);</span>
     MessageBuilder&lt;String&gt; requestMessageBuilder = MessageBuilder.withPayload("hello").setHeader(FileHeaders.FILENAME, "bar.txt");
     Message&lt;String&gt; defaultMessage = requestMessageBuilder.build();
     String path = (String) gw.handleRequestMessage(defaultMessage);
     assertThat(path).isEqualTo("foo/bar.txt");
     ArgumentCaptor&lt;String&gt; captor = ArgumentCaptor.forClass(String.class);
     verify(session).write(any(InputStream.class), captor.capture());
     assertThat(captor.getValue()).isEqualTo("foo/bar.txt.writing");
     verify(session).rename("foo/bar.txt.writing", "foo/bar.txt");
     Message&lt;String&gt; failMessage = requestMessageBuilder.setHeader("file.exists.mode", FileExistsMode.FAIL).build();
     assertThatExceptionOfType(MessageDeliveryException.class).isThrownBy(() -&gt; gw.handleRequestMessage(failMessage)).withStackTraceContaining("The destination file already exists");
     Message&lt;String&gt; replaceMessage = requestMessageBuilder.setHeader("file.exists.mode", "replace").build();
     path = (String) gw.handleRequestMessage(replaceMessage);
     assertThat(path).isEqualTo("foo/bar.txt");
     captor = ArgumentCaptor.forClass(String.class);
     verify(session, times(2)).write(any(InputStream.class), captor.capture());
     assertThat(captor.getValue()).isEqualTo("foo/bar.txt.writing");
     verify(session, times(2)).rename("foo/bar.txt.writing", "foo/bar.txt");
     Message&lt;String&gt; appendMessage = requestMessageBuilder.setHeader("file.exists.mode", "APPEND").build();
     path = (String) gw.handleRequestMessage(appendMessage);
     assertThat(path).isEqualTo("foo/bar.txt");
     captor = ArgumentCaptor.forClass(String.class);
     verify(session).append(any(InputStream.class), captor.capture());
     assertThat(captor.getValue()).isEqualTo("foo/bar.txt");
     Message&lt;String&gt; ignoreMessage = requestMessageBuilder.setHeader("file.exists.mode", FileExistsMode.IGNORE).build();
     path = (String) gw.handleRequestMessage(ignoreMessage);
     assertThat(path).isEqualTo("foo/bar.txt");
     // no more writes/appends
     verify(session, times(2)).write(any(InputStream.class), anyString());
     verify(session, times(1)).append(any(InputStream.class), anyString());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testPutExistsExpression</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;TestLsEntry&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Boolean.TRUE).given(session).exists(anyString());

    RemoteFileTemplate&lt;TestLsEntry&gt; template = <span class="hljs-keyword">new</span> RemoteFileTemplate&lt;&gt;(sessionFactory);

    template.setRemoteDirectoryExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"foo/"</span>));

    template.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    template.afterPropertiesSet();

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(template, <span class="hljs-string">"put"</span>, <span class="hljs-string">"payload"</span>);

    FileTransferringMessageHandler&lt;TestLsEntry&gt; handler = <span class="hljs-keyword">new</span> FileTransferringMessageHandler&lt;&gt;(sessionFactory);

    handler.setRemoteDirectoryExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"foo/"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    gw.afterPropertiesSet();

    gw.setFileExistsModeExpressionString(<span class="hljs-string">"headers[\"file.exists.mode\"]"</span>);

    when(sessionFactory.getSession()).thenReturn(session);

    MessageBuilder&lt;String&gt; requestMessageBuilder = MessageBuilder.withPayload(<span class="hljs-string">"hello"</span>).setHeader(FileHeaders.FILENAME, <span class="hljs-string">"bar.txt"</span>);

    Message&lt;String&gt; defaultMessage = requestMessageBuilder.build();

    String path = (String) gw.handleRequestMessage(defaultMessage);

    assertThat(path).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    ArgumentCaptor&lt;String&gt; captor = ArgumentCaptor.forClass(String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(session).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">captor</span>.<span class="hljs-title">capture</span>())</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-string">"foo/bar.txt.writing"</span>);

    verify(session).rename(<span class="hljs-string">"foo/bar.txt.writing"</span>, <span class="hljs-string">"foo/bar.txt"</span>);

    Message&lt;String&gt; failMessage = requestMessageBuilder.setHeader(<span class="hljs-string">"file.exists.mode"</span>, FileExistsMode.FAIL).build();

    assertThatExceptionOfType(MessageDeliveryException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(() -&gt; <span class="hljs-title">gw</span>.<span class="hljs-title">handleRequestMessage</span>(<span class="hljs-title">failMessage</span>)).<span class="hljs-title">withStackTraceContaining</span>("<span class="hljs-title">The</span> <span class="hljs-title">destination</span> <span class="hljs-title">file</span> <span class="hljs-title">already</span> <span class="hljs-title">exists</span>")</span>;

    Message&lt;String&gt; replaceMessage = requestMessageBuilder.setHeader(<span class="hljs-string">"file.exists.mode"</span>, <span class="hljs-string">"replace"</span>).build();

    path = (String) gw.handleRequestMessage(replaceMessage);

    assertThat(path).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    captor = ArgumentCaptor.forClass(String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(session, times(<span class="hljs-number">2</span>)).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">captor</span>.<span class="hljs-title">capture</span>())</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-string">"foo/bar.txt.writing"</span>);

    verify(session, times(<span class="hljs-number">2</span>)).rename(<span class="hljs-string">"foo/bar.txt.writing"</span>, <span class="hljs-string">"foo/bar.txt"</span>);

    Message&lt;String&gt; appendMessage = requestMessageBuilder.setHeader(<span class="hljs-string">"file.exists.mode"</span>, <span class="hljs-string">"APPEND"</span>).build();

    path = (String) gw.handleRequestMessage(appendMessage);

    assertThat(path).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    captor = ArgumentCaptor.forClass(String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(session).append(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">captor</span>.<span class="hljs-title">capture</span>())</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    Message&lt;String&gt; ignoreMessage = requestMessageBuilder.setHeader(<span class="hljs-string">"file.exists.mode"</span>, FileExistsMode.IGNORE).build();

    path = (String) gw.handleRequestMessage(ignoreMessage);

    assertThat(path).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    <span class="hljs-comment">// no more writes/appends</span>

    verify(session, times(<span class="hljs-number">2</span>)).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;

    verify(session, times(<span class="hljs-number">1</span>)).append(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; createMockSessionFactory(Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; session) {
    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)
    SessionFactory&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest474">Test Case ID #spring-integration_Test_47_4</h4>
<h4 id="test-case-name-testmputfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testMput</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 @SuppressWarnings("unchecked")
 public void testMput() throws Exception {
<span class="hljs-deletion">-    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory.class);</span>
     Session&lt;TestLsEntry&gt; session = mock(Session.class);
<span class="hljs-addition">+    SessionFactory&lt;TestLsEntry&gt; sessionFactory = createMockSessionFactory(session);</span>
     RemoteFileTemplate&lt;TestLsEntry&gt; template = new RemoteFileTemplate&lt;&gt;(sessionFactory);
     template.setRemoteDirectoryExpression(new LiteralExpression("foo/"));
     template.setBeanFactory(mock(BeanFactory.class));
     template.afterPropertiesSet();
     TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(template, "mput", "payload");
     gw.afterPropertiesSet();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
     final AtomicReference&lt;String&gt; written = new AtomicReference&lt;&gt;();
     doAnswer(invocation -&gt; {
         written.set(invocation.getArgument(1));
         return null;
     }).when(session).write(any(InputStream.class), anyString());
     assertThat(new File(tempFolder, "baz.txt").createNewFile()).isTrue();
     assertThat(new File(tempFolder, "qux.txt").createNewFile()).isTrue();
     Message&lt;File&gt; requestMessage = MessageBuilder.withPayload(tempFolder).build();
     List&lt;String&gt; out = (List&lt;String&gt;) gw.handleRequestMessage(requestMessage);
     assertThat(out).hasSize(2);
     assertThat(out.get(0)).isNotEqualTo(out.get(1));
     assertThat(out.get(0)).isIn("foo/baz.txt", "foo/qux.txt");
     assertThat(out.get(1)).isIn("foo/baz.txt", "foo/qux.txt");
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMput</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;TestLsEntry&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RemoteFileTemplate&lt;TestLsEntry&gt; template = <span class="hljs-keyword">new</span> RemoteFileTemplate&lt;&gt;(sessionFactory);

    template.setRemoteDirectoryExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"foo/"</span>));

    template.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    template.afterPropertiesSet();

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(template, <span class="hljs-string">"mput"</span>, <span class="hljs-string">"payload"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    <span class="hljs-keyword">final</span> AtomicReference&lt;String&gt; written = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    doAnswer(invocation -&gt; {

        written.set(invocation.getArgument(<span class="hljs-number">1</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(session).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;

    assertThat(<span class="hljs-keyword">new</span> File(tempFolder, <span class="hljs-string">"baz.txt"</span>).createNewFile()).isTrue();

    assertThat(<span class="hljs-keyword">new</span> File(tempFolder, <span class="hljs-string">"qux.txt"</span>).createNewFile()).isTrue();

    Message&lt;File&gt; requestMessage = MessageBuilder.withPayload(tempFolder).build();

    List&lt;String&gt; out = (List&lt;String&gt;) gw.handleRequestMessage(requestMessage);

    assertThat(out).hasSize(<span class="hljs-number">2</span>);

    assertThat(out.get(<span class="hljs-number">0</span>)).isNotEqualTo(out.get(<span class="hljs-number">1</span>));

    assertThat(out.get(<span class="hljs-number">0</span>)).isIn(<span class="hljs-string">"foo/baz.txt"</span>, <span class="hljs-string">"foo/qux.txt"</span>);

    assertThat(out.get(<span class="hljs-number">1</span>)).isIn(<span class="hljs-string">"foo/baz.txt"</span>, <span class="hljs-string">"foo/qux.txt"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; createMockSessionFactory(Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; session) {
    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)
    SessionFactory&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest475">Test Case ID #spring-integration_Test_47_5</h4>
<h4 id="test-case-name-testmputrecursivefile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testMputRecursive</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 @SuppressWarnings("unchecked")
 public void testMputRecursive() throws Exception {
<span class="hljs-deletion">-    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory.class);</span>
     Session&lt;TestLsEntry&gt; session = mock(Session.class);
<span class="hljs-addition">+    SessionFactory&lt;TestLsEntry&gt; sessionFactory = createMockSessionFactory(session);</span>
     RemoteFileTemplate&lt;TestLsEntry&gt; template = new RemoteFileTemplate&lt;&gt;(sessionFactory);
     template.setRemoteDirectoryExpression(new LiteralExpression("foo/"));
     template.setBeanFactory(mock(BeanFactory.class));
     template.afterPropertiesSet();
     TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(template, "mput", null);
     gw.setOptions("-R");
     gw.afterPropertiesSet();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
     final AtomicReference&lt;String&gt; written = new AtomicReference&lt;&gt;();
     doAnswer(invocation -&gt; {
         written.set(invocation.getArgument(1));
         return null;
     }).when(session).write(any(InputStream.class), anyString());
     new File(tempFolder, "baz.txt").createNewFile();
     new File(tempFolder, "qux.txt").createNewFile();
     File dir1 = Files.createTempDirectory(tempFolder.toPath(), "junit").toFile();
     File file3 = File.createTempFile("foo", ".txt", dir1);
     Message&lt;File&gt; requestMessage = MessageBuilder.withPayload(tempFolder).build();
     List&lt;String&gt; out = (List&lt;String&gt;) gw.handleRequestMessage(requestMessage);
     assertThat(out).hasSize(3);
     assertThat(out.get(0)).isNotEqualTo(out.get(1));
     assertThat(out.get(0)).isIn("foo/baz.txt", "foo/qux.txt", "foo/" + dir1.getName() + "/" + file3.getName());
     assertThat(out.get(1)).isIn("foo/baz.txt", "foo/qux.txt", "foo/" + dir1.getName() + "/" + file3.getName());
     assertThat(out.get(2)).isIn("foo/baz.txt", "foo/qux.txt", "foo/" + dir1.getName() + "/" + file3.getName());
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMputRecursive</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;TestLsEntry&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RemoteFileTemplate&lt;TestLsEntry&gt; template = <span class="hljs-keyword">new</span> RemoteFileTemplate&lt;&gt;(sessionFactory);

    template.setRemoteDirectoryExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"foo/"</span>));

    template.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    template.afterPropertiesSet();

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(template, <span class="hljs-string">"mput"</span>, <span class="hljs-keyword">null</span>);

    gw.setOptions(<span class="hljs-string">"-R"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    <span class="hljs-keyword">final</span> AtomicReference&lt;String&gt; written = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    doAnswer(invocation -&gt; {

        written.set(invocation.getArgument(<span class="hljs-number">1</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(session).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;

    <span class="hljs-keyword">new</span> File(tempFolder, <span class="hljs-string">"baz.txt"</span>).createNewFile();

    <span class="hljs-keyword">new</span> File(tempFolder, <span class="hljs-string">"qux.txt"</span>).createNewFile();

    File dir1 = Files.createTempDirectory(tempFolder.toPath(), <span class="hljs-string">"junit"</span>).toFile();

    File file3 = File.createTempFile(<span class="hljs-string">"foo"</span>, <span class="hljs-string">".txt"</span>, dir1);

    Message&lt;File&gt; requestMessage = MessageBuilder.withPayload(tempFolder).build();

    List&lt;String&gt; out = (List&lt;String&gt;) gw.handleRequestMessage(requestMessage);

    assertThat(out).hasSize(<span class="hljs-number">3</span>);

    assertThat(out.get(<span class="hljs-number">0</span>)).isNotEqualTo(out.get(<span class="hljs-number">1</span>));

    assertThat(out.get(<span class="hljs-number">0</span>)).isIn(<span class="hljs-string">"foo/baz.txt"</span>, <span class="hljs-string">"foo/qux.txt"</span>, <span class="hljs-string">"foo/"</span> + dir1.getName() + <span class="hljs-string">"/"</span> + file3.getName());

    assertThat(out.get(<span class="hljs-number">1</span>)).isIn(<span class="hljs-string">"foo/baz.txt"</span>, <span class="hljs-string">"foo/qux.txt"</span>, <span class="hljs-string">"foo/"</span> + dir1.getName() + <span class="hljs-string">"/"</span> + file3.getName());

    assertThat(out.get(<span class="hljs-number">2</span>)).isIn(<span class="hljs-string">"foo/baz.txt"</span>, <span class="hljs-string">"foo/qux.txt"</span>, <span class="hljs-string">"foo/"</span> + dir1.getName() + <span class="hljs-string">"/"</span> + file3.getName());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; createMockSessionFactory(Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; session) {
    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)
    SessionFactory&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest476">Test Case ID #spring-integration_Test_47_6</h4>
<h4 id="test-case-name-testmputcollectionfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testMputCollection</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-sessionfactory">Mock Object Variable Name: <code>sessionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 @SuppressWarnings("unchecked")
 public void testMputCollection() throws Exception {
<span class="hljs-deletion">-    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory.class);</span>
     Session&lt;TestLsEntry&gt; session = mock(Session.class);
     TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "mput", "payload");
     gw.setRemoteDirectoryExpression(new LiteralExpression("foo/"));
     gw.afterPropertiesSet();
<span class="hljs-deletion">-    when(sessionFactory.getSession()).thenReturn(session);</span>
<span class="hljs-addition">+    SessionFactory&lt;TestLsEntry&gt; sessionFactory = createMockSessionFactory(session);</span>
     final AtomicReference&lt;String&gt; written = new AtomicReference&lt;&gt;();
     doAnswer(invocation -&gt; {
         written.set(invocation.getArgument(1));
         return null;
     }).when(session).write(any(InputStream.class), anyString());
     List&lt;File&gt; files = new ArrayList&lt;&gt;();
     File file1 = new File(tempFolder, "fiz.txt");
     file1.createNewFile();
     files.add(file1);
     File file2 = new File(tempFolder, "buz.txt");
     file2.createNewFile();
     files.add(file2);
     Message&lt;List&lt;File&gt;&gt; requestMessage = MessageBuilder.withPayload(files).build();
     List&lt;String&gt; out = (List&lt;String&gt;) gw.handleRequestMessage(requestMessage);
     assertThat(out).isNotNull().hasSize(2);
     assertThat(out.get(0)).isNotEqualTo(out.get(1));
     assertThat(out.get(0)).isEqualTo("foo/fiz.txt");
     assertThat(out.get(1)).isEqualTo("foo/buz.txt");
     assertThat(written.get()).isEqualTo("foo/buz.txt.writing");
     verify(session).rename("foo/buz.txt.writing", "foo/buz.txt");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMputCollection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;TestLsEntry&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"mput"</span>, <span class="hljs-string">"payload"</span>);

    gw.setRemoteDirectoryExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"foo/"</span>));

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    <span class="hljs-keyword">final</span> AtomicReference&lt;String&gt; written = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    doAnswer(invocation -&gt; {

        written.set(invocation.getArgument(<span class="hljs-number">1</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(session).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;

    List&lt;File&gt; files = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    File file1 = <span class="hljs-keyword">new</span> File(tempFolder, <span class="hljs-string">"fiz.txt"</span>);

    file1.createNewFile();

    files.add(file1);

    File file2 = <span class="hljs-keyword">new</span> File(tempFolder, <span class="hljs-string">"buz.txt"</span>);

    file2.createNewFile();

    files.add(file2);

    Message&lt;List&lt;File&gt;&gt; requestMessage = MessageBuilder.withPayload(files).build();

    List&lt;String&gt; out = (List&lt;String&gt;) gw.handleRequestMessage(requestMessage);

    assertThat(out).isNotNull().hasSize(<span class="hljs-number">2</span>);

    assertThat(out.get(<span class="hljs-number">0</span>)).isNotEqualTo(out.get(<span class="hljs-number">1</span>));

    assertThat(out.get(<span class="hljs-number">0</span>)).isEqualTo(<span class="hljs-string">"foo/fiz.txt"</span>);

    assertThat(out.get(<span class="hljs-number">1</span>)).isEqualTo(<span class="hljs-string">"foo/buz.txt"</span>);

    assertThat(written.get()).isEqualTo(<span class="hljs-string">"foo/buz.txt.writing"</span>);

    verify(session).rename(<span class="hljs-string">"foo/buz.txt.writing"</span>, <span class="hljs-string">"foo/buz.txt"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; createMockSessionFactory(Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; session) {
    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)
    SessionFactory&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(sessionFactory.getSession()).thenReturn(session);
    <span class="hljs-keyword">return</span> sessionFactory;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci48">Mock Clone Instance #spring-integration_MCI_48</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.ws.soap.SoapMessage</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SoapMessage <span class="hljs-title">createMockSoapMessage</span><span class="hljs-params">(String soapActionReturn)</span> </span>{
    SoapMessage soapMessage = mock(SoapMessage<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(soapMessage.getSoapAction()).thenReturn(soapActionReturn);
    <span class="hljs-keyword">return</span> soapMessage;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest481">Test Case ID #spring-integration_Test_48_1</h4>
<h4 id="test-case-name-testextractstandardheadersemptysoapactionfile-cjavaprojectsspringspring-integrationspring-integration-wssrctestjavaorgspringframeworkintegrationwsdefaultsoapheadermappertestsjava">Test Case Name: <code>testExtractStandardHeadersEmptySoapAction</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ws\src\test\java\org\springframework\integration\ws\DefaultSoapHeaderMapperTests.java</code>)</h4>
<h4 id="mock-object-variable-name-soapmessage">Mock Object Variable Name: <code>soapMessage</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     DefaultSoapHeaderMapper mapper = new DefaultSoapHeaderMapper();
<span class="hljs-deletion">-    SoapMessage soapMessage = mock(SoapMessage.class);</span>
<span class="hljs-deletion">-    when(soapMessage.getSoapAction()).thenReturn("");</span>
<span class="hljs-addition">+    SoapMessage soapMessage = createMockSoapMessage("");</span>
     assertThat(mapper.extractStandardHeaders(soapMessage).isEmpty()).isTrue();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testExtractStandardHeadersEmptySoapAction</span><span class="hljs-params">()</span> </span>{

    DefaultSoapHeaderMapper mapper = <span class="hljs-keyword">new</span> DefaultSoapHeaderMapper();

    SoapMessage soapMessage = mock(SoapMessage<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(soapMessage.getSoapAction()).thenReturn(<span class="hljs-string">""</span>);

    assertThat(mapper.extractStandardHeaders(soapMessage).isEmpty()).isTrue();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SoapMessage <span class="hljs-title">createMockSoapMessage</span><span class="hljs-params">(String soapActionReturn)</span> </span>{
    SoapMessage soapMessage = mock(SoapMessage<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(soapMessage.getSoapAction()).thenReturn(soapActionReturn);
    <span class="hljs-keyword">return</span> soapMessage;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest482">Test Case ID #spring-integration_Test_48_2</h4>
<h4 id="test-case-name-testextractstandardheadersnonemptysoapactionfile-cjavaprojectsspringspring-integrationspring-integration-wssrctestjavaorgspringframeworkintegrationwsdefaultsoapheadermappertestsjava">Test Case Name: <code>testExtractStandardHeadersNonEmptySoapAction</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ws\src\test\java\org\springframework\integration\ws\DefaultSoapHeaderMapperTests.java</code>)</h4>
<h4 id="mock-object-variable-name-soapmessage">Mock Object Variable Name: <code>soapMessage</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    DefaultSoapHeaderMapper mapper = new DefaultSoapHeaderMapper();
<span class="hljs-deletion">-    SoapMessage soapMessage = mock(SoapMessage.class);</span>
<span class="hljs-deletion">-    when(soapMessage.getSoapAction()).thenReturn("foo");</span>
<span class="hljs-addition">+    SoapMessage soapMessage = createMockSoapMessage("foo");</span>
    Map&lt;String, Object&gt; standardHeaders = mapper.toHeadersFromRequest(soapMessage);
    assertThat(standardHeaders.size()).isEqualTo(1);
    assertThat(standardHeaders.containsKey(WebServiceHeaders.SOAP_ACTION)).isTrue();
    assertThat(standardHeaders.get(WebServiceHeaders.SOAP_ACTION)).isEqualTo("foo");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testExtractStandardHeadersNonEmptySoapAction</span><span class="hljs-params">()</span> </span>{

    DefaultSoapHeaderMapper mapper = <span class="hljs-keyword">new</span> DefaultSoapHeaderMapper();

    SoapMessage soapMessage = mock(SoapMessage<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(soapMessage.getSoapAction()).thenReturn(<span class="hljs-string">"foo"</span>);

    Map&lt;String, Object&gt; standardHeaders = mapper.toHeadersFromRequest(soapMessage);

    assertThat(standardHeaders.size()).isEqualTo(<span class="hljs-number">1</span>);

    assertThat(standardHeaders.containsKey(WebServiceHeaders.SOAP_ACTION)).isTrue();

    assertThat(standardHeaders.get(WebServiceHeaders.SOAP_ACTION)).isEqualTo(<span class="hljs-string">"foo"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SoapMessage <span class="hljs-title">createMockSoapMessage</span><span class="hljs-params">(String soapActionReturn)</span> </span>{
    SoapMessage soapMessage = mock(SoapMessage<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(soapMessage.getSoapAction()).thenReturn(soapActionReturn);
    <span class="hljs-keyword">return</span> soapMessage;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci49">Mock Clone Instance #spring-integration_MCI_49</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.rabbitmq.client.ConnectionFactory</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConnectionFactory <span class="hljs-title">createMockConnectionFactory</span><span class="hljs-params">(Connection connection)</span> </span>{
    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());
    <span class="hljs-keyword">return</span> connectionFactory;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest491">Test Case ID #spring-integration_Test_49_1</h4>
<h4 id="test-case-name-testackfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpinboundamqpmessagesourcetestsjava">Test Case Name: <code>testAck</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\inbound\AmqpMessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-connectionfactory">Mock Object Variable Name: <code>connectionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    willReturn(channel).given(connection).createChannel();
<span class="hljs-deletion">-    ConnectionFactory connectionFactory = mock(ConnectionFactory.class);</span>
<span class="hljs-deletion">-    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());</span>
<span class="hljs-addition">+    ConnectionFactory connectionFactory = createMockConnectionFactory(connection);</span>
    CachingConnectionFactory ccf = new CachingConnectionFactory(connectionFactory);
    AmqpMessageSource source = new AmqpMessageSource(ccf, "foo");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAck</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">true</span>).given(channel).isOpen();

    Envelope envelope = <span class="hljs-keyword">new</span> Envelope(<span class="hljs-number">123L</span>, <span class="hljs-keyword">false</span>, <span class="hljs-string">"ex"</span>, <span class="hljs-string">"rk"</span>);

    BasicProperties props = <span class="hljs-keyword">new</span> BasicProperties.Builder().contentType(MessageProperties.DEFAULT_CONTENT_TYPE).build();

    GetResponse getResponse = <span class="hljs-keyword">new</span> GetResponse(envelope, props, <span class="hljs-string">"bar"</span>.getBytes(), <span class="hljs-number">0</span>);

    willReturn(getResponse).given(channel).basicGet(<span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>);

    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">true</span>).given(connection).isOpen();

    willReturn(channel).given(connection).createChannel();

    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());

    CachingConnectionFactory ccf = <span class="hljs-keyword">new</span> CachingConnectionFactory(connectionFactory);

    AmqpMessageSource source = <span class="hljs-keyword">new</span> AmqpMessageSource(ccf, <span class="hljs-string">"foo"</span>);

    source.setRawMessageHeader(<span class="hljs-keyword">true</span>);

    Message&lt;?&gt; received = source.receive();

    assertThat(received.getHeaders().get(AmqpMessageHeaderErrorMessageStrategy.AMQP_RAW_MESSAGE)).isInstanceOf(org.springframework.amqp.core.Message<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    assertThat(received.getHeaders().get(IntegrationMessageHeaderAccessor.SOURCE_DATA)).isSameAs(received.getHeaders().get(AmqpMessageHeaderErrorMessageStrategy.AMQP_RAW_MESSAGE));

    assertThat(received.getHeaders().get(AmqpHeaders.CONSUMER_QUEUE)).isEqualTo(<span class="hljs-string">"foo"</span>);

    <span class="hljs-comment">// make sure channel is not cached</span>

    org.springframework.amqp.rabbit.connection.Connection conn = ccf.createConnection();

    <span class="hljs-comment">// should not have been "closed"</span>

    Channel notCached = conn.createChannel(<span class="hljs-keyword">false</span>);

    verify(connection, times(<span class="hljs-number">2</span>)).createChannel();

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(Status.ACCEPT);

    verify(channel).basicAck(<span class="hljs-number">123L</span>, <span class="hljs-keyword">false</span>);

    <span class="hljs-comment">// should have been "closed"</span>

    Channel cached = conn.createChannel(<span class="hljs-keyword">false</span>);

    verify(connection, times(<span class="hljs-number">2</span>)).createChannel();

    notCached.close();

    cached.close();

    ccf.destroy();

    verify(channel, times(<span class="hljs-number">2</span>)).close();

    verify(connection).close(<span class="hljs-number">30000</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConnectionFactory <span class="hljs-title">createMockConnectionFactory</span><span class="hljs-params">(Connection connection)</span> </span>{
    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());
    <span class="hljs-keyword">return</span> connectionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest492">Test Case ID #spring-integration_Test_49_2</h4>
<h4 id="test-case-name-testnackorrequeuefile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpinboundamqpmessagesourcetestsjava">Test Case Name: <code>testNackOrRequeue</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\inbound\AmqpMessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-connectionfactory">Mock Object Variable Name: <code>connectionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    willReturn(true).given(connection).isOpen();
    willReturn(channel).given(connection).createChannel();
<span class="hljs-deletion">-    ConnectionFactory connectionFactory = mock(ConnectionFactory.class);</span>
<span class="hljs-deletion">-    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());</span>
<span class="hljs-addition">+    ConnectionFactory connectionFactory = createMockConnectionFactory(connection);</span>
    CachingConnectionFactory ccf = new CachingConnectionFactory(connectionFactory);
    AmqpMessageSource source = new AmqpMessageSource(ccf, "foo");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNackOrRequeue</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> requeue)</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">true</span>).given(channel).isOpen();

    Envelope envelope = <span class="hljs-keyword">new</span> Envelope(<span class="hljs-number">123L</span>, <span class="hljs-keyword">false</span>, <span class="hljs-string">"ex"</span>, <span class="hljs-string">"rk"</span>);

    BasicProperties props = <span class="hljs-keyword">new</span> BasicProperties.Builder().contentType(MessageProperties.DEFAULT_CONTENT_TYPE).build();

    GetResponse getResponse = <span class="hljs-keyword">new</span> GetResponse(envelope, props, <span class="hljs-string">"bar"</span>.getBytes(), <span class="hljs-number">0</span>);

    willReturn(getResponse).given(channel).basicGet(<span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>);

    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">true</span>).given(connection).isOpen();

    willReturn(channel).given(connection).createChannel();

    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());

    CachingConnectionFactory ccf = <span class="hljs-keyword">new</span> CachingConnectionFactory(connectionFactory);

    AmqpMessageSource source = <span class="hljs-keyword">new</span> AmqpMessageSource(ccf, <span class="hljs-string">"foo"</span>);

    Message&lt;?&gt; received = source.receive();

    verify(connection).createChannel();

    StaticMessageHeaderAccessor.getAcknowledgmentCallback(received).acknowledge(requeue ? Status.REQUEUE : Status.REJECT);

    verify(channel).basicReject(<span class="hljs-number">123L</span>, requeue);

    verify(connection).createChannel();

    ccf.destroy();

    verify(channel).close();

    verify(connection).close(<span class="hljs-number">30000</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConnectionFactory <span class="hljs-title">createMockConnectionFactory</span><span class="hljs-params">(Connection connection)</span> </span>{
    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());
    <span class="hljs-keyword">return</span> connectionFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest493">Test Case ID #spring-integration_Test_49_3</h4>
<h4 id="test-case-name-testbatchfile-cjavaprojectsspringspring-integrationspring-integration-amqpsrctestjavaorgspringframeworkintegrationamqpinboundamqpmessagesourcetestsjava">Test Case Name: <code>testBatch</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-amqp\src\test\java\org\springframework\integration\amqp\inbound\AmqpMessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-connectionfactory">Mock Object Variable Name: <code>connectionFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    willReturn(true).given(connection).isOpen();
    willReturn(channel).given(connection).createChannel();
<span class="hljs-deletion">-    ConnectionFactory connectionFactory = mock(ConnectionFactory.class);</span>
<span class="hljs-deletion">-    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());</span>
<span class="hljs-addition">+    ConnectionFactory connectionFactory = createMockConnectionFactory(connection);</span>
    CachingConnectionFactory ccf = new CachingConnectionFactory(connectionFactory);
    AmqpMessageSource source = new AmqpMessageSource(ccf, "foo");
    Message&lt;?&gt; received = source.receive();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testBatch</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SimpleBatchingStrategy bs = <span class="hljs-keyword">new</span> SimpleBatchingStrategy(<span class="hljs-number">2</span>, <span class="hljs-number">10_000</span>, <span class="hljs-number">10_000L</span>);

    MessageProperties messageProperties = <span class="hljs-keyword">new</span> MessageProperties();

    messageProperties.setContentType(<span class="hljs-string">"text/plain"</span>);

    org.springframework.amqp.core.Message message = <span class="hljs-keyword">new</span> org.springframework.amqp.core.Message(<span class="hljs-string">"test1"</span>.getBytes(), messageProperties);

    bs.addToBatch(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>, message);

    message = <span class="hljs-keyword">new</span> org.springframework.amqp.core.Message(<span class="hljs-string">"test2"</span>.getBytes(), messageProperties);

    MessageBatch batched = bs.addToBatch(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>, message);

    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">true</span>).given(channel).isOpen();

    Envelope envelope = <span class="hljs-keyword">new</span> Envelope(<span class="hljs-number">123L</span>, <span class="hljs-keyword">false</span>, <span class="hljs-string">"ex"</span>, <span class="hljs-string">"rk"</span>);

    BasicProperties props = <span class="hljs-keyword">new</span> BasicProperties.Builder().headers(batched.message().getMessageProperties().getHeaders()).contentType(<span class="hljs-string">"text/plain"</span>).build();

    GetResponse getResponse = <span class="hljs-keyword">new</span> GetResponse(envelope, props, batched.message().getBody(), <span class="hljs-number">0</span>);

    willReturn(getResponse).given(channel).basicGet(<span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>);

    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">true</span>).given(connection).isOpen();

    willReturn(channel).given(connection).createChannel();

    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());

    CachingConnectionFactory ccf = <span class="hljs-keyword">new</span> CachingConnectionFactory(connectionFactory);

    AmqpMessageSource source = <span class="hljs-keyword">new</span> AmqpMessageSource(ccf, <span class="hljs-string">"foo"</span>);

    Message&lt;?&gt; received = source.receive();

    assertThat(received).isNotNull();

    assertThat(((List&lt;String&gt;) received.getPayload())).contains(<span class="hljs-string">"test1"</span>, <span class="hljs-string">"test2"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConnectionFactory <span class="hljs-title">createMockConnectionFactory</span><span class="hljs-params">(Connection connection)</span> </span>{
    ConnectionFactory connectionFactory = mock(ConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(connection).given(connectionFactory).newConnection((ExecutorService) isNull(), anyString());
    <span class="hljs-keyword">return</span> connectionFactory;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci50">Mock Clone Instance #spring-integration_MCI_50</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.kafka.clients.producer.Producer</code></li>
<li><strong>Test Case Count</strong>: 6</li>
<li><strong>MO Count</strong>: 6</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Producer <span class="hljs-title">createMockProducer</span><span class="hljs-params">()</span> </span>{
    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">given</span>(<span class="hljs-title">producer</span>).<span class="hljs-title">send</span>(<span class="hljs-title">any</span>(<span class="hljs-title">ProducerRecord</span>.<span class="hljs-title">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;
    <span class="hljs-keyword">return</span> producer;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest501">Test Case ID #spring-integration_Test_50_1</h4>
<h4 id="test-case-name-testtransactionfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkaoutboundkafkaproducermessagehandlertestsjava">Test Case Name: <code>testTransaction</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\outbound\KafkaProducerMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-producer">Mock Object Variable Name: <code>producer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ProducerFactory pf = mock(ProducerFactory.class);
    given(pf.transactionCapable()).willReturn(true);
<span class="hljs-deletion">-    Producer producer = mock(Producer.class);</span>
<span class="hljs-deletion">-    given(pf.createProducer(isNull())).willReturn(producer);</span>
<span class="hljs-deletion">-    willReturn(mock(Future.class)).given(producer).send(any(ProducerRecord.class), any(Callback.class));</span>
<span class="hljs-addition">+    Producer producer = createMockProducer();</span>
<span class="hljs-addition">+    given(pf.createProducer(isNull())).willReturn(producer);</span>
    KafkaTemplate template = new KafkaTemplate(pf);
    KafkaProducerMessageHandler handler = new KafkaProducerMessageHandler(template);
    handler.setTopicExpression(new LiteralExpression("bar"));
    handler.setBeanFactory(mock(BeanFactory.class));
    handler.afterPropertiesSet();
    handler.start();
    handler.handleMessage(new GenericMessage&lt;&gt;("foo"));
    handler.stop();
    InOrder inOrder = inOrder(producer);
    inOrder.verify(producer).beginTransaction();
    inOrder.verify(producer).send(any(ProducerRecord.class), any(Callback.class));
    inOrder.verify(producer).commitTransaction();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testTransaction</span><span class="hljs-params">()</span> </span>{

    ProducerFactory pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(pf.transactionCapable()).willReturn(<span class="hljs-keyword">true</span>);

    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(pf.createProducer(isNull())).willReturn(producer);

    willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">given</span>(<span class="hljs-title">producer</span>).<span class="hljs-title">send</span>(<span class="hljs-title">any</span>(<span class="hljs-title">ProducerRecord</span>.<span class="hljs-title">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;

    KafkaTemplate template = <span class="hljs-keyword">new</span> KafkaTemplate(pf);

    KafkaProducerMessageHandler handler = <span class="hljs-keyword">new</span> KafkaProducerMessageHandler(template);

    handler.setTopicExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    handler.start();

    handler.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>));

    handler.stop();

    InOrder inOrder = inOrder(producer);

    inOrder.verify(producer).beginTransaction();

    inOrder.verify(producer).send(any(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;

    inOrder.verify(producer).commitTransaction();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Producer <span class="hljs-title">createMockProducer</span><span class="hljs-params">()</span> </span>{
    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">given</span>(<span class="hljs-title">producer</span>).<span class="hljs-title">send</span>(<span class="hljs-title">any</span>(<span class="hljs-title">ProducerRecord</span>.<span class="hljs-title">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;
    <span class="hljs-keyword">return</span> producer;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest502">Test Case ID #spring-integration_Test_50_2</h4>
<h4 id="test-case-name-testtransactiontxidoverridefile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkaoutboundkafkaproducermessagehandlertestsjava">Test Case Name: <code>testTransactionTxIdOverride</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\outbound\KafkaProducerMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-producer">Mock Object Variable Name: <code>producer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testTransactionTxIdOverride() {
<span class="hljs-deletion">-    Producer producer = mock(Producer.class);</span>
<span class="hljs-addition">+    Producer producer = createMockProducer();</span>
    AtomicReference&lt;String&gt; txId = new AtomicReference&lt;&gt;();
    DefaultKafkaProducerFactory pf = new DefaultKafkaProducerFactory(Collections.emptyMap()) {

        @Override
        protected Producer createTransactionalProducer(String txIdPrefix) {
            txId.set(txIdPrefix);
            return producer;
        }
    };
<span class="hljs-deletion">-    willReturn(mock(Future.class)).given(producer).send(any(ProducerRecord.class), any(Callback.class));</span>
    KafkaTemplate template = new KafkaTemplate(pf);
    template.setTransactionIdPrefix("overridden.tx.id.");
    KafkaProducerMessageHandler handler = new KafkaProducerMessageHandler(template);
    handler.setTopicExpression(new LiteralExpression("bar"));
    handler.setBeanFactory(mock(BeanFactory.class));
    handler.afterPropertiesSet();
    handler.start();
    handler.handleMessage(new GenericMessage&lt;&gt;("foo"));
    handler.stop();
    InOrder inOrder = inOrder(producer);
    inOrder.verify(producer).beginTransaction();
    inOrder.verify(producer).send(any(ProducerRecord.class), any(Callback.class));
    inOrder.verify(producer).commitTransaction();
    assertThat(txId.get()).isEqualTo("overridden.tx.id.");
<span class="hljs-addition">+</span>
<span class="hljs-addition">+</span>
<span class="hljs-addition">+    // static import or qualification may be needed for createMockProducer()</span>
}
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testTransactionTxIdOverride</span><span class="hljs-params">()</span> </span>{

    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AtomicReference&lt;String&gt; txId = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    DefaultKafkaProducerFactory pf = <span class="hljs-keyword">new</span> DefaultKafkaProducerFactory(Collections.emptyMap()) {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">protected</span> Producer <span class="hljs-title">createTransactionalProducer</span><span class="hljs-params">(String txIdPrefix)</span> </span>{

            txId.set(txIdPrefix);

            <span class="hljs-keyword">return</span> producer;

        }

    };

    pf.setTransactionIdPrefix(<span class="hljs-string">"default.tx.id."</span>);

    willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">given</span>(<span class="hljs-title">producer</span>).<span class="hljs-title">send</span>(<span class="hljs-title">any</span>(<span class="hljs-title">ProducerRecord</span>.<span class="hljs-title">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;

    KafkaTemplate template = <span class="hljs-keyword">new</span> KafkaTemplate(pf);

    template.setTransactionIdPrefix(<span class="hljs-string">"overridden.tx.id."</span>);

    KafkaProducerMessageHandler handler = <span class="hljs-keyword">new</span> KafkaProducerMessageHandler(template);

    handler.setTopicExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    handler.start();

    handler.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>));

    handler.stop();

    InOrder inOrder = inOrder(producer);

    inOrder.verify(producer).beginTransaction();

    inOrder.verify(producer).send(any(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;

    inOrder.verify(producer).commitTransaction();

    assertThat(txId.get()).isEqualTo(<span class="hljs-string">"overridden.tx.id."</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Producer <span class="hljs-title">createMockProducer</span><span class="hljs-params">()</span> </span>{
    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">given</span>(<span class="hljs-title">producer</span>).<span class="hljs-title">send</span>(<span class="hljs-title">any</span>(<span class="hljs-title">ProducerRecord</span>.<span class="hljs-title">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;
    <span class="hljs-keyword">return</span> producer;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest503">Test Case ID #spring-integration_Test_50_3</h4>
<h4 id="test-case-name-testtransactionsynchfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkaoutboundkafkaproducermessagehandlertestsjava">Test Case Name: <code>testTransactionSynch</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\outbound\KafkaProducerMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-producer">Mock Object Variable Name: <code>producer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testTransactionSynch() {
<span class="hljs-deletion">-    Producer producer = mock(Producer.class);</span>
<span class="hljs-addition">+    Producer producer = createMockProducer();</span>
    ProducerFactory pf = mock(ProducerFactory.class);
    given(pf.transactionCapable()).willReturn(true);
    given(pf.createProducer(isNull())).willReturn(producer);
<span class="hljs-deletion">-    willReturn(mock(Future.class)).given(producer).send(any(ProducerRecord.class), any(Callback.class));</span>
    KafkaTemplate template = new KafkaTemplate(pf);
    KafkaProducerMessageHandler handler = new KafkaProducerMessageHandler(template);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testTransactionSynch</span><span class="hljs-params">()</span> </span>{

    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ProducerFactory pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(pf.transactionCapable()).willReturn(<span class="hljs-keyword">true</span>);

    given(pf.createProducer(isNull())).willReturn(producer);

    willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">given</span>(<span class="hljs-title">producer</span>).<span class="hljs-title">send</span>(<span class="hljs-title">any</span>(<span class="hljs-title">ProducerRecord</span>.<span class="hljs-title">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;

    KafkaTemplate template = <span class="hljs-keyword">new</span> KafkaTemplate(pf);

    KafkaProducerMessageHandler handler = <span class="hljs-keyword">new</span> KafkaProducerMessageHandler(template);

    handler.setTopicExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    handler.start();

    <span class="hljs-keyword">try</span> {

        <span class="hljs-keyword">new</span> TransactionTemplate(<span class="hljs-keyword">new</span> SomeOtherTransactionManager()).executeWithoutResult(status -&gt; {

            handler.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>));

            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">"test"</span>);

        });

    } <span class="hljs-keyword">catch</span> (IllegalStateException ex) {

    }

    handler.stop();

    verify(producer).beginTransaction();

    verify(producer).send(any(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;

    verify(producer).abortTransaction();

    verify(producer).close(any());

    verifyNoMoreInteractions(producer);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Producer <span class="hljs-title">createMockProducer</span><span class="hljs-params">()</span> </span>{
    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">given</span>(<span class="hljs-title">producer</span>).<span class="hljs-title">send</span>(<span class="hljs-title">any</span>(<span class="hljs-title">ProducerRecord</span>.<span class="hljs-title">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;
    <span class="hljs-keyword">return</span> producer;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest504">Test Case ID #spring-integration_Test_50_4</h4>
<h4 id="test-case-name-testflushfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkaoutboundkafkaproducermessagehandlertestsjava">Test Case Name: <code>testFlush</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\outbound\KafkaProducerMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-producer">Mock Object Variable Name: <code>producer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ProducerFactory pf = mock(ProducerFactory.class);
<span class="hljs-deletion">-    Producer producer = mock(Producer.class);</span>
<span class="hljs-addition">+    Producer producer = createMockProducer();</span>
    given(pf.createProducer()).willReturn(producer);
<span class="hljs-deletion">-    willReturn(mock(Future.class)).given(producer).send(any(ProducerRecord.class), any(Callback.class));</span>
    KafkaTemplate template = new KafkaTemplate(pf);
    KafkaProducerMessageHandler handler = new KafkaProducerMessageHandler(template);
    handler.setTopicExpression(new LiteralExpression("bar"));
    handler.setBeanFactory(mock(BeanFactory.class));
    handler.afterPropertiesSet();
    handler.start();
    handler.handleMessage(new GenericMessage&lt;&gt;("foo", Collections.singletonMap(KafkaIntegrationHeaders.FLUSH, Boolean.TRUE)));
    InOrder inOrder = inOrder(producer);
    ArgumentCaptor&lt;ProducerRecord&gt; captor = ArgumentCaptor.forClass(ProducerRecord.class);
    inOrder.verify(producer).send(captor.capture(), any(Callback.class));
    inOrder.verify(producer).flush();
    handler.stop();
    assertThat(captor.getValue().headers().lastHeader(KafkaIntegrationHeaders.FLUSH)).isNull();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testFlush</span><span class="hljs-params">()</span> </span>{

    ProducerFactory pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(pf.createProducer()).willReturn(producer);

    willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">given</span>(<span class="hljs-title">producer</span>).<span class="hljs-title">send</span>(<span class="hljs-title">any</span>(<span class="hljs-title">ProducerRecord</span>.<span class="hljs-title">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;

    KafkaTemplate template = <span class="hljs-keyword">new</span> KafkaTemplate(pf);

    KafkaProducerMessageHandler handler = <span class="hljs-keyword">new</span> KafkaProducerMessageHandler(template);

    handler.setTopicExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    handler.start();

    handler.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>, Collections.singletonMap(KafkaIntegrationHeaders.FLUSH, Boolean.TRUE)));

    InOrder inOrder = inOrder(producer);

    ArgumentCaptor&lt;ProducerRecord&gt; captor = ArgumentCaptor.forClass(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    inOrder.verify(producer).send(captor.capture(), any(Callback<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    inOrder.verify(producer).flush();

    handler.stop();

    assertThat(captor.getValue().headers().lastHeader(KafkaIntegrationHeaders.FLUSH)).isNull();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Producer <span class="hljs-title">createMockProducer</span><span class="hljs-params">()</span> </span>{
    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">given</span>(<span class="hljs-title">producer</span>).<span class="hljs-title">send</span>(<span class="hljs-title">any</span>(<span class="hljs-title">ProducerRecord</span>.<span class="hljs-title">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;
    <span class="hljs-keyword">return</span> producer;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest505">Test Case ID #spring-integration_Test_50_5</h4>
<h4 id="test-case-name-testnoflushfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkaoutboundkafkaproducermessagehandlertestsjava">Test Case Name: <code>testNoFlush</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\outbound\KafkaProducerMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-producer">Mock Object Variable Name: <code>producer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ProducerFactory pf = mock(ProducerFactory.class);
<span class="hljs-deletion">-    Producer producer = mock(Producer.class);</span>
<span class="hljs-addition">+    Producer producer = createMockProducer();</span>
    given(pf.createProducer()).willReturn(producer);
<span class="hljs-deletion">-    willReturn(mock(Future.class)).given(producer).send(any(ProducerRecord.class), any(Callback.class));</span>
    KafkaTemplate template = new KafkaTemplate(pf);
    KafkaProducerMessageHandler handler = new KafkaProducerMessageHandler(template);
    handler.setTopicExpression(new LiteralExpression("bar"));
    handler.setBeanFactory(mock(BeanFactory.class));
    handler.afterPropertiesSet();
    handler.start();
    handler.handleMessage(new GenericMessage&lt;&gt;("foo"));
    InOrder inOrder = inOrder(producer);
    inOrder.verify(producer).send(any(ProducerRecord.class), any(Callback.class));
    inOrder.verify(producer, never()).flush();
    handler.stop();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testNoFlush</span><span class="hljs-params">()</span> </span>{

    ProducerFactory pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(pf.createProducer()).willReturn(producer);

    willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">given</span>(<span class="hljs-title">producer</span>).<span class="hljs-title">send</span>(<span class="hljs-title">any</span>(<span class="hljs-title">ProducerRecord</span>.<span class="hljs-title">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;

    KafkaTemplate template = <span class="hljs-keyword">new</span> KafkaTemplate(pf);

    KafkaProducerMessageHandler handler = <span class="hljs-keyword">new</span> KafkaProducerMessageHandler(template);

    handler.setTopicExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    handler.start();

    handler.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>));

    InOrder inOrder = inOrder(producer);

    inOrder.verify(producer).send(any(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;

    inOrder.verify(producer, never()).flush();

    handler.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Producer <span class="hljs-title">createMockProducer</span><span class="hljs-params">()</span> </span>{
    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">given</span>(<span class="hljs-title">producer</span>).<span class="hljs-title">send</span>(<span class="hljs-title">any</span>(<span class="hljs-title">ProducerRecord</span>.<span class="hljs-title">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;
    <span class="hljs-keyword">return</span> producer;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest506">Test Case ID #spring-integration_Test_50_6</h4>
<h4 id="test-case-name-conversionfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkaoutboundkafkaproducermessagehandlertestsjava">Test Case Name: <code>conversion</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\outbound\KafkaProducerMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-producer">Mock Object Variable Name: <code>producer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ProducerFactory pf = mock(ProducerFactory.class);
<span class="hljs-deletion">-    Producer producer = mock(Producer.class);</span>
<span class="hljs-addition">+    Producer producer = createMockProducer();</span>
    given(pf.createProducer()).willReturn(producer);
<span class="hljs-deletion">-    willReturn(mock(Future.class)).given(producer).send(any(ProducerRecord.class), any(Callback.class));</span>
    KafkaTemplate template = new KafkaTemplate(pf);
    RecordMessageConverter converter = mock(RecordMessageConverter.class);
    ProducerRecord recordFromConverter = mock(ProducerRecord.class);
    given(converter.fromMessage(any(), any())).willReturn(recordFromConverter);
    template.setMessageConverter(converter);
    KafkaProducerMessageHandler handler = new KafkaProducerMessageHandler(template);
    handler.setTopicExpression(new LiteralExpression("bar"));
    handler.setBeanFactory(mock(BeanFactory.class));
    ProducerRecordCreator creator = mock(ProducerRecordCreator.class);
    ProducerRecord recordFromCreator = mock(ProducerRecord.class);
    given(creator.create(any(), any(), any(), any(), any(), any(), any())).willReturn(recordFromCreator);
    handler.setProducerRecordCreator(creator);
    handler.afterPropertiesSet();
    handler.start();
    handler.handleMessage(new GenericMessage&lt;&gt;("foo"));
    ArgumentCaptor&lt;ProducerRecord&gt; captor = ArgumentCaptor.forClass(ProducerRecord.class);
    verify(producer).send(captor.capture(), any(Callback.class));
    assertThat(captor.getValue()).isSameAs(recordFromCreator);
    handler.setUseTemplateConverter(true);
    handler.handleMessage(new GenericMessage&lt;&gt;("foo"));
    verify(producer, times(2)).send(captor.capture(), any(Callback.class));
    assertThat(captor.getValue()).isSameAs(recordFromConverter);
    handler.stop();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"rawtypes"</span>, <span class="hljs-string">"unchecked"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">conversion</span><span class="hljs-params">()</span> </span>{

    ProducerFactory pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(pf.createProducer()).willReturn(producer);

    willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">given</span>(<span class="hljs-title">producer</span>).<span class="hljs-title">send</span>(<span class="hljs-title">any</span>(<span class="hljs-title">ProducerRecord</span>.<span class="hljs-title">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;

    KafkaTemplate template = <span class="hljs-keyword">new</span> KafkaTemplate(pf);

    RecordMessageConverter converter = mock(RecordMessageConverter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ProducerRecord recordFromConverter = mock(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(converter.fromMessage(any(), any())).willReturn(recordFromConverter);

    template.setMessageConverter(converter);

    KafkaProducerMessageHandler handler = <span class="hljs-keyword">new</span> KafkaProducerMessageHandler(template);

    handler.setTopicExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ProducerRecordCreator creator = mock(ProducerRecordCreator<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ProducerRecord recordFromCreator = mock(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(creator.create(any(), any(), any(), any(), any(), any(), any())).willReturn(recordFromCreator);

    handler.setProducerRecordCreator(creator);

    handler.afterPropertiesSet();

    handler.start();

    handler.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>));

    ArgumentCaptor&lt;ProducerRecord&gt; captor = ArgumentCaptor.forClass(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(producer).send(captor.capture(), any(Callback<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    assertThat(captor.getValue()).isSameAs(recordFromCreator);

    handler.setUseTemplateConverter(<span class="hljs-keyword">true</span>);

    handler.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>));

    verify(producer, times(<span class="hljs-number">2</span>)).send(captor.capture(), any(Callback<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    assertThat(captor.getValue()).isSameAs(recordFromConverter);

    handler.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Producer <span class="hljs-title">createMockProducer</span><span class="hljs-params">()</span> </span>{
    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">given</span>(<span class="hljs-title">producer</span>).<span class="hljs-title">send</span>(<span class="hljs-title">any</span>(<span class="hljs-title">ProducerRecord</span>.<span class="hljs-title">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">Callback</span>.<span class="hljs-title">class</span>))</span>;
    <span class="hljs-keyword">return</span> producer;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci51">Mock Clone Instance #spring-integration_MCI_51</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.kafka.clients.producer.Producer</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Producer <span class="hljs-title">createMockProducer</span><span class="hljs-params">(CountDownLatch closeLatch)</span> </span>{
    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(producer.send(any(), any())).willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    willAnswer(i -&gt; {
        closeLatch.countDown();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(producer).close(any());
    <span class="hljs-keyword">return</span> producer;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest511">Test Case ID #spring-integration_Test_51_1</h4>
<h4 id="test-case-name-testconsumeandproducetransactionfile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkaoutboundkafkaproducermessagehandlertestsjava">Test Case Name: <code>testConsumeAndProduceTransaction</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\outbound\KafkaProducerMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-producer">Mock Object Variable Name: <code>producer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    willReturn(mockConsumer).given(cf).createConsumer("group", "", null, KafkaTestUtils.defaultPropertyOverrides());
<span class="hljs-deletion">-    Producer producer = mock(Producer.class);</span>
<span class="hljs-deletion">-    given(producer.send(any(), any())).willReturn(mock(Future.class));</span>
<span class="hljs-deletion">-    final CountDownLatch closeLatch = new CountDownLatch(2);</span>
<span class="hljs-deletion">-    willAnswer(i -&gt; {</span>
<span class="hljs-deletion">-        closeLatch.countDown();</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).given(producer).close(any());</span>
<span class="hljs-addition">+    final CountDownLatch closeLatch = new CountDownLatch(2);</span>
<span class="hljs-addition">+    Producer producer = createMockProducer(closeLatch);</span>
     ProducerFactory pf = mock(ProducerFactory.class);
     given(pf.transactionCapable()).willReturn(true);
     willReturn(producer).given(pf).createProducer(isNull());
     KafkaTransactionManager ptm = new KafkaTransactionManager(pf);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"unchecked"</span>, <span class="hljs-string">"rawtypes"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumeAndProduceTransaction</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Consumer mockConsumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    willAnswer(i -&gt; {

        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(mockConsumer).subscribe(any(Collection<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">ConsumerRebalanceListener</span>.<span class="hljs-title">class</span>))</span>;

    ConsumerRecords records = <span class="hljs-keyword">new</span> ConsumerRecords(Collections.singletonMap(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord&lt;&gt;(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>))));

    <span class="hljs-keyword">final</span> AtomicBoolean done = <span class="hljs-keyword">new</span> AtomicBoolean();

    willAnswer(i -&gt; {

        <span class="hljs-keyword">if</span> (done.compareAndSet(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>)) {

            <span class="hljs-keyword">return</span> records;

        } <span class="hljs-keyword">else</span> {

            Thread.sleep(<span class="hljs-number">500</span>);

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

        }

    }).given(mockConsumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ConsumerGroupMetadata meta = <span class="hljs-keyword">new</span> ConsumerGroupMetadata(<span class="hljs-string">"group"</span>);

    given(mockConsumer.groupMetadata()).willReturn(meta);

    ConsumerFactory cf = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(mockConsumer).given(cf).createConsumer(<span class="hljs-string">"group"</span>, <span class="hljs-string">""</span>, <span class="hljs-keyword">null</span>, KafkaTestUtils.defaultPropertyOverrides());

    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(producer.send(any(), any())).willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">final</span> CountDownLatch closeLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">2</span>);

    willAnswer(i -&gt; {

        closeLatch.countDown();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(producer).close(any());

    ProducerFactory pf = mock(ProducerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(pf.transactionCapable()).willReturn(<span class="hljs-keyword">true</span>);

    willReturn(producer).given(pf).createProducer(isNull());

    KafkaTransactionManager ptm = <span class="hljs-keyword">new</span> KafkaTransactionManager(pf);

    ContainerProperties props = <span class="hljs-keyword">new</span> ContainerProperties(<span class="hljs-string">"foo"</span>);

    props.setGroupId(<span class="hljs-string">"group"</span>);

    props.setKafkaAwareTransactionManager(ptm);

    props.setAssignmentCommitOption(AssignmentCommitOption.ALWAYS);

    <span class="hljs-keyword">final</span> KafkaTemplate template = <span class="hljs-keyword">new</span> KafkaTemplate(pf);

    KafkaMessageListenerContainer container = <span class="hljs-keyword">new</span> KafkaMessageListenerContainer&lt;&gt;(cf, props);

    container.setBeanName(<span class="hljs-string">"commit"</span>);

    KafkaMessageDrivenChannelAdapter inbound = <span class="hljs-keyword">new</span> KafkaMessageDrivenChannelAdapter&lt;&gt;(container);

    DirectChannel channel = <span class="hljs-keyword">new</span> DirectChannel();

    inbound.setOutputChannel(channel);

    KafkaProducerMessageHandler handler = <span class="hljs-keyword">new</span> KafkaProducerMessageHandler(template);

    handler.setMessageKeyExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    handler.setTopicExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"topic"</span>));

    channel.subscribe(handler);

    inbound.afterPropertiesSet();

    inbound.start();

    assertThat(closeLatch.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    InOrder inOrder = inOrder(producer);

    inOrder.verify(producer).beginTransaction();

    inOrder.verify(producer).sendOffsetsToTransaction(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">0</span>)), meta);

    inOrder.verify(producer).commitTransaction();

    inOrder.verify(producer).close(any());

    inOrder.verify(producer).beginTransaction();

    ArgumentCaptor&lt;ProducerRecord&gt; captor = ArgumentCaptor.forClass(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    inOrder.verify(producer).send(captor.capture(), any(Callback<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-keyword">new</span> ProducerRecord(<span class="hljs-string">"topic"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-string">"value"</span>));

    inOrder.verify(producer).sendOffsetsToTransaction(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">1</span>)), meta);

    inOrder.verify(producer).commitTransaction();

    inOrder.verify(producer).close(any());

    container.stop();

    verify(pf, times(<span class="hljs-number">2</span>)).createProducer(isNull());

    verifyNoMoreInteractions(producer);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Producer <span class="hljs-title">createMockProducer</span><span class="hljs-params">(CountDownLatch closeLatch)</span> </span>{
    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(producer.send(any(), any())).willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    willAnswer(i -&gt; {
        closeLatch.countDown();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(producer).close(any());
    <span class="hljs-keyword">return</span> producer;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest512">Test Case ID #spring-integration_Test_51_2</h4>
<h4 id="test-case-name-testconsumeandproducetransactiontxidoverridefile-cjavaprojectsspringspring-integrationspring-integration-kafkasrctestjavaorgspringframeworkintegrationkafkaoutboundkafkaproducermessagehandlertestsjava">Test Case Name: <code>testConsumeAndProduceTransactionTxIdOverride</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-kafka\src\test\java\org\springframework\integration\kafka\outbound\KafkaProducerMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-producer">Mock Object Variable Name: <code>producer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    willReturn(mockConsumer).given(cf).createConsumer("group", "", null, KafkaTestUtils.defaultPropertyOverrides());
<span class="hljs-deletion">-    Producer producer = mock(Producer.class);</span>
<span class="hljs-deletion">-    given(producer.send(any(), any())).willReturn(mock(Future.class));</span>
<span class="hljs-deletion">-    final CountDownLatch closeLatch = new CountDownLatch(2);</span>
<span class="hljs-deletion">-    willAnswer(i -&gt; {</span>
<span class="hljs-deletion">-        closeLatch.countDown();</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).given(producer).close(any());</span>
<span class="hljs-addition">+    final CountDownLatch closeLatch = new CountDownLatch(2);</span>
<span class="hljs-addition">+    Producer producer = createMockProducer(closeLatch);</span>
    AtomicReference&lt;String&gt; txId = new AtomicReference&lt;&gt;();
    DefaultKafkaProducerFactory pf = new DefaultKafkaProducerFactory(Collections.emptyMap()) {
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>({ <span class="hljs-string">"unchecked"</span>, <span class="hljs-string">"rawtypes"</span> })

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumeAndProduceTransactionTxIdOverride</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Consumer mockConsumer = mock(Consumer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> TopicPartition topicPartition = <span class="hljs-keyword">new</span> TopicPartition(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>);

    willAnswer(i -&gt; {

        ((ConsumerRebalanceListener) i.getArgument(<span class="hljs-number">1</span>)).onPartitionsAssigned(Collections.singletonList(topicPartition));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(mockConsumer).subscribe(any(Collection<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">ConsumerRebalanceListener</span>.<span class="hljs-title">class</span>))</span>;

    ConsumerRecords records = <span class="hljs-keyword">new</span> ConsumerRecords(Collections.singletonMap(topicPartition, Collections.singletonList(<span class="hljs-keyword">new</span> ConsumerRecord&lt;&gt;(<span class="hljs-string">"foo"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>))));

    <span class="hljs-keyword">final</span> AtomicBoolean done = <span class="hljs-keyword">new</span> AtomicBoolean();

    willAnswer(i -&gt; {

        <span class="hljs-keyword">if</span> (done.compareAndSet(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>)) {

            <span class="hljs-keyword">return</span> records;

        } <span class="hljs-keyword">else</span> {

            Thread.sleep(<span class="hljs-number">500</span>);

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

        }

    }).given(mockConsumer).poll(any(Duration<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ConsumerGroupMetadata meta = <span class="hljs-keyword">new</span> ConsumerGroupMetadata(<span class="hljs-string">"group"</span>);

    given(mockConsumer.groupMetadata()).willReturn(meta);

    ConsumerFactory cf = mock(ConsumerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(mockConsumer).given(cf).createConsumer(<span class="hljs-string">"group"</span>, <span class="hljs-string">""</span>, <span class="hljs-keyword">null</span>, KafkaTestUtils.defaultPropertyOverrides());

    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(producer.send(any(), any())).willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">final</span> CountDownLatch closeLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">2</span>);

    willAnswer(i -&gt; {

        closeLatch.countDown();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(producer).close(any());

    AtomicReference&lt;String&gt; txId = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    DefaultKafkaProducerFactory pf = <span class="hljs-keyword">new</span> DefaultKafkaProducerFactory(Collections.emptyMap()) {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">protected</span> Producer <span class="hljs-title">createTransactionalProducer</span><span class="hljs-params">(String txIdPrefix)</span> </span>{

            txId.set(txIdPrefix);

            <span class="hljs-keyword">return</span> producer;

        }

    };

    pf.setTransactionIdPrefix(<span class="hljs-string">"default.tx.id."</span>);

    KafkaTransactionManager tm = <span class="hljs-keyword">new</span> KafkaTransactionManager(pf);

    tm.setTransactionIdPrefix(<span class="hljs-string">"tm.tx.id."</span>);

    ContainerProperties props = <span class="hljs-keyword">new</span> ContainerProperties(<span class="hljs-string">"foo"</span>);

    props.setGroupId(<span class="hljs-string">"group"</span>);

    props.setKafkaAwareTransactionManager(tm);

    props.setAssignmentCommitOption(AssignmentCommitOption.ALWAYS);

    <span class="hljs-keyword">final</span> KafkaTemplate template = <span class="hljs-keyword">new</span> KafkaTemplate(pf);

    template.setTransactionIdPrefix(<span class="hljs-string">"template.tx.id."</span>);

    KafkaMessageListenerContainer container = <span class="hljs-keyword">new</span> KafkaMessageListenerContainer&lt;&gt;(cf, props);

    container.setBeanName(<span class="hljs-string">"commit"</span>);

    KafkaMessageDrivenChannelAdapter inbound = <span class="hljs-keyword">new</span> KafkaMessageDrivenChannelAdapter&lt;&gt;(container);

    DirectChannel channel = <span class="hljs-keyword">new</span> DirectChannel();

    inbound.setOutputChannel(channel);

    KafkaProducerMessageHandler handler = <span class="hljs-keyword">new</span> KafkaProducerMessageHandler(template);

    handler.setMessageKeyExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"bar"</span>));

    handler.setTopicExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"topic"</span>));

    channel.subscribe(handler);

    inbound.afterPropertiesSet();

    inbound.start();

    assertThat(closeLatch.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    InOrder inOrder = inOrder(producer);

    inOrder.verify(producer).beginTransaction();

    inOrder.verify(producer).sendOffsetsToTransaction(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">0</span>)), meta);

    inOrder.verify(producer).commitTransaction();

    inOrder.verify(producer).close(any());

    inOrder.verify(producer).beginTransaction();

    ArgumentCaptor&lt;ProducerRecord&gt; captor = ArgumentCaptor.forClass(ProducerRecord<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    inOrder.verify(producer).send(captor.capture(), any(Callback<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-keyword">new</span> ProducerRecord(<span class="hljs-string">"topic"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-string">"value"</span>));

    inOrder.verify(producer).sendOffsetsToTransaction(Collections.singletonMap(topicPartition, <span class="hljs-keyword">new</span> OffsetAndMetadata(<span class="hljs-number">1</span>)), meta);

    inOrder.verify(producer).commitTransaction();

    inOrder.verify(producer).close(any());

    container.stop();

    verifyNoMoreInteractions(producer);

    assertThat(txId.get()).isEqualTo(<span class="hljs-string">"tm.tx.id."</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Producer <span class="hljs-title">createMockProducer</span><span class="hljs-params">(CountDownLatch closeLatch)</span> </span>{
    Producer producer = mock(Producer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(producer.send(any(), any())).willReturn(mock(Future<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    willAnswer(i -&gt; {
        closeLatch.countDown();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).given(producer).close(any());
    <span class="hljs-keyword">return</span> producer;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci52">Mock Clone Instance #spring-integration_MCI_52</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.messaging.Message&lt;?&gt;</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Message&lt;?&gt; createMockMessageWithHeaders() {
    Message&lt;?&gt; message = mock(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(<span class="hljs-keyword">new</span> MessageHeaders(mock(Map<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">given</span>(<span class="hljs-title">message</span>).<span class="hljs-title">getHeaders</span>()</span>;
    <span class="hljs-keyword">return</span> message;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest521">Test Case ID #spring-integration_Test_52_1</h4>
<h4 id="test-case-name-shouldignorenullvalueswheninitializedwithcollectioncontainingnullsfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationstoresimplemessagegrouptestsjava">Test Case Name: <code>shouldIgnoreNullValuesWhenInitializedWithCollectionContainingNulls</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\store\SimpleMessageGroupTests.java</code>)</h4>
<h4 id="mock-object-variable-name-m1">Mock Object Variable Name: <code>m1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @SuppressWarnings("unchecked")
 @Test
 public void shouldIgnoreNullValuesWhenInitializedWithCollectionContainingNulls() {
<span class="hljs-deletion">-    Message&lt;?&gt; m1 = mock(Message.class);</span>
<span class="hljs-deletion">-    willReturn(new MessageHeaders(mock(Map.class))).given(m1).getHeaders();</span>
<span class="hljs-addition">+    Message&lt;?&gt; m1 = createMockMessageWithHeaders();</span>
     Message&lt;?&gt; m2 = mock(Message.class);
     willReturn(new MessageHeaders(mock(Map.class))).given(m2).getHeaders();
     final List&lt;Message&lt;?&gt;&gt; messages = new ArrayList&lt;&gt;();
     messages.add(m1);
     messages.add(null);
     messages.add(m2);
     SimpleMessageGroup grp = new SimpleMessageGroup(messages, 1);
     assertThat(grp.getMessages().size()).isEqualTo(2);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shouldIgnoreNullValuesWhenInitializedWithCollectionContainingNulls</span><span class="hljs-params">()</span> </span>{

    Message&lt;?&gt; m1 = mock(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">new</span> MessageHeaders(mock(Map<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">given</span>(<span class="hljs-title">m1</span>).<span class="hljs-title">getHeaders</span>()</span>;

    Message&lt;?&gt; m2 = mock(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">new</span> MessageHeaders(mock(Map<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">given</span>(<span class="hljs-title">m2</span>).<span class="hljs-title">getHeaders</span>()</span>;

    <span class="hljs-keyword">final</span> List&lt;Message&lt;?&gt;&gt; messages = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    messages.add(m1);

    messages.add(<span class="hljs-keyword">null</span>);

    messages.add(m2);

    SimpleMessageGroup grp = <span class="hljs-keyword">new</span> SimpleMessageGroup(messages, <span class="hljs-number">1</span>);

    assertThat(grp.getMessages().size()).isEqualTo(<span class="hljs-number">2</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Message&lt;?&gt; createMockMessageWithHeaders() {
    Message&lt;?&gt; message = mock(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(<span class="hljs-keyword">new</span> MessageHeaders(mock(Map<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">given</span>(<span class="hljs-title">message</span>).<span class="hljs-title">getHeaders</span>()</span>;
    <span class="hljs-keyword">return</span> message;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest522">Test Case ID #spring-integration_Test_52_2</h4>
<h4 id="test-case-name-shouldignorenullvalueswheninitializedwithcollectioncontainingnullsfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationstoresimplemessagegrouptestsjava">Test Case Name: <code>shouldIgnoreNullValuesWhenInitializedWithCollectionContainingNulls</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\store\SimpleMessageGroupTests.java</code>)</h4>
<h4 id="mock-object-variable-name-m2">Mock Object Variable Name: <code>m2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     Message&lt;?&gt; m1 = mock(Message.class);
     willReturn(new MessageHeaders(mock(Map.class))).given(m1).getHeaders();
<span class="hljs-deletion">-    Message&lt;?&gt; m2 = mock(Message.class);</span>
<span class="hljs-deletion">-    willReturn(new MessageHeaders(mock(Map.class))).given(m2).getHeaders();</span>
<span class="hljs-addition">+    Message&lt;?&gt; m2 = createMockMessageWithHeaders();</span>
     final List&lt;Message&lt;?&gt;&gt; messages = new ArrayList&lt;&gt;();
     messages.add(m1);
     messages.add(null);
     messages.add(m2);
     SimpleMessageGroup grp = new SimpleMessageGroup(messages, 1);
     assertThat(grp.getMessages().size()).isEqualTo(2);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shouldIgnoreNullValuesWhenInitializedWithCollectionContainingNulls</span><span class="hljs-params">()</span> </span>{

    Message&lt;?&gt; m1 = mock(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">new</span> MessageHeaders(mock(Map<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">given</span>(<span class="hljs-title">m1</span>).<span class="hljs-title">getHeaders</span>()</span>;

    Message&lt;?&gt; m2 = mock(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(<span class="hljs-keyword">new</span> MessageHeaders(mock(Map<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">given</span>(<span class="hljs-title">m2</span>).<span class="hljs-title">getHeaders</span>()</span>;

    <span class="hljs-keyword">final</span> List&lt;Message&lt;?&gt;&gt; messages = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    messages.add(m1);

    messages.add(<span class="hljs-keyword">null</span>);

    messages.add(m2);

    SimpleMessageGroup grp = <span class="hljs-keyword">new</span> SimpleMessageGroup(messages, <span class="hljs-number">1</span>);

    assertThat(grp.getMessages().size()).isEqualTo(<span class="hljs-number">2</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Message&lt;?&gt; createMockMessageWithHeaders() {
    Message&lt;?&gt; message = mock(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(<span class="hljs-keyword">new</span> MessageHeaders(mock(Map<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">given</span>(<span class="hljs-title">message</span>).<span class="hljs-title">getHeaders</span>()</span>;
    <span class="hljs-keyword">return</span> message;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci53">Mock Clone Instance #spring-integration_MCI_53</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.acks.AcknowledgmentCallback</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AcknowledgmentCallback <span class="hljs-title">createMockAcknowledgmentCallback</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAutoAck)</span> </span>{
    AcknowledgmentCallback callback = mock(AcknowledgmentCallback<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(callback.isAutoAck()).willReturn(isAutoAck);
    <span class="hljs-keyword">return</span> callback;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest531">Test Case ID #spring-integration_Test_53_1</h4>
<h4 id="test-case-name-testacknackfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationendpointmessagesourcepollingtemplatetestsjava">Test Case Name: <code>testAckNack</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\endpoint\MessageSourcePollingTemplateTests.java</code>)</h4>
<h4 id="mock-object-variable-name-callback">Mock Object Variable Name: <code>callback</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testAckNack() {
<span class="hljs-deletion">-    AcknowledgmentCallback callback = mock(AcknowledgmentCallback.class);</span>
<span class="hljs-deletion">-    given(callback.isAutoAck()).willReturn(true);</span>
<span class="hljs-addition">+    AcknowledgmentCallback callback = createMockAcknowledgmentCallback(true);</span>
     MessageSource&lt;?&gt; source = () -&gt; new GenericMessage&lt;&gt;("foo", Collections.singletonMap(IntegrationMessageHeaderAccessor.ACKNOWLEDGMENT_CALLBACK, callback));
     MessageSourcePollingTemplate template = new MessageSourcePollingTemplate(source);
     template.poll(h -&gt; {
     });
     verify(callback).acknowledge(Status.ACCEPT);
     try {
         template.poll(h -&gt; {
             throw new RuntimeException("expected");
         });
         fail("expected exception");
     } catch (MessageHandlingException e) {
         assertThat(e.getCause().getMessage()).isEqualTo("expected");
     }
     verify(callback).acknowledge(Status.REJECT);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAckNack</span><span class="hljs-params">()</span> </span>{

    AcknowledgmentCallback callback = mock(AcknowledgmentCallback<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(callback.isAutoAck()).willReturn(<span class="hljs-keyword">true</span>);

    MessageSource&lt;?&gt; source = () -&gt; <span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>, Collections.singletonMap(IntegrationMessageHeaderAccessor.ACKNOWLEDGMENT_CALLBACK, callback));

    MessageSourcePollingTemplate template = <span class="hljs-keyword">new</span> MessageSourcePollingTemplate(source);

    template.poll(h -&gt; {

    });

    verify(callback).acknowledge(Status.ACCEPT);

    <span class="hljs-keyword">try</span> {

        template.poll(h -&gt; {

            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"expected"</span>);

        });

        fail(<span class="hljs-string">"expected exception"</span>);

    } <span class="hljs-keyword">catch</span> (MessageHandlingException e) {

        assertThat(e.getCause().getMessage()).isEqualTo(<span class="hljs-string">"expected"</span>);

    }

    verify(callback).acknowledge(Status.REJECT);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AcknowledgmentCallback <span class="hljs-title">createMockAcknowledgmentCallback</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAutoAck)</span> </span>{
    AcknowledgmentCallback callback = mock(AcknowledgmentCallback<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(callback.isAutoAck()).willReturn(isAutoAck);
    <span class="hljs-keyword">return</span> callback;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest532">Test Case ID #spring-integration_Test_53_2</h4>
<h4 id="test-case-name-testnoautoackfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationendpointmessagesourcepollingtemplatetestsjava">Test Case Name: <code>testNoAutoAck</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\endpoint\MessageSourcePollingTemplateTests.java</code>)</h4>
<h4 id="mock-object-variable-name-callback">Mock Object Variable Name: <code>callback</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testNoAutoAck() {
<span class="hljs-deletion">-    AcknowledgmentCallback callback = mock(AcknowledgmentCallback.class);</span>
<span class="hljs-deletion">-    given(callback.isAutoAck()).willReturn(false);</span>
<span class="hljs-addition">+    AcknowledgmentCallback callback = createMockAcknowledgmentCallback(false);</span>
     MessageSource&lt;?&gt; source = () -&gt; new GenericMessage&lt;&gt;("foo", Collections.singletonMap(IntegrationMessageHeaderAccessor.ACKNOWLEDGMENT_CALLBACK, callback));
     MessageSourcePollingTemplate template = new MessageSourcePollingTemplate(source);
     template.poll(h -&gt; {
     });
     verify(callback, never()).acknowledge(Status.ACCEPT);
     verify(callback, never()).acknowledge(Status.REJECT);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNoAutoAck</span><span class="hljs-params">()</span> </span>{

    AcknowledgmentCallback callback = mock(AcknowledgmentCallback<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(callback.isAutoAck()).willReturn(<span class="hljs-keyword">false</span>);

    MessageSource&lt;?&gt; source = () -&gt; <span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>, Collections.singletonMap(IntegrationMessageHeaderAccessor.ACKNOWLEDGMENT_CALLBACK, callback));

    MessageSourcePollingTemplate template = <span class="hljs-keyword">new</span> MessageSourcePollingTemplate(source);

    template.poll(h -&gt; {

    });

    verify(callback, never()).acknowledge(Status.ACCEPT);

    verify(callback, never()).acknowledge(Status.REJECT);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AcknowledgmentCallback <span class="hljs-title">createMockAcknowledgmentCallback</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAutoAck)</span> </span>{
    AcknowledgmentCallback callback = mock(AcknowledgmentCallback<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(callback.isAutoAck()).willReturn(isAutoAck);
    <span class="hljs-keyword">return</span> callback;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci54">Mock Clone Instance #spring-integration_MCI_54</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.messaging.support.InterceptableChannel</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> InterceptableChannel channel;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    channel = mock(InterceptableChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
channel;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest541">Test Case ID #spring-integration_Test_54_1</h4>
<h4 id="test-case-name-testprocessorwithinterceptordefaultpatternfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationconfigglobalchannelinterceptorprocessortestsjava">Test Case Name: <code>testProcessorWithInterceptorDefaultPattern</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\config\GlobalChannelInterceptorProcessorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-channel">Mock Object Variable Name: <code>channel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testProcessorWithInterceptorDefaultPattern() {
     Map&lt;String, GlobalChannelInterceptorWrapper&gt; interceptors = new HashMap&lt;&gt;();
     Map&lt;String, InterceptableChannel&gt; channels = new HashMap&lt;&gt;();
     ChannelInterceptor channelInterceptor = mock();
     GlobalChannelInterceptorWrapper globalChannelInterceptorWrapper = new GlobalChannelInterceptorWrapper(channelInterceptor);
<span class="hljs-deletion">-    InterceptableChannel channel = mock();</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `channel`</span>
     interceptors.put("Test-1", globalChannelInterceptorWrapper);
     channels.put("Test-1", channel);
     when(this.beanFactory.getBeansOfType(GlobalChannelInterceptorWrapper.class)).thenReturn(interceptors);
     when(this.beanFactory.getBeansOfType(InterceptableChannel.class)).thenReturn(channels);
     this.globalChannelInterceptorProcessor.afterSingletonsInstantiated();
<span class="hljs-deletion">-    verify(channel).addInterceptor(channelInterceptor);</span>
<span class="hljs-addition">+    verify(channel).addInterceptor(channelInterceptor);</span>
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcessorWithInterceptorDefaultPattern</span><span class="hljs-params">()</span> </span>{

    Map&lt;String, GlobalChannelInterceptorWrapper&gt; interceptors = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    Map&lt;String, InterceptableChannel&gt; channels = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ChannelInterceptor channelInterceptor = mock();

    GlobalChannelInterceptorWrapper globalChannelInterceptorWrapper = <span class="hljs-keyword">new</span> GlobalChannelInterceptorWrapper(channelInterceptor);

    InterceptableChannel channel = mock();

    interceptors.put(<span class="hljs-string">"Test-1"</span>, globalChannelInterceptorWrapper);

    channels.put(<span class="hljs-string">"Test-1"</span>, channel);

    when(<span class="hljs-keyword">this</span>.beanFactory.getBeansOfType(GlobalChannelInterceptorWrapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">interceptors</span>)</span>;

    when(<span class="hljs-keyword">this</span>.beanFactory.getBeansOfType(InterceptableChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">channels</span>)</span>;

    <span class="hljs-keyword">this</span>.globalChannelInterceptorProcessor.afterSingletonsInstantiated();

    verify(channel).addInterceptor(channelInterceptor);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> InterceptableChannel channel;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    channel = mock(InterceptableChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
channel;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest542">Test Case ID #spring-integration_Test_54_2</h4>
<h4 id="test-case-name-testprocessorwithinterceptormatchingpatternfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationconfigglobalchannelinterceptorprocessortestsjava">Test Case Name: <code>testProcessorWithInterceptorMatchingPattern</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\config\GlobalChannelInterceptorProcessorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-channel">Mock Object Variable Name: <code>channel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testProcessorWithInterceptorMatchingPattern() {
     Map&lt;String, GlobalChannelInterceptorWrapper&gt; interceptors = new HashMap&lt;&gt;();
     Map&lt;String, InterceptableChannel&gt; channels = new HashMap&lt;&gt;();
     ChannelInterceptor channelInterceptor = mock();
     GlobalChannelInterceptorWrapper globalChannelInterceptorWrapper = new GlobalChannelInterceptorWrapper(channelInterceptor);
<span class="hljs-deletion">-    InterceptableChannel channel = mock();</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `channel`</span>
     globalChannelInterceptorWrapper.setPatterns(new String[] { "Te*" });
     interceptors.put("Test-1", globalChannelInterceptorWrapper);
<span class="hljs-deletion">-    channels.put("Test-1", channel);</span>
<span class="hljs-addition">+    channels.put("Test-1", channel);</span>
     when(this.beanFactory.getBeansOfType(GlobalChannelInterceptorWrapper.class)).thenReturn(interceptors);
     when(this.beanFactory.getBeansOfType(InterceptableChannel.class)).thenReturn(channels);
     this.globalChannelInterceptorProcessor.afterSingletonsInstantiated();
<span class="hljs-deletion">-    verify(channel).addInterceptor(channelInterceptor);</span>
<span class="hljs-addition">+    verify(channel).addInterceptor(channelInterceptor);</span>
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcessorWithInterceptorMatchingPattern</span><span class="hljs-params">()</span> </span>{

    Map&lt;String, GlobalChannelInterceptorWrapper&gt; interceptors = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    Map&lt;String, InterceptableChannel&gt; channels = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ChannelInterceptor channelInterceptor = mock();

    GlobalChannelInterceptorWrapper globalChannelInterceptorWrapper = <span class="hljs-keyword">new</span> GlobalChannelInterceptorWrapper(channelInterceptor);

    InterceptableChannel channel = mock();

    globalChannelInterceptorWrapper.setPatterns(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"Te*"</span> });

    interceptors.put(<span class="hljs-string">"Test-1"</span>, globalChannelInterceptorWrapper);

    channels.put(<span class="hljs-string">"Test-1"</span>, channel);

    when(<span class="hljs-keyword">this</span>.beanFactory.getBeansOfType(GlobalChannelInterceptorWrapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">interceptors</span>)</span>;

    when(<span class="hljs-keyword">this</span>.beanFactory.getBeansOfType(InterceptableChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">channels</span>)</span>;

    <span class="hljs-keyword">this</span>.globalChannelInterceptorProcessor.afterSingletonsInstantiated();

    verify(channel).addInterceptor(channelInterceptor);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> InterceptableChannel channel;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    channel = mock(InterceptableChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
channel;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest543">Test Case ID #spring-integration_Test_54_3</h4>
<h4 id="test-case-name-testprocessorwithinterceptornotmatchingpatternfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationconfigglobalchannelinterceptorprocessortestsjava">Test Case Name: <code>testProcessorWithInterceptorNotMatchingPattern</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\config\GlobalChannelInterceptorProcessorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-channel">Mock Object Variable Name: <code>channel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testProcessorWithInterceptorNotMatchingPattern() {
     Map&lt;String, GlobalChannelInterceptorWrapper&gt; interceptors = new HashMap&lt;&gt;();
     Map&lt;String, InterceptableChannel&gt; channels = new HashMap&lt;&gt;();
     ChannelInterceptor channelInterceptor = mock();
     GlobalChannelInterceptorWrapper globalChannelInterceptorWrapper = new GlobalChannelInterceptorWrapper(channelInterceptor);
<span class="hljs-deletion">-    InterceptableChannel channel = mock();</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `channel`</span>
     globalChannelInterceptorWrapper.setPatterns(new String[] { "te*" });
     interceptors.put("Test-1", globalChannelInterceptorWrapper);
     channels.put("Test-1", channel);
     when(this.beanFactory.getBeansOfType(GlobalChannelInterceptorWrapper.class)).thenReturn(interceptors);
     when(this.beanFactory.getBeansOfType(InterceptableChannel.class)).thenReturn(channels);
     this.globalChannelInterceptorProcessor.afterSingletonsInstantiated();
<span class="hljs-deletion">-    verify(channel, never()).addInterceptor(channelInterceptor);</span>
<span class="hljs-addition">+    verify(channel, never()).addInterceptor(channelInterceptor);</span>
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcessorWithInterceptorNotMatchingPattern</span><span class="hljs-params">()</span> </span>{

    Map&lt;String, GlobalChannelInterceptorWrapper&gt; interceptors = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    Map&lt;String, InterceptableChannel&gt; channels = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ChannelInterceptor channelInterceptor = mock();

    GlobalChannelInterceptorWrapper globalChannelInterceptorWrapper = <span class="hljs-keyword">new</span> GlobalChannelInterceptorWrapper(channelInterceptor);

    InterceptableChannel channel = mock();

    globalChannelInterceptorWrapper.setPatterns(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"te*"</span> });

    interceptors.put(<span class="hljs-string">"Test-1"</span>, globalChannelInterceptorWrapper);

    channels.put(<span class="hljs-string">"Test-1"</span>, channel);

    when(<span class="hljs-keyword">this</span>.beanFactory.getBeansOfType(GlobalChannelInterceptorWrapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">interceptors</span>)</span>;

    when(<span class="hljs-keyword">this</span>.beanFactory.getBeansOfType(InterceptableChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">channels</span>)</span>;

    <span class="hljs-keyword">this</span>.globalChannelInterceptorProcessor.afterSingletonsInstantiated();

    verify(channel, never()).addInterceptor(channelInterceptor);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> InterceptableChannel channel;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    channel = mock(InterceptableChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
channel;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest544">Test Case ID #spring-integration_Test_54_4</h4>
<h4 id="test-case-name-testprocessorwithinterceptormatchingnegativepatternfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationconfigglobalchannelinterceptorprocessortestsjava">Test Case Name: <code>testProcessorWithInterceptorMatchingNegativePattern</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\config\GlobalChannelInterceptorProcessorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-channel">Mock Object Variable Name: <code>channel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testProcessorWithInterceptorMatchingNegativePattern() {
     Map&lt;String, GlobalChannelInterceptorWrapper&gt; interceptors = new HashMap&lt;&gt;();
     Map&lt;String, InterceptableChannel&gt; channels = new HashMap&lt;&gt;();
     ChannelInterceptor channelInterceptor = mock();
     GlobalChannelInterceptorWrapper globalChannelInterceptorWrapper = new GlobalChannelInterceptorWrapper(channelInterceptor);
<span class="hljs-deletion">-    InterceptableChannel channel = mock();</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `channel`</span>
     globalChannelInterceptorWrapper.setPatterns(new String[] { "!te*", "!Te*" });
     interceptors.put("Test-1", globalChannelInterceptorWrapper);
     channels.put("Test-1", channel);
     when(this.beanFactory.getBeansOfType(GlobalChannelInterceptorWrapper.class)).thenReturn(interceptors);
     when(this.beanFactory.getBeansOfType(InterceptableChannel.class)).thenReturn(channels);
     this.globalChannelInterceptorProcessor.afterSingletonsInstantiated();
<span class="hljs-deletion">-    verify(channel, never()).addInterceptor(channelInterceptor);</span>
<span class="hljs-addition">+    verify(channel, never()).addInterceptor(channelInterceptor);</span>
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcessorWithInterceptorMatchingNegativePattern</span><span class="hljs-params">()</span> </span>{

    Map&lt;String, GlobalChannelInterceptorWrapper&gt; interceptors = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    Map&lt;String, InterceptableChannel&gt; channels = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ChannelInterceptor channelInterceptor = mock();

    GlobalChannelInterceptorWrapper globalChannelInterceptorWrapper = <span class="hljs-keyword">new</span> GlobalChannelInterceptorWrapper(channelInterceptor);

    InterceptableChannel channel = mock();

    globalChannelInterceptorWrapper.setPatterns(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"!te*"</span>, <span class="hljs-string">"!Te*"</span> });

    interceptors.put(<span class="hljs-string">"Test-1"</span>, globalChannelInterceptorWrapper);

    channels.put(<span class="hljs-string">"Test-1"</span>, channel);

    when(<span class="hljs-keyword">this</span>.beanFactory.getBeansOfType(GlobalChannelInterceptorWrapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">interceptors</span>)</span>;

    when(<span class="hljs-keyword">this</span>.beanFactory.getBeansOfType(InterceptableChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">channels</span>)</span>;

    <span class="hljs-keyword">this</span>.globalChannelInterceptorProcessor.afterSingletonsInstantiated();

    verify(channel, never()).addInterceptor(channelInterceptor);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> InterceptableChannel channel;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    channel = mock(InterceptableChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
channel;

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci55">Mock Clone Instance #spring-integration_MCI_55</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.file.remote.session.Session&lt;F&gt;</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;F&gt; <span class="hljs-function">Session&lt;F&gt; <span class="hljs-title">createMockSession</span><span class="hljs-params">()</span> </span>{
    Session&lt;F&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(invocation -&gt; {
        String path = invocation.getArgument(<span class="hljs-number">1</span>);
        assertThat(path.startsWith(<span class="hljs-string">"/"</span>)).isFalse();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).when(session).rename(Mockito.anyString(), Mockito.anyString());
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest551">Test Case ID #spring-integration_Test_55_1</h4>
<h4 id="test-case-name-testremotedirwithemptystringfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotehandlerfiletransferringmessagehandlertestsjava">Test Case Name: <code>testRemoteDirWithEmptyString</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\handler\FileTransferringMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SessionFactory&lt;F&gt; sf = mock(SessionFactory.class);
<span class="hljs-deletion">-    Session&lt;F&gt; session = mock(Session.class);</span>
<span class="hljs-addition">+    Session&lt;F&gt; session = createMockSession();</span>
    when(sf.getSession()).thenReturn(session);
<span class="hljs-deletion">-    doAnswer(invocation -&gt; {</span>
<span class="hljs-deletion">-        String path = invocation.getArgument(1);</span>
<span class="hljs-deletion">-        assertThat(path.startsWith("/")).isFalse();</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).when(session).rename(Mockito.anyString(), Mockito.anyString());</span>
    ExpressionParser parser = new SpelExpressionParser();
    FileTransferringMessageHandler&lt;F&gt; handler = new FileTransferringMessageHandler&lt;F&gt;(sf);
    handler.setRemoteDirectoryExpression(parser.parseExpression("''"));
    handler.setBeanFactory(mock(BeanFactory.class));
    handler.afterPropertiesSet();
    handler.handleMessage(new GenericMessage&lt;String&gt;("hello"));
    verify(session, times(1)).write(Mockito.any(InputStream.class), Mockito.anyString());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-keyword">public</span> &lt;F&gt; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRemoteDirWithEmptyString</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory&lt;F&gt; sf = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;F&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(sf.getSession()).thenReturn(session);

    doAnswer(invocation -&gt; {

        String path = invocation.getArgument(<span class="hljs-number">1</span>);

        assertThat(path.startsWith(<span class="hljs-string">"/"</span>)).isFalse();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(session).rename(Mockito.anyString(), Mockito.anyString());

    ExpressionParser parser = <span class="hljs-keyword">new</span> SpelExpressionParser();

    FileTransferringMessageHandler&lt;F&gt; handler = <span class="hljs-keyword">new</span> FileTransferringMessageHandler&lt;F&gt;(sf);

    handler.setRemoteDirectoryExpression(parser.parseExpression(<span class="hljs-string">"''"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    handler.handleMessage(<span class="hljs-keyword">new</span> GenericMessage&lt;String&gt;(<span class="hljs-string">"hello"</span>));

    verify(session, times(<span class="hljs-number">1</span>)).write(Mockito.any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">Mockito</span>.<span class="hljs-title">anyString</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;F&gt; <span class="hljs-function">Session&lt;F&gt; <span class="hljs-title">createMockSession</span><span class="hljs-params">()</span> </span>{
    Session&lt;F&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(invocation -&gt; {
        String path = invocation.getArgument(<span class="hljs-number">1</span>);
        assertThat(path.startsWith(<span class="hljs-string">"/"</span>)).isFalse();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).when(session).rename(Mockito.anyString(), Mockito.anyString());
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest552">Test Case ID #spring-integration_Test_55_2</h4>
<h4 id="test-case-name-testremotedirwithnullfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotehandlerfiletransferringmessagehandlertestsjava">Test Case Name: <code>testRemoteDirWithNull</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\handler\FileTransferringMessageHandlerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SessionFactory&lt;F&gt; sf = mock(SessionFactory.class);
<span class="hljs-deletion">-    Session&lt;F&gt; session = mock(Session.class);</span>
<span class="hljs-addition">+    Session&lt;F&gt; session = createMockSession();</span>
    when(sf.getSession()).thenReturn(session);
<span class="hljs-deletion">-    doAnswer(invocation -&gt; {</span>
<span class="hljs-deletion">-        String path = invocation.getArgument(1);</span>
<span class="hljs-deletion">-        assertThat(path.startsWith("/")).isFalse();</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).when(session).rename(Mockito.anyString(), Mockito.anyString());</span>
    ExpressionParser parser = new SpelExpressionParser();
    FileTransferringMessageHandler&lt;F&gt; handler = new FileTransferringMessageHandler&lt;F&gt;(sf);
    handler.setRemoteDirectoryExpression(parser.parseExpression("headers['path']"));
    handler.setBeanFactory(mock(BeanFactory.class));
    handler.afterPropertiesSet();
    Message&lt;?&gt; message = MessageBuilder.withPayload("hello").setHeader("path", null).build();
    handler.handleMessage(message);
    verify(session, times(1)).write(Mockito.any(InputStream.class), Mockito.anyString());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-keyword">public</span> &lt;F&gt; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRemoteDirWithNull</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory&lt;F&gt; sf = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;F&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(sf.getSession()).thenReturn(session);

    doAnswer(invocation -&gt; {

        String path = invocation.getArgument(<span class="hljs-number">1</span>);

        assertThat(path.startsWith(<span class="hljs-string">"/"</span>)).isFalse();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(session).rename(Mockito.anyString(), Mockito.anyString());

    ExpressionParser parser = <span class="hljs-keyword">new</span> SpelExpressionParser();

    FileTransferringMessageHandler&lt;F&gt; handler = <span class="hljs-keyword">new</span> FileTransferringMessageHandler&lt;F&gt;(sf);

    handler.setRemoteDirectoryExpression(parser.parseExpression(<span class="hljs-string">"headers['path']"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    Message&lt;?&gt; message = MessageBuilder.withPayload(<span class="hljs-string">"hello"</span>).setHeader(<span class="hljs-string">"path"</span>, <span class="hljs-keyword">null</span>).build();

    handler.handleMessage(message);

    verify(session, times(<span class="hljs-number">1</span>)).write(Mockito.any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">Mockito</span>.<span class="hljs-title">anyString</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;F&gt; <span class="hljs-function">Session&lt;F&gt; <span class="hljs-title">createMockSession</span><span class="hljs-params">()</span> </span>{
    Session&lt;F&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(invocation -&gt; {
        String path = invocation.getArgument(<span class="hljs-number">1</span>);
        assertThat(path.startsWith(<span class="hljs-string">"/"</span>)).isFalse();
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).when(session).rename(Mockito.anyString(), Mockito.anyString());
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci56">Mock Clone Instance #spring-integration_MCI_56</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>jakarta.mail.Folder</code></li>
<li><strong>Test Case Count</strong>: 5</li>
<li><strong>MO Count</strong>: 5</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Folder <span class="hljs-title">createMockFolder</span><span class="hljs-params">(Message[] messages)</span> </span>{
    Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(folder.getPermanentFlags()).willReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));
    given(folder.isOpen()).willReturn(<span class="hljs-keyword">true</span>);
    willAnswer(invocation -&gt; messages).given(folder).search(any(SearchTerm<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    <span class="hljs-keyword">return</span> folder;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest561">Test Case ID #spring-integration_Test_56_1</h4>
<h4 id="test-case-name-receivemarkasreadanddeletefile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailimapmailreceivertestsjava">Test Case Name: <code>receiveMarkAsReadAndDelete</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\ImapMailReceiverTests.java</code>)</h4>
<h4 id="mock-object-variable-name-folder">Mock Object Variable Name: <code>folder</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Field folderField = AbstractMailReceiver.class.getDeclaredField("folder");
    folderField.setAccessible(true);
<span class="hljs-deletion">-    Folder folder = mock(Folder.class);</span>
<span class="hljs-deletion">-    given(folder.getPermanentFlags()).willReturn(new Flags(Flags.Flag.USER));</span>
<span class="hljs-deletion">-    given(folder.isOpen()).willReturn(true);</span>
<span class="hljs-addition">+    Message msg1 = GreenMailUtil.newMimeMessage("test1");</span>
<span class="hljs-addition">+    Message msg2 = GreenMailUtil.newMimeMessage("test2");</span>
<span class="hljs-addition">+    final Message[] messages = new Message[] { msg1, msg2 };</span>
<span class="hljs-addition">+    Folder folder = createMockFolder(messages);</span>
    folderField.set(receiver, folder);
<span class="hljs-deletion">-    Message msg1 = GreenMailUtil.newMimeMessage("test1");</span>
<span class="hljs-deletion">-    Message msg2 = GreenMailUtil.newMimeMessage("test2");</span>
<span class="hljs-deletion">-    final Message[] messages = new Message[] { msg1, msg2 };</span>
    willAnswer(invocation -&gt; {
        DirectFieldAccessor accessor = new DirectFieldAccessor(invocation.getMock());
        int folderOpenMode = (int) accessor.getPropertyValue("folderOpenMode");
        if (folderOpenMode != Folder.READ_WRITE) {
            throw new IllegalArgumentException("Folder had to be open in READ_WRITE mode");
        }
        return null;
    }).given(receiver).openFolder();
<span class="hljs-deletion">-    willAnswer(invocation -&gt; messages).given(folder).search(any(SearchTerm.class));</span>
    willAnswer(invocation -&gt; null).given(receiver).fetchMessages(messages);
    receiver.receive();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveMarkAsReadAndDelete</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractMailReceiver receiver = <span class="hljs-keyword">new</span> ImapMailReceiver();

    ((ImapMailReceiver) receiver).setShouldMarkMessagesAsRead(<span class="hljs-keyword">true</span>);

    receiver.setShouldDeleteMessages(<span class="hljs-keyword">true</span>);

    receiver = spy(receiver);

    receiver.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    receiver.afterPropertiesSet();

    Field folderField = AbstractMailReceiver<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredField</span>("<span class="hljs-title">folder</span>")</span>;

    folderField.setAccessible(<span class="hljs-keyword">true</span>);

    Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(folder.getPermanentFlags()).willReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));

    given(folder.isOpen()).willReturn(<span class="hljs-keyword">true</span>);

    folderField.set(receiver, folder);

    Message msg1 = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test1"</span>);

    Message msg2 = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test2"</span>);

    <span class="hljs-keyword">final</span> Message[] messages = <span class="hljs-keyword">new</span> Message[] { msg1, msg2 };

    willAnswer(invocation -&gt; {

        DirectFieldAccessor accessor = <span class="hljs-keyword">new</span> DirectFieldAccessor(invocation.getMock());

        <span class="hljs-keyword">int</span> folderOpenMode = (<span class="hljs-keyword">int</span>) accessor.getPropertyValue(<span class="hljs-string">"folderOpenMode"</span>);

        <span class="hljs-keyword">if</span> (folderOpenMode != Folder.READ_WRITE) {

            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"Folder had to be open in READ_WRITE mode"</span>);

        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(receiver).openFolder();

    willAnswer(invocation -&gt; messages).given(folder).search(any(SearchTerm<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    willAnswer(invocation -&gt; <span class="hljs-keyword">null</span>).given(receiver).fetchMessages(messages);

    receiver.receive();

    assertThat(msg1.getFlags().contains(Flag.SEEN)).isTrue();

    assertThat(msg2.getFlags().contains(Flag.SEEN)).isTrue();

    verify(receiver, times(<span class="hljs-number">2</span>)).deleteMessages(Mockito.any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Folder <span class="hljs-title">createMockFolder</span><span class="hljs-params">(Message[] messages)</span> </span>{
    Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(folder.getPermanentFlags()).willReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));
    given(folder.isOpen()).willReturn(<span class="hljs-keyword">true</span>);
    willAnswer(invocation -&gt; messages).given(folder).search(any(SearchTerm<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    <span class="hljs-keyword">return</span> folder;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest562">Test Case ID #spring-integration_Test_56_2</h4>
<h4 id="test-case-name-receiveanddontmarkasreadfile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailimapmailreceivertestsjava">Test Case Name: <code>receiveAndDontMarkAsRead</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\ImapMailReceiverTests.java</code>)</h4>
<h4 id="mock-object-variable-name-folder">Mock Object Variable Name: <code>folder</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    Field folderField = AbstractMailReceiver.class.getDeclaredField("folder");
    folderField.setAccessible(true);
<span class="hljs-deletion">-    Folder folder = mock(Folder.class);</span>
<span class="hljs-deletion">-    given(folder.getPermanentFlags()).willReturn(new Flags(Flags.Flag.USER));</span>
<span class="hljs-deletion">-    given(folder.isOpen()).willReturn(true);</span>
<span class="hljs-addition">+    Folder folder = createMockFolder(messages);</span>
    folderField.set(receiver, folder);
    Message msg1 = GreenMailUtil.newMimeMessage("test1");
    Message msg2 = GreenMailUtil.newMimeMessage("test2");
    final Message[] messages = new Message[] { msg1, msg2 };
    willAnswer(invocation -&gt; null).given(receiver).openFolder();
<span class="hljs-deletion">-    willAnswer(invocation -&gt; messages).given(folder).search(any(SearchTerm.class));</span>
    willAnswer(invocation -&gt; null).given(receiver).fetchMessages(messages);
    receiver.afterPropertiesSet();
    receiver.receive();
    assertThat(msg1.getFlags().contains(Flag.SEEN)).isFalse();
    assertThat(msg2.getFlags().contains(Flag.SEEN)).isFalse();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveAndDontMarkAsRead</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractMailReceiver receiver = <span class="hljs-keyword">new</span> ImapMailReceiver();

    ((ImapMailReceiver) receiver).setShouldMarkMessagesAsRead(<span class="hljs-keyword">false</span>);

    receiver = spy(receiver);

    receiver.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    receiver.afterPropertiesSet();

    Field folderField = AbstractMailReceiver<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredField</span>("<span class="hljs-title">folder</span>")</span>;

    folderField.setAccessible(<span class="hljs-keyword">true</span>);

    Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(folder.getPermanentFlags()).willReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));

    given(folder.isOpen()).willReturn(<span class="hljs-keyword">true</span>);

    folderField.set(receiver, folder);

    Message msg1 = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test1"</span>);

    Message msg2 = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test2"</span>);

    <span class="hljs-keyword">final</span> Message[] messages = <span class="hljs-keyword">new</span> Message[] { msg1, msg2 };

    willAnswer(invocation -&gt; <span class="hljs-keyword">null</span>).given(receiver).openFolder();

    willAnswer(invocation -&gt; messages).given(folder).search(any(SearchTerm<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    willAnswer(invocation -&gt; <span class="hljs-keyword">null</span>).given(receiver).fetchMessages(messages);

    receiver.afterPropertiesSet();

    receiver.receive();

    assertThat(msg1.getFlags().contains(Flag.SEEN)).isFalse();

    assertThat(msg2.getFlags().contains(Flag.SEEN)).isFalse();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Folder <span class="hljs-title">createMockFolder</span><span class="hljs-params">(Message[] messages)</span> </span>{
    Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(folder.getPermanentFlags()).willReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));
    given(folder.isOpen()).willReturn(<span class="hljs-keyword">true</span>);
    willAnswer(invocation -&gt; messages).given(folder).search(any(SearchTerm<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    <span class="hljs-keyword">return</span> folder;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest563">Test Case ID #spring-integration_Test_56_3</h4>
<h4 id="test-case-name-receiveanddontmarkasreadbutdeletefile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailimapmailreceivertestsjava">Test Case Name: <code>receiveAndDontMarkAsReadButDelete</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\ImapMailReceiverTests.java</code>)</h4>
<h4 id="mock-object-variable-name-folder">Mock Object Variable Name: <code>folder</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Field folderField = AbstractMailReceiver.class.getDeclaredField("folder");
    folderField.setAccessible(true);
<span class="hljs-deletion">-    Folder folder = mock(Folder.class);</span>
<span class="hljs-deletion">-    given(folder.getPermanentFlags()).willReturn(new Flags(Flags.Flag.USER));</span>
<span class="hljs-deletion">-    given(folder.isOpen()).willReturn(true);</span>
<span class="hljs-addition">+    Message msg1 = GreenMailUtil.newMimeMessage("test1");</span>
<span class="hljs-addition">+    Message msg2 = GreenMailUtil.newMimeMessage("test2");</span>
<span class="hljs-addition">+    final Message[] messages = new Message[] { msg1, msg2 };</span>
<span class="hljs-addition">+    Folder folder = createMockFolder(messages);</span>
    folderField.set(receiver, folder);
<span class="hljs-deletion">-    Message msg1 = GreenMailUtil.newMimeMessage("test1");</span>
<span class="hljs-deletion">-    Message msg2 = GreenMailUtil.newMimeMessage("test2");</span>
<span class="hljs-deletion">-    final Message[] messages = new Message[] { msg1, msg2 };</span>
    willAnswer(invocation -&gt; {
        DirectFieldAccessor accessor = new DirectFieldAccessor(invocation.getMock());
        int folderOpenMode = (int) accessor.getPropertyValue("folderOpenMode");
        if (folderOpenMode != Folder.READ_WRITE) {
            throw new IllegalArgumentException("Folder had to be open in READ_WRITE mode");
        }
        return null;
    }).given(receiver).openFolder();
<span class="hljs-deletion">-    willAnswer(invocation -&gt; messages).given(folder).search(any(SearchTerm.class));</span>
    willAnswer(invocation -&gt; null).given(receiver).fetchMessages(messages);
    receiver.afterPropertiesSet();
    receiver.receive();
    assertThat(msg1.getFlags().contains(Flag.SEEN)).isFalse();
    assertThat(msg2.getFlags().contains(Flag.SEEN)).isFalse();
    assertThat(msg1.getFlags().contains(Flag.DELETED)).isTrue();
    assertThat(msg2.getFlags().contains(Flag.DELETED)).isTrue();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveAndDontMarkAsReadButDelete</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractMailReceiver receiver = <span class="hljs-keyword">new</span> ImapMailReceiver();

    receiver.setShouldDeleteMessages(<span class="hljs-keyword">true</span>);

    ((ImapMailReceiver) receiver).setShouldMarkMessagesAsRead(<span class="hljs-keyword">false</span>);

    receiver = spy(receiver);

    receiver.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    receiver.afterPropertiesSet();

    Field folderField = AbstractMailReceiver<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredField</span>("<span class="hljs-title">folder</span>")</span>;

    folderField.setAccessible(<span class="hljs-keyword">true</span>);

    Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(folder.getPermanentFlags()).willReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));

    given(folder.isOpen()).willReturn(<span class="hljs-keyword">true</span>);

    folderField.set(receiver, folder);

    Message msg1 = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test1"</span>);

    Message msg2 = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test2"</span>);

    <span class="hljs-keyword">final</span> Message[] messages = <span class="hljs-keyword">new</span> Message[] { msg1, msg2 };

    willAnswer(invocation -&gt; {

        DirectFieldAccessor accessor = <span class="hljs-keyword">new</span> DirectFieldAccessor(invocation.getMock());

        <span class="hljs-keyword">int</span> folderOpenMode = (<span class="hljs-keyword">int</span>) accessor.getPropertyValue(<span class="hljs-string">"folderOpenMode"</span>);

        <span class="hljs-keyword">if</span> (folderOpenMode != Folder.READ_WRITE) {

            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"Folder had to be open in READ_WRITE mode"</span>);

        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(receiver).openFolder();

    willAnswer(invocation -&gt; messages).given(folder).search(any(SearchTerm<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    willAnswer(invocation -&gt; <span class="hljs-keyword">null</span>).given(receiver).fetchMessages(messages);

    receiver.afterPropertiesSet();

    receiver.receive();

    assertThat(msg1.getFlags().contains(Flag.SEEN)).isFalse();

    assertThat(msg2.getFlags().contains(Flag.SEEN)).isFalse();

    assertThat(msg1.getFlags().contains(Flag.DELETED)).isTrue();

    assertThat(msg2.getFlags().contains(Flag.DELETED)).isTrue();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Folder <span class="hljs-title">createMockFolder</span><span class="hljs-params">(Message[] messages)</span> </span>{
    Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(folder.getPermanentFlags()).willReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));
    given(folder.isOpen()).willReturn(<span class="hljs-keyword">true</span>);
    willAnswer(invocation -&gt; messages).given(folder).search(any(SearchTerm<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    <span class="hljs-keyword">return</span> folder;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest564">Test Case ID #spring-integration_Test_56_4</h4>
<h4 id="test-case-name-receiveandignoremarkasreaddontdeletefile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailimapmailreceivertestsjava">Test Case Name: <code>receiveAndIgnoreMarkAsReadDontDelete</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\ImapMailReceiverTests.java</code>)</h4>
<h4 id="mock-object-variable-name-folder">Mock Object Variable Name: <code>folder</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Field folderField = AbstractMailReceiver.class.getDeclaredField("folder");
    folderField.setAccessible(true);
<span class="hljs-deletion">-    Folder folder = mock(Folder.class);</span>
<span class="hljs-deletion">-    given(folder.getPermanentFlags()).willReturn(new Flags(Flags.Flag.USER));</span>
<span class="hljs-deletion">-    given(folder.isOpen()).willReturn(true);</span>
    Message msg1 = GreenMailUtil.newMimeMessage("test1");
    Message msg2 = GreenMailUtil.newMimeMessage("test2");
    final Message[] messages = new Message[] { msg1, msg2 };
<span class="hljs-addition">+    Folder folder = createMockFolder(messages);</span>
    folderField.set(receiver, folder);
    willAnswer(invocation -&gt; null).given(receiver).fetchMessages(messages);
    receiver.receive();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveAndIgnoreMarkAsReadDontDelete</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractMailReceiver receiver = <span class="hljs-keyword">new</span> ImapMailReceiver();

    receiver = spy(receiver);

    receiver.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    receiver.afterPropertiesSet();

    Field folderField = AbstractMailReceiver<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredField</span>("<span class="hljs-title">folder</span>")</span>;

    folderField.setAccessible(<span class="hljs-keyword">true</span>);

    Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(folder.getPermanentFlags()).willReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));

    given(folder.isOpen()).willReturn(<span class="hljs-keyword">true</span>);

    folderField.set(receiver, folder);

    Message msg1 = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test1"</span>);

    Message msg2 = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test2"</span>);

    <span class="hljs-keyword">final</span> Message[] messages = <span class="hljs-keyword">new</span> Message[] { msg1, msg2 };

    willAnswer(invocation -&gt; {

        DirectFieldAccessor accessor = <span class="hljs-keyword">new</span> DirectFieldAccessor(invocation.getMock());

        <span class="hljs-keyword">int</span> folderOpenMode = (<span class="hljs-keyword">int</span>) accessor.getPropertyValue(<span class="hljs-string">"folderOpenMode"</span>);

        <span class="hljs-keyword">if</span> (folderOpenMode != Folder.READ_WRITE) {

            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"Folder had to be open in READ_WRITE mode"</span>);

        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(receiver).openFolder();

    willAnswer(invocation -&gt; messages).given(folder).search(any(SearchTerm<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    willAnswer(invocation -&gt; <span class="hljs-keyword">null</span>).given(receiver).fetchMessages(messages);

    receiver.receive();

    assertThat(msg1.getFlags().contains(Flag.SEEN)).isTrue();

    assertThat(msg2.getFlags().contains(Flag.SEEN)).isTrue();

    verify(receiver, times(<span class="hljs-number">0</span>)).deleteMessages(Mockito.any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Folder <span class="hljs-title">createMockFolder</span><span class="hljs-params">(Message[] messages)</span> </span>{
    Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(folder.getPermanentFlags()).willReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));
    given(folder.isOpen()).willReturn(<span class="hljs-keyword">true</span>);
    willAnswer(invocation -&gt; messages).given(folder).search(any(SearchTerm<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    <span class="hljs-keyword">return</span> folder;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest565">Test Case ID #spring-integration_Test_56_5</h4>
<h4 id="test-case-name-testidlechanneladapterexceptionfile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailimapmailreceivertestsjava">Test Case Name: <code>testIdleChannelAdapterException</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\ImapMailReceiverTests.java</code>)</h4>
<h4 id="mock-object-variable-name-folder">Mock Object Variable Name: <code>folder</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Field folderField = AbstractMailReceiver.class.getDeclaredField("folder");
    folderField.setAccessible(true);
<span class="hljs-deletion">-    Folder folder = mock(IMAPFolder.class);</span>
<span class="hljs-deletion">-    given(folder.getPermanentFlags()).willReturn(new Flags(Flags.Flag.USER));</span>
<span class="hljs-deletion">-    given(folder.isOpen()).willReturn(true);</span>
<span class="hljs-deletion">-    given(folder.exists()).willReturn(true);</span>
<span class="hljs-addition">+    Message mailMessage = GreenMailUtil.newMimeMessage("test1");</span>
<span class="hljs-addition">+    Message[] messages = new Message[] { mailMessage };</span>
<span class="hljs-addition">+    Folder folder = createMockFolder(messages);</span>
<span class="hljs-addition">+    given(folder.exists()).willReturn(true);</span>
    folderField.set(receiver, folder);
    Field storeField = AbstractMailReceiver.class.getDeclaredField("store");
    storeField.setAccessible(true);
    Store store = mock(Store.class);
    given(store.isConnected()).willReturn(true);
    storeField.set(receiver, store);
    DirectFieldAccessor adapterAccessor = new DirectFieldAccessor(adapter);
    adapterAccessor.setPropertyValue("mailReceiver", receiver);
<span class="hljs-deletion">-    Message mailMessage = GreenMailUtil.newMimeMessage("test1");</span>
<span class="hljs-deletion">-    Message[] messages = new Message[] { mailMessage };</span>
<span class="hljs-deletion">-    willAnswer(invocation -&gt; messages).given(folder).search(any(SearchTerm.class));</span>
    adapter.start();
    org.springframework.messaging.Message&lt;?&gt; replMessage = errorChannel.receive(10000);
    assertThat(replMessage).isNotNull();
    assertThat(((Exception) replMessage.getPayload()).getCause().getMessage()).isEqualTo("Failed");
    adapter.stop();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testIdleChannelAdapterException</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    ImapIdleChannelAdapter adapter = <span class="hljs-keyword">this</span>.context.getBean(<span class="hljs-string">"simpleAdapter"</span>, ImapIdleChannelAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">//ImapMailReceiver receiver = (ImapMailReceiver) TestUtils.getPropertyValue(adapter, "mailReceiver");</span>

    DirectChannel channel = <span class="hljs-keyword">new</span> DirectChannel();

    channel.subscribe(<span class="hljs-keyword">new</span> AbstractReplyProducingMessageHandler() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">handleRequestMessage</span><span class="hljs-params">(org.springframework.messaging.Message&lt;?&gt; requestMessage)</span> </span>{

            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"Failed"</span>);

        }

    });

    adapter.setOutputChannel(channel);

    QueueChannel errorChannel = <span class="hljs-keyword">new</span> QueueChannel();

    adapter.setErrorChannel(errorChannel);

    adapter.setReconnectDelay(<span class="hljs-number">10</span>);

    AbstractMailReceiver receiver = <span class="hljs-keyword">new</span> ImapMailReceiver();

    receiver.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    receiver.afterPropertiesSet();

    Field folderField = AbstractMailReceiver<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredField</span>("<span class="hljs-title">folder</span>")</span>;

    folderField.setAccessible(<span class="hljs-keyword">true</span>);

    Folder folder = mock(IMAPFolder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(folder.getPermanentFlags()).willReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));

    given(folder.isOpen()).willReturn(<span class="hljs-keyword">true</span>);

    given(folder.exists()).willReturn(<span class="hljs-keyword">true</span>);

    folderField.set(receiver, folder);

    Field storeField = AbstractMailReceiver<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredField</span>("<span class="hljs-title">store</span>")</span>;

    storeField.setAccessible(<span class="hljs-keyword">true</span>);

    Store store = mock(Store<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(store.isConnected()).willReturn(<span class="hljs-keyword">true</span>);

    storeField.set(receiver, store);

    DirectFieldAccessor adapterAccessor = <span class="hljs-keyword">new</span> DirectFieldAccessor(adapter);

    adapterAccessor.setPropertyValue(<span class="hljs-string">"mailReceiver"</span>, receiver);

    Message mailMessage = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test1"</span>);

    Message[] messages = <span class="hljs-keyword">new</span> Message[] { mailMessage };

    willAnswer(invocation -&gt; messages).given(folder).search(any(SearchTerm<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    adapter.start();

    org.springframework.messaging.Message&lt;?&gt; replMessage = errorChannel.receive(<span class="hljs-number">10000</span>);

    assertThat(replMessage).isNotNull();

    assertThat(((Exception) replMessage.getPayload()).getCause().getMessage()).isEqualTo(<span class="hljs-string">"Failed"</span>);

    adapter.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Folder <span class="hljs-title">createMockFolder</span><span class="hljs-params">(Message[] messages)</span> </span>{
    Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(folder.getPermanentFlags()).willReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));
    given(folder.isOpen()).willReturn(<span class="hljs-keyword">true</span>);
    willAnswer(invocation -&gt; messages).given(folder).search(any(SearchTerm<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    <span class="hljs-keyword">return</span> folder;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci57">Mock Clone Instance #spring-integration_MCI_57</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>jakarta.mail.Folder</code></li>
<li><strong>Test Case Count</strong>: 7</li>
<li><strong>MO Count</strong>: 7</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockFolder</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Folder <span class="hljs-title">createMockFolderWithPermanentFlags</span><span class="hljs-params">(Flags permanentFlags)</span> </span>{
        Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(folder.getPermanentFlags()).thenReturn(permanentFlags);
        <span class="hljs-keyword">return</span> folder;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest571">Test Case ID #spring-integration_Test_57_1</h4>
<h4 id="test-case-name-testattachmentsgutsfile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailimapmailreceivertestsjava">Test Case Name: <code>testAttachmentsGuts</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\ImapMailReceiverTests.java</code>)</h4>
<h4 id="mock-object-variable-name-folder">Mock Object Variable Name: <code>folder</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
private Folder testAttachmentsGuts(final ImapMailReceiver receiver) throws MessagingException, IOException {
    Store store = mock(Store.class);
<span class="hljs-deletion">-    Folder folder = mock(Folder.class);</span>
<span class="hljs-deletion">-    given(folder.exists()).willReturn(true);</span>
<span class="hljs-deletion">-    given(folder.isOpen()).willReturn(true);</span>
<span class="hljs-addition">+    Folder folder = MockFolder.createMockFolderWithPermanentFlags(new Flags(Flags.Flag.USER));</span>
<span class="hljs-addition">+    given(folder.exists()).willReturn(true);</span>
<span class="hljs-addition">+    given(folder.isOpen()).willReturn(true);</span>
    Message message = GreenMailUtil.newMimeMessage(new ClassPathResource("test.mail").getInputStream());
    given(folder.search(Mockito.any())).willReturn(new Message[] { message });
    given(store.getFolder(Mockito.any(URLName.class))).willReturn(folder);
<span class="hljs-deletion">-    given(folder.getPermanentFlags()).willReturn(new Flags(Flags.Flag.USER));</span>
    DirectFieldAccessor df = new DirectFieldAccessor(receiver);
    df.setPropertyValue("store", store);
    receiver.setBeanFactory(mock(BeanFactory.class));
    receiver.afterPropertiesSet();
    return folder;
}
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> Folder <span class="hljs-title">testAttachmentsGuts</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ImapMailReceiver receiver)</span> <span class="hljs-keyword">throws</span> MessagingException, IOException </span>{

    Store store = mock(Store<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(folder.exists()).willReturn(<span class="hljs-keyword">true</span>);

    given(folder.isOpen()).willReturn(<span class="hljs-keyword">true</span>);

    Message message = GreenMailUtil.newMimeMessage(<span class="hljs-keyword">new</span> ClassPathResource(<span class="hljs-string">"test.mail"</span>).getInputStream());

    given(folder.search(Mockito.any())).willReturn(<span class="hljs-keyword">new</span> Message[] { message });

    given(store.getFolder(Mockito.any(URLName<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">folder</span>)</span>;

    given(folder.getPermanentFlags()).willReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));

    DirectFieldAccessor df = <span class="hljs-keyword">new</span> DirectFieldAccessor(receiver);

    df.setPropertyValue(<span class="hljs-string">"store"</span>, store);

    receiver.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    receiver.afterPropertiesSet();

    <span class="hljs-keyword">return</span> folder;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockFolder</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Folder <span class="hljs-title">createMockFolderWithPermanentFlags</span><span class="hljs-params">(Flags permanentFlags)</span> </span>{
        Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(folder.getPermanentFlags()).thenReturn(permanentFlags);
        <span class="hljs-keyword">return</span> folder;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest572">Test Case ID #spring-integration_Test_57_2</h4>
<h4 id="test-case-name-validatesearchtermswhenshouldmarkasreadwithexistingflagsfile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailimapmailsearchtermstestsjava">Test Case Name: <code>validateSearchTermsWhenShouldMarkAsReadWithExistingFlags</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\ImapMailSearchTermsTests.java</code>)</h4>
<h4 id="mock-object-variable-name-folder">Mock Object Variable Name: <code>folder</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    Field folderField = AbstractMailReceiver.class.getDeclaredField("folder");
    folderField.setAccessible(true);
<span class="hljs-deletion">-    Folder folder = mock(Folder.class);</span>
<span class="hljs-deletion">-    when(folder.getPermanentFlags()).thenReturn(new Flags(Flags.Flag.USER));</span>
<span class="hljs-addition">+    Folder folder = MockFolder.createMockFolderWithPermanentFlags(new Flags(Flags.Flag.USER));</span>
    folderField.set(receiver, folder);
    Method compileSearchTerms = ReflectionUtils.findMethod(receiver.getClass(), "compileSearchTerms", Flags.class);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">validateSearchTermsWhenShouldMarkAsReadWithExistingFlags</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    ImapMailReceiver receiver = <span class="hljs-keyword">new</span> ImapMailReceiver();

    receiver.setShouldMarkMessagesAsRead(<span class="hljs-keyword">true</span>);

    receiver.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    receiver.afterPropertiesSet();

    Field folderField = AbstractMailReceiver<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredField</span>("<span class="hljs-title">folder</span>")</span>;

    folderField.setAccessible(<span class="hljs-keyword">true</span>);

    Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(folder.getPermanentFlags()).thenReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));

    folderField.set(receiver, folder);

    Method compileSearchTerms = ReflectionUtils.findMethod(receiver.getClass(), <span class="hljs-string">"compileSearchTerms"</span>, Flags<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    compileSearchTerms.setAccessible(<span class="hljs-keyword">true</span>);

    Flags flags = <span class="hljs-keyword">new</span> Flags();

    flags.add(Flag.ANSWERED);

    SearchTerm searchTerms = (SearchTerm) compileSearchTerms.invoke(receiver, flags);

    assertThat(searchTerms <span class="hljs-keyword">instanceof</span> AndTerm).isTrue();

    AndTerm andTerm = (AndTerm) searchTerms;

    SearchTerm[] terms = andTerm.getTerms();

    assertThat(terms.length).isEqualTo(<span class="hljs-number">2</span>);

    NotTerm notTerm = (NotTerm) terms[<span class="hljs-number">0</span>];

    assertThat(((FlagTerm) notTerm.getTerm()).getFlags().contains(Flag.ANSWERED)).isTrue();

    notTerm = (NotTerm) terms[<span class="hljs-number">1</span>];

    Flags siFlags = <span class="hljs-keyword">new</span> Flags();

    siFlags.add(AbstractMailReceiver.DEFAULT_SI_USER_FLAG);

    assertThat(((FlagTerm) notTerm.getTerm()).getFlags().contains(siFlags)).isTrue();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockFolder</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Folder <span class="hljs-title">createMockFolderWithPermanentFlags</span><span class="hljs-params">(Flags permanentFlags)</span> </span>{
        Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(folder.getPermanentFlags()).thenReturn(permanentFlags);
        <span class="hljs-keyword">return</span> folder;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest573">Test Case ID #spring-integration_Test_57_3</h4>
<h4 id="test-case-name-validatesearchtermswhenshouldnotmarkasreadnoexistingflagsfile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailimapmailsearchtermstestsjava">Test Case Name: <code>validateSearchTermsWhenShouldNotMarkAsReadNoExistingFlags</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\ImapMailSearchTermsTests.java</code>)</h4>
<h4 id="mock-object-variable-name-folder">Mock Object Variable Name: <code>folder</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    Field folderField = AbstractMailReceiver.class.getDeclaredField("folder");
    folderField.setAccessible(true);
<span class="hljs-deletion">-    Folder folder = mock(Folder.class);</span>
<span class="hljs-deletion">-    when(folder.getPermanentFlags()).thenReturn(new Flags(Flags.Flag.USER));</span>
<span class="hljs-addition">+    Folder folder = MockFolder.createMockFolderWithPermanentFlags(new Flags(Flags.Flag.USER));</span>
    folderField.set(receiver, folder);
    Method compileSearchTerms = ReflectionUtils.findMethod(receiver.getClass(), "compileSearchTerms", Flags.class);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">validateSearchTermsWhenShouldNotMarkAsReadNoExistingFlags</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    ImapMailReceiver receiver = <span class="hljs-keyword">new</span> ImapMailReceiver();

    receiver.setShouldMarkMessagesAsRead(<span class="hljs-keyword">false</span>);

    receiver.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    receiver.afterPropertiesSet();

    Field folderField = AbstractMailReceiver<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredField</span>("<span class="hljs-title">folder</span>")</span>;

    folderField.setAccessible(<span class="hljs-keyword">true</span>);

    Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(folder.getPermanentFlags()).thenReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));

    folderField.set(receiver, folder);

    Method compileSearchTerms = ReflectionUtils.findMethod(receiver.getClass(), <span class="hljs-string">"compileSearchTerms"</span>, Flags<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    compileSearchTerms.setAccessible(<span class="hljs-keyword">true</span>);

    Flags flags = <span class="hljs-keyword">new</span> Flags();

    SearchTerm searchTerms = (SearchTerm) compileSearchTerms.invoke(receiver, flags);

    assertThat(searchTerms <span class="hljs-keyword">instanceof</span> NotTerm).isTrue();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockFolder</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Folder <span class="hljs-title">createMockFolderWithPermanentFlags</span><span class="hljs-params">(Flags permanentFlags)</span> </span>{
        Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(folder.getPermanentFlags()).thenReturn(permanentFlags);
        <span class="hljs-keyword">return</span> folder;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest574">Test Case ID #spring-integration_Test_57_4</h4>
<h4 id="test-case-name-receiveanddeletefile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailpop3mailreceivertestsjava">Test Case Name: <code>receiveAndDelete</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\Pop3MailReceiverTests.java</code>)</h4>
<h4 id="mock-object-variable-name-folder">Mock Object Variable Name: <code>folder</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    Field folderField = AbstractMailReceiver.class.getDeclaredField("folder");
    folderField.setAccessible(true);
<span class="hljs-deletion">-    Folder folder = mock(Folder.class);</span>
<span class="hljs-deletion">-    when(folder.getPermanentFlags()).thenReturn(new Flags(Flags.Flag.USER));</span>
<span class="hljs-addition">+    Folder folder = MockFolder.createMockFolderWithPermanentFlags(new Flags(Flags.Flag.USER));</span>
    folderField.set(receiver, folder);
    Message msg1 = GreenMailUtil.newMimeMessage("test1");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveAndDelete</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractMailReceiver receiver = <span class="hljs-keyword">new</span> Pop3MailReceiver();

    receiver.setShouldDeleteMessages(<span class="hljs-keyword">true</span>);

    receiver = spy(receiver);

    receiver.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    receiver.afterPropertiesSet();

    Field folderField = AbstractMailReceiver<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredField</span>("<span class="hljs-title">folder</span>")</span>;

    folderField.setAccessible(<span class="hljs-keyword">true</span>);

    Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(folder.getPermanentFlags()).thenReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));

    folderField.set(receiver, folder);

    Message msg1 = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test1"</span>);

    Message msg2 = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test2"</span>);

    <span class="hljs-keyword">final</span> Message[] messages = <span class="hljs-keyword">new</span> Message[] { msg1, msg2 };

    doAnswer(invocation -&gt; {

        DirectFieldAccessor accessor = <span class="hljs-keyword">new</span> DirectFieldAccessor(invocation.getMock());

        <span class="hljs-keyword">int</span> folderOpenMode = (Integer) accessor.getPropertyValue(<span class="hljs-string">"folderOpenMode"</span>);

        <span class="hljs-keyword">if</span> (folderOpenMode != Folder.READ_WRITE) {

            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"Folder had to be open in READ_WRITE mode"</span>);

        }

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(receiver).openFolder();

    doAnswer(invocation -&gt; messages).when(receiver).searchForNewMessages();

    doAnswer(invocation -&gt; <span class="hljs-keyword">null</span>).when(receiver).fetchMessages(messages);

    receiver.afterPropertiesSet();

    receiver.receive();

    assertThat(msg1.getFlags().contains(Flag.DELETED)).isTrue();

    assertThat(msg2.getFlags().contains(Flag.DELETED)).isTrue();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockFolder</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Folder <span class="hljs-title">createMockFolderWithPermanentFlags</span><span class="hljs-params">(Flags permanentFlags)</span> </span>{
        Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(folder.getPermanentFlags()).thenReturn(permanentFlags);
        <span class="hljs-keyword">return</span> folder;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest575">Test Case ID #spring-integration_Test_57_5</h4>
<h4 id="test-case-name-receiveanddontdeletefile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailpop3mailreceivertestsjava">Test Case Name: <code>receiveAndDontDelete</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\Pop3MailReceiverTests.java</code>)</h4>
<h4 id="mock-object-variable-name-folder">Mock Object Variable Name: <code>folder</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Field folderField = AbstractMailReceiver.class.getDeclaredField("folder");
    folderField.setAccessible(true);
<span class="hljs-deletion">-    Folder folder = mock(Folder.class);</span>
<span class="hljs-deletion">-    when(folder.getPermanentFlags()).thenReturn(new Flags(Flags.Flag.USER));</span>
<span class="hljs-addition">+    Folder folder = MockFolder.createMockFolderWithPermanentFlags(new Flags(Flags.Flag.USER));</span>
    folderField.set(receiver, folder);
    Message msg1 = GreenMailUtil.newMimeMessage("test1");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveAndDontDelete</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractMailReceiver receiver = <span class="hljs-keyword">new</span> Pop3MailReceiver();

    receiver.setShouldDeleteMessages(<span class="hljs-keyword">false</span>);

    receiver = spy(receiver);

    receiver.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    receiver.afterPropertiesSet();

    Field folderField = AbstractMailReceiver<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredField</span>("<span class="hljs-title">folder</span>")</span>;

    folderField.setAccessible(<span class="hljs-keyword">true</span>);

    Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(folder.getPermanentFlags()).thenReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));

    folderField.set(receiver, folder);

    Message msg1 = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test1"</span>);

    Message msg2 = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test2"</span>);

    <span class="hljs-keyword">final</span> Message[] messages = <span class="hljs-keyword">new</span> Message[] { msg1, msg2 };

    doAnswer(invocation -&gt; <span class="hljs-keyword">null</span>).when(receiver).openFolder();

    doAnswer(invocation -&gt; messages).when(receiver).searchForNewMessages();

    doAnswer(invocation -&gt; <span class="hljs-keyword">null</span>).when(receiver).fetchMessages(messages);

    receiver.afterPropertiesSet();

    receiver.receive();

    assertThat(msg1.getFlags().contains(Flag.DELETED)).isFalse();

    assertThat(msg2.getFlags().contains(Flag.DELETED)).isFalse();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockFolder</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Folder <span class="hljs-title">createMockFolderWithPermanentFlags</span><span class="hljs-params">(Flags permanentFlags)</span> </span>{
        Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(folder.getPermanentFlags()).thenReturn(permanentFlags);
        <span class="hljs-keyword">return</span> folder;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest576">Test Case ID #spring-integration_Test_57_6</h4>
<h4 id="test-case-name-receiveanddontsetdeletewithurlfile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailpop3mailreceivertestsjava">Test Case Name: <code>receiveAndDontSetDeleteWithUrl</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\Pop3MailReceiverTests.java</code>)</h4>
<h4 id="mock-object-variable-name-folder">Mock Object Variable Name: <code>folder</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Field folderField = AbstractMailReceiver.class.getDeclaredField("folder");
    folderField.setAccessible(true);
<span class="hljs-deletion">-    Folder folder = mock(Folder.class);</span>
<span class="hljs-deletion">-    when(folder.getPermanentFlags()).thenReturn(new Flags(Flags.Flag.USER));</span>
<span class="hljs-addition">+    Folder folder = MockFolder.createMockFolderWithPermanentFlags(new Flags(Flags.Flag.USER));</span>
    folderField.set(receiver, folder);
    Message msg1 = GreenMailUtil.newMimeMessage("test1");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveAndDontSetDeleteWithUrl</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractMailReceiver receiver = <span class="hljs-keyword">new</span> Pop3MailReceiver(<span class="hljs-string">"pop3://some.host"</span>);

    receiver = spy(receiver);

    receiver.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    receiver.afterPropertiesSet();

    Field folderField = AbstractMailReceiver<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredField</span>("<span class="hljs-title">folder</span>")</span>;

    folderField.setAccessible(<span class="hljs-keyword">true</span>);

    Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(folder.getPermanentFlags()).thenReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));

    folderField.set(receiver, folder);

    Message msg1 = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test1"</span>);

    Message msg2 = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test2"</span>);

    <span class="hljs-keyword">final</span> Message[] messages = <span class="hljs-keyword">new</span> Message[] { msg1, msg2 };

    doAnswer(invocation -&gt; <span class="hljs-keyword">null</span>).when(receiver).openFolder();

    doAnswer(invocation -&gt; messages).when(receiver).searchForNewMessages();

    doAnswer(invocation -&gt; <span class="hljs-keyword">null</span>).when(receiver).fetchMessages(messages);

    receiver.afterPropertiesSet();

    receiver.receive();

    assertThat(msg1.getFlags().contains(Flag.DELETED)).isFalse();

    assertThat(msg2.getFlags().contains(Flag.DELETED)).isFalse();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockFolder</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Folder <span class="hljs-title">createMockFolderWithPermanentFlags</span><span class="hljs-params">(Flags permanentFlags)</span> </span>{
        Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(folder.getPermanentFlags()).thenReturn(permanentFlags);
        <span class="hljs-keyword">return</span> folder;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest577">Test Case ID #spring-integration_Test_57_7</h4>
<h4 id="test-case-name-receiveanddontsetdeletewithouturlfile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailpop3mailreceivertestsjava">Test Case Name: <code>receiveAndDontSetDeleteWithoutUrl</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\Pop3MailReceiverTests.java</code>)</h4>
<h4 id="mock-object-variable-name-folder">Mock Object Variable Name: <code>folder</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Field folderField = AbstractMailReceiver.class.getDeclaredField("folder");
    folderField.setAccessible(true);
<span class="hljs-deletion">-    Folder folder = mock(Folder.class);</span>
<span class="hljs-deletion">-    when(folder.getPermanentFlags()).thenReturn(new Flags(Flags.Flag.USER));</span>
<span class="hljs-addition">+    Folder folder = MockFolder.createMockFolderWithPermanentFlags(new Flags(Flags.Flag.USER));</span>
    folderField.set(receiver, folder);
    Message msg1 = GreenMailUtil.newMimeMessage("test1");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveAndDontSetDeleteWithoutUrl</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractMailReceiver receiver = <span class="hljs-keyword">new</span> Pop3MailReceiver();

    receiver = spy(receiver);

    receiver.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    receiver.afterPropertiesSet();

    Field folderField = AbstractMailReceiver<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredField</span>("<span class="hljs-title">folder</span>")</span>;

    folderField.setAccessible(<span class="hljs-keyword">true</span>);

    Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(folder.getPermanentFlags()).thenReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));

    folderField.set(receiver, folder);

    Message msg1 = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test1"</span>);

    Message msg2 = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test2"</span>);

    <span class="hljs-keyword">final</span> Message[] messages = <span class="hljs-keyword">new</span> Message[] { msg1, msg2 };

    doAnswer(invocation -&gt; <span class="hljs-keyword">null</span>).when(receiver).openFolder();

    doAnswer(invocation -&gt; messages).when(receiver).searchForNewMessages();

    doAnswer(invocation -&gt; <span class="hljs-keyword">null</span>).when(receiver).fetchMessages(messages);

    receiver.afterPropertiesSet();

    receiver.receive();

    assertThat(msg1.getFlags().contains(Flag.DELETED)).isFalse();

    assertThat(msg2.getFlags().contains(Flag.DELETED)).isFalse();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockFolder</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Folder <span class="hljs-title">createMockFolderWithPermanentFlags</span><span class="hljs-params">(Flags permanentFlags)</span> </span>{
        Folder folder = mock(Folder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(folder.getPermanentFlags()).thenReturn(permanentFlags);
        <span class="hljs-keyword">return</span> folder;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci58">Mock Clone Instance #spring-integration_MCI_58</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>jakarta.mail.Message</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Message <span class="hljs-title">createMockMessageWithSubject</span><span class="hljs-params">(String subject)</span> </span>{
    Message message = mock(MimeMessage<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(message.getSubject()).willReturn(subject);
    <span class="hljs-keyword">return</span> message;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest581">Test Case ID #spring-integration_Test_58_1</h4>
<h4 id="test-case-name-receiveexpungedandnotexpungedlogfilteredfile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailimapmailreceivertestsjava">Test Case Name: <code>receiveExpungedAndNotExpungedLogFiltered</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\ImapMailReceiverTests.java</code>)</h4>
<h4 id="mock-object-variable-name-msg1">Mock Object Variable Name: <code>msg1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(logger.isDebugEnabled()).thenReturn(true);
<span class="hljs-deletion">-    Message msg1 = mock(MimeMessage.class);</span>
<span class="hljs-addition">+    Message msg1 = createMockMessageWithSubject("msg1");</span>
    Message msg2 = mock(MimeMessage.class);
<span class="hljs-deletion">-    given(msg1.isExpunged()).willReturn(true);</span>
<span class="hljs-addition">+    given(msg1.isExpunged()).willReturn(true);</span>
<span class="hljs-deletion">-    given(msg1.getSubject()).willReturn("msg1");</span>
    given(msg2.getSubject()).willReturn("msg2");
    Expression selectorExpression = new SpelExpressionParser().parseExpression("false");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveExpungedAndNotExpungedLogFiltered</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractMailReceiver receiver = <span class="hljs-keyword">new</span> ImapMailReceiver();

    LogAccessor logger = spy(TestUtils.getPropertyValue(receiver, <span class="hljs-string">"logger"</span>, LogAccessor<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">new</span> DirectFieldAccessor(receiver).setPropertyValue(<span class="hljs-string">"logger"</span>, logger);

    when(logger.isDebugEnabled()).thenReturn(<span class="hljs-keyword">true</span>);

    Message msg1 = mock(MimeMessage<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Message msg2 = mock(MimeMessage<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(msg1.isExpunged()).willReturn(<span class="hljs-keyword">true</span>);

    given(msg1.getSubject()).willReturn(<span class="hljs-string">"msg1"</span>);

    given(msg2.getSubject()).willReturn(<span class="hljs-string">"msg2"</span>);

    Expression selectorExpression = <span class="hljs-keyword">new</span> SpelExpressionParser().parseExpression(<span class="hljs-string">"false"</span>);

    receiver.setSelectorExpression(selectorExpression);

    receiveAndMarkAsReadDontDeleteGuts(receiver, msg1, msg2);

    verify(msg1).isExpunged();

    verify(msg2).isExpunged();

    verify(msg1, never()).getSubject();

    verify(msg2).getSubject();

    verify(logger).debug(Mockito.startsWith(<span class="hljs-string">"Expunged message discarded"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Message <span class="hljs-title">createMockMessageWithSubject</span><span class="hljs-params">(String subject)</span> </span>{
    Message message = mock(MimeMessage<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(message.getSubject()).willReturn(subject);
    <span class="hljs-keyword">return</span> message;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest582">Test Case ID #spring-integration_Test_58_2</h4>
<h4 id="test-case-name-receiveexpungedandnotexpungedlogfilteredfile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailimapmailreceivertestsjava">Test Case Name: <code>receiveExpungedAndNotExpungedLogFiltered</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\ImapMailReceiverTests.java</code>)</h4>
<h4 id="mock-object-variable-name-msg2">Mock Object Variable Name: <code>msg2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Message msg1 = mock(MimeMessage.class);
<span class="hljs-deletion">-    Message msg2 = mock(MimeMessage.class);</span>
     given(msg1.isExpunged()).willReturn(true);
     given(msg1.getSubject()).willReturn("msg1");
<span class="hljs-deletion">-    given(msg2.getSubject()).willReturn("msg2");</span>
<span class="hljs-addition">+    Message msg2 = createMockMessageWithSubject("msg2");</span>
     Expression selectorExpression = new SpelExpressionParser().parseExpression("false");
     receiver.setSelectorExpression(selectorExpression);
     receiveAndMarkAsReadDontDeleteGuts(receiver, msg1, msg2);
     verify(msg1).isExpunged();
     verify(msg2).isExpunged();
     verify(msg1, never()).getSubject();
     verify(msg2).getSubject();
     verify(logger).debug(Mockito.startsWith("Expunged message discarded"));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveExpungedAndNotExpungedLogFiltered</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractMailReceiver receiver = <span class="hljs-keyword">new</span> ImapMailReceiver();

    LogAccessor logger = spy(TestUtils.getPropertyValue(receiver, <span class="hljs-string">"logger"</span>, LogAccessor<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">new</span> DirectFieldAccessor(receiver).setPropertyValue(<span class="hljs-string">"logger"</span>, logger);

    when(logger.isDebugEnabled()).thenReturn(<span class="hljs-keyword">true</span>);

    Message msg1 = mock(MimeMessage<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Message msg2 = mock(MimeMessage<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(msg1.isExpunged()).willReturn(<span class="hljs-keyword">true</span>);

    given(msg1.getSubject()).willReturn(<span class="hljs-string">"msg1"</span>);

    given(msg2.getSubject()).willReturn(<span class="hljs-string">"msg2"</span>);

    Expression selectorExpression = <span class="hljs-keyword">new</span> SpelExpressionParser().parseExpression(<span class="hljs-string">"false"</span>);

    receiver.setSelectorExpression(selectorExpression);

    receiveAndMarkAsReadDontDeleteGuts(receiver, msg1, msg2);

    verify(msg1).isExpunged();

    verify(msg2).isExpunged();

    verify(msg1, never()).getSubject();

    verify(msg2).getSubject();

    verify(logger).debug(Mockito.startsWith(<span class="hljs-string">"Expunged message discarded"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Message <span class="hljs-title">createMockMessageWithSubject</span><span class="hljs-params">(String subject)</span> </span>{
    Message message = mock(MimeMessage<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(message.getSubject()).willReturn(subject);
    <span class="hljs-keyword">return</span> message;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci59">Mock Clone Instance #spring-integration_MCI_59</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>java.io.File</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> File <span class="hljs-title">createMockFile</span><span class="hljs-params">(Path toPathReturn)</span> </span>{
    File fileMock = mock();
    when(fileMock.toPath()).thenReturn(toPathReturn);
    <span class="hljs-keyword">return</span> fileMock;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest591">Test Case ID #spring-integration_Test_59_1</h4>
<h4 id="test-case-name-scaneachpollfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfilefilereadingmessagesourcetestsjava">Test Case Name: <code>scanEachPoll</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\FileReadingMessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-anotherfilemock">Mock Object Variable Name: <code>anotherFileMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void scanEachPoll() {
<span class="hljs-deletion">-    File anotherFileMock = mock();</span>
<span class="hljs-deletion">-    when(anotherFileMock.toPath()).thenReturn(Path.of("[dir]/anotherFileMock"));</span>
<span class="hljs-addition">+    File anotherFileMock = createMockFile(Path.of("[dir]/anotherFileMock"));</span>
    when(inputDirectoryMock.listFiles()).thenReturn(new File[] { fileMock, anotherFileMock });
    source.setScanEachPoll(true);
    assertThat(source.receive()).isNotNull();
    assertThat(source.receive()).isNotNull();
    assertThat(source.receive()).isNull();
    verify(inputDirectoryMock, times(3)).listFiles();
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">scanEachPoll</span><span class="hljs-params">()</span> </span>{

    File anotherFileMock = mock();

    when(anotherFileMock.toPath()).thenReturn(Path.of(<span class="hljs-string">"[dir]/anotherFileMock"</span>));

    when(inputDirectoryMock.listFiles()).thenReturn(<span class="hljs-keyword">new</span> File[] { fileMock, anotherFileMock });

    source.setScanEachPoll(<span class="hljs-keyword">true</span>);

    assertThat(source.receive()).isNotNull();

    assertThat(source.receive()).isNotNull();

    assertThat(source.receive()).isNull();

    verify(inputDirectoryMock, times(<span class="hljs-number">3</span>)).listFiles();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> File <span class="hljs-title">createMockFile</span><span class="hljs-params">(Path toPathReturn)</span> </span>{
    File fileMock = mock();
    when(fileMock.toPath()).thenReturn(toPathReturn);
    <span class="hljs-keyword">return</span> fileMock;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest592">Test Case ID #spring-integration_Test_59_2</h4>
<h4 id="test-case-name-orderedreceptionfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfilefilereadingmessagesourcetestsjava">Test Case Name: <code>orderedReception</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\FileReadingMessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-file1">Mock Object Variable Name: <code>file1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void orderedReception() {
<span class="hljs-deletion">-    File file1 = mock();</span>
<span class="hljs-deletion">-    when(file1.toPath()).thenReturn(Path.of("[dir]/file1"));</span>
<span class="hljs-addition">+    File file1 = createMockFile(Path.of("[dir]/file1"));</span>
    File file2 = mock();
    when(file2.toPath()).thenReturn(Path.of("[dir]/file2"));
    File file3 = mock();
    when(file3.toPath()).thenReturn(Path.of("[dir]/file3"));
    // record the comparator to reverse order the files
    when(comparator.compare(file1, file2)).thenReturn(1);
    when(comparator.compare(file1, file3)).thenReturn(1);
    when(comparator.compare(file3, file2)).thenReturn(-1);
    when(inputDirectoryMock.listFiles()).thenReturn(new File[] { file2, file3, file1 });
    assertThat(source.receive().getPayload()).isSameAs(file3);
    assertThat(source.receive().getPayload()).isSameAs(file2);
    assertThat(source.receive().getPayload()).isSameAs(file1);
    assertThat(source.receive()).isNull();
    verify(inputDirectoryMock, times(2)).listFiles();
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">orderedReception</span><span class="hljs-params">()</span> </span>{

    File file1 = mock();

    when(file1.toPath()).thenReturn(Path.of(<span class="hljs-string">"[dir]/file1"</span>));

    File file2 = mock();

    when(file2.toPath()).thenReturn(Path.of(<span class="hljs-string">"[dir]/file2"</span>));

    File file3 = mock();

    when(file3.toPath()).thenReturn(Path.of(<span class="hljs-string">"[dir]/file3"</span>));

    <span class="hljs-comment">// record the comparator to reverse order the files</span>

    when(comparator.compare(file1, file2)).thenReturn(<span class="hljs-number">1</span>);

    when(comparator.compare(file1, file3)).thenReturn(<span class="hljs-number">1</span>);

    when(comparator.compare(file3, file2)).thenReturn(-<span class="hljs-number">1</span>);

    when(inputDirectoryMock.listFiles()).thenReturn(<span class="hljs-keyword">new</span> File[] { file2, file3, file1 });

    assertThat(source.receive().getPayload()).isSameAs(file3);

    assertThat(source.receive().getPayload()).isSameAs(file2);

    assertThat(source.receive().getPayload()).isSameAs(file1);

    assertThat(source.receive()).isNull();

    verify(inputDirectoryMock, times(<span class="hljs-number">2</span>)).listFiles();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> File <span class="hljs-title">createMockFile</span><span class="hljs-params">(Path toPathReturn)</span> </span>{
    File fileMock = mock();
    when(fileMock.toPath()).thenReturn(toPathReturn);
    <span class="hljs-keyword">return</span> fileMock;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest593">Test Case ID #spring-integration_Test_59_3</h4>
<h4 id="test-case-name-orderedreceptionfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfilefilereadingmessagesourcetestsjava">Test Case Name: <code>orderedReception</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\FileReadingMessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-file2">Mock Object Variable Name: <code>file2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    File file1 = mock();
    when(file1.toPath()).thenReturn(Path.of("[dir]/file1"));
<span class="hljs-deletion">-    File file2 = mock();</span>
<span class="hljs-deletion">-    when(file2.toPath()).thenReturn(Path.of("[dir]/file2"));</span>
<span class="hljs-addition">+    File file2 = createMockFile(Path.of("[dir]/file2"));</span>
    File file3 = mock();
    when(file3.toPath()).thenReturn(Path.of("[dir]/file3"));
    // record the comparator to reverse order the files
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">orderedReception</span><span class="hljs-params">()</span> </span>{

    File file1 = mock();

    when(file1.toPath()).thenReturn(Path.of(<span class="hljs-string">"[dir]/file1"</span>));

    File file2 = mock();

    when(file2.toPath()).thenReturn(Path.of(<span class="hljs-string">"[dir]/file2"</span>));

    File file3 = mock();

    when(file3.toPath()).thenReturn(Path.of(<span class="hljs-string">"[dir]/file3"</span>));

    <span class="hljs-comment">// record the comparator to reverse order the files</span>

    when(comparator.compare(file1, file2)).thenReturn(<span class="hljs-number">1</span>);

    when(comparator.compare(file1, file3)).thenReturn(<span class="hljs-number">1</span>);

    when(comparator.compare(file3, file2)).thenReturn(-<span class="hljs-number">1</span>);

    when(inputDirectoryMock.listFiles()).thenReturn(<span class="hljs-keyword">new</span> File[] { file2, file3, file1 });

    assertThat(source.receive().getPayload()).isSameAs(file3);

    assertThat(source.receive().getPayload()).isSameAs(file2);

    assertThat(source.receive().getPayload()).isSameAs(file1);

    assertThat(source.receive()).isNull();

    verify(inputDirectoryMock, times(<span class="hljs-number">2</span>)).listFiles();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> File <span class="hljs-title">createMockFile</span><span class="hljs-params">(Path toPathReturn)</span> </span>{
    File fileMock = mock();
    when(fileMock.toPath()).thenReturn(toPathReturn);
    <span class="hljs-keyword">return</span> fileMock;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest594">Test Case ID #spring-integration_Test_59_4</h4>
<h4 id="test-case-name-orderedreceptionfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfilefilereadingmessagesourcetestsjava">Test Case Name: <code>orderedReception</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\FileReadingMessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-file3">Mock Object Variable Name: <code>file3</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    File file2 = mock();
    when(file2.toPath()).thenReturn(Path.of("[dir]/file2"));
<span class="hljs-deletion">-    File file3 = mock();</span>
<span class="hljs-deletion">-    when(file3.toPath()).thenReturn(Path.of("[dir]/file3"));</span>
<span class="hljs-addition">+    File file3 = createMockFile(Path.of("[dir]/file3"));</span>
    // record the comparator to reverse order the files
    when(comparator.compare(file1, file2)).thenReturn(1);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">orderedReception</span><span class="hljs-params">()</span> </span>{

    File file1 = mock();

    when(file1.toPath()).thenReturn(Path.of(<span class="hljs-string">"[dir]/file1"</span>));

    File file2 = mock();

    when(file2.toPath()).thenReturn(Path.of(<span class="hljs-string">"[dir]/file2"</span>));

    File file3 = mock();

    when(file3.toPath()).thenReturn(Path.of(<span class="hljs-string">"[dir]/file3"</span>));

    <span class="hljs-comment">// record the comparator to reverse order the files</span>

    when(comparator.compare(file1, file2)).thenReturn(<span class="hljs-number">1</span>);

    when(comparator.compare(file1, file3)).thenReturn(<span class="hljs-number">1</span>);

    when(comparator.compare(file3, file2)).thenReturn(-<span class="hljs-number">1</span>);

    when(inputDirectoryMock.listFiles()).thenReturn(<span class="hljs-keyword">new</span> File[] { file2, file3, file1 });

    assertThat(source.receive().getPayload()).isSameAs(file3);

    assertThat(source.receive().getPayload()).isSameAs(file2);

    assertThat(source.receive().getPayload()).isSameAs(file1);

    assertThat(source.receive()).isNull();

    verify(inputDirectoryMock, times(<span class="hljs-number">2</span>)).listFiles();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> File <span class="hljs-title">createMockFile</span><span class="hljs-params">(Path toPathReturn)</span> </span>{
    File fileMock = mock();
    when(fileMock.toPath()).thenReturn(toPathReturn);
    <span class="hljs-keyword">return</span> fileMock;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci60">Mock Clone Instance #spring-integration_MCI_60</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.context.SmartLifecycle</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SmartLifecycle <span class="hljs-title">createMockSmartLifecycle</span><span class="hljs-params">(<span class="hljs-keyword">int</span> phase)</span> </span>{
    SmartLifecycle mock = mock(SmartLifecycle<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(mock.getPhase()).thenReturn(phase);
    <span class="hljs-keyword">return</span> mock;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest601">Test Case ID #spring-integration_Test_60_1</h4>
<h4 id="test-case-name-testorderfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationsupportsmartlifecyclerolecontrollertestsjava">Test Case Name: <code>testOrder</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\support\SmartLifecycleRoleControllerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-lc1">Mock Object Variable Name: <code>lc1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testOrder() {
<span class="hljs-deletion">-    SmartLifecycle lc1 = mock(SmartLifecycle.class);</span>
<span class="hljs-deletion">-    when(lc1.getPhase()).thenReturn(2);</span>
<span class="hljs-addition">+    SmartLifecycle lc1 = createMockSmartLifecycle(2);</span>
     SmartLifecycle lc2 = mock(SmartLifecycle.class);
     when(lc2.getPhase()).thenReturn(1);
     MultiValueMap&lt;String, SmartLifecycle&gt; map = new LinkedMultiValueMap&lt;&gt;();
     map.add("foo", lc1);
     map.add("foo", lc2);
     SmartLifecycleRoleController controller = new SmartLifecycleRoleController(map);
     controller.startLifecyclesInRole("foo");
     controller.stopLifecyclesInRole("foo");
     InOrder inOrder = inOrder(lc1, lc2);
     inOrder.verify(lc2).start();
     inOrder.verify(lc1).start();
     inOrder.verify(lc1).stop();
     inOrder.verify(lc2).stop();
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testOrder</span><span class="hljs-params">()</span> </span>{

    SmartLifecycle lc1 = mock(SmartLifecycle<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(lc1.getPhase()).thenReturn(<span class="hljs-number">2</span>);

    SmartLifecycle lc2 = mock(SmartLifecycle<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(lc2.getPhase()).thenReturn(<span class="hljs-number">1</span>);

    MultiValueMap&lt;String, SmartLifecycle&gt; map = <span class="hljs-keyword">new</span> LinkedMultiValueMap&lt;&gt;();

    map.add(<span class="hljs-string">"foo"</span>, lc1);

    map.add(<span class="hljs-string">"foo"</span>, lc2);

    SmartLifecycleRoleController controller = <span class="hljs-keyword">new</span> SmartLifecycleRoleController(map);

    controller.startLifecyclesInRole(<span class="hljs-string">"foo"</span>);

    controller.stopLifecyclesInRole(<span class="hljs-string">"foo"</span>);

    InOrder inOrder = inOrder(lc1, lc2);

    inOrder.verify(lc2).start();

    inOrder.verify(lc1).start();

    inOrder.verify(lc1).stop();

    inOrder.verify(lc2).stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SmartLifecycle <span class="hljs-title">createMockSmartLifecycle</span><span class="hljs-params">(<span class="hljs-keyword">int</span> phase)</span> </span>{
    SmartLifecycle mock = mock(SmartLifecycle<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(mock.getPhase()).thenReturn(phase);
    <span class="hljs-keyword">return</span> mock;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest602">Test Case ID #spring-integration_Test_60_2</h4>
<h4 id="test-case-name-testorderfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationsupportsmartlifecyclerolecontrollertestsjava">Test Case Name: <code>testOrder</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\support\SmartLifecycleRoleControllerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-lc2">Mock Object Variable Name: <code>lc2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SmartLifecycle lc1 = mock(SmartLifecycle.class);
    when(lc1.getPhase()).thenReturn(2);
<span class="hljs-deletion">-    SmartLifecycle lc2 = mock(SmartLifecycle.class);</span>
<span class="hljs-deletion">-    when(lc2.getPhase()).thenReturn(1);</span>
<span class="hljs-addition">+    SmartLifecycle lc2 = createMockSmartLifecycle(1);</span>
    MultiValueMap&lt;String, SmartLifecycle&gt; map = new LinkedMultiValueMap&lt;&gt;();
    map.add("foo", lc1);
    map.add("foo", lc2);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testOrder</span><span class="hljs-params">()</span> </span>{

    SmartLifecycle lc1 = mock(SmartLifecycle<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(lc1.getPhase()).thenReturn(<span class="hljs-number">2</span>);

    SmartLifecycle lc2 = mock(SmartLifecycle<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(lc2.getPhase()).thenReturn(<span class="hljs-number">1</span>);

    MultiValueMap&lt;String, SmartLifecycle&gt; map = <span class="hljs-keyword">new</span> LinkedMultiValueMap&lt;&gt;();

    map.add(<span class="hljs-string">"foo"</span>, lc1);

    map.add(<span class="hljs-string">"foo"</span>, lc2);

    SmartLifecycleRoleController controller = <span class="hljs-keyword">new</span> SmartLifecycleRoleController(map);

    controller.startLifecyclesInRole(<span class="hljs-string">"foo"</span>);

    controller.stopLifecyclesInRole(<span class="hljs-string">"foo"</span>);

    InOrder inOrder = inOrder(lc1, lc2);

    inOrder.verify(lc2).start();

    inOrder.verify(lc1).start();

    inOrder.verify(lc1).stop();

    inOrder.verify(lc2).stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SmartLifecycle <span class="hljs-title">createMockSmartLifecycle</span><span class="hljs-params">(<span class="hljs-keyword">int</span> phase)</span> </span>{
    SmartLifecycle mock = mock(SmartLifecycle<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(mock.getPhase()).thenReturn(phase);
    <span class="hljs-keyword">return</span> mock;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci61">Mock Clone Instance #spring-integration_MCI_61</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.file.remote.session.Session&lt;java.lang.String&gt;</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session&lt;String&gt; <span class="hljs-title">createMockSessionWithReadRaw</span><span class="hljs-params">()</span> </span>{
    Session&lt;String&gt; session = mock();
    when(session.readRaw(anyString())).thenReturn(mock());
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest611">Test Case ID #spring-integration_Test_61_1</h4>
<h4 id="test-case-name-fetchfilesfromremoteafterclearingfetchedcachefile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremoteremotefilestreamingmessagesourcetestsjava">Test Case Name: <code>fetchFilesFromRemoteAfterClearingFetchedCache</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\RemoteFileStreamingMessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    RemoteFileTemplate&lt;String&gt; remoteFileTemplate = mock();
    when(remoteFileTemplate.list("remoteDirectory")).thenReturn(new String[] { "file1", "file2" });
<span class="hljs-deletion">-    Session&lt;String&gt; session = mock();</span>
<span class="hljs-deletion">-    when(session.readRaw(anyString())).thenReturn(mock());</span>
<span class="hljs-addition">+    Session&lt;String&gt; session = createMockSessionWithReadRaw();</span>
    when(remoteFileTemplate.getSession()).thenReturn(session);
    Comparator&lt;String&gt; comparator = mock();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">fetchFilesFromRemoteAfterClearingFetchedCache</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{

    RemoteFileTemplate&lt;String&gt; remoteFileTemplate = mock();

    when(remoteFileTemplate.list(<span class="hljs-string">"remoteDirectory"</span>)).thenReturn(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"file1"</span>, <span class="hljs-string">"file2"</span> });

    Session&lt;String&gt; session = mock();

    when(session.readRaw(anyString())).thenReturn(mock());

    when(remoteFileTemplate.getSession()).thenReturn(session);

    Comparator&lt;String&gt; comparator = mock();

    TestRemoteFileStreamingMessageSource testRemoteFileStreamingMessageSource = <span class="hljs-keyword">new</span> TestRemoteFileStreamingMessageSource(remoteFileTemplate, comparator);

    testRemoteFileStreamingMessageSource.setRemoteDirectory(<span class="hljs-string">"remoteDirectory"</span>);

    testRemoteFileStreamingMessageSource.setBeanFactory(mock());

    testRemoteFileStreamingMessageSource.start();

    assertThat(testRemoteFileStreamingMessageSource.doReceive(<span class="hljs-number">2</span>)).isNotNull();

    testRemoteFileStreamingMessageSource.clearFetchedCache();

    assertThat(testRemoteFileStreamingMessageSource.doReceive(<span class="hljs-number">2</span>)).isNotNull();

    verify(remoteFileTemplate, times(<span class="hljs-number">2</span>)).list(<span class="hljs-string">"remoteDirectory"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session&lt;String&gt; <span class="hljs-title">createMockSessionWithReadRaw</span><span class="hljs-params">()</span> </span>{
    Session&lt;String&gt; session = mock();
    when(session.readRaw(anyString())).thenReturn(mock());
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest612">Test Case ID #spring-integration_Test_61_2</h4>
<h4 id="test-case-name-filteroutfilesnotacceptedbyfilterfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremoteremotefilestreamingmessagesourcetestsjava">Test Case Name: <code>filterOutFilesNotAcceptedByFilter</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\RemoteFileStreamingMessageSourceTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    RemoteFileTemplate&lt;String&gt; remoteFileTemplate = mock();
    when(remoteFileTemplate.list("remoteDirectory")).thenReturn(new String[] { "file1", "file2" });
<span class="hljs-deletion">-    Session&lt;String&gt; session = mock();</span>
<span class="hljs-deletion">-    when(session.readRaw(anyString())).thenReturn(mock());</span>
<span class="hljs-addition">+    Session&lt;String&gt; session = createMockSessionWithReadRaw();</span>
    when(remoteFileTemplate.getSession()).thenReturn(session);
    FileListFilter&lt;String&gt; fileListFilter = mock();
    when(fileListFilter.supportsSingleFileFiltering()).thenReturn(true);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">filterOutFilesNotAcceptedByFilter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{

    RemoteFileTemplate&lt;String&gt; remoteFileTemplate = mock();

    when(remoteFileTemplate.list(<span class="hljs-string">"remoteDirectory"</span>)).thenReturn(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"file1"</span>, <span class="hljs-string">"file2"</span> });

    Session&lt;String&gt; session = mock();

    when(session.readRaw(anyString())).thenReturn(mock());

    when(remoteFileTemplate.getSession()).thenReturn(session);

    FileListFilter&lt;String&gt; fileListFilter = mock();

    when(fileListFilter.supportsSingleFileFiltering()).thenReturn(<span class="hljs-keyword">true</span>);

    when(fileListFilter.accept(<span class="hljs-string">"file1"</span>)).thenReturn(<span class="hljs-keyword">false</span>);

    when(fileListFilter.accept(<span class="hljs-string">"file2"</span>)).thenReturn(<span class="hljs-keyword">false</span>);

    Comparator&lt;String&gt; comparator = mock();

    TestRemoteFileStreamingMessageSource testRemoteFileStreamingMessageSource = <span class="hljs-keyword">new</span> TestRemoteFileStreamingMessageSource(remoteFileTemplate, comparator);

    testRemoteFileStreamingMessageSource.setFilter(fileListFilter);

    testRemoteFileStreamingMessageSource.setRemoteDirectory(<span class="hljs-string">"remoteDirectory"</span>);

    testRemoteFileStreamingMessageSource.setBeanFactory(mock());

    testRemoteFileStreamingMessageSource.start();

    assertThat(testRemoteFileStreamingMessageSource.doReceive(-<span class="hljs-number">1</span>)).isNull();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session&lt;String&gt; <span class="hljs-title">createMockSessionWithReadRaw</span><span class="hljs-params">()</span> </span>{
    Session&lt;String&gt; session = mock();
    when(session.readRaw(anyString())).thenReturn(mock());
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci62">Mock Clone Instance #spring-integration_MCI_62</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.eclipse.angus.mail.imap.IMAPFolder</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> IMAPFolder <span class="hljs-title">createMockImapFolder</span><span class="hljs-params">(Flags permanentFlags, <span class="hljs-keyword">boolean</span> existsReturn, <span class="hljs-keyword">boolean</span> isOpenFirstReturn, <span class="hljs-keyword">boolean</span> isOpenSecondReturn)</span> </span>{
    IMAPFolder folder = mock(IMAPFolder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(folder.getPermanentFlags()).willReturn(permanentFlags);
    given(folder.exists()).willReturn(existsReturn);
    given(folder.isOpen()).willReturn(isOpenFirstReturn).willReturn(isOpenSecondReturn);
    <span class="hljs-keyword">return</span> folder;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest621">Test Case ID #spring-integration_Test_62_1</h4>
<h4 id="test-case-name-testnoinitialidledelaywhenrecentnotsupportedfile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailimapmailreceivertestsjava">Test Case Name: <code>testNoInitialIdleDelayWhenRecentNotSupported</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\ImapMailReceiverTests.java</code>)</h4>
<h4 id="mock-object-variable-name-folder">Mock Object Variable Name: <code>folder</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ThreadPoolTaskScheduler taskScheduler = new ThreadPoolTaskScheduler();
    setUpScheduler(receiver, taskScheduler);
<span class="hljs-deletion">-    final IMAPFolder folder = mock(IMAPFolder.class);</span>
<span class="hljs-deletion">-    given(folder.getPermanentFlags()).willReturn(new Flags(Flags.Flag.USER));</span>
<span class="hljs-deletion">-    given(folder.isOpen()).willReturn(false).willReturn(true);</span>
<span class="hljs-deletion">-    given(folder.exists()).willReturn(true);</span>
<span class="hljs-addition">+    final IMAPFolder folder = createMockImapFolder(new Flags(Flags.Flag.USER), true, false, true);</span>
    Field storeField = AbstractMailReceiver.class.getDeclaredField("store");
    storeField.setAccessible(true);
    Store store = mock(Store.class);
@@
    willAnswer(invocation -&gt; {
        /*
 			 * Return the message from first invocation of waitForMessages()
 			 * and in receive(); then return false in the next call to
 			 * waitForMessages() so we enter idle(); counter will be reset
 			 * to 1 in the mocked idle().
 			 */
        if (shouldFindMessagesCounter.decrementAndGet() &gt;= 0) {
            return messages;
        } else {
            return new Message[0];
        }
    }).given(folder).search(any(SearchTerm.class));
    willAnswer(invocation -&gt; {
        Thread.sleep(300);
        shouldFindMessagesCounter.set(1);
        return null;
    }).given(folder).idle(true);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"resource"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNoInitialIdleDelayWhenRecentNotSupported</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    ImapIdleChannelAdapter adapter = <span class="hljs-keyword">this</span>.context.getBean(<span class="hljs-string">"simpleAdapter"</span>, ImapIdleChannelAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    QueueChannel channel = <span class="hljs-keyword">new</span> QueueChannel();

    adapter.setOutputChannel(channel);

    adapter.setReconnectDelay(<span class="hljs-number">10</span>);

    ImapMailReceiver receiver = <span class="hljs-keyword">new</span> ImapMailReceiver(<span class="hljs-string">"imap:foo"</span>);

    ThreadPoolTaskScheduler taskScheduler = <span class="hljs-keyword">new</span> ThreadPoolTaskScheduler();

    setUpScheduler(receiver, taskScheduler);

    <span class="hljs-keyword">final</span> IMAPFolder folder = mock(IMAPFolder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(folder.getPermanentFlags()).willReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));

    given(folder.isOpen()).willReturn(<span class="hljs-keyword">false</span>).willReturn(<span class="hljs-keyword">true</span>);

    given(folder.exists()).willReturn(<span class="hljs-keyword">true</span>);

    Field storeField = AbstractMailReceiver<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredField</span>("<span class="hljs-title">store</span>")</span>;

    storeField.setAccessible(<span class="hljs-keyword">true</span>);

    Store store = mock(Store<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(store.isConnected()).willReturn(<span class="hljs-keyword">true</span>);

    given(store.getFolder(Mockito.any(URLName<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">folder</span>)</span>;

    storeField.set(receiver, store);

    receiver.afterPropertiesSet();

    DirectFieldAccessor adapterAccessor = <span class="hljs-keyword">new</span> DirectFieldAccessor(adapter);

    adapterAccessor.setPropertyValue(<span class="hljs-string">"mailReceiver"</span>, receiver);

    Message mailMessage = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test1"</span>);

    <span class="hljs-keyword">final</span> Message[] messages = <span class="hljs-keyword">new</span> Message[] { mailMessage };

    <span class="hljs-keyword">final</span> AtomicInteger shouldFindMessagesCounter = <span class="hljs-keyword">new</span> AtomicInteger(<span class="hljs-number">2</span>);

    willAnswer(invocation -&gt; {

        <span class="hljs-comment">/*

			 * Return the message from first invocation of waitForMessages()

			 * and in receive(); then return false in the next call to

			 * waitForMessages() so we enter idle(); counter will be reset

			 * to 1 in the mocked idle().

			 */</span>

        <span class="hljs-keyword">if</span> (shouldFindMessagesCounter.decrementAndGet() &gt;= <span class="hljs-number">0</span>) {

            <span class="hljs-keyword">return</span> messages;

        } <span class="hljs-keyword">else</span> {

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Message[<span class="hljs-number">0</span>];

        }

    }).given(folder).search(any(SearchTerm<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    willAnswer(invocation -&gt; {

        Thread.sleep(<span class="hljs-number">300</span>);

        shouldFindMessagesCounter.set(<span class="hljs-number">1</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(folder).idle(<span class="hljs-keyword">true</span>);

    adapter.start();

    <span class="hljs-comment">/*

		 * Idle takes 5 seconds; if all is well, we should receive the first message

		 * before then.

		 */</span>

    assertThat(channel.receive(<span class="hljs-number">20000</span>)).isNotNull();

    <span class="hljs-comment">// We should not receive any more until the next idle elapses</span>

    assertThat(channel.receive(<span class="hljs-number">100</span>)).isNull();

    assertThat(channel.receive(<span class="hljs-number">10000</span>)).isNotNull();

    adapter.stop();

    taskScheduler.shutdown();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> IMAPFolder <span class="hljs-title">createMockImapFolder</span><span class="hljs-params">(Flags permanentFlags, <span class="hljs-keyword">boolean</span> existsReturn, <span class="hljs-keyword">boolean</span> isOpenFirstReturn, <span class="hljs-keyword">boolean</span> isOpenSecondReturn)</span> </span>{
    IMAPFolder folder = mock(IMAPFolder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(folder.getPermanentFlags()).willReturn(permanentFlags);
    given(folder.exists()).willReturn(existsReturn);
    given(folder.isOpen()).willReturn(isOpenFirstReturn).willReturn(isOpenSecondReturn);
    <span class="hljs-keyword">return</span> folder;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest622">Test Case ID #spring-integration_Test_62_2</h4>
<h4 id="test-case-name-testinitialidledelaywhenrecentissupportedfile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailimapmailreceivertestsjava">Test Case Name: <code>testInitialIdleDelayWhenRecentIsSupported</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\ImapMailReceiverTests.java</code>)</h4>
<h4 id="mock-object-variable-name-folder">Mock Object Variable Name: <code>folder</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ThreadPoolTaskScheduler taskScheduler = new ThreadPoolTaskScheduler();
    setUpScheduler(receiver, taskScheduler);
<span class="hljs-deletion">-    IMAPFolder folder = mock(IMAPFolder.class);</span>
<span class="hljs-deletion">-    given(folder.getPermanentFlags()).willReturn(new Flags(Flags.Flag.RECENT));</span>
<span class="hljs-deletion">-    given(folder.isOpen()).willReturn(false).willReturn(true);</span>
<span class="hljs-deletion">-    given(folder.exists()).willReturn(true);</span>
<span class="hljs-addition">+    IMAPFolder folder = createMockImapFolder(new Flags(Flags.Flag.RECENT), true, false, true);</span>
    Field storeField = AbstractMailReceiver.class.getDeclaredField("store");
    storeField.setAccessible(true);
    Store store = mock(Store.class);
@@
    Message[] messages = new Message[] { mailMessage };
    willAnswer(invocation -&gt; messages).given(folder).search(any(SearchTerm.class));
    CountDownLatch idles = new CountDownLatch(2);
    willAnswer(invocation -&gt; {
        idles.countDown();
        Thread.sleep(500);
        return null;
    }).given(folder).idle(true);
    adapter.start();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInitialIdleDelayWhenRecentIsSupported</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    ImapIdleChannelAdapter adapter = <span class="hljs-keyword">this</span>.context.getBean(<span class="hljs-string">"simpleAdapter"</span>, ImapIdleChannelAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    QueueChannel channel = <span class="hljs-keyword">new</span> QueueChannel();

    adapter.setOutputChannel(channel);

    adapter.setReconnectDelay(<span class="hljs-number">100</span>);

    adapter.afterPropertiesSet();

    ImapMailReceiver receiver = <span class="hljs-keyword">new</span> ImapMailReceiver(<span class="hljs-string">"imap:foo"</span>);

    receiver.setCancelIdleInterval(<span class="hljs-number">10</span>);

    ThreadPoolTaskScheduler taskScheduler = <span class="hljs-keyword">new</span> ThreadPoolTaskScheduler();

    setUpScheduler(receiver, taskScheduler);

    IMAPFolder folder = mock(IMAPFolder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(folder.getPermanentFlags()).willReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.RECENT));

    given(folder.isOpen()).willReturn(<span class="hljs-keyword">false</span>).willReturn(<span class="hljs-keyword">true</span>);

    given(folder.exists()).willReturn(<span class="hljs-keyword">true</span>);

    Field storeField = AbstractMailReceiver<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredField</span>("<span class="hljs-title">store</span>")</span>;

    storeField.setAccessible(<span class="hljs-keyword">true</span>);

    Store store = mock(Store<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(store.isConnected()).willReturn(<span class="hljs-keyword">true</span>);

    given(store.getFolder(Mockito.any(URLName<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">folder</span>)</span>;

    storeField.set(receiver, store);

    receiver.afterPropertiesSet();

    DirectFieldAccessor adapterAccessor = <span class="hljs-keyword">new</span> DirectFieldAccessor(adapter);

    adapterAccessor.setPropertyValue(<span class="hljs-string">"mailReceiver"</span>, receiver);

    Message mailMessage = GreenMailUtil.newMimeMessage(<span class="hljs-string">"test1"</span>);

    Message[] messages = <span class="hljs-keyword">new</span> Message[] { mailMessage };

    willAnswer(invocation -&gt; messages).given(folder).search(any(SearchTerm<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    CountDownLatch idles = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">2</span>);

    willAnswer(invocation -&gt; {

        idles.countDown();

        Thread.sleep(<span class="hljs-number">500</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).given(folder).idle(<span class="hljs-keyword">true</span>);

    adapter.start();

    <span class="hljs-comment">/*

		 * Idle takes 5 seconds; since this server supports RECENT, we should

		 * not receive any early messages.

		 */</span>

    assertThat(channel.receive(<span class="hljs-number">100</span>)).isNull();

    assertThat(channel.receive(<span class="hljs-number">20000</span>)).isNotNull();

    assertThat(idles.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    adapter.stop();

    taskScheduler.shutdown();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> IMAPFolder <span class="hljs-title">createMockImapFolder</span><span class="hljs-params">(Flags permanentFlags, <span class="hljs-keyword">boolean</span> existsReturn, <span class="hljs-keyword">boolean</span> isOpenFirstReturn, <span class="hljs-keyword">boolean</span> isOpenSecondReturn)</span> </span>{
    IMAPFolder folder = mock(IMAPFolder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(folder.getPermanentFlags()).willReturn(permanentFlags);
    given(folder.exists()).willReturn(existsReturn);
    given(folder.isOpen()).willReturn(isOpenFirstReturn).willReturn(isOpenSecondReturn);
    <span class="hljs-keyword">return</span> folder;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest623">Test Case ID #spring-integration_Test_62_3</h4>
<h4 id="test-case-name-testidlereconnectsfile-cjavaprojectsspringspring-integrationspring-integration-mailsrctestjavaorgspringframeworkintegrationmailimapmailreceivertestsjava">Test Case Name: <code>testIdleReconnects</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-mail\src\test\java\org\springframework\integration\mail\ImapMailReceiverTests.java</code>)</h4>
<h4 id="mock-object-variable-name-folder">Mock Object Variable Name: <code>folder</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    receiver.afterPropertiesSet();
<span class="hljs-deletion">-    IMAPFolder folder = mock(IMAPFolder.class);</span>
<span class="hljs-deletion">-    given(folder.getPermanentFlags()).willReturn(new Flags(Flags.Flag.USER));</span>
<span class="hljs-deletion">-    given(folder.isOpen()).willReturn(false).willReturn(true);</span>
<span class="hljs-deletion">-    given(folder.exists()).willReturn(true);</span>
<span class="hljs-deletion">-    given(folder.hasNewMessages()).willReturn(true);</span>
<span class="hljs-addition">+    IMAPFolder folder = createMockImapFolder(new Flags(Flags.Flag.USER), true, false, true);</span>
<span class="hljs-addition">+    given(folder.hasNewMessages()).willReturn(true);</span>
    Field storeField = AbstractMailReceiver.class.getDeclaredField("store");
    storeField.setAccessible(true);
    Store store = mock(Store.class);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testIdleReconnects</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    ImapMailReceiver receiver = spy(<span class="hljs-keyword">new</span> ImapMailReceiver(<span class="hljs-string">"imap:foo"</span>));

    receiver.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    receiver.afterPropertiesSet();

    IMAPFolder folder = mock(IMAPFolder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(folder.getPermanentFlags()).willReturn(<span class="hljs-keyword">new</span> Flags(Flags.Flag.USER));

    given(folder.isOpen()).willReturn(<span class="hljs-keyword">false</span>).willReturn(<span class="hljs-keyword">true</span>);

    given(folder.exists()).willReturn(<span class="hljs-keyword">true</span>);

    given(folder.hasNewMessages()).willReturn(<span class="hljs-keyword">true</span>);

    Field storeField = AbstractMailReceiver<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getDeclaredField</span>("<span class="hljs-title">store</span>")</span>;

    storeField.setAccessible(<span class="hljs-keyword">true</span>);

    Store store = mock(Store<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(store.isConnected()).willReturn(<span class="hljs-keyword">false</span>);

    given(store.getFolder(Mockito.any(URLName<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">folder</span>)</span>;

    storeField.set(receiver, store);

    ImapIdleChannelAdapter adapter = <span class="hljs-keyword">new</span> ImapIdleChannelAdapter(receiver);

    LogAccessor logger = spy(TestUtils.getPropertyValue(adapter, <span class="hljs-string">"logger"</span>, LogAccessor<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">new</span> DirectFieldAccessor(adapter).setPropertyValue(<span class="hljs-string">"logger"</span>, logger);

    willDoNothing().given(logger).warn(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;

    willAnswer(i -&gt; {

        i.callRealMethod();

        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> FolderClosedException(folder, <span class="hljs-string">"test"</span>);

    }).given(receiver).waitForNewMessages();

    adapter.setReconnectDelay(<span class="hljs-number">10</span>);

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">3</span>);

    adapter.setApplicationEventPublisher(e -&gt; latch.countDown());

    adapter.afterPropertiesSet();

    adapter.start();

    assertThat(latch.await(<span class="hljs-number">60</span>, TimeUnit.SECONDS)).isTrue();

    verify(store, atLeast(<span class="hljs-number">3</span>)).connect();

    adapter.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> IMAPFolder <span class="hljs-title">createMockImapFolder</span><span class="hljs-params">(Flags permanentFlags, <span class="hljs-keyword">boolean</span> existsReturn, <span class="hljs-keyword">boolean</span> isOpenFirstReturn, <span class="hljs-keyword">boolean</span> isOpenSecondReturn)</span> </span>{
    IMAPFolder folder = mock(IMAPFolder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(folder.getPermanentFlags()).willReturn(permanentFlags);
    given(folder.exists()).willReturn(existsReturn);
    given(folder.isOpen()).willReturn(isOpenFirstReturn).willReturn(isOpenSecondReturn);
    <span class="hljs-keyword">return</span> folder;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci63">Mock Clone Instance #spring-integration_MCI_63</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>java.util.concurrent.locks.Lock</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Lock <span class="hljs-title">createMockLock</span><span class="hljs-params">(java.util.function.Supplier&lt;Boolean&gt; tryLockSupplier)</span> </span>{
    Lock lock = mock(Lock<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(lock.tryLock(anyLong(), any(TimeUnit<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willAnswer</span>(<span class="hljs-title">i</span> -&gt; <span class="hljs-title">tryLockSupplier</span>.<span class="hljs-title">get</span>())</span>;
    <span class="hljs-keyword">return</span> lock;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest631">Test Case ID #spring-integration_Test_63_1</h4>
<h4 id="test-case-name-competingwithlockfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationsupportleaderlockregistryleaderinitiatortestsjava">Test Case Name: <code>competingWithLock</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\support\leader\LockRegistryLeaderInitiatorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-firstlock">Mock Object Variable Name: <code>firstLock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    // set up first registry instance - this one will be able to obtain lock initially
    LockRegistry firstRegistry = mock(LockRegistry.class);
<span class="hljs-deletion">-    Lock firstLock = mock(Lock.class);</span>
<span class="hljs-deletion">-    given(firstRegistry.obtain(anyString())).willReturn(firstLock);</span>
<span class="hljs-deletion">-    given(firstLock.tryLock(anyLong(), any(TimeUnit.class))).willAnswer(i -&gt; firstLocked.get());</span>
<span class="hljs-addition">+    Lock firstLock = createMockLock(() -&gt; firstLocked.get());</span>
<span class="hljs-addition">+    given(firstRegistry.obtain(anyString())).willReturn(firstLock);</span>
    // set up first initiator instance using first LockRegistry
    LockRegistryLeaderInitiator first = new LockRegistryLeaderInitiator(firstRegistry, new DefaultCandidate());
    CountDownLatch firstGranted = new CountDownLatch(1);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">competingWithLock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-comment">// switch used to toggle which registry obtains lock</span>

    AtomicBoolean firstLocked = <span class="hljs-keyword">new</span> AtomicBoolean(<span class="hljs-keyword">true</span>);

    <span class="hljs-comment">// set up first registry instance - this one will be able to obtain lock initially</span>

    LockRegistry firstRegistry = mock(LockRegistry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Lock firstLock = mock(Lock<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(firstRegistry.obtain(anyString())).willReturn(firstLock);

    given(firstLock.tryLock(anyLong(), any(TimeUnit<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willAnswer</span>(<span class="hljs-title">i</span> -&gt; <span class="hljs-title">firstLocked</span>.<span class="hljs-title">get</span>())</span>;

    <span class="hljs-comment">// set up first initiator instance using first LockRegistry</span>

    LockRegistryLeaderInitiator first = <span class="hljs-keyword">new</span> LockRegistryLeaderInitiator(firstRegistry, <span class="hljs-keyword">new</span> DefaultCandidate());

    CountDownLatch firstGranted = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    CountDownLatch firstRevoked = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    CountDownLatch firstAquireLockFailed = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    first.setHeartBeatMillis(<span class="hljs-number">10</span>);

    first.setBusyWaitMillis(<span class="hljs-number">1</span>);

    first.setLeaderEventPublisher(<span class="hljs-keyword">new</span> CountingPublisher(firstGranted, firstRevoked, firstAquireLockFailed));

    <span class="hljs-comment">// set up second registry instance - this one will NOT be able to obtain lock initially</span>

    LockRegistry secondRegistry = mock(LockRegistry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Lock secondLock = mock(Lock<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(secondRegistry.obtain(anyString())).willReturn(secondLock);

    given(secondLock.tryLock(anyLong(), any(TimeUnit<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willAnswer</span>(<span class="hljs-title">i</span> -&gt; !<span class="hljs-title">firstLocked</span>.<span class="hljs-title">get</span>())</span>;

    <span class="hljs-comment">// set up second initiator instance using second LockRegistry</span>

    LockRegistryLeaderInitiator second = <span class="hljs-keyword">new</span> LockRegistryLeaderInitiator(secondRegistry, <span class="hljs-keyword">new</span> DefaultCandidate());

    CountDownLatch secondGranted = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    CountDownLatch secondRevoked = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    CountDownLatch secondAquireLockFailed = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    second.setHeartBeatMillis(<span class="hljs-number">10</span>);

    second.setBusyWaitMillis(<span class="hljs-number">1</span>);

    second.setLeaderEventPublisher(<span class="hljs-keyword">new</span> CountingPublisher(secondGranted, secondRevoked, secondAquireLockFailed));

    <span class="hljs-comment">// start initiators</span>

    first.start();

    second.start();

    <span class="hljs-comment">// first initiator should lead and publish granted event</span>

    assertThat(firstGranted.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    assertThat(first.getContext().isLeader()).isTrue();

    assertThat(second.getContext().isLeader()).isFalse();

    <span class="hljs-comment">// simulate first registry instance unable to obtain lock, for example due to lock timeout</span>

    firstLocked.set(<span class="hljs-keyword">false</span>);

    <span class="hljs-comment">// second initiator should take lead and publish granted event, first initiator should publish revoked event</span>

    assertThat(secondGranted.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    assertThat(firstRevoked.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    assertThat(second.getContext().isLeader()).isTrue();

    assertThat(first.getContext().isLeader()).isFalse();

    first.stop();

    second.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Lock <span class="hljs-title">createMockLock</span><span class="hljs-params">(java.util.function.Supplier&lt;Boolean&gt; tryLockSupplier)</span> </span>{
    Lock lock = mock(Lock<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(lock.tryLock(anyLong(), any(TimeUnit<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willAnswer</span>(<span class="hljs-title">i</span> -&gt; <span class="hljs-title">tryLockSupplier</span>.<span class="hljs-title">get</span>())</span>;
    <span class="hljs-keyword">return</span> lock;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest632">Test Case ID #spring-integration_Test_63_2</h4>
<h4 id="test-case-name-competingwithlockfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationsupportleaderlockregistryleaderinitiatortestsjava">Test Case Name: <code>competingWithLock</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\support\leader\LockRegistryLeaderInitiatorTests.java</code>)</h4>
<h4 id="mock-object-variable-name-secondlock">Mock Object Variable Name: <code>secondLock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    LockRegistry secondRegistry = mock(LockRegistry.class);
<span class="hljs-deletion">-    Lock secondLock = mock(Lock.class);</span>
<span class="hljs-deletion">-    given(secondRegistry.obtain(anyString())).willReturn(secondLock);</span>
<span class="hljs-deletion">-    given(secondLock.tryLock(anyLong(), any(TimeUnit.class))).willAnswer(i -&gt; !firstLocked.get());</span>
<span class="hljs-addition">+    Lock secondLock = createMockLock(() -&gt; !firstLocked.get());</span>
<span class="hljs-addition">+    given(secondRegistry.obtain(anyString())).willReturn(secondLock);</span>
    // set up second initiator instance using second LockRegistry
    LockRegistryLeaderInitiator second = new LockRegistryLeaderInitiator(secondRegistry, new DefaultCandidate());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">competingWithLock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-comment">// switch used to toggle which registry obtains lock</span>

    AtomicBoolean firstLocked = <span class="hljs-keyword">new</span> AtomicBoolean(<span class="hljs-keyword">true</span>);

    <span class="hljs-comment">// set up first registry instance - this one will be able to obtain lock initially</span>

    LockRegistry firstRegistry = mock(LockRegistry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Lock firstLock = mock(Lock<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(firstRegistry.obtain(anyString())).willReturn(firstLock);

    given(firstLock.tryLock(anyLong(), any(TimeUnit<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willAnswer</span>(<span class="hljs-title">i</span> -&gt; <span class="hljs-title">firstLocked</span>.<span class="hljs-title">get</span>())</span>;

    <span class="hljs-comment">// set up first initiator instance using first LockRegistry</span>

    LockRegistryLeaderInitiator first = <span class="hljs-keyword">new</span> LockRegistryLeaderInitiator(firstRegistry, <span class="hljs-keyword">new</span> DefaultCandidate());

    CountDownLatch firstGranted = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    CountDownLatch firstRevoked = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    CountDownLatch firstAquireLockFailed = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    first.setHeartBeatMillis(<span class="hljs-number">10</span>);

    first.setBusyWaitMillis(<span class="hljs-number">1</span>);

    first.setLeaderEventPublisher(<span class="hljs-keyword">new</span> CountingPublisher(firstGranted, firstRevoked, firstAquireLockFailed));

    <span class="hljs-comment">// set up second registry instance - this one will NOT be able to obtain lock initially</span>

    LockRegistry secondRegistry = mock(LockRegistry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Lock secondLock = mock(Lock<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(secondRegistry.obtain(anyString())).willReturn(secondLock);

    given(secondLock.tryLock(anyLong(), any(TimeUnit<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willAnswer</span>(<span class="hljs-title">i</span> -&gt; !<span class="hljs-title">firstLocked</span>.<span class="hljs-title">get</span>())</span>;

    <span class="hljs-comment">// set up second initiator instance using second LockRegistry</span>

    LockRegistryLeaderInitiator second = <span class="hljs-keyword">new</span> LockRegistryLeaderInitiator(secondRegistry, <span class="hljs-keyword">new</span> DefaultCandidate());

    CountDownLatch secondGranted = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    CountDownLatch secondRevoked = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    CountDownLatch secondAquireLockFailed = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    second.setHeartBeatMillis(<span class="hljs-number">10</span>);

    second.setBusyWaitMillis(<span class="hljs-number">1</span>);

    second.setLeaderEventPublisher(<span class="hljs-keyword">new</span> CountingPublisher(secondGranted, secondRevoked, secondAquireLockFailed));

    <span class="hljs-comment">// start initiators</span>

    first.start();

    second.start();

    <span class="hljs-comment">// first initiator should lead and publish granted event</span>

    assertThat(firstGranted.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    assertThat(first.getContext().isLeader()).isTrue();

    assertThat(second.getContext().isLeader()).isFalse();

    <span class="hljs-comment">// simulate first registry instance unable to obtain lock, for example due to lock timeout</span>

    firstLocked.set(<span class="hljs-keyword">false</span>);

    <span class="hljs-comment">// second initiator should take lead and publish granted event, first initiator should publish revoked event</span>

    assertThat(secondGranted.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    assertThat(firstRevoked.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    assertThat(second.getContext().isLeader()).isTrue();

    assertThat(first.getContext().isLeader()).isFalse();

    first.stop();

    second.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Lock <span class="hljs-title">createMockLock</span><span class="hljs-params">(java.util.function.Supplier&lt;Boolean&gt; tryLockSupplier)</span> </span>{
    Lock lock = mock(Lock<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(lock.tryLock(anyLong(), any(TimeUnit<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willAnswer</span>(<span class="hljs-title">i</span> -&gt; <span class="hljs-title">tryLockSupplier</span>.<span class="hljs-title">get</span>())</span>;
    <span class="hljs-keyword">return</span> lock;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci64">Mock Clone Instance #spring-integration_MCI_64</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>jcifs.smb.SmbFile</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 6</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockSmbFile</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SmbFile <span class="hljs-title">createMockSmbFile</span><span class="hljs-params">(<span class="hljs-keyword">long</span> lastModified)</span> </span>{
        SmbFile smbFile = mock(SmbFile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(smbFile.getLastModified()).thenReturn(lastModified);
        <span class="hljs-keyword">return</span> smbFile;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest641">Test Case ID #spring-integration_Test_64_1</h4>
<h4 id="test-case-name-testagefile-cjavaprojectsspringspring-integrationspring-integration-smbsrctestjavaorgspringframeworkintegrationsmbfilterssmblastmodifiedfilelistfiltertestsjava">Test Case Name: <code>testAge</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-smb\src\test\java\org\springframework\integration\smb\filters\SmbLastModifiedFileListFilterTests.java</code>)</h4>
<h4 id="mock-object-variable-name-smbfile1">Mock Object Variable Name: <code>smbFile1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SmbLastModifiedFileListFilter filter = new SmbLastModifiedFileListFilter();
    filter.setAge(80);
<span class="hljs-deletion">-    SmbFile smbFile1 = mock(SmbFile.class);</span>
<span class="hljs-deletion">-    when(smbFile1.getLastModified()).thenReturn(System.currentTimeMillis());</span>
<span class="hljs-addition">+    SmbFile smbFile1 = MockSmbFile.createMockSmbFile(System.currentTimeMillis());</span>
    SmbFile smbFile2 = mock(SmbFile.class);
    when(smbFile2.getLastModified()).thenReturn(System.currentTimeMillis());
    SmbFile smbFile3 = mock(SmbFile.class);
    when(smbFile3.getLastModified()).thenReturn(Instant.now().minus(Duration.ofDays(1)).toEpochMilli());
    SmbFile[] files = new SmbFile[] { smbFile1, smbFile2, smbFile3 };
    assertThat(filter.filterFiles(files)).hasSize(1);
    assertThat(filter.accept(smbFile1)).isFalse();
    assertThat(filter.accept(smbFile3)).isTrue();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAge</span><span class="hljs-params">()</span> </span>{

    SmbLastModifiedFileListFilter filter = <span class="hljs-keyword">new</span> SmbLastModifiedFileListFilter();

    filter.setAge(<span class="hljs-number">80</span>);

    SmbFile smbFile1 = mock(SmbFile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(smbFile1.getLastModified()).thenReturn(System.currentTimeMillis());

    SmbFile smbFile2 = mock(SmbFile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(smbFile2.getLastModified()).thenReturn(System.currentTimeMillis());

    SmbFile smbFile3 = mock(SmbFile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(smbFile3.getLastModified()).thenReturn(Instant.now().minus(Duration.ofDays(<span class="hljs-number">1</span>)).toEpochMilli());

    SmbFile[] files = <span class="hljs-keyword">new</span> SmbFile[] { smbFile1, smbFile2, smbFile3 };

    assertThat(filter.filterFiles(files)).hasSize(<span class="hljs-number">1</span>);

    assertThat(filter.accept(smbFile1)).isFalse();

    assertThat(filter.accept(smbFile3)).isTrue();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockSmbFile</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SmbFile <span class="hljs-title">createMockSmbFile</span><span class="hljs-params">(<span class="hljs-keyword">long</span> lastModified)</span> </span>{
        SmbFile smbFile = mock(SmbFile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(smbFile.getLastModified()).thenReturn(lastModified);
        <span class="hljs-keyword">return</span> smbFile;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest642">Test Case ID #spring-integration_Test_64_2</h4>
<h4 id="test-case-name-testagefile-cjavaprojectsspringspring-integrationspring-integration-smbsrctestjavaorgspringframeworkintegrationsmbfilterssmblastmodifiedfilelistfiltertestsjava">Test Case Name: <code>testAge</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-smb\src\test\java\org\springframework\integration\smb\filters\SmbLastModifiedFileListFilterTests.java</code>)</h4>
<h4 id="mock-object-variable-name-smbfile2">Mock Object Variable Name: <code>smbFile2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SmbFile smbFile1 = mock(SmbFile.class);
    when(smbFile1.getLastModified()).thenReturn(System.currentTimeMillis());
<span class="hljs-deletion">-    SmbFile smbFile2 = mock(SmbFile.class);</span>
<span class="hljs-deletion">-    when(smbFile2.getLastModified()).thenReturn(System.currentTimeMillis());</span>
<span class="hljs-addition">+    SmbFile smbFile2 = MockSmbFile.createMockSmbFile(System.currentTimeMillis());</span>
    SmbFile smbFile3 = mock(SmbFile.class);
    when(smbFile3.getLastModified()).thenReturn(Instant.now().minus(Duration.ofDays(1)).toEpochMilli());
    SmbFile[] files = new SmbFile[] { smbFile1, smbFile2, smbFile3 };
    assertThat(filter.filterFiles(files)).hasSize(1);
    assertThat(filter.accept(smbFile1)).isFalse();
    assertThat(filter.accept(smbFile3)).isTrue();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAge</span><span class="hljs-params">()</span> </span>{

    SmbLastModifiedFileListFilter filter = <span class="hljs-keyword">new</span> SmbLastModifiedFileListFilter();

    filter.setAge(<span class="hljs-number">80</span>);

    SmbFile smbFile1 = mock(SmbFile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(smbFile1.getLastModified()).thenReturn(System.currentTimeMillis());

    SmbFile smbFile2 = mock(SmbFile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(smbFile2.getLastModified()).thenReturn(System.currentTimeMillis());

    SmbFile smbFile3 = mock(SmbFile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(smbFile3.getLastModified()).thenReturn(Instant.now().minus(Duration.ofDays(<span class="hljs-number">1</span>)).toEpochMilli());

    SmbFile[] files = <span class="hljs-keyword">new</span> SmbFile[] { smbFile1, smbFile2, smbFile3 };

    assertThat(filter.filterFiles(files)).hasSize(<span class="hljs-number">1</span>);

    assertThat(filter.accept(smbFile1)).isFalse();

    assertThat(filter.accept(smbFile3)).isTrue();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockSmbFile</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SmbFile <span class="hljs-title">createMockSmbFile</span><span class="hljs-params">(<span class="hljs-keyword">long</span> lastModified)</span> </span>{
        SmbFile smbFile = mock(SmbFile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(smbFile.getLastModified()).thenReturn(lastModified);
        <span class="hljs-keyword">return</span> smbFile;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest643">Test Case ID #spring-integration_Test_64_3</h4>
<h4 id="test-case-name-testagefile-cjavaprojectsspringspring-integrationspring-integration-smbsrctestjavaorgspringframeworkintegrationsmbfilterssmblastmodifiedfilelistfiltertestsjava">Test Case Name: <code>testAge</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-smb\src\test\java\org\springframework\integration\smb\filters\SmbLastModifiedFileListFilterTests.java</code>)</h4>
<h4 id="mock-object-variable-name-smbfile3">Mock Object Variable Name: <code>smbFile3</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     SmbFile smbFile2 = mock(SmbFile.class);
     when(smbFile2.getLastModified()).thenReturn(System.currentTimeMillis());
<span class="hljs-deletion">-    SmbFile smbFile3 = mock(SmbFile.class);</span>
<span class="hljs-deletion">-    when(smbFile3.getLastModified()).thenReturn(Instant.now().minus(Duration.ofDays(1)).toEpochMilli());</span>
<span class="hljs-addition">+    SmbFile smbFile3 = MockSmbFile.createMockSmbFile(Instant.now().minus(Duration.ofDays(1)).toEpochMilli());</span>
     SmbFile[] files = new SmbFile[] { smbFile1, smbFile2, smbFile3 };
     assertThat(filter.filterFiles(files)).hasSize(1);
     assertThat(filter.accept(smbFile1)).isFalse();
     assertThat(filter.accept(smbFile3)).isTrue();
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAge</span><span class="hljs-params">()</span> </span>{

    SmbLastModifiedFileListFilter filter = <span class="hljs-keyword">new</span> SmbLastModifiedFileListFilter();

    filter.setAge(<span class="hljs-number">80</span>);

    SmbFile smbFile1 = mock(SmbFile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(smbFile1.getLastModified()).thenReturn(System.currentTimeMillis());

    SmbFile smbFile2 = mock(SmbFile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(smbFile2.getLastModified()).thenReturn(System.currentTimeMillis());

    SmbFile smbFile3 = mock(SmbFile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(smbFile3.getLastModified()).thenReturn(Instant.now().minus(Duration.ofDays(<span class="hljs-number">1</span>)).toEpochMilli());

    SmbFile[] files = <span class="hljs-keyword">new</span> SmbFile[] { smbFile1, smbFile2, smbFile3 };

    assertThat(filter.filterFiles(files)).hasSize(<span class="hljs-number">1</span>);

    assertThat(filter.accept(smbFile1)).isFalse();

    assertThat(filter.accept(smbFile3)).isTrue();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockSmbFile</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SmbFile <span class="hljs-title">createMockSmbFile</span><span class="hljs-params">(<span class="hljs-keyword">long</span> lastModified)</span> </span>{
        SmbFile smbFile = mock(SmbFile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(smbFile.getLastModified()).thenReturn(lastModified);
        <span class="hljs-keyword">return</span> smbFile;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest644">Test Case ID #spring-integration_Test_64_4</h4>
<h4 id="test-case-name-testagefile-cjavaprojectsspringspring-integrationspring-integration-smbsrctestjavaorgspringframeworkintegrationsmbfilterssmbrecentfilelistfiltertestsjava">Test Case Name: <code>testAge</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-smb\src\test\java\org\springframework\integration\smb\filters\SmbRecentFileListFilterTests.java</code>)</h4>
<h4 id="mock-object-variable-name-smbfile1">Mock Object Variable Name: <code>smbFile1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SmbRecentFileListFilter filter = new SmbRecentFileListFilter(Duration.ofHours(20));
<span class="hljs-deletion">-    SmbFile smbFile1 = mock();</span>
<span class="hljs-deletion">-    when(smbFile1.getLastModified()).thenReturn(System.currentTimeMillis());</span>
<span class="hljs-addition">+    SmbFile smbFile1 = MockSmbFile.createMockSmbFile(System.currentTimeMillis());</span>
    SmbFile smbFile2 = mock();
    when(smbFile2.getLastModified()).thenReturn(System.currentTimeMillis());
    SmbFile smbFile3 = mock();
    when(smbFile3.getLastModified()).thenReturn(Instant.now().minus(Duration.ofDays(1)).toEpochMilli());
    SmbFile[] files = new SmbFile[] { smbFile1, smbFile2, smbFile3 };
    assertThat(filter.filterFiles(files)).hasSize(2);
    assertThat(filter.accept(smbFile1)).isTrue();
    assertThat(filter.accept(smbFile2)).isTrue();
    assertThat(filter.accept(smbFile3)).isFalse();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAge</span><span class="hljs-params">()</span> </span>{

    SmbRecentFileListFilter filter = <span class="hljs-keyword">new</span> SmbRecentFileListFilter(Duration.ofHours(<span class="hljs-number">20</span>));

    SmbFile smbFile1 = mock();

    when(smbFile1.getLastModified()).thenReturn(System.currentTimeMillis());

    SmbFile smbFile2 = mock();

    when(smbFile2.getLastModified()).thenReturn(System.currentTimeMillis());

    SmbFile smbFile3 = mock();

    when(smbFile3.getLastModified()).thenReturn(Instant.now().minus(Duration.ofDays(<span class="hljs-number">1</span>)).toEpochMilli());

    SmbFile[] files = <span class="hljs-keyword">new</span> SmbFile[] { smbFile1, smbFile2, smbFile3 };

    assertThat(filter.filterFiles(files)).hasSize(<span class="hljs-number">2</span>);

    assertThat(filter.accept(smbFile1)).isTrue();

    assertThat(filter.accept(smbFile2)).isTrue();

    assertThat(filter.accept(smbFile3)).isFalse();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockSmbFile</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SmbFile <span class="hljs-title">createMockSmbFile</span><span class="hljs-params">(<span class="hljs-keyword">long</span> lastModified)</span> </span>{
        SmbFile smbFile = mock(SmbFile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(smbFile.getLastModified()).thenReturn(lastModified);
        <span class="hljs-keyword">return</span> smbFile;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest645">Test Case ID #spring-integration_Test_64_5</h4>
<h4 id="test-case-name-testagefile-cjavaprojectsspringspring-integrationspring-integration-smbsrctestjavaorgspringframeworkintegrationsmbfilterssmbrecentfilelistfiltertestsjava">Test Case Name: <code>testAge</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-smb\src\test\java\org\springframework\integration\smb\filters\SmbRecentFileListFilterTests.java</code>)</h4>
<h4 id="mock-object-variable-name-smbfile2">Mock Object Variable Name: <code>smbFile2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SmbFile smbFile1 = mock();
    when(smbFile1.getLastModified()).thenReturn(System.currentTimeMillis());
<span class="hljs-deletion">-    SmbFile smbFile2 = mock();</span>
<span class="hljs-deletion">-    when(smbFile2.getLastModified()).thenReturn(System.currentTimeMillis());</span>
<span class="hljs-addition">+    SmbFile smbFile2 = MockSmbFile.createMockSmbFile(System.currentTimeMillis());</span>
    SmbFile smbFile3 = mock();
    when(smbFile3.getLastModified()).thenReturn(Instant.now().minus(Duration.ofDays(1)).toEpochMilli());
    SmbFile[] files = new SmbFile[] { smbFile1, smbFile2, smbFile3 };
    assertThat(filter.filterFiles(files)).hasSize(2);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAge</span><span class="hljs-params">()</span> </span>{

    SmbRecentFileListFilter filter = <span class="hljs-keyword">new</span> SmbRecentFileListFilter(Duration.ofHours(<span class="hljs-number">20</span>));

    SmbFile smbFile1 = mock();

    when(smbFile1.getLastModified()).thenReturn(System.currentTimeMillis());

    SmbFile smbFile2 = mock();

    when(smbFile2.getLastModified()).thenReturn(System.currentTimeMillis());

    SmbFile smbFile3 = mock();

    when(smbFile3.getLastModified()).thenReturn(Instant.now().minus(Duration.ofDays(<span class="hljs-number">1</span>)).toEpochMilli());

    SmbFile[] files = <span class="hljs-keyword">new</span> SmbFile[] { smbFile1, smbFile2, smbFile3 };

    assertThat(filter.filterFiles(files)).hasSize(<span class="hljs-number">2</span>);

    assertThat(filter.accept(smbFile1)).isTrue();

    assertThat(filter.accept(smbFile2)).isTrue();

    assertThat(filter.accept(smbFile3)).isFalse();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockSmbFile</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SmbFile <span class="hljs-title">createMockSmbFile</span><span class="hljs-params">(<span class="hljs-keyword">long</span> lastModified)</span> </span>{
        SmbFile smbFile = mock(SmbFile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(smbFile.getLastModified()).thenReturn(lastModified);
        <span class="hljs-keyword">return</span> smbFile;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest646">Test Case ID #spring-integration_Test_64_6</h4>
<h4 id="test-case-name-testagefile-cjavaprojectsspringspring-integrationspring-integration-smbsrctestjavaorgspringframeworkintegrationsmbfilterssmbrecentfilelistfiltertestsjava">Test Case Name: <code>testAge</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-smb\src\test\java\org\springframework\integration\smb\filters\SmbRecentFileListFilterTests.java</code>)</h4>
<h4 id="mock-object-variable-name-smbfile3">Mock Object Variable Name: <code>smbFile3</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SmbFile smbFile1 = mock();
    when(smbFile1.getLastModified()).thenReturn(System.currentTimeMillis());
    SmbFile smbFile2 = mock();
    when(smbFile2.getLastModified()).thenReturn(System.currentTimeMillis());
<span class="hljs-deletion">-    SmbFile smbFile3 = mock();</span>
<span class="hljs-deletion">-    when(smbFile3.getLastModified()).thenReturn(Instant.now().minus(Duration.ofDays(1)).toEpochMilli());</span>
<span class="hljs-addition">+    SmbFile smbFile3 = MockSmbFile.createMockSmbFile(Instant.now().minus(Duration.ofDays(1)).toEpochMilli());</span>
    SmbFile[] files = new SmbFile[] { smbFile1, smbFile2, smbFile3 };
    assertThat(filter.filterFiles(files)).hasSize(2);
    assertThat(filter.accept(smbFile1)).isTrue();
    assertThat(filter.accept(smbFile2)).isTrue();
    assertThat(filter.accept(smbFile3)).isFalse();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAge</span><span class="hljs-params">()</span> </span>{

    SmbRecentFileListFilter filter = <span class="hljs-keyword">new</span> SmbRecentFileListFilter(Duration.ofHours(<span class="hljs-number">20</span>));

    SmbFile smbFile1 = mock();

    when(smbFile1.getLastModified()).thenReturn(System.currentTimeMillis());

    SmbFile smbFile2 = mock();

    when(smbFile2.getLastModified()).thenReturn(System.currentTimeMillis());

    SmbFile smbFile3 = mock();

    when(smbFile3.getLastModified()).thenReturn(Instant.now().minus(Duration.ofDays(<span class="hljs-number">1</span>)).toEpochMilli());

    SmbFile[] files = <span class="hljs-keyword">new</span> SmbFile[] { smbFile1, smbFile2, smbFile3 };

    assertThat(filter.filterFiles(files)).hasSize(<span class="hljs-number">2</span>);

    assertThat(filter.accept(smbFile1)).isTrue();

    assertThat(filter.accept(smbFile2)).isTrue();

    assertThat(filter.accept(smbFile3)).isFalse();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockSmbFile</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SmbFile <span class="hljs-title">createMockSmbFile</span><span class="hljs-params">(<span class="hljs-keyword">long</span> lastModified)</span> </span>{
        SmbFile smbFile = mock(SmbFile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(smbFile.getLastModified()).thenReturn(lastModified);
        <span class="hljs-keyword">return</span> smbFile;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci65">Mock Clone Instance #spring-integration_MCI_65</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.file.remote.session.Session&lt;org.springframework.integration.file.remote.gateway.RemoteFileOutboundGatewayTests.TestLsEntry&gt;</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; createMockSession(AtomicReference&lt;String&gt; written) {
    Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(invocation -&gt; {
        written.set(invocation.getArgument(<span class="hljs-number">1</span>));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).when(session).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest651">Test Case ID #spring-integration_Test_65_1</h4>
<h4 id="test-case-name-testmputfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testMput</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory.class);
<span class="hljs-deletion">-    Session&lt;TestLsEntry&gt; session = mock(Session.class);</span>
    RemoteFileTemplate&lt;TestLsEntry&gt; template = new RemoteFileTemplate&lt;&gt;(sessionFactory);
    template.setRemoteDirectoryExpression(new LiteralExpression("foo/"));
    template.setBeanFactory(mock(BeanFactory.class));
    template.afterPropertiesSet();
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(template, "mput", "payload");
    gw.afterPropertiesSet();
    when(sessionFactory.getSession()).thenReturn(session);
    final AtomicReference&lt;String&gt; written = new AtomicReference&lt;&gt;();
<span class="hljs-addition">+    Session&lt;TestLsEntry&gt; session = createMockSession(written);</span>
<span class="hljs-deletion">-    doAnswer(invocation -&gt; {</span>
<span class="hljs-deletion">-        written.set(invocation.getArgument(1));</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).when(session).write(any(InputStream.class), anyString());</span>
    assertThat(new File(tempFolder, "baz.txt").createNewFile()).isTrue();
    assertThat(new File(tempFolder, "qux.txt").createNewFile()).isTrue();
    Message&lt;File&gt; requestMessage = MessageBuilder.withPayload(tempFolder).build();
    List&lt;String&gt; out = (List&lt;String&gt;) gw.handleRequestMessage(requestMessage);
    assertThat(out).hasSize(2);
    assertThat(out.get(0)).isNotEqualTo(out.get(1));
    assertThat(out.get(0)).isIn("foo/baz.txt", "foo/qux.txt");
    assertThat(out.get(1)).isIn("foo/baz.txt", "foo/qux.txt");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMput</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;TestLsEntry&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RemoteFileTemplate&lt;TestLsEntry&gt; template = <span class="hljs-keyword">new</span> RemoteFileTemplate&lt;&gt;(sessionFactory);

    template.setRemoteDirectoryExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"foo/"</span>));

    template.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    template.afterPropertiesSet();

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(template, <span class="hljs-string">"mput"</span>, <span class="hljs-string">"payload"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    <span class="hljs-keyword">final</span> AtomicReference&lt;String&gt; written = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    doAnswer(invocation -&gt; {

        written.set(invocation.getArgument(<span class="hljs-number">1</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(session).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;

    assertThat(<span class="hljs-keyword">new</span> File(tempFolder, <span class="hljs-string">"baz.txt"</span>).createNewFile()).isTrue();

    assertThat(<span class="hljs-keyword">new</span> File(tempFolder, <span class="hljs-string">"qux.txt"</span>).createNewFile()).isTrue();

    Message&lt;File&gt; requestMessage = MessageBuilder.withPayload(tempFolder).build();

    List&lt;String&gt; out = (List&lt;String&gt;) gw.handleRequestMessage(requestMessage);

    assertThat(out).hasSize(<span class="hljs-number">2</span>);

    assertThat(out.get(<span class="hljs-number">0</span>)).isNotEqualTo(out.get(<span class="hljs-number">1</span>));

    assertThat(out.get(<span class="hljs-number">0</span>)).isIn(<span class="hljs-string">"foo/baz.txt"</span>, <span class="hljs-string">"foo/qux.txt"</span>);

    assertThat(out.get(<span class="hljs-number">1</span>)).isIn(<span class="hljs-string">"foo/baz.txt"</span>, <span class="hljs-string">"foo/qux.txt"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; createMockSession(AtomicReference&lt;String&gt; written) {
    Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(invocation -&gt; {
        written.set(invocation.getArgument(<span class="hljs-number">1</span>));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).when(session).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest652">Test Case ID #spring-integration_Test_65_2</h4>
<h4 id="test-case-name-testmputrecursivefile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testMputRecursive</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory.class);
<span class="hljs-deletion">-    Session&lt;TestLsEntry&gt; session = mock(Session.class);</span>
    RemoteFileTemplate&lt;TestLsEntry&gt; template = new RemoteFileTemplate&lt;&gt;(sessionFactory);
    template.setRemoteDirectoryExpression(new LiteralExpression("foo/"));
    template.setBeanFactory(mock(BeanFactory.class));
    template.afterPropertiesSet();
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(template, "mput", null);
    gw.setOptions("-R");
    gw.afterPropertiesSet();
    when(sessionFactory.getSession()).thenReturn(session);
    final AtomicReference&lt;String&gt; written = new AtomicReference&lt;&gt;();
<span class="hljs-addition">+    Session&lt;TestLsEntry&gt; session = createMockSession(written);</span>
    new File(tempFolder, "baz.txt").createNewFile();
    new File(tempFolder, "qux.txt").createNewFile();
    File dir1 = Files.createTempDirectory(tempFolder.toPath(), "junit").toFile();
    File file3 = File.createTempFile("foo", ".txt", dir1);
    Message&lt;File&gt; requestMessage = MessageBuilder.withPayload(tempFolder).build();
    List&lt;String&gt; out = (List&lt;String&gt;) gw.handleRequestMessage(requestMessage);
    assertThat(out).hasSize(3);
    assertThat(out.get(0)).isNotEqualTo(out.get(1));
    assertThat(out.get(0)).isIn("foo/baz.txt", "foo/qux.txt", "foo/" + dir1.getName() + "/" + file3.getName());
    assertThat(out.get(1)).isIn("foo/baz.txt", "foo/qux.txt", "foo/" + dir1.getName() + "/" + file3.getName());
    assertThat(out.get(2)).isIn("foo/baz.txt", "foo/qux.txt", "foo/" + dir1.getName() + "/" + file3.getName());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMputRecursive</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;TestLsEntry&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RemoteFileTemplate&lt;TestLsEntry&gt; template = <span class="hljs-keyword">new</span> RemoteFileTemplate&lt;&gt;(sessionFactory);

    template.setRemoteDirectoryExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"foo/"</span>));

    template.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    template.afterPropertiesSet();

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(template, <span class="hljs-string">"mput"</span>, <span class="hljs-keyword">null</span>);

    gw.setOptions(<span class="hljs-string">"-R"</span>);

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    <span class="hljs-keyword">final</span> AtomicReference&lt;String&gt; written = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    doAnswer(invocation -&gt; {

        written.set(invocation.getArgument(<span class="hljs-number">1</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(session).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;

    <span class="hljs-keyword">new</span> File(tempFolder, <span class="hljs-string">"baz.txt"</span>).createNewFile();

    <span class="hljs-keyword">new</span> File(tempFolder, <span class="hljs-string">"qux.txt"</span>).createNewFile();

    File dir1 = Files.createTempDirectory(tempFolder.toPath(), <span class="hljs-string">"junit"</span>).toFile();

    File file3 = File.createTempFile(<span class="hljs-string">"foo"</span>, <span class="hljs-string">".txt"</span>, dir1);

    Message&lt;File&gt; requestMessage = MessageBuilder.withPayload(tempFolder).build();

    List&lt;String&gt; out = (List&lt;String&gt;) gw.handleRequestMessage(requestMessage);

    assertThat(out).hasSize(<span class="hljs-number">3</span>);

    assertThat(out.get(<span class="hljs-number">0</span>)).isNotEqualTo(out.get(<span class="hljs-number">1</span>));

    assertThat(out.get(<span class="hljs-number">0</span>)).isIn(<span class="hljs-string">"foo/baz.txt"</span>, <span class="hljs-string">"foo/qux.txt"</span>, <span class="hljs-string">"foo/"</span> + dir1.getName() + <span class="hljs-string">"/"</span> + file3.getName());

    assertThat(out.get(<span class="hljs-number">1</span>)).isIn(<span class="hljs-string">"foo/baz.txt"</span>, <span class="hljs-string">"foo/qux.txt"</span>, <span class="hljs-string">"foo/"</span> + dir1.getName() + <span class="hljs-string">"/"</span> + file3.getName());

    assertThat(out.get(<span class="hljs-number">2</span>)).isIn(<span class="hljs-string">"foo/baz.txt"</span>, <span class="hljs-string">"foo/qux.txt"</span>, <span class="hljs-string">"foo/"</span> + dir1.getName() + <span class="hljs-string">"/"</span> + file3.getName());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; createMockSession(AtomicReference&lt;String&gt; written) {
    Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(invocation -&gt; {
        written.set(invocation.getArgument(<span class="hljs-number">1</span>));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).when(session).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest653">Test Case ID #spring-integration_Test_65_3</h4>
<h4 id="test-case-name-testmputcollectionfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testMputCollection</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory.class);
<span class="hljs-deletion">-    Session&lt;TestLsEntry&gt; session = mock(Session.class);</span>
<span class="hljs-addition">+    final AtomicReference&lt;String&gt; written = new AtomicReference&lt;&gt;();</span>
<span class="hljs-addition">+    Session&lt;TestLsEntry&gt; session = createMockSession(written);</span>
    TestRemoteFileOutboundGateway gw = new TestRemoteFileOutboundGateway(sessionFactory, "mput", "payload");
    gw.setRemoteDirectoryExpression(new LiteralExpression("foo/"));
    gw.afterPropertiesSet();
    when(sessionFactory.getSession()).thenReturn(session);
<span class="hljs-deletion">-    final AtomicReference&lt;String&gt; written = new AtomicReference&lt;&gt;();</span>
<span class="hljs-deletion">-    doAnswer(invocation -&gt; {</span>
<span class="hljs-deletion">-        written.set(invocation.getArgument(1));</span>
<span class="hljs-deletion">-        return null;</span>
<span class="hljs-deletion">-    }).when(session).write(any(InputStream.class), anyString());</span>
    List&lt;File&gt; files = new ArrayList&lt;&gt;();
    File file1 = new File(tempFolder, "fiz.txt");
    file1.createNewFile();
    files.add(file1);
    File file2 = new File(tempFolder, "buz.txt");
    file2.createNewFile();
    files.add(file2);
    Message&lt;List&lt;File&gt;&gt; requestMessage = MessageBuilder.withPayload(files).build();
    List&lt;String&gt; out = (List&lt;String&gt;) gw.handleRequestMessage(requestMessage);
    assertThat(out).isNotNull().hasSize(2);
    assertThat(out.get(0)).isNotEqualTo(out.get(1));
    assertThat(out.get(0)).isEqualTo("foo/fiz.txt");
    assertThat(out.get(1)).isEqualTo("foo/buz.txt");
    assertThat(written.get()).isEqualTo("foo/buz.txt.writing");
    verify(session).rename("foo/buz.txt.writing", "foo/buz.txt");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMputCollection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;TestLsEntry&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(sessionFactory, <span class="hljs-string">"mput"</span>, <span class="hljs-string">"payload"</span>);

    gw.setRemoteDirectoryExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"foo/"</span>));

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    <span class="hljs-keyword">final</span> AtomicReference&lt;String&gt; written = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    doAnswer(invocation -&gt; {

        written.set(invocation.getArgument(<span class="hljs-number">1</span>));

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(session).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;

    List&lt;File&gt; files = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    File file1 = <span class="hljs-keyword">new</span> File(tempFolder, <span class="hljs-string">"fiz.txt"</span>);

    file1.createNewFile();

    files.add(file1);

    File file2 = <span class="hljs-keyword">new</span> File(tempFolder, <span class="hljs-string">"buz.txt"</span>);

    file2.createNewFile();

    files.add(file2);

    Message&lt;List&lt;File&gt;&gt; requestMessage = MessageBuilder.withPayload(files).build();

    List&lt;String&gt; out = (List&lt;String&gt;) gw.handleRequestMessage(requestMessage);

    assertThat(out).isNotNull().hasSize(<span class="hljs-number">2</span>);

    assertThat(out.get(<span class="hljs-number">0</span>)).isNotEqualTo(out.get(<span class="hljs-number">1</span>));

    assertThat(out.get(<span class="hljs-number">0</span>)).isEqualTo(<span class="hljs-string">"foo/fiz.txt"</span>);

    assertThat(out.get(<span class="hljs-number">1</span>)).isEqualTo(<span class="hljs-string">"foo/buz.txt"</span>);

    assertThat(written.get()).isEqualTo(<span class="hljs-string">"foo/buz.txt.writing"</span>);

    verify(session).rename(<span class="hljs-string">"foo/buz.txt.writing"</span>, <span class="hljs-string">"foo/buz.txt"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; createMockSession(AtomicReference&lt;String&gt; written) {
    Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(invocation -&gt; {
        written.set(invocation.getArgument(<span class="hljs-number">1</span>));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    }).when(session).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci66">Mock Clone Instance #spring-integration_MCI_66</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.file.remote.session.Session&lt;org.springframework.integration.file.remote.gateway.RemoteFileOutboundGatewayTests.TestLsEntry&gt;</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; createMockSessionExistsTrue() {
    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)
    Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(Boolean.TRUE).given(session).exists(anyString());
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest661">Test Case ID #spring-integration_Test_66_1</h4>
<h4 id="test-case-name-testputexistsfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testPutExists</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    @SuppressWarnings("unchecked")
    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory.class);
<span class="hljs-deletion">-    @SuppressWarnings("unchecked")</span>
<span class="hljs-deletion">-    Session&lt;TestLsEntry&gt; session = mock(Session.class);</span>
<span class="hljs-deletion">-    willReturn(Boolean.TRUE).given(session).exists(anyString());</span>
<span class="hljs-addition">+    Session&lt;TestLsEntry&gt; session = createMockSessionExistsTrue();</span>
    RemoteFileTemplate&lt;TestLsEntry&gt; template = new RemoteFileTemplate&lt;&gt;(sessionFactory);
    template.setRemoteDirectoryExpression(new LiteralExpression("foo/"));
    template.setBeanFactory(mock(BeanFactory.class));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testPutExists</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

    Session&lt;TestLsEntry&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Boolean.TRUE).given(session).exists(anyString());

    RemoteFileTemplate&lt;TestLsEntry&gt; template = <span class="hljs-keyword">new</span> RemoteFileTemplate&lt;&gt;(sessionFactory);

    template.setRemoteDirectoryExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"foo/"</span>));

    template.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    template.afterPropertiesSet();

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(template, <span class="hljs-string">"put"</span>, <span class="hljs-string">"payload"</span>);

    FileTransferringMessageHandler&lt;TestLsEntry&gt; handler = <span class="hljs-keyword">new</span> FileTransferringMessageHandler&lt;&gt;(sessionFactory);

    handler.setRemoteDirectoryExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"foo/"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    gw.afterPropertiesSet();

    when(sessionFactory.getSession()).thenReturn(session);

    Message&lt;String&gt; requestMessage = MessageBuilder.withPayload(<span class="hljs-string">"hello"</span>).setHeader(FileHeaders.FILENAME, <span class="hljs-string">"bar.txt"</span>).build();

    <span class="hljs-comment">// default (null) == REPLACE</span>

    String path = (String) gw.handleRequestMessage(requestMessage);

    assertThat(path).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    ArgumentCaptor&lt;String&gt; captor = ArgumentCaptor.forClass(String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(session).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">captor</span>.<span class="hljs-title">capture</span>())</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-string">"foo/bar.txt.writing"</span>);

    verify(session).rename(<span class="hljs-string">"foo/bar.txt.writing"</span>, <span class="hljs-string">"foo/bar.txt"</span>);

    gw.setFileExistsMode(FileExistsMode.FAIL);

    assertThatExceptionOfType(MessageDeliveryException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(() -&gt; <span class="hljs-title">gw</span>.<span class="hljs-title">handleRequestMessage</span>(<span class="hljs-title">requestMessage</span>)).<span class="hljs-title">withStackTraceContaining</span>("<span class="hljs-title">The</span> <span class="hljs-title">destination</span> <span class="hljs-title">file</span> <span class="hljs-title">already</span> <span class="hljs-title">exists</span>")</span>;

    gw.setFileExistsMode(FileExistsMode.REPLACE);

    path = (String) gw.handleRequestMessage(requestMessage);

    assertThat(path).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    captor = ArgumentCaptor.forClass(String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(session, times(<span class="hljs-number">2</span>)).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">captor</span>.<span class="hljs-title">capture</span>())</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-string">"foo/bar.txt.writing"</span>);

    verify(session, times(<span class="hljs-number">2</span>)).rename(<span class="hljs-string">"foo/bar.txt.writing"</span>, <span class="hljs-string">"foo/bar.txt"</span>);

    gw.setFileExistsMode(FileExistsMode.APPEND);

    path = (String) gw.handleRequestMessage(requestMessage);

    assertThat(path).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    captor = ArgumentCaptor.forClass(String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(session).append(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">captor</span>.<span class="hljs-title">capture</span>())</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    gw.setFileExistsMode(FileExistsMode.IGNORE);

    path = (String) gw.handleRequestMessage(requestMessage);

    assertThat(path).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    <span class="hljs-comment">// no more writes/appends</span>

    verify(session, times(<span class="hljs-number">2</span>)).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;

    verify(session, times(<span class="hljs-number">1</span>)).append(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; createMockSessionExistsTrue() {
    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)
    Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(Boolean.TRUE).given(session).exists(anyString());
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest662">Test Case ID #spring-integration_Test_66_2</h4>
<h4 id="test-case-name-testputexistsexpressionfile-cjavaprojectsspringspring-integrationspring-integration-filesrctestjavaorgspringframeworkintegrationfileremotegatewayremotefileoutboundgatewaytestsjava">Test Case Name: <code>testPutExistsExpression</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-file\src\test\java\org\springframework\integration\file\remote\gateway\RemoteFileOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-session">Mock Object Variable Name: <code>session</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory.class);
<span class="hljs-deletion">-    Session&lt;TestLsEntry&gt; session = mock(Session.class);</span>
<span class="hljs-deletion">-    willReturn(Boolean.TRUE).given(session).exists(anyString());</span>
<span class="hljs-addition">+    Session&lt;TestLsEntry&gt; session = createMockSessionExistsTrue();</span>
    RemoteFileTemplate&lt;TestLsEntry&gt; template = new RemoteFileTemplate&lt;&gt;(sessionFactory);
    template.setRemoteDirectoryExpression(new LiteralExpression("foo/"));
    template.setBeanFactory(mock(BeanFactory.class));
    template.afterPropertiesSet();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testPutExistsExpression</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    SessionFactory&lt;TestLsEntry&gt; sessionFactory = mock(SessionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Session&lt;TestLsEntry&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    willReturn(Boolean.TRUE).given(session).exists(anyString());

    RemoteFileTemplate&lt;TestLsEntry&gt; template = <span class="hljs-keyword">new</span> RemoteFileTemplate&lt;&gt;(sessionFactory);

    template.setRemoteDirectoryExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"foo/"</span>));

    template.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    template.afterPropertiesSet();

    TestRemoteFileOutboundGateway gw = <span class="hljs-keyword">new</span> TestRemoteFileOutboundGateway(template, <span class="hljs-string">"put"</span>, <span class="hljs-string">"payload"</span>);

    FileTransferringMessageHandler&lt;TestLsEntry&gt; handler = <span class="hljs-keyword">new</span> FileTransferringMessageHandler&lt;&gt;(sessionFactory);

    handler.setRemoteDirectoryExpression(<span class="hljs-keyword">new</span> LiteralExpression(<span class="hljs-string">"foo/"</span>));

    handler.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    handler.afterPropertiesSet();

    gw.afterPropertiesSet();

    gw.setFileExistsModeExpressionString(<span class="hljs-string">"headers[\"file.exists.mode\"]"</span>);

    when(sessionFactory.getSession()).thenReturn(session);

    MessageBuilder&lt;String&gt; requestMessageBuilder = MessageBuilder.withPayload(<span class="hljs-string">"hello"</span>).setHeader(FileHeaders.FILENAME, <span class="hljs-string">"bar.txt"</span>);

    Message&lt;String&gt; defaultMessage = requestMessageBuilder.build();

    String path = (String) gw.handleRequestMessage(defaultMessage);

    assertThat(path).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    ArgumentCaptor&lt;String&gt; captor = ArgumentCaptor.forClass(String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(session).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">captor</span>.<span class="hljs-title">capture</span>())</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-string">"foo/bar.txt.writing"</span>);

    verify(session).rename(<span class="hljs-string">"foo/bar.txt.writing"</span>, <span class="hljs-string">"foo/bar.txt"</span>);

    Message&lt;String&gt; failMessage = requestMessageBuilder.setHeader(<span class="hljs-string">"file.exists.mode"</span>, FileExistsMode.FAIL).build();

    assertThatExceptionOfType(MessageDeliveryException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(() -&gt; <span class="hljs-title">gw</span>.<span class="hljs-title">handleRequestMessage</span>(<span class="hljs-title">failMessage</span>)).<span class="hljs-title">withStackTraceContaining</span>("<span class="hljs-title">The</span> <span class="hljs-title">destination</span> <span class="hljs-title">file</span> <span class="hljs-title">already</span> <span class="hljs-title">exists</span>")</span>;

    Message&lt;String&gt; replaceMessage = requestMessageBuilder.setHeader(<span class="hljs-string">"file.exists.mode"</span>, <span class="hljs-string">"replace"</span>).build();

    path = (String) gw.handleRequestMessage(replaceMessage);

    assertThat(path).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    captor = ArgumentCaptor.forClass(String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(session, times(<span class="hljs-number">2</span>)).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">captor</span>.<span class="hljs-title">capture</span>())</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-string">"foo/bar.txt.writing"</span>);

    verify(session, times(<span class="hljs-number">2</span>)).rename(<span class="hljs-string">"foo/bar.txt.writing"</span>, <span class="hljs-string">"foo/bar.txt"</span>);

    Message&lt;String&gt; appendMessage = requestMessageBuilder.setHeader(<span class="hljs-string">"file.exists.mode"</span>, <span class="hljs-string">"APPEND"</span>).build();

    path = (String) gw.handleRequestMessage(appendMessage);

    assertThat(path).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    captor = ArgumentCaptor.forClass(String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(session).append(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">captor</span>.<span class="hljs-title">capture</span>())</span>;

    assertThat(captor.getValue()).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    Message&lt;String&gt; ignoreMessage = requestMessageBuilder.setHeader(<span class="hljs-string">"file.exists.mode"</span>, FileExistsMode.IGNORE).build();

    path = (String) gw.handleRequestMessage(ignoreMessage);

    assertThat(path).isEqualTo(<span class="hljs-string">"foo/bar.txt"</span>);

    <span class="hljs-comment">// no more writes/appends</span>

    verify(session, times(<span class="hljs-number">2</span>)).write(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;

    verify(session, times(<span class="hljs-number">1</span>)).append(any(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyString</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; createMockSessionExistsTrue() {
    <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)
    Session&lt;RemoteFileOutboundGatewayTests.TestLsEntry&gt; session = mock(Session<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    willReturn(Boolean.TRUE).given(session).exists(anyString());
    <span class="hljs-keyword">return</span> session;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci67">Mock Clone Instance #spring-integration_MCI_67</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.ip.tcp.connection.AbstractClientConnectionFactory</code></li>
<li><strong>Test Case Count</strong>: 7</li>
<li><strong>MO Count</strong>: 7</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AbstractClientConnectionFactory <span class="hljs-title">createMockAbstractClientConnectionFactory</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isRunningReturn)</span> </span>{
    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.isRunning()).thenReturn(isRunningReturn);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest671">Test Case ID #spring-integration_Test_67_1</h4>
<h4 id="test-case-name-testreusefile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectioncachingclientconnectionfactorytestsjava">Test Case Name: <code>testReuse</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\CachingClientConnectionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-factory">Mock Object Variable Name: <code>factory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testReuse() throws Exception {
<span class="hljs-deletion">-    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory.class);</span>
<span class="hljs-deletion">-    when(factory.isRunning()).thenReturn(true);</span>
<span class="hljs-addition">+    AbstractClientConnectionFactory factory = createMockAbstractClientConnectionFactory(true);</span>
     TcpConnectionSupport mockConn1 = makeMockConnection("conn1");
     TcpConnectionSupport mockConn2 = makeMockConnection("conn2");
     when(factory.getConnection()).thenReturn(mockConn1).thenReturn(mockConn2);
     CachingClientConnectionFactory cachingFactory = new CachingClientConnectionFactory(factory, 2);
     cachingFactory.start();
     TcpConnection conn1 = cachingFactory.getConnection();
     // INT-3652
     TcpConnectionInterceptorSupport cachedConn1 = (TcpConnectionInterceptorSupport) conn1;
     Log logger = spy(TestUtils.getPropertyValue(cachedConn1, "logger", Log.class));
     when(logger.isDebugEnabled()).thenReturn(true);
     new DirectFieldAccessor(cachedConn1).setPropertyValue("logger", logger);
     cachedConn1.onMessage(new ErrorMessage(new RuntimeException()));
     ArgumentCaptor&lt;String&gt; captor = ArgumentCaptor.forClass(String.class);
     verify(logger).debug(captor.capture());
     assertThat(captor.getValue()).startsWith("Message discarded; no listener:");
     // end INT-3652
     assertThat(conn1.toString()).isEqualTo("Cached:" + mockConn1.toString());
     conn1.close();
     conn1 = cachingFactory.getConnection();
     assertThat(conn1.toString()).isEqualTo("Cached:" + mockConn1.toString());
     TcpConnection conn2 = cachingFactory.getConnection();
     assertThat(conn2.toString()).isEqualTo("Cached:" + mockConn2.toString());
     conn1.close();
     conn2.close();
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testReuse</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factory.isRunning()).thenReturn(<span class="hljs-keyword">true</span>);

    TcpConnectionSupport mockConn1 = makeMockConnection(<span class="hljs-string">"conn1"</span>);

    TcpConnectionSupport mockConn2 = makeMockConnection(<span class="hljs-string">"conn2"</span>);

    when(factory.getConnection()).thenReturn(mockConn1).thenReturn(mockConn2);

    CachingClientConnectionFactory cachingFactory = <span class="hljs-keyword">new</span> CachingClientConnectionFactory(factory, <span class="hljs-number">2</span>);

    cachingFactory.start();

    TcpConnection conn1 = cachingFactory.getConnection();

    <span class="hljs-comment">// INT-3652</span>

    TcpConnectionInterceptorSupport cachedConn1 = (TcpConnectionInterceptorSupport) conn1;

    Log logger = spy(TestUtils.getPropertyValue(cachedConn1, <span class="hljs-string">"logger"</span>, Log<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    when(logger.isDebugEnabled()).thenReturn(<span class="hljs-keyword">true</span>);

    <span class="hljs-keyword">new</span> DirectFieldAccessor(cachedConn1).setPropertyValue(<span class="hljs-string">"logger"</span>, logger);

    cachedConn1.onMessage(<span class="hljs-keyword">new</span> ErrorMessage(<span class="hljs-keyword">new</span> RuntimeException()));

    ArgumentCaptor&lt;String&gt; captor = ArgumentCaptor.forClass(String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(logger).debug(captor.capture());

    assertThat(captor.getValue()).startsWith(<span class="hljs-string">"Message discarded; no listener:"</span>);

    <span class="hljs-comment">// end INT-3652</span>

    assertThat(conn1.toString()).isEqualTo(<span class="hljs-string">"Cached:"</span> + mockConn1.toString());

    conn1.close();

    conn1 = cachingFactory.getConnection();

    assertThat(conn1.toString()).isEqualTo(<span class="hljs-string">"Cached:"</span> + mockConn1.toString());

    TcpConnection conn2 = cachingFactory.getConnection();

    assertThat(conn2.toString()).isEqualTo(<span class="hljs-string">"Cached:"</span> + mockConn2.toString());

    conn1.close();

    conn2.close();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AbstractClientConnectionFactory <span class="hljs-title">createMockAbstractClientConnectionFactory</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isRunningReturn)</span> </span>{
    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.isRunning()).thenReturn(isRunningReturn);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest672">Test Case ID #spring-integration_Test_67_2</h4>
<h4 id="test-case-name-testreusenolimitfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectioncachingclientconnectionfactorytestsjava">Test Case Name: <code>testReuseNoLimit</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\CachingClientConnectionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-factory">Mock Object Variable Name: <code>factory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testReuseNoLimit() throws Exception {
<span class="hljs-deletion">-    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory.class);</span>
<span class="hljs-deletion">-    when(factory.isRunning()).thenReturn(true);</span>
<span class="hljs-addition">+    AbstractClientConnectionFactory factory = createMockAbstractClientConnectionFactory(true);</span>
    TcpConnectionSupport mockConn1 = makeMockConnection("conn1");
    TcpConnectionSupport mockConn2 = makeMockConnection("conn2");
    when(factory.getConnection()).thenReturn(mockConn1).thenReturn(mockConn2);
    CachingClientConnectionFactory cachingFactory = new CachingClientConnectionFactory(factory, 0);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testReuseNoLimit</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factory.isRunning()).thenReturn(<span class="hljs-keyword">true</span>);

    TcpConnectionSupport mockConn1 = makeMockConnection(<span class="hljs-string">"conn1"</span>);

    TcpConnectionSupport mockConn2 = makeMockConnection(<span class="hljs-string">"conn2"</span>);

    when(factory.getConnection()).thenReturn(mockConn1).thenReturn(mockConn2);

    CachingClientConnectionFactory cachingFactory = <span class="hljs-keyword">new</span> CachingClientConnectionFactory(factory, <span class="hljs-number">0</span>);

    cachingFactory.start();

    TcpConnection conn1 = cachingFactory.getConnection();

    assertThat(conn1.toString()).isEqualTo(<span class="hljs-string">"Cached:"</span> + mockConn1.toString());

    conn1.close();

    conn1 = cachingFactory.getConnection();

    assertThat(conn1.toString()).isEqualTo(<span class="hljs-string">"Cached:"</span> + mockConn1.toString());

    TcpConnection conn2 = cachingFactory.getConnection();

    assertThat(conn2.toString()).isEqualTo(<span class="hljs-string">"Cached:"</span> + mockConn2.toString());

    conn1.close();

    conn2.close();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AbstractClientConnectionFactory <span class="hljs-title">createMockAbstractClientConnectionFactory</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isRunningReturn)</span> </span>{
    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.isRunning()).thenReturn(isRunningReturn);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest673">Test Case ID #spring-integration_Test_67_3</h4>
<h4 id="test-case-name-testreuseclosedfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectioncachingclientconnectionfactorytestsjava">Test Case Name: <code>testReuseClosed</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\CachingClientConnectionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-factory">Mock Object Variable Name: <code>factory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testReuseClosed() throws Exception {
<span class="hljs-deletion">-    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory.class);</span>
<span class="hljs-deletion">-    when(factory.isRunning()).thenReturn(true);</span>
<span class="hljs-addition">+    AbstractClientConnectionFactory factory = createMockAbstractClientConnectionFactory(true);</span>
    TcpConnectionSupport mockConn1 = makeMockConnection("conn1");
    TcpConnectionSupport mockConn2 = makeMockConnection("conn2");
    doAnswer(invocation -&gt; null).when(mockConn1).close();
    when(factory.getConnection()).thenReturn(mockConn1).thenReturn(mockConn2).thenReturn(mockConn1).thenReturn(mockConn2);
    CachingClientConnectionFactory cachingFactory = new CachingClientConnectionFactory(factory, 2);
    cachingFactory.start();
    TcpConnection conn1 = cachingFactory.getConnection();
    assertThat(conn1.toString()).isEqualTo("Cached:" + mockConn1.toString());
    conn1.close();
    conn1 = cachingFactory.getConnection();
    assertThat(conn1.toString()).isEqualTo("Cached:" + mockConn1.toString());
    TcpConnection conn2 = cachingFactory.getConnection();
    assertThat(conn2.toString()).isEqualTo("Cached:" + mockConn2.toString());
    conn1.close();
    conn2.close();
    when(mockConn1.isOpen()).thenReturn(false);
    TcpConnection conn2a = cachingFactory.getConnection();
    assertThat(conn2a.toString()).isEqualTo("Cached:" + mockConn2.toString());
    assertThat(TestUtils.getPropertyValue(conn2a, "theConnection")).isSameAs(TestUtils.getPropertyValue(conn2, "theConnection"));
    conn2a.close();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testReuseClosed</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factory.isRunning()).thenReturn(<span class="hljs-keyword">true</span>);

    TcpConnectionSupport mockConn1 = makeMockConnection(<span class="hljs-string">"conn1"</span>);

    TcpConnectionSupport mockConn2 = makeMockConnection(<span class="hljs-string">"conn2"</span>);

    doAnswer(invocation -&gt; <span class="hljs-keyword">null</span>).when(mockConn1).close();

    when(factory.getConnection()).thenReturn(mockConn1).thenReturn(mockConn2).thenReturn(mockConn1).thenReturn(mockConn2);

    CachingClientConnectionFactory cachingFactory = <span class="hljs-keyword">new</span> CachingClientConnectionFactory(factory, <span class="hljs-number">2</span>);

    cachingFactory.start();

    TcpConnection conn1 = cachingFactory.getConnection();

    assertThat(conn1.toString()).isEqualTo(<span class="hljs-string">"Cached:"</span> + mockConn1.toString());

    conn1.close();

    conn1 = cachingFactory.getConnection();

    assertThat(conn1.toString()).isEqualTo(<span class="hljs-string">"Cached:"</span> + mockConn1.toString());

    TcpConnection conn2 = cachingFactory.getConnection();

    assertThat(conn2.toString()).isEqualTo(<span class="hljs-string">"Cached:"</span> + mockConn2.toString());

    conn1.close();

    conn2.close();

    when(mockConn1.isOpen()).thenReturn(<span class="hljs-keyword">false</span>);

    TcpConnection conn2a = cachingFactory.getConnection();

    assertThat(conn2a.toString()).isEqualTo(<span class="hljs-string">"Cached:"</span> + mockConn2.toString());

    assertThat(TestUtils.getPropertyValue(conn2a, <span class="hljs-string">"theConnection"</span>)).isSameAs(TestUtils.getPropertyValue(conn2, <span class="hljs-string">"theConnection"</span>));

    conn2a.close();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AbstractClientConnectionFactory <span class="hljs-title">createMockAbstractClientConnectionFactory</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isRunningReturn)</span> </span>{
    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.isRunning()).thenReturn(isRunningReturn);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest674">Test Case ID #spring-integration_Test_67_4</h4>
<h4 id="test-case-name-testlimitfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectioncachingclientconnectionfactorytestsjava">Test Case Name: <code>testLimit</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\CachingClientConnectionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-factory">Mock Object Variable Name: <code>factory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testLimit() throws Exception {
<span class="hljs-deletion">-    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory.class);</span>
<span class="hljs-deletion">-    when(factory.isRunning()).thenReturn(true);</span>
<span class="hljs-addition">+    AbstractClientConnectionFactory factory = createMockAbstractClientConnectionFactory(true);</span>
     TcpConnectionSupport mockConn1 = makeMockConnection("conn1");
     TcpConnectionSupport mockConn2 = makeMockConnection("conn2");
     when(factory.getConnection()).thenReturn(mockConn1).thenReturn(mockConn2);
     CachingClientConnectionFactory cachingFactory = new CachingClientConnectionFactory(factory, 2);
     cachingFactory.setConnectionWaitTimeout(10);
     cachingFactory.start();
     TcpConnection conn1 = cachingFactory.getConnection();
     assertThat(conn1.toString()).isEqualTo("Cached:" + mockConn1.toString());
     conn1.close();
     conn1 = cachingFactory.getConnection();
     assertThat(conn1.toString()).isEqualTo("Cached:" + mockConn1.toString());
     TcpConnection conn2 = cachingFactory.getConnection();
     assertThat(conn2.toString()).isEqualTo("Cached:" + mockConn2.toString());
     assertThatExceptionOfType(PoolItemNotAvailableException.class).isThrownBy(cachingFactory::getConnection);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLimit</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factory.isRunning()).thenReturn(<span class="hljs-keyword">true</span>);

    TcpConnectionSupport mockConn1 = makeMockConnection(<span class="hljs-string">"conn1"</span>);

    TcpConnectionSupport mockConn2 = makeMockConnection(<span class="hljs-string">"conn2"</span>);

    when(factory.getConnection()).thenReturn(mockConn1).thenReturn(mockConn2);

    CachingClientConnectionFactory cachingFactory = <span class="hljs-keyword">new</span> CachingClientConnectionFactory(factory, <span class="hljs-number">2</span>);

    cachingFactory.setConnectionWaitTimeout(<span class="hljs-number">10</span>);

    cachingFactory.start();

    TcpConnection conn1 = cachingFactory.getConnection();

    assertThat(conn1.toString()).isEqualTo(<span class="hljs-string">"Cached:"</span> + mockConn1.toString());

    conn1.close();

    conn1 = cachingFactory.getConnection();

    assertThat(conn1.toString()).isEqualTo(<span class="hljs-string">"Cached:"</span> + mockConn1.toString());

    TcpConnection conn2 = cachingFactory.getConnection();

    assertThat(conn2.toString()).isEqualTo(<span class="hljs-string">"Cached:"</span> + mockConn2.toString());

    assertThatExceptionOfType(PoolItemNotAvailableException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(<span class="hljs-title">cachingFactory</span>::<span class="hljs-title">getConnection</span>)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AbstractClientConnectionFactory <span class="hljs-title">createMockAbstractClientConnectionFactory</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isRunningReturn)</span> </span>{
    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.isRunning()).thenReturn(isRunningReturn);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest675">Test Case ID #spring-integration_Test_67_5</h4>
<h4 id="test-case-name-teststopfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectioncachingclientconnectionfactorytestsjava">Test Case Name: <code>testStop</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\CachingClientConnectionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-factory">Mock Object Variable Name: <code>factory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testStop() throws Exception {
<span class="hljs-deletion">-    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory.class);</span>
<span class="hljs-deletion">-    when(factory.isRunning()).thenReturn(true);</span>
<span class="hljs-addition">+    AbstractClientConnectionFactory factory = createMockAbstractClientConnectionFactory(true);</span>
     TcpConnectionSupport mockConn1 = makeMockConnection("conn1");
     TcpConnectionSupport mockConn2 = makeMockConnection("conn2");
     int i = 3;
     when(factory.getConnection()).thenReturn(mockConn1).thenReturn(mockConn2).thenReturn(makeMockConnection("conn" + (i++)));
     CachingClientConnectionFactory cachingFactory = new CachingClientConnectionFactory(factory, 2);
     cachingFactory.start();
     TcpConnection conn1 = cachingFactory.getConnection();
     assertThat(conn1.toString()).isEqualTo("Cached:" + mockConn1.toString());
     conn1.close();
     conn1 = cachingFactory.getConnection();
     assertThat(conn1.toString()).isEqualTo("Cached:" + mockConn1.toString());
     TcpConnection conn2 = cachingFactory.getConnection();
     assertThat(conn2.toString()).isEqualTo("Cached:" + mockConn2.toString());
     cachingFactory.stop();
     Answer&lt;Object&gt; answer = invocation -&gt; null;
     doAnswer(answer).when(mockConn1).close();
     doAnswer(answer).when(mockConn2).close();
     when(factory.isRunning()).thenReturn(false);
     conn1.close();
     conn2.close();
     verify(mockConn1).close();
     verify(mockConn2).close();
     when(mockConn1.isOpen()).thenReturn(false);
     when(mockConn2.isOpen()).thenReturn(false);
     when(factory.isRunning()).thenReturn(true);
     TcpConnection conn3 = cachingFactory.getConnection();
     assertThat(TestUtils.getPropertyValue(conn3, "theConnection")).isNotSameAs(TestUtils.getPropertyValue(conn1, "theConnection"));
     assertThat(TestUtils.getPropertyValue(conn3, "theConnection")).isNotSameAs(TestUtils.getPropertyValue(conn2, "theConnection"));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStop</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factory.isRunning()).thenReturn(<span class="hljs-keyword">true</span>);

    TcpConnectionSupport mockConn1 = makeMockConnection(<span class="hljs-string">"conn1"</span>);

    TcpConnectionSupport mockConn2 = makeMockConnection(<span class="hljs-string">"conn2"</span>);

    <span class="hljs-keyword">int</span> i = <span class="hljs-number">3</span>;

    when(factory.getConnection()).thenReturn(mockConn1).thenReturn(mockConn2).thenReturn(makeMockConnection(<span class="hljs-string">"conn"</span> + (i++)));

    CachingClientConnectionFactory cachingFactory = <span class="hljs-keyword">new</span> CachingClientConnectionFactory(factory, <span class="hljs-number">2</span>);

    cachingFactory.start();

    TcpConnection conn1 = cachingFactory.getConnection();

    assertThat(conn1.toString()).isEqualTo(<span class="hljs-string">"Cached:"</span> + mockConn1.toString());

    conn1.close();

    conn1 = cachingFactory.getConnection();

    assertThat(conn1.toString()).isEqualTo(<span class="hljs-string">"Cached:"</span> + mockConn1.toString());

    TcpConnection conn2 = cachingFactory.getConnection();

    assertThat(conn2.toString()).isEqualTo(<span class="hljs-string">"Cached:"</span> + mockConn2.toString());

    cachingFactory.stop();

    Answer&lt;Object&gt; answer = invocation -&gt; <span class="hljs-keyword">null</span>;

    doAnswer(answer).when(mockConn1).close();

    doAnswer(answer).when(mockConn2).close();

    when(factory.isRunning()).thenReturn(<span class="hljs-keyword">false</span>);

    conn1.close();

    conn2.close();

    verify(mockConn1).close();

    verify(mockConn2).close();

    when(mockConn1.isOpen()).thenReturn(<span class="hljs-keyword">false</span>);

    when(mockConn2.isOpen()).thenReturn(<span class="hljs-keyword">false</span>);

    when(factory.isRunning()).thenReturn(<span class="hljs-keyword">true</span>);

    TcpConnection conn3 = cachingFactory.getConnection();

    assertThat(TestUtils.getPropertyValue(conn3, <span class="hljs-string">"theConnection"</span>)).isNotSameAs(TestUtils.getPropertyValue(conn1, <span class="hljs-string">"theConnection"</span>));

    assertThat(TestUtils.getPropertyValue(conn3, <span class="hljs-string">"theConnection"</span>)).isNotSameAs(TestUtils.getPropertyValue(conn2, <span class="hljs-string">"theConnection"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AbstractClientConnectionFactory <span class="hljs-title">createMockAbstractClientConnectionFactory</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isRunningReturn)</span> </span>{
    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.isRunning()).thenReturn(isRunningReturn);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest676">Test Case ID #spring-integration_Test_67_6</h4>
<h4 id="test-case-name-testenlargepoolfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectioncachingclientconnectionfactorytestsjava">Test Case Name: <code>testEnlargePool</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\CachingClientConnectionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-factory">Mock Object Variable Name: <code>factory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testEnlargePool() throws Exception {
<span class="hljs-deletion">-    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory.class);</span>
<span class="hljs-deletion">-    when(factory.isRunning()).thenReturn(true);</span>
<span class="hljs-addition">+    AbstractClientConnectionFactory factory = createMockAbstractClientConnectionFactory(true);</span>
     TcpConnectionSupport mockConn1 = makeMockConnection("conn1");
     TcpConnectionSupport mockConn2 = makeMockConnection("conn2");
     TcpConnectionSupport mockConn3 = makeMockConnection("conn3");
     TcpConnectionSupport mockConn4 = makeMockConnection("conn4");
     when(factory.getConnection()).thenReturn(mockConn1, mockConn2, mockConn3, mockConn4);
     CachingClientConnectionFactory cachingFactory = new CachingClientConnectionFactory(factory, 2);
     cachingFactory.start();
     TcpConnection conn1 = cachingFactory.getConnection();
     TcpConnection conn2 = cachingFactory.getConnection();
     assertThat(conn2).isNotSameAs(conn1);
     Semaphore semaphore = TestUtils.getPropertyValue(TestUtils.getPropertyValue(cachingFactory, "pool"), "permits", Semaphore.class);
     assertThat(semaphore.availablePermits()).isEqualTo(0);
     cachingFactory.setPoolSize(4);
     TcpConnection conn3 = cachingFactory.getConnection();
     TcpConnection conn4 = cachingFactory.getConnection();
     assertThat(semaphore.availablePermits()).isEqualTo(0);
     conn1.close();
     conn1.close();
     conn2.close();
     conn3.close();
     conn4.close();
     assertThat(semaphore.availablePermits()).isEqualTo(4);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testEnlargePool</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factory.isRunning()).thenReturn(<span class="hljs-keyword">true</span>);

    TcpConnectionSupport mockConn1 = makeMockConnection(<span class="hljs-string">"conn1"</span>);

    TcpConnectionSupport mockConn2 = makeMockConnection(<span class="hljs-string">"conn2"</span>);

    TcpConnectionSupport mockConn3 = makeMockConnection(<span class="hljs-string">"conn3"</span>);

    TcpConnectionSupport mockConn4 = makeMockConnection(<span class="hljs-string">"conn4"</span>);

    when(factory.getConnection()).thenReturn(mockConn1, mockConn2, mockConn3, mockConn4);

    CachingClientConnectionFactory cachingFactory = <span class="hljs-keyword">new</span> CachingClientConnectionFactory(factory, <span class="hljs-number">2</span>);

    cachingFactory.start();

    TcpConnection conn1 = cachingFactory.getConnection();

    TcpConnection conn2 = cachingFactory.getConnection();

    assertThat(conn2).isNotSameAs(conn1);

    Semaphore semaphore = TestUtils.getPropertyValue(TestUtils.getPropertyValue(cachingFactory, <span class="hljs-string">"pool"</span>), <span class="hljs-string">"permits"</span>, Semaphore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    assertThat(semaphore.availablePermits()).isEqualTo(<span class="hljs-number">0</span>);

    cachingFactory.setPoolSize(<span class="hljs-number">4</span>);

    TcpConnection conn3 = cachingFactory.getConnection();

    TcpConnection conn4 = cachingFactory.getConnection();

    assertThat(semaphore.availablePermits()).isEqualTo(<span class="hljs-number">0</span>);

    conn1.close();

    conn1.close();

    conn2.close();

    conn3.close();

    conn4.close();

    assertThat(semaphore.availablePermits()).isEqualTo(<span class="hljs-number">4</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AbstractClientConnectionFactory <span class="hljs-title">createMockAbstractClientConnectionFactory</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isRunningReturn)</span> </span>{
    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.isRunning()).thenReturn(isRunningReturn);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest677">Test Case ID #spring-integration_Test_67_7</h4>
<h4 id="test-case-name-testreducepoolfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectioncachingclientconnectionfactorytestsjava">Test Case Name: <code>testReducePool</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\CachingClientConnectionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-factory">Mock Object Variable Name: <code>factory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testReducePool() throws Exception {
<span class="hljs-deletion">-    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory.class);</span>
<span class="hljs-deletion">-    when(factory.isRunning()).thenReturn(true);</span>
<span class="hljs-addition">+    AbstractClientConnectionFactory factory = createMockAbstractClientConnectionFactory(true);</span>
     TcpConnectionSupport mockConn1 = makeMockConnection("conn1", true);
     TcpConnectionSupport mockConn2 = makeMockConnection("conn2", true);
     TcpConnectionSupport mockConn3 = makeMockConnection("conn3", true);
     TcpConnectionSupport mockConn4 = makeMockConnection("conn4", true);
     when(factory.getConnection()).thenReturn(mockConn1).thenReturn(mockConn2).thenReturn(mockConn3).thenReturn(mockConn4);
     CachingClientConnectionFactory cachingFactory = new CachingClientConnectionFactory(factory, 4);
     cachingFactory.start();
     TcpConnection conn1 = cachingFactory.getConnection();
     TcpConnection conn2 = cachingFactory.getConnection();
     TcpConnection conn3 = cachingFactory.getConnection();
     TcpConnection conn4 = cachingFactory.getConnection();
     Semaphore semaphore = TestUtils.getPropertyValue(TestUtils.getPropertyValue(cachingFactory, "pool"), "permits", Semaphore.class);
     assertThat(semaphore.availablePermits()).isEqualTo(0);
     conn1.close();
     assertThat(semaphore.availablePermits()).isEqualTo(1);
     cachingFactory.setPoolSize(2);
     assertThat(semaphore.availablePermits()).isEqualTo(0);
     assertThat(cachingFactory.getActiveCount()).isEqualTo(3);
     conn2.close();
     assertThat(semaphore.availablePermits()).isEqualTo(0);
     assertThat(cachingFactory.getActiveCount()).isEqualTo(2);
     conn3.close();
     assertThat(cachingFactory.getActiveCount()).isEqualTo(1);
     assertThat(cachingFactory.getIdleCount()).isEqualTo(1);
     conn4.close();
     assertThat(semaphore.availablePermits()).isEqualTo(2);
     assertThat(cachingFactory.getActiveCount()).isEqualTo(0);
     assertThat(cachingFactory.getIdleCount()).isEqualTo(2);
     verify(mockConn1).close();
     verify(mockConn2).close();
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testReducePool</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factory.isRunning()).thenReturn(<span class="hljs-keyword">true</span>);

    TcpConnectionSupport mockConn1 = makeMockConnection(<span class="hljs-string">"conn1"</span>, <span class="hljs-keyword">true</span>);

    TcpConnectionSupport mockConn2 = makeMockConnection(<span class="hljs-string">"conn2"</span>, <span class="hljs-keyword">true</span>);

    TcpConnectionSupport mockConn3 = makeMockConnection(<span class="hljs-string">"conn3"</span>, <span class="hljs-keyword">true</span>);

    TcpConnectionSupport mockConn4 = makeMockConnection(<span class="hljs-string">"conn4"</span>, <span class="hljs-keyword">true</span>);

    when(factory.getConnection()).thenReturn(mockConn1).thenReturn(mockConn2).thenReturn(mockConn3).thenReturn(mockConn4);

    CachingClientConnectionFactory cachingFactory = <span class="hljs-keyword">new</span> CachingClientConnectionFactory(factory, <span class="hljs-number">4</span>);

    cachingFactory.start();

    TcpConnection conn1 = cachingFactory.getConnection();

    TcpConnection conn2 = cachingFactory.getConnection();

    TcpConnection conn3 = cachingFactory.getConnection();

    TcpConnection conn4 = cachingFactory.getConnection();

    Semaphore semaphore = TestUtils.getPropertyValue(TestUtils.getPropertyValue(cachingFactory, <span class="hljs-string">"pool"</span>), <span class="hljs-string">"permits"</span>, Semaphore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    assertThat(semaphore.availablePermits()).isEqualTo(<span class="hljs-number">0</span>);

    conn1.close();

    assertThat(semaphore.availablePermits()).isEqualTo(<span class="hljs-number">1</span>);

    cachingFactory.setPoolSize(<span class="hljs-number">2</span>);

    assertThat(semaphore.availablePermits()).isEqualTo(<span class="hljs-number">0</span>);

    assertThat(cachingFactory.getActiveCount()).isEqualTo(<span class="hljs-number">3</span>);

    conn2.close();

    assertThat(semaphore.availablePermits()).isEqualTo(<span class="hljs-number">0</span>);

    assertThat(cachingFactory.getActiveCount()).isEqualTo(<span class="hljs-number">2</span>);

    conn3.close();

    assertThat(cachingFactory.getActiveCount()).isEqualTo(<span class="hljs-number">1</span>);

    assertThat(cachingFactory.getIdleCount()).isEqualTo(<span class="hljs-number">1</span>);

    conn4.close();

    assertThat(semaphore.availablePermits()).isEqualTo(<span class="hljs-number">2</span>);

    assertThat(cachingFactory.getActiveCount()).isEqualTo(<span class="hljs-number">0</span>);

    assertThat(cachingFactory.getIdleCount()).isEqualTo(<span class="hljs-number">2</span>);

    verify(mockConn1).close();

    verify(mockConn2).close();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AbstractClientConnectionFactory <span class="hljs-title">createMockAbstractClientConnectionFactory</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isRunningReturn)</span> </span>{
    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.isRunning()).thenReturn(isRunningReturn);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci68">Mock Clone Instance #spring-integration_MCI_68</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.ip.tcp.connection.AbstractClientConnectionFactory</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 6</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AbstractClientConnectionFactory <span class="hljs-title">createMockAbstractClientConnectionFactory</span><span class="hljs-params">()</span> </span>{
    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.isActive()).thenReturn(<span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest681">Test Case ID #spring-integration_Test_68_1</h4>
<h4 id="test-case-name-testrefreshsharedfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionfailoverclientconnectionfactorytestsjava">Test Case Name: <code>testRefreshShared</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\FailoverClientConnectionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-factory1">Mock Object Variable Name: <code>factory1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
<span class="hljs-deletion">-    AbstractClientConnectionFactory factory1 = mock(AbstractClientConnectionFactory.class);</span>
<span class="hljs-addition">+    AbstractClientConnectionFactory factory1 = createMockAbstractClientConnectionFactory();</span>
     AbstractClientConnectionFactory factory2 = mock(AbstractClientConnectionFactory.class);
     List&lt;AbstractClientConnectionFactory&gt; factories = new ArrayList&lt;&gt;();
     factories.add(factory1);
     factories.add(factory2);
     TcpConnectionSupport conn1 = makeMockConnection();
     doReturn("conn1").when(conn1).getConnectionId();
     TcpConnectionSupport conn2 = makeMockConnection();
     doReturn("conn2").when(conn2).getConnectionId();
     doThrow(new UncheckedIOException(new IOException("fail"))).when(factory1).getConnection();
     if (closeOnRefresh) {
         when(factory2.getConnection()).thenReturn(conn1, conn2);
     } else {
         when(factory2.getConnection()).thenReturn(conn1);
     }
<span class="hljs-deletion">-    when(factory1.isActive()).thenReturn(true);</span>
     when(factory2.isActive()).thenReturn(true);
     FailoverClientConnectionFactory failoverFactory = new FailoverClientConnectionFactory(factories);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRefreshShared</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> closeOnRefresh, <span class="hljs-keyword">long</span> interval)</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractClientConnectionFactory factory1 = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AbstractClientConnectionFactory factory2 = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;AbstractClientConnectionFactory&gt; factories = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    factories.add(factory1);

    factories.add(factory2);

    TcpConnectionSupport conn1 = makeMockConnection();

    doReturn(<span class="hljs-string">"conn1"</span>).when(conn1).getConnectionId();

    TcpConnectionSupport conn2 = makeMockConnection();

    doReturn(<span class="hljs-string">"conn2"</span>).when(conn2).getConnectionId();

    doThrow(<span class="hljs-keyword">new</span> UncheckedIOException(<span class="hljs-keyword">new</span> IOException(<span class="hljs-string">"fail"</span>))).when(factory1).getConnection();

    <span class="hljs-keyword">if</span> (closeOnRefresh) {

        when(factory2.getConnection()).thenReturn(conn1, conn2);

    } <span class="hljs-keyword">else</span> {

        when(factory2.getConnection()).thenReturn(conn1);

    }

    when(factory1.isActive()).thenReturn(<span class="hljs-keyword">true</span>);

    when(factory2.isActive()).thenReturn(<span class="hljs-keyword">true</span>);

    FailoverClientConnectionFactory failoverFactory = <span class="hljs-keyword">new</span> FailoverClientConnectionFactory(factories);

    failoverFactory.setCloseOnRefresh(closeOnRefresh);

    failoverFactory.start();

    TcpConnectionSupport connection = failoverFactory.getConnection();

    assertThat(TestUtils.getPropertyValue(failoverFactory, <span class="hljs-string">"theConnection"</span>)).isNotNull();

    failoverFactory.setRefreshSharedInterval(interval);

    InOrder inOrder = inOrder(factory1, factory2, conn1, conn2);

    inOrder.verify(factory1).getConnection();

    inOrder.verify(factory2).getConnection();

    inOrder.verify(conn1).registerListener(any());

    inOrder.verify(conn1).isOpen();

    assertThat(failoverFactory.getConnection()).isSameAs(connection);

    inOrder.verifyNoMoreInteractions();

    failoverFactory.setRefreshSharedInterval(-<span class="hljs-number">1</span>);

    assertThat(failoverFactory.getConnection()).isNotSameAs(connection);

    inOrder.verify(factory1).getConnection();

    inOrder.verify(factory2).getConnection();

    <span class="hljs-keyword">if</span> (closeOnRefresh) {

        inOrder.verify(conn2).registerListener(any());

        inOrder.verify(conn2).isOpen();

        inOrder.verify(conn1).close();

    } <span class="hljs-keyword">else</span> {

        inOrder.verify(conn1).registerListener(any());

        inOrder.verify(conn1).isOpen();

        inOrder.verify(conn1, never()).close();

    }

    inOrder.verifyNoMoreInteractions();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AbstractClientConnectionFactory <span class="hljs-title">createMockAbstractClientConnectionFactory</span><span class="hljs-params">()</span> </span>{
    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.isActive()).thenReturn(<span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest682">Test Case ID #spring-integration_Test_68_2</h4>
<h4 id="test-case-name-testrefreshsharedfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionfailoverclientconnectionfactorytestsjava">Test Case Name: <code>testRefreshShared</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\FailoverClientConnectionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-factory2">Mock Object Variable Name: <code>factory2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
     AbstractClientConnectionFactory factory1 = mock(AbstractClientConnectionFactory.class);
<span class="hljs-deletion">-    AbstractClientConnectionFactory factory2 = mock(AbstractClientConnectionFactory.class);</span>
<span class="hljs-addition">+    AbstractClientConnectionFactory factory2 = createMockAbstractClientConnectionFactory();</span>
     List&lt;AbstractClientConnectionFactory&gt; factories = new ArrayList&lt;&gt;();
     factories.add(factory1);
     factories.add(factory2);
     TcpConnectionSupport conn1 = makeMockConnection();
     doReturn("conn1").when(conn1).getConnectionId();
     TcpConnectionSupport conn2 = makeMockConnection();
     doReturn("conn2").when(conn2).getConnectionId();
     doThrow(new UncheckedIOException(new IOException("fail"))).when(factory1).getConnection();
     if (closeOnRefresh) {
         when(factory2.getConnection()).thenReturn(conn1, conn2);
     } else {
         when(factory2.getConnection()).thenReturn(conn1);
     }
<span class="hljs-deletion">-    when(factory1.isActive()).thenReturn(true);</span>
<span class="hljs-deletion">-    when(factory2.isActive()).thenReturn(true);</span>
<span class="hljs-addition">+    when(factory1.isActive()).thenReturn(true);</span>
     FailoverClientConnectionFactory failoverFactory = new FailoverClientConnectionFactory(factories);
     failoverFactory.setCloseOnRefresh(closeOnRefresh);
     failoverFactory.start();
     TcpConnectionSupport connection = failoverFactory.getConnection();
     assertThat(TestUtils.getPropertyValue(failoverFactory, "theConnection")).isNotNull();
     failoverFactory.setRefreshSharedInterval(interval);
     InOrder inOrder = inOrder(factory1, factory2, conn1, conn2);
     inOrder.verify(factory1).getConnection();
     inOrder.verify(factory2).getConnection();
     inOrder.verify(conn1).registerListener(any());
     inOrder.verify(conn1).isOpen();
     assertThat(failoverFactory.getConnection()).isSameAs(connection);
     inOrder.verifyNoMoreInteractions();
     failoverFactory.setRefreshSharedInterval(-1);
     assertThat(failoverFactory.getConnection()).isNotSameAs(connection);
     inOrder.verify(factory1).getConnection();
     inOrder.verify(factory2).getConnection();
     if (closeOnRefresh) {
         inOrder.verify(conn2).registerListener(any());
         inOrder.verify(conn2).isOpen();
         inOrder.verify(conn1).close();
     } else {
         inOrder.verify(conn1).registerListener(any());
         inOrder.verify(conn1).isOpen();
         inOrder.verify(conn1, never()).close();
     }
     inOrder.verifyNoMoreInteractions();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRefreshShared</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> closeOnRefresh, <span class="hljs-keyword">long</span> interval)</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractClientConnectionFactory factory1 = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AbstractClientConnectionFactory factory2 = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;AbstractClientConnectionFactory&gt; factories = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    factories.add(factory1);

    factories.add(factory2);

    TcpConnectionSupport conn1 = makeMockConnection();

    doReturn(<span class="hljs-string">"conn1"</span>).when(conn1).getConnectionId();

    TcpConnectionSupport conn2 = makeMockConnection();

    doReturn(<span class="hljs-string">"conn2"</span>).when(conn2).getConnectionId();

    doThrow(<span class="hljs-keyword">new</span> UncheckedIOException(<span class="hljs-keyword">new</span> IOException(<span class="hljs-string">"fail"</span>))).when(factory1).getConnection();

    <span class="hljs-keyword">if</span> (closeOnRefresh) {

        when(factory2.getConnection()).thenReturn(conn1, conn2);

    } <span class="hljs-keyword">else</span> {

        when(factory2.getConnection()).thenReturn(conn1);

    }

    when(factory1.isActive()).thenReturn(<span class="hljs-keyword">true</span>);

    when(factory2.isActive()).thenReturn(<span class="hljs-keyword">true</span>);

    FailoverClientConnectionFactory failoverFactory = <span class="hljs-keyword">new</span> FailoverClientConnectionFactory(factories);

    failoverFactory.setCloseOnRefresh(closeOnRefresh);

    failoverFactory.start();

    TcpConnectionSupport connection = failoverFactory.getConnection();

    assertThat(TestUtils.getPropertyValue(failoverFactory, <span class="hljs-string">"theConnection"</span>)).isNotNull();

    failoverFactory.setRefreshSharedInterval(interval);

    InOrder inOrder = inOrder(factory1, factory2, conn1, conn2);

    inOrder.verify(factory1).getConnection();

    inOrder.verify(factory2).getConnection();

    inOrder.verify(conn1).registerListener(any());

    inOrder.verify(conn1).isOpen();

    assertThat(failoverFactory.getConnection()).isSameAs(connection);

    inOrder.verifyNoMoreInteractions();

    failoverFactory.setRefreshSharedInterval(-<span class="hljs-number">1</span>);

    assertThat(failoverFactory.getConnection()).isNotSameAs(connection);

    inOrder.verify(factory1).getConnection();

    inOrder.verify(factory2).getConnection();

    <span class="hljs-keyword">if</span> (closeOnRefresh) {

        inOrder.verify(conn2).registerListener(any());

        inOrder.verify(conn2).isOpen();

        inOrder.verify(conn1).close();

    } <span class="hljs-keyword">else</span> {

        inOrder.verify(conn1).registerListener(any());

        inOrder.verify(conn1).isOpen();

        inOrder.verify(conn1, never()).close();

    }

    inOrder.verifyNoMoreInteractions();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AbstractClientConnectionFactory <span class="hljs-title">createMockAbstractClientConnectionFactory</span><span class="hljs-params">()</span> </span>{
    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.isActive()).thenReturn(<span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest683">Test Case ID #spring-integration_Test_68_3</h4>
<h4 id="test-case-name-testfailoverconnectnonefile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionfailoverclientconnectionfactorytestsjava">Test Case Name: <code>testFailoverConnectNone</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\FailoverClientConnectionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-factory1">Mock Object Variable Name: <code>factory1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testFailoverConnectNone() throws Exception {
<span class="hljs-deletion">-    AbstractClientConnectionFactory factory1 = mock(AbstractClientConnectionFactory.class);</span>
<span class="hljs-addition">+    AbstractClientConnectionFactory factory1 = createMockAbstractClientConnectionFactory();</span>
     AbstractClientConnectionFactory factory2 = mock(AbstractClientConnectionFactory.class);
     List&lt;AbstractClientConnectionFactory&gt; factories = new ArrayList&lt;&gt;();
     factories.add(factory1);
     factories.add(factory2);
<span class="hljs-deletion">-    when(factory1.getConnection()).thenThrow(new UncheckedIOException(new IOException("fail")));</span>
     when(factory2.getConnection()).thenThrow(new UncheckedIOException(new IOException("fail")));
<span class="hljs-deletion">-    when(factory1.isActive()).thenReturn(true);</span>
     when(factory2.isActive()).thenReturn(true);
     FailoverClientConnectionFactory failoverFactory = new FailoverClientConnectionFactory(factories);
     failoverFactory.start();
     GenericMessage&lt;String&gt; message = new GenericMessage&lt;&gt;("foo");
     assertThatExceptionOfType(UncheckedIOException.class).isThrownBy(() -&gt; failoverFactory.getConnection().send(message));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFailoverConnectNone</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractClientConnectionFactory factory1 = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AbstractClientConnectionFactory factory2 = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;AbstractClientConnectionFactory&gt; factories = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    factories.add(factory1);

    factories.add(factory2);

    when(factory1.getConnection()).thenThrow(<span class="hljs-keyword">new</span> UncheckedIOException(<span class="hljs-keyword">new</span> IOException(<span class="hljs-string">"fail"</span>)));

    when(factory2.getConnection()).thenThrow(<span class="hljs-keyword">new</span> UncheckedIOException(<span class="hljs-keyword">new</span> IOException(<span class="hljs-string">"fail"</span>)));

    when(factory1.isActive()).thenReturn(<span class="hljs-keyword">true</span>);

    when(factory2.isActive()).thenReturn(<span class="hljs-keyword">true</span>);

    FailoverClientConnectionFactory failoverFactory = <span class="hljs-keyword">new</span> FailoverClientConnectionFactory(factories);

    failoverFactory.start();

    GenericMessage&lt;String&gt; message = <span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>);

    assertThatExceptionOfType(UncheckedIOException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(() -&gt; <span class="hljs-title">failoverFactory</span>.<span class="hljs-title">getConnection</span>().<span class="hljs-title">send</span>(<span class="hljs-title">message</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AbstractClientConnectionFactory <span class="hljs-title">createMockAbstractClientConnectionFactory</span><span class="hljs-params">()</span> </span>{
    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.isActive()).thenReturn(<span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest684">Test Case ID #spring-integration_Test_68_4</h4>
<h4 id="test-case-name-testfailoverconnectnonefile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionfailoverclientconnectionfactorytestsjava">Test Case Name: <code>testFailoverConnectNone</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\FailoverClientConnectionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-factory2">Mock Object Variable Name: <code>factory2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
     AbstractClientConnectionFactory factory1 = mock(AbstractClientConnectionFactory.class);
<span class="hljs-deletion">-    AbstractClientConnectionFactory factory2 = mock(AbstractClientConnectionFactory.class);</span>
<span class="hljs-addition">+    AbstractClientConnectionFactory factory2 = createMockAbstractClientConnectionFactory();</span>
     List&lt;AbstractClientConnectionFactory&gt; factories = new ArrayList&lt;&gt;();
     factories.add(factory1);
     factories.add(factory2);
     when(factory1.getConnection()).thenThrow(new UncheckedIOException(new IOException("fail")));
<span class="hljs-deletion">-    when(factory2.getConnection()).thenThrow(new UncheckedIOException(new IOException("fail")));</span>
     when(factory1.isActive()).thenReturn(true);
<span class="hljs-deletion">-    when(factory2.isActive()).thenReturn(true);</span>
     FailoverClientConnectionFactory failoverFactory = new FailoverClientConnectionFactory(factories);
     failoverFactory.start();
     GenericMessage&lt;String&gt; message = new GenericMessage&lt;&gt;("foo");
     assertThatExceptionOfType(UncheckedIOException.class).isThrownBy(() -&gt; failoverFactory.getConnection().send(message));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFailoverConnectNone</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractClientConnectionFactory factory1 = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AbstractClientConnectionFactory factory2 = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;AbstractClientConnectionFactory&gt; factories = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    factories.add(factory1);

    factories.add(factory2);

    when(factory1.getConnection()).thenThrow(<span class="hljs-keyword">new</span> UncheckedIOException(<span class="hljs-keyword">new</span> IOException(<span class="hljs-string">"fail"</span>)));

    when(factory2.getConnection()).thenThrow(<span class="hljs-keyword">new</span> UncheckedIOException(<span class="hljs-keyword">new</span> IOException(<span class="hljs-string">"fail"</span>)));

    when(factory1.isActive()).thenReturn(<span class="hljs-keyword">true</span>);

    when(factory2.isActive()).thenReturn(<span class="hljs-keyword">true</span>);

    FailoverClientConnectionFactory failoverFactory = <span class="hljs-keyword">new</span> FailoverClientConnectionFactory(factories);

    failoverFactory.start();

    GenericMessage&lt;String&gt; message = <span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>);

    assertThatExceptionOfType(UncheckedIOException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(() -&gt; <span class="hljs-title">failoverFactory</span>.<span class="hljs-title">getConnection</span>().<span class="hljs-title">send</span>(<span class="hljs-title">message</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AbstractClientConnectionFactory <span class="hljs-title">createMockAbstractClientConnectionFactory</span><span class="hljs-params">()</span> </span>{
    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.isActive()).thenReturn(<span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest685">Test Case ID #spring-integration_Test_68_5</h4>
<h4 id="test-case-name-testfailoverconnecttofirstaftertriedallfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionfailoverclientconnectionfactorytestsjava">Test Case Name: <code>testFailoverConnectToFirstAfterTriedAll</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\FailoverClientConnectionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-factory1">Mock Object Variable Name: <code>factory1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testFailoverConnectToFirstAfterTriedAll() throws Exception {
<span class="hljs-deletion">-    AbstractClientConnectionFactory factory1 = mock(AbstractClientConnectionFactory.class);</span>
<span class="hljs-addition">+    AbstractClientConnectionFactory factory1 = createMockAbstractClientConnectionFactory();</span>
     AbstractClientConnectionFactory factory2 = mock(AbstractClientConnectionFactory.class);
     List&lt;AbstractClientConnectionFactory&gt; factories = new ArrayList&lt;&gt;();
     factories.add(factory1);
     factories.add(factory2);
     TcpConnectionSupport conn1 = makeMockConnection();
     doAnswer(invocation -&gt; null).when(conn1).send(Mockito.any(Message.class));
<span class="hljs-deletion">-    when(factory1.getConnection()).thenThrow(new UncheckedIOException(new IOException("fail"))).thenReturn(conn1);</span>
<span class="hljs-addition">+    when(factory1.getConnection()).thenThrow(new UncheckedIOException(new IOException("fail"))).thenReturn(conn1);</span>
     when(factory2.getConnection()).thenThrow(new UncheckedIOException(new IOException("fail")));
<span class="hljs-deletion">-    when(factory1.isActive()).thenReturn(true);</span>
     when(factory2.isActive()).thenReturn(true);
     FailoverClientConnectionFactory failoverFactory = new FailoverClientConnectionFactory(factories);
     failoverFactory.start();
     GenericMessage&lt;String&gt; message = new GenericMessage&lt;String&gt;("foo");
     failoverFactory.getConnection().send(message);
     Mockito.verify(conn1).send(message);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFailoverConnectToFirstAfterTriedAll</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractClientConnectionFactory factory1 = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AbstractClientConnectionFactory factory2 = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;AbstractClientConnectionFactory&gt; factories = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    factories.add(factory1);

    factories.add(factory2);

    TcpConnectionSupport conn1 = makeMockConnection();

    doAnswer(invocation -&gt; <span class="hljs-keyword">null</span>).when(conn1).send(Mockito.any(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    when(factory1.getConnection()).thenThrow(<span class="hljs-keyword">new</span> UncheckedIOException(<span class="hljs-keyword">new</span> IOException(<span class="hljs-string">"fail"</span>))).thenReturn(conn1);

    when(factory2.getConnection()).thenThrow(<span class="hljs-keyword">new</span> UncheckedIOException(<span class="hljs-keyword">new</span> IOException(<span class="hljs-string">"fail"</span>)));

    when(factory1.isActive()).thenReturn(<span class="hljs-keyword">true</span>);

    when(factory2.isActive()).thenReturn(<span class="hljs-keyword">true</span>);

    FailoverClientConnectionFactory failoverFactory = <span class="hljs-keyword">new</span> FailoverClientConnectionFactory(factories);

    failoverFactory.start();

    GenericMessage&lt;String&gt; message = <span class="hljs-keyword">new</span> GenericMessage&lt;String&gt;(<span class="hljs-string">"foo"</span>);

    failoverFactory.getConnection().send(message);

    Mockito.verify(conn1).send(message);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AbstractClientConnectionFactory <span class="hljs-title">createMockAbstractClientConnectionFactory</span><span class="hljs-params">()</span> </span>{
    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.isActive()).thenReturn(<span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest686">Test Case ID #spring-integration_Test_68_6</h4>
<h4 id="test-case-name-testfailoverconnecttofirstaftertriedallfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionfailoverclientconnectionfactorytestsjava">Test Case Name: <code>testFailoverConnectToFirstAfterTriedAll</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\FailoverClientConnectionFactoryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-factory2">Mock Object Variable Name: <code>factory2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    AbstractClientConnectionFactory factory1 = mock(AbstractClientConnectionFactory.class);
<span class="hljs-deletion">-    AbstractClientConnectionFactory factory2 = mock(AbstractClientConnectionFactory.class);</span>
<span class="hljs-addition">+    AbstractClientConnectionFactory factory2 = createMockAbstractClientConnectionFactory();</span>
    List&lt;AbstractClientConnectionFactory&gt; factories = new ArrayList&lt;&gt;();
    factories.add(factory1);
    factories.add(factory2);
    TcpConnectionSupport conn1 = makeMockConnection();
    doAnswer(invocation -&gt; null).when(conn1).send(Mockito.any(Message.class));
    when(factory1.getConnection()).thenThrow(new UncheckedIOException(new IOException("fail"))).thenReturn(conn1);
<span class="hljs-deletion">-    when(factory2.getConnection()).thenThrow(new UncheckedIOException(new IOException("fail")));</span>
<span class="hljs-addition">+    when(factory2.getConnection()).thenThrow(new UncheckedIOException(new IOException("fail")));</span>
    when(factory1.isActive()).thenReturn(true);
<span class="hljs-deletion">-    when(factory2.isActive()).thenReturn(true);</span>
    FailoverClientConnectionFactory failoverFactory = new FailoverClientConnectionFactory(factories);
    failoverFactory.start();
    GenericMessage&lt;String&gt; message = new GenericMessage&lt;String&gt;("foo");
    failoverFactory.getConnection().send(message);
    Mockito.verify(conn1).send(message);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFailoverConnectToFirstAfterTriedAll</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    AbstractClientConnectionFactory factory1 = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AbstractClientConnectionFactory factory2 = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;AbstractClientConnectionFactory&gt; factories = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    factories.add(factory1);

    factories.add(factory2);

    TcpConnectionSupport conn1 = makeMockConnection();

    doAnswer(invocation -&gt; <span class="hljs-keyword">null</span>).when(conn1).send(Mockito.any(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    when(factory1.getConnection()).thenThrow(<span class="hljs-keyword">new</span> UncheckedIOException(<span class="hljs-keyword">new</span> IOException(<span class="hljs-string">"fail"</span>))).thenReturn(conn1);

    when(factory2.getConnection()).thenThrow(<span class="hljs-keyword">new</span> UncheckedIOException(<span class="hljs-keyword">new</span> IOException(<span class="hljs-string">"fail"</span>)));

    when(factory1.isActive()).thenReturn(<span class="hljs-keyword">true</span>);

    when(factory2.isActive()).thenReturn(<span class="hljs-keyword">true</span>);

    FailoverClientConnectionFactory failoverFactory = <span class="hljs-keyword">new</span> FailoverClientConnectionFactory(factories);

    failoverFactory.start();

    GenericMessage&lt;String&gt; message = <span class="hljs-keyword">new</span> GenericMessage&lt;String&gt;(<span class="hljs-string">"foo"</span>);

    failoverFactory.getConnection().send(message);

    Mockito.verify(conn1).send(message);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AbstractClientConnectionFactory <span class="hljs-title">createMockAbstractClientConnectionFactory</span><span class="hljs-params">()</span> </span>{
    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.isActive()).thenReturn(<span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci69">Mock Clone Instance #spring-integration_MCI_69</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.integration.ip.tcp.connection.AbstractClientConnectionFactory</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AbstractClientConnectionFactory <span class="hljs-title">createMockAbstractClientConnectionFactory</span><span class="hljs-params">(TcpConnectionSupport connectionSupport)</span> </span>{
    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.getConnection()).thenReturn(connectionSupport);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest691">Test Case ID #spring-integration_Test_69_1</h4>
<h4 id="test-case-name-testcachingfailoverfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcptcpoutboundgatewaytestsjava">Test Case Name: <code>testCachingFailover</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\TcpOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-factory1">Mock Object Variable Name: <code>factory1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    assertThat(latch.await(10000, TimeUnit.MILLISECONDS)).isTrue();
    // Failover
<span class="hljs-deletion">-    AbstractClientConnectionFactory factory1 = mock(AbstractClientConnectionFactory.class);</span>
     TcpConnectionSupport mockConn1 = makeMockConnection();
<span class="hljs-deletion">-    when(factory1.getConnection()).thenReturn(mockConn1);</span>
<span class="hljs-addition">+    AbstractClientConnectionFactory factory1 = createMockAbstractClientConnectionFactory(mockConn1);</span>
     doThrow(new UncheckedIOException(new IOException("fail"))).when(mockConn1).send(any(Message.class));
     AbstractClientConnectionFactory factory2 = new TcpNetClientConnectionFactory("localhost", serverSocket.get().getLocalPort());
     factory2.setSerializer(new DefaultSerializer());
     factory2.setDeserializer(new DefaultDeserializer());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testCachingFailover</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-keyword">final</span> AtomicReference&lt;ServerSocket&gt; serverSocket = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    <span class="hljs-keyword">final</span> CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">final</span> AtomicBoolean done = <span class="hljs-keyword">new</span> AtomicBoolean();

    <span class="hljs-keyword">final</span> CountDownLatch serverLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">this</span>.executor.execute(() -&gt; {

        <span class="hljs-keyword">try</span> {

            ServerSocket server = ServerSocketFactory.getDefault().createServerSocket(<span class="hljs-number">0</span>);

            serverSocket.set(server);

            latch.countDown();

            <span class="hljs-keyword">while</span> (!done.get()) {

                Socket socket = server.accept();

                <span class="hljs-keyword">while</span> (!socket.isClosed()) {

                    <span class="hljs-keyword">try</span> {

                        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(socket.getInputStream());

                        String request = (String) ois.readObject();

                        logger.debug(<span class="hljs-string">"Read "</span> + request);

                        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(socket.getOutputStream());

                        oos.writeObject(<span class="hljs-string">"bar"</span>);

                        logger.debug(<span class="hljs-string">"Replied to "</span> + request);

                        serverLatch.countDown();

                    } <span class="hljs-keyword">catch</span> (IOException e1) {

                        logger.debug(<span class="hljs-string">"error on write "</span> + e1.getClass().getSimpleName());

                        socket.close();

                    }

                }

            }

        } <span class="hljs-keyword">catch</span> (Exception e2) {

            <span class="hljs-keyword">if</span> (!done.get()) {

                e2.printStackTrace();

            }

        }

    });

    assertThat(latch.await(<span class="hljs-number">10000</span>, TimeUnit.MILLISECONDS)).isTrue();

    <span class="hljs-comment">// Failover</span>

    AbstractClientConnectionFactory factory1 = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpConnectionSupport mockConn1 = makeMockConnection();

    when(factory1.getConnection()).thenReturn(mockConn1);

    doThrow(<span class="hljs-keyword">new</span> UncheckedIOException(<span class="hljs-keyword">new</span> IOException(<span class="hljs-string">"fail"</span>))).when(mockConn1).send(any(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    AbstractClientConnectionFactory factory2 = <span class="hljs-keyword">new</span> TcpNetClientConnectionFactory(<span class="hljs-string">"localhost"</span>, serverSocket.get().getLocalPort());

    factory2.setSerializer(<span class="hljs-keyword">new</span> DefaultSerializer());

    factory2.setDeserializer(<span class="hljs-keyword">new</span> DefaultDeserializer());

    factory2.setSoTimeout(<span class="hljs-number">10000</span>);

    factory2.setSingleUse(<span class="hljs-keyword">false</span>);

    List&lt;AbstractClientConnectionFactory&gt; factories = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    factories.add(factory1);

    factories.add(factory2);

    FailoverClientConnectionFactory failoverFactory = <span class="hljs-keyword">new</span> FailoverClientConnectionFactory(factories);

    failoverFactory.start();

    <span class="hljs-comment">// Cache</span>

    CachingClientConnectionFactory cachingFactory = <span class="hljs-keyword">new</span> CachingClientConnectionFactory(failoverFactory, <span class="hljs-number">2</span>);

    cachingFactory.start();

    TcpOutboundGateway gateway = <span class="hljs-keyword">new</span> TcpOutboundGateway();

    gateway.setConnectionFactory(cachingFactory);

    PollableChannel outputChannel = <span class="hljs-keyword">new</span> QueueChannel();

    gateway.setOutputChannel(outputChannel);

    gateway.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    gateway.afterPropertiesSet();

    gateway.start();

    GenericMessage&lt;String&gt; message = <span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>);

    gateway.handleMessage(message);

    Message&lt;?&gt; reply = outputChannel.receive(<span class="hljs-number">0</span>);

    assertThat(reply).isNotNull();

    assertThat(reply.getPayload()).isEqualTo(<span class="hljs-string">"bar"</span>);

    done.set(<span class="hljs-keyword">true</span>);

    gateway.stop();

    verify(mockConn1).send(any(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    factory2.stop();

    serverSocket.get().close();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AbstractClientConnectionFactory <span class="hljs-title">createMockAbstractClientConnectionFactory</span><span class="hljs-params">(TcpConnectionSupport connectionSupport)</span> </span>{
    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.getConnection()).thenReturn(connectionSupport);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest692">Test Case ID #spring-integration_Test_69_2</h4>
<h4 id="test-case-name-testfailovercachedfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcptcpoutboundgatewaytestsjava">Test Case Name: <code>testFailoverCached</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\TcpOutboundGatewayTests.java</code>)</h4>
<h4 id="mock-object-variable-name-factory1">Mock Object Variable Name: <code>factory1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    assertThat(latch.await(10000, TimeUnit.MILLISECONDS)).isTrue();
    // Cache
<span class="hljs-deletion">-    AbstractClientConnectionFactory factory1 = mock(AbstractClientConnectionFactory.class);</span>
    TcpConnectionSupport mockConn1 = makeMockConnection();
<span class="hljs-deletion">-    when(factory1.getConnection()).thenReturn(mockConn1);</span>
<span class="hljs-deletion">-    when(factory1.isSingleUse()).thenReturn(true);</span>
<span class="hljs-addition">+    AbstractClientConnectionFactory factory1 = createMockAbstractClientConnectionFactory(mockConn1);</span>
<span class="hljs-addition">+    when(factory1.isSingleUse()).thenReturn(true);</span>
    doThrow(new UncheckedIOException(new IOException("fail"))).when(mockConn1).send(any(Message.class));
    CachingClientConnectionFactory cachingFactory1 = new CachingClientConnectionFactory(factory1, 1);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testFailoverCached</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-keyword">final</span> AtomicReference&lt;ServerSocket&gt; serverSocket = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    <span class="hljs-keyword">final</span> CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">final</span> AtomicBoolean done = <span class="hljs-keyword">new</span> AtomicBoolean();

    <span class="hljs-keyword">final</span> CountDownLatch serverLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">this</span>.executor.execute(() -&gt; {

        <span class="hljs-keyword">try</span> {

            ServerSocket server = ServerSocketFactory.getDefault().createServerSocket(<span class="hljs-number">0</span>);

            serverSocket.set(server);

            latch.countDown();

            <span class="hljs-keyword">while</span> (!done.get()) {

                Socket socket = server.accept();

                <span class="hljs-keyword">while</span> (!socket.isClosed()) {

                    <span class="hljs-keyword">try</span> {

                        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(socket.getInputStream());

                        String request = (String) ois.readObject();

                        logger.debug(<span class="hljs-string">"Read "</span> + request);

                        ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(socket.getOutputStream());

                        oos.writeObject(<span class="hljs-string">"bar"</span>);

                        logger.debug(<span class="hljs-string">"Replied to "</span> + request);

                        serverLatch.countDown();

                    } <span class="hljs-keyword">catch</span> (IOException e1) {

                        logger.debug(<span class="hljs-string">"error on write "</span> + e1.getClass().getSimpleName());

                        socket.close();

                    }

                }

            }

        } <span class="hljs-keyword">catch</span> (Exception e2) {

            <span class="hljs-keyword">if</span> (!done.get()) {

                e2.printStackTrace();

            }

        }

    });

    assertThat(latch.await(<span class="hljs-number">10000</span>, TimeUnit.MILLISECONDS)).isTrue();

    <span class="hljs-comment">// Cache</span>

    AbstractClientConnectionFactory factory1 = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpConnectionSupport mockConn1 = makeMockConnection();

    when(factory1.getConnection()).thenReturn(mockConn1);

    when(factory1.isSingleUse()).thenReturn(<span class="hljs-keyword">true</span>);

    doThrow(<span class="hljs-keyword">new</span> UncheckedIOException(<span class="hljs-keyword">new</span> IOException(<span class="hljs-string">"fail"</span>))).when(mockConn1).send(any(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    CachingClientConnectionFactory cachingFactory1 = <span class="hljs-keyword">new</span> CachingClientConnectionFactory(factory1, <span class="hljs-number">1</span>);

    AbstractClientConnectionFactory factory2 = <span class="hljs-keyword">new</span> TcpNetClientConnectionFactory(<span class="hljs-string">"localhost"</span>, serverSocket.get().getLocalPort());

    factory2.setSerializer(<span class="hljs-keyword">new</span> DefaultSerializer());

    factory2.setDeserializer(<span class="hljs-keyword">new</span> DefaultDeserializer());

    factory2.setSoTimeout(<span class="hljs-number">10000</span>);

    factory2.setSingleUse(<span class="hljs-keyword">true</span>);

    CachingClientConnectionFactory cachingFactory2 = <span class="hljs-keyword">new</span> CachingClientConnectionFactory(factory2, <span class="hljs-number">1</span>);

    <span class="hljs-comment">// Failover</span>

    List&lt;AbstractClientConnectionFactory&gt; factories = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    factories.add(cachingFactory1);

    factories.add(cachingFactory2);

    FailoverClientConnectionFactory failoverFactory = <span class="hljs-keyword">new</span> FailoverClientConnectionFactory(factories);

    failoverFactory.setSingleUse(<span class="hljs-keyword">true</span>);

    failoverFactory.afterPropertiesSet();

    failoverFactory.start();

    TcpOutboundGateway gateway = <span class="hljs-keyword">new</span> TcpOutboundGateway();

    gateway.setConnectionFactory(failoverFactory);

    PollableChannel outputChannel = <span class="hljs-keyword">new</span> QueueChannel();

    gateway.setOutputChannel(outputChannel);

    gateway.setBeanFactory(mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    gateway.afterPropertiesSet();

    gateway.start();

    GenericMessage&lt;String&gt; message = <span class="hljs-keyword">new</span> GenericMessage&lt;&gt;(<span class="hljs-string">"foo"</span>);

    gateway.handleMessage(message);

    Message&lt;?&gt; reply = outputChannel.receive(<span class="hljs-number">0</span>);

    assertThat(reply).isNotNull();

    assertThat(reply.getPayload()).isEqualTo(<span class="hljs-string">"bar"</span>);

    done.set(<span class="hljs-keyword">true</span>);

    gateway.stop();

    verify(mockConn1).send(any(Message<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    factory2.stop();

    serverSocket.get().close();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AbstractClientConnectionFactory <span class="hljs-title">createMockAbstractClientConnectionFactory</span><span class="hljs-params">(TcpConnectionSupport connectionSupport)</span> </span>{
    AbstractClientConnectionFactory factory = mock(AbstractClientConnectionFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(factory.getConnection()).thenReturn(connectionSupport);
    <span class="hljs-keyword">return</span> factory;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci70">Mock Clone Instance #spring-integration_MCI_70</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.beans.factory.BeanFactory</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> BeanFactory <span class="hljs-title">createMockBeanFactory</span><span class="hljs-params">()</span> </span>{
    BeanFactory mock = mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(mock.getBean(AbstractApplicationContext.APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster<span class="hljs-class">.<span class="hljs-keyword">class</span>))
        .<span class="hljs-title">willReturn</span>(<span class="hljs-title">mock</span>(<span class="hljs-title">ApplicationEventMulticaster</span>.<span class="hljs-title">class</span>))</span>;
    <span class="hljs-keyword">return</span> mock;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest701">Test Case ID #spring-integration_Test_70_1</h4>
<h4 id="test-case-name-testnofilterfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpconnectioneventlistenertestsjava">Test Case Name: <code>testNoFilter</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpConnectionEventListenerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-mock">Mock Object Variable Name: <code>mock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    eventProducer.setEventTypes(TcpConnectionEvent.class);
<span class="hljs-deletion">-    BeanFactory mock = mock(BeanFactory.class);</span>
<span class="hljs-deletion">-    given(mock.getBean(AbstractApplicationContext.APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class)).willReturn(mock(ApplicationEventMulticaster.class));</span>
<span class="hljs-addition">+    BeanFactory mock = createMockBeanFactory();</span>
    eventProducer.setBeanFactory(mock);
    eventProducer.afterPropertiesSet();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNoFilter</span><span class="hljs-params">()</span> </span>{

    ApplicationEventListeningMessageProducer eventProducer = <span class="hljs-keyword">new</span> ApplicationEventListeningMessageProducer();

    QueueChannel outputChannel = <span class="hljs-keyword">new</span> QueueChannel();

    eventProducer.setOutputChannel(outputChannel);

    eventProducer.setEventTypes(TcpConnectionEvent<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    BeanFactory mock = mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(mock.getBean(AbstractApplicationContext.APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">willReturn</span>(<span class="hljs-title">mock</span>(<span class="hljs-title">ApplicationEventMulticaster</span>.<span class="hljs-title">class</span>))</span>;

    eventProducer.setBeanFactory(mock);

    eventProducer.afterPropertiesSet();

    eventProducer.start();

    TcpConnectionSupport connection = Mockito.mock(TcpConnectionSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    assertThat(eventProducer.supportsEventType(ResolvableType.forClass(TcpConnectionOpenEvent<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">isTrue</span>()</span>;

    TcpConnectionEvent event1 = <span class="hljs-keyword">new</span> TcpConnectionOpenEvent(connection, <span class="hljs-string">"foo"</span>);

    eventProducer.onApplicationEvent(event1);

    assertThat(eventProducer.supportsEventType(ResolvableType.forClass(FooEvent<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">isTrue</span>()</span>;

    FooEvent event2 = <span class="hljs-keyword">new</span> FooEvent(connection, <span class="hljs-string">"foo"</span>);

    eventProducer.onApplicationEvent(event2);

    assertThat(eventProducer.supportsEventType(ResolvableType.forClass(BarEvent<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">isTrue</span>()</span>;

    BarEvent event3 = <span class="hljs-keyword">new</span> BarEvent(connection, <span class="hljs-string">"foo"</span>);

    eventProducer.onApplicationEvent(event3);

    Message&lt;?&gt; message = outputChannel.receive(<span class="hljs-number">0</span>);

    assertThat(message).isNotNull();

    assertThat(message.getPayload()).isSameAs(event1);

    message = outputChannel.receive(<span class="hljs-number">0</span>);

    assertThat(message).isNotNull();

    assertThat(message.getPayload()).isSameAs(event2);

    message = outputChannel.receive(<span class="hljs-number">0</span>);

    assertThat(message).isNotNull();

    assertThat(message.getPayload()).isSameAs(event3);

    message = outputChannel.receive(<span class="hljs-number">0</span>);

    assertThat(message).isNull();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> BeanFactory <span class="hljs-title">createMockBeanFactory</span><span class="hljs-params">()</span> </span>{
    BeanFactory mock = mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(mock.getBean(AbstractApplicationContext.APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster<span class="hljs-class">.<span class="hljs-keyword">class</span>))
        .<span class="hljs-title">willReturn</span>(<span class="hljs-title">mock</span>(<span class="hljs-title">ApplicationEventMulticaster</span>.<span class="hljs-title">class</span>))</span>;
    <span class="hljs-keyword">return</span> mock;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest702">Test Case ID #spring-integration_Test_70_2</h4>
<h4 id="test-case-name-testfilterfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpconnectioneventlistenertestsjava">Test Case Name: <code>testFilter</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpConnectionEventListenerTests.java</code>)</h4>
<h4 id="mock-object-variable-name-mock">Mock Object Variable Name: <code>mock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
     eventProducer.setEventTypes(FooEvent.class, BarEvent.class);
<span class="hljs-deletion">-    BeanFactory mock = mock(BeanFactory.class);</span>
<span class="hljs-deletion">-    given(mock.getBean(AbstractApplicationContext.APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster.class)).willReturn(mock(ApplicationEventMulticaster.class));</span>
<span class="hljs-addition">+    BeanFactory mock = createMockBeanFactory();</span>
     eventProducer.setBeanFactory(mock);
     eventProducer.afterPropertiesSet();
     eventProducer.start();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFilter</span><span class="hljs-params">()</span> </span>{

    ApplicationEventListeningMessageProducer eventProducer = <span class="hljs-keyword">new</span> ApplicationEventListeningMessageProducer();

    QueueChannel outputChannel = <span class="hljs-keyword">new</span> QueueChannel();

    eventProducer.setOutputChannel(outputChannel);

    eventProducer.setEventTypes(FooEvent<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">BarEvent</span>.<span class="hljs-title">class</span>)</span>;

    BeanFactory mock = mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(mock.getBean(AbstractApplicationContext.APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">willReturn</span>(<span class="hljs-title">mock</span>(<span class="hljs-title">ApplicationEventMulticaster</span>.<span class="hljs-title">class</span>))</span>;

    eventProducer.setBeanFactory(mock);

    eventProducer.afterPropertiesSet();

    eventProducer.start();

    TcpConnectionSupport connection = Mockito.mock(TcpConnectionSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    assertThat(eventProducer.supportsEventType(ResolvableType.forClass(TcpConnectionOpenEvent<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">isFalse</span>()</span>;

    assertThat(eventProducer.supportsEventType(ResolvableType.forClass(FooEvent<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">isTrue</span>()</span>;

    FooEvent event2 = <span class="hljs-keyword">new</span> FooEvent(connection, <span class="hljs-string">"foo"</span>);

    eventProducer.onApplicationEvent(event2);

    assertThat(eventProducer.supportsEventType(ResolvableType.forClass(BarEvent<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">isTrue</span>()</span>;

    BarEvent event3 = <span class="hljs-keyword">new</span> BarEvent(connection, <span class="hljs-string">"foo"</span>);

    eventProducer.onApplicationEvent(event3);

    Message&lt;?&gt; message = outputChannel.receive(<span class="hljs-number">0</span>);

    assertThat(message).isNotNull();

    assertThat(message.getPayload()).isSameAs(event2);

    message = outputChannel.receive(<span class="hljs-number">0</span>);

    assertThat(message).isNotNull();

    assertThat(message.getPayload()).isSameAs(event3);

    message = outputChannel.receive(<span class="hljs-number">0</span>);

    assertThat(message).isNull();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> BeanFactory <span class="hljs-title">createMockBeanFactory</span><span class="hljs-params">()</span> </span>{
    BeanFactory mock = mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(mock.getBean(AbstractApplicationContext.APPLICATION_EVENT_MULTICASTER_BEAN_NAME, ApplicationEventMulticaster<span class="hljs-class">.<span class="hljs-keyword">class</span>))
        .<span class="hljs-title">willReturn</span>(<span class="hljs-title">mock</span>(<span class="hljs-title">ApplicationEventMulticaster</span>.<span class="hljs-title">class</span>))</span>;
    <span class="hljs-keyword">return</span> mock;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci71">Mock Clone Instance #spring-integration_MCI_71</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.springframework.beans.factory.BeanFactory</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> BeanFactory <span class="hljs-title">createMockBeanFactory</span><span class="hljs-params">(org.mockito.stubbing.Answer&lt;?&gt; getBeanAnswer)</span> </span>{
    BeanFactory beanFactory = mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(getBeanAnswer).when(beanFactory).getBean(anyString(), eq(MessageChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    <span class="hljs-keyword">return</span> beanFactory;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest711">Test Case ID #spring-integration_Test_71_1</h4>
<h4 id="test-case-name-testbfcrwithregistryfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationchannelregistryheaderchannelregistrytestsjava">Test Case Name: <code>testBFCRWithRegistry</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\channel\registry\HeaderChannelRegistryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-beanfactory">Mock Object Variable Name: <code>beanFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    BeanFactoryChannelResolver resolver = new BeanFactoryChannelResolver();
<span class="hljs-deletion">-    BeanFactory beanFactory = mock(BeanFactory.class);</span>
<span class="hljs-deletion">-    when(beanFactory.getBean(IntegrationContextUtils.INTEGRATION_HEADER_CHANNEL_REGISTRY_BEAN_NAME, HeaderChannelRegistry.class)).thenReturn(mock(HeaderChannelRegistry.class));</span>
<span class="hljs-deletion">-    doAnswer(invocation -&gt; {</span>
<span class="hljs-deletion">-        throw new NoSuchBeanDefinitionException("bar");</span>
<span class="hljs-deletion">-    }).when(beanFactory).getBean("foo", MessageChannel.class);</span>
<span class="hljs-addition">+    BeanFactory beanFactory = createMockBeanFactory(invocation -&gt; {</span>
<span class="hljs-addition">+        throw new NoSuchBeanDefinitionException("bar");</span>
<span class="hljs-addition">+    });</span>
<span class="hljs-addition">+    when(beanFactory.getBean(IntegrationContextUtils.INTEGRATION_HEADER_CHANNEL_REGISTRY_BEAN_NAME, HeaderChannelRegistry.class)).thenReturn(mock(HeaderChannelRegistry.class));</span>
    resolver.setBeanFactory(beanFactory);
    assertThatExceptionOfType(DestinationResolutionException.class).isThrownBy(() -&gt; resolver.resolveDestination("foo")).withMessageContaining("failed to look up MessageChannel with name 'foo' in the BeanFactory.");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testBFCRWithRegistry</span><span class="hljs-params">()</span> </span>{

    BeanFactoryChannelResolver resolver = <span class="hljs-keyword">new</span> BeanFactoryChannelResolver();

    BeanFactory beanFactory = mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(beanFactory.getBean(IntegrationContextUtils.INTEGRATION_HEADER_CHANNEL_REGISTRY_BEAN_NAME, HeaderChannelRegistry<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">mock</span>(<span class="hljs-title">HeaderChannelRegistry</span>.<span class="hljs-title">class</span>))</span>;

    doAnswer(invocation -&gt; {

        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NoSuchBeanDefinitionException(<span class="hljs-string">"bar"</span>);

    }).when(beanFactory).getBean(<span class="hljs-string">"foo"</span>, MessageChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    resolver.setBeanFactory(beanFactory);

    assertThatExceptionOfType(DestinationResolutionException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(() -&gt; <span class="hljs-title">resolver</span>.<span class="hljs-title">resolveDestination</span>("<span class="hljs-title">foo</span>")).<span class="hljs-title">withMessageContaining</span>("<span class="hljs-title">failed</span> <span class="hljs-title">to</span> <span class="hljs-title">look</span> <span class="hljs-title">up</span> <span class="hljs-title">MessageChannel</span> <span class="hljs-title">with</span> <span class="hljs-title">name</span> '<span class="hljs-title">foo</span>' <span class="hljs-title">in</span> <span class="hljs-title">the</span> <span class="hljs-title">BeanFactory</span>.")</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> BeanFactory <span class="hljs-title">createMockBeanFactory</span><span class="hljs-params">(org.mockito.stubbing.Answer&lt;?&gt; getBeanAnswer)</span> </span>{
    BeanFactory beanFactory = mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(getBeanAnswer).when(beanFactory).getBean(anyString(), eq(MessageChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    <span class="hljs-keyword">return</span> beanFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest712">Test Case ID #spring-integration_Test_71_2</h4>
<h4 id="test-case-name-testbfcrnoregistryfile-cjavaprojectsspringspring-integrationspring-integration-coresrctestjavaorgspringframeworkintegrationchannelregistryheaderchannelregistrytestsjava">Test Case Name: <code>testBFCRNoRegistry</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-core\src\test\java\org\springframework\integration\channel\registry\HeaderChannelRegistryTests.java</code>)</h4>
<h4 id="mock-object-variable-name-beanfactory">Mock Object Variable Name: <code>beanFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    BeanFactoryChannelResolver resolver = new BeanFactoryChannelResolver();
<span class="hljs-deletion">-    BeanFactory beanFactory = mock(BeanFactory.class);</span>
<span class="hljs-deletion">-    doAnswer(invocation -&gt; {</span>
<span class="hljs-deletion">-        throw new NoSuchBeanDefinitionException("bar");</span>
<span class="hljs-deletion">-    }).when(beanFactory).getBean("foo", MessageChannel.class);</span>
<span class="hljs-addition">+    BeanFactory beanFactory = createMockBeanFactory(invocation -&gt; {</span>
<span class="hljs-addition">+        throw new NoSuchBeanDefinitionException("bar");</span>
<span class="hljs-addition">+    });</span>
    resolver.setBeanFactory(beanFactory);
    assertThatExceptionOfType(DestinationResolutionException.class).isThrownBy(() -&gt; resolver.resolveDestination("foo")).withMessageContaining("failed to look up MessageChannel with name 'foo' in the BeanFactory" + " (and there is no HeaderChannelRegistry present).");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testBFCRNoRegistry</span><span class="hljs-params">()</span> </span>{

    BeanFactoryChannelResolver resolver = <span class="hljs-keyword">new</span> BeanFactoryChannelResolver();

    BeanFactory beanFactory = mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    doAnswer(invocation -&gt; {

        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NoSuchBeanDefinitionException(<span class="hljs-string">"bar"</span>);

    }).when(beanFactory).getBean(<span class="hljs-string">"foo"</span>, MessageChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    resolver.setBeanFactory(beanFactory);

    assertThatExceptionOfType(DestinationResolutionException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isThrownBy</span>(() -&gt; <span class="hljs-title">resolver</span>.<span class="hljs-title">resolveDestination</span>("<span class="hljs-title">foo</span>")).<span class="hljs-title">withMessageContaining</span>("<span class="hljs-title">failed</span> <span class="hljs-title">to</span> <span class="hljs-title">look</span> <span class="hljs-title">up</span> <span class="hljs-title">MessageChannel</span> <span class="hljs-title">with</span> <span class="hljs-title">name</span> '<span class="hljs-title">foo</span>' <span class="hljs-title">in</span> <span class="hljs-title">the</span> <span class="hljs-title">BeanFactory</span>" + " (<span class="hljs-title">and</span> <span class="hljs-title">there</span> <span class="hljs-title">is</span> <span class="hljs-title">no</span> <span class="hljs-title">HeaderChannelRegistry</span> <span class="hljs-title">present</span>).")</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> BeanFactory <span class="hljs-title">createMockBeanFactory</span><span class="hljs-params">(org.mockito.stubbing.Answer&lt;?&gt; getBeanAnswer)</span> </span>{
    BeanFactory beanFactory = mock(BeanFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    doAnswer(getBeanAnswer).when(beanFactory).getBean(anyString(), eq(MessageChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
    <span class="hljs-keyword">return</span> beanFactory;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-spring-integrationmci72">Mock Clone Instance #spring-integration_MCI_72</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>java.io.InputStream</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInputStream</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock InputStream with configurable return value for read().
     *
     * <span class="hljs-doctag">@param</span> readReturn the int value to be returned by read()
     * <span class="hljs-doctag">@return</span> the configured mock InputStream
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InputStream <span class="hljs-title">createMockInputStream</span><span class="hljs-params">(<span class="hljs-keyword">int</span> readReturn)</span> </span>{
        InputStream inputStream = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(inputStream.read()).thenReturn(readReturn);
        <span class="hljs-keyword">return</span> inputStream;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-spring-integrationtest721">Test Case ID #spring-integration_Test_72_1</h4>
<h4 id="test-case-name-testnetclientfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionsocketsupporttestsjava">Test Case Name: <code>testNetClient</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\SocketSupportTests.java</code>)</h4>
<h4 id="mock-object-variable-name-is">Mock Object Variable Name: <code>is</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     Socket socket = mock(Socket.class);
<span class="hljs-deletion">-    InputStream is = mock(InputStream.class);</span>
<span class="hljs-deletion">-    when(is.read()).thenReturn(-1);</span>
<span class="hljs-addition">+    InputStream is = MockInputStream.createMockInputStream(-1);</span>
     when(socket.getInputStream()).thenReturn(is);
     InetAddress inetAddress = InetAddress.getLocalHost();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNetClient</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketFactory factory = Mockito.mock(SocketFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factorySupport.getSocketFactory()).thenReturn(factory);

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    InputStream is = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(is.read()).thenReturn(-<span class="hljs-number">1</span>);

    when(socket.getInputStream()).thenReturn(is);

    InetAddress inetAddress = InetAddress.getLocalHost();

    when(socket.getInetAddress()).thenReturn(inetAddress);

    when(factory.createSocket()).thenReturn(socket);

    TcpSocketSupport socketSupport = Mockito.mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNetClientConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> TcpNetClientConnectionFactory(<span class="hljs-string">"x"</span>, <span class="hljs-number">0</span>);

    connectionFactory.setTcpSocketFactorySupport(factorySupport);

    connectionFactory.setTcpSocketSupport(socketSupport);

    connectionFactory.start();

    connectionFactory.getConnection();

    verify(socketSupport).postProcessSocket(socket);

    connectionFactory.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInputStream</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock InputStream with configurable return value for read().
     *
     * <span class="hljs-doctag">@param</span> readReturn the int value to be returned by read()
     * <span class="hljs-doctag">@return</span> the configured mock InputStream
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InputStream <span class="hljs-title">createMockInputStream</span><span class="hljs-params">(<span class="hljs-keyword">int</span> readReturn)</span> </span>{
        InputStream inputStream = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(inputStream.read()).thenReturn(readReturn);
        <span class="hljs-keyword">return</span> inputStream;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest722">Test Case ID #spring-integration_Test_72_2</h4>
<h4 id="test-case-name-testnetclientsockettimeoutfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionsocketsupporttestsjava">Test Case Name: <code>testNetClientSocketTimeout</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\SocketSupportTests.java</code>)</h4>
<h4 id="mock-object-variable-name-is">Mock Object Variable Name: <code>is</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Socket socket = mock(Socket.class);
<span class="hljs-deletion">-    InputStream is = mock(InputStream.class);</span>
<span class="hljs-deletion">-    when(is.read()).thenReturn(-1);</span>
<span class="hljs-addition">+    InputStream is = MockInputStream.createMockInputStream(-1);</span>
    when(socket.getInputStream()).thenReturn(is);
    InetAddress inetAddress = InetAddress.getLocalHost();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNetClientSocketTimeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SocketFactory factory = Mockito.mock(SocketFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factorySupport.getSocketFactory()).thenReturn(factory);

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    InputStream is = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(is.read()).thenReturn(-<span class="hljs-number">1</span>);

    when(socket.getInputStream()).thenReturn(is);

    InetAddress inetAddress = InetAddress.getLocalHost();

    when(socket.getInetAddress()).thenReturn(inetAddress);

    when(factory.createSocket()).thenReturn(socket);

    doThrow(<span class="hljs-keyword">new</span> SocketTimeoutException()).when(socket).connect(any(), eq(<span class="hljs-number">1000</span>));

    TcpSocketSupport socketSupport = Mockito.mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNetClientConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> TcpNetClientConnectionFactory(<span class="hljs-string">"x"</span>, <span class="hljs-number">0</span>);

    connectionFactory.setConnectTimeout(<span class="hljs-number">1</span>);

    connectionFactory.setTcpSocketFactorySupport(factorySupport);

    connectionFactory.setTcpSocketSupport(socketSupport);

    connectionFactory.start();

    assertThatThrownBy(connectionFactory::getConnection).isInstanceOf(UncheckedIOException<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">hasCauseInstanceOf</span>(<span class="hljs-title">SocketTimeoutException</span>.<span class="hljs-title">class</span>)</span>;

    connectionFactory.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInputStream</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock InputStream with configurable return value for read().
     *
     * <span class="hljs-doctag">@param</span> readReturn the int value to be returned by read()
     * <span class="hljs-doctag">@return</span> the configured mock InputStream
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InputStream <span class="hljs-title">createMockInputStream</span><span class="hljs-params">(<span class="hljs-keyword">int</span> readReturn)</span> </span>{
        InputStream inputStream = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(inputStream.read()).thenReturn(readReturn);
        <span class="hljs-keyword">return</span> inputStream;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest723">Test Case ID #spring-integration_Test_72_3</h4>
<h4 id="test-case-name-testnetserverfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectionsocketsupporttestsjava">Test Case Name: <code>testNetServer</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\SocketSupportTests.java</code>)</h4>
<h4 id="mock-object-variable-name-is">Mock Object Variable Name: <code>is</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Socket socket = mock(Socket.class);
    Socket socket1 = mock(Socket.class);
<span class="hljs-deletion">-    InputStream is = mock(InputStream.class);</span>
<span class="hljs-deletion">-    when(is.read()).thenReturn(-1);</span>
<span class="hljs-addition">+    InputStream is = MockInputStream.createMockInputStream(-1);</span>
    when(socket.getInputStream()).thenReturn(is);
    when(socket1.getInputStream()).thenReturn(is);
    InetAddress inetAddress = InetAddress.getLocalHost();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNetServer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TcpSocketFactorySupport factorySupport = mock(TcpSocketFactorySupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServerSocketFactory factory = mock(ServerSocketFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(factorySupport.getServerSocketFactory()).thenReturn(factory);

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Socket socket1 = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    InputStream is = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(is.read()).thenReturn(-<span class="hljs-number">1</span>);

    when(socket.getInputStream()).thenReturn(is);

    when(socket1.getInputStream()).thenReturn(is);

    InetAddress inetAddress = InetAddress.getLocalHost();

    when(socket.getInetAddress()).thenReturn(inetAddress);

    when(socket1.getInetAddress()).thenReturn(inetAddress);

    ServerSocket serverSocket = mock(ServerSocket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AtomicBoolean closed = <span class="hljs-keyword">new</span> AtomicBoolean();

    doAnswer(invoc -&gt; {

        closed.set(<span class="hljs-keyword">true</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(serverSocket).close();

    when(serverSocket.getInetAddress()).thenReturn(inetAddress);

    when(factory.createServerSocket(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>)).thenReturn(serverSocket);

    <span class="hljs-keyword">final</span> CountDownLatch latch1 = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">final</span> CountDownLatch latch2 = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    when(serverSocket.accept()).thenReturn(socket).then(invocation -&gt; {

        <span class="hljs-keyword">if</span> (closed.get()) {

            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> SocketException();

        }

        latch1.countDown();

        latch2.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS);

        Thread.sleep(<span class="hljs-number">50</span>);

        <span class="hljs-keyword">return</span> socket1;

    });

    TcpSocketSupport socketSupport = mock(TcpSocketSupport<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TcpNetServerConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> TcpNetServerConnectionFactory(<span class="hljs-number">0</span>);

    connectionFactory.setTcpSocketFactorySupport(factorySupport);

    connectionFactory.setTcpSocketSupport(socketSupport);

    connectionFactory.registerListener(mock(TcpListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    connectionFactory.start();

    assertThat(latch1.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS)).isTrue();

    verify(socketSupport).postProcessServerSocket(serverSocket);

    verify(socketSupport).postProcessSocket(socket);

    latch2.countDown();

    connectionFactory.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInputStream</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock InputStream with configurable return value for read().
     *
     * <span class="hljs-doctag">@param</span> readReturn the int value to be returned by read()
     * <span class="hljs-doctag">@return</span> the configured mock InputStream
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InputStream <span class="hljs-title">createMockInputStream</span><span class="hljs-params">(<span class="hljs-keyword">int</span> readReturn)</span> </span>{
        InputStream inputStream = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(inputStream.read()).thenReturn(readReturn);
        <span class="hljs-keyword">return</span> inputStream;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-spring-integrationtest724">Test Case ID #spring-integration_Test_72_4</h4>
<h4 id="test-case-name-testerrorlogfile-cjavaprojectsspringspring-integrationspring-integration-ipsrctestjavaorgspringframeworkintegrationiptcpconnectiontcpnetconnectiontestsjava">Test Case Name: <code>testErrorLog</code>(File: <code>C:\Java_projects\Spring\spring-integration\spring-integration-ip\src\test\java\org\springframework\integration\ip\tcp\connection\TcpNetConnectionTests.java</code>)</h4>
<h4 id="mock-object-variable-name-stream">Mock Object Variable Name: <code>stream</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Socket socket = mock(Socket.class);
<span class="hljs-deletion">-    InputStream stream = mock(InputStream.class);</span>
<span class="hljs-deletion">-    when(socket.getInputStream()).thenReturn(stream);</span>
<span class="hljs-deletion">-    when(stream.read()).thenReturn((int) 'x');</span>
<span class="hljs-addition">+    InputStream stream = MockInputStream.createMockInputStream((int) 'x');</span>
<span class="hljs-addition">+    when(socket.getInputStream()).thenReturn(stream);</span>
    TcpNetConnection connection = new TcpNetConnection(socket, true, false, e -&gt; {
    }, null);
    connection.setDeserializer(new ByteArrayStxEtxSerializer());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testErrorLog</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Socket socket = mock(Socket<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    InputStream stream = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(socket.getInputStream()).thenReturn(stream);

    when(stream.read()).thenReturn((<span class="hljs-keyword">int</span>) <span class="hljs-string">'x'</span>);

    TcpNetConnection connection = <span class="hljs-keyword">new</span> TcpNetConnection(socket, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, e -&gt; {

    }, <span class="hljs-keyword">null</span>);

    connection.setDeserializer(<span class="hljs-keyword">new</span> ByteArrayStxEtxSerializer());

    <span class="hljs-keyword">final</span> AtomicReference&lt;Object&gt; log = <span class="hljs-keyword">new</span> AtomicReference&lt;Object&gt;();

    Log logger = mock(Log<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(logger.isErrorEnabled()).willReturn(<span class="hljs-keyword">true</span>);

    doAnswer(invocation -&gt; {

        log.set(invocation.getArguments()[<span class="hljs-number">0</span>]);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

    }).when(logger).error(Mockito.anyString());

    DirectFieldAccessor accessor = <span class="hljs-keyword">new</span> DirectFieldAccessor(connection);

    accessor.setPropertyValue(<span class="hljs-string">"logger"</span>, logger);

    connection.registerListener(mock(TcpListener<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    connection.setMapper(<span class="hljs-keyword">new</span> TcpMessageMapper());

    connection.run();

    assertThat(log.get()).isNotNull();

    assertThat(log.get()).isEqualTo(<span class="hljs-string">"Read exception "</span> + connection.getConnectionId() + <span class="hljs-string">" MessageMappingException:Expected STX to begin message"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInputStream</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock InputStream with configurable return value for read().
     *
     * <span class="hljs-doctag">@param</span> readReturn the int value to be returned by read()
     * <span class="hljs-doctag">@return</span> the configured mock InputStream
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InputStream <span class="hljs-title">createMockInputStream</span><span class="hljs-params">(<span class="hljs-keyword">int</span> readReturn)</span> </span>{
        InputStream inputStream = mock(InputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(inputStream.read()).thenReturn(readReturn);
        <span class="hljs-keyword">return</span> inputStream;
    }
}
</div></code></pre>
</details>
<hr>

</body>
</html>
