<!DOCTYPE html>
<html>
<head>
<title>dubbo-Refactoring-guide.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="a-guide-to-refactoring-mock-clones-in-dubbo">A guide to Refactoring mock clones in dubbo</h1>
<h2 id="mock-clone-instance-dubbomci1">Mock Clone Instance #dubbo_MCI_1</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>java.sql.Connection</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">createMockConnectionWithTypeInfoNext</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> nextReturn)</span> <span class="hljs-keyword">throws</span> SQLException </span>{
    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Answers</span>.<span class="hljs-title">RETURNS_DEEP_STUBS</span>)</span>;
    given(connection.getMetaData().getTypeInfo().next()).willReturn(nextReturn);
    <span class="hljs-keyword">return</span> connection;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest11">Test Case ID #dubbo_Test_1_1</h4>
<h4 id="test-case-name-testwithdatasourcehasnextresultfile-cjavaprojectsapachedubbodubbo-configdubbo-config-springsrctestjavaorgapachedubboconfigspringstatusdatasourcestatuscheckertestjava">Test Case Name: <code>testWithDatasourceHasNextResult</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-config\dubbo-config-spring\src\test\java\org\apache\dubbo\config\spring\status\DataSourceStatusCheckerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-connection">Mock Object Variable Name: <code>connection</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     Map&lt;String, DataSource&gt; map = new HashMap&lt;String, DataSource&gt;();
     DataSource dataSource = mock(DataSource.class);
<span class="hljs-deletion">-    Connection connection = mock(Connection.class, Answers.RETURNS_DEEP_STUBS);</span>
<span class="hljs-addition">+    Connection connection = createMockConnectionWithTypeInfoNext(true);</span>
     given(dataSource.getConnection()).willReturn(connection);
<span class="hljs-deletion">-    given(connection.getMetaData().getTypeInfo().next()).willReturn(true);</span>
     map.put("mockDatabase", dataSource);
     given(applicationContext.getBeansOfType(eq(DataSource.class), anyBoolean(), anyBoolean())).willReturn(map);
     Status status = dataSourceStatusChecker.check();
     assertThat(status.getLevel(), is(Status.Level.OK));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testWithDatasourceHasNextResult</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException </span>{

    Map&lt;String, DataSource&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;String, DataSource&gt;();

    DataSource dataSource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Answers</span>.<span class="hljs-title">RETURNS_DEEP_STUBS</span>)</span>;

    given(dataSource.getConnection()).willReturn(connection);

    given(connection.getMetaData().getTypeInfo().next()).willReturn(<span class="hljs-keyword">true</span>);

    map.put(<span class="hljs-string">"mockDatabase"</span>, dataSource);

    given(applicationContext.getBeansOfType(eq(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyBoolean</span>(), <span class="hljs-title">anyBoolean</span>())).<span class="hljs-title">willReturn</span>(<span class="hljs-title">map</span>)</span>;

    Status status = dataSourceStatusChecker.check();

    assertThat(status.getLevel(), is(Status.Level.OK));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">createMockConnectionWithTypeInfoNext</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> nextReturn)</span> <span class="hljs-keyword">throws</span> SQLException </span>{
    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Answers</span>.<span class="hljs-title">RETURNS_DEEP_STUBS</span>)</span>;
    given(connection.getMetaData().getTypeInfo().next()).willReturn(nextReturn);
    <span class="hljs-keyword">return</span> connection;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest12">Test Case ID #dubbo_Test_1_2</h4>
<h4 id="test-case-name-testwithdatasourcenothasnextresultfile-cjavaprojectsapachedubbodubbo-configdubbo-config-springsrctestjavaorgapachedubboconfigspringstatusdatasourcestatuscheckertestjava">Test Case Name: <code>testWithDatasourceNotHasNextResult</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-config\dubbo-config-spring\src\test\java\org\apache\dubbo\config\spring\status\DataSourceStatusCheckerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-connection">Mock Object Variable Name: <code>connection</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     Map&lt;String, DataSource&gt; map = new HashMap&lt;String, DataSource&gt;();
     DataSource dataSource = mock(DataSource.class);
<span class="hljs-deletion">-    Connection connection = mock(Connection.class, Answers.RETURNS_DEEP_STUBS);</span>
<span class="hljs-addition">+    Connection connection = createMockConnectionWithTypeInfoNext(false);</span>
     given(dataSource.getConnection()).willReturn(connection);
<span class="hljs-deletion">-    given(connection.getMetaData().getTypeInfo().next()).willReturn(false);</span>
     map.put("mockDatabase", dataSource);
     given(applicationContext.getBeansOfType(eq(DataSource.class), anyBoolean(), anyBoolean())).willReturn(map);
     Status status = dataSourceStatusChecker.check();
     assertThat(status.getLevel(), is(Status.Level.ERROR));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testWithDatasourceNotHasNextResult</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException </span>{

    Map&lt;String, DataSource&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;String, DataSource&gt;();

    DataSource dataSource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Answers</span>.<span class="hljs-title">RETURNS_DEEP_STUBS</span>)</span>;

    given(dataSource.getConnection()).willReturn(connection);

    given(connection.getMetaData().getTypeInfo().next()).willReturn(<span class="hljs-keyword">false</span>);

    map.put(<span class="hljs-string">"mockDatabase"</span>, dataSource);

    given(applicationContext.getBeansOfType(eq(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyBoolean</span>(), <span class="hljs-title">anyBoolean</span>())).<span class="hljs-title">willReturn</span>(<span class="hljs-title">map</span>)</span>;

    Status status = dataSourceStatusChecker.check();

    assertThat(status.getLevel(), is(Status.Level.ERROR));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">createMockConnectionWithTypeInfoNext</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> nextReturn)</span> <span class="hljs-keyword">throws</span> SQLException </span>{
    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Answers</span>.<span class="hljs-title">RETURNS_DEEP_STUBS</span>)</span>;
    given(connection.getMetaData().getTypeInfo().next()).willReturn(nextReturn);
    <span class="hljs-keyword">return</span> connection;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci2">Mock Clone Instance #dubbo_MCI_2</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>Directory&lt;DemoService&gt;</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDirectory</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Directory&lt;DemoService&gt; <span class="hljs-title">createMockDirectory</span><span class="hljs-params">(org.apache.dubbo.common.URL url)</span> </span>{
        Directory&lt;DemoService&gt; dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(dic.getUrl()).willReturn(url);
        given(dic.getConsumerUrl()).willReturn(url);
        given(dic.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        <span class="hljs-keyword">return</span> dic;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest21">Test Case ID #dubbo_Test_2_1</h4>
<h4 id="test-case-name-testnormalfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportbroadcastclusterinvokertestjava">Test Case Name: <code>testNormal</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\BroadCastClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-dic">Mock Object Variable Name: <code>dic</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @BeforeEach
 public void setUp() throws Exception {
<span class="hljs-deletion">-    dic = mock(Directory.class);</span>
<span class="hljs-addition">+    dic = MockDirectory.createMockDirectory(url);</span>
     invoker1 = new MockInvoker();
     invoker2 = new MockInvoker();
     invoker3 = new MockInvoker();
     invoker4 = new MockInvoker();
     url = URL.valueOf("test://127.0.0.1:8080/test");
<span class="hljs-deletion">-    given(dic.getUrl()).willReturn(url);</span>
<span class="hljs-deletion">-    given(dic.getConsumerUrl()).willReturn(url);</span>
<span class="hljs-deletion">-    given(dic.getInterface()).willReturn(DemoService.class);</span>
     invocation = new RpcInvocation();
     invocation.setMethodName("test");
     clusterInvoker = new BroadcastClusterInvoker(dic);
 }

</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testNormal</span><span class="hljs-params">()</span> </span>{

    given(dic.list(invocation)).willReturn(Arrays.asList(invoker1, invoker2, invoker3, invoker4));

    <span class="hljs-comment">// Every invoker will be called</span>

    clusterInvoker.invoke(invocation);

    assertTrue(invoker1.isInvoked());

    assertTrue(invoker2.isInvoked());

    assertTrue(invoker3.isInvoked());

    assertTrue(invoker4.isInvoked());

}
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = <span class="hljs-keyword">new</span> MockInvoker();

    invoker2 = <span class="hljs-keyword">new</span> MockInvoker();

    invoker3 = <span class="hljs-keyword">new</span> MockInvoker();

    invoker4 = <span class="hljs-keyword">new</span> MockInvoker();

    url = URL.valueOf(<span class="hljs-string">"test://127.0.0.1:8080/test"</span>);

    given(dic.getUrl()).willReturn(url);

    given(dic.getConsumerUrl()).willReturn(url);

    given(dic.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    invocation.setMethodName(<span class="hljs-string">"test"</span>);

    clusterInvoker = <span class="hljs-keyword">new</span> BroadcastClusterInvoker(dic);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDirectory</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Directory&lt;DemoService&gt; <span class="hljs-title">createMockDirectory</span><span class="hljs-params">(org.apache.dubbo.common.URL url)</span> </span>{
        Directory&lt;DemoService&gt; dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(dic.getUrl()).willReturn(url);
        given(dic.getConsumerUrl()).willReturn(url);
        given(dic.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        <span class="hljs-keyword">return</span> dic;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest22">Test Case ID #dubbo_Test_2_2</h4>
<h4 id="test-case-name-testexfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportbroadcastclusterinvokertestjava">Test Case Name: <code>testEx</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\BroadCastClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-dic">Mock Object Variable Name: <code>dic</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- Original</span>
<span class="hljs-comment">+++ Refactored</span>
@@
 @BeforeEach
 public void setUp() throws Exception {
<span class="hljs-deletion">-    dic = mock(Directory.class);</span>
     invoker1 = new MockInvoker();
     invoker2 = new MockInvoker();
     invoker3 = new MockInvoker();
     invoker4 = new MockInvoker();
     url = URL.valueOf("test://127.0.0.1:8080/test");
<span class="hljs-deletion">-    given(dic.getUrl()).willReturn(url);</span>
<span class="hljs-deletion">-    given(dic.getConsumerUrl()).willReturn(url);</span>
<span class="hljs-deletion">-    given(dic.getInterface()).willReturn(DemoService.class);</span>
<span class="hljs-addition">+    dic = MockDirectory.createMockDirectory(url);</span>
     invocation = new RpcInvocation();
     invocation.setMethodName("test");
     clusterInvoker = new BroadcastClusterInvoker(dic);
 }

 @Test
 void testEx() {
     given(dic.list(invocation)).willReturn(Arrays.asList(invoker1, invoker2, invoker3, invoker4));
     invoker1.invokeThrowEx();
     assertThrows(RpcException.class, () -&gt; {
         clusterInvoker.invoke(invocation);
     });
     // The default failure percentage is 100, even if a certain invoker#invoke throws an exception, other invokers will still be called
     assertTrue(invoker1.isInvoked());
     assertTrue(invoker2.isInvoked());
     assertTrue(invoker3.isInvoked());
     assertTrue(invoker4.isInvoked());
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = <span class="hljs-keyword">new</span> MockInvoker();

    invoker2 = <span class="hljs-keyword">new</span> MockInvoker();

    invoker3 = <span class="hljs-keyword">new</span> MockInvoker();

    invoker4 = <span class="hljs-keyword">new</span> MockInvoker();

    url = URL.valueOf(<span class="hljs-string">"test://127.0.0.1:8080/test"</span>);

    given(dic.getUrl()).willReturn(url);

    given(dic.getConsumerUrl()).willReturn(url);

    given(dic.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    invocation.setMethodName(<span class="hljs-string">"test"</span>);

    clusterInvoker = <span class="hljs-keyword">new</span> BroadcastClusterInvoker(dic);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testEx</span><span class="hljs-params">()</span> </span>{

    given(dic.list(invocation)).willReturn(Arrays.asList(invoker1, invoker2, invoker3, invoker4));

    invoker1.invokeThrowEx();

    assertThrows(RpcException<span class="hljs-class">.<span class="hljs-keyword">class</span>, () -&gt; </span>{

        clusterInvoker.invoke(invocation);

    });

    <span class="hljs-comment">// The default failure percentage is 100, even if a certain invoker#invoke throws an exception, other invokers will still be called</span>

    assertTrue(invoker1.isInvoked());

    assertTrue(invoker2.isInvoked());

    assertTrue(invoker3.isInvoked());

    assertTrue(invoker4.isInvoked());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDirectory</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Directory&lt;DemoService&gt; <span class="hljs-title">createMockDirectory</span><span class="hljs-params">(org.apache.dubbo.common.URL url)</span> </span>{
        Directory&lt;DemoService&gt; dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(dic.getUrl()).willReturn(url);
        given(dic.getConsumerUrl()).willReturn(url);
        given(dic.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        <span class="hljs-keyword">return</span> dic;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest23">Test Case ID #dubbo_Test_2_3</h4>
<h4 id="test-case-name-testfailpercentfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportbroadcastclusterinvokertestjava">Test Case Name: <code>testFailPercent</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\BroadCastClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-dic">Mock Object Variable Name: <code>dic</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    @BeforeEach
    public void setUp() throws Exception {
<span class="hljs-deletion">-        dic = mock(Directory.class);</span>
<span class="hljs-addition">+        dic = MockDirectory.createMockDirectory(url);</span>
        invoker1 = new MockInvoker();
        invoker2 = new MockInvoker();
        invoker3 = new MockInvoker();
        invoker4 = new MockInvoker();
        url = URL.valueOf("test://127.0.0.1:8080/test");
<span class="hljs-deletion">-        given(dic.getUrl()).willReturn(url);</span>
<span class="hljs-deletion">-        given(dic.getConsumerUrl()).willReturn(url);</span>
<span class="hljs-deletion">-        given(dic.getInterface()).willReturn(DemoService.class);</span>
        invocation = new RpcInvocation();
        invocation.setMethodName("test");
        clusterInvoker = new BroadcastClusterInvoker(dic);
    }

    @Test
    void testFailPercent() {
        given(dic.list(invocation)).willReturn(Arrays.asList(invoker1, invoker2, invoker3, invoker4));
        // We set the failure percentage to 75, which means that when the number of call failures is 4*(75/100) = 3,
        // an exception will be thrown directly and subsequent invokers will not be called.
        url = url.addParameter("broadcast.fail.percent", 75);
<span class="hljs-deletion">-        given(dic.getConsumerUrl()).willReturn(url);</span>
<span class="hljs-addition">+        given(dic.getConsumerUrl()).willReturn(url);</span>
        invoker1.invokeThrowEx();
        invoker2.invokeThrowEx();
        invoker3.invokeThrowEx();
        invoker4.invokeThrowEx();
        assertThrows(RpcException.class, () -&gt; {
            clusterInvoker.invoke(invocation);
        });
        assertTrue(invoker1.isInvoked());
        assertTrue(invoker2.isInvoked());
        assertTrue(invoker3.isInvoked());
        assertFalse(invoker4.isInvoked());
    }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testFailPercent</span><span class="hljs-params">()</span> </span>{

    given(dic.list(invocation)).willReturn(Arrays.asList(invoker1, invoker2, invoker3, invoker4));

    <span class="hljs-comment">// We set the failure percentage to 75, which means that when the number of call failures is 4*(75/100) = 3,</span>

    <span class="hljs-comment">// an exception will be thrown directly and subsequent invokers will not be called.</span>

    url = url.addParameter(<span class="hljs-string">"broadcast.fail.percent"</span>, <span class="hljs-number">75</span>);

    given(dic.getConsumerUrl()).willReturn(url);

    invoker1.invokeThrowEx();

    invoker2.invokeThrowEx();

    invoker3.invokeThrowEx();

    invoker4.invokeThrowEx();

    assertThrows(RpcException<span class="hljs-class">.<span class="hljs-keyword">class</span>, () -&gt; </span>{

        clusterInvoker.invoke(invocation);

    });

    assertTrue(invoker1.isInvoked());

    assertTrue(invoker2.isInvoked());

    assertTrue(invoker3.isInvoked());

    assertFalse(invoker4.isInvoked());

}
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = <span class="hljs-keyword">new</span> MockInvoker();

    invoker2 = <span class="hljs-keyword">new</span> MockInvoker();

    invoker3 = <span class="hljs-keyword">new</span> MockInvoker();

    invoker4 = <span class="hljs-keyword">new</span> MockInvoker();

    url = URL.valueOf(<span class="hljs-string">"test://127.0.0.1:8080/test"</span>);

    given(dic.getUrl()).willReturn(url);

    given(dic.getConsumerUrl()).willReturn(url);

    given(dic.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    invocation.setMethodName(<span class="hljs-string">"test"</span>);

    clusterInvoker = <span class="hljs-keyword">new</span> BroadcastClusterInvoker(dic);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDirectory</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Directory&lt;DemoService&gt; <span class="hljs-title">createMockDirectory</span><span class="hljs-params">(org.apache.dubbo.common.URL url)</span> </span>{
        Directory&lt;DemoService&gt; dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(dic.getUrl()).willReturn(url);
        given(dic.getConsumerUrl()).willReturn(url);
        given(dic.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        <span class="hljs-keyword">return</span> dic;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest24">Test Case ID #dubbo_Test_2_4</h4>
<h4 id="test-case-name-testnoinvokefile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportfailsafeclusterinvokertestjava">Test Case Name: <code>testNoInvoke</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\FailSafeClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-dic">Mock Object Variable Name: <code>dic</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- a/TestClass.java</span>
<span class="hljs-comment">+++ b/TestClass.java</span>
@@
 @Test
 void testNoInvoke() {
<span class="hljs-deletion">-    dic = mock(Directory.class);</span>
<span class="hljs-deletion">-    given(dic.getUrl()).willReturn(url);</span>
<span class="hljs-deletion">-    given(dic.getConsumerUrl()).willReturn(url);</span>
<span class="hljs-deletion">-    given(dic.list(invocation)).willReturn(null);</span>
<span class="hljs-deletion">-    given(dic.getInterface()).willReturn(DemoService.class);</span>
<span class="hljs-addition">+    dic = MockDirectory.createMockDirectory(url);</span>
<span class="hljs-addition">+    given(dic.list(invocation)).willReturn(null);</span>
     invocation.setMethodName("method1");
     resetInvokerToNoException();
     FailsafeClusterInvoker&lt;DemoService&gt; invoker = new FailsafeClusterInvoker&lt;DemoService&gt;(dic);
     LogUtil.start();
     invoker.invoke(invocation);
     assertTrue(LogUtil.findMessage("No provider") &gt; 0);
     LogUtil.stop();
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testNoInvoke</span><span class="hljs-params">()</span> </span>{

    dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(dic.getUrl()).willReturn(url);

    given(dic.getConsumerUrl()).willReturn(url);

    given(dic.list(invocation)).willReturn(<span class="hljs-keyword">null</span>);

    given(dic.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation.setMethodName(<span class="hljs-string">"method1"</span>);

    resetInvokerToNoException();

    FailsafeClusterInvoker&lt;DemoService&gt; invoker = <span class="hljs-keyword">new</span> FailsafeClusterInvoker&lt;DemoService&gt;(dic);

    LogUtil.start();

    invoker.invoke(invocation);

    assertTrue(LogUtil.findMessage(<span class="hljs-string">"No provider"</span>) &gt; <span class="hljs-number">0</span>);

    LogUtil.stop();

}
<span class="hljs-comment">/**

 * <span class="hljs-doctag">@throws</span> java.lang.Exception

 */</span>

<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(dic.getUrl()).willReturn(url);

    given(dic.getConsumerUrl()).willReturn(url);

    given(dic.list(invocation)).willReturn(invokers);

    given(dic.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation.setMethodName(<span class="hljs-string">"method1"</span>);

    invokers.add(invoker);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDirectory</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Directory&lt;DemoService&gt; <span class="hljs-title">createMockDirectory</span><span class="hljs-params">(org.apache.dubbo.common.URL url)</span> </span>{
        Directory&lt;DemoService&gt; dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(dic.getUrl()).willReturn(url);
        given(dic.getConsumerUrl()).willReturn(url);
        given(dic.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        <span class="hljs-keyword">return</span> dic;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci3">Mock Clone Instance #dubbo_MCI_3</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.registry.integration.RegistryProtocol</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RegistryProtocol <span class="hljs-title">createMockRegistryProtocol</span><span class="hljs-params">(ClusterInvoker invoker, ClusterInvoker serviceDiscoveryInvoker)</span> </span>{
    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);
    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);
    <span class="hljs-keyword">return</span> registryProtocol;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest31">Test Case ID #dubbo_Test_3_1</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationinvokertestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-registryprotocol">Mock Object Variable Name: <code>registryProtocol</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void test() {
<span class="hljs-deletion">-    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol.class);</span>
     ClusterInvoker invoker = Mockito.mock(ClusterInvoker.class);
     ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker.class);
     DynamicDirectory directory = Mockito.mock(DynamicDirectory.class);
     DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory.class);
     Mockito.when(invoker.getDirectory()).thenReturn(directory);
     Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);
     Mockito.when(invoker.isAvailable()).thenReturn(true);
     Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(true);
     Mockito.when(invoker.hasProxyInvokers()).thenReturn(true);
     Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(true);
     List&lt;Invoker&lt;?&gt;&gt; invokers = new LinkedList&lt;&gt;();
     invokers.add(Mockito.mock(Invoker.class));
     invokers.add(Mockito.mock(Invoker.class));
     List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = new LinkedList&lt;&gt;();
     serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
     serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
     Mockito.when(directory.getAllInvokers()).thenReturn(invokers);
     Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);
<span class="hljs-addition">+    RegistryProtocol registryProtocol = createMockRegistryProtocol(invoker, serviceDiscoveryInvoker);</span>
@@
<span class="hljs-deletion">-    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);</span>
<span class="hljs-deletion">-    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);</span>
     URL consumerURL = Mockito.mock(URL.class);
     Mockito.when(consumerURL.getServiceInterface()).thenReturn("Test");
     Mockito.when(consumerURL.getGroup()).thenReturn("Group");
     Mockito.when(consumerURL.getVersion()).thenReturn("0.0.0");
     Mockito.when(consumerURL.getServiceKey()).thenReturn("Group/Test:0.0.0");
     Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn("Test:0.0.0");
     Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());
     Mockito.when(invoker.getUrl()).thenReturn(consumerURL);
     Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);
     MigrationInvoker&lt;?&gt; migrationInvoker = new MigrationInvoker&lt;&gt;(registryProtocol, null, null, DemoService.class, null, consumerURL);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"all"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker invoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory directory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(invoker.getDirectory()).thenReturn(directory);

    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);

    Mockito.when(invoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(invoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;Invoker&lt;?&gt;&gt; invokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);

    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);

    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);

    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceInterface()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getGroup()).thenReturn(<span class="hljs-string">"Group"</span>);

    Mockito.when(consumerURL.getVersion()).thenReturn(<span class="hljs-string">"0.0.0"</span>);

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Group/Test:0.0.0"</span>);

    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn(<span class="hljs-string">"Test:0.0.0"</span>);

    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());

    Mockito.when(invoker.getUrl()).thenReturn(consumerURL);

    Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);

    MigrationInvoker&lt;?&gt; migrationInvoker = <span class="hljs-keyword">new</span> MigrationInvoker&lt;&gt;(registryProtocol, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">null</span>, <span class="hljs-title">consumerURL</span>)</span>;

    MigrationRule migrationRule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">3</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">4</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">5</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">3</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">4</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">5</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">6</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">6</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">7</span>)).invoke(<span class="hljs-keyword">null</span>);

    Assertions.assertNull(migrationInvoker.getInvoker());

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">7</span>)).invoke(<span class="hljs-keyword">null</span>);

    Assertions.assertNull(migrationInvoker.getServiceDiscoveryInvoker());

    ArgumentCaptor&lt;InvokersChangedListener&gt; argument = ArgumentCaptor.forClass(InvokersChangedListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(serviceDiscoveryDirectory, Mockito.atLeastOnce()).setInvokersChangedListener(argument.capture());

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">27</span>)).invoke(<span class="hljs-keyword">null</span>);

    serviceDiscoveryInvokers.remove(<span class="hljs-number">1</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">false</span>);

    argument.getAllValues().get(argument.getAllValues().size() - <span class="hljs-number">1</span>).onChange();

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">27</span>)).invoke(<span class="hljs-keyword">null</span>);

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    argument.getAllValues().get(argument.getAllValues().size() - <span class="hljs-number">1</span>).onChange();

    Mockito.when(migrationRule.getProportion(Mockito.any())).thenReturn(<span class="hljs-number">50</span>);

    migrationInvoker.setMigrationRule(migrationRule);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(serviceDiscoveryInvoker, Mockito.atMost(<span class="hljs-number">1026</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.atLeast(<span class="hljs-number">28</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getDelay(Mockito.any())).thenReturn(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">long</span> currentTimeMillis = System.currentTimeMillis();

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    Assertions.assertTrue(System.currentTimeMillis() - currentTimeMillis &gt;= <span class="hljs-number">2000</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RegistryProtocol <span class="hljs-title">createMockRegistryProtocol</span><span class="hljs-params">(ClusterInvoker invoker, ClusterInvoker serviceDiscoveryInvoker)</span> </span>{
    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);
    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);
    <span class="hljs-keyword">return</span> registryProtocol;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest32">Test Case ID #dubbo_Test_3_2</h4>
<h4 id="test-case-name-testdecidefile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationinvokertestjava">Test Case Name: <code>testDecide</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-registryprotocol">Mock Object Variable Name: <code>registryProtocol</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 void testDecide() {
<span class="hljs-deletion">-    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol.class);</span>
     ClusterInvoker invoker = Mockito.mock(ClusterInvoker.class);
     ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker.class);
     DynamicDirectory directory = Mockito.mock(DynamicDirectory.class);
     DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory.class);
     Mockito.when(invoker.getDirectory()).thenReturn(directory);
     Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);
     Mockito.when(invoker.isAvailable()).thenReturn(true);
     Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(true);
     Mockito.when(invoker.hasProxyInvokers()).thenReturn(true);
     Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(true);
     List&lt;Invoker&lt;?&gt;&gt; invokers = new LinkedList&lt;&gt;();
     invokers.add(Mockito.mock(Invoker.class));
     invokers.add(Mockito.mock(Invoker.class));
     List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = new LinkedList&lt;&gt;();
     serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
     serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
     Mockito.when(directory.getAllInvokers()).thenReturn(invokers);
     Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);
<span class="hljs-addition">+    RegistryProtocol registryProtocol = createMockRegistryProtocol(invoker, serviceDiscoveryInvoker);</span>
     URL consumerURL = Mockito.mock(URL.class);
     Mockito.when(consumerURL.getServiceInterface()).thenReturn("Test");
     Mockito.when(consumerURL.getGroup()).thenReturn("Group");
     Mockito.when(consumerURL.getVersion()).thenReturn("0.0.0");
     Mockito.when(consumerURL.getServiceKey()).thenReturn("Group/Test:0.0.0");
     Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn("Test:0.0.0");
     Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());
     Mockito.when(invoker.getUrl()).thenReturn(consumerURL);
     Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);
     MigrationInvoker&lt;?&gt; migrationInvoker = new MigrationInvoker&lt;&gt;(registryProtocol, null, null, DemoService.class, null, consumerURL);
     MigrationRule migrationRule = Mockito.mock(MigrationRule.class);
     Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(true);
     migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);
     migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);
     migrationInvoker.invoke(null);
     Mockito.verify(serviceDiscoveryInvoker, Mockito.times(1)).invoke(null);
     Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(false);
     migrationInvoker.invoke(null);
     Mockito.verify(invoker, Mockito.times(1)).invoke(null);
     Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(true);
     migrationInvoker.invoke(null);
     Mockito.verify(serviceDiscoveryInvoker, Mockito.times(2)).invoke(null);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"all"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testDecide</span><span class="hljs-params">()</span> </span>{

    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker invoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory directory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(invoker.getDirectory()).thenReturn(directory);

    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);

    Mockito.when(invoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(invoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;Invoker&lt;?&gt;&gt; invokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);

    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);

    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);

    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceInterface()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getGroup()).thenReturn(<span class="hljs-string">"Group"</span>);

    Mockito.when(consumerURL.getVersion()).thenReturn(<span class="hljs-string">"0.0.0"</span>);

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Group/Test:0.0.0"</span>);

    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn(<span class="hljs-string">"Test:0.0.0"</span>);

    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());

    Mockito.when(invoker.getUrl()).thenReturn(consumerURL);

    Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);

    MigrationInvoker&lt;?&gt; migrationInvoker = <span class="hljs-keyword">new</span> MigrationInvoker&lt;&gt;(registryProtocol, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">null</span>, <span class="hljs-title">consumerURL</span>)</span>;

    MigrationRule migrationRule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RegistryProtocol <span class="hljs-title">createMockRegistryProtocol</span><span class="hljs-params">(ClusterInvoker invoker, ClusterInvoker serviceDiscoveryInvoker)</span> </span>{
    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);
    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);
    <span class="hljs-keyword">return</span> registryProtocol;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci4">Mock Clone Instance #dubbo_MCI_4</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.registry.client.migration.MigrationRuleHandler&lt;?&gt;</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MigrationRuleHandler&lt;?&gt; handler;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    handler = Mockito.mock(MigrationRuleHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">verboseLogging</span>())</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
handler

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest41">Test Case ID #dubbo_Test_4_1</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationrulelistenertestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationRuleListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-handler">Mock Object Variable Name: <code>handler</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     System.setProperty("dubbo.application.migration.delay", "1");
<span class="hljs-deletion">-    MigrationRuleHandler&lt;?&gt; handler = Mockito.mock(MigrationRuleHandler.class, Mockito.withSettings().verboseLogging());</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `handler`</span>
     CountDownLatch countDownLatch = new CountDownLatch(1);
     MigrationRuleListener migrationRuleListener = new MigrationRuleListener(ApplicationModel.defaultModel().getDefaultModule()) {
@@
     migrationRuleListener.getHandlers().put(migrationInvoker, handler);
     countDownLatch.countDown();
     await().untilAsserted(() -&gt; {
<span class="hljs-deletion">-        Mockito.verify(handler).doMigrate(Mockito.any());</span>
<span class="hljs-addition">+        Mockito.verify(handler).doMigrate(Mockito.any());</span>
     });
     //        Mockito.verify(handler, Mockito.timeout(5000)).doMigrate(Mockito.any());
     migrationRuleListener.onRefer(null, migrationInvoker, consumerURL, null);
<span class="hljs-deletion">-    Mockito.verify(handler, Mockito.times(2)).doMigrate(Mockito.any());</span>
<span class="hljs-addition">+    Mockito.verify(handler, Mockito.times(2)).doMigrate(Mockito.any());</span>
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Listener started with config center and local rule, no initial remote rule.

 * Check local rule take effect

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    DynamicConfiguration dynamicConfiguration = Mockito.mock(DynamicConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ApplicationModel.reset();

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setDynamicConfiguration(dynamicConfiguration);

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setLocalMigrationRule(localRule);

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"demo-consumer"</span>);

    ApplicationModel.defaultModel().getApplicationConfigManager().setApplication(applicationConfig);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getParameter(<span class="hljs-string">"timestamp"</span>)).thenReturn(<span class="hljs-string">"1"</span>);

    System.setProperty(<span class="hljs-string">"dubbo.application.migration.delay"</span>, <span class="hljs-string">"1"</span>);

    MigrationRuleHandler&lt;?&gt; handler = Mockito.mock(MigrationRuleHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">verboseLogging</span>())</span>;

    CountDownLatch countDownLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    MigrationRuleListener migrationRuleListener = <span class="hljs-keyword">new</span> MigrationRuleListener(ApplicationModel.defaultModel().getDefaultModule()) {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">process</span><span class="hljs-params">(ConfigChangedEvent event)</span> </span>{

            <span class="hljs-keyword">try</span> {

                countDownLatch.await();

            } <span class="hljs-keyword">catch</span> (InterruptedException e) {

                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);

            }

            <span class="hljs-keyword">super</span>.process(event);

        }

    };

    MigrationInvoker&lt;?&gt; migrationInvoker = Mockito.mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    migrationRuleListener.getHandlers().put(migrationInvoker, handler);

    countDownLatch.countDown();

    await().untilAsserted(() -&gt; {

        Mockito.verify(handler).doMigrate(Mockito.any());

    });

    <span class="hljs-comment">//        Mockito.verify(handler, Mockito.timeout(5000)).doMigrate(Mockito.any());</span>

    migrationRuleListener.onRefer(<span class="hljs-keyword">null</span>, migrationInvoker, consumerURL, <span class="hljs-keyword">null</span>);

    Mockito.verify(handler, Mockito.times(<span class="hljs-number">2</span>)).doMigrate(Mockito.any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MigrationRuleHandler&lt;?&gt; handler;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    handler = Mockito.mock(MigrationRuleHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">verboseLogging</span>())</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
handler

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest42">Test Case ID #dubbo_Test_4_2</h4>
<h4 id="test-case-name-testwithinitandnolocalrulefile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationrulelistenertestjava">Test Case Name: <code>testWithInitAndNoLocalRule</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationRuleListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-handler">Mock Object Variable Name: <code>handler</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     System.setProperty("dubbo.application.migration.delay", "1000");
<span class="hljs-deletion">-    MigrationRuleHandler&lt;?&gt; handler = Mockito.mock(MigrationRuleHandler.class, Mockito.withSettings().verboseLogging());</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `handler`</span>
     MigrationRuleListener migrationRuleListener = new MigrationRuleListener(ApplicationModel.defaultModel().getDefaultModule());
     MigrationInvoker&lt;?&gt; migrationInvoker = Mockito.mock(MigrationInvoker.class);
     migrationRuleListener.getHandlers().put(migrationInvoker, handler);
     migrationRuleListener.onRefer(null, migrationInvoker, consumerURL, null);
     // check migration happened after invoker referred
<span class="hljs-deletion">-    Mockito.verify(handler, Mockito.times(1)).doMigrate(MigrationRule.getInitRule());</span>
<span class="hljs-addition">+    Mockito.verify(handler, Mockito.times(1)).doMigrate(MigrationRule.getInitRule());</span>
     // check no delay tasks created for there's no local rule and no config center
     Assertions.assertNull(migrationRuleListener.localRuleMigrationFuture);
     Assertions.assertNull(migrationRuleListener.ruleMigrationFuture);
     Assertions.assertEquals(0, migrationRuleListener.ruleQueue.size());
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Test listener started without local rule and config center, INIT should be used and no scheduled task should be started.

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testWithInitAndNoLocalRule</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setDynamicConfiguration(<span class="hljs-keyword">null</span>);

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setLocalMigrationRule(<span class="hljs-string">""</span>);

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"demo-consumer"</span>);

    ApplicationModel.defaultModel().getApplicationConfigManager().setApplication(applicationConfig);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getParameter(<span class="hljs-string">"timestamp"</span>)).thenReturn(<span class="hljs-string">"1"</span>);

    System.setProperty(<span class="hljs-string">"dubbo.application.migration.delay"</span>, <span class="hljs-string">"1000"</span>);

    MigrationRuleHandler&lt;?&gt; handler = Mockito.mock(MigrationRuleHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">verboseLogging</span>())</span>;

    MigrationRuleListener migrationRuleListener = <span class="hljs-keyword">new</span> MigrationRuleListener(ApplicationModel.defaultModel().getDefaultModule());

    MigrationInvoker&lt;?&gt; migrationInvoker = Mockito.mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    migrationRuleListener.getHandlers().put(migrationInvoker, handler);

    migrationRuleListener.onRefer(<span class="hljs-keyword">null</span>, migrationInvoker, consumerURL, <span class="hljs-keyword">null</span>);

    <span class="hljs-comment">// check migration happened after invoker referred</span>

    Mockito.verify(handler, Mockito.times(<span class="hljs-number">1</span>)).doMigrate(MigrationRule.getInitRule());

    <span class="hljs-comment">// check no delay tasks created for there's no local rule and no config center</span>

    Assertions.assertNull(migrationRuleListener.localRuleMigrationFuture);

    Assertions.assertNull(migrationRuleListener.ruleMigrationFuture);

    Assertions.assertEquals(<span class="hljs-number">0</span>, migrationRuleListener.ruleQueue.size());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MigrationRuleHandler&lt;?&gt; handler;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    handler = Mockito.mock(MigrationRuleHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">verboseLogging</span>())</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
handler

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest43">Test Case ID #dubbo_Test_4_3</h4>
<h4 id="test-case-name-testwithconfigurationlistenerandlocalrulefile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationrulelistenertestjava">Test Case Name: <code>testWithConfigurationListenerAndLocalRule</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationRuleListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-handler">Mock Object Variable Name: <code>handler</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     System.setProperty("dubbo.application.migration.delay", "10");
<span class="hljs-deletion">-    MigrationRuleHandler&lt;?&gt; handler = Mockito.mock(MigrationRuleHandler.class, Mockito.withSettings().verboseLogging());</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `handler`</span>
     MigrationRuleHandler&lt;?&gt; handler2 = Mockito.mock(MigrationRuleHandler.class, Mockito.withSettings().verboseLogging());
     // Both local rule and remote rule are here
     // Local rule with one delayed task started to apply
     MigrationRuleListener migrationRuleListener = new MigrationRuleListener(ApplicationModel.defaultModel().getDefaultModule());
@@
     migrationRuleListener.getHandlers().put(migrationInvoker, handler);
     migrationRuleListener.onRefer(null, migrationInvoker, consumerURL, null);
     MigrationRule tmpRemoteRule = migrationRuleListener.getRule();
     ArgumentCaptor&lt;MigrationRule&gt; captor = ArgumentCaptor.forClass(MigrationRule.class);
<span class="hljs-deletion">-    Mockito.verify(handler, Mockito.times(1)).doMigrate(captor.capture());</span>
<span class="hljs-addition">+    Mockito.verify(handler, Mockito.times(1)).doMigrate(captor.capture());</span>
     Assertions.assertEquals(tmpRemoteRule, captor.getValue());
     await().until(() -&gt; migrationRuleListener.localRuleMigrationFuture.isDone());
     Assertions.assertNull(migrationRuleListener.ruleMigrationFuture);
     Assertions.assertEquals(tmpRemoteRule, migrationRuleListener.getRule());
<span class="hljs-deletion">-    Mockito.verify(handler, Mockito.times(1)).doMigrate(Mockito.any());</span>
<span class="hljs-addition">+    Mockito.verify(handler, Mockito.times(1)).doMigrate(Mockito.any());</span>
     ArgumentCaptor&lt;MigrationRule&gt; captor2 = ArgumentCaptor.forClass(MigrationRule.class);
     migrationRuleListener.getHandlers().put(migrationInvoker2, handler2);
     migrationRuleListener.onRefer(null, migrationInvoker2, consumerURL2, null);
     Mockito.verify(handler2, Mockito.times(1)).doMigrate(captor2.capture());
     Assertions.assertEquals(tmpRemoteRule, captor2.getValue());
     migrationRuleListener.process(new ConfigChangedEvent("key", "group", dynamicRemoteRule));
     await().until(migrationRuleListener.ruleQueue::isEmpty);
     await().untilAsserted(() -&gt; {
<span class="hljs-deletion">-        Mockito.verify(handler, Mockito.times(2)).doMigrate(Mockito.any());</span>
<span class="hljs-addition">+        Mockito.verify(handler, Mockito.times(2)).doMigrate(Mockito.any());</span>
         Mockito.verify(handler2, Mockito.times(2)).doMigrate(Mockito.any());
     });
     Assertions.assertNotNull(migrationRuleListener.ruleMigrationFuture);
     ArgumentCaptor&lt;MigrationRule&gt; captor_event = ArgumentCaptor.forClass(MigrationRule.class);
<span class="hljs-deletion">-    Mockito.verify(handler, Mockito.times(2)).doMigrate(captor_event.capture());</span>
<span class="hljs-addition">+    Mockito.verify(handler, Mockito.times(2)).doMigrate(captor_event.capture());</span>
     Assertions.assertEquals("APPLICATION_FIRST", captor_event.getValue().getStep().toString());
     Mockito.verify(handler2, Mockito.times(2)).doMigrate(captor_event.capture());
     Assertions.assertEquals("APPLICATION_FIRST", captor_event.getValue().getStep().toString());
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Listener with config center initial remote rule and local rule, check

 * 1. initial remote rule other than local rule take effect

 * 2. remote rule change and all invokers gets notified

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testWithConfigurationListenerAndLocalRule</span><span class="hljs-params">()</span> </span>{

    DynamicConfiguration dynamicConfiguration = Mockito.mock(DynamicConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.doReturn(remoteRule).when(dynamicConfiguration).getConfig(Mockito.anyString(), Mockito.anyString());

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setDynamicConfiguration(dynamicConfiguration);

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setLocalMigrationRule(localRule);

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"demo-consumer"</span>);

    ApplicationModel.defaultModel().getApplicationConfigManager().setApplication(applicationConfig);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getParameter(<span class="hljs-string">"timestamp"</span>)).thenReturn(<span class="hljs-string">"1"</span>);

    URL consumerURL2 = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL2.getServiceKey()).thenReturn(<span class="hljs-string">"Test2"</span>);

    Mockito.when(consumerURL2.getParameter(<span class="hljs-string">"timestamp"</span>)).thenReturn(<span class="hljs-string">"2"</span>);

    System.setProperty(<span class="hljs-string">"dubbo.application.migration.delay"</span>, <span class="hljs-string">"10"</span>);

    MigrationRuleHandler&lt;?&gt; handler = Mockito.mock(MigrationRuleHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">verboseLogging</span>())</span>;

    MigrationRuleHandler&lt;?&gt; handler2 = Mockito.mock(MigrationRuleHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">verboseLogging</span>())</span>;

    <span class="hljs-comment">// Both local rule and remote rule are here</span>

    <span class="hljs-comment">// Local rule with one delayed task started to apply</span>

    MigrationRuleListener migrationRuleListener = <span class="hljs-keyword">new</span> MigrationRuleListener(ApplicationModel.defaultModel().getDefaultModule());

    Assertions.assertNotNull(migrationRuleListener.localRuleMigrationFuture);

    Assertions.assertNull(migrationRuleListener.ruleMigrationFuture);

    MigrationInvoker&lt;?&gt; migrationInvoker = Mockito.mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationInvoker&lt;?&gt; migrationInvoker2 = Mockito.mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// Remote rule will be applied when onRefer gets executed</span>

    migrationRuleListener.getHandlers().put(migrationInvoker, handler);

    migrationRuleListener.onRefer(<span class="hljs-keyword">null</span>, migrationInvoker, consumerURL, <span class="hljs-keyword">null</span>);

    MigrationRule tmpRemoteRule = migrationRuleListener.getRule();

    ArgumentCaptor&lt;MigrationRule&gt; captor = ArgumentCaptor.forClass(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(handler, Mockito.times(<span class="hljs-number">1</span>)).doMigrate(captor.capture());

    Assertions.assertEquals(tmpRemoteRule, captor.getValue());

    await().until(() -&gt; migrationRuleListener.localRuleMigrationFuture.isDone());

    Assertions.assertNull(migrationRuleListener.ruleMigrationFuture);

    Assertions.assertEquals(tmpRemoteRule, migrationRuleListener.getRule());

    Mockito.verify(handler, Mockito.times(<span class="hljs-number">1</span>)).doMigrate(Mockito.any());

    ArgumentCaptor&lt;MigrationRule&gt; captor2 = ArgumentCaptor.forClass(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    migrationRuleListener.getHandlers().put(migrationInvoker2, handler2);

    migrationRuleListener.onRefer(<span class="hljs-keyword">null</span>, migrationInvoker2, consumerURL2, <span class="hljs-keyword">null</span>);

    Mockito.verify(handler2, Mockito.times(<span class="hljs-number">1</span>)).doMigrate(captor2.capture());

    Assertions.assertEquals(tmpRemoteRule, captor2.getValue());

    migrationRuleListener.process(<span class="hljs-keyword">new</span> ConfigChangedEvent(<span class="hljs-string">"key"</span>, <span class="hljs-string">"group"</span>, dynamicRemoteRule));

    await().until(migrationRuleListener.ruleQueue::isEmpty);

    await().untilAsserted(() -&gt; {

        Mockito.verify(handler, Mockito.times(<span class="hljs-number">2</span>)).doMigrate(Mockito.any());

        Mockito.verify(handler2, Mockito.times(<span class="hljs-number">2</span>)).doMigrate(Mockito.any());

    });

    Assertions.assertNotNull(migrationRuleListener.ruleMigrationFuture);

    ArgumentCaptor&lt;MigrationRule&gt; captor_event = ArgumentCaptor.forClass(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(handler, Mockito.times(<span class="hljs-number">2</span>)).doMigrate(captor_event.capture());

    Assertions.assertEquals(<span class="hljs-string">"APPLICATION_FIRST"</span>, captor_event.getValue().getStep().toString());

    Mockito.verify(handler2, Mockito.times(<span class="hljs-number">2</span>)).doMigrate(captor_event.capture());

    Assertions.assertEquals(<span class="hljs-string">"APPLICATION_FIRST"</span>, captor_event.getValue().getStep().toString());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MigrationRuleHandler&lt;?&gt; handler;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    handler = Mockito.mock(MigrationRuleHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">verboseLogging</span>())</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
handler

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci5">Mock Clone Instance #dubbo_MCI_5</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.registry.nacos.NacosConnectionManager</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> NacosConnectionManager <span class="hljs-title">createMockNacosConnectionManager</span><span class="hljs-params">(NamingService namingService)</span> </span>{
    NacosConnectionManager connectionManager = Mockito.mock(NacosConnectionManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(connectionManager.getNamingService()).thenReturn(namingService);
    <span class="hljs-keyword">return</span> connectionManager;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest51">Test Case ID #dubbo_Test_5_1</h4>
<h4 id="test-case-name-testsubscribefile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-nacossrctestjavaorgapachedubboregistrynacosnacosnamingservicewrappertestjava">Test Case Name: <code>testSubscribe</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-nacos\src\test\java\org\apache\dubbo\registry\nacos\NacosNamingServiceWrapperTest.java</code>)</h4>
<h4 id="mock-object-variable-name-connectionmanager">Mock Object Variable Name: <code>connectionManager</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 void testSubscribe() throws NacosException {
<span class="hljs-deletion">-    NacosConnectionManager connectionManager = Mockito.mock(NacosConnectionManager.class);</span>
     NamingService namingService = Mockito.mock(NamingService.class);
<span class="hljs-deletion">-    Mockito.when(connectionManager.getNamingService()).thenReturn(namingService);</span>
<span class="hljs-addition">+    NacosConnectionManager connectionManager = createMockNacosConnectionManager(namingService);</span>
     NacosNamingServiceWrapper nacosNamingServiceWrapper = new NacosNamingServiceWrapper(connectionManager, 0, 0);
     EventListener eventListener = Mockito.mock(EventListener.class);
     nacosNamingServiceWrapper.subscribe("service_name", "test", eventListener);
     Mockito.verify(namingService, Mockito.times(1)).subscribe("service_name", "test", eventListener);
     nacosNamingServiceWrapper.subscribe("service_name", "test", eventListener);
     Mockito.verify(namingService, Mockito.times(2)).subscribe("service_name", "test", eventListener);
     nacosNamingServiceWrapper.unsubscribe("service_name", "test", eventListener);
     Mockito.verify(namingService, Mockito.times(1)).unsubscribe("service_name", "test", eventListener);
     nacosNamingServiceWrapper.unsubscribe("service_name", "test", eventListener);
     Mockito.verify(namingService, Mockito.times(1)).unsubscribe("service_name", "test", eventListener);
     nacosNamingServiceWrapper.unsubscribe("service_name", "mock", eventListener);
     Mockito.verify(namingService, Mockito.times(0)).unsubscribe("service_name", "mock", eventListener);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testSubscribe</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NacosException </span>{

    NacosConnectionManager connectionManager = Mockito.mock(NacosConnectionManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    NamingService namingService = Mockito.mock(NamingService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(connectionManager.getNamingService()).thenReturn(namingService);

    NacosNamingServiceWrapper nacosNamingServiceWrapper = <span class="hljs-keyword">new</span> NacosNamingServiceWrapper(connectionManager, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

    EventListener eventListener = Mockito.mock(EventListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    nacosNamingServiceWrapper.subscribe(<span class="hljs-string">"service_name"</span>, <span class="hljs-string">"test"</span>, eventListener);

    Mockito.verify(namingService, Mockito.times(<span class="hljs-number">1</span>)).subscribe(<span class="hljs-string">"service_name"</span>, <span class="hljs-string">"test"</span>, eventListener);

    nacosNamingServiceWrapper.subscribe(<span class="hljs-string">"service_name"</span>, <span class="hljs-string">"test"</span>, eventListener);

    Mockito.verify(namingService, Mockito.times(<span class="hljs-number">2</span>)).subscribe(<span class="hljs-string">"service_name"</span>, <span class="hljs-string">"test"</span>, eventListener);

    nacosNamingServiceWrapper.unsubscribe(<span class="hljs-string">"service_name"</span>, <span class="hljs-string">"test"</span>, eventListener);

    Mockito.verify(namingService, Mockito.times(<span class="hljs-number">1</span>)).unsubscribe(<span class="hljs-string">"service_name"</span>, <span class="hljs-string">"test"</span>, eventListener);

    nacosNamingServiceWrapper.unsubscribe(<span class="hljs-string">"service_name"</span>, <span class="hljs-string">"test"</span>, eventListener);

    Mockito.verify(namingService, Mockito.times(<span class="hljs-number">1</span>)).unsubscribe(<span class="hljs-string">"service_name"</span>, <span class="hljs-string">"test"</span>, eventListener);

    nacosNamingServiceWrapper.unsubscribe(<span class="hljs-string">"service_name"</span>, <span class="hljs-string">"mock"</span>, eventListener);

    Mockito.verify(namingService, Mockito.times(<span class="hljs-number">0</span>)).unsubscribe(<span class="hljs-string">"service_name"</span>, <span class="hljs-string">"mock"</span>, eventListener);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> NacosConnectionManager <span class="hljs-title">createMockNacosConnectionManager</span><span class="hljs-params">(NamingService namingService)</span> </span>{
    NacosConnectionManager connectionManager = Mockito.mock(NacosConnectionManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(connectionManager.getNamingService()).thenReturn(namingService);
    <span class="hljs-keyword">return</span> connectionManager;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest52">Test Case ID #dubbo_Test_5_2</h4>
<h4 id="test-case-name-testconcurrencyfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-nacossrctestjavaorgapachedubboregistrynacosnacosnamingservicewrappertestjava">Test Case Name: <code>testConcurrency</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-nacos\src\test\java\org\apache\dubbo\registry\nacos\NacosNamingServiceWrapperTest.java</code>)</h4>
<h4 id="mock-object-variable-name-connectionmanager">Mock Object Variable Name: <code>connectionManager</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testConcurrency() throws NacosException, InterruptedException {
<span class="hljs-deletion">-    NacosConnectionManager connectionManager = Mockito.mock(NacosConnectionManager.class);</span>
     CountDownLatch startLatch = new CountDownLatch(1);
     CountDownLatch stopLatch = new CountDownLatch(1);
     NamingService namingService = Mockito.mock(NamingService.class);
<span class="hljs-addition">+    NacosConnectionManager connectionManager = createMockNacosConnectionManager(namingService);</span>
<span class="hljs-deletion">-    Mockito.when(connectionManager.getNamingService()).thenReturn(namingService);</span>
     NacosNamingServiceWrapper nacosNamingServiceWrapper = new NacosNamingServiceWrapper(connectionManager, false, 0, 0);
     Instance instance = new Instance();
     nacosNamingServiceWrapper.registerInstance("service_name", "test", instance);
     NacosNamingServiceWrapper.InstancesInfo instancesInfo = nacosNamingServiceWrapper.getRegisterStatus().get(new NacosNamingServiceWrapper.InstanceId("service_name", "test"));
     Assertions.assertEquals(1, instancesInfo.getInstances().size());
     nacosNamingServiceWrapper.getRegisterStatus().put(new NacosNamingServiceWrapper.InstanceId("service_name", "test"), new NacosNamingServiceWrapper.InstancesInfo() {

         private final NacosNamingServiceWrapper.InstancesInfo delegate = instancesInfo;

         @Override
         public void lock() {
             delegate.lock();
         }

         @Override
         public void unlock() {
             delegate.unlock();
         }

         @Override
         public List&lt;NacosNamingServiceWrapper.InstanceInfo&gt; getInstances() {
             try {
                 if (startLatch.getCount() &gt; 0) {
                     Thread.sleep(1000);
                     startLatch.countDown();
                     Thread.sleep(1000);
                 }
             } catch (InterruptedException e) {
                 throw new RuntimeException(e);
             }
             return delegate.getInstances();
         }

         @Override
         public boolean isBatchRegistered() {
             return delegate.isBatchRegistered();
         }

         @Override
         public void setBatchRegistered(boolean batchRegistered) {
             delegate.setBatchRegistered(batchRegistered);
         }

         @Override
         public boolean isValid() {
             return delegate.isValid();
         }

         @Override
         public void setValid(boolean valid) {
             delegate.setValid(valid);
         }
     });
     new Thread(() -&gt; {
         try {
             startLatch.await();
             nacosNamingServiceWrapper.registerInstance("service_name", "test", instance);
             stopLatch.countDown();
         } catch (Exception e) {
             throw new RuntimeException(e);
         }
     }).start();
     new Thread(() -&gt; {
         try {
             nacosNamingServiceWrapper.deregisterInstance("service_name", "test", instance);
         } catch (NacosException e) {
             throw new RuntimeException(e);
         }
     }).start();
     stopLatch.await();
     NacosNamingServiceWrapper.InstancesInfo instancesInfoNew = nacosNamingServiceWrapper.getRegisterStatus().get(new NacosNamingServiceWrapper.InstanceId("service_name", "test"));
     Assertions.assertEquals(1, instancesInfoNew.getInstances().size());
     Assertions.assertNotEquals(instancesInfo, instancesInfoNew);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConcurrency</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NacosException, InterruptedException </span>{

    NacosConnectionManager connectionManager = Mockito.mock(NacosConnectionManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    CountDownLatch startLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    CountDownLatch stopLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    NamingService namingService = Mockito.mock(NamingService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(connectionManager.getNamingService()).thenReturn(namingService);

    NacosNamingServiceWrapper nacosNamingServiceWrapper = <span class="hljs-keyword">new</span> NacosNamingServiceWrapper(connectionManager, <span class="hljs-keyword">false</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

    Instance instance = <span class="hljs-keyword">new</span> Instance();

    nacosNamingServiceWrapper.registerInstance(<span class="hljs-string">"service_name"</span>, <span class="hljs-string">"test"</span>, instance);

    NacosNamingServiceWrapper.InstancesInfo instancesInfo = nacosNamingServiceWrapper.getRegisterStatus().get(<span class="hljs-keyword">new</span> NacosNamingServiceWrapper.InstanceId(<span class="hljs-string">"service_name"</span>, <span class="hljs-string">"test"</span>));

    Assertions.assertEquals(<span class="hljs-number">1</span>, instancesInfo.getInstances().size());

    nacosNamingServiceWrapper.getRegisterStatus().put(<span class="hljs-keyword">new</span> NacosNamingServiceWrapper.InstanceId(<span class="hljs-string">"service_name"</span>, <span class="hljs-string">"test"</span>), <span class="hljs-keyword">new</span> NacosNamingServiceWrapper.InstancesInfo() {



        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> NacosNamingServiceWrapper.InstancesInfo delegate = instancesInfo;



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">lock</span><span class="hljs-params">()</span> </span>{

            delegate.lock();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">()</span> </span>{

            delegate.unlock();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> List&lt;NacosNamingServiceWrapper.InstanceInfo&gt; getInstances() {

            <span class="hljs-keyword">try</span> {

                <span class="hljs-keyword">if</span> (startLatch.getCount() &gt; <span class="hljs-number">0</span>) {

                    Thread.sleep(<span class="hljs-number">1000</span>);

                    startLatch.countDown();

                    Thread.sleep(<span class="hljs-number">1000</span>);

                }

            } <span class="hljs-keyword">catch</span> (InterruptedException e) {

                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);

            }

            <span class="hljs-keyword">return</span> delegate.getInstances();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isBatchRegistered</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> delegate.isBatchRegistered();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBatchRegistered</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> batchRegistered)</span> </span>{

            delegate.setBatchRegistered(batchRegistered);

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isValid</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> delegate.isValid();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setValid</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> valid)</span> </span>{

            delegate.setValid(valid);

        }

    });

    <span class="hljs-keyword">new</span> Thread(() -&gt; {

        <span class="hljs-keyword">try</span> {

            startLatch.await();

            nacosNamingServiceWrapper.registerInstance(<span class="hljs-string">"service_name"</span>, <span class="hljs-string">"test"</span>, instance);

            stopLatch.countDown();

        } <span class="hljs-keyword">catch</span> (Exception e) {

            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);

        }

    }).start();

    <span class="hljs-keyword">new</span> Thread(() -&gt; {

        <span class="hljs-keyword">try</span> {

            nacosNamingServiceWrapper.deregisterInstance(<span class="hljs-string">"service_name"</span>, <span class="hljs-string">"test"</span>, instance);

        } <span class="hljs-keyword">catch</span> (NacosException e) {

            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);

        }

    }).start();

    stopLatch.await();

    NacosNamingServiceWrapper.InstancesInfo instancesInfoNew = nacosNamingServiceWrapper.getRegisterStatus().get(<span class="hljs-keyword">new</span> NacosNamingServiceWrapper.InstanceId(<span class="hljs-string">"service_name"</span>, <span class="hljs-string">"test"</span>));

    Assertions.assertEquals(<span class="hljs-number">1</span>, instancesInfoNew.getInstances().size());

    Assertions.assertNotEquals(instancesInfo, instancesInfoNew);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> NacosConnectionManager <span class="hljs-title">createMockNacosConnectionManager</span><span class="hljs-params">(NamingService namingService)</span> </span>{
    NacosConnectionManager connectionManager = Mockito.mock(NacosConnectionManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(connectionManager.getNamingService()).thenReturn(namingService);
    <span class="hljs-keyword">return</span> connectionManager;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci6">Mock Clone Instance #dubbo_MCI_6</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.common.utils.Log</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Log <span class="hljs-title">createMockLog</span><span class="hljs-params">(Level logLevelReturn)</span> </span>{
    Log log = mock(Log<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(log.getLogLevel()).thenReturn(logLevelReturn);
    <span class="hljs-keyword">return</span> log;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest61">Test Case ID #dubbo_Test_6_1</h4>
<h4 id="test-case-name-testchecknoerrorfile-cjavaprojectsapachedubbodubbo-commonsrctestjavaorgapachedubbocommonutilslogutiltestjava">Test Case Name: <code>testCheckNoError</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-common\src\test\java\org\apache\dubbo\common\utils\LogUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-log">Mock Object Variable Name: <code>log</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void testCheckNoError() {
<span class="hljs-deletion">-    Log log = mock(Log.class);</span>
<span class="hljs-deletion">-    DubboAppender.logList.add(log);</span>
<span class="hljs-deletion">-    when(log.getLogLevel()).thenReturn(Level.ERROR);</span>
<span class="hljs-addition">+    Log log = createMockLog(Level.ERROR);</span>
<span class="hljs-addition">+    DubboAppender.logList.add(log);</span>
     assertThat(LogUtil.checkNoError(), is(false));
<span class="hljs-deletion">-    when(log.getLogLevel()).thenReturn(Level.INFO);</span>
<span class="hljs-addition">+    when(log.getLogLevel()).thenReturn(Level.INFO);</span>
     assertThat(LogUtil.checkNoError(), is(true));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testCheckNoError</span><span class="hljs-params">()</span> </span>{

    Log log = mock(Log<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DubboAppender.logList.add(log);

    when(log.getLogLevel()).thenReturn(Level.ERROR);

    assertThat(LogUtil.checkNoError(), is(<span class="hljs-keyword">false</span>));

    when(log.getLogLevel()).thenReturn(Level.INFO);

    assertThat(LogUtil.checkNoError(), is(<span class="hljs-keyword">true</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Log <span class="hljs-title">createMockLog</span><span class="hljs-params">(Level logLevelReturn)</span> </span>{
    Log log = mock(Log<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(log.getLogLevel()).thenReturn(logLevelReturn);
    <span class="hljs-keyword">return</span> log;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest62">Test Case ID #dubbo_Test_6_2</h4>
<h4 id="test-case-name-testfindlevelfile-cjavaprojectsapachedubbodubbo-commonsrctestjavaorgapachedubbocommonutilslogutiltestjava">Test Case Name: <code>testFindLevel</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-common\src\test\java\org\apache\dubbo\common\utils\LogUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-log">Mock Object Variable Name: <code>log</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 void testFindLevel() {
<span class="hljs-deletion">-    Log log = mock(Log.class);</span>
<span class="hljs-addition">+    Log log = createMockLog(Level.ERROR);</span>
     DubboAppender.logList.add(log);
<span class="hljs-deletion">-    when(log.getLogLevel()).thenReturn(Level.ERROR);</span>
     assertThat(LogUtil.findLevel(Level.ERROR), equalTo(1));
     assertThat(LogUtil.findLevel(Level.INFO), equalTo(0));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testFindLevel</span><span class="hljs-params">()</span> </span>{

    Log log = mock(Log<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DubboAppender.logList.add(log);

    when(log.getLogLevel()).thenReturn(Level.ERROR);

    assertThat(LogUtil.findLevel(Level.ERROR), equalTo(<span class="hljs-number">1</span>));

    assertThat(LogUtil.findLevel(Level.INFO), equalTo(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Log <span class="hljs-title">createMockLog</span><span class="hljs-params">(Level logLevelReturn)</span> </span>{
    Log log = mock(Log<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(log.getLogLevel()).thenReturn(logLevelReturn);
    <span class="hljs-keyword">return</span> log;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest63">Test Case ID #dubbo_Test_6_3</h4>
<h4 id="test-case-name-testfindlevelwiththreadnamefile-cjavaprojectsapachedubbodubbo-commonsrctestjavaorgapachedubbocommonutilslogutiltestjava">Test Case Name: <code>testFindLevelWithThreadName</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-common\src\test\java\org\apache\dubbo\common\utils\LogUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-log">Mock Object Variable Name: <code>log</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 void testFindLevelWithThreadName() {
<span class="hljs-deletion">-    Log log = mock(Log.class);</span>
<span class="hljs-deletion">-    DubboAppender.logList.add(log);</span>
<span class="hljs-deletion">-    when(log.getLogLevel()).thenReturn(Level.ERROR);</span>
<span class="hljs-deletion">-    when(log.getLogThread()).thenReturn("thread-1");</span>
<span class="hljs-addition">+    Log log = createMockLog(Level.ERROR);</span>
<span class="hljs-addition">+    when(log.getLogThread()).thenReturn("thread-1");</span>
<span class="hljs-addition">+    DubboAppender.logList.add(log);</span>
<span class="hljs-deletion">-    log = mock(Log.class);</span>
<span class="hljs-deletion">-    DubboAppender.logList.add(log);</span>
<span class="hljs-deletion">-    when(log.getLogLevel()).thenReturn(Level.ERROR);</span>
<span class="hljs-deletion">-    when(log.getLogThread()).thenReturn("thread-2");</span>
<span class="hljs-addition">+    log = createMockLog(Level.ERROR);</span>
<span class="hljs-addition">+    when(log.getLogThread()).thenReturn("thread-2");</span>
<span class="hljs-addition">+    DubboAppender.logList.add(log);</span>
     assertThat(LogUtil.findLevelWithThreadName(Level.ERROR, "thread-2"), equalTo(1));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testFindLevelWithThreadName</span><span class="hljs-params">()</span> </span>{

    Log log = mock(Log<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DubboAppender.logList.add(log);

    when(log.getLogLevel()).thenReturn(Level.ERROR);

    when(log.getLogThread()).thenReturn(<span class="hljs-string">"thread-1"</span>);

    log = mock(Log<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DubboAppender.logList.add(log);

    when(log.getLogLevel()).thenReturn(Level.ERROR);

    when(log.getLogThread()).thenReturn(<span class="hljs-string">"thread-2"</span>);

    assertThat(LogUtil.findLevelWithThreadName(Level.ERROR, <span class="hljs-string">"thread-2"</span>), equalTo(<span class="hljs-number">1</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Log <span class="hljs-title">createMockLog</span><span class="hljs-params">(Level logLevelReturn)</span> </span>{
    Log log = mock(Log<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(log.getLogLevel()).thenReturn(logLevelReturn);
    <span class="hljs-keyword">return</span> log;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest64">Test Case ID #dubbo_Test_6_4</h4>
<h4 id="test-case-name-testfindmessage2file-cjavaprojectsapachedubbodubbo-commonsrctestjavaorgapachedubbocommonutilslogutiltestjava">Test Case Name: <code>testFindMessage2</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-common\src\test\java\org\apache\dubbo\common\utils\LogUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-log">Mock Object Variable Name: <code>log</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testFindMessage2() {
<span class="hljs-deletion">-    Log log = mock(Log.class);</span>
<span class="hljs-deletion">-    DubboAppender.logList.add(log);</span>
<span class="hljs-deletion">-    when(log.getLogMessage()).thenReturn("message");</span>
<span class="hljs-deletion">-    when(log.getLogLevel()).thenReturn(Level.ERROR);</span>
<span class="hljs-deletion">-    log = mock(Log.class);</span>
<span class="hljs-deletion">-    DubboAppender.logList.add(log);</span>
<span class="hljs-deletion">-    when(log.getLogMessage()).thenReturn("message");</span>
<span class="hljs-deletion">-    when(log.getLogLevel()).thenReturn(Level.INFO);</span>
<span class="hljs-addition">+    Log log = createMockLog(Level.ERROR);</span>
<span class="hljs-addition">+    when(log.getLogMessage()).thenReturn("message");</span>
<span class="hljs-addition">+    DubboAppender.logList.add(log);</span>
<span class="hljs-addition">+    log = createMockLog(Level.INFO);</span>
<span class="hljs-addition">+    when(log.getLogMessage()).thenReturn("message");</span>
<span class="hljs-addition">+    DubboAppender.logList.add(log);</span>
    assertThat(LogUtil.findMessage(Level.ERROR, "message"), equalTo(1));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testFindMessage2</span><span class="hljs-params">()</span> </span>{

    Log log = mock(Log<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DubboAppender.logList.add(log);

    when(log.getLogMessage()).thenReturn(<span class="hljs-string">"message"</span>);

    when(log.getLogLevel()).thenReturn(Level.ERROR);

    log = mock(Log<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DubboAppender.logList.add(log);

    when(log.getLogMessage()).thenReturn(<span class="hljs-string">"message"</span>);

    when(log.getLogLevel()).thenReturn(Level.INFO);

    assertThat(LogUtil.findMessage(Level.ERROR, <span class="hljs-string">"message"</span>), equalTo(<span class="hljs-number">1</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Log <span class="hljs-title">createMockLog</span><span class="hljs-params">(Level logLevelReturn)</span> </span>{
    Log log = mock(Log<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(log.getLogLevel()).thenReturn(logLevelReturn);
    <span class="hljs-keyword">return</span> log;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci7">Mock Clone Instance #dubbo_MCI_7</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.monitor.MonitorService</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MonitorService monitorService;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    monitorService = mock(MonitorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
monitorService

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest71">Test Case ID #dubbo_Test_7_1</h4>
<h4 id="test-case-name-testavailablefile-cjavaprojectsapachedubbodubbo-monitordubbo-monitor-defaultsrctestjavaorgapachedubbomonitordubbodubbomonitortestjava">Test Case Name: <code>testAvailable</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-monitor\dubbo-monitor-default\src\test\java\org\apache\dubbo\monitor\dubbo\DubboMonitorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-monitorservice">Mock Object Variable Name: <code>monitorService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void testAvailable() {
     Invoker invoker = mock(Invoker.class);
<span class="hljs-deletion">-    MonitorService monitorService = mock(MonitorService.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `monitorService`</span>
     given(invoker.isAvailable()).willReturn(true);
     given(invoker.getUrl()).willReturn(URL.valueOf("dubbo://127.0.0.1:7070?interval=20"));
<span class="hljs-deletion">-    DubboMonitor dubboMonitor = new DubboMonitor(invoker, monitorService);</span>
<span class="hljs-addition">+    DubboMonitor dubboMonitor = new DubboMonitor(invoker, monitorService);</span>
     assertThat(dubboMonitor.isAvailable(), is(true));
     verify(invoker).isAvailable();
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAvailable</span><span class="hljs-params">()</span> </span>{

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MonitorService monitorService = mock(MonitorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"dubbo://127.0.0.1:7070?interval=20"</span>));

    DubboMonitor dubboMonitor = <span class="hljs-keyword">new</span> DubboMonitor(invoker, monitorService);

    assertThat(dubboMonitor.isAvailable(), is(<span class="hljs-keyword">true</span>));

    verify(invoker).isAvailable();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MonitorService monitorService;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    monitorService = mock(MonitorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
monitorService

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest72">Test Case ID #dubbo_Test_7_2</h4>
<h4 id="test-case-name-testsumfile-cjavaprojectsapachedubbodubbo-monitordubbo-monitor-defaultsrctestjavaorgapachedubbomonitordubbodubbomonitortestjava">Test Case Name: <code>testSum</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-monitor\dubbo-monitor-default\src\test\java\org\apache\dubbo\monitor\dubbo\DubboMonitorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-monitorservice">Mock Object Variable Name: <code>monitorService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void testSum() {
     URL statistics = new URLBuilder(DUBBO_PROTOCOL, "10.20.153.11", 0).addParameter(APPLICATION_KEY, "morgan").addParameter(INTERFACE_KEY, "MemberService").addParameter(METHOD_KEY, "findPerson").addParameter(CONSUMER, "10.20.153.11").addParameter(SUCCESS_KEY, 1).addParameter(FAILURE_KEY, 0).addParameter(ELAPSED_KEY, 3).addParameter(MAX_ELAPSED_KEY, 3).addParameter(CONCURRENT_KEY, 1).addParameter(MAX_CONCURRENT_KEY, 1).build();
     Invoker invoker = mock(Invoker.class);
<span class="hljs-deletion">-    MonitorService monitorService = mock(MonitorService.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `monitorService`</span>
     given(invoker.getUrl()).willReturn(URL.valueOf("dubbo://127.0.0.1:7070?interval=20"));
     DubboMonitor dubboMonitor = new DubboMonitor(invoker, monitorService);
     dubboMonitor.collect(statistics.toSerializableURL());
     dubboMonitor.collect(statistics.addParameter(SUCCESS_KEY, 3).addParameter(CONCURRENT_KEY, 2).addParameter(INPUT_KEY, 1).addParameter(OUTPUT_KEY, 2).toSerializableURL());
     dubboMonitor.collect(statistics.addParameter(SUCCESS_KEY, 6).addParameter(ELAPSED_KEY, 2).toSerializableURL());
     dubboMonitor.send();
     ArgumentCaptor&lt;URL&gt; summaryCaptor = ArgumentCaptor.forClass(URL.class);
<span class="hljs-deletion">-    verify(monitorService, atLeastOnce()).collect(summaryCaptor.capture());</span>
<span class="hljs-addition">+    verify(monitorService, atLeastOnce()).collect(summaryCaptor.capture());</span>
     List&lt;URL&gt; allValues = summaryCaptor.getAllValues();
     assertThat(allValues, not(nullValue()));
     assertThat(allValues, hasItem(new CustomMatcher&lt;URL&gt;("Monitor count should greater than 1") {

         @Override
         public boolean matches(Object item) {
             URL url = (URL) item;
             return Integer.valueOf(url.getParameter(SUCCESS_KEY)) &gt; 1;
         }
     }));
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testSum</span><span class="hljs-params">()</span> </span>{

    URL statistics = <span class="hljs-keyword">new</span> URLBuilder(DUBBO_PROTOCOL, <span class="hljs-string">"10.20.153.11"</span>, <span class="hljs-number">0</span>).addParameter(APPLICATION_KEY, <span class="hljs-string">"morgan"</span>).addParameter(INTERFACE_KEY, <span class="hljs-string">"MemberService"</span>).addParameter(METHOD_KEY, <span class="hljs-string">"findPerson"</span>).addParameter(CONSUMER, <span class="hljs-string">"10.20.153.11"</span>).addParameter(SUCCESS_KEY, <span class="hljs-number">1</span>).addParameter(FAILURE_KEY, <span class="hljs-number">0</span>).addParameter(ELAPSED_KEY, <span class="hljs-number">3</span>).addParameter(MAX_ELAPSED_KEY, <span class="hljs-number">3</span>).addParameter(CONCURRENT_KEY, <span class="hljs-number">1</span>).addParameter(MAX_CONCURRENT_KEY, <span class="hljs-number">1</span>).build();

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MonitorService monitorService = mock(MonitorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"dubbo://127.0.0.1:7070?interval=20"</span>));

    DubboMonitor dubboMonitor = <span class="hljs-keyword">new</span> DubboMonitor(invoker, monitorService);

    dubboMonitor.collect(statistics.toSerializableURL());

    dubboMonitor.collect(statistics.addParameter(SUCCESS_KEY, <span class="hljs-number">3</span>).addParameter(CONCURRENT_KEY, <span class="hljs-number">2</span>).addParameter(INPUT_KEY, <span class="hljs-number">1</span>).addParameter(OUTPUT_KEY, <span class="hljs-number">2</span>).toSerializableURL());

    dubboMonitor.collect(statistics.addParameter(SUCCESS_KEY, <span class="hljs-number">6</span>).addParameter(ELAPSED_KEY, <span class="hljs-number">2</span>).toSerializableURL());

    dubboMonitor.send();

    ArgumentCaptor&lt;URL&gt; summaryCaptor = ArgumentCaptor.forClass(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(monitorService, atLeastOnce()).collect(summaryCaptor.capture());

    List&lt;URL&gt; allValues = summaryCaptor.getAllValues();

    assertThat(allValues, not(nullValue()));

    assertThat(allValues, hasItem(<span class="hljs-keyword">new</span> CustomMatcher&lt;URL&gt;(<span class="hljs-string">"Monitor count should greater than 1"</span>) {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">matches</span><span class="hljs-params">(Object item)</span> </span>{

            URL url = (URL) item;

            <span class="hljs-keyword">return</span> Integer.valueOf(url.getParameter(SUCCESS_KEY)) &gt; <span class="hljs-number">1</span>;

        }

    }));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MonitorService monitorService;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    monitorService = mock(MonitorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
monitorService

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest73">Test Case ID #dubbo_Test_7_3</h4>
<h4 id="test-case-name-testlookupfile-cjavaprojectsapachedubbodubbo-monitordubbo-monitor-defaultsrctestjavaorgapachedubbomonitordubbodubbomonitortestjava">Test Case Name: <code>testLookUp</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-monitor\dubbo-monitor-default\src\test\java\org\apache\dubbo\monitor\dubbo\DubboMonitorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-monitorservice">Mock Object Variable Name: <code>monitorService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void testLookUp() {
     Invoker invoker = mock(Invoker.class);
<span class="hljs-deletion">-    MonitorService monitorService = mock(MonitorService.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `monitorService`</span>
     URL queryUrl = URL.valueOf("dubbo://127.0.0.1:7070?interval=20");
     given(invoker.getUrl()).willReturn(queryUrl);
     DubboMonitor dubboMonitor = new DubboMonitor(invoker, monitorService);
     dubboMonitor.lookup(queryUrl);
     verify(monitorService).lookup(queryUrl);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testLookUp</span><span class="hljs-params">()</span> </span>{

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MonitorService monitorService = mock(MonitorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL queryUrl = URL.valueOf(<span class="hljs-string">"dubbo://127.0.0.1:7070?interval=20"</span>);

    given(invoker.getUrl()).willReturn(queryUrl);

    DubboMonitor dubboMonitor = <span class="hljs-keyword">new</span> DubboMonitor(invoker, monitorService);

    dubboMonitor.lookup(queryUrl);

    verify(monitorService).lookup(queryUrl);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MonitorService monitorService;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    monitorService = mock(MonitorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
monitorService

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci8">Mock Clone Instance #dubbo_MCI_8</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>java.net.InetAddress</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> InetAddress <span class="hljs-title">createMockInetAddress</span><span class="hljs-params">(String hostAddressReturn)</span> </span>{
    InetAddress addr = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(addr.isLoopbackAddress()).thenReturn(<span class="hljs-keyword">false</span>);
    when(addr.getHostAddress()).thenReturn(hostAddressReturn);
    <span class="hljs-keyword">return</span> addr;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest81">Test Case ID #dubbo_Test_8_1</h4>
<h4 id="test-case-name-shouldshowipnotpermittedmsggivenacceptforeignipfalseandnotmatchwhitelistfile-cjavaprojectsapachedubbodubbo-plugindubbo-qossrctestjavaorgapachedubboqosserverhandlerforeignhostpermithandlertestjava">Test Case Name: <code>shouldShowIpNotPermittedMsg_GivenAcceptForeignIpFalseAndNotMatchWhiteList</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-qos\src\test\java\org\apache\dubbo\qos\server\handler\ForeignHostPermitHandlerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-addr">Mock Object Variable Name: <code>addr</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(context.channel()).thenReturn(channel);
<span class="hljs-deletion">-    InetAddress addr = mock(InetAddress.class);</span>
<span class="hljs-deletion">-    when(addr.isLoopbackAddress()).thenReturn(false);</span>
<span class="hljs-deletion">-    when(addr.getHostAddress()).thenReturn("179.23.44.1");</span>
<span class="hljs-addition">+    InetAddress addr = createMockInetAddress("179.23.44.1");</span>
    InetSocketAddress address = new InetSocketAddress(addr, 12345);
    when(channel.remoteAddress()).thenReturn(address);
    ChannelFuture future = mock(ChannelFuture.class);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">shouldShowIpNotPermittedMsg_GivenAcceptForeignIpFalseAndNotMatchWhiteList</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    ChannelHandlerContext context = mock(ChannelHandlerContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(context.channel()).thenReturn(channel);

    InetAddress addr = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(addr.isLoopbackAddress()).thenReturn(<span class="hljs-keyword">false</span>);

    when(addr.getHostAddress()).thenReturn(<span class="hljs-string">"179.23.44.1"</span>);

    InetSocketAddress address = <span class="hljs-keyword">new</span> InetSocketAddress(addr, <span class="hljs-number">12345</span>);

    when(channel.remoteAddress()).thenReturn(address);

    ChannelFuture future = mock(ChannelFuture<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(context.writeAndFlush(any(ByteBuf<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">future</span>)</span>;

    ForeignHostPermitHandler handler = <span class="hljs-keyword">new</span> ForeignHostPermitHandler(QosConfiguration.builder().acceptForeignIp(<span class="hljs-keyword">false</span>).acceptForeignIpWhitelist(<span class="hljs-string">"175.23.44.1 ,  192.168.1.192/26"</span>).anonymousAccessPermissionLevel(PermissionLevel.NONE.name()).build());

    handler.handlerAdded(context);

    ArgumentCaptor&lt;ByteBuf&gt; captor = ArgumentCaptor.forClass(ByteBuf<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(context).writeAndFlush(captor.capture());

    assertThat(<span class="hljs-keyword">new</span> String(captor.getValue().array()), containsString(<span class="hljs-string">"Foreign Ip Not Permitted, Consider Config It In Whitelist"</span>));

    verify(future).addListener(ChannelFutureListener.CLOSE);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> InetAddress <span class="hljs-title">createMockInetAddress</span><span class="hljs-params">(String hostAddressReturn)</span> </span>{
    InetAddress addr = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(addr.isLoopbackAddress()).thenReturn(<span class="hljs-keyword">false</span>);
    when(addr.getHostAddress()).thenReturn(hostAddressReturn);
    <span class="hljs-keyword">return</span> addr;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest82">Test Case ID #dubbo_Test_8_2</h4>
<h4 id="test-case-name-shouldnotshowipnotpermittedmsggivenacceptforeignipfalseandmatchwhitelistfile-cjavaprojectsapachedubbodubbo-plugindubbo-qossrctestjavaorgapachedubboqosserverhandlerforeignhostpermithandlertestjava">Test Case Name: <code>shouldNotShowIpNotPermittedMsg_GivenAcceptForeignIpFalseAndMatchWhiteList</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-qos\src\test\java\org\apache\dubbo\qos\server\handler\ForeignHostPermitHandlerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-addr">Mock Object Variable Name: <code>addr</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(context.channel()).thenReturn(channel);
<span class="hljs-deletion">-    InetAddress addr = mock(InetAddress.class);</span>
<span class="hljs-deletion">-    when(addr.isLoopbackAddress()).thenReturn(false);</span>
<span class="hljs-deletion">-    when(addr.getHostAddress()).thenReturn("175.23.44.1");</span>
<span class="hljs-addition">+    InetAddress addr = createMockInetAddress("175.23.44.1");</span>
    InetSocketAddress address = new InetSocketAddress(addr, 12345);
    when(channel.remoteAddress()).thenReturn(address);
    ForeignHostPermitHandler handler = new ForeignHostPermitHandler(QosConfiguration.builder().acceptForeignIp(false).acceptForeignIpWhitelist("175.23.44.1, 192.168.1.192/26  ").build());
    handler.handlerAdded(context);
    verify(context, never()).writeAndFlush(any());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">shouldNotShowIpNotPermittedMsg_GivenAcceptForeignIpFalseAndMatchWhiteList</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    ChannelHandlerContext context = mock(ChannelHandlerContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(context.channel()).thenReturn(channel);

    InetAddress addr = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(addr.isLoopbackAddress()).thenReturn(<span class="hljs-keyword">false</span>);

    when(addr.getHostAddress()).thenReturn(<span class="hljs-string">"175.23.44.1"</span>);

    InetSocketAddress address = <span class="hljs-keyword">new</span> InetSocketAddress(addr, <span class="hljs-number">12345</span>);

    when(channel.remoteAddress()).thenReturn(address);

    ForeignHostPermitHandler handler = <span class="hljs-keyword">new</span> ForeignHostPermitHandler(QosConfiguration.builder().acceptForeignIp(<span class="hljs-keyword">false</span>).acceptForeignIpWhitelist(<span class="hljs-string">"175.23.44.1, 192.168.1.192/26  "</span>).build());

    handler.handlerAdded(context);

    verify(context, never()).writeAndFlush(any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> InetAddress <span class="hljs-title">createMockInetAddress</span><span class="hljs-params">(String hostAddressReturn)</span> </span>{
    InetAddress addr = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(addr.isLoopbackAddress()).thenReturn(<span class="hljs-keyword">false</span>);
    when(addr.getHostAddress()).thenReturn(hostAddressReturn);
    <span class="hljs-keyword">return</span> addr;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest83">Test Case ID #dubbo_Test_8_3</h4>
<h4 id="test-case-name-shouldnotshowipnotpermittedmsggivenacceptforeignipfalseandmatchwhitelistrangefile-cjavaprojectsapachedubbodubbo-plugindubbo-qossrctestjavaorgapachedubboqosserverhandlerforeignhostpermithandlertestjava">Test Case Name: <code>shouldNotShowIpNotPermittedMsg_GivenAcceptForeignIpFalseAndMatchWhiteListRange</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-qos\src\test\java\org\apache\dubbo\qos\server\handler\ForeignHostPermitHandlerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-addr">Mock Object Variable Name: <code>addr</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(context.channel()).thenReturn(channel);
<span class="hljs-deletion">-    InetAddress addr = mock(InetAddress.class);</span>
<span class="hljs-deletion">-    when(addr.isLoopbackAddress()).thenReturn(false);</span>
<span class="hljs-deletion">-    when(addr.getHostAddress()).thenReturn("192.168.1.199");</span>
<span class="hljs-addition">+    InetAddress addr = createMockInetAddress("192.168.1.199");</span>
    InetSocketAddress address = new InetSocketAddress(addr, 12345);
    when(channel.remoteAddress()).thenReturn(address);
    ForeignHostPermitHandler handler = new ForeignHostPermitHandler(QosConfiguration.builder().acceptForeignIp(false).acceptForeignIpWhitelist("175.23.44.1, 192.168.1.192/26").build());
    handler.handlerAdded(context);
    verify(context, never()).writeAndFlush(any());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">shouldNotShowIpNotPermittedMsg_GivenAcceptForeignIpFalseAndMatchWhiteListRange</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    ChannelHandlerContext context = mock(ChannelHandlerContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(context.channel()).thenReturn(channel);

    InetAddress addr = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(addr.isLoopbackAddress()).thenReturn(<span class="hljs-keyword">false</span>);

    when(addr.getHostAddress()).thenReturn(<span class="hljs-string">"192.168.1.199"</span>);

    InetSocketAddress address = <span class="hljs-keyword">new</span> InetSocketAddress(addr, <span class="hljs-number">12345</span>);

    when(channel.remoteAddress()).thenReturn(address);

    ForeignHostPermitHandler handler = <span class="hljs-keyword">new</span> ForeignHostPermitHandler(QosConfiguration.builder().acceptForeignIp(<span class="hljs-keyword">false</span>).acceptForeignIpWhitelist(<span class="hljs-string">"175.23.44.1, 192.168.1.192/26"</span>).build());

    handler.handlerAdded(context);

    verify(context, never()).writeAndFlush(any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> InetAddress <span class="hljs-title">createMockInetAddress</span><span class="hljs-params">(String hostAddressReturn)</span> </span>{
    InetAddress addr = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(addr.isLoopbackAddress()).thenReturn(<span class="hljs-keyword">false</span>);
    when(addr.getHostAddress()).thenReturn(hostAddressReturn);
    <span class="hljs-keyword">return</span> addr;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci9">Mock Clone Instance #dubbo_MCI_9</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>java.net.InetAddress</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> InetAddress <span class="hljs-title">createMockInetAddress</span><span class="hljs-params">(String hostAddressReturn)</span> </span>{
    InetAddress address = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(address.getHostAddress()).thenReturn(hostAddressReturn);
    <span class="hljs-keyword">return</span> address;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest91">Test Case ID #dubbo_Test_9_1</h4>
<h4 id="test-case-name-testisvalidaddressfile-cjavaprojectsapachedubbodubbo-commonsrctestjavaorgapachedubbocommonutilsnetutilstestjava">Test Case Name: <code>testIsValidAddress</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-common\src\test\java\org\apache\dubbo\common\utils\NetUtilsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-address">Mock Object Variable Name: <code>address</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 void testIsValidAddress() {
     assertFalse(NetUtils.isValidV4Address((InetAddress) null));
<span class="hljs-deletion">-    InetAddress address = mock(InetAddress.class);</span>
<span class="hljs-deletion">-    when(address.isLoopbackAddress()).thenReturn(true);</span>
<span class="hljs-addition">+    InetAddress address = mock(InetAddress.class);</span>
<span class="hljs-addition">+    when(address.isLoopbackAddress()).thenReturn(true);</span>
     assertFalse(NetUtils.isValidV4Address(address));
<span class="hljs-deletion">-    address = mock(InetAddress.class);</span>
<span class="hljs-deletion">-    when(address.getHostAddress()).thenReturn("localhost");</span>
<span class="hljs-addition">+    address = createMockInetAddress("localhost");</span>
     assertFalse(NetUtils.isValidV4Address(address));
<span class="hljs-deletion">-    address = mock(InetAddress.class);</span>
<span class="hljs-deletion">-    when(address.getHostAddress()).thenReturn("0.0.0.0");</span>
<span class="hljs-addition">+    address = createMockInetAddress("0.0.0.0");</span>
     assertFalse(NetUtils.isValidV4Address(address));
<span class="hljs-deletion">-    address = mock(InetAddress.class);</span>
<span class="hljs-deletion">-    when(address.getHostAddress()).thenReturn("127.0.0.1");</span>
<span class="hljs-addition">+    address = createMockInetAddress("127.0.0.1");</span>
     assertFalse(NetUtils.isValidV4Address(address));
<span class="hljs-deletion">-    address = mock(InetAddress.class);</span>
<span class="hljs-deletion">-    when(address.getHostAddress()).thenReturn("1.2.3.4");</span>
<span class="hljs-addition">+    address = createMockInetAddress("1.2.3.4");</span>
     assertTrue(NetUtils.isValidV4Address(address));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testIsValidAddress</span><span class="hljs-params">()</span> </span>{

    assertFalse(NetUtils.isValidV4Address((InetAddress) <span class="hljs-keyword">null</span>));

    InetAddress address = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(address.isLoopbackAddress()).thenReturn(<span class="hljs-keyword">true</span>);

    assertFalse(NetUtils.isValidV4Address(address));

    address = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(address.getHostAddress()).thenReturn(<span class="hljs-string">"localhost"</span>);

    assertFalse(NetUtils.isValidV4Address(address));

    address = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(address.getHostAddress()).thenReturn(<span class="hljs-string">"0.0.0.0"</span>);

    assertFalse(NetUtils.isValidV4Address(address));

    address = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(address.getHostAddress()).thenReturn(<span class="hljs-string">"127.0.0.1"</span>);

    assertFalse(NetUtils.isValidV4Address(address));

    address = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(address.getHostAddress()).thenReturn(<span class="hljs-string">"1.2.3.4"</span>);

    assertTrue(NetUtils.isValidV4Address(address));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> InetAddress <span class="hljs-title">createMockInetAddress</span><span class="hljs-params">(String hostAddressReturn)</span> </span>{
    InetAddress address = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(address.getHostAddress()).thenReturn(hostAddressReturn);
    <span class="hljs-keyword">return</span> address;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest92">Test Case ID #dubbo_Test_9_2</h4>
<h4 id="test-case-name-testtoaddressstringfile-cjavaprojectsapachedubbodubbo-commonsrctestjavaorgapachedubbocommonutilsnetutilstestjava">Test Case Name: <code>testToAddressString</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-common\src\test\java\org\apache\dubbo\common\utils\NetUtilsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-address">Mock Object Variable Name: <code>address</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void testToAddressString() {
<span class="hljs-deletion">-    InetAddress address = mock(InetAddress.class);</span>
<span class="hljs-deletion">-    when(address.getHostAddress()).thenReturn("dubbo");</span>
<span class="hljs-addition">+    InetAddress address = createMockInetAddress("dubbo");</span>
     InetSocketAddress socketAddress = new InetSocketAddress(address, 1234);
     assertThat(NetUtils.toAddressString(socketAddress), equalTo("dubbo:1234"));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testToAddressString</span><span class="hljs-params">()</span> </span>{

    InetAddress address = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(address.getHostAddress()).thenReturn(<span class="hljs-string">"dubbo"</span>);

    InetSocketAddress socketAddress = <span class="hljs-keyword">new</span> InetSocketAddress(address, <span class="hljs-number">1234</span>);

    assertThat(NetUtils.toAddressString(socketAddress), equalTo(<span class="hljs-string">"dubbo:1234"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> InetAddress <span class="hljs-title">createMockInetAddress</span><span class="hljs-params">(String hostAddressReturn)</span> </span>{
    InetAddress address = mock(InetAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(address.getHostAddress()).thenReturn(hostAddressReturn);
    <span class="hljs-keyword">return</span> address;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci10">Mock Clone Instance #dubbo_MCI_10</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.protocol.tri.observer.ServerCallToObserverAdapter&lt;java.lang.String&gt;</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 5</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockServerCallToObserverAdapter</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ServerCallToObserverAdapter&lt;String&gt; <span class="hljs-title">createMockServerCallToObserverAdapter</span><span class="hljs-params">(
            java.util.concurrent.atomic.AtomicInteger nextCounter,
            java.util.concurrent.atomic.AtomicInteger completeCounter,
            java.util.concurrent.atomic.AtomicInteger errorCounter)</span> </span>{
        ServerCallToObserverAdapter&lt;String&gt; responseObserver = Mockito.mock(ServerCallToObserverAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        doAnswer(o -&gt; nextCounter.incrementAndGet()).when(responseObserver).onNext(anyString());
        doAnswer(o -&gt; completeCounter.incrementAndGet()).when(responseObserver).onCompleted();
        doAnswer(o -&gt; errorCounter.incrementAndGet()).when(responseObserver).onError(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        <span class="hljs-keyword">return</span> responseObserver;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest101">Test Case ID #dubbo_Test_10_1</h4>
<h4 id="test-case-name-testinvokefile-cjavaprojectsapachedubbodubbo-plugindubbo-reactivesrctestjavaorgapachedubboreactivemanytomanymethodhandlertestjava">Test Case Name: <code>testInvoke</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-reactive\src\test\java\org\apache\dubbo\reactive\ManyToManyMethodHandlerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-responseobserver">Mock Object Variable Name: <code>responseObserver</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    AtomicInteger nextCounter = new AtomicInteger();
    AtomicInteger completeCounter = new AtomicInteger();
    AtomicInteger errorCounter = new AtomicInteger();
<span class="hljs-deletion">-    ServerCallToObserverAdapter&lt;String&gt; responseObserver = Mockito.mock(ServerCallToObserverAdapter.class);</span>
<span class="hljs-deletion">-    doAnswer(o -&gt; nextCounter.incrementAndGet()).when(responseObserver).onNext(anyString());</span>
<span class="hljs-deletion">-    doAnswer(o -&gt; completeCounter.incrementAndGet()).when(responseObserver).onCompleted();</span>
<span class="hljs-deletion">-    doAnswer(o -&gt; errorCounter.incrementAndGet()).when(responseObserver).onError(any(Throwable.class));</span>
<span class="hljs-addition">+    ServerCallToObserverAdapter&lt;String&gt; responseObserver = MockServerCallToObserverAdapter.createMockServerCallToObserverAdapter(nextCounter, completeCounter, errorCounter);</span>
    ManyToManyMethodHandler&lt;String, String&gt; handler = new ManyToManyMethodHandler&lt;&gt;(requestFlux -&gt; requestFlux.map(r -&gt; r + "0"));
    CompletableFuture&lt;StreamObserver&lt;String&gt;&gt; future = handler.invoke(new Object[] { responseObserver });
    StreamObserver&lt;String&gt; requestObserver = future.get();
    for (int i = 0; i &lt; 10; i++) {
        requestObserver.onNext(String.valueOf(i));
    }
    requestObserver.onCompleted();
    Assertions.assertEquals(10, nextCounter.get());
    Assertions.assertEquals(0, errorCounter.get());
    Assertions.assertEquals(1, completeCounter.get());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvoke</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException </span>{

    AtomicInteger nextCounter = <span class="hljs-keyword">new</span> AtomicInteger();

    AtomicInteger completeCounter = <span class="hljs-keyword">new</span> AtomicInteger();

    AtomicInteger errorCounter = <span class="hljs-keyword">new</span> AtomicInteger();

    ServerCallToObserverAdapter&lt;String&gt; responseObserver = Mockito.mock(ServerCallToObserverAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    doAnswer(o -&gt; nextCounter.incrementAndGet()).when(responseObserver).onNext(anyString());

    doAnswer(o -&gt; completeCounter.incrementAndGet()).when(responseObserver).onCompleted();

    doAnswer(o -&gt; errorCounter.incrementAndGet()).when(responseObserver).onError(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ManyToManyMethodHandler&lt;String, String&gt; handler = <span class="hljs-keyword">new</span> ManyToManyMethodHandler&lt;&gt;(requestFlux -&gt; requestFlux.map(r -&gt; r + <span class="hljs-string">"0"</span>));

    CompletableFuture&lt;StreamObserver&lt;String&gt;&gt; future = handler.invoke(<span class="hljs-keyword">new</span> Object[] { responseObserver });

    StreamObserver&lt;String&gt; requestObserver = future.get();

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {

        requestObserver.onNext(String.valueOf(i));

    }

    requestObserver.onCompleted();

    Assertions.assertEquals(<span class="hljs-number">10</span>, nextCounter.get());

    Assertions.assertEquals(<span class="hljs-number">0</span>, errorCounter.get());

    Assertions.assertEquals(<span class="hljs-number">1</span>, completeCounter.get());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockServerCallToObserverAdapter</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ServerCallToObserverAdapter&lt;String&gt; <span class="hljs-title">createMockServerCallToObserverAdapter</span><span class="hljs-params">(
            java.util.concurrent.atomic.AtomicInteger nextCounter,
            java.util.concurrent.atomic.AtomicInteger completeCounter,
            java.util.concurrent.atomic.AtomicInteger errorCounter)</span> </span>{
        ServerCallToObserverAdapter&lt;String&gt; responseObserver = Mockito.mock(ServerCallToObserverAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        doAnswer(o -&gt; nextCounter.incrementAndGet()).when(responseObserver).onNext(anyString());
        doAnswer(o -&gt; completeCounter.incrementAndGet()).when(responseObserver).onCompleted();
        doAnswer(o -&gt; errorCounter.incrementAndGet()).when(responseObserver).onError(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        <span class="hljs-keyword">return</span> responseObserver;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest102">Test Case ID #dubbo_Test_10_2</h4>
<h4 id="test-case-name-testinvokerfile-cjavaprojectsapachedubbodubbo-plugindubbo-reactivesrctestjavaorgapachedubboreactivemanytoonemethodhandlertestjava">Test Case Name: <code>testInvoker</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-reactive\src\test\java\org\apache\dubbo\reactive\ManyToOneMethodHandlerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-responseobserver">Mock Object Variable Name: <code>responseObserver</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    AtomicInteger nextCounter = new AtomicInteger();
    AtomicInteger completeCounter = new AtomicInteger();
    AtomicInteger errorCounter = new AtomicInteger();
<span class="hljs-deletion">-    ServerCallToObserverAdapter&lt;String&gt; responseObserver = Mockito.mock(ServerCallToObserverAdapter.class);</span>
<span class="hljs-deletion">-    doAnswer(o -&gt; nextCounter.incrementAndGet()).when(responseObserver).onNext(anyString());</span>
<span class="hljs-deletion">-    doAnswer(o -&gt; completeCounter.incrementAndGet()).when(responseObserver).onCompleted();</span>
<span class="hljs-deletion">-    doAnswer(o -&gt; errorCounter.incrementAndGet()).when(responseObserver).onError(any(Throwable.class));</span>
<span class="hljs-addition">+    ServerCallToObserverAdapter&lt;String&gt; responseObserver = MockServerCallToObserverAdapter.createMockServerCallToObserverAdapter(nextCounter, completeCounter, errorCounter);</span>
    ManyToOneMethodHandler&lt;String, String&gt; handler = new ManyToOneMethodHandler&lt;&gt;(requestFlux -&gt; requestFlux.map(Integer::valueOf).reduce(Integer::sum).map(String::valueOf));
    CompletableFuture&lt;StreamObserver&lt;String&gt;&gt; future = handler.invoke(new Object[] { responseObserver });
    StreamObserver&lt;String&gt; requestObserver = future.get();
    for (int i = 0; i &lt; 10; i++) {
        requestObserver.onNext(String.valueOf(i));
    }
    requestObserver.onCompleted();
    Assertions.assertEquals(1, nextCounter.get());
    Assertions.assertEquals(0, errorCounter.get());
    Assertions.assertEquals(1, completeCounter.get());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvoker</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException </span>{

    AtomicInteger nextCounter = <span class="hljs-keyword">new</span> AtomicInteger();

    AtomicInteger completeCounter = <span class="hljs-keyword">new</span> AtomicInteger();

    AtomicInteger errorCounter = <span class="hljs-keyword">new</span> AtomicInteger();

    ServerCallToObserverAdapter&lt;String&gt; responseObserver = Mockito.mock(ServerCallToObserverAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    doAnswer(o -&gt; nextCounter.incrementAndGet()).when(responseObserver).onNext(anyString());

    doAnswer(o -&gt; completeCounter.incrementAndGet()).when(responseObserver).onCompleted();

    doAnswer(o -&gt; errorCounter.incrementAndGet()).when(responseObserver).onError(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ManyToOneMethodHandler&lt;String, String&gt; handler = <span class="hljs-keyword">new</span> ManyToOneMethodHandler&lt;&gt;(requestFlux -&gt; requestFlux.map(Integer::valueOf).reduce(Integer::sum).map(String::valueOf));

    CompletableFuture&lt;StreamObserver&lt;String&gt;&gt; future = handler.invoke(<span class="hljs-keyword">new</span> Object[] { responseObserver });

    StreamObserver&lt;String&gt; requestObserver = future.get();

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {

        requestObserver.onNext(String.valueOf(i));

    }

    requestObserver.onCompleted();

    Assertions.assertEquals(<span class="hljs-number">1</span>, nextCounter.get());

    Assertions.assertEquals(<span class="hljs-number">0</span>, errorCounter.get());

    Assertions.assertEquals(<span class="hljs-number">1</span>, completeCounter.get());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockServerCallToObserverAdapter</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ServerCallToObserverAdapter&lt;String&gt; <span class="hljs-title">createMockServerCallToObserverAdapter</span><span class="hljs-params">(
            java.util.concurrent.atomic.AtomicInteger nextCounter,
            java.util.concurrent.atomic.AtomicInteger completeCounter,
            java.util.concurrent.atomic.AtomicInteger errorCounter)</span> </span>{
        ServerCallToObserverAdapter&lt;String&gt; responseObserver = Mockito.mock(ServerCallToObserverAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        doAnswer(o -&gt; nextCounter.incrementAndGet()).when(responseObserver).onNext(anyString());
        doAnswer(o -&gt; completeCounter.incrementAndGet()).when(responseObserver).onCompleted();
        doAnswer(o -&gt; errorCounter.incrementAndGet()).when(responseObserver).onError(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        <span class="hljs-keyword">return</span> responseObserver;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest103">Test Case ID #dubbo_Test_10_3</h4>
<h4 id="test-case-name-testerrorfile-cjavaprojectsapachedubbodubbo-plugindubbo-reactivesrctestjavaorgapachedubboreactivemanytoonemethodhandlertestjava">Test Case Name: <code>testError</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-reactive\src\test\java\org\apache\dubbo\reactive\ManyToOneMethodHandlerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-responseobserver">Mock Object Variable Name: <code>responseObserver</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    AtomicInteger nextCounter = new AtomicInteger();
    AtomicInteger completeCounter = new AtomicInteger();
    AtomicInteger errorCounter = new AtomicInteger();
<span class="hljs-deletion">-    ServerCallToObserverAdapter&lt;String&gt; responseObserver = Mockito.mock(ServerCallToObserverAdapter.class);</span>
<span class="hljs-deletion">-    doAnswer(o -&gt; nextCounter.incrementAndGet()).when(responseObserver).onNext(anyString());</span>
<span class="hljs-deletion">-    doAnswer(o -&gt; completeCounter.incrementAndGet()).when(responseObserver).onCompleted();</span>
<span class="hljs-deletion">-    doAnswer(o -&gt; errorCounter.incrementAndGet()).when(responseObserver).onError(any(Throwable.class));</span>
<span class="hljs-addition">+    ServerCallToObserverAdapter&lt;String&gt; responseObserver = MockServerCallToObserverAdapter.createMockServerCallToObserverAdapter(nextCounter, completeCounter, errorCounter);</span>
    ManyToOneMethodHandler&lt;String, String&gt; handler = new ManyToOneMethodHandler&lt;&gt;(requestFlux -&gt; requestFlux.map(Integer::valueOf).reduce(Integer::sum).map(String::valueOf));
    CompletableFuture&lt;StreamObserver&lt;String&gt;&gt; future = handler.invoke(new Object[] { responseObserver });
    StreamObserver&lt;String&gt; requestObserver = future.get();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testError</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException </span>{

    AtomicInteger nextCounter = <span class="hljs-keyword">new</span> AtomicInteger();

    AtomicInteger completeCounter = <span class="hljs-keyword">new</span> AtomicInteger();

    AtomicInteger errorCounter = <span class="hljs-keyword">new</span> AtomicInteger();

    ServerCallToObserverAdapter&lt;String&gt; responseObserver = Mockito.mock(ServerCallToObserverAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    doAnswer(o -&gt; nextCounter.incrementAndGet()).when(responseObserver).onNext(anyString());

    doAnswer(o -&gt; completeCounter.incrementAndGet()).when(responseObserver).onCompleted();

    doAnswer(o -&gt; errorCounter.incrementAndGet()).when(responseObserver).onError(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    ManyToOneMethodHandler&lt;String, String&gt; handler = <span class="hljs-keyword">new</span> ManyToOneMethodHandler&lt;&gt;(requestFlux -&gt; requestFlux.map(Integer::valueOf).reduce(Integer::sum).map(String::valueOf));

    CompletableFuture&lt;StreamObserver&lt;String&gt;&gt; future = handler.invoke(<span class="hljs-keyword">new</span> Object[] { responseObserver });

    StreamObserver&lt;String&gt; requestObserver = future.get();

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {

        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">6</span>) {

            requestObserver.onError(<span class="hljs-keyword">new</span> Throwable());

        }

        requestObserver.onNext(String.valueOf(i));

    }

    requestObserver.onCompleted();

    Assertions.assertEquals(<span class="hljs-number">0</span>, nextCounter.get());

    Assertions.assertEquals(<span class="hljs-number">1</span>, errorCounter.get());

    Assertions.assertEquals(<span class="hljs-number">0</span>, completeCounter.get());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockServerCallToObserverAdapter</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ServerCallToObserverAdapter&lt;String&gt; <span class="hljs-title">createMockServerCallToObserverAdapter</span><span class="hljs-params">(
            java.util.concurrent.atomic.AtomicInteger nextCounter,
            java.util.concurrent.atomic.AtomicInteger completeCounter,
            java.util.concurrent.atomic.AtomicInteger errorCounter)</span> </span>{
        ServerCallToObserverAdapter&lt;String&gt; responseObserver = Mockito.mock(ServerCallToObserverAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        doAnswer(o -&gt; nextCounter.incrementAndGet()).when(responseObserver).onNext(anyString());
        doAnswer(o -&gt; completeCounter.incrementAndGet()).when(responseObserver).onCompleted();
        doAnswer(o -&gt; errorCounter.incrementAndGet()).when(responseObserver).onError(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        <span class="hljs-keyword">return</span> responseObserver;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest104">Test Case ID #dubbo_Test_10_4</h4>
<h4 id="test-case-name-testinvokefile-cjavaprojectsapachedubbodubbo-plugindubbo-reactivesrctestjavaorgapachedubboreactiveonetomanymethodhandlertestjava">Test Case Name: <code>testInvoke</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-reactive\src\test\java\org\apache\dubbo\reactive\OneToManyMethodHandlerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-responseobserver">Mock Object Variable Name: <code>responseObserver</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    AtomicInteger nextCounter = new AtomicInteger();
    AtomicInteger completeCounter = new AtomicInteger();
    AtomicInteger errorCounter = new AtomicInteger();
<span class="hljs-deletion">-    ServerCallToObserverAdapter&lt;String&gt; responseObserver = Mockito.mock(ServerCallToObserverAdapter.class);</span>
<span class="hljs-deletion">-    doAnswer(o -&gt; nextCounter.incrementAndGet()).when(responseObserver).onNext(anyString());</span>
<span class="hljs-deletion">-    doAnswer(o -&gt; completeCounter.incrementAndGet()).when(responseObserver).onCompleted();</span>
<span class="hljs-deletion">-    doAnswer(o -&gt; errorCounter.incrementAndGet()).when(responseObserver).onError(any(Throwable.class));</span>
<span class="hljs-addition">+    ServerCallToObserverAdapter&lt;String&gt; responseObserver = MockServerCallToObserverAdapter.createMockServerCallToObserverAdapter(nextCounter, completeCounter, errorCounter);</span>
    OneToManyMethodHandler&lt;String, String&gt; handler = new OneToManyMethodHandler&lt;&gt;(requestMono -&gt; requestMono.flatMapMany(r -&gt; Flux.fromArray(r.split(","))));
    CompletableFuture&lt;?&gt; future = handler.invoke(new Object[] { request, responseObserver });
    Assertions.assertTrue(future.isDone());
    Assertions.assertEquals(7, nextCounter.get());
    Assertions.assertEquals(0, errorCounter.get());
    Assertions.assertEquals(1, completeCounter.get());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvoke</span><span class="hljs-params">()</span> </span>{

    String request = <span class="hljs-string">"1,2,3,4,5,6,7"</span>;

    AtomicInteger nextCounter = <span class="hljs-keyword">new</span> AtomicInteger();

    AtomicInteger completeCounter = <span class="hljs-keyword">new</span> AtomicInteger();

    AtomicInteger errorCounter = <span class="hljs-keyword">new</span> AtomicInteger();

    ServerCallToObserverAdapter&lt;String&gt; responseObserver = Mockito.mock(ServerCallToObserverAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    doAnswer(o -&gt; nextCounter.incrementAndGet()).when(responseObserver).onNext(anyString());

    doAnswer(o -&gt; completeCounter.incrementAndGet()).when(responseObserver).onCompleted();

    doAnswer(o -&gt; errorCounter.incrementAndGet()).when(responseObserver).onError(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    OneToManyMethodHandler&lt;String, String&gt; handler = <span class="hljs-keyword">new</span> OneToManyMethodHandler&lt;&gt;(requestMono -&gt; requestMono.flatMapMany(r -&gt; Flux.fromArray(r.split(<span class="hljs-string">","</span>))));

    CompletableFuture&lt;?&gt; future = handler.invoke(<span class="hljs-keyword">new</span> Object[] { request, responseObserver });

    Assertions.assertTrue(future.isDone());

    Assertions.assertEquals(<span class="hljs-number">7</span>, nextCounter.get());

    Assertions.assertEquals(<span class="hljs-number">0</span>, errorCounter.get());

    Assertions.assertEquals(<span class="hljs-number">1</span>, completeCounter.get());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockServerCallToObserverAdapter</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ServerCallToObserverAdapter&lt;String&gt; <span class="hljs-title">createMockServerCallToObserverAdapter</span><span class="hljs-params">(
            java.util.concurrent.atomic.AtomicInteger nextCounter,
            java.util.concurrent.atomic.AtomicInteger completeCounter,
            java.util.concurrent.atomic.AtomicInteger errorCounter)</span> </span>{
        ServerCallToObserverAdapter&lt;String&gt; responseObserver = Mockito.mock(ServerCallToObserverAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        doAnswer(o -&gt; nextCounter.incrementAndGet()).when(responseObserver).onNext(anyString());
        doAnswer(o -&gt; completeCounter.incrementAndGet()).when(responseObserver).onCompleted();
        doAnswer(o -&gt; errorCounter.incrementAndGet()).when(responseObserver).onError(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        <span class="hljs-keyword">return</span> responseObserver;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest105">Test Case ID #dubbo_Test_10_5</h4>
<h4 id="test-case-name-testerrorfile-cjavaprojectsapachedubbodubbo-plugindubbo-reactivesrctestjavaorgapachedubboreactiveonetomanymethodhandlertestjava">Test Case Name: <code>testError</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-reactive\src\test\java\org\apache\dubbo\reactive\OneToManyMethodHandlerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-responseobserver">Mock Object Variable Name: <code>responseObserver</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    AtomicInteger nextCounter = new AtomicInteger();
    AtomicInteger completeCounter = new AtomicInteger();
    AtomicInteger errorCounter = new AtomicInteger();
<span class="hljs-deletion">-    ServerCallToObserverAdapter&lt;String&gt; responseObserver = Mockito.mock(ServerCallToObserverAdapter.class);</span>
<span class="hljs-deletion">-    doAnswer(o -&gt; nextCounter.incrementAndGet()).when(responseObserver).onNext(anyString());</span>
<span class="hljs-deletion">-    doAnswer(o -&gt; completeCounter.incrementAndGet()).when(responseObserver).onCompleted();</span>
<span class="hljs-deletion">-    doAnswer(o -&gt; errorCounter.incrementAndGet()).when(responseObserver).onError(any(Throwable.class));</span>
<span class="hljs-addition">+    ServerCallToObserverAdapter&lt;String&gt; responseObserver = MockServerCallToObserverAdapter.createMockServerCallToObserverAdapter(nextCounter, completeCounter, errorCounter);</span>
    OneToManyMethodHandler&lt;String, String&gt; handler = new OneToManyMethodHandler&lt;&gt;(requestMono -&gt; Flux.create(emitter -&gt; {
        for (int i = 0; i &lt; 10; i++) {
            if (i == 6) {
                emitter.error(new Throwable());
            } else {
                emitter.next(String.valueOf(i));
            }
        }
    }));
    CompletableFuture&lt;?&gt; future = handler.invoke(new Object[] { request, responseObserver });
    Assertions.assertTrue(future.isDone());
    Assertions.assertEquals(6, nextCounter.get());
    Assertions.assertEquals(1, errorCounter.get());
    Assertions.assertEquals(0, completeCounter.get());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testError</span><span class="hljs-params">()</span> </span>{

    String request = <span class="hljs-string">"1,2,3,4,5,6,7"</span>;

    AtomicInteger nextCounter = <span class="hljs-keyword">new</span> AtomicInteger();

    AtomicInteger completeCounter = <span class="hljs-keyword">new</span> AtomicInteger();

    AtomicInteger errorCounter = <span class="hljs-keyword">new</span> AtomicInteger();

    ServerCallToObserverAdapter&lt;String&gt; responseObserver = Mockito.mock(ServerCallToObserverAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    doAnswer(o -&gt; nextCounter.incrementAndGet()).when(responseObserver).onNext(anyString());

    doAnswer(o -&gt; completeCounter.incrementAndGet()).when(responseObserver).onCompleted();

    doAnswer(o -&gt; errorCounter.incrementAndGet()).when(responseObserver).onError(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    OneToManyMethodHandler&lt;String, String&gt; handler = <span class="hljs-keyword">new</span> OneToManyMethodHandler&lt;&gt;(requestMono -&gt; Flux.create(emitter -&gt; {

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {

            <span class="hljs-keyword">if</span> (i == <span class="hljs-number">6</span>) {

                emitter.error(<span class="hljs-keyword">new</span> Throwable());

            } <span class="hljs-keyword">else</span> {

                emitter.next(String.valueOf(i));

            }

        }

    }));

    CompletableFuture&lt;?&gt; future = handler.invoke(<span class="hljs-keyword">new</span> Object[] { request, responseObserver });

    Assertions.assertTrue(future.isDone());

    Assertions.assertEquals(<span class="hljs-number">6</span>, nextCounter.get());

    Assertions.assertEquals(<span class="hljs-number">1</span>, errorCounter.get());

    Assertions.assertEquals(<span class="hljs-number">0</span>, completeCounter.get());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockServerCallToObserverAdapter</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ServerCallToObserverAdapter&lt;String&gt; <span class="hljs-title">createMockServerCallToObserverAdapter</span><span class="hljs-params">(
            java.util.concurrent.atomic.AtomicInteger nextCounter,
            java.util.concurrent.atomic.AtomicInteger completeCounter,
            java.util.concurrent.atomic.AtomicInteger errorCounter)</span> </span>{
        ServerCallToObserverAdapter&lt;String&gt; responseObserver = Mockito.mock(ServerCallToObserverAdapter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        doAnswer(o -&gt; nextCounter.incrementAndGet()).when(responseObserver).onNext(anyString());
        doAnswer(o -&gt; completeCounter.incrementAndGet()).when(responseObserver).onCompleted();
        doAnswer(o -&gt; errorCounter.incrementAndGet()).when(responseObserver).onError(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        <span class="hljs-keyword">return</span> responseObserver;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci11">Mock Clone Instance #dubbo_MCI_11</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.common.URL</code></li>
<li><strong>Test Case Count</strong>: 5</li>
<li><strong>MO Count</strong>: 5</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> URL <span class="hljs-title">createMockUrl</span><span class="hljs-params">(ConsumerModel consumerModel)</span> </span>{
    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(url.getServiceModel()).thenReturn(consumerModel);
    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;
    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;
    <span class="hljs-keyword">return</span> url;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest111">Test Case ID #dubbo_Test_11_1</h4>
<h4 id="test-case-name-unarycallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>unaryCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-url">Mock Object Variable Name: <code>url</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker.class);
<span class="hljs-deletion">-    URL url = Mockito.mock(URL.class);</span>
    ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);
    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
<span class="hljs-addition">+    URL url = createMockUrl(consumerModel);</span>
    when(invoker.getUrl()).thenReturn(url);
    when(invoker.getInterface()).thenReturn(IGreeter.class);
    Result result = Mockito.mock(Result.class);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unaryCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">result</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(result.recreate()).thenReturn(response);

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    Object ret = StubInvocationUtil.unaryCall(invoker, method, request);

    Assertions.assertEquals(response, ret);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> URL <span class="hljs-title">createMockUrl</span><span class="hljs-params">(ConsumerModel consumerModel)</span> </span>{
    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(url.getServiceModel()).thenReturn(consumerModel);
    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;
    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;
    <span class="hljs-keyword">return</span> url;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest112">Test Case ID #dubbo_Test_11_2</h4>
<h4 id="test-case-name-unarycall2file-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>unaryCall2</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-url">Mock Object Variable Name: <code>url</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker.class);
<span class="hljs-deletion">-    URL url = Mockito.mock(URL.class);</span>
<span class="hljs-deletion">-    ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);</span>
<span class="hljs-addition">+    ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);</span>
<span class="hljs-addition">+    URL url = createMockUrl(consumerModel);</span>
    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
<span class="hljs-deletion">-    when(url.getServiceModel()).thenReturn(consumerModel);</span>
<span class="hljs-deletion">-    when(url.getServiceInterface()).thenReturn(IGreeter.class.getName());</span>
<span class="hljs-deletion">-    when(url.getProtocolServiceKey()).thenReturn(IGreeter.class.getName());</span>
    when(invoker.getUrl()).thenReturn(url);
    when(invoker.getInterface()).thenReturn(IGreeter.class);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unaryCall2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenThrow</span>(<span class="hljs-title">new</span> <span class="hljs-title">RuntimeException</span>("<span class="hljs-title">a</span>")).<span class="hljs-title">thenThrow</span>(<span class="hljs-title">new</span> <span class="hljs-title">Error</span>("<span class="hljs-title">b</span>"))</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(result.recreate()).thenReturn(response);

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    <span class="hljs-keyword">try</span> {

        StubInvocationUtil.unaryCall(invoker, method, request);

        fail();

    } <span class="hljs-keyword">catch</span> (Throwable t) {

        <span class="hljs-comment">// pass</span>

    }

    <span class="hljs-keyword">try</span> {

        StubInvocationUtil.unaryCall(invoker, method, request);

        fail();

    } <span class="hljs-keyword">catch</span> (Throwable t) {

        <span class="hljs-comment">// pass</span>

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> URL <span class="hljs-title">createMockUrl</span><span class="hljs-params">(ConsumerModel consumerModel)</span> </span>{
    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(url.getServiceModel()).thenReturn(consumerModel);
    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;
    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;
    <span class="hljs-keyword">return</span> url;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest113">Test Case ID #dubbo_Test_11_3</h4>
<h4 id="test-case-name-testunarycallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>testUnaryCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-url">Mock Object Variable Name: <code>url</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker.class);
<span class="hljs-deletion">-    URL url = Mockito.mock(URL.class);</span>
<span class="hljs-addition">+    URL url = createMockUrl(consumerModel);</span>
    ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);
    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
<span class="hljs-deletion">-    when(url.getServiceModel()).thenReturn(consumerModel);</span>
<span class="hljs-deletion">-    when(url.getServiceInterface()).thenReturn(IGreeter.class.getName());</span>
<span class="hljs-deletion">-    when(url.getProtocolServiceKey()).thenReturn(IGreeter.class.getName());</span>
    when(invoker.getUrl()).thenReturn(url);
    when(invoker.getInterface()).thenReturn(IGreeter.class);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testUnaryCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">then</span>(<span class="hljs-title">invocationOnMock</span> -&gt; <span class="hljs-title">result</span>)</span>;

    when(result.recreate()).thenReturn(response);

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    AtomicReference&lt;Object&gt; atomicReference = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    StreamObserver&lt;Object&gt; responseObserver = <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

            atomicReference.set(data);

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

            latch.countDown();

        }

    };

    StubInvocationUtil.unaryCall(invoker, method, request, responseObserver);

    latch.await(<span class="hljs-number">1</span>, TimeUnit.SECONDS);

    Assertions.assertEquals(response, atomicReference.get());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> URL <span class="hljs-title">createMockUrl</span><span class="hljs-params">(ConsumerModel consumerModel)</span> </span>{
    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(url.getServiceModel()).thenReturn(consumerModel);
    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;
    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;
    <span class="hljs-keyword">return</span> url;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest114">Test Case ID #dubbo_Test_11_4</h4>
<h4 id="test-case-name-biorclientstreamcallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>biOrClientStreamCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-url">Mock Object Variable Name: <code>url</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker.class);
<span class="hljs-deletion">-    URL url = Mockito.mock(URL.class);</span>
<span class="hljs-addition">+    URL url = createMockUrl(consumerModel);</span>
    ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);
    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
<span class="hljs-deletion">-    when(url.getServiceModel()).thenReturn(consumerModel);</span>
<span class="hljs-deletion">-    when(url.getServiceInterface()).thenReturn(IGreeter.class.getName());</span>
<span class="hljs-deletion">-    when(url.getProtocolServiceKey()).thenReturn(IGreeter.class.getName());</span>
    when(invoker.getUrl()).thenReturn(url);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">biOrClientStreamCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">then</span>(<span class="hljs-title">invocationOnMock</span> -&gt; </span>{

        Invocation invocation = (Invocation) invocationOnMock.getArguments()[<span class="hljs-number">0</span>];

        StreamObserver&lt;Object&gt; observer = (StreamObserver&lt;Object&gt;) invocation.getArguments()[<span class="hljs-number">0</span>];

        observer.onNext(response);

        observer.onCompleted();

        when(result.recreate()).then(invocationOnMock1 -&gt; <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



            <span class="hljs-meta">@Override</span>

            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

                observer.onNext(data);

            }



            <span class="hljs-meta">@Override</span>

            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

            }



            <span class="hljs-meta">@Override</span>

            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

                observer.onCompleted();

            }

        });

        <span class="hljs-keyword">return</span> result;

    });

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">11</span>);

    StreamObserver&lt;Object&gt; responseObserver = <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

            latch.countDown();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

            latch.countDown();

        }

    };

    StreamObserver&lt;Object&gt; observer = StubInvocationUtil.biOrClientStreamCall(invoker, method, responseObserver);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {

        observer.onNext(request);

    }

    observer.onCompleted();

    Assertions.assertTrue(latch.await(<span class="hljs-number">1</span>, TimeUnit.SECONDS));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> URL <span class="hljs-title">createMockUrl</span><span class="hljs-params">(ConsumerModel consumerModel)</span> </span>{
    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(url.getServiceModel()).thenReturn(consumerModel);
    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;
    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;
    <span class="hljs-keyword">return</span> url;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest115">Test Case ID #dubbo_Test_11_5</h4>
<h4 id="test-case-name-serverstreamcallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>serverStreamCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-url">Mock Object Variable Name: <code>url</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 void serverStreamCall() throws InterruptedException {
     Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker.class);
<span class="hljs-deletion">-    URL url = Mockito.mock(URL.class);</span>
     ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);
     ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
     when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
<span class="hljs-addition">+    URL url = createMockUrl(consumerModel);</span>
     when(invoker.getUrl()).thenReturn(url);
     when(invoker.getInterface()).thenReturn(IGreeter.class);
     Result result = Mockito.mock(Result.class);
     String response = "response";
     when(invoker.invoke(any(Invocation.class))).then(invocationOnMock -&gt; {
         Invocation invocation = (Invocation) invocationOnMock.getArguments()[0];
         StreamObserver&lt;Object&gt; observer = (StreamObserver&lt;Object&gt;) invocation.getArguments()[1];
         for (int i = 0; i &lt; 10; i++) {
             observer.onNext(response);
         }
         observer.onCompleted();
         return result;
     });
     MethodDescriptor method = Mockito.mock(MethodDescriptor.class);
     when(method.getParameterClasses()).thenReturn(new Class[] { String.class });
     when(method.getMethodName()).thenReturn("sayHello");
     String request = "request";
     CountDownLatch latch = new CountDownLatch(11);
     StreamObserver&lt;Object&gt; responseObserver = new StreamObserver&lt;Object&gt;() {

         @Override
         public void onNext(Object data) {
             latch.countDown();
         }

         @Override
         public void onError(Throwable throwable) {
         }

         @Override
         public void onCompleted() {
             latch.countDown();
         }
     };
     StubInvocationUtil.serverStreamCall(invoker, method, request, responseObserver);
     Assertions.assertTrue(latch.await(1, TimeUnit.SECONDS));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">serverStreamCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">then</span>(<span class="hljs-title">invocationOnMock</span> -&gt; </span>{

        Invocation invocation = (Invocation) invocationOnMock.getArguments()[<span class="hljs-number">0</span>];

        StreamObserver&lt;Object&gt; observer = (StreamObserver&lt;Object&gt;) invocation.getArguments()[<span class="hljs-number">1</span>];

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {

            observer.onNext(response);

        }

        observer.onCompleted();

        <span class="hljs-keyword">return</span> result;

    });

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">11</span>);

    StreamObserver&lt;Object&gt; responseObserver = <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

            latch.countDown();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

            latch.countDown();

        }

    };

    StubInvocationUtil.serverStreamCall(invoker, method, request, responseObserver);

    Assertions.assertTrue(latch.await(<span class="hljs-number">1</span>, TimeUnit.SECONDS));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> URL <span class="hljs-title">createMockUrl</span><span class="hljs-params">(ConsumerModel consumerModel)</span> </span>{
    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(url.getServiceModel()).thenReturn(consumerModel);
    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;
    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;
    <span class="hljs-keyword">return</span> url;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci12">Mock Clone Instance #dubbo_MCI_12</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.common.URL</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockURL</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> URL <span class="hljs-title">createMockURL</span><span class="hljs-params">(ProviderModel providerModel)</span> </span>{
        URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(url.getServiceModel()).thenReturn(providerModel);
        <span class="hljs-keyword">return</span> url;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest121">Test Case ID #dubbo_Test_12_1</h4>
<h4 id="test-case-name-dostartcallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcprotocoltricallreflectionservercalltestjava">Test Case Name: <code>doStartCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\protocol\tri\call\ReflectionServerCallTest.java</code>)</h4>
<h4 id="mock-object-variable-name-url">Mock Object Variable Name: <code>url</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Method method = DescriptorService.class.getMethod("sayHello", HelloReply.class);
    MethodDescriptor methodDescriptor = new ReflectionMethodDescriptor(method);
<span class="hljs-deletion">-    URL url = Mockito.mock(URL.class);</span>
<span class="hljs-addition">+    URL url = MockURL.createMockURL(providerModel);</span>
    when(invoker.getUrl()).thenReturn(url);
<span class="hljs-deletion">-    when(url.getServiceModel()).thenReturn(providerModel);</span>
    String service = "testService";
    String methodName = "method";
    try {
        ReflectionAbstractServerCall call = new ReflectionAbstractServerCall(invoker, serverStream, new FrameworkModel(), "", service, methodName, Collections.emptyList(), ImmediateEventExecutor.INSTANCE);
        fail();
    } catch (Exception e) {
        // pass
    }
    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
    when(serviceDescriptor.getMethods(anyString())).thenReturn(Collections.singletonList(methodDescriptor));
    when(providerModel.getServiceModel()).thenReturn(serviceDescriptor);
    ReflectionAbstractServerCall call2 = new ReflectionAbstractServerCall(invoker, serverStream, new FrameworkModel(), "", service, methodName, Collections.emptyList(), ImmediateEventExecutor.INSTANCE);
    call2.onHeader(Collections.emptyMap());
    call2.onMessage(new byte[0], false);
    call2.onComplete();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">doStartCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NoSuchMethodException </span>{

    Invoker&lt;?&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TripleServerStream serverStream = Mockito.mock(TripleServerStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ProviderModel providerModel = Mockito.mock(ProviderModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Method method = DescriptorService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getMethod</span>("<span class="hljs-title">sayHello</span>", <span class="hljs-title">HelloReply</span>.<span class="hljs-title">class</span>)</span>;

    MethodDescriptor methodDescriptor = <span class="hljs-keyword">new</span> ReflectionMethodDescriptor(method);

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(url.getServiceModel()).thenReturn(providerModel);

    String service = <span class="hljs-string">"testService"</span>;

    String methodName = <span class="hljs-string">"method"</span>;

    <span class="hljs-keyword">try</span> {

        ReflectionAbstractServerCall call = <span class="hljs-keyword">new</span> ReflectionAbstractServerCall(invoker, serverStream, <span class="hljs-keyword">new</span> FrameworkModel(), <span class="hljs-string">""</span>, service, methodName, Collections.emptyList(), ImmediateEventExecutor.INSTANCE);

        fail();

    } <span class="hljs-keyword">catch</span> (Exception e) {

        <span class="hljs-comment">// pass</span>

    }

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(serviceDescriptor.getMethods(anyString())).thenReturn(Collections.singletonList(methodDescriptor));

    when(providerModel.getServiceModel()).thenReturn(serviceDescriptor);

    ReflectionAbstractServerCall call2 = <span class="hljs-keyword">new</span> ReflectionAbstractServerCall(invoker, serverStream, <span class="hljs-keyword">new</span> FrameworkModel(), <span class="hljs-string">""</span>, service, methodName, Collections.emptyList(), ImmediateEventExecutor.INSTANCE);

    call2.onHeader(Collections.emptyMap());

    call2.onMessage(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">0</span>], <span class="hljs-keyword">false</span>);

    call2.onComplete();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockURL</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> URL <span class="hljs-title">createMockURL</span><span class="hljs-params">(ProviderModel providerModel)</span> </span>{
        URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(url.getServiceModel()).thenReturn(providerModel);
        <span class="hljs-keyword">return</span> url;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest122">Test Case ID #dubbo_Test_12_2</h4>
<h4 id="test-case-name-dostartcallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcprotocoltricallstubservercalltestjava">Test Case Name: <code>doStartCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\protocol\tri\call\StubServerCallTest.java</code>)</h4>
<h4 id="mock-object-variable-name-url">Mock Object Variable Name: <code>url</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
    StubMethodDescriptor methodDescriptor = Mockito.mock(StubMethodDescriptor.class);
<span class="hljs-deletion">-    URL url = Mockito.mock(URL.class);</span>
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
<span class="hljs-deletion">-    when(url.getServiceModel()).thenReturn(providerModel);</span>
<span class="hljs-addition">+    URL url = MockURL.createMockURL(providerModel);</span>
<span class="hljs-addition">+    when(invoker.getUrl()).thenReturn(url);</span>
    when(providerModel.getServiceModel()).thenReturn(serviceDescriptor);
    when(serviceDescriptor.getMethods(anyString())).thenReturn(Collections.singletonList(methodDescriptor));
    when(methodDescriptor.getRpcType()).thenReturn(RpcType.UNARY);
    when(methodDescriptor.parseRequest(any(byte[].class))).thenReturn("test");
    String service = "testService";
    String method = "method";
    StubAbstractServerCall call = new StubAbstractServerCall(invoker, tripleServerStream, new FrameworkModel(), "", service, method, ImmediateEventExecutor.INSTANCE);
    call.onHeader(Collections.emptyMap());
    call.onMessage(new byte[0], false);
    call.onComplete();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">doStartCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>{

    Invoker&lt;?&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TripleServerStream tripleServerStream = Mockito.mock(TripleServerStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ProviderModel providerModel = Mockito.mock(ProviderModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    StubMethodDescriptor methodDescriptor = Mockito.mock(StubMethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(url.getServiceModel()).thenReturn(providerModel);

    when(providerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(serviceDescriptor.getMethods(anyString())).thenReturn(Collections.singletonList(methodDescriptor));

    when(methodDescriptor.getRpcType()).thenReturn(RpcType.UNARY);

    when(methodDescriptor.parseRequest(any(<span class="hljs-keyword">byte</span>[]<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>("<span class="hljs-title">test</span>")</span>;

    String service = <span class="hljs-string">"testService"</span>;

    String method = <span class="hljs-string">"method"</span>;

    StubAbstractServerCall call = <span class="hljs-keyword">new</span> StubAbstractServerCall(invoker, tripleServerStream, <span class="hljs-keyword">new</span> FrameworkModel(), <span class="hljs-string">""</span>, service, method, ImmediateEventExecutor.INSTANCE);

    call.onHeader(Collections.emptyMap());

    call.onMessage(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">0</span>], <span class="hljs-keyword">false</span>);

    call.onComplete();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockURL</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> URL <span class="hljs-title">createMockURL</span><span class="hljs-params">(ProviderModel providerModel)</span> </span>{
        URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(url.getServiceModel()).thenReturn(providerModel);
        <span class="hljs-keyword">return</span> url;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci13">Mock Clone Instance #dubbo_MCI_13</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.common.URL</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> org.apache.dubbo.common.<span class="hljs-function">URL <span class="hljs-title">createMockUrl</span><span class="hljs-params">(String serviceKeyReturn, String getParameterKey, String getParameterReturn)</span> </span>{
    org.apache.dubbo.common.URL url = Mockito.mock(org.apache.dubbo.common.URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(url.getServiceKey()).thenReturn(serviceKeyReturn);
    Mockito.when(url.getParameter(getParameterKey)).thenReturn(getParameterReturn);
    <span class="hljs-keyword">return</span> url;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest131">Test Case ID #dubbo_Test_13_1</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationrulelistenertestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationRuleListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-consumerurl">Mock Object Variable Name: <code>consumerURL</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    applicationConfig.setName("demo-consumer");
    ApplicationModel.defaultModel().getApplicationConfigManager().setApplication(applicationConfig);
<span class="hljs-deletion">-    URL consumerURL = Mockito.mock(URL.class);</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL.getServiceKey()).thenReturn("Test");</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL.getParameter("timestamp")).thenReturn("1");</span>
<span class="hljs-addition">+    URL consumerURL = createMockUrl("Test", "timestamp", "1");</span>
    System.setProperty("dubbo.application.migration.delay", "1");
    MigrationRuleHandler&lt;?&gt; handler = Mockito.mock(MigrationRuleHandler.class, Mockito.withSettings().verboseLogging());
    CountDownLatch countDownLatch = new CountDownLatch(1);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Listener started with config center and local rule, no initial remote rule.

 * Check local rule take effect

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    DynamicConfiguration dynamicConfiguration = Mockito.mock(DynamicConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ApplicationModel.reset();

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setDynamicConfiguration(dynamicConfiguration);

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setLocalMigrationRule(localRule);

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"demo-consumer"</span>);

    ApplicationModel.defaultModel().getApplicationConfigManager().setApplication(applicationConfig);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getParameter(<span class="hljs-string">"timestamp"</span>)).thenReturn(<span class="hljs-string">"1"</span>);

    System.setProperty(<span class="hljs-string">"dubbo.application.migration.delay"</span>, <span class="hljs-string">"1"</span>);

    MigrationRuleHandler&lt;?&gt; handler = Mockito.mock(MigrationRuleHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">verboseLogging</span>())</span>;

    CountDownLatch countDownLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    MigrationRuleListener migrationRuleListener = <span class="hljs-keyword">new</span> MigrationRuleListener(ApplicationModel.defaultModel().getDefaultModule()) {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">process</span><span class="hljs-params">(ConfigChangedEvent event)</span> </span>{

            <span class="hljs-keyword">try</span> {

                countDownLatch.await();

            } <span class="hljs-keyword">catch</span> (InterruptedException e) {

                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);

            }

            <span class="hljs-keyword">super</span>.process(event);

        }

    };

    MigrationInvoker&lt;?&gt; migrationInvoker = Mockito.mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    migrationRuleListener.getHandlers().put(migrationInvoker, handler);

    countDownLatch.countDown();

    await().untilAsserted(() -&gt; {

        Mockito.verify(handler).doMigrate(Mockito.any());

    });

    <span class="hljs-comment">//        Mockito.verify(handler, Mockito.timeout(5000)).doMigrate(Mockito.any());</span>

    migrationRuleListener.onRefer(<span class="hljs-keyword">null</span>, migrationInvoker, consumerURL, <span class="hljs-keyword">null</span>);

    Mockito.verify(handler, Mockito.times(<span class="hljs-number">2</span>)).doMigrate(Mockito.any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> org.apache.dubbo.common.<span class="hljs-function">URL <span class="hljs-title">createMockUrl</span><span class="hljs-params">(String serviceKeyReturn, String getParameterKey, String getParameterReturn)</span> </span>{
    org.apache.dubbo.common.URL url = Mockito.mock(org.apache.dubbo.common.URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(url.getServiceKey()).thenReturn(serviceKeyReturn);
    Mockito.when(url.getParameter(getParameterKey)).thenReturn(getParameterReturn);
    <span class="hljs-keyword">return</span> url;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest132">Test Case ID #dubbo_Test_13_2</h4>
<h4 id="test-case-name-testwithinitandnolocalrulefile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationrulelistenertestjava">Test Case Name: <code>testWithInitAndNoLocalRule</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationRuleListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-consumerurl">Mock Object Variable Name: <code>consumerURL</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     applicationConfig.setName("demo-consumer");
     ApplicationModel.defaultModel().getApplicationConfigManager().setApplication(applicationConfig);
<span class="hljs-deletion">-    URL consumerURL = Mockito.mock(URL.class);</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL.getServiceKey()).thenReturn("Test");</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL.getParameter("timestamp")).thenReturn("1");</span>
<span class="hljs-addition">+    URL consumerURL = createMockUrl("Test", "timestamp", "1");</span>
     System.setProperty("dubbo.application.migration.delay", "1000");
     MigrationRuleHandler&lt;?&gt; handler = Mockito.mock(MigrationRuleHandler.class, Mockito.withSettings().verboseLogging());
     MigrationRuleListener migrationRuleListener = new MigrationRuleListener(ApplicationModel.defaultModel().getDefaultModule());
     MigrationInvoker&lt;?&gt; migrationInvoker = Mockito.mock(MigrationInvoker.class);
     migrationRuleListener.getHandlers().put(migrationInvoker, handler);
     migrationRuleListener.onRefer(null, migrationInvoker, consumerURL, null);
     // check migration happened after invoker referred
     Mockito.verify(handler, Mockito.times(1)).doMigrate(MigrationRule.getInitRule());
     // check no delay tasks created for there's no local rule and no config center
     Assertions.assertNull(migrationRuleListener.localRuleMigrationFuture);
     Assertions.assertNull(migrationRuleListener.ruleMigrationFuture);
     Assertions.assertEquals(0, migrationRuleListener.ruleQueue.size());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Test listener started without local rule and config center, INIT should be used and no scheduled task should be started.

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testWithInitAndNoLocalRule</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setDynamicConfiguration(<span class="hljs-keyword">null</span>);

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setLocalMigrationRule(<span class="hljs-string">""</span>);

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"demo-consumer"</span>);

    ApplicationModel.defaultModel().getApplicationConfigManager().setApplication(applicationConfig);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getParameter(<span class="hljs-string">"timestamp"</span>)).thenReturn(<span class="hljs-string">"1"</span>);

    System.setProperty(<span class="hljs-string">"dubbo.application.migration.delay"</span>, <span class="hljs-string">"1000"</span>);

    MigrationRuleHandler&lt;?&gt; handler = Mockito.mock(MigrationRuleHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">verboseLogging</span>())</span>;

    MigrationRuleListener migrationRuleListener = <span class="hljs-keyword">new</span> MigrationRuleListener(ApplicationModel.defaultModel().getDefaultModule());

    MigrationInvoker&lt;?&gt; migrationInvoker = Mockito.mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    migrationRuleListener.getHandlers().put(migrationInvoker, handler);

    migrationRuleListener.onRefer(<span class="hljs-keyword">null</span>, migrationInvoker, consumerURL, <span class="hljs-keyword">null</span>);

    <span class="hljs-comment">// check migration happened after invoker referred</span>

    Mockito.verify(handler, Mockito.times(<span class="hljs-number">1</span>)).doMigrate(MigrationRule.getInitRule());

    <span class="hljs-comment">// check no delay tasks created for there's no local rule and no config center</span>

    Assertions.assertNull(migrationRuleListener.localRuleMigrationFuture);

    Assertions.assertNull(migrationRuleListener.ruleMigrationFuture);

    Assertions.assertEquals(<span class="hljs-number">0</span>, migrationRuleListener.ruleQueue.size());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> org.apache.dubbo.common.<span class="hljs-function">URL <span class="hljs-title">createMockUrl</span><span class="hljs-params">(String serviceKeyReturn, String getParameterKey, String getParameterReturn)</span> </span>{
    org.apache.dubbo.common.URL url = Mockito.mock(org.apache.dubbo.common.URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(url.getServiceKey()).thenReturn(serviceKeyReturn);
    Mockito.when(url.getParameter(getParameterKey)).thenReturn(getParameterReturn);
    <span class="hljs-keyword">return</span> url;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest133">Test Case ID #dubbo_Test_13_3</h4>
<h4 id="test-case-name-testwithconfigurationlistenerandlocalrulefile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationrulelistenertestjava">Test Case Name: <code>testWithConfigurationListenerAndLocalRule</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationRuleListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-consumerurl">Mock Object Variable Name: <code>consumerURL</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    ApplicationConfig applicationConfig = new ApplicationConfig();
    applicationConfig.setName("demo-consumer");
    ApplicationModel.defaultModel().getApplicationConfigManager().setApplication(applicationConfig);
<span class="hljs-deletion">-    URL consumerURL = Mockito.mock(URL.class);</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL.getServiceKey()).thenReturn("Test");</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL.getParameter("timestamp")).thenReturn("1");</span>
<span class="hljs-addition">+    URL consumerURL = createMockUrl("Test", "timestamp", "1");</span>
    URL consumerURL2 = Mockito.mock(URL.class);
    Mockito.when(consumerURL2.getServiceKey()).thenReturn("Test2");
    Mockito.when(consumerURL2.getParameter("timestamp")).thenReturn("2");
    System.setProperty("dubbo.application.migration.delay", "10");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Listener with config center initial remote rule and local rule, check

 * 1. initial remote rule other than local rule take effect

 * 2. remote rule change and all invokers gets notified

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testWithConfigurationListenerAndLocalRule</span><span class="hljs-params">()</span> </span>{

    DynamicConfiguration dynamicConfiguration = Mockito.mock(DynamicConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.doReturn(remoteRule).when(dynamicConfiguration).getConfig(Mockito.anyString(), Mockito.anyString());

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setDynamicConfiguration(dynamicConfiguration);

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setLocalMigrationRule(localRule);

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"demo-consumer"</span>);

    ApplicationModel.defaultModel().getApplicationConfigManager().setApplication(applicationConfig);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getParameter(<span class="hljs-string">"timestamp"</span>)).thenReturn(<span class="hljs-string">"1"</span>);

    URL consumerURL2 = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL2.getServiceKey()).thenReturn(<span class="hljs-string">"Test2"</span>);

    Mockito.when(consumerURL2.getParameter(<span class="hljs-string">"timestamp"</span>)).thenReturn(<span class="hljs-string">"2"</span>);

    System.setProperty(<span class="hljs-string">"dubbo.application.migration.delay"</span>, <span class="hljs-string">"10"</span>);

    MigrationRuleHandler&lt;?&gt; handler = Mockito.mock(MigrationRuleHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">verboseLogging</span>())</span>;

    MigrationRuleHandler&lt;?&gt; handler2 = Mockito.mock(MigrationRuleHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">verboseLogging</span>())</span>;

    <span class="hljs-comment">// Both local rule and remote rule are here</span>

    <span class="hljs-comment">// Local rule with one delayed task started to apply</span>

    MigrationRuleListener migrationRuleListener = <span class="hljs-keyword">new</span> MigrationRuleListener(ApplicationModel.defaultModel().getDefaultModule());

    Assertions.assertNotNull(migrationRuleListener.localRuleMigrationFuture);

    Assertions.assertNull(migrationRuleListener.ruleMigrationFuture);

    MigrationInvoker&lt;?&gt; migrationInvoker = Mockito.mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationInvoker&lt;?&gt; migrationInvoker2 = Mockito.mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// Remote rule will be applied when onRefer gets executed</span>

    migrationRuleListener.getHandlers().put(migrationInvoker, handler);

    migrationRuleListener.onRefer(<span class="hljs-keyword">null</span>, migrationInvoker, consumerURL, <span class="hljs-keyword">null</span>);

    MigrationRule tmpRemoteRule = migrationRuleListener.getRule();

    ArgumentCaptor&lt;MigrationRule&gt; captor = ArgumentCaptor.forClass(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(handler, Mockito.times(<span class="hljs-number">1</span>)).doMigrate(captor.capture());

    Assertions.assertEquals(tmpRemoteRule, captor.getValue());

    await().until(() -&gt; migrationRuleListener.localRuleMigrationFuture.isDone());

    Assertions.assertNull(migrationRuleListener.ruleMigrationFuture);

    Assertions.assertEquals(tmpRemoteRule, migrationRuleListener.getRule());

    Mockito.verify(handler, Mockito.times(<span class="hljs-number">1</span>)).doMigrate(Mockito.any());

    ArgumentCaptor&lt;MigrationRule&gt; captor2 = ArgumentCaptor.forClass(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    migrationRuleListener.getHandlers().put(migrationInvoker2, handler2);

    migrationRuleListener.onRefer(<span class="hljs-keyword">null</span>, migrationInvoker2, consumerURL2, <span class="hljs-keyword">null</span>);

    Mockito.verify(handler2, Mockito.times(<span class="hljs-number">1</span>)).doMigrate(captor2.capture());

    Assertions.assertEquals(tmpRemoteRule, captor2.getValue());

    migrationRuleListener.process(<span class="hljs-keyword">new</span> ConfigChangedEvent(<span class="hljs-string">"key"</span>, <span class="hljs-string">"group"</span>, dynamicRemoteRule));

    await().until(migrationRuleListener.ruleQueue::isEmpty);

    await().untilAsserted(() -&gt; {

        Mockito.verify(handler, Mockito.times(<span class="hljs-number">2</span>)).doMigrate(Mockito.any());

        Mockito.verify(handler2, Mockito.times(<span class="hljs-number">2</span>)).doMigrate(Mockito.any());

    });

    Assertions.assertNotNull(migrationRuleListener.ruleMigrationFuture);

    ArgumentCaptor&lt;MigrationRule&gt; captor_event = ArgumentCaptor.forClass(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(handler, Mockito.times(<span class="hljs-number">2</span>)).doMigrate(captor_event.capture());

    Assertions.assertEquals(<span class="hljs-string">"APPLICATION_FIRST"</span>, captor_event.getValue().getStep().toString());

    Mockito.verify(handler2, Mockito.times(<span class="hljs-number">2</span>)).doMigrate(captor_event.capture());

    Assertions.assertEquals(<span class="hljs-string">"APPLICATION_FIRST"</span>, captor_event.getValue().getStep().toString());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> org.apache.dubbo.common.<span class="hljs-function">URL <span class="hljs-title">createMockUrl</span><span class="hljs-params">(String serviceKeyReturn, String getParameterKey, String getParameterReturn)</span> </span>{
    org.apache.dubbo.common.URL url = Mockito.mock(org.apache.dubbo.common.URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(url.getServiceKey()).thenReturn(serviceKeyReturn);
    Mockito.when(url.getParameter(getParameterKey)).thenReturn(getParameterReturn);
    <span class="hljs-keyword">return</span> url;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest134">Test Case ID #dubbo_Test_13_4</h4>
<h4 id="test-case-name-testwithconfigurationlistenerandlocalrulefile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationrulelistenertestjava">Test Case Name: <code>testWithConfigurationListenerAndLocalRule</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationRuleListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-consumerurl2">Mock Object Variable Name: <code>consumerURL2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Mockito.when(consumerURL.getServiceKey()).thenReturn("Test");
    Mockito.when(consumerURL.getParameter("timestamp")).thenReturn("1");
<span class="hljs-deletion">-    URL consumerURL2 = Mockito.mock(URL.class);</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL2.getServiceKey()).thenReturn("Test2");</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL2.getParameter("timestamp")).thenReturn("2");</span>
<span class="hljs-addition">+    URL consumerURL2 = createMockUrl("Test2", "timestamp", "2");</span>
    System.setProperty("dubbo.application.migration.delay", "10");
    MigrationRuleHandler&lt;?&gt; handler = Mockito.mock(MigrationRuleHandler.class, Mockito.withSettings().verboseLogging());
    MigrationRuleHandler&lt;?&gt; handler2 = Mockito.mock(MigrationRuleHandler.class, Mockito.withSettings().verboseLogging());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Listener with config center initial remote rule and local rule, check

 * 1. initial remote rule other than local rule take effect

 * 2. remote rule change and all invokers gets notified

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testWithConfigurationListenerAndLocalRule</span><span class="hljs-params">()</span> </span>{

    DynamicConfiguration dynamicConfiguration = Mockito.mock(DynamicConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.doReturn(remoteRule).when(dynamicConfiguration).getConfig(Mockito.anyString(), Mockito.anyString());

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setDynamicConfiguration(dynamicConfiguration);

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setLocalMigrationRule(localRule);

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"demo-consumer"</span>);

    ApplicationModel.defaultModel().getApplicationConfigManager().setApplication(applicationConfig);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getParameter(<span class="hljs-string">"timestamp"</span>)).thenReturn(<span class="hljs-string">"1"</span>);

    URL consumerURL2 = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL2.getServiceKey()).thenReturn(<span class="hljs-string">"Test2"</span>);

    Mockito.when(consumerURL2.getParameter(<span class="hljs-string">"timestamp"</span>)).thenReturn(<span class="hljs-string">"2"</span>);

    System.setProperty(<span class="hljs-string">"dubbo.application.migration.delay"</span>, <span class="hljs-string">"10"</span>);

    MigrationRuleHandler&lt;?&gt; handler = Mockito.mock(MigrationRuleHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">verboseLogging</span>())</span>;

    MigrationRuleHandler&lt;?&gt; handler2 = Mockito.mock(MigrationRuleHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">verboseLogging</span>())</span>;

    <span class="hljs-comment">// Both local rule and remote rule are here</span>

    <span class="hljs-comment">// Local rule with one delayed task started to apply</span>

    MigrationRuleListener migrationRuleListener = <span class="hljs-keyword">new</span> MigrationRuleListener(ApplicationModel.defaultModel().getDefaultModule());

    Assertions.assertNotNull(migrationRuleListener.localRuleMigrationFuture);

    Assertions.assertNull(migrationRuleListener.ruleMigrationFuture);

    MigrationInvoker&lt;?&gt; migrationInvoker = Mockito.mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationInvoker&lt;?&gt; migrationInvoker2 = Mockito.mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// Remote rule will be applied when onRefer gets executed</span>

    migrationRuleListener.getHandlers().put(migrationInvoker, handler);

    migrationRuleListener.onRefer(<span class="hljs-keyword">null</span>, migrationInvoker, consumerURL, <span class="hljs-keyword">null</span>);

    MigrationRule tmpRemoteRule = migrationRuleListener.getRule();

    ArgumentCaptor&lt;MigrationRule&gt; captor = ArgumentCaptor.forClass(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(handler, Mockito.times(<span class="hljs-number">1</span>)).doMigrate(captor.capture());

    Assertions.assertEquals(tmpRemoteRule, captor.getValue());

    await().until(() -&gt; migrationRuleListener.localRuleMigrationFuture.isDone());

    Assertions.assertNull(migrationRuleListener.ruleMigrationFuture);

    Assertions.assertEquals(tmpRemoteRule, migrationRuleListener.getRule());

    Mockito.verify(handler, Mockito.times(<span class="hljs-number">1</span>)).doMigrate(Mockito.any());

    ArgumentCaptor&lt;MigrationRule&gt; captor2 = ArgumentCaptor.forClass(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    migrationRuleListener.getHandlers().put(migrationInvoker2, handler2);

    migrationRuleListener.onRefer(<span class="hljs-keyword">null</span>, migrationInvoker2, consumerURL2, <span class="hljs-keyword">null</span>);

    Mockito.verify(handler2, Mockito.times(<span class="hljs-number">1</span>)).doMigrate(captor2.capture());

    Assertions.assertEquals(tmpRemoteRule, captor2.getValue());

    migrationRuleListener.process(<span class="hljs-keyword">new</span> ConfigChangedEvent(<span class="hljs-string">"key"</span>, <span class="hljs-string">"group"</span>, dynamicRemoteRule));

    await().until(migrationRuleListener.ruleQueue::isEmpty);

    await().untilAsserted(() -&gt; {

        Mockito.verify(handler, Mockito.times(<span class="hljs-number">2</span>)).doMigrate(Mockito.any());

        Mockito.verify(handler2, Mockito.times(<span class="hljs-number">2</span>)).doMigrate(Mockito.any());

    });

    Assertions.assertNotNull(migrationRuleListener.ruleMigrationFuture);

    ArgumentCaptor&lt;MigrationRule&gt; captor_event = ArgumentCaptor.forClass(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(handler, Mockito.times(<span class="hljs-number">2</span>)).doMigrate(captor_event.capture());

    Assertions.assertEquals(<span class="hljs-string">"APPLICATION_FIRST"</span>, captor_event.getValue().getStep().toString());

    Mockito.verify(handler2, Mockito.times(<span class="hljs-number">2</span>)).doMigrate(captor_event.capture());

    Assertions.assertEquals(<span class="hljs-string">"APPLICATION_FIRST"</span>, captor_event.getValue().getStep().toString());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> org.apache.dubbo.common.<span class="hljs-function">URL <span class="hljs-title">createMockUrl</span><span class="hljs-params">(String serviceKeyReturn, String getParameterKey, String getParameterReturn)</span> </span>{
    org.apache.dubbo.common.URL url = Mockito.mock(org.apache.dubbo.common.URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(url.getServiceKey()).thenReturn(serviceKeyReturn);
    Mockito.when(url.getParameter(getParameterKey)).thenReturn(getParameterReturn);
    <span class="hljs-keyword">return</span> url;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci14">Mock Clone Instance #dubbo_MCI_14</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.common.URL</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> URL <span class="hljs-title">createMockConsumerURL</span><span class="hljs-params">(String serviceInterface, String group, String version, String serviceKey, String displayServiceKey, ApplicationModel applicationModel)</span> </span>{
    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(consumerURL.getServiceInterface()).thenReturn(serviceInterface);
    Mockito.when(consumerURL.getGroup()).thenReturn(group);
    Mockito.when(consumerURL.getVersion()).thenReturn(version);
    Mockito.when(consumerURL.getServiceKey()).thenReturn(serviceKey);
    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn(displayServiceKey);
    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(applicationModel);
    <span class="hljs-keyword">return</span> consumerURL;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest141">Test Case ID #dubbo_Test_14_1</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationinvokertestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-consumerurl">Mock Object Variable Name: <code>consumerURL</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);
     Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);
<span class="hljs-deletion">-    URL consumerURL = Mockito.mock(URL.class);</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL.getServiceInterface()).thenReturn("Test");</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL.getGroup()).thenReturn("Group");</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL.getVersion()).thenReturn("0.0.0");</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL.getServiceKey()).thenReturn("Group/Test:0.0.0");</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn("Test:0.0.0");</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());</span>
<span class="hljs-addition">+    URL consumerURL = createMockConsumerURL(</span>
<span class="hljs-addition">+        "Test",</span>
<span class="hljs-addition">+        "Group",</span>
<span class="hljs-addition">+        "0.0.0",</span>
<span class="hljs-addition">+        "Group/Test:0.0.0",</span>
<span class="hljs-addition">+        "Test:0.0.0",</span>
<span class="hljs-addition">+        ApplicationModel.defaultModel()</span>
<span class="hljs-addition">+    );</span>
     Mockito.when(invoker.getUrl()).thenReturn(consumerURL);
     Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);
     MigrationInvoker&lt;?&gt; migrationInvoker = new MigrationInvoker&lt;&gt;(registryProtocol, null, null, DemoService.class, null, consumerURL);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"all"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker invoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory directory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(invoker.getDirectory()).thenReturn(directory);

    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);

    Mockito.when(invoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(invoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;Invoker&lt;?&gt;&gt; invokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);

    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);

    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);

    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceInterface()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getGroup()).thenReturn(<span class="hljs-string">"Group"</span>);

    Mockito.when(consumerURL.getVersion()).thenReturn(<span class="hljs-string">"0.0.0"</span>);

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Group/Test:0.0.0"</span>);

    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn(<span class="hljs-string">"Test:0.0.0"</span>);

    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());

    Mockito.when(invoker.getUrl()).thenReturn(consumerURL);

    Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);

    MigrationInvoker&lt;?&gt; migrationInvoker = <span class="hljs-keyword">new</span> MigrationInvoker&lt;&gt;(registryProtocol, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">null</span>, <span class="hljs-title">consumerURL</span>)</span>;

    MigrationRule migrationRule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">3</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">4</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">5</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">3</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">4</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">5</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">6</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">6</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">7</span>)).invoke(<span class="hljs-keyword">null</span>);

    Assertions.assertNull(migrationInvoker.getInvoker());

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">7</span>)).invoke(<span class="hljs-keyword">null</span>);

    Assertions.assertNull(migrationInvoker.getServiceDiscoveryInvoker());

    ArgumentCaptor&lt;InvokersChangedListener&gt; argument = ArgumentCaptor.forClass(InvokersChangedListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(serviceDiscoveryDirectory, Mockito.atLeastOnce()).setInvokersChangedListener(argument.capture());

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">27</span>)).invoke(<span class="hljs-keyword">null</span>);

    serviceDiscoveryInvokers.remove(<span class="hljs-number">1</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">false</span>);

    argument.getAllValues().get(argument.getAllValues().size() - <span class="hljs-number">1</span>).onChange();

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">27</span>)).invoke(<span class="hljs-keyword">null</span>);

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    argument.getAllValues().get(argument.getAllValues().size() - <span class="hljs-number">1</span>).onChange();

    Mockito.when(migrationRule.getProportion(Mockito.any())).thenReturn(<span class="hljs-number">50</span>);

    migrationInvoker.setMigrationRule(migrationRule);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(serviceDiscoveryInvoker, Mockito.atMost(<span class="hljs-number">1026</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.atLeast(<span class="hljs-number">28</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getDelay(Mockito.any())).thenReturn(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">long</span> currentTimeMillis = System.currentTimeMillis();

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    Assertions.assertTrue(System.currentTimeMillis() - currentTimeMillis &gt;= <span class="hljs-number">2000</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> URL <span class="hljs-title">createMockConsumerURL</span><span class="hljs-params">(String serviceInterface, String group, String version, String serviceKey, String displayServiceKey, ApplicationModel applicationModel)</span> </span>{
    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(consumerURL.getServiceInterface()).thenReturn(serviceInterface);
    Mockito.when(consumerURL.getGroup()).thenReturn(group);
    Mockito.when(consumerURL.getVersion()).thenReturn(version);
    Mockito.when(consumerURL.getServiceKey()).thenReturn(serviceKey);
    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn(displayServiceKey);
    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(applicationModel);
    <span class="hljs-keyword">return</span> consumerURL;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest142">Test Case ID #dubbo_Test_14_2</h4>
<h4 id="test-case-name-testdecidefile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationinvokertestjava">Test Case Name: <code>testDecide</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-consumerurl">Mock Object Variable Name: <code>consumerURL</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);
    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);
<span class="hljs-deletion">-    URL consumerURL = Mockito.mock(URL.class);</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL.getServiceInterface()).thenReturn("Test");</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL.getGroup()).thenReturn("Group");</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL.getVersion()).thenReturn("0.0.0");</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL.getServiceKey()).thenReturn("Group/Test:0.0.0");</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn("Test:0.0.0");</span>
<span class="hljs-deletion">-    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());</span>
<span class="hljs-addition">+    URL consumerURL = createMockConsumerURL(</span>
<span class="hljs-addition">+        "Test",</span>
<span class="hljs-addition">+        "Group",</span>
<span class="hljs-addition">+        "0.0.0",</span>
<span class="hljs-addition">+        "Group/Test:0.0.0",</span>
<span class="hljs-addition">+        "Test:0.0.0",</span>
<span class="hljs-addition">+        ApplicationModel.defaultModel()</span>
<span class="hljs-addition">+    );</span>
    Mockito.when(invoker.getUrl()).thenReturn(consumerURL);
    Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);
    MigrationInvoker&lt;?&gt; migrationInvoker = new MigrationInvoker&lt;&gt;(registryProtocol, null, null, DemoService.class, null, consumerURL);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"all"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testDecide</span><span class="hljs-params">()</span> </span>{

    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker invoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory directory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(invoker.getDirectory()).thenReturn(directory);

    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);

    Mockito.when(invoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(invoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;Invoker&lt;?&gt;&gt; invokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);

    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);

    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);

    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceInterface()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getGroup()).thenReturn(<span class="hljs-string">"Group"</span>);

    Mockito.when(consumerURL.getVersion()).thenReturn(<span class="hljs-string">"0.0.0"</span>);

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Group/Test:0.0.0"</span>);

    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn(<span class="hljs-string">"Test:0.0.0"</span>);

    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());

    Mockito.when(invoker.getUrl()).thenReturn(consumerURL);

    Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);

    MigrationInvoker&lt;?&gt; migrationInvoker = <span class="hljs-keyword">new</span> MigrationInvoker&lt;&gt;(registryProtocol, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">null</span>, <span class="hljs-title">consumerURL</span>)</span>;

    MigrationRule migrationRule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> URL <span class="hljs-title">createMockConsumerURL</span><span class="hljs-params">(String serviceInterface, String group, String version, String serviceKey, String displayServiceKey, ApplicationModel applicationModel)</span> </span>{
    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(consumerURL.getServiceInterface()).thenReturn(serviceInterface);
    Mockito.when(consumerURL.getGroup()).thenReturn(group);
    Mockito.when(consumerURL.getVersion()).thenReturn(version);
    Mockito.when(consumerURL.getServiceKey()).thenReturn(serviceKey);
    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn(displayServiceKey);
    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(applicationModel);
    <span class="hljs-keyword">return</span> consumerURL;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci15">Mock Clone Instance #dubbo_MCI_15</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.common.URL</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> URL <span class="hljs-title">createMockUrl</span><span class="hljs-params">()</span> </span>{
    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(url.getPath()).thenReturn(<span class="hljs-string">"DemoInterface"</span>);
    <span class="hljs-keyword">return</span> url;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest151">Test Case ID #dubbo_Test_15_1</h4>
<h4 id="test-case-name-testroutepathmatchfile-cjavaprojectsapachedubbodubbo-xdssrctestjavaorgapachedubborpcclusterrouterxdsxdsroutetestjava">Test Case Name: <code>testRoutePathMatch</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-xds\src\test\java\org\apache\dubbo\rpc\cluster\router\xds\XdsRouteTest.java</code>)</h4>
<h4 id="mock-object-variable-name-url1">Mock Object Variable Name: <code>url1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Invocation invocation = Mockito.mock(Invocation.class);
    Invoker invoker = Mockito.mock(Invoker.class);
<span class="hljs-deletion">-    URL url1 = Mockito.mock(URL.class);</span>
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url1);</span>
<span class="hljs-deletion">-    when(url1.getPath()).thenReturn("DemoInterface");</span>
<span class="hljs-addition">+    URL url1 = createMockUrl();</span>
<span class="hljs-addition">+    when(invoker.getUrl()).thenReturn(url1);</span>
    when(invocation.getInvoker()).thenReturn(invoker);
    when(invocation.getMethodName()).thenReturn("call");
    Set&lt;Endpoint&gt; endpoints = new HashSet&lt;&gt;();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRoutePathMatch</span><span class="hljs-params">()</span> </span>{

    XdsRouter&lt;Object&gt; xdsRouter = <span class="hljs-keyword">new</span> XdsRouter&lt;&gt;(url, rdsRouteRuleManager, edsEndpointManager, <span class="hljs-keyword">true</span>);

    String appName = <span class="hljs-string">"app1"</span>;

    String cluster1 = <span class="hljs-string">"cluster-test1"</span>;

    Invoker&lt;Object&gt; invoker1 = createInvoker(appName, <span class="hljs-string">"1.1.1.1:20880"</span>);

    BitList&lt;Invoker&lt;Object&gt;&gt; invokers = <span class="hljs-keyword">new</span> BitList&lt;&gt;(Arrays.asList(invoker1, createInvoker(appName, <span class="hljs-string">"2.2.2.2:20880"</span>)));

    xdsRouter.notify(invokers);

    String path = <span class="hljs-string">"/DemoInterface/call"</span>;

    VirtualHost virtualHost = VirtualHost.newBuilder().addDomains(appName).addRoutes(Route.newBuilder().setName(<span class="hljs-string">"route-test"</span>).setMatch(RouteMatch.newBuilder().setPath(path).build()).setRoute(RouteAction.newBuilder().setCluster(cluster1).build()).build()).build();

    RdsVirtualHostListener hostListener = <span class="hljs-keyword">new</span> RdsVirtualHostListener(appName, rdsRouteRuleManager);

    hostListener.parseVirtualHost(virtualHost);

    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url1 = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.getUrl()).thenReturn(url1);

    when(url1.getPath()).thenReturn(<span class="hljs-string">"DemoInterface"</span>);

    when(invocation.getInvoker()).thenReturn(invoker);

    when(invocation.getMethodName()).thenReturn(<span class="hljs-string">"call"</span>);

    Set&lt;Endpoint&gt; endpoints = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    Endpoint endpoint1 = <span class="hljs-keyword">new</span> Endpoint();

    endpoint1.setAddress(<span class="hljs-string">"1.1.1.1"</span>);

    endpoint1.setPortValue(<span class="hljs-number">20880</span>);

    endpoints.add(endpoint1);

    edsEndpointManager.notifyEndpointChange(cluster1, endpoints);

    BitList&lt;Invoker&lt;Object&gt;&gt; routes = xdsRouter.route(invokers.clone(), <span class="hljs-keyword">null</span>, invocation, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);

    assertEquals(<span class="hljs-number">1</span>, routes.size());

    assertEquals(invoker1, routes.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> URL <span class="hljs-title">createMockUrl</span><span class="hljs-params">()</span> </span>{
    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(url.getPath()).thenReturn(<span class="hljs-string">"DemoInterface"</span>);
    <span class="hljs-keyword">return</span> url;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest152">Test Case ID #dubbo_Test_15_2</h4>
<h4 id="test-case-name-testroutemultiappfile-cjavaprojectsapachedubbodubbo-xdssrctestjavaorgapachedubborpcclusterrouterxdsxdsroutetestjava">Test Case Name: <code>testRouteMultiApp</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-xds\src\test\java\org\apache\dubbo\rpc\cluster\router\xds\XdsRouteTest.java</code>)</h4>
<h4 id="mock-object-variable-name-url1">Mock Object Variable Name: <code>url1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Invocation invocation = Mockito.mock(Invocation.class);
    Invoker invoker = Mockito.mock(Invoker.class);
<span class="hljs-deletion">-    URL url1 = Mockito.mock(URL.class);</span>
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url1);</span>
<span class="hljs-deletion">-    when(url1.getPath()).thenReturn("DemoInterface");</span>
<span class="hljs-addition">+    URL url1 = createMockUrl();</span>
<span class="hljs-addition">+    when(invoker.getUrl()).thenReturn(url1);</span>
    when(invocation.getInvoker()).thenReturn(invoker);
    when(invocation.getMethodName()).thenReturn("call");
    Set&lt;Endpoint&gt; endpoints = new HashSet&lt;&gt;();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRouteMultiApp</span><span class="hljs-params">()</span> </span>{

    XdsRouter&lt;Object&gt; xdsRouter = <span class="hljs-keyword">new</span> XdsRouter&lt;&gt;(url, rdsRouteRuleManager, edsEndpointManager, <span class="hljs-keyword">true</span>);

    String appName1 = <span class="hljs-string">"app1"</span>;

    String appName2 = <span class="hljs-string">"app2"</span>;

    String cluster1 = <span class="hljs-string">"cluster-test1"</span>;

    Invoker&lt;Object&gt; invoker1 = createInvoker(appName2, <span class="hljs-string">"1.1.1.1:20880"</span>);

    Invoker&lt;Object&gt; invoker2 = createInvoker(appName1, <span class="hljs-string">"2.2.2.2:20880"</span>);

    BitList&lt;Invoker&lt;Object&gt;&gt; invokers = <span class="hljs-keyword">new</span> BitList&lt;&gt;(Arrays.asList(invoker1, invoker2));

    xdsRouter.notify(invokers);

    assertEquals(xdsRouter.getSubscribeApplications().size(), <span class="hljs-number">2</span>);

    String path = <span class="hljs-string">"/DemoInterface/call"</span>;

    VirtualHost virtualHost = VirtualHost.newBuilder().addDomains(appName2).addRoutes(Route.newBuilder().setName(<span class="hljs-string">"route-test"</span>).setMatch(RouteMatch.newBuilder().setPath(path).build()).setRoute(RouteAction.newBuilder().setCluster(cluster1).build()).build()).build();

    RdsVirtualHostListener hostListener = <span class="hljs-keyword">new</span> RdsVirtualHostListener(appName2, rdsRouteRuleManager);

    hostListener.parseVirtualHost(virtualHost);

    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url1 = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.getUrl()).thenReturn(url1);

    when(url1.getPath()).thenReturn(<span class="hljs-string">"DemoInterface"</span>);

    when(invocation.getInvoker()).thenReturn(invoker);

    when(invocation.getMethodName()).thenReturn(<span class="hljs-string">"call"</span>);

    Set&lt;Endpoint&gt; endpoints = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    Endpoint endpoint1 = <span class="hljs-keyword">new</span> Endpoint();

    endpoint1.setAddress(<span class="hljs-string">"1.1.1.1"</span>);

    endpoint1.setPortValue(<span class="hljs-number">20880</span>);

    endpoints.add(endpoint1);

    edsEndpointManager.notifyEndpointChange(cluster1, endpoints);

    BitList&lt;Invoker&lt;Object&gt;&gt; routes = xdsRouter.route(invokers.clone(), <span class="hljs-keyword">null</span>, invocation, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);

    assertEquals(<span class="hljs-number">1</span>, routes.size());

    assertEquals(invoker1, routes.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> URL <span class="hljs-title">createMockUrl</span><span class="hljs-params">()</span> </span>{
    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(url.getPath()).thenReturn(<span class="hljs-string">"DemoInterface"</span>);
    <span class="hljs-keyword">return</span> url;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci16">Mock Clone Instance #dubbo_MCI_16</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.model.MethodDescriptor</code></li>
<li><strong>Test Case Count</strong>: 5</li>
<li><strong>MO Count</strong>: 5</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MethodDescriptor <span class="hljs-title">createMockMethodDescriptor</span><span class="hljs-params">()</span> </span>{
    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;
    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);
    <span class="hljs-keyword">return</span> method;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest161">Test Case ID #dubbo_Test_16_1</h4>
<h4 id="test-case-name-unarycallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>unaryCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-method">Mock Object Variable Name: <code>method</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(result.recreate()).thenReturn(response);
<span class="hljs-deletion">-    MethodDescriptor method = Mockito.mock(MethodDescriptor.class);</span>
<span class="hljs-deletion">-    when(method.getParameterClasses()).thenReturn(new Class[] { String.class });</span>
<span class="hljs-deletion">-    when(method.getMethodName()).thenReturn("sayHello");</span>
<span class="hljs-addition">+    MethodDescriptor method = createMockMethodDescriptor();</span>
    String request = "request";
    Object ret = StubInvocationUtil.unaryCall(invoker, method, request);
    Assertions.assertEquals(response, ret);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unaryCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">result</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(result.recreate()).thenReturn(response);

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    Object ret = StubInvocationUtil.unaryCall(invoker, method, request);

    Assertions.assertEquals(response, ret);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MethodDescriptor <span class="hljs-title">createMockMethodDescriptor</span><span class="hljs-params">()</span> </span>{
    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;
    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);
    <span class="hljs-keyword">return</span> method;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest162">Test Case ID #dubbo_Test_16_2</h4>
<h4 id="test-case-name-unarycall2file-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>unaryCall2</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-method">Mock Object Variable Name: <code>method</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(result.recreate()).thenReturn(response);
<span class="hljs-deletion">-    MethodDescriptor method = Mockito.mock(MethodDescriptor.class);</span>
<span class="hljs-deletion">-    when(method.getParameterClasses()).thenReturn(new Class[] { String.class });</span>
<span class="hljs-deletion">-    when(method.getMethodName()).thenReturn("sayHello");</span>
<span class="hljs-addition">+    MethodDescriptor method = createMockMethodDescriptor();</span>
    String request = "request";
    try {
        StubInvocationUtil.unaryCall(invoker, method, request);
        fail();
    } catch (Throwable t) {
        // pass
    }
    try {
        StubInvocationUtil.unaryCall(invoker, method, request);
        fail();
    } catch (Throwable t) {
        // pass
    }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unaryCall2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenThrow</span>(<span class="hljs-title">new</span> <span class="hljs-title">RuntimeException</span>("<span class="hljs-title">a</span>")).<span class="hljs-title">thenThrow</span>(<span class="hljs-title">new</span> <span class="hljs-title">Error</span>("<span class="hljs-title">b</span>"))</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(result.recreate()).thenReturn(response);

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    <span class="hljs-keyword">try</span> {

        StubInvocationUtil.unaryCall(invoker, method, request);

        fail();

    } <span class="hljs-keyword">catch</span> (Throwable t) {

        <span class="hljs-comment">// pass</span>

    }

    <span class="hljs-keyword">try</span> {

        StubInvocationUtil.unaryCall(invoker, method, request);

        fail();

    } <span class="hljs-keyword">catch</span> (Throwable t) {

        <span class="hljs-comment">// pass</span>

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MethodDescriptor <span class="hljs-title">createMockMethodDescriptor</span><span class="hljs-params">()</span> </span>{
    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;
    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);
    <span class="hljs-keyword">return</span> method;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest163">Test Case ID #dubbo_Test_16_3</h4>
<h4 id="test-case-name-testunarycallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>testUnaryCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-method">Mock Object Variable Name: <code>method</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(result.recreate()).thenReturn(response);
<span class="hljs-deletion">-    MethodDescriptor method = Mockito.mock(MethodDescriptor.class);</span>
<span class="hljs-deletion">-    when(method.getParameterClasses()).thenReturn(new Class[] { String.class });</span>
<span class="hljs-deletion">-    when(method.getMethodName()).thenReturn("sayHello");</span>
<span class="hljs-addition">+    MethodDescriptor method = createMockMethodDescriptor();</span>
    String request = "request";
    CountDownLatch latch = new CountDownLatch(1);
    AtomicReference&lt;Object&gt; atomicReference = new AtomicReference&lt;&gt;();
    StreamObserver&lt;Object&gt; responseObserver = new StreamObserver&lt;Object&gt;() {

</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testUnaryCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">then</span>(<span class="hljs-title">invocationOnMock</span> -&gt; <span class="hljs-title">result</span>)</span>;

    when(result.recreate()).thenReturn(response);

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    AtomicReference&lt;Object&gt; atomicReference = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    StreamObserver&lt;Object&gt; responseObserver = <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

            atomicReference.set(data);

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

            latch.countDown();

        }

    };

    StubInvocationUtil.unaryCall(invoker, method, request, responseObserver);

    latch.await(<span class="hljs-number">1</span>, TimeUnit.SECONDS);

    Assertions.assertEquals(response, atomicReference.get());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MethodDescriptor <span class="hljs-title">createMockMethodDescriptor</span><span class="hljs-params">()</span> </span>{
    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;
    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);
    <span class="hljs-keyword">return</span> method;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest164">Test Case ID #dubbo_Test_16_4</h4>
<h4 id="test-case-name-biorclientstreamcallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>biOrClientStreamCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-method">Mock Object Variable Name: <code>method</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    when(invoker.invoke(any(Invocation.class))).then(invocationOnMock -&gt; {
        Invocation invocation = (Invocation) invocationOnMock.getArguments()[0];
        StreamObserver&lt;Object&gt; observer = (StreamObserver&lt;Object&gt;) invocation.getArguments()[0];
        observer.onNext(response);
        observer.onCompleted();
        when(result.recreate()).then(invocationOnMock1 -&gt; new StreamObserver&lt;Object&gt;() {

            @Override
            public void onNext(Object data) {
                observer.onNext(data);
            }

            @Override
            public void onError(Throwable throwable) {
            }

            @Override
            public void onCompleted() {
                observer.onCompleted();
            }
        });
        return result;
    });
<span class="hljs-deletion">-    MethodDescriptor method = Mockito.mock(MethodDescriptor.class);</span>
<span class="hljs-deletion">-    when(method.getParameterClasses()).thenReturn(new Class[] { String.class });</span>
<span class="hljs-deletion">-    when(method.getMethodName()).thenReturn("sayHello");</span>
<span class="hljs-addition">+    MethodDescriptor method = createMockMethodDescriptor();</span>
    String request = "request";
    CountDownLatch latch = new CountDownLatch(11);
    StreamObserver&lt;Object&gt; responseObserver = new StreamObserver&lt;Object&gt;() {

        @Override
        public void onNext(Object data) {
            latch.countDown();
        }

        @Override
        public void onError(Throwable throwable) {
        }

        @Override
        public void onCompleted() {
            latch.countDown();
        }
    };
    StreamObserver&lt;Object&gt; observer = StubInvocationUtil.biOrClientStreamCall(invoker, method, responseObserver);
    for (int i = 0; i &lt; 10; i++) {
        observer.onNext(request);
    }
    observer.onCompleted();
    Assertions.assertTrue(latch.await(1, TimeUnit.SECONDS));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">biOrClientStreamCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">then</span>(<span class="hljs-title">invocationOnMock</span> -&gt; </span>{

        Invocation invocation = (Invocation) invocationOnMock.getArguments()[<span class="hljs-number">0</span>];

        StreamObserver&lt;Object&gt; observer = (StreamObserver&lt;Object&gt;) invocation.getArguments()[<span class="hljs-number">0</span>];

        observer.onNext(response);

        observer.onCompleted();

        when(result.recreate()).then(invocationOnMock1 -&gt; <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



            <span class="hljs-meta">@Override</span>

            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

                observer.onNext(data);

            }



            <span class="hljs-meta">@Override</span>

            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

            }



            <span class="hljs-meta">@Override</span>

            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

                observer.onCompleted();

            }

        });

        <span class="hljs-keyword">return</span> result;

    });

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">11</span>);

    StreamObserver&lt;Object&gt; responseObserver = <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

            latch.countDown();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

            latch.countDown();

        }

    };

    StreamObserver&lt;Object&gt; observer = StubInvocationUtil.biOrClientStreamCall(invoker, method, responseObserver);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {

        observer.onNext(request);

    }

    observer.onCompleted();

    Assertions.assertTrue(latch.await(<span class="hljs-number">1</span>, TimeUnit.SECONDS));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MethodDescriptor <span class="hljs-title">createMockMethodDescriptor</span><span class="hljs-params">()</span> </span>{
    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;
    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);
    <span class="hljs-keyword">return</span> method;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest165">Test Case ID #dubbo_Test_16_5</h4>
<h4 id="test-case-name-serverstreamcallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>serverStreamCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-method">Mock Object Variable Name: <code>method</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Result result = Mockito.mock(Result.class);
    String response = "response";
    when(invoker.invoke(any(Invocation.class))).then(invocationOnMock -&gt; {
        Invocation invocation = (Invocation) invocationOnMock.getArguments()[0];
        StreamObserver&lt;Object&gt; observer = (StreamObserver&lt;Object&gt;) invocation.getArguments()[1];
        for (int i = 0; i &lt; 10; i++) {
            observer.onNext(response);
        }
        observer.onCompleted();
        return result;
    });
<span class="hljs-deletion">-    MethodDescriptor method = Mockito.mock(MethodDescriptor.class);</span>
<span class="hljs-deletion">-    when(method.getParameterClasses()).thenReturn(new Class[] { String.class });</span>
<span class="hljs-deletion">-    when(method.getMethodName()).thenReturn("sayHello");</span>
<span class="hljs-addition">+    MethodDescriptor method = createMockMethodDescriptor();</span>
    String request = "request";
    CountDownLatch latch = new CountDownLatch(11);
    StreamObserver&lt;Object&gt; responseObserver = new StreamObserver&lt;Object&gt;() {

        @Override
        public void onNext(Object data) {
            latch.countDown();
        }

        @Override
        public void onError(Throwable throwable) {
        }

        @Override
        public void onCompleted() {
            latch.countDown();
        }
    };
    StubInvocationUtil.serverStreamCall(invoker, method, request, responseObserver);
    Assertions.assertTrue(latch.await(1, TimeUnit.SECONDS));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">serverStreamCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">then</span>(<span class="hljs-title">invocationOnMock</span> -&gt; </span>{

        Invocation invocation = (Invocation) invocationOnMock.getArguments()[<span class="hljs-number">0</span>];

        StreamObserver&lt;Object&gt; observer = (StreamObserver&lt;Object&gt;) invocation.getArguments()[<span class="hljs-number">1</span>];

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {

            observer.onNext(response);

        }

        observer.onCompleted();

        <span class="hljs-keyword">return</span> result;

    });

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">11</span>);

    StreamObserver&lt;Object&gt; responseObserver = <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

            latch.countDown();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

            latch.countDown();

        }

    };

    StubInvocationUtil.serverStreamCall(invoker, method, request, responseObserver);

    Assertions.assertTrue(latch.await(<span class="hljs-number">1</span>, TimeUnit.SECONDS));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MethodDescriptor <span class="hljs-title">createMockMethodDescriptor</span><span class="hljs-params">()</span> </span>{
    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;
    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);
    <span class="hljs-keyword">return</span> method;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci17">Mock Clone Instance #dubbo_MCI_17</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.cluster.router.mesh.route.MeshEnvListenerFactory</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MeshEnvListenerFactory <span class="hljs-title">createMockMeshEnvListenerFactory</span><span class="hljs-params">(MeshEnvListener meshEnvListener)</span> </span>{
    MeshEnvListenerFactory meshEnvListenerFactory = Mockito.mock(MeshEnvListenerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(meshEnvListenerFactory.getListener()).thenReturn(meshEnvListener);
    <span class="hljs-keyword">return</span> meshEnvListenerFactory;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest171">Test Case ID #dubbo_Test_17_1</h4>
<h4 id="test-case-name-testregister3file-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclusterroutermeshroutemeshrulemanagertestjava">Test Case Name: <code>testRegister3</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\router\mesh\route\MeshRuleManagerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-meshenvlistenerfactory1">Mock Object Variable Name: <code>meshEnvListenerFactory1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testRegister3() {
<span class="hljs-deletion">-    MeshEnvListenerFactory meshEnvListenerFactory1 = Mockito.mock(MeshEnvListenerFactory.class);</span>
     MeshEnvListenerFactory meshEnvListenerFactory2 = Mockito.mock(MeshEnvListenerFactory.class);
     MeshEnvListener meshEnvListener1 = Mockito.mock(MeshEnvListener.class);
<span class="hljs-addition">+    MeshEnvListenerFactory meshEnvListenerFactory1 = createMockMeshEnvListenerFactory(meshEnvListener1);</span>
     when(meshEnvListenerFactory2.getListener()).thenReturn(meshEnvListener2);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRegister3</span><span class="hljs-params">()</span> </span>{

    MeshEnvListenerFactory meshEnvListenerFactory1 = Mockito.mock(MeshEnvListenerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MeshEnvListenerFactory meshEnvListenerFactory2 = Mockito.mock(MeshEnvListenerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MeshEnvListener meshEnvListener1 = Mockito.mock(MeshEnvListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(meshEnvListenerFactory1.getListener()).thenReturn(meshEnvListener1);

    MeshEnvListener meshEnvListener2 = Mockito.mock(MeshEnvListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(meshEnvListenerFactory2.getListener()).thenReturn(meshEnvListener2);

    envListenerFactories.add(meshEnvListenerFactory1);

    envListenerFactories.add(meshEnvListenerFactory2);

    MeshRuleManager meshRuleManager = <span class="hljs-keyword">new</span> MeshRuleManager(moduleModel);

    MeshRuleListener meshRuleListener1 = <span class="hljs-keyword">new</span> MeshRuleListener() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onRuleChange</span><span class="hljs-params">(String appName, List&lt;Map&lt;String, Object&gt;&gt; rules)</span> </span>{

            fail();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clearRule</span><span class="hljs-params">(String appName)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">ruleSuffix</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-string">"Type1"</span>;

        }

    };

    when(meshEnvListener1.isEnable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(meshEnvListener2.isEnable()).thenReturn(<span class="hljs-keyword">true</span>);

    meshRuleManager.register(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener1);

    assertEquals(<span class="hljs-number">1</span>, meshRuleManager.getAppRuleListeners().size());

    verify(ruleRepository, times(<span class="hljs-number">1</span>)).getRule(<span class="hljs-string">"dubbo-demo.MESHAPPRULE"</span>, <span class="hljs-string">"dubbo"</span>, <span class="hljs-number">5000L</span>);

    MeshAppRuleListener meshAppRuleListener = meshRuleManager.getAppRuleListeners().values().iterator().next();

    verify(ruleRepository, times(<span class="hljs-number">1</span>)).addListener(<span class="hljs-string">"dubbo-demo.MESHAPPRULE"</span>, <span class="hljs-string">"dubbo"</span>, meshAppRuleListener);

    verify(meshEnvListener2, times(<span class="hljs-number">1</span>)).onSubscribe(<span class="hljs-string">"dubbo-demo"</span>, meshAppRuleListener);

    meshRuleManager.register(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener1);

    assertEquals(<span class="hljs-number">1</span>, meshRuleManager.getAppRuleListeners().size());

    MeshRuleListener meshRuleListener2 = <span class="hljs-keyword">new</span> MeshRuleListener() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onRuleChange</span><span class="hljs-params">(String appName, List&lt;Map&lt;String, Object&gt;&gt; rules)</span> </span>{

            fail();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clearRule</span><span class="hljs-params">(String appName)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">ruleSuffix</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-string">"Type2"</span>;

        }

    };

    meshRuleManager.register(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener2);

    assertEquals(<span class="hljs-number">1</span>, meshRuleManager.getAppRuleListeners().size());

    assertEquals(<span class="hljs-number">2</span>, meshAppRuleListener.getMeshRuleDispatcher().getListenerMap().size());

    meshRuleManager.unregister(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener1);

    assertEquals(<span class="hljs-number">1</span>, meshRuleManager.getAppRuleListeners().size());

    assertEquals(<span class="hljs-number">1</span>, meshAppRuleListener.getMeshRuleDispatcher().getListenerMap().size());

    meshRuleManager.unregister(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener2);

    assertEquals(<span class="hljs-number">0</span>, meshRuleManager.getAppRuleListeners().size());

    verify(ruleRepository, times(<span class="hljs-number">1</span>)).removeListener(<span class="hljs-string">"dubbo-demo.MESHAPPRULE"</span>, <span class="hljs-string">"dubbo"</span>, meshAppRuleListener);

    verify(meshEnvListener2, times(<span class="hljs-number">1</span>)).onUnSubscribe(<span class="hljs-string">"dubbo-demo"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MeshEnvListenerFactory <span class="hljs-title">createMockMeshEnvListenerFactory</span><span class="hljs-params">(MeshEnvListener meshEnvListener)</span> </span>{
    MeshEnvListenerFactory meshEnvListenerFactory = Mockito.mock(MeshEnvListenerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(meshEnvListenerFactory.getListener()).thenReturn(meshEnvListener);
    <span class="hljs-keyword">return</span> meshEnvListenerFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest172">Test Case ID #dubbo_Test_17_2</h4>
<h4 id="test-case-name-testregister3file-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclusterroutermeshroutemeshrulemanagertestjava">Test Case Name: <code>testRegister3</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\router\mesh\route\MeshRuleManagerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-meshenvlistenerfactory2">Mock Object Variable Name: <code>meshEnvListenerFactory2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    MeshEnvListenerFactory meshEnvListenerFactory1 = Mockito.mock(MeshEnvListenerFactory.class);
<span class="hljs-deletion">-    MeshEnvListenerFactory meshEnvListenerFactory2 = Mockito.mock(MeshEnvListenerFactory.class);</span>
    MeshEnvListener meshEnvListener1 = Mockito.mock(MeshEnvListener.class);
    when(meshEnvListenerFactory1.getListener()).thenReturn(meshEnvListener1);
    MeshEnvListener meshEnvListener2 = Mockito.mock(MeshEnvListener.class);
<span class="hljs-deletion">-    when(meshEnvListenerFactory2.getListener()).thenReturn(meshEnvListener2);</span>
<span class="hljs-addition">+    MeshEnvListenerFactory meshEnvListenerFactory2 = createMockMeshEnvListenerFactory(meshEnvListener2);</span>
    envListenerFactories.add(meshEnvListenerFactory1);
    envListenerFactories.add(meshEnvListenerFactory2);
    MeshRuleManager meshRuleManager = new MeshRuleManager(moduleModel);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRegister3</span><span class="hljs-params">()</span> </span>{

    MeshEnvListenerFactory meshEnvListenerFactory1 = Mockito.mock(MeshEnvListenerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MeshEnvListenerFactory meshEnvListenerFactory2 = Mockito.mock(MeshEnvListenerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MeshEnvListener meshEnvListener1 = Mockito.mock(MeshEnvListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(meshEnvListenerFactory1.getListener()).thenReturn(meshEnvListener1);

    MeshEnvListener meshEnvListener2 = Mockito.mock(MeshEnvListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(meshEnvListenerFactory2.getListener()).thenReturn(meshEnvListener2);

    envListenerFactories.add(meshEnvListenerFactory1);

    envListenerFactories.add(meshEnvListenerFactory2);

    MeshRuleManager meshRuleManager = <span class="hljs-keyword">new</span> MeshRuleManager(moduleModel);

    MeshRuleListener meshRuleListener1 = <span class="hljs-keyword">new</span> MeshRuleListener() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onRuleChange</span><span class="hljs-params">(String appName, List&lt;Map&lt;String, Object&gt;&gt; rules)</span> </span>{

            fail();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clearRule</span><span class="hljs-params">(String appName)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">ruleSuffix</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-string">"Type1"</span>;

        }

    };

    when(meshEnvListener1.isEnable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(meshEnvListener2.isEnable()).thenReturn(<span class="hljs-keyword">true</span>);

    meshRuleManager.register(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener1);

    assertEquals(<span class="hljs-number">1</span>, meshRuleManager.getAppRuleListeners().size());

    verify(ruleRepository, times(<span class="hljs-number">1</span>)).getRule(<span class="hljs-string">"dubbo-demo.MESHAPPRULE"</span>, <span class="hljs-string">"dubbo"</span>, <span class="hljs-number">5000L</span>);

    MeshAppRuleListener meshAppRuleListener = meshRuleManager.getAppRuleListeners().values().iterator().next();

    verify(ruleRepository, times(<span class="hljs-number">1</span>)).addListener(<span class="hljs-string">"dubbo-demo.MESHAPPRULE"</span>, <span class="hljs-string">"dubbo"</span>, meshAppRuleListener);

    verify(meshEnvListener2, times(<span class="hljs-number">1</span>)).onSubscribe(<span class="hljs-string">"dubbo-demo"</span>, meshAppRuleListener);

    meshRuleManager.register(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener1);

    assertEquals(<span class="hljs-number">1</span>, meshRuleManager.getAppRuleListeners().size());

    MeshRuleListener meshRuleListener2 = <span class="hljs-keyword">new</span> MeshRuleListener() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onRuleChange</span><span class="hljs-params">(String appName, List&lt;Map&lt;String, Object&gt;&gt; rules)</span> </span>{

            fail();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clearRule</span><span class="hljs-params">(String appName)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">ruleSuffix</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-string">"Type2"</span>;

        }

    };

    meshRuleManager.register(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener2);

    assertEquals(<span class="hljs-number">1</span>, meshRuleManager.getAppRuleListeners().size());

    assertEquals(<span class="hljs-number">2</span>, meshAppRuleListener.getMeshRuleDispatcher().getListenerMap().size());

    meshRuleManager.unregister(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener1);

    assertEquals(<span class="hljs-number">1</span>, meshRuleManager.getAppRuleListeners().size());

    assertEquals(<span class="hljs-number">1</span>, meshAppRuleListener.getMeshRuleDispatcher().getListenerMap().size());

    meshRuleManager.unregister(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener2);

    assertEquals(<span class="hljs-number">0</span>, meshRuleManager.getAppRuleListeners().size());

    verify(ruleRepository, times(<span class="hljs-number">1</span>)).removeListener(<span class="hljs-string">"dubbo-demo.MESHAPPRULE"</span>, <span class="hljs-string">"dubbo"</span>, meshAppRuleListener);

    verify(meshEnvListener2, times(<span class="hljs-number">1</span>)).onUnSubscribe(<span class="hljs-string">"dubbo-demo"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MeshEnvListenerFactory <span class="hljs-title">createMockMeshEnvListenerFactory</span><span class="hljs-params">(MeshEnvListener meshEnvListener)</span> </span>{
    MeshEnvListenerFactory meshEnvListenerFactory = Mockito.mock(MeshEnvListenerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(meshEnvListenerFactory.getListener()).thenReturn(meshEnvListener);
    <span class="hljs-keyword">return</span> meshEnvListenerFactory;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci18">Mock Clone Instance #dubbo_MCI_18</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.registry.client.ServiceDiscovery</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockServiceDiscovery</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock ServiceDiscovery with standard stubbing for getRemoteMetadata and getUrl.
     * <span class="hljs-doctag">@param</span> registryURL the URL to return from getUrl()
     * <span class="hljs-doctag">@param</span> metadataInfo_111 MetadataInfo for revision "111"
     * <span class="hljs-doctag">@param</span> metadataInfo_222 MetadataInfo for revision "222"
     * <span class="hljs-doctag">@param</span> metadataInfo_333 MetadataInfo for revision "333"
     * <span class="hljs-doctag">@param</span> metadataInfo_555_tri MetadataInfo for revision "555"
     * <span class="hljs-doctag">@param</span> answer222 Answer&lt;MetadataInfo&gt; for getRemoteMetadata("222", ...)
     * <span class="hljs-doctag">@return</span> configured mock ServiceDiscovery
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ServiceDiscovery <span class="hljs-title">createMockServiceDiscovery</span><span class="hljs-params">(
            URL registryURL,
            MetadataInfo metadataInfo_111,
            MetadataInfo metadataInfo_222,
            MetadataInfo metadataInfo_333,
            MetadataInfo metadataInfo_555_tri,
            org.mockito.stubbing.Answer&lt;MetadataInfo&gt; answer222)</span> </span>{
        ServiceDiscovery serviceDiscovery = Mockito.mock(ServiceDiscovery<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(serviceDiscovery.getUrl()).thenReturn(registryURL);
        when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"111"</span>), anyList())).thenReturn(metadataInfo_111);
        when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"222"</span>), anyList())).thenReturn(metadataInfo_222);
        when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"333"</span>), anyList())).thenReturn(metadataInfo_333);
        when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"444"</span>), anyList())).thenReturn(MetadataInfo.EMPTY);
        when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"555"</span>), anyList())).thenReturn(metadataInfo_555_tri);
        when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"222"</span>), anyList())).thenAnswer(answer222);
        <span class="hljs-keyword">return</span> serviceDiscovery;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest181">Test Case ID #dubbo_Test_18_1</h4>
<h4 id="test-case-name-testrevisionfailureonnotificationfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenertestjava">Test Case Name: <code>testRevisionFailureOnNotification</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-servicediscovery">Mock Object Variable Name: <code>serviceDiscovery</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- Original.java</span>
<span class="hljs-comment">+++ Refactored.java</span>
@@
    @BeforeAll
    public static void setUp() {
        metadataService = Mockito.mock(MetadataService.class);
        List&lt;Object&gt; urlsSameRevision = new ArrayList&lt;&gt;();
        urlsSameRevision.add("127.0.0.1:20880?revision=111");
        urlsSameRevision.add("127.0.0.2:20880?revision=111");
        urlsSameRevision.add("127.0.0.3:20880?revision=111");
        List&lt;Object&gt; urlsDifferentRevision = new ArrayList&lt;&gt;();
        urlsDifferentRevision.add("30.10.0.1:20880?revision=222");
        urlsDifferentRevision.add("30.10.0.2:20880?revision=222");
        urlsDifferentRevision.add("30.10.0.3:20880?revision=333");
        urlsDifferentRevision.add("30.10.0.4:20880?revision=333");
        List&lt;Object&gt; urlsFailedRevision = new ArrayList&lt;&gt;();
        urlsFailedRevision.add("30.10.0.5:20880?revision=222");
        urlsFailedRevision.add("30.10.0.6:20880?revision=222");
        // revision will fail
        urlsFailedRevision.add("30.10.0.7:20880?revision=444");
        // revision will fail
        urlsFailedRevision.add("30.10.0.8:20880?revision=444");
        List&lt;Object&gt; urlsFailedRevision2 = new ArrayList&lt;&gt;();
        urlsFailedRevision2.add("30.10.0.1:20880?revision=222");
        urlsFailedRevision2.add("30.10.0.2:20880?revision=222");
        List&lt;Object&gt; urlsWithoutRevision = new ArrayList&lt;&gt;();
        urlsWithoutRevision.add("30.10.0.1:20880");
        List&lt;Object&gt; urlsMultipleProtocols = new ArrayList&lt;&gt;();
        //triple
        urlsMultipleProtocols.add("30.10.0.1:20880?revision=555");
        // dubbo
        urlsMultipleProtocols.addAll(urlsSameRevision);
        app1Instances = buildInstances(urlsSameRevision);
        app2Instances = buildInstances(urlsDifferentRevision);
        app1FailedInstances = buildInstances(urlsFailedRevision);
        app1FailedInstances2 = buildInstances(urlsFailedRevision2);
        app1InstancesWithNoRevision = buildInstances(urlsWithoutRevision);
        app1InstancesMultipleProtocols = buildInstances(urlsMultipleProtocols);
        metadataInfo_111 = JsonUtils.toJavaObject(metadata_111, MetadataInfo.class);
        metadataInfo_222 = JsonUtils.toJavaObject(metadata_222, MetadataInfo.class);
        metadataInfo_333 = JsonUtils.toJavaObject(metadata_333, MetadataInfo.class);
        metadataInfo_444 = JsonUtils.toJavaObject(metadata_444, MetadataInfo.class);
        metadataInfo_555_tri = JsonUtils.toJavaObject(metadata_555_triple, MetadataInfo.class);
<span class="hljs-deletion">-        serviceDiscovery = Mockito.mock(ServiceDiscovery.class);</span>
<span class="hljs-deletion">-        when(serviceDiscovery.getUrl()).thenReturn(registryURL);</span>
<span class="hljs-deletion">-        when(serviceDiscovery.getRemoteMetadata(eq("111"), anyList())).thenReturn(metadataInfo_111);</span>
<span class="hljs-deletion">-        when(serviceDiscovery.getRemoteMetadata(eq("222"), anyList())).thenReturn(metadataInfo_222);</span>
<span class="hljs-deletion">-        when(serviceDiscovery.getRemoteMetadata(eq("333"), anyList())).thenReturn(metadataInfo_333);</span>
<span class="hljs-deletion">-        when(serviceDiscovery.getRemoteMetadata(eq("444"), anyList())).thenReturn(MetadataInfo.EMPTY);</span>
<span class="hljs-deletion">-        when(serviceDiscovery.getRemoteMetadata(eq("555"), anyList())).thenReturn(metadataInfo_555_tri);</span>
    }

    // revision revisionrevision
    @Test
    @Order(11)
    public void testRevisionFailureOnNotification() {
        Set&lt;String&gt; serviceNames = new HashSet&lt;&gt;();
        serviceNames.add("app1");
        serviceNames.add("app2");
<span class="hljs-addition">+        serviceDiscovery = MockServiceDiscovery.createMockServiceDiscovery(</span>
<span class="hljs-addition">+            registryURL,</span>
<span class="hljs-addition">+            metadataInfo_111,</span>
<span class="hljs-addition">+            metadataInfo_222,</span>
<span class="hljs-addition">+            metadataInfo_333,</span>
<span class="hljs-addition">+            metadataInfo_555_tri,</span>
<span class="hljs-addition">+            new Answer&lt;MetadataInfo&gt;() {</span>
<span class="hljs-addition">+                @Override</span>
<span class="hljs-addition">+                public MetadataInfo answer(InvocationOnMock invocationOnMock) throws Throwable {</span>
<span class="hljs-addition">+                    if (Thread.currentThread().getName().contains("Dubbo-framework-metadata-retry")) {</span>
<span class="hljs-addition">+                        return metadataInfo_222;</span>
<span class="hljs-addition">+                    }</span>
<span class="hljs-addition">+                    return MetadataInfo.EMPTY;</span>
<span class="hljs-addition">+                }</span>
<span class="hljs-addition">+            }</span>
<span class="hljs-addition">+        );</span>
        listener = new ServiceInstancesChangedListener(serviceNames, serviceDiscovery);
        // notify app1 instance change
        ServiceInstancesChangedEvent event = new ServiceInstancesChangedEvent("app1", app1Instances);
        listener.onEvent(event);
<span class="hljs-deletion">-        when(serviceDiscovery.getRemoteMetadata(eq("222"), anyList())).thenAnswer(new Answer&lt;MetadataInfo&gt;() {</span>
<span class="hljs-deletion">-</span>
<span class="hljs-deletion">-            @Override</span>
<span class="hljs-deletion">-            public MetadataInfo answer(InvocationOnMock invocationOnMock) throws Throwable {</span>
<span class="hljs-deletion">-                if (Thread.currentThread().getName().contains("Dubbo-framework-metadata-retry")) {</span>
<span class="hljs-deletion">-                    return metadataInfo_222;</span>
<span class="hljs-deletion">-                }</span>
<span class="hljs-deletion">-                return MetadataInfo.EMPTY;</span>
<span class="hljs-deletion">-            }</span>
<span class="hljs-deletion">-        });</span>
        ServiceInstancesChangedEvent event2 = new ServiceInstancesChangedEvent("app2", app1FailedInstances2);
        listener.onEvent(event2);
        // event2 did not really take effect
        ProtocolServiceKey protocolServiceKey1 = new ProtocolServiceKey(service1, null, null, "dubbo");
        ProtocolServiceKey protocolServiceKey2 = new ProtocolServiceKey(service2, null, null, "dubbo");
        Assertions.assertEquals(3, listener.getAddresses(protocolServiceKey1, consumerURL).size());
        assertTrue(isEmpty(listener.getAddresses(protocolServiceKey2, consumerURL)));
        //
        init();
        try {
            Thread.sleep(15000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        // check recovered after retry.
        List&lt;URL&gt; serviceUrls_after_retry = listener.getAddresses(protocolServiceKey1, consumerURL);
        Assertions.assertEquals(5, serviceUrls_after_retry.size());
        List&lt;URL&gt; serviceUrls2_after_retry = listener.getAddresses(protocolServiceKey2, consumerURL);
        Assertions.assertEquals(2, serviceUrls2_after_retry.size());
    }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeAll</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{

    metadataService = Mockito.mock(MetadataService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;Object&gt; urlsSameRevision = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsSameRevision.add(<span class="hljs-string">"127.0.0.1:20880?revision=111"</span>);

    urlsSameRevision.add(<span class="hljs-string">"127.0.0.2:20880?revision=111"</span>);

    urlsSameRevision.add(<span class="hljs-string">"127.0.0.3:20880?revision=111"</span>);

    List&lt;Object&gt; urlsDifferentRevision = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsDifferentRevision.add(<span class="hljs-string">"30.10.0.1:20880?revision=222"</span>);

    urlsDifferentRevision.add(<span class="hljs-string">"30.10.0.2:20880?revision=222"</span>);

    urlsDifferentRevision.add(<span class="hljs-string">"30.10.0.3:20880?revision=333"</span>);

    urlsDifferentRevision.add(<span class="hljs-string">"30.10.0.4:20880?revision=333"</span>);

    List&lt;Object&gt; urlsFailedRevision = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsFailedRevision.add(<span class="hljs-string">"30.10.0.5:20880?revision=222"</span>);

    urlsFailedRevision.add(<span class="hljs-string">"30.10.0.6:20880?revision=222"</span>);

    <span class="hljs-comment">// revision will fail</span>

    urlsFailedRevision.add(<span class="hljs-string">"30.10.0.7:20880?revision=444"</span>);

    <span class="hljs-comment">// revision will fail</span>

    urlsFailedRevision.add(<span class="hljs-string">"30.10.0.8:20880?revision=444"</span>);

    List&lt;Object&gt; urlsFailedRevision2 = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsFailedRevision2.add(<span class="hljs-string">"30.10.0.1:20880?revision=222"</span>);

    urlsFailedRevision2.add(<span class="hljs-string">"30.10.0.2:20880?revision=222"</span>);

    List&lt;Object&gt; urlsWithoutRevision = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsWithoutRevision.add(<span class="hljs-string">"30.10.0.1:20880"</span>);

    List&lt;Object&gt; urlsMultipleProtocols = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-comment">//triple</span>

    urlsMultipleProtocols.add(<span class="hljs-string">"30.10.0.1:20880?revision=555"</span>);

    <span class="hljs-comment">// dubbo</span>

    urlsMultipleProtocols.addAll(urlsSameRevision);

    app1Instances = buildInstances(urlsSameRevision);

    app2Instances = buildInstances(urlsDifferentRevision);

    app1FailedInstances = buildInstances(urlsFailedRevision);

    app1FailedInstances2 = buildInstances(urlsFailedRevision2);

    app1InstancesWithNoRevision = buildInstances(urlsWithoutRevision);

    app1InstancesMultipleProtocols = buildInstances(urlsMultipleProtocols);

    metadataInfo_111 = JsonUtils.toJavaObject(metadata_111, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    metadataInfo_222 = JsonUtils.toJavaObject(metadata_222, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    metadataInfo_333 = JsonUtils.toJavaObject(metadata_333, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    metadataInfo_444 = JsonUtils.toJavaObject(metadata_444, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    metadataInfo_555_tri = JsonUtils.toJavaObject(metadata_555_triple, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    serviceDiscovery = Mockito.mock(ServiceDiscovery<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(serviceDiscovery.getUrl()).thenReturn(registryURL);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"111"</span>), anyList())).thenReturn(metadataInfo_111);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"222"</span>), anyList())).thenReturn(metadataInfo_222);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"333"</span>), anyList())).thenReturn(metadataInfo_333);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"444"</span>), anyList())).thenReturn(MetadataInfo.EMPTY);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"555"</span>), anyList())).thenReturn(metadataInfo_555_tri);

}
<span class="hljs-comment">// revision revisionrevision</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">11</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRevisionFailureOnNotification</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    serviceNames.add(<span class="hljs-string">"app2"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1Instances);

    listener.onEvent(event);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"222"</span>), anyList())).thenAnswer(<span class="hljs-keyword">new</span> Answer&lt;MetadataInfo&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> MetadataInfo <span class="hljs-title">answer</span><span class="hljs-params">(InvocationOnMock invocationOnMock)</span> <span class="hljs-keyword">throws</span> Throwable </span>{

            <span class="hljs-keyword">if</span> (Thread.currentThread().getName().contains(<span class="hljs-string">"Dubbo-framework-metadata-retry"</span>)) {

                <span class="hljs-keyword">return</span> metadataInfo_222;

            }

            <span class="hljs-keyword">return</span> MetadataInfo.EMPTY;

        }

    });

    ServiceInstancesChangedEvent event2 = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app2"</span>, app1FailedInstances2);

    listener.onEvent(event2);

    <span class="hljs-comment">// event2 did not really take effect</span>

    ProtocolServiceKey protocolServiceKey1 = <span class="hljs-keyword">new</span> ProtocolServiceKey(service1, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"dubbo"</span>);

    ProtocolServiceKey protocolServiceKey2 = <span class="hljs-keyword">new</span> ProtocolServiceKey(service2, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"dubbo"</span>);

    Assertions.assertEquals(<span class="hljs-number">3</span>, listener.getAddresses(protocolServiceKey1, consumerURL).size());

    assertTrue(isEmpty(listener.getAddresses(protocolServiceKey2, consumerURL)));

    <span class="hljs-comment">//</span>

    init();

    <span class="hljs-keyword">try</span> {

        Thread.sleep(<span class="hljs-number">15000</span>);

    } <span class="hljs-keyword">catch</span> (InterruptedException e) {

        e.printStackTrace();

    }

    <span class="hljs-comment">// check recovered after retry.</span>

    List&lt;URL&gt; serviceUrls_after_retry = listener.getAddresses(protocolServiceKey1, consumerURL);

    Assertions.assertEquals(<span class="hljs-number">5</span>, serviceUrls_after_retry.size());

    List&lt;URL&gt; serviceUrls2_after_retry = listener.getAddresses(protocolServiceKey2, consumerURL);

    Assertions.assertEquals(<span class="hljs-number">2</span>, serviceUrls2_after_retry.size());

}
<span class="hljs-meta">@AfterAll</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">destroy</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    serviceDiscovery.destroy();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockServiceDiscovery</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock ServiceDiscovery with standard stubbing for getRemoteMetadata and getUrl.
     * <span class="hljs-doctag">@param</span> registryURL the URL to return from getUrl()
     * <span class="hljs-doctag">@param</span> metadataInfo_111 MetadataInfo for revision "111"
     * <span class="hljs-doctag">@param</span> metadataInfo_222 MetadataInfo for revision "222"
     * <span class="hljs-doctag">@param</span> metadataInfo_333 MetadataInfo for revision "333"
     * <span class="hljs-doctag">@param</span> metadataInfo_555_tri MetadataInfo for revision "555"
     * <span class="hljs-doctag">@param</span> answer222 Answer&lt;MetadataInfo&gt; for getRemoteMetadata("222", ...)
     * <span class="hljs-doctag">@return</span> configured mock ServiceDiscovery
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ServiceDiscovery <span class="hljs-title">createMockServiceDiscovery</span><span class="hljs-params">(
            URL registryURL,
            MetadataInfo metadataInfo_111,
            MetadataInfo metadataInfo_222,
            MetadataInfo metadataInfo_333,
            MetadataInfo metadataInfo_555_tri,
            org.mockito.stubbing.Answer&lt;MetadataInfo&gt; answer222)</span> </span>{
        ServiceDiscovery serviceDiscovery = Mockito.mock(ServiceDiscovery<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(serviceDiscovery.getUrl()).thenReturn(registryURL);
        when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"111"</span>), anyList())).thenReturn(metadataInfo_111);
        when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"222"</span>), anyList())).thenReturn(metadataInfo_222);
        when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"333"</span>), anyList())).thenReturn(metadataInfo_333);
        when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"444"</span>), anyList())).thenReturn(MetadataInfo.EMPTY);
        when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"555"</span>), anyList())).thenReturn(metadataInfo_555_tri);
        when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"222"</span>), anyList())).thenAnswer(answer222);
        <span class="hljs-keyword">return</span> serviceDiscovery;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest182">Test Case ID #dubbo_Test_18_2</h4>
<h4 id="test-case-name-testrevisionfailureonnotificationfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenerwithoutemptyprotecttestjava">Test Case Name: <code>testRevisionFailureOnNotification</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerWithoutEmptyProtectTest.java</code>)</h4>
<h4 id="mock-object-variable-name-servicediscovery">Mock Object Variable Name: <code>serviceDiscovery</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- Original.java</span>
<span class="hljs-comment">+++ Refactored.java</span>
@@
    @BeforeAll
    public static void setUp() {
        metadataService = Mockito.mock(MetadataService.class);
        List&lt;Object&gt; urlsSameRevision = new ArrayList&lt;&gt;();
        urlsSameRevision.add("127.0.0.1:20880?revision=111");
        urlsSameRevision.add("127.0.0.2:20880?revision=111");
        urlsSameRevision.add("127.0.0.3:20880?revision=111");
        List&lt;Object&gt; urlsDifferentRevision = new ArrayList&lt;&gt;();
        urlsDifferentRevision.add("30.10.0.1:20880?revision=222");
        urlsDifferentRevision.add("30.10.0.2:20880?revision=222");
        urlsDifferentRevision.add("30.10.0.3:20880?revision=333");
        urlsDifferentRevision.add("30.10.0.4:20880?revision=333");
        List&lt;Object&gt; urlsFailedRevision = new ArrayList&lt;&gt;();
        urlsFailedRevision.add("30.10.0.5:20880?revision=222");
        urlsFailedRevision.add("30.10.0.6:20880?revision=222");
        // revision will fail
        urlsFailedRevision.add("30.10.0.7:20880?revision=444");
        // revision will fail
        urlsFailedRevision.add("30.10.0.8:20880?revision=444");
        List&lt;Object&gt; urlsFailedRevision2 = new ArrayList&lt;&gt;();
        urlsFailedRevision2.add("30.10.0.1:20880?revision=222");
        urlsFailedRevision2.add("30.10.0.2:20880?revision=222");
        List&lt;Object&gt; urlsWithoutRevision = new ArrayList&lt;&gt;();
        urlsWithoutRevision.add("30.10.0.1:20880");
        List&lt;Object&gt; urlsMultipleProtocols = new ArrayList&lt;&gt;();
        //triple
        urlsMultipleProtocols.add("30.10.0.1:20880?revision=555");
        // dubbo
        urlsMultipleProtocols.addAll(urlsSameRevision);
        app1Instances = buildInstances(urlsSameRevision);
        app2Instances = buildInstances(urlsDifferentRevision);
        app1FailedInstances = buildInstances(urlsFailedRevision);
        app1FailedInstances2 = buildInstances(urlsFailedRevision2);
        app1InstancesWithNoRevision = buildInstances(urlsWithoutRevision);
        app1InstancesMultipleProtocols = buildInstances(urlsMultipleProtocols);
        metadataInfo_111 = JsonUtils.toJavaObject(metadata_111, MetadataInfo.class);
        metadataInfo_222 = JsonUtils.toJavaObject(metadata_222, MetadataInfo.class);
        metadataInfo_333 = JsonUtils.toJavaObject(metadata_333, MetadataInfo.class);
        metadataInfo_444 = JsonUtils.toJavaObject(metadata_444, MetadataInfo.class);
        metadataInfo_555_tri = JsonUtils.toJavaObject(metadata_555_triple, MetadataInfo.class);
<span class="hljs-deletion">-        serviceDiscovery = Mockito.mock(ServiceDiscovery.class);</span>
<span class="hljs-deletion">-        when(serviceDiscovery.getUrl()).thenReturn(registryURL);</span>
<span class="hljs-deletion">-        when(serviceDiscovery.getRemoteMetadata(eq("111"), anyList())).thenReturn(metadataInfo_111);</span>
<span class="hljs-deletion">-        when(serviceDiscovery.getRemoteMetadata(eq("222"), anyList())).thenReturn(metadataInfo_222);</span>
<span class="hljs-deletion">-        when(serviceDiscovery.getRemoteMetadata(eq("333"), anyList())).thenReturn(metadataInfo_333);</span>
<span class="hljs-deletion">-        when(serviceDiscovery.getRemoteMetadata(eq("444"), anyList())).thenReturn(MetadataInfo.EMPTY);</span>
<span class="hljs-deletion">-        when(serviceDiscovery.getRemoteMetadata(eq("555"), anyList())).thenReturn(metadataInfo_555_tri);</span>
    }

    // revision revisionrevision
    @Test
    @Order(11)
    public void testRevisionFailureOnNotification() {
        Set&lt;String&gt; serviceNames = new HashSet&lt;&gt;();
        serviceNames.add("app1");
        serviceNames.add("app2");
<span class="hljs-addition">+        org.mockito.stubbing.Answer&lt;MetadataInfo&gt; answer222 = new Answer&lt;MetadataInfo&gt;() {</span>
<span class="hljs-addition">+            @Override</span>
<span class="hljs-addition">+            public MetadataInfo answer(InvocationOnMock invocationOnMock) throws Throwable {</span>
<span class="hljs-addition">+                if (Thread.currentThread().getName().contains("Dubbo-framework-metadata-retry")) {</span>
<span class="hljs-addition">+                    return metadataInfo_222;</span>
<span class="hljs-addition">+                }</span>
<span class="hljs-addition">+                return MetadataInfo.EMPTY;</span>
<span class="hljs-addition">+            }</span>
<span class="hljs-addition">+        };</span>
<span class="hljs-addition">+        serviceDiscovery = MockServiceDiscovery.createMockServiceDiscovery(</span>
<span class="hljs-addition">+            registryURL,</span>
<span class="hljs-addition">+            metadataInfo_111,</span>
<span class="hljs-addition">+            metadataInfo_222,</span>
<span class="hljs-addition">+            metadataInfo_333,</span>
<span class="hljs-addition">+            metadataInfo_555_tri,</span>
<span class="hljs-addition">+            answer222</span>
<span class="hljs-addition">+        );</span>
        listener = new ServiceInstancesChangedListener(serviceNames, serviceDiscovery);
        // notify app1 instance change
        ServiceInstancesChangedEvent event = new ServiceInstancesChangedEvent("app1", app1Instances);
        listener.onEvent(event);
<span class="hljs-deletion">-        when(serviceDiscovery.getRemoteMetadata(eq("222"), anyList())).thenAnswer(new Answer&lt;MetadataInfo&gt;() {</span>
<span class="hljs-deletion">-</span>
<span class="hljs-deletion">-            @Override</span>
<span class="hljs-deletion">-            public MetadataInfo answer(InvocationOnMock invocationOnMock) throws Throwable {</span>
<span class="hljs-deletion">-                if (Thread.currentThread().getName().contains("Dubbo-framework-metadata-retry")) {</span>
<span class="hljs-deletion">-                    return metadataInfo_222;</span>
<span class="hljs-deletion">-                }</span>
<span class="hljs-deletion">-                return MetadataInfo.EMPTY;</span>
<span class="hljs-deletion">-            }</span>
<span class="hljs-deletion">-        });</span>
        ServiceInstancesChangedEvent event2 = new ServiceInstancesChangedEvent("app2", app1FailedInstances2);
        listener.onEvent(event2);
        // event2 did not really take effect
        ProtocolServiceKey protocolServiceKey1 = new ProtocolServiceKey(service1, null, null, "dubbo");
        ProtocolServiceKey protocolServiceKey2 = new ProtocolServiceKey(service2, null, null, "dubbo");
        Assertions.assertEquals(3, listener.getAddresses(protocolServiceKey1, consumerURL).size());
        assertTrue(isEmpty(listener.getAddresses(protocolServiceKey2, consumerURL)));
        //
        init();
        try {
            Thread.sleep(15000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        // check recovered after retry.
        List&lt;URL&gt; serviceUrls_after_retry = listener.getAddresses(protocolServiceKey1, consumerURL);
        Assertions.assertEquals(5, serviceUrls_after_retry.size());
        List&lt;URL&gt; serviceUrls2_after_retry = listener.getAddresses(protocolServiceKey2, consumerURL);
        Assertions.assertEquals(2, serviceUrls2_after_retry.size());
    }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeAll</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{

    metadataService = Mockito.mock(MetadataService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;Object&gt; urlsSameRevision = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsSameRevision.add(<span class="hljs-string">"127.0.0.1:20880?revision=111"</span>);

    urlsSameRevision.add(<span class="hljs-string">"127.0.0.2:20880?revision=111"</span>);

    urlsSameRevision.add(<span class="hljs-string">"127.0.0.3:20880?revision=111"</span>);

    List&lt;Object&gt; urlsDifferentRevision = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsDifferentRevision.add(<span class="hljs-string">"30.10.0.1:20880?revision=222"</span>);

    urlsDifferentRevision.add(<span class="hljs-string">"30.10.0.2:20880?revision=222"</span>);

    urlsDifferentRevision.add(<span class="hljs-string">"30.10.0.3:20880?revision=333"</span>);

    urlsDifferentRevision.add(<span class="hljs-string">"30.10.0.4:20880?revision=333"</span>);

    List&lt;Object&gt; urlsFailedRevision = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsFailedRevision.add(<span class="hljs-string">"30.10.0.5:20880?revision=222"</span>);

    urlsFailedRevision.add(<span class="hljs-string">"30.10.0.6:20880?revision=222"</span>);

    <span class="hljs-comment">// revision will fail</span>

    urlsFailedRevision.add(<span class="hljs-string">"30.10.0.7:20880?revision=444"</span>);

    <span class="hljs-comment">// revision will fail</span>

    urlsFailedRevision.add(<span class="hljs-string">"30.10.0.8:20880?revision=444"</span>);

    List&lt;Object&gt; urlsFailedRevision2 = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsFailedRevision2.add(<span class="hljs-string">"30.10.0.1:20880?revision=222"</span>);

    urlsFailedRevision2.add(<span class="hljs-string">"30.10.0.2:20880?revision=222"</span>);

    List&lt;Object&gt; urlsWithoutRevision = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsWithoutRevision.add(<span class="hljs-string">"30.10.0.1:20880"</span>);

    List&lt;Object&gt; urlsMultipleProtocols = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-comment">//triple</span>

    urlsMultipleProtocols.add(<span class="hljs-string">"30.10.0.1:20880?revision=555"</span>);

    <span class="hljs-comment">// dubbo</span>

    urlsMultipleProtocols.addAll(urlsSameRevision);

    app1Instances = buildInstances(urlsSameRevision);

    app2Instances = buildInstances(urlsDifferentRevision);

    app1FailedInstances = buildInstances(urlsFailedRevision);

    app1FailedInstances2 = buildInstances(urlsFailedRevision2);

    app1InstancesWithNoRevision = buildInstances(urlsWithoutRevision);

    app1InstancesMultipleProtocols = buildInstances(urlsMultipleProtocols);

    metadataInfo_111 = JsonUtils.toJavaObject(metadata_111, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    metadataInfo_222 = JsonUtils.toJavaObject(metadata_222, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    metadataInfo_333 = JsonUtils.toJavaObject(metadata_333, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    metadataInfo_444 = JsonUtils.toJavaObject(metadata_444, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    metadataInfo_555_tri = JsonUtils.toJavaObject(metadata_555_triple, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    serviceDiscovery = Mockito.mock(ServiceDiscovery<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(serviceDiscovery.getUrl()).thenReturn(registryURL);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"111"</span>), anyList())).thenReturn(metadataInfo_111);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"222"</span>), anyList())).thenReturn(metadataInfo_222);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"333"</span>), anyList())).thenReturn(metadataInfo_333);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"444"</span>), anyList())).thenReturn(MetadataInfo.EMPTY);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"555"</span>), anyList())).thenReturn(metadataInfo_555_tri);

}
<span class="hljs-comment">// revision revisionrevision</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">11</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRevisionFailureOnNotification</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    serviceNames.add(<span class="hljs-string">"app2"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1Instances);

    listener.onEvent(event);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"222"</span>), anyList())).thenAnswer(<span class="hljs-keyword">new</span> Answer&lt;MetadataInfo&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> MetadataInfo <span class="hljs-title">answer</span><span class="hljs-params">(InvocationOnMock invocationOnMock)</span> <span class="hljs-keyword">throws</span> Throwable </span>{

            <span class="hljs-keyword">if</span> (Thread.currentThread().getName().contains(<span class="hljs-string">"Dubbo-framework-metadata-retry"</span>)) {

                <span class="hljs-keyword">return</span> metadataInfo_222;

            }

            <span class="hljs-keyword">return</span> MetadataInfo.EMPTY;

        }

    });

    ServiceInstancesChangedEvent event2 = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app2"</span>, app1FailedInstances2);

    listener.onEvent(event2);

    <span class="hljs-comment">// event2 did not really take effect</span>

    ProtocolServiceKey protocolServiceKey1 = <span class="hljs-keyword">new</span> ProtocolServiceKey(service1, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"dubbo"</span>);

    ProtocolServiceKey protocolServiceKey2 = <span class="hljs-keyword">new</span> ProtocolServiceKey(service2, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"dubbo"</span>);

    Assertions.assertEquals(<span class="hljs-number">3</span>, listener.getAddresses(protocolServiceKey1, consumerURL).size());

    assertTrue(isEmpty(listener.getAddresses(protocolServiceKey2, consumerURL)));

    <span class="hljs-comment">//</span>

    init();

    <span class="hljs-keyword">try</span> {

        Thread.sleep(<span class="hljs-number">15000</span>);

    } <span class="hljs-keyword">catch</span> (InterruptedException e) {

        e.printStackTrace();

    }

    <span class="hljs-comment">// check recovered after retry.</span>

    List&lt;URL&gt; serviceUrls_after_retry = listener.getAddresses(protocolServiceKey1, consumerURL);

    Assertions.assertEquals(<span class="hljs-number">5</span>, serviceUrls_after_retry.size());

    List&lt;URL&gt; serviceUrls2_after_retry = listener.getAddresses(protocolServiceKey2, consumerURL);

    Assertions.assertEquals(<span class="hljs-number">2</span>, serviceUrls2_after_retry.size());

}
<span class="hljs-meta">@AfterAll</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">destroy</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    serviceDiscovery.destroy();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockServiceDiscovery</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock ServiceDiscovery with standard stubbing for getRemoteMetadata and getUrl.
     * <span class="hljs-doctag">@param</span> registryURL the URL to return from getUrl()
     * <span class="hljs-doctag">@param</span> metadataInfo_111 MetadataInfo for revision "111"
     * <span class="hljs-doctag">@param</span> metadataInfo_222 MetadataInfo for revision "222"
     * <span class="hljs-doctag">@param</span> metadataInfo_333 MetadataInfo for revision "333"
     * <span class="hljs-doctag">@param</span> metadataInfo_555_tri MetadataInfo for revision "555"
     * <span class="hljs-doctag">@param</span> answer222 Answer&lt;MetadataInfo&gt; for getRemoteMetadata("222", ...)
     * <span class="hljs-doctag">@return</span> configured mock ServiceDiscovery
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ServiceDiscovery <span class="hljs-title">createMockServiceDiscovery</span><span class="hljs-params">(
            URL registryURL,
            MetadataInfo metadataInfo_111,
            MetadataInfo metadataInfo_222,
            MetadataInfo metadataInfo_333,
            MetadataInfo metadataInfo_555_tri,
            org.mockito.stubbing.Answer&lt;MetadataInfo&gt; answer222)</span> </span>{
        ServiceDiscovery serviceDiscovery = Mockito.mock(ServiceDiscovery<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(serviceDiscovery.getUrl()).thenReturn(registryURL);
        when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"111"</span>), anyList())).thenReturn(metadataInfo_111);
        when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"222"</span>), anyList())).thenReturn(metadataInfo_222);
        when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"333"</span>), anyList())).thenReturn(metadataInfo_333);
        when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"444"</span>), anyList())).thenReturn(MetadataInfo.EMPTY);
        when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"555"</span>), anyList())).thenReturn(metadataInfo_555_tri);
        when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"222"</span>), anyList())).thenAnswer(answer222);
        <span class="hljs-keyword">return</span> serviceDiscovery;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci19">Mock Clone Instance #dubbo_MCI_19</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.metadata.MetadataService</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockMetadataService</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MetadataService <span class="hljs-title">createMockMetadataService</span><span class="hljs-params">()</span> </span>{
        MetadataService metadataService = Mockito.mock(MetadataService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        Mockito.doReturn(<span class="hljs-keyword">null</span>).when(metadataService).getMetadataInfo(org.mockito.ArgumentMatchers.eq(<span class="hljs-keyword">null</span>));
        <span class="hljs-keyword">return</span> metadataService;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest191">Test Case ID #dubbo_Test_19_1</h4>
<h4 id="test-case-name-testinstancewithoutrevisionfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenertestjava">Test Case Name: <code>testInstanceWithoutRevision</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-metadataservice">Mock Object Variable Name: <code>metadataService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- Original</span>
<span class="hljs-comment">+++ Refactored</span>
@@
    ServiceDiscovery serviceDiscovery = Mockito.mock(ServiceDiscovery.class);
    listener = new ServiceInstancesChangedListener(serviceNames, serviceDiscovery);
    ServiceInstancesChangedListener spyListener = Mockito.spy(listener);
<span class="hljs-deletion">-    Mockito.doReturn(null).when(metadataService).getMetadataInfo(eq(null));</span>
<span class="hljs-addition">+    metadataService = MockMetadataService.createMockMetadataService();</span>
    ServiceInstancesChangedEvent event = new ServiceInstancesChangedEvent("app1", app1InstancesWithNoRevision);
    spyListener.onEvent(event);
    // notification succeeded
    assertTrue(true);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeAll</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{

    metadataService = Mockito.mock(MetadataService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;Object&gt; urlsSameRevision = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsSameRevision.add(<span class="hljs-string">"127.0.0.1:20880?revision=111"</span>);

    urlsSameRevision.add(<span class="hljs-string">"127.0.0.2:20880?revision=111"</span>);

    urlsSameRevision.add(<span class="hljs-string">"127.0.0.3:20880?revision=111"</span>);

    List&lt;Object&gt; urlsDifferentRevision = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsDifferentRevision.add(<span class="hljs-string">"30.10.0.1:20880?revision=222"</span>);

    urlsDifferentRevision.add(<span class="hljs-string">"30.10.0.2:20880?revision=222"</span>);

    urlsDifferentRevision.add(<span class="hljs-string">"30.10.0.3:20880?revision=333"</span>);

    urlsDifferentRevision.add(<span class="hljs-string">"30.10.0.4:20880?revision=333"</span>);

    List&lt;Object&gt; urlsFailedRevision = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsFailedRevision.add(<span class="hljs-string">"30.10.0.5:20880?revision=222"</span>);

    urlsFailedRevision.add(<span class="hljs-string">"30.10.0.6:20880?revision=222"</span>);

    <span class="hljs-comment">// revision will fail</span>

    urlsFailedRevision.add(<span class="hljs-string">"30.10.0.7:20880?revision=444"</span>);

    <span class="hljs-comment">// revision will fail</span>

    urlsFailedRevision.add(<span class="hljs-string">"30.10.0.8:20880?revision=444"</span>);

    List&lt;Object&gt; urlsFailedRevision2 = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsFailedRevision2.add(<span class="hljs-string">"30.10.0.1:20880?revision=222"</span>);

    urlsFailedRevision2.add(<span class="hljs-string">"30.10.0.2:20880?revision=222"</span>);

    List&lt;Object&gt; urlsWithoutRevision = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsWithoutRevision.add(<span class="hljs-string">"30.10.0.1:20880"</span>);

    List&lt;Object&gt; urlsMultipleProtocols = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-comment">//triple</span>

    urlsMultipleProtocols.add(<span class="hljs-string">"30.10.0.1:20880?revision=555"</span>);

    <span class="hljs-comment">// dubbo</span>

    urlsMultipleProtocols.addAll(urlsSameRevision);

    app1Instances = buildInstances(urlsSameRevision);

    app2Instances = buildInstances(urlsDifferentRevision);

    app1FailedInstances = buildInstances(urlsFailedRevision);

    app1FailedInstances2 = buildInstances(urlsFailedRevision2);

    app1InstancesWithNoRevision = buildInstances(urlsWithoutRevision);

    app1InstancesMultipleProtocols = buildInstances(urlsMultipleProtocols);

    metadataInfo_111 = JsonUtils.toJavaObject(metadata_111, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    metadataInfo_222 = JsonUtils.toJavaObject(metadata_222, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    metadataInfo_333 = JsonUtils.toJavaObject(metadata_333, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    metadataInfo_444 = JsonUtils.toJavaObject(metadata_444, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    metadataInfo_555_tri = JsonUtils.toJavaObject(metadata_555_triple, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    serviceDiscovery = Mockito.mock(ServiceDiscovery<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(serviceDiscovery.getUrl()).thenReturn(registryURL);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"111"</span>), anyList())).thenReturn(metadataInfo_111);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"222"</span>), anyList())).thenReturn(metadataInfo_222);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"333"</span>), anyList())).thenReturn(metadataInfo_333);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"444"</span>), anyList())).thenReturn(MetadataInfo.EMPTY);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"555"</span>), anyList())).thenReturn(metadataInfo_555_tri);

}
<span class="hljs-comment">// Abnormal case. Instance does not have revision</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">12</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInstanceWithoutRevision</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    ServiceDiscovery serviceDiscovery = Mockito.mock(ServiceDiscovery<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    ServiceInstancesChangedListener spyListener = Mockito.spy(listener);

    Mockito.doReturn(<span class="hljs-keyword">null</span>).when(metadataService).getMetadataInfo(eq(<span class="hljs-keyword">null</span>));

    ServiceInstancesChangedEvent event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1InstancesWithNoRevision);

    spyListener.onEvent(event);

    <span class="hljs-comment">// notification succeeded</span>

    assertTrue(<span class="hljs-keyword">true</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockMetadataService</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MetadataService <span class="hljs-title">createMockMetadataService</span><span class="hljs-params">()</span> </span>{
        MetadataService metadataService = Mockito.mock(MetadataService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        Mockito.doReturn(<span class="hljs-keyword">null</span>).when(metadataService).getMetadataInfo(org.mockito.ArgumentMatchers.eq(<span class="hljs-keyword">null</span>));
        <span class="hljs-keyword">return</span> metadataService;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest192">Test Case ID #dubbo_Test_19_2</h4>
<h4 id="test-case-name-testinstancewithoutrevisionfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenerwithoutemptyprotecttestjava">Test Case Name: <code>testInstanceWithoutRevision</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerWithoutEmptyProtectTest.java</code>)</h4>
<h4 id="mock-object-variable-name-metadataservice">Mock Object Variable Name: <code>metadataService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- Original</span>
<span class="hljs-comment">+++ Refactored</span>
@@
    ServiceDiscovery serviceDiscovery = Mockito.mock(ServiceDiscovery.class);
    listener = new ServiceInstancesChangedListener(serviceNames, serviceDiscovery);
    ServiceInstancesChangedListener spyListener = Mockito.spy(listener);
<span class="hljs-deletion">-    Mockito.doReturn(null).when(metadataService).getMetadataInfo(eq(null));</span>
<span class="hljs-addition">+    metadataService = MockMetadataService.createMockMetadataService();</span>
    ServiceInstancesChangedEvent event = new ServiceInstancesChangedEvent("app1", app1InstancesWithNoRevision);
    spyListener.onEvent(event);
    // notification succeeded
    assertTrue(true);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeAll</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{

    metadataService = Mockito.mock(MetadataService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;Object&gt; urlsSameRevision = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsSameRevision.add(<span class="hljs-string">"127.0.0.1:20880?revision=111"</span>);

    urlsSameRevision.add(<span class="hljs-string">"127.0.0.2:20880?revision=111"</span>);

    urlsSameRevision.add(<span class="hljs-string">"127.0.0.3:20880?revision=111"</span>);

    List&lt;Object&gt; urlsDifferentRevision = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsDifferentRevision.add(<span class="hljs-string">"30.10.0.1:20880?revision=222"</span>);

    urlsDifferentRevision.add(<span class="hljs-string">"30.10.0.2:20880?revision=222"</span>);

    urlsDifferentRevision.add(<span class="hljs-string">"30.10.0.3:20880?revision=333"</span>);

    urlsDifferentRevision.add(<span class="hljs-string">"30.10.0.4:20880?revision=333"</span>);

    List&lt;Object&gt; urlsFailedRevision = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsFailedRevision.add(<span class="hljs-string">"30.10.0.5:20880?revision=222"</span>);

    urlsFailedRevision.add(<span class="hljs-string">"30.10.0.6:20880?revision=222"</span>);

    <span class="hljs-comment">// revision will fail</span>

    urlsFailedRevision.add(<span class="hljs-string">"30.10.0.7:20880?revision=444"</span>);

    <span class="hljs-comment">// revision will fail</span>

    urlsFailedRevision.add(<span class="hljs-string">"30.10.0.8:20880?revision=444"</span>);

    List&lt;Object&gt; urlsFailedRevision2 = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsFailedRevision2.add(<span class="hljs-string">"30.10.0.1:20880?revision=222"</span>);

    urlsFailedRevision2.add(<span class="hljs-string">"30.10.0.2:20880?revision=222"</span>);

    List&lt;Object&gt; urlsWithoutRevision = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urlsWithoutRevision.add(<span class="hljs-string">"30.10.0.1:20880"</span>);

    List&lt;Object&gt; urlsMultipleProtocols = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-comment">//triple</span>

    urlsMultipleProtocols.add(<span class="hljs-string">"30.10.0.1:20880?revision=555"</span>);

    <span class="hljs-comment">// dubbo</span>

    urlsMultipleProtocols.addAll(urlsSameRevision);

    app1Instances = buildInstances(urlsSameRevision);

    app2Instances = buildInstances(urlsDifferentRevision);

    app1FailedInstances = buildInstances(urlsFailedRevision);

    app1FailedInstances2 = buildInstances(urlsFailedRevision2);

    app1InstancesWithNoRevision = buildInstances(urlsWithoutRevision);

    app1InstancesMultipleProtocols = buildInstances(urlsMultipleProtocols);

    metadataInfo_111 = JsonUtils.toJavaObject(metadata_111, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    metadataInfo_222 = JsonUtils.toJavaObject(metadata_222, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    metadataInfo_333 = JsonUtils.toJavaObject(metadata_333, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    metadataInfo_444 = JsonUtils.toJavaObject(metadata_444, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    metadataInfo_555_tri = JsonUtils.toJavaObject(metadata_555_triple, MetadataInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    serviceDiscovery = Mockito.mock(ServiceDiscovery<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(serviceDiscovery.getUrl()).thenReturn(registryURL);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"111"</span>), anyList())).thenReturn(metadataInfo_111);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"222"</span>), anyList())).thenReturn(metadataInfo_222);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"333"</span>), anyList())).thenReturn(metadataInfo_333);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"444"</span>), anyList())).thenReturn(MetadataInfo.EMPTY);

    when(serviceDiscovery.getRemoteMetadata(eq(<span class="hljs-string">"555"</span>), anyList())).thenReturn(metadataInfo_555_tri);

}
<span class="hljs-comment">// Abnormal case. Instance does not have revision</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">12</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInstanceWithoutRevision</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    ServiceDiscovery serviceDiscovery = Mockito.mock(ServiceDiscovery<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    ServiceInstancesChangedListener spyListener = Mockito.spy(listener);

    Mockito.doReturn(<span class="hljs-keyword">null</span>).when(metadataService).getMetadataInfo(eq(<span class="hljs-keyword">null</span>));

    ServiceInstancesChangedEvent event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1InstancesWithNoRevision);

    spyListener.onEvent(event);

    <span class="hljs-comment">// notification succeeded</span>

    assertTrue(<span class="hljs-keyword">true</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockMetadataService</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MetadataService <span class="hljs-title">createMockMetadataService</span><span class="hljs-params">()</span> </span>{
        MetadataService metadataService = Mockito.mock(MetadataService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        Mockito.doReturn(<span class="hljs-keyword">null</span>).when(metadataService).getMetadataInfo(org.mockito.ArgumentMatchers.eq(<span class="hljs-keyword">null</span>));
        <span class="hljs-keyword">return</span> metadataService;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci20">Mock Clone Instance #dubbo_MCI_20</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.remoting.Channel</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Channel <span class="hljs-title">createMockChannel</span><span class="hljs-params">(URL url)</span> </span>{
    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(channel.getUrl()).willReturn(url);
    <span class="hljs-keyword">return</span> channel;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest201">Test Case ID #dubbo_Test_20_1</h4>
<h4 id="test-case-name-testcheckpayloaddefault8mfile-cjavaprojectsapachedubbodubbo-remotingdubbo-remoting-apisrctestjavaorgapachedubboremotingtransportabstractcodectestjava">Test Case Name: <code>testCheckPayloadDefault8M</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-remoting\dubbo-remoting-api\src\test\java\org\apache\dubbo\remoting\transport\AbstractCodecTest.java</code>)</h4>
<h4 id="mock-object-variable-name-channel">Mock Object Variable Name: <code>channel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testCheckPayloadDefault8M() throws Exception {
<span class="hljs-deletion">-    Channel channel = mock(Channel.class);</span>
<span class="hljs-deletion">-    given(channel.getUrl()).willReturn(URL.valueOf("dubbo://1.1.1.1"));</span>
<span class="hljs-addition">+    Channel channel = createMockChannel(URL.valueOf("dubbo://1.1.1.1"));</span>
    AbstractCodec.checkPayload(channel, 1 * 1024 * 1024);
    try {
        AbstractCodec.checkPayload(channel, 15 * 1024 * 1024);
    } catch (IOException expected) {
        assertThat(expected.getMessage(), allOf(containsString("Data length too large: "), containsString("max payload: " + 8 * 1024 * 1024)));
    }
    verify(channel, VerificationModeFactory.atLeastOnce()).getUrl();
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testCheckPayloadDefault8M</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(channel.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"dubbo://1.1.1.1"</span>));

    AbstractCodec.checkPayload(channel, <span class="hljs-number">1</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);

    <span class="hljs-keyword">try</span> {

        AbstractCodec.checkPayload(channel, <span class="hljs-number">15</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);

    } <span class="hljs-keyword">catch</span> (IOException expected) {

        assertThat(expected.getMessage(), allOf(containsString(<span class="hljs-string">"Data length too large: "</span>), containsString(<span class="hljs-string">"max payload: "</span> + <span class="hljs-number">8</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)));

    }

    verify(channel, VerificationModeFactory.atLeastOnce()).getUrl();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Channel <span class="hljs-title">createMockChannel</span><span class="hljs-params">(URL url)</span> </span>{
    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(channel.getUrl()).willReturn(url);
    <span class="hljs-keyword">return</span> channel;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest202">Test Case ID #dubbo_Test_20_2</h4>
<h4 id="test-case-name-testcheckproviderpayloadfile-cjavaprojectsapachedubbodubbo-remotingdubbo-remoting-apisrctestjavaorgapachedubboremotingtransportabstractcodectestjava">Test Case Name: <code>testCheckProviderPayload</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-remoting\dubbo-remoting-api\src\test\java\org\apache\dubbo\remoting\transport\AbstractCodecTest.java</code>)</h4>
<h4 id="mock-object-variable-name-channel">Mock Object Variable Name: <code>channel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 void testCheckProviderPayload() throws Exception {
<span class="hljs-deletion">-    Channel channel = mock(Channel.class);</span>
<span class="hljs-deletion">-    given(channel.getUrl()).willReturn(URL.valueOf("dubbo://1.1.1.1"));</span>
<span class="hljs-addition">+    Channel channel = createMockChannel(URL.valueOf("dubbo://1.1.1.1"));</span>
     AbstractCodec.checkPayload(channel, 1024 * 1024 + 1, 1024 * 1024);
     try {
         AbstractCodec.checkPayload(channel, 1024 * 1024, 1024 * 1024);
     } catch (IOException expected) {
         assertThat(expected.getMessage(), allOf(containsString("Data length too large: "), containsString("max payload: " + 1024 * 1024)));
     }
     try {
         AbstractCodec.checkPayload(channel, 0, 15 * 1024 * 1024);
     } catch (IOException expected) {
         assertThat(expected.getMessage(), allOf(containsString("Data length too large: "), containsString("max payload: " + 8 * 1024 * 1024)));
     }
     verify(channel, VerificationModeFactory.atLeastOnce()).getUrl();
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testCheckProviderPayload</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(channel.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"dubbo://1.1.1.1"</span>));

    AbstractCodec.checkPayload(channel, <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> + <span class="hljs-number">1</span>, <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);

    <span class="hljs-keyword">try</span> {

        AbstractCodec.checkPayload(channel, <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>, <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);

    } <span class="hljs-keyword">catch</span> (IOException expected) {

        assertThat(expected.getMessage(), allOf(containsString(<span class="hljs-string">"Data length too large: "</span>), containsString(<span class="hljs-string">"max payload: "</span> + <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)));

    }

    <span class="hljs-keyword">try</span> {

        AbstractCodec.checkPayload(channel, <span class="hljs-number">0</span>, <span class="hljs-number">15</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);

    } <span class="hljs-keyword">catch</span> (IOException expected) {

        assertThat(expected.getMessage(), allOf(containsString(<span class="hljs-string">"Data length too large: "</span>), containsString(<span class="hljs-string">"max payload: "</span> + <span class="hljs-number">8</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)));

    }

    verify(channel, VerificationModeFactory.atLeastOnce()).getUrl();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Channel <span class="hljs-title">createMockChannel</span><span class="hljs-params">(URL url)</span> </span>{
    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(channel.getUrl()).willReturn(url);
    <span class="hljs-keyword">return</span> channel;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest203">Test Case ID #dubbo_Test_20_3</h4>
<h4 id="test-case-name-tescheckpayloadminuspayloadnolimitfile-cjavaprojectsapachedubbodubbo-remotingdubbo-remoting-apisrctestjavaorgapachedubboremotingtransportabstractcodectestjava">Test Case Name: <code>tesCheckPayloadMinusPayloadNoLimit</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-remoting\dubbo-remoting-api\src\test\java\org\apache\dubbo\remoting\transport\AbstractCodecTest.java</code>)</h4>
<h4 id="mock-object-variable-name-channel">Mock Object Variable Name: <code>channel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void tesCheckPayloadMinusPayloadNoLimit() throws Exception {
<span class="hljs-deletion">-    Channel channel = mock(Channel.class);</span>
<span class="hljs-deletion">-    given(channel.getUrl()).willReturn(URL.valueOf("dubbo://1.1.1.1?payload=-1"));</span>
<span class="hljs-addition">+    Channel channel = createMockChannel(URL.valueOf("dubbo://1.1.1.1?payload=-1"));</span>
     AbstractCodec.checkPayload(channel, 15 * 1024 * 1024);
     verify(channel, VerificationModeFactory.atLeastOnce()).getUrl();
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">tesCheckPayloadMinusPayloadNoLimit</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(channel.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"dubbo://1.1.1.1?payload=-1"</span>));

    AbstractCodec.checkPayload(channel, <span class="hljs-number">15</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);

    verify(channel, VerificationModeFactory.atLeastOnce()).getUrl();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Channel <span class="hljs-title">createMockChannel</span><span class="hljs-params">(URL url)</span> </span>{
    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(channel.getUrl()).willReturn(url);
    <span class="hljs-keyword">return</span> channel;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest204">Test Case ID #dubbo_Test_20_4</h4>
<h4 id="test-case-name-testisclientsidefile-cjavaprojectsapachedubbodubbo-remotingdubbo-remoting-apisrctestjavaorgapachedubboremotingtransportabstractcodectestjava">Test Case Name: <code>testIsClientSide</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-remoting\dubbo-remoting-api\src\test\java\org\apache\dubbo\remoting\transport\AbstractCodecTest.java</code>)</h4>
<h4 id="mock-object-variable-name-channel">Mock Object Variable Name: <code>channel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     AbstractCodec codec = getAbstractCodec();
<span class="hljs-deletion">-    Channel channel = mock(Channel.class);</span>
<span class="hljs-deletion">-    given(channel.getRemoteAddress()).willReturn(new InetSocketAddress("172.24.157.13", 9103));</span>
<span class="hljs-deletion">-    given(channel.getUrl()).willReturn(URL.valueOf("dubbo://172.24.157.13:9103"));</span>
<span class="hljs-addition">+    Channel channel = createMockChannel(URL.valueOf("dubbo://172.24.157.13:9103"));</span>
<span class="hljs-addition">+    given(channel.getRemoteAddress()).willReturn(new InetSocketAddress("172.24.157.13", 9103));</span>
     assertThat(codec.isClientSide(channel), is(true));
     assertThat(codec.isServerSide(channel), is(false));
<span class="hljs-deletion">-    given(channel.getRemoteAddress()).willReturn(new InetSocketAddress("172.24.157.14", 9103));</span>
<span class="hljs-deletion">-    given(channel.getUrl()).willReturn(URL.valueOf("dubbo://172.24.157.13:9103"));</span>
<span class="hljs-addition">+    given(channel.getRemoteAddress()).willReturn(new InetSocketAddress("172.24.157.14", 9103));</span>
<span class="hljs-addition">+    given(channel.getUrl()).willReturn(URL.valueOf("dubbo://172.24.157.13:9103"));</span>
     assertThat(codec.isClientSide(channel), is(false));
     assertThat(codec.isServerSide(channel), is(true));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testIsClientSide</span><span class="hljs-params">()</span> </span>{

    AbstractCodec codec = getAbstractCodec();

    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(channel.getRemoteAddress()).willReturn(<span class="hljs-keyword">new</span> InetSocketAddress(<span class="hljs-string">"172.24.157.13"</span>, <span class="hljs-number">9103</span>));

    given(channel.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"dubbo://172.24.157.13:9103"</span>));

    assertThat(codec.isClientSide(channel), is(<span class="hljs-keyword">true</span>));

    assertThat(codec.isServerSide(channel), is(<span class="hljs-keyword">false</span>));

    given(channel.getRemoteAddress()).willReturn(<span class="hljs-keyword">new</span> InetSocketAddress(<span class="hljs-string">"172.24.157.14"</span>, <span class="hljs-number">9103</span>));

    given(channel.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"dubbo://172.24.157.13:9103"</span>));

    assertThat(codec.isClientSide(channel), is(<span class="hljs-keyword">false</span>));

    assertThat(codec.isServerSide(channel), is(<span class="hljs-keyword">true</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Channel <span class="hljs-title">createMockChannel</span><span class="hljs-params">(URL url)</span> </span>{
    Channel channel = mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(channel.getUrl()).willReturn(url);
    <span class="hljs-keyword">return</span> channel;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci21">Mock Clone Instance #dubbo_MCI_21</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.remoting.Channel</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockChannel</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Channel with the given URL to be returned by getUrl().
     *
     * <span class="hljs-doctag">@param</span> url the URL to return from channel.getUrl()
     * <span class="hljs-doctag">@return</span> a mock Channel
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Channel <span class="hljs-title">createMockChannel</span><span class="hljs-params">(org.apache.dubbo.common.URL url)</span> </span>{
        Channel channel = Mockito.mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        Mockito.when(channel.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> channel;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest211">Test Case ID #dubbo_Test_21_1</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-remotingdubbo-remoting-apisrctestjavaorgapachedubboremotingtelnetsupporthelptelnethandlertestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-remoting\dubbo-remoting-api\src\test\java\org\apache\dubbo\remoting\telnet\support\HelpTelnetHandlerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-channel">Mock Object Variable Name: <code>channel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void test() {
<span class="hljs-deletion">-    Channel channel = Mockito.mock(Channel.class);</span>
<span class="hljs-deletion">-    Mockito.when(channel.getUrl()).thenReturn(URL.valueOf("dubbo://127.0.0.1:12345"));</span>
<span class="hljs-addition">+    Channel channel = MockChannel.createMockChannel(URL.valueOf("dubbo://127.0.0.1:12345"));</span>
    HelpTelnetHandler helpTelnetHandler = new HelpTelnetHandler(FrameworkModel.defaultModel());
    // default output
    String prompt = "Please input \"help [command]\" show detail.\r\n";
    Assertions.assertTrue(helpTelnetHandler.telnet(channel, "").contains(prompt));
    // "help" command output
    String demoOutput = "Command:\r\n" + "    help [command]\r\n" + "Summary:\r\n" + "    Show help.\r\n" + "Detail:\r\n" + "    Show help.";
    Assertions.assertEquals(helpTelnetHandler.telnet(channel, "help"), demoOutput);
}
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    Channel channel = Mockito.mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(channel.getUrl()).thenReturn(URL.valueOf(<span class="hljs-string">"dubbo://127.0.0.1:12345"</span>));

    HelpTelnetHandler helpTelnetHandler = <span class="hljs-keyword">new</span> HelpTelnetHandler(FrameworkModel.defaultModel());

    <span class="hljs-comment">// default output</span>

    String prompt = <span class="hljs-string">"Please input \"help [command]\" show detail.\r\n"</span>;

    Assertions.assertTrue(helpTelnetHandler.telnet(channel, <span class="hljs-string">""</span>).contains(prompt));

    <span class="hljs-comment">// "help" command output</span>

    String demoOutput = <span class="hljs-string">"Command:\r\n"</span> + <span class="hljs-string">"    help [command]\r\n"</span> + <span class="hljs-string">"Summary:\r\n"</span> + <span class="hljs-string">"    Show help.\r\n"</span> + <span class="hljs-string">"Detail:\r\n"</span> + <span class="hljs-string">"    Show help."</span>;

    Assertions.assertEquals(helpTelnetHandler.telnet(channel, <span class="hljs-string">"help"</span>), demoOutput);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockChannel</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Channel with the given URL to be returned by getUrl().
     *
     * <span class="hljs-doctag">@param</span> url the URL to return from channel.getUrl()
     * <span class="hljs-doctag">@return</span> a mock Channel
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Channel <span class="hljs-title">createMockChannel</span><span class="hljs-params">(org.apache.dubbo.common.URL url)</span> </span>{
        Channel channel = Mockito.mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        Mockito.when(channel.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> channel;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest212">Test Case ID #dubbo_Test_21_2</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-remotingdubbo-remoting-apisrctestjavaorgapachedubboremotingtelnetsupportstatustelnethandlertestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-remoting\dubbo-remoting-api\src\test\java\org\apache\dubbo\remoting\telnet\support\StatusTelnetHandlerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-channel">Mock Object Variable Name: <code>channel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 void test() {
<span class="hljs-deletion">-    Channel channel = Mockito.mock(Channel.class);</span>
<span class="hljs-deletion">-    Mockito.when(channel.getUrl()).thenReturn(URL.valueOf("dubbo://127.0.0.1:12345"));</span>
<span class="hljs-addition">+    Channel channel = MockChannel.createMockChannel(URL.valueOf("dubbo://127.0.0.1:12345"));</span>
     StatusTelnetHandler statusTelnetHandler = new StatusTelnetHandler();
     Assertions.assertNotNull(statusTelnetHandler.telnet(channel, ""));
     Assertions.assertNotNull(statusTelnetHandler.telnet(channel, "-l"));
     String errorPrompt = "Unsupported parameter ";
     Assertions.assertTrue(statusTelnetHandler.telnet(channel, "other").contains(errorPrompt));
<span class="hljs-deletion">-    Mockito.when(channel.getUrl()).thenReturn(URL.valueOf("dubbo://127.0.0.1:12345?status=load,memory"));</span>
<span class="hljs-addition">+    Mockito.when(channel.getUrl()).thenReturn(URL.valueOf("dubbo://127.0.0.1:12345?status=load,memory"));</span>
     Assertions.assertNotNull(statusTelnetHandler.telnet(channel, ""));
     Assertions.assertNotNull(statusTelnetHandler.telnet(channel, "-l"));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    Channel channel = Mockito.mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(channel.getUrl()).thenReturn(URL.valueOf(<span class="hljs-string">"dubbo://127.0.0.1:12345"</span>));

    StatusTelnetHandler statusTelnetHandler = <span class="hljs-keyword">new</span> StatusTelnetHandler();

    Assertions.assertNotNull(statusTelnetHandler.telnet(channel, <span class="hljs-string">""</span>));

    Assertions.assertNotNull(statusTelnetHandler.telnet(channel, <span class="hljs-string">"-l"</span>));

    String errorPrompt = <span class="hljs-string">"Unsupported parameter "</span>;

    Assertions.assertTrue(statusTelnetHandler.telnet(channel, <span class="hljs-string">"other"</span>).contains(errorPrompt));

    Mockito.when(channel.getUrl()).thenReturn(URL.valueOf(<span class="hljs-string">"dubbo://127.0.0.1:12345?status=load,memory"</span>));

    Assertions.assertNotNull(statusTelnetHandler.telnet(channel, <span class="hljs-string">""</span>));

    Assertions.assertNotNull(statusTelnetHandler.telnet(channel, <span class="hljs-string">"-l"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockChannel</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Channel with the given URL to be returned by getUrl().
     *
     * <span class="hljs-doctag">@param</span> url the URL to return from channel.getUrl()
     * <span class="hljs-doctag">@return</span> a mock Channel
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Channel <span class="hljs-title">createMockChannel</span><span class="hljs-params">(org.apache.dubbo.common.URL url)</span> </span>{
        Channel channel = Mockito.mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        Mockito.when(channel.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> channel;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest213">Test Case ID #dubbo_Test_21_3</h4>
<h4 id="test-case-name-testtelnetfile-cjavaprojectsapachedubbodubbo-remotingdubbo-remoting-apisrctestjavaorgapachedubboremotingtelnetsupporttelnethandleradaptertestjava">Test Case Name: <code>testTelnet</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-remoting\dubbo-remoting-api\src\test\java\org\apache\dubbo\remoting\telnet\support\TelnetHandlerAdapterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-channel">Mock Object Variable Name: <code>channel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 void testTelnet() throws RemotingException {
<span class="hljs-deletion">-    Channel channel = Mockito.mock(Channel.class);</span>
     Map&lt;String, String&gt; param = new HashMap&lt;&gt;();
     param.put("telnet", "status");
     URL url = new URL("p1", "127.0.0.1", 12345, "path1", param);
<span class="hljs-addition">+    Channel channel = MockChannel.createMockChannel(url);</span>
     TelnetHandlerAdapter telnetHandlerAdapter = new TelnetHandlerAdapter(FrameworkModel.defaultModel());
     String message = "--no-prompt status ";
     String expectedResult = "OK\r\n";
     Assertions.assertEquals(expectedResult, telnetHandlerAdapter.telnet(channel, message));
     message = "--no-prompt status test";
     expectedResult = "Unsupported parameter test for status.\r\n";
     Assertions.assertEquals(expectedResult, telnetHandlerAdapter.telnet(channel, message));
     message = "--no-prompt test";
     expectedResult = "Unsupported command: test\r\n";
     Assertions.assertEquals(expectedResult, telnetHandlerAdapter.telnet(channel, message));
     message = "--no-prompt help";
     expectedResult = "Command: help disabled for security reasons, please enable support by listing the commands through 'telnet'\r\n";
     Assertions.assertEquals(expectedResult, telnetHandlerAdapter.telnet(channel, message));
     message = "--no-prompt";
     expectedResult = StringUtils.EMPTY_STRING;
     Assertions.assertEquals(expectedResult, telnetHandlerAdapter.telnet(channel, message));
     message = "help";
     expectedResult = "Command: help disabled for security reasons, please enable support by listing the commands through 'telnet'\r\ndubbo&gt;";
     Assertions.assertEquals(expectedResult, telnetHandlerAdapter.telnet(channel, message));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testTelnet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemotingException </span>{

    Channel channel = Mockito.mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Map&lt;String, String&gt; param = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    param.put(<span class="hljs-string">"telnet"</span>, <span class="hljs-string">"status"</span>);

    URL url = <span class="hljs-keyword">new</span> URL(<span class="hljs-string">"p1"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">12345</span>, <span class="hljs-string">"path1"</span>, param);

    Mockito.when(channel.getUrl()).thenReturn(url);

    TelnetHandlerAdapter telnetHandlerAdapter = <span class="hljs-keyword">new</span> TelnetHandlerAdapter(FrameworkModel.defaultModel());

    String message = <span class="hljs-string">"--no-prompt status "</span>;

    String expectedResult = <span class="hljs-string">"OK\r\n"</span>;

    Assertions.assertEquals(expectedResult, telnetHandlerAdapter.telnet(channel, message));

    message = <span class="hljs-string">"--no-prompt status test"</span>;

    expectedResult = <span class="hljs-string">"Unsupported parameter test for status.\r\n"</span>;

    Assertions.assertEquals(expectedResult, telnetHandlerAdapter.telnet(channel, message));

    message = <span class="hljs-string">"--no-prompt test"</span>;

    expectedResult = <span class="hljs-string">"Unsupported command: test\r\n"</span>;

    Assertions.assertEquals(expectedResult, telnetHandlerAdapter.telnet(channel, message));

    message = <span class="hljs-string">"--no-prompt help"</span>;

    expectedResult = <span class="hljs-string">"Command: help disabled for security reasons, please enable support by listing the commands through 'telnet'\r\n"</span>;

    Assertions.assertEquals(expectedResult, telnetHandlerAdapter.telnet(channel, message));

    message = <span class="hljs-string">"--no-prompt"</span>;

    expectedResult = StringUtils.EMPTY_STRING;

    Assertions.assertEquals(expectedResult, telnetHandlerAdapter.telnet(channel, message));

    message = <span class="hljs-string">"help"</span>;

    expectedResult = <span class="hljs-string">"Command: help disabled for security reasons, please enable support by listing the commands through 'telnet'\r\ndubbo&gt;"</span>;

    Assertions.assertEquals(expectedResult, telnetHandlerAdapter.telnet(channel, message));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockChannel</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Channel with the given URL to be returned by getUrl().
     *
     * <span class="hljs-doctag">@param</span> url the URL to return from channel.getUrl()
     * <span class="hljs-doctag">@return</span> a mock Channel
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Channel <span class="hljs-title">createMockChannel</span><span class="hljs-params">(org.apache.dubbo.common.URL url)</span> </span>{
        Channel channel = Mockito.mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        Mockito.when(channel.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> channel;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci22">Mock Clone Instance #dubbo_MCI_22</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.remoting.Channel</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Channel <span class="hljs-title">createMockChannel</span><span class="hljs-params">(Object attributeValue)</span> </span>{
    Channel channel = Mockito.mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(channel.getAttribute(HeaderExchangeChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>() + ".<span class="hljs-title">CHANNEL</span>")).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">attributeValue</span>)</span>;
    <span class="hljs-keyword">return</span> channel;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest221">Test Case ID #dubbo_Test_22_1</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-remotingdubbo-remoting-apisrctestjavaorgapachedubboremotingexchangesupportheaderheaderexchangeservertestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-remoting\dubbo-remoting-api\src\test\java\org\apache\dubbo\remoting\exchange\support\header\HeaderExchangeServerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-channel1">Mock Object Variable Name: <code>channel1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
     // test getChannels() and getExchangeChannels()
<span class="hljs-deletion">-    Channel channel1 = Mockito.mock(Channel.class);</span>
<span class="hljs-addition">+    Channel channel1 = createMockChannel(exchangeChannel1);</span>
     Channel channel2 = Mockito.mock(Channel.class);
     Channel exchangeChannel1 = new HeaderExchangeChannel(channel1);
     Channel exchangeChannel2 = new HeaderExchangeChannel(channel2);
<span class="hljs-deletion">-    Mockito.when(channel1.getAttribute(HeaderExchangeChannel.class.getName() + ".CHANNEL")).thenReturn(exchangeChannel1);</span>
     Mockito.when(channel2.getAttribute(HeaderExchangeChannel.class.getName() + ".CHANNEL")).thenReturn(exchangeChannel2);
     Collection&lt;Channel&gt; exChannels = Arrays.asList(exchangeChannel1, exchangeChannel2);
     Mockito.when(server.getChannels()).thenReturn(Arrays.asList(channel1, channel2));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, RemotingException </span>{

    RemotingServer server = Mockito.mock(RemotingServer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"dubbo"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">20881</span>);

    Mockito.when(server.getUrl()).thenReturn(url);

    Mockito.when(server.canHandleIdle()).thenReturn(<span class="hljs-keyword">false</span>);

    HeaderExchangeServer headerExchangeServer = <span class="hljs-keyword">new</span> HeaderExchangeServer(server);

    Assertions.assertEquals(headerExchangeServer.getServer(), server);

    Assertions.assertEquals(headerExchangeServer.getUrl(), url);

    <span class="hljs-comment">// test getChannels() and getExchangeChannels()</span>

    Channel channel1 = Mockito.mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Channel channel2 = Mockito.mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Channel exchangeChannel1 = <span class="hljs-keyword">new</span> HeaderExchangeChannel(channel1);

    Channel exchangeChannel2 = <span class="hljs-keyword">new</span> HeaderExchangeChannel(channel2);

    Mockito.when(channel1.getAttribute(HeaderExchangeChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>() + ".<span class="hljs-title">CHANNEL</span>")).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">exchangeChannel1</span>)</span>;

    Mockito.when(channel2.getAttribute(HeaderExchangeChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>() + ".<span class="hljs-title">CHANNEL</span>")).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">exchangeChannel2</span>)</span>;

    Collection&lt;Channel&gt; exChannels = Arrays.asList(exchangeChannel1, exchangeChannel2);

    Mockito.when(server.getChannels()).thenReturn(Arrays.asList(channel1, channel2));

    Assertions.assertEquals(headerExchangeServer.getChannels(), exChannels);

    Assertions.assertEquals(headerExchangeServer.getExchangeChannels(), exChannels);

    <span class="hljs-comment">// test getChannel(InetSocketAddress) and getExchangeChannel(InetSocketAddress)</span>

    InetSocketAddress address1 = Mockito.mock(InetSocketAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    InetSocketAddress address2 = Mockito.mock(InetSocketAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(server.getChannel(Mockito.eq(address1))).thenReturn(channel1);

    Mockito.when(server.getChannel(Mockito.eq(address2))).thenReturn(channel2);

    Assertions.assertEquals(headerExchangeServer.getChannel(address1), exchangeChannel1);

    Assertions.assertEquals(headerExchangeServer.getChannel(address2), exchangeChannel2);

    Assertions.assertEquals(headerExchangeServer.getExchangeChannel(address1), exchangeChannel1);

    Assertions.assertEquals(headerExchangeServer.getExchangeChannel(address2), exchangeChannel2);

    <span class="hljs-comment">// test send(Object message) and send(Object message, boolean sent)</span>

    headerExchangeServer.send(<span class="hljs-string">"test"</span>);

    Mockito.verify(server, Mockito.times(<span class="hljs-number">1</span>)).send(<span class="hljs-string">"test"</span>);

    headerExchangeServer.send(<span class="hljs-string">"test"</span>, <span class="hljs-keyword">true</span>);

    Mockito.verify(server, Mockito.times(<span class="hljs-number">1</span>)).send(<span class="hljs-string">"test"</span>, <span class="hljs-keyword">true</span>);

    <span class="hljs-comment">// test reset(URL url)</span>

    url = url.addParameter(Constants.HEARTBEAT_KEY, <span class="hljs-number">3000</span>).addParameter(Constants.HEARTBEAT_TIMEOUT_KEY, <span class="hljs-number">3000</span> * <span class="hljs-number">3</span>);

    headerExchangeServer.reset(url);

    <span class="hljs-comment">// test close(int timeout)</span>

    Mockito.when(exchangeChannel1.isConnected()).thenReturn(<span class="hljs-keyword">true</span>);

    headerExchangeServer.close(<span class="hljs-number">1000</span>);

    Mockito.verify(server, Mockito.times(<span class="hljs-number">1</span>)).startClose();

    Thread.sleep(<span class="hljs-number">1000</span>);

    Mockito.verify(server, Mockito.times(<span class="hljs-number">1</span>)).close(<span class="hljs-number">1000</span>);

    Assertions.assertThrows(RemotingException<span class="hljs-class">.<span class="hljs-keyword">class</span>, () -&gt; <span class="hljs-title">headerExchangeServer</span>.<span class="hljs-title">send</span>("<span class="hljs-title">test</span>"))</span>;

    Assertions.assertThrows(RemotingException<span class="hljs-class">.<span class="hljs-keyword">class</span>, () -&gt; <span class="hljs-title">headerExchangeServer</span>.<span class="hljs-title">send</span>("<span class="hljs-title">test</span>", <span class="hljs-title">true</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Channel <span class="hljs-title">createMockChannel</span><span class="hljs-params">(Object attributeValue)</span> </span>{
    Channel channel = Mockito.mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(channel.getAttribute(HeaderExchangeChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>() + ".<span class="hljs-title">CHANNEL</span>")).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">attributeValue</span>)</span>;
    <span class="hljs-keyword">return</span> channel;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest222">Test Case ID #dubbo_Test_22_2</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-remotingdubbo-remoting-apisrctestjavaorgapachedubboremotingexchangesupportheaderheaderexchangeservertestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-remoting\dubbo-remoting-api\src\test\java\org\apache\dubbo\remoting\exchange\support\header\HeaderExchangeServerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-channel2">Mock Object Variable Name: <code>channel2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Channel channel1 = Mockito.mock(Channel.class);
<span class="hljs-deletion">-    Channel channel2 = Mockito.mock(Channel.class);</span>
    Channel exchangeChannel1 = new HeaderExchangeChannel(channel1);
    Channel exchangeChannel2 = new HeaderExchangeChannel(channel2);
    Mockito.when(channel1.getAttribute(HeaderExchangeChannel.class.getName() + ".CHANNEL")).thenReturn(exchangeChannel1);
<span class="hljs-deletion">-    Mockito.when(channel2.getAttribute(HeaderExchangeChannel.class.getName() + ".CHANNEL")).thenReturn(exchangeChannel2);</span>
<span class="hljs-addition">+    Channel channel2 = createMockChannel(exchangeChannel2);</span>
    Collection&lt;Channel&gt; exChannels = Arrays.asList(exchangeChannel1, exchangeChannel2);
    Mockito.when(server.getChannels()).thenReturn(Arrays.asList(channel1, channel2));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, RemotingException </span>{

    RemotingServer server = Mockito.mock(RemotingServer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"dubbo"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">20881</span>);

    Mockito.when(server.getUrl()).thenReturn(url);

    Mockito.when(server.canHandleIdle()).thenReturn(<span class="hljs-keyword">false</span>);

    HeaderExchangeServer headerExchangeServer = <span class="hljs-keyword">new</span> HeaderExchangeServer(server);

    Assertions.assertEquals(headerExchangeServer.getServer(), server);

    Assertions.assertEquals(headerExchangeServer.getUrl(), url);

    <span class="hljs-comment">// test getChannels() and getExchangeChannels()</span>

    Channel channel1 = Mockito.mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Channel channel2 = Mockito.mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Channel exchangeChannel1 = <span class="hljs-keyword">new</span> HeaderExchangeChannel(channel1);

    Channel exchangeChannel2 = <span class="hljs-keyword">new</span> HeaderExchangeChannel(channel2);

    Mockito.when(channel1.getAttribute(HeaderExchangeChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>() + ".<span class="hljs-title">CHANNEL</span>")).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">exchangeChannel1</span>)</span>;

    Mockito.when(channel2.getAttribute(HeaderExchangeChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>() + ".<span class="hljs-title">CHANNEL</span>")).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">exchangeChannel2</span>)</span>;

    Collection&lt;Channel&gt; exChannels = Arrays.asList(exchangeChannel1, exchangeChannel2);

    Mockito.when(server.getChannels()).thenReturn(Arrays.asList(channel1, channel2));

    Assertions.assertEquals(headerExchangeServer.getChannels(), exChannels);

    Assertions.assertEquals(headerExchangeServer.getExchangeChannels(), exChannels);

    <span class="hljs-comment">// test getChannel(InetSocketAddress) and getExchangeChannel(InetSocketAddress)</span>

    InetSocketAddress address1 = Mockito.mock(InetSocketAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    InetSocketAddress address2 = Mockito.mock(InetSocketAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(server.getChannel(Mockito.eq(address1))).thenReturn(channel1);

    Mockito.when(server.getChannel(Mockito.eq(address2))).thenReturn(channel2);

    Assertions.assertEquals(headerExchangeServer.getChannel(address1), exchangeChannel1);

    Assertions.assertEquals(headerExchangeServer.getChannel(address2), exchangeChannel2);

    Assertions.assertEquals(headerExchangeServer.getExchangeChannel(address1), exchangeChannel1);

    Assertions.assertEquals(headerExchangeServer.getExchangeChannel(address2), exchangeChannel2);

    <span class="hljs-comment">// test send(Object message) and send(Object message, boolean sent)</span>

    headerExchangeServer.send(<span class="hljs-string">"test"</span>);

    Mockito.verify(server, Mockito.times(<span class="hljs-number">1</span>)).send(<span class="hljs-string">"test"</span>);

    headerExchangeServer.send(<span class="hljs-string">"test"</span>, <span class="hljs-keyword">true</span>);

    Mockito.verify(server, Mockito.times(<span class="hljs-number">1</span>)).send(<span class="hljs-string">"test"</span>, <span class="hljs-keyword">true</span>);

    <span class="hljs-comment">// test reset(URL url)</span>

    url = url.addParameter(Constants.HEARTBEAT_KEY, <span class="hljs-number">3000</span>).addParameter(Constants.HEARTBEAT_TIMEOUT_KEY, <span class="hljs-number">3000</span> * <span class="hljs-number">3</span>);

    headerExchangeServer.reset(url);

    <span class="hljs-comment">// test close(int timeout)</span>

    Mockito.when(exchangeChannel1.isConnected()).thenReturn(<span class="hljs-keyword">true</span>);

    headerExchangeServer.close(<span class="hljs-number">1000</span>);

    Mockito.verify(server, Mockito.times(<span class="hljs-number">1</span>)).startClose();

    Thread.sleep(<span class="hljs-number">1000</span>);

    Mockito.verify(server, Mockito.times(<span class="hljs-number">1</span>)).close(<span class="hljs-number">1000</span>);

    Assertions.assertThrows(RemotingException<span class="hljs-class">.<span class="hljs-keyword">class</span>, () -&gt; <span class="hljs-title">headerExchangeServer</span>.<span class="hljs-title">send</span>("<span class="hljs-title">test</span>"))</span>;

    Assertions.assertThrows(RemotingException<span class="hljs-class">.<span class="hljs-keyword">class</span>, () -&gt; <span class="hljs-title">headerExchangeServer</span>.<span class="hljs-title">send</span>("<span class="hljs-title">test</span>", <span class="hljs-title">true</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Channel <span class="hljs-title">createMockChannel</span><span class="hljs-params">(Object attributeValue)</span> </span>{
    Channel channel = Mockito.mock(Channel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(channel.getAttribute(HeaderExchangeChannel<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>() + ".<span class="hljs-title">CHANNEL</span>")).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">attributeValue</span>)</span>;
    <span class="hljs-keyword">return</span> channel;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci23">Mock Clone Instance #dubbo_MCI_23</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.model.ServiceDescriptor</code></li>
<li><strong>Test Case Count</strong>: 5</li>
<li><strong>MO Count</strong>: 5</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ServiceDescriptor serviceDescriptor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
serviceDescriptor;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest231">Test Case ID #dubbo_Test_23_1</h4>
<h4 id="test-case-name-unarycallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>unaryCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-servicedescriptor">Mock Object Variable Name: <code>serviceDescriptor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void unaryCall() throws Throwable {
     Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker.class);
     URL url = Mockito.mock(URL.class);
     ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);
<span class="hljs-deletion">-    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `serviceDescriptor`</span>
     when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
     when(url.getServiceModel()).thenReturn(consumerModel);
     when(url.getServiceInterface()).thenReturn(IGreeter.class.getName());
     when(url.getProtocolServiceKey()).thenReturn(IGreeter.class.getName());
     when(invoker.getUrl()).thenReturn(url);
     when(invoker.getInterface()).thenReturn(IGreeter.class);
     Result result = Mockito.mock(Result.class);
     when(invoker.invoke(any(Invocation.class))).thenReturn(result);
     String response = "response";
     when(result.recreate()).thenReturn(response);
     MethodDescriptor method = Mockito.mock(MethodDescriptor.class);
     when(method.getParameterClasses()).thenReturn(new Class[] { String.class });
     when(method.getMethodName()).thenReturn("sayHello");
     String request = "request";
     Object ret = StubInvocationUtil.unaryCall(invoker, method, request);
     Assertions.assertEquals(response, ret);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unaryCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">result</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(result.recreate()).thenReturn(response);

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    Object ret = StubInvocationUtil.unaryCall(invoker, method, request);

    Assertions.assertEquals(response, ret);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ServiceDescriptor serviceDescriptor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
serviceDescriptor;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest232">Test Case ID #dubbo_Test_23_2</h4>
<h4 id="test-case-name-unarycall2file-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>unaryCall2</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-servicedescriptor">Mock Object Variable Name: <code>serviceDescriptor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void unaryCall2() throws Throwable {
     Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker.class);
     URL url = Mockito.mock(URL.class);
     ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);
<span class="hljs-deletion">-    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `serviceDescriptor`</span>
     when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
     when(url.getServiceModel()).thenReturn(consumerModel);
     when(url.getServiceInterface()).thenReturn(IGreeter.class.getName());
     when(url.getProtocolServiceKey()).thenReturn(IGreeter.class.getName());
     when(invoker.getUrl()).thenReturn(url);
     when(invoker.getInterface()).thenReturn(IGreeter.class);
     Result result = Mockito.mock(Result.class);
     when(invoker.invoke(any(Invocation.class))).thenThrow(new RuntimeException("a")).thenThrow(new Error("b"));
     String response = "response";
     when(result.recreate()).thenReturn(response);
     MethodDescriptor method = Mockito.mock(MethodDescriptor.class);
     when(method.getParameterClasses()).thenReturn(new Class[] { String.class });
     when(method.getMethodName()).thenReturn("sayHello");
     String request = "request";
     try {
         StubInvocationUtil.unaryCall(invoker, method, request);
         fail();
     } catch (Throwable t) {
         // pass
     }
     try {
         StubInvocationUtil.unaryCall(invoker, method, request);
         fail();
     } catch (Throwable t) {
         // pass
     }
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unaryCall2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenThrow</span>(<span class="hljs-title">new</span> <span class="hljs-title">RuntimeException</span>("<span class="hljs-title">a</span>")).<span class="hljs-title">thenThrow</span>(<span class="hljs-title">new</span> <span class="hljs-title">Error</span>("<span class="hljs-title">b</span>"))</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(result.recreate()).thenReturn(response);

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    <span class="hljs-keyword">try</span> {

        StubInvocationUtil.unaryCall(invoker, method, request);

        fail();

    } <span class="hljs-keyword">catch</span> (Throwable t) {

        <span class="hljs-comment">// pass</span>

    }

    <span class="hljs-keyword">try</span> {

        StubInvocationUtil.unaryCall(invoker, method, request);

        fail();

    } <span class="hljs-keyword">catch</span> (Throwable t) {

        <span class="hljs-comment">// pass</span>

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ServiceDescriptor serviceDescriptor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
serviceDescriptor;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest233">Test Case ID #dubbo_Test_23_3</h4>
<h4 id="test-case-name-testunarycallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>testUnaryCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-servicedescriptor">Mock Object Variable Name: <code>serviceDescriptor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void testUnaryCall() throws Throwable {
     Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker.class);
     URL url = Mockito.mock(URL.class);
     ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);
<span class="hljs-deletion">-    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `serviceDescriptor`</span>
     when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
     when(url.getServiceModel()).thenReturn(consumerModel);
     when(url.getServiceInterface()).thenReturn(IGreeter.class.getName());
     when(url.getProtocolServiceKey()).thenReturn(IGreeter.class.getName());
     when(invoker.getUrl()).thenReturn(url);
     when(invoker.getInterface()).thenReturn(IGreeter.class);
     Result result = Mockito.mock(Result.class);
     String response = "response";
     when(invoker.invoke(any(Invocation.class))).then(invocationOnMock -&gt; result);
     when(result.recreate()).thenReturn(response);
     MethodDescriptor method = Mockito.mock(MethodDescriptor.class);
     when(method.getParameterClasses()).thenReturn(new Class[] { String.class });
     when(method.getMethodName()).thenReturn("sayHello");
     String request = "request";
     CountDownLatch latch = new CountDownLatch(1);
     AtomicReference&lt;Object&gt; atomicReference = new AtomicReference&lt;&gt;();
     StreamObserver&lt;Object&gt; responseObserver = new StreamObserver&lt;Object&gt;() {

         @Override
         public void onNext(Object data) {
             atomicReference.set(data);
         }

         @Override
         public void onError(Throwable throwable) {
         }

         @Override
         public void onCompleted() {
             latch.countDown();
         }
     };
     StubInvocationUtil.unaryCall(invoker, method, request, responseObserver);
     latch.await(1, TimeUnit.SECONDS);
     Assertions.assertEquals(response, atomicReference.get());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testUnaryCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">then</span>(<span class="hljs-title">invocationOnMock</span> -&gt; <span class="hljs-title">result</span>)</span>;

    when(result.recreate()).thenReturn(response);

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    AtomicReference&lt;Object&gt; atomicReference = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    StreamObserver&lt;Object&gt; responseObserver = <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

            atomicReference.set(data);

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

            latch.countDown();

        }

    };

    StubInvocationUtil.unaryCall(invoker, method, request, responseObserver);

    latch.await(<span class="hljs-number">1</span>, TimeUnit.SECONDS);

    Assertions.assertEquals(response, atomicReference.get());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ServiceDescriptor serviceDescriptor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
serviceDescriptor;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest234">Test Case ID #dubbo_Test_23_4</h4>
<h4 id="test-case-name-biorclientstreamcallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>biOrClientStreamCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-servicedescriptor">Mock Object Variable Name: <code>serviceDescriptor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);
<span class="hljs-deletion">-    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `serviceDescriptor`</span>
    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
    when(url.getServiceModel()).thenReturn(consumerModel);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">biOrClientStreamCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">then</span>(<span class="hljs-title">invocationOnMock</span> -&gt; </span>{

        Invocation invocation = (Invocation) invocationOnMock.getArguments()[<span class="hljs-number">0</span>];

        StreamObserver&lt;Object&gt; observer = (StreamObserver&lt;Object&gt;) invocation.getArguments()[<span class="hljs-number">0</span>];

        observer.onNext(response);

        observer.onCompleted();

        when(result.recreate()).then(invocationOnMock1 -&gt; <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



            <span class="hljs-meta">@Override</span>

            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

                observer.onNext(data);

            }



            <span class="hljs-meta">@Override</span>

            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

            }



            <span class="hljs-meta">@Override</span>

            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

                observer.onCompleted();

            }

        });

        <span class="hljs-keyword">return</span> result;

    });

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">11</span>);

    StreamObserver&lt;Object&gt; responseObserver = <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

            latch.countDown();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

            latch.countDown();

        }

    };

    StreamObserver&lt;Object&gt; observer = StubInvocationUtil.biOrClientStreamCall(invoker, method, responseObserver);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {

        observer.onNext(request);

    }

    observer.onCompleted();

    Assertions.assertTrue(latch.await(<span class="hljs-number">1</span>, TimeUnit.SECONDS));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ServiceDescriptor serviceDescriptor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
serviceDescriptor;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest235">Test Case ID #dubbo_Test_23_5</h4>
<h4 id="test-case-name-serverstreamcallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>serverStreamCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-servicedescriptor">Mock Object Variable Name: <code>serviceDescriptor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void serverStreamCall() throws InterruptedException {
     Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker.class);
     URL url = Mockito.mock(URL.class);
     ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);
<span class="hljs-deletion">-    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `serviceDescriptor`</span>
     when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
     when(url.getServiceModel()).thenReturn(consumerModel);
     when(url.getServiceInterface()).thenReturn(IGreeter.class.getName());
     when(url.getProtocolServiceKey()).thenReturn(IGreeter.class.getName());
     when(invoker.getUrl()).thenReturn(url);
     when(invoker.getInterface()).thenReturn(IGreeter.class);
     Result result = Mockito.mock(Result.class);
     String response = "response";
     when(invoker.invoke(any(Invocation.class))).then(invocationOnMock -&gt; {
         Invocation invocation = (Invocation) invocationOnMock.getArguments()[0];
         StreamObserver&lt;Object&gt; observer = (StreamObserver&lt;Object&gt;) invocation.getArguments()[1];
         for (int i = 0; i &lt; 10; i++) {
             observer.onNext(response);
         }
         observer.onCompleted();
         return result;
     });
     MethodDescriptor method = Mockito.mock(MethodDescriptor.class);
     when(method.getParameterClasses()).thenReturn(new Class[] { String.class });
     when(method.getMethodName()).thenReturn("sayHello");
     String request = "request";
     CountDownLatch latch = new CountDownLatch(11);
     StreamObserver&lt;Object&gt; responseObserver = new StreamObserver&lt;Object&gt;() {

         @Override
         public void onNext(Object data) {
             latch.countDown();
         }

         @Override
         public void onError(Throwable throwable) {
         }

         @Override
         public void onCompleted() {
             latch.countDown();
         }
     };
     StubInvocationUtil.serverStreamCall(invoker, method, request, responseObserver);
     Assertions.assertTrue(latch.await(1, TimeUnit.SECONDS));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">serverStreamCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">then</span>(<span class="hljs-title">invocationOnMock</span> -&gt; </span>{

        Invocation invocation = (Invocation) invocationOnMock.getArguments()[<span class="hljs-number">0</span>];

        StreamObserver&lt;Object&gt; observer = (StreamObserver&lt;Object&gt;) invocation.getArguments()[<span class="hljs-number">1</span>];

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {

            observer.onNext(response);

        }

        observer.onCompleted();

        <span class="hljs-keyword">return</span> result;

    });

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">11</span>);

    StreamObserver&lt;Object&gt; responseObserver = <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

            latch.countDown();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

            latch.countDown();

        }

    };

    StubInvocationUtil.serverStreamCall(invoker, method, request, responseObserver);

    Assertions.assertTrue(latch.await(<span class="hljs-number">1</span>, TimeUnit.SECONDS));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ServiceDescriptor serviceDescriptor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
serviceDescriptor;

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci24">Mock Clone Instance #dubbo_MCI_24</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.cluster.ClusterInvoker</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ClusterInvoker <span class="hljs-title">createMockClusterInvoker</span><span class="hljs-params">(DynamicDirectory directory, URL url, <span class="hljs-keyword">boolean</span> hasProxyInvokers, <span class="hljs-keyword">boolean</span> isAvailable)</span> </span>{
    ClusterInvoker invoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(invoker.getDirectory()).thenReturn(directory);
    Mockito.when(invoker.getUrl()).thenReturn(url);
    Mockito.when(invoker.hasProxyInvokers()).thenReturn(hasProxyInvokers);
    Mockito.when(invoker.isAvailable()).thenReturn(isAvailable);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest241">Test Case ID #dubbo_Test_24_1</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationinvokertestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol.class);
<span class="hljs-deletion">-    ClusterInvoker invoker = Mockito.mock(ClusterInvoker.class);</span>
<span class="hljs-addition">+    ClusterInvoker invoker = createMockClusterInvoker(directory, consumerURL, true, true);</span>
    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker.class);
    DynamicDirectory directory = Mockito.mock(DynamicDirectory.class);
    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory.class);
<span class="hljs-deletion">-    Mockito.when(invoker.getDirectory()).thenReturn(directory);</span>
    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);
<span class="hljs-deletion">-    Mockito.when(invoker.isAvailable()).thenReturn(true);</span>
    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(true);
<span class="hljs-deletion">-    Mockito.when(invoker.hasProxyInvokers()).thenReturn(true);</span>
    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(true);
    List&lt;Invoker&lt;?&gt;&gt; invokers = new LinkedList&lt;&gt;();
    invokers.add(Mockito.mock(Invoker.class));
    invokers.add(Mockito.mock(Invoker.class));
    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = new LinkedList&lt;&gt;();
    serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
    serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);
    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);
    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);
    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);
    URL consumerURL = Mockito.mock(URL.class);
    Mockito.when(consumerURL.getServiceInterface()).thenReturn("Test");
    Mockito.when(consumerURL.getGroup()).thenReturn("Group");
    Mockito.when(consumerURL.getVersion()).thenReturn("0.0.0");
    Mockito.when(consumerURL.getServiceKey()).thenReturn("Group/Test:0.0.0");
    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn("Test:0.0.0");
    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());
<span class="hljs-deletion">-    Mockito.when(invoker.getUrl()).thenReturn(consumerURL);</span>
    Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);
    MigrationInvoker&lt;?&gt; migrationInvoker = new MigrationInvoker&lt;&gt;(registryProtocol, null, null, DemoService.class, null, consumerURL);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"all"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker invoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory directory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(invoker.getDirectory()).thenReturn(directory);

    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);

    Mockito.when(invoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(invoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;Invoker&lt;?&gt;&gt; invokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);

    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);

    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);

    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceInterface()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getGroup()).thenReturn(<span class="hljs-string">"Group"</span>);

    Mockito.when(consumerURL.getVersion()).thenReturn(<span class="hljs-string">"0.0.0"</span>);

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Group/Test:0.0.0"</span>);

    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn(<span class="hljs-string">"Test:0.0.0"</span>);

    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());

    Mockito.when(invoker.getUrl()).thenReturn(consumerURL);

    Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);

    MigrationInvoker&lt;?&gt; migrationInvoker = <span class="hljs-keyword">new</span> MigrationInvoker&lt;&gt;(registryProtocol, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">null</span>, <span class="hljs-title">consumerURL</span>)</span>;

    MigrationRule migrationRule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">3</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">4</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">5</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">3</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">4</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">5</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">6</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">6</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">7</span>)).invoke(<span class="hljs-keyword">null</span>);

    Assertions.assertNull(migrationInvoker.getInvoker());

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">7</span>)).invoke(<span class="hljs-keyword">null</span>);

    Assertions.assertNull(migrationInvoker.getServiceDiscoveryInvoker());

    ArgumentCaptor&lt;InvokersChangedListener&gt; argument = ArgumentCaptor.forClass(InvokersChangedListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(serviceDiscoveryDirectory, Mockito.atLeastOnce()).setInvokersChangedListener(argument.capture());

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">27</span>)).invoke(<span class="hljs-keyword">null</span>);

    serviceDiscoveryInvokers.remove(<span class="hljs-number">1</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">false</span>);

    argument.getAllValues().get(argument.getAllValues().size() - <span class="hljs-number">1</span>).onChange();

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">27</span>)).invoke(<span class="hljs-keyword">null</span>);

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    argument.getAllValues().get(argument.getAllValues().size() - <span class="hljs-number">1</span>).onChange();

    Mockito.when(migrationRule.getProportion(Mockito.any())).thenReturn(<span class="hljs-number">50</span>);

    migrationInvoker.setMigrationRule(migrationRule);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(serviceDiscoveryInvoker, Mockito.atMost(<span class="hljs-number">1026</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.atLeast(<span class="hljs-number">28</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getDelay(Mockito.any())).thenReturn(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">long</span> currentTimeMillis = System.currentTimeMillis();

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    Assertions.assertTrue(System.currentTimeMillis() - currentTimeMillis &gt;= <span class="hljs-number">2000</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ClusterInvoker <span class="hljs-title">createMockClusterInvoker</span><span class="hljs-params">(DynamicDirectory directory, URL url, <span class="hljs-keyword">boolean</span> hasProxyInvokers, <span class="hljs-keyword">boolean</span> isAvailable)</span> </span>{
    ClusterInvoker invoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(invoker.getDirectory()).thenReturn(directory);
    Mockito.when(invoker.getUrl()).thenReturn(url);
    Mockito.when(invoker.hasProxyInvokers()).thenReturn(hasProxyInvokers);
    Mockito.when(invoker.isAvailable()).thenReturn(isAvailable);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest242">Test Case ID #dubbo_Test_24_2</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationinvokertestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-servicediscoveryinvoker">Mock Object Variable Name: <code>serviceDiscoveryInvoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol.class);
    ClusterInvoker invoker = Mockito.mock(ClusterInvoker.class);
<span class="hljs-deletion">-    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker.class);</span>
    DynamicDirectory directory = Mockito.mock(DynamicDirectory.class);
    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory.class);
    Mockito.when(invoker.getDirectory()).thenReturn(directory);
<span class="hljs-deletion">-    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);</span>
    Mockito.when(invoker.isAvailable()).thenReturn(true);
<span class="hljs-deletion">-    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(true);</span>
    Mockito.when(invoker.hasProxyInvokers()).thenReturn(true);
<span class="hljs-deletion">-    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(true);</span>
    List&lt;Invoker&lt;?&gt;&gt; invokers = new LinkedList&lt;&gt;();
    invokers.add(Mockito.mock(Invoker.class));
    invokers.add(Mockito.mock(Invoker.class));
    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = new LinkedList&lt;&gt;();
    serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
    serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);
    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);
    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);
    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);
    URL consumerURL = Mockito.mock(URL.class);
    Mockito.when(consumerURL.getServiceInterface()).thenReturn("Test");
    Mockito.when(consumerURL.getGroup()).thenReturn("Group");
    Mockito.when(consumerURL.getVersion()).thenReturn("0.0.0");
    Mockito.when(consumerURL.getServiceKey()).thenReturn("Group/Test:0.0.0");
    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn("Test:0.0.0");
    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());
    Mockito.when(invoker.getUrl()).thenReturn(consumerURL);
<span class="hljs-deletion">-    Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);</span>
<span class="hljs-addition">+    ClusterInvoker serviceDiscoveryInvoker = createMockClusterInvoker(serviceDiscoveryDirectory, consumerURL, true, true);</span>
    MigrationInvoker&lt;?&gt; migrationInvoker = new MigrationInvoker&lt;&gt;(registryProtocol, null, null, DemoService.class, null, consumerURL);
    MigrationRule migrationRule = Mockito.mock(MigrationRule.class);
    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(true);
    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);
    migrationInvoker.invoke(null);
    Mockito.verify(invoker, Mockito.times(1)).invoke(null);
    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);
    migrationInvoker.invoke(null);
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(1)).invoke(null);
    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(1.0f);
    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);
    migrationInvoker.invoke(null);
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(2)).invoke(null);
    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(2.0f);
    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);
    migrationInvoker.invoke(null);
    Mockito.verify(invoker, Mockito.times(2)).invoke(null);
    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(false);
    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(1.0f);
    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);
    migrationInvoker.invoke(null);
    Mockito.verify(invoker, Mockito.times(3)).invoke(null);
    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);
    migrationInvoker.invoke(null);
    Mockito.verify(invoker, Mockito.times(4)).invoke(null);
    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(2.0f);
    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);
    migrationInvoker.invoke(null);
    Mockito.verify(invoker, Mockito.times(5)).invoke(null);
    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(1.0f);
    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);
    migrationInvoker.invoke(null);
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(3)).invoke(null);
    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);
    migrationInvoker.invoke(null);
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(4)).invoke(null);
    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(2.0f);
    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);
    migrationInvoker.invoke(null);
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(5)).invoke(null);
    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(2.0f);
    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(true);
    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);
    migrationInvoker.invoke(null);
    Mockito.verify(invoker, Mockito.times(6)).invoke(null);
    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);
    migrationInvoker.invoke(null);
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(6)).invoke(null);
    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(false);
    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);
    migrationInvoker.invoke(null);
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(7)).invoke(null);
    Assertions.assertNull(migrationInvoker.getInvoker());
    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(true);
    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);
    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(false);
    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);
    migrationInvoker.invoke(null);
    Mockito.verify(invoker, Mockito.times(7)).invoke(null);
    Assertions.assertNull(migrationInvoker.getServiceDiscoveryInvoker());
    ArgumentCaptor&lt;InvokersChangedListener&gt; argument = ArgumentCaptor.forClass(InvokersChangedListener.class);
    Mockito.verify(serviceDiscoveryDirectory, Mockito.atLeastOnce()).setInvokersChangedListener(argument.capture());
    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(1.0f);
    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);
    for (int i = 0; i &lt; 20; i++) {
        migrationInvoker.invoke(null);
    }
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(27)).invoke(null);
    serviceDiscoveryInvokers.remove(1);
<span class="hljs-deletion">-    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(false);</span>
<span class="hljs-addition">+    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(false);</span>
    argument.getAllValues().get(argument.getAllValues().size() - 1).onChange();
    for (int i = 0; i &lt; 20; i++) {
        migrationInvoker.invoke(null);
    }
    Mockito.verify(invoker, Mockito.times(27)).invoke(null);
    serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
<span class="hljs-deletion">-    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(true);</span>
<span class="hljs-addition">+    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(true);</span>
    argument.getAllValues().get(argument.getAllValues().size() - 1).onChange();
    Mockito.when(migrationRule.getProportion(Mockito.any())).thenReturn(50);
    migrationInvoker.setMigrationRule(migrationRule);
    for (int i = 0; i &lt; 1000; i++) {
        migrationInvoker.invoke(null);
    }
    Mockito.verify(serviceDiscoveryInvoker, Mockito.atMost(1026)).invoke(null);
    Mockito.verify(invoker, Mockito.atLeast(28)).invoke(null);
    Mockito.when(migrationRule.getDelay(Mockito.any())).thenReturn(1);
    long currentTimeMillis = System.currentTimeMillis();
    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);
    Assertions.assertTrue(System.currentTimeMillis() - currentTimeMillis &gt;= 2000);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"all"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker invoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory directory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(invoker.getDirectory()).thenReturn(directory);

    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);

    Mockito.when(invoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(invoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;Invoker&lt;?&gt;&gt; invokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);

    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);

    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);

    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceInterface()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getGroup()).thenReturn(<span class="hljs-string">"Group"</span>);

    Mockito.when(consumerURL.getVersion()).thenReturn(<span class="hljs-string">"0.0.0"</span>);

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Group/Test:0.0.0"</span>);

    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn(<span class="hljs-string">"Test:0.0.0"</span>);

    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());

    Mockito.when(invoker.getUrl()).thenReturn(consumerURL);

    Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);

    MigrationInvoker&lt;?&gt; migrationInvoker = <span class="hljs-keyword">new</span> MigrationInvoker&lt;&gt;(registryProtocol, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">null</span>, <span class="hljs-title">consumerURL</span>)</span>;

    MigrationRule migrationRule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">3</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">4</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">5</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">3</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">4</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">5</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">6</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">6</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">7</span>)).invoke(<span class="hljs-keyword">null</span>);

    Assertions.assertNull(migrationInvoker.getInvoker());

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">7</span>)).invoke(<span class="hljs-keyword">null</span>);

    Assertions.assertNull(migrationInvoker.getServiceDiscoveryInvoker());

    ArgumentCaptor&lt;InvokersChangedListener&gt; argument = ArgumentCaptor.forClass(InvokersChangedListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(serviceDiscoveryDirectory, Mockito.atLeastOnce()).setInvokersChangedListener(argument.capture());

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">27</span>)).invoke(<span class="hljs-keyword">null</span>);

    serviceDiscoveryInvokers.remove(<span class="hljs-number">1</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">false</span>);

    argument.getAllValues().get(argument.getAllValues().size() - <span class="hljs-number">1</span>).onChange();

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">27</span>)).invoke(<span class="hljs-keyword">null</span>);

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    argument.getAllValues().get(argument.getAllValues().size() - <span class="hljs-number">1</span>).onChange();

    Mockito.when(migrationRule.getProportion(Mockito.any())).thenReturn(<span class="hljs-number">50</span>);

    migrationInvoker.setMigrationRule(migrationRule);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(serviceDiscoveryInvoker, Mockito.atMost(<span class="hljs-number">1026</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.atLeast(<span class="hljs-number">28</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getDelay(Mockito.any())).thenReturn(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">long</span> currentTimeMillis = System.currentTimeMillis();

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    Assertions.assertTrue(System.currentTimeMillis() - currentTimeMillis &gt;= <span class="hljs-number">2000</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ClusterInvoker <span class="hljs-title">createMockClusterInvoker</span><span class="hljs-params">(DynamicDirectory directory, URL url, <span class="hljs-keyword">boolean</span> hasProxyInvokers, <span class="hljs-keyword">boolean</span> isAvailable)</span> </span>{
    ClusterInvoker invoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(invoker.getDirectory()).thenReturn(directory);
    Mockito.when(invoker.getUrl()).thenReturn(url);
    Mockito.when(invoker.hasProxyInvokers()).thenReturn(hasProxyInvokers);
    Mockito.when(invoker.isAvailable()).thenReturn(isAvailable);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest243">Test Case ID #dubbo_Test_24_3</h4>
<h4 id="test-case-name-testdecidefile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationinvokertestjava">Test Case Name: <code>testDecide</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol.class);
<span class="hljs-deletion">-    ClusterInvoker invoker = Mockito.mock(ClusterInvoker.class);</span>
<span class="hljs-addition">+    ClusterInvoker invoker = createMockClusterInvoker(directory, consumerURL, true, true);</span>
    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker.class);
    DynamicDirectory directory = Mockito.mock(DynamicDirectory.class);
    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory.class);
<span class="hljs-deletion">-    Mockito.when(invoker.getDirectory()).thenReturn(directory);</span>
    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);
<span class="hljs-deletion">-    Mockito.when(invoker.isAvailable()).thenReturn(true);</span>
    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(true);
<span class="hljs-deletion">-    Mockito.when(invoker.hasProxyInvokers()).thenReturn(true);</span>
    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(true);
    List&lt;Invoker&lt;?&gt;&gt; invokers = new LinkedList&lt;&gt;();
    invokers.add(Mockito.mock(Invoker.class));
    invokers.add(Mockito.mock(Invoker.class));
    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = new LinkedList&lt;&gt;();
    serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
    serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);
    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);
    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);
    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);
    URL consumerURL = Mockito.mock(URL.class);
    Mockito.when(consumerURL.getServiceInterface()).thenReturn("Test");
    Mockito.when(consumerURL.getGroup()).thenReturn("Group");
    Mockito.when(consumerURL.getVersion()).thenReturn("0.0.0");
    Mockito.when(consumerURL.getServiceKey()).thenReturn("Group/Test:0.0.0");
    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn("Test:0.0.0");
    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());
<span class="hljs-deletion">-    Mockito.when(invoker.getUrl()).thenReturn(consumerURL);</span>
    Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);
    MigrationInvoker&lt;?&gt; migrationInvoker = new MigrationInvoker&lt;&gt;(registryProtocol, null, null, DemoService.class, null, consumerURL);
    MigrationRule migrationRule = Mockito.mock(MigrationRule.class);
    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(true);
    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);
    migrationInvoker.invoke(null);
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(1)).invoke(null);
    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(false);
    migrationInvoker.invoke(null);
    Mockito.verify(invoker, Mockito.times(1)).invoke(null);
    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(true);
    migrationInvoker.invoke(null);
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(2)).invoke(null);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"all"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testDecide</span><span class="hljs-params">()</span> </span>{

    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker invoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory directory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(invoker.getDirectory()).thenReturn(directory);

    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);

    Mockito.when(invoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(invoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;Invoker&lt;?&gt;&gt; invokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);

    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);

    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);

    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceInterface()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getGroup()).thenReturn(<span class="hljs-string">"Group"</span>);

    Mockito.when(consumerURL.getVersion()).thenReturn(<span class="hljs-string">"0.0.0"</span>);

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Group/Test:0.0.0"</span>);

    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn(<span class="hljs-string">"Test:0.0.0"</span>);

    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());

    Mockito.when(invoker.getUrl()).thenReturn(consumerURL);

    Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);

    MigrationInvoker&lt;?&gt; migrationInvoker = <span class="hljs-keyword">new</span> MigrationInvoker&lt;&gt;(registryProtocol, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">null</span>, <span class="hljs-title">consumerURL</span>)</span>;

    MigrationRule migrationRule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ClusterInvoker <span class="hljs-title">createMockClusterInvoker</span><span class="hljs-params">(DynamicDirectory directory, URL url, <span class="hljs-keyword">boolean</span> hasProxyInvokers, <span class="hljs-keyword">boolean</span> isAvailable)</span> </span>{
    ClusterInvoker invoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(invoker.getDirectory()).thenReturn(directory);
    Mockito.when(invoker.getUrl()).thenReturn(url);
    Mockito.when(invoker.hasProxyInvokers()).thenReturn(hasProxyInvokers);
    Mockito.when(invoker.isAvailable()).thenReturn(isAvailable);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest244">Test Case ID #dubbo_Test_24_4</h4>
<h4 id="test-case-name-testdecidefile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationinvokertestjava">Test Case Name: <code>testDecide</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-servicediscoveryinvoker">Mock Object Variable Name: <code>serviceDiscoveryInvoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ClusterInvoker invoker = Mockito.mock(ClusterInvoker.class);
<span class="hljs-deletion">-    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker.class);</span>
    DynamicDirectory directory = Mockito.mock(DynamicDirectory.class);
    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory.class);
    Mockito.when(invoker.getDirectory()).thenReturn(directory);
<span class="hljs-deletion">-    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);</span>
    Mockito.when(invoker.isAvailable()).thenReturn(true);
<span class="hljs-deletion">-    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(true);</span>
    Mockito.when(invoker.hasProxyInvokers()).thenReturn(true);
<span class="hljs-deletion">-    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(true);</span>
    List&lt;Invoker&lt;?&gt;&gt; invokers = new LinkedList&lt;&gt;();
    invokers.add(Mockito.mock(Invoker.class));
    invokers.add(Mockito.mock(Invoker.class));
    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = new LinkedList&lt;&gt;();
    serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
    serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);
    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);
    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);
<span class="hljs-deletion">-    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);</span>
<span class="hljs-addition">+    ClusterInvoker serviceDiscoveryInvoker = createMockClusterInvoker(serviceDiscoveryDirectory, consumerURL, true, true);</span>
<span class="hljs-addition">+    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);</span>
    URL consumerURL = Mockito.mock(URL.class);
    Mockito.when(consumerURL.getServiceInterface()).thenReturn("Test");
    Mockito.when(consumerURL.getGroup()).thenReturn("Group");
    Mockito.when(consumerURL.getVersion()).thenReturn("0.0.0");
    Mockito.when(consumerURL.getServiceKey()).thenReturn("Group/Test:0.0.0");
    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn("Test:0.0.0");
    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());
    Mockito.when(invoker.getUrl()).thenReturn(consumerURL);
<span class="hljs-deletion">-    Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);</span>
    MigrationInvoker&lt;?&gt; migrationInvoker = new MigrationInvoker&lt;&gt;(registryProtocol, null, null, DemoService.class, null, consumerURL);
    MigrationRule migrationRule = Mockito.mock(MigrationRule.class);
    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(true);
    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);
    migrationInvoker.invoke(null);
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(1)).invoke(null);
    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(false);
    migrationInvoker.invoke(null);
    Mockito.verify(invoker, Mockito.times(1)).invoke(null);
    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(true);
    migrationInvoker.invoke(null);
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(2)).invoke(null);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"all"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testDecide</span><span class="hljs-params">()</span> </span>{

    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker invoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory directory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(invoker.getDirectory()).thenReturn(directory);

    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);

    Mockito.when(invoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(invoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;Invoker&lt;?&gt;&gt; invokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);

    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);

    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);

    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceInterface()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getGroup()).thenReturn(<span class="hljs-string">"Group"</span>);

    Mockito.when(consumerURL.getVersion()).thenReturn(<span class="hljs-string">"0.0.0"</span>);

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Group/Test:0.0.0"</span>);

    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn(<span class="hljs-string">"Test:0.0.0"</span>);

    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());

    Mockito.when(invoker.getUrl()).thenReturn(consumerURL);

    Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);

    MigrationInvoker&lt;?&gt; migrationInvoker = <span class="hljs-keyword">new</span> MigrationInvoker&lt;&gt;(registryProtocol, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">null</span>, <span class="hljs-title">consumerURL</span>)</span>;

    MigrationRule migrationRule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ClusterInvoker <span class="hljs-title">createMockClusterInvoker</span><span class="hljs-params">(DynamicDirectory directory, URL url, <span class="hljs-keyword">boolean</span> hasProxyInvokers, <span class="hljs-keyword">boolean</span> isAvailable)</span> </span>{
    ClusterInvoker invoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(invoker.getDirectory()).thenReturn(directory);
    Mockito.when(invoker.getUrl()).thenReturn(url);
    Mockito.when(invoker.hasProxyInvokers()).thenReturn(hasProxyInvokers);
    Mockito.when(invoker.isAvailable()).thenReturn(isAvailable);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci25">Mock Clone Instance #dubbo_MCI_25</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.cluster.ClusterInvoker</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ClusterInvoker <span class="hljs-title">createMockClusterInvoker</span><span class="hljs-params">(URL url, <span class="hljs-keyword">boolean</span> hasProxyInvokers)</span> </span>{
    ClusterInvoker mockClusterInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(mockClusterInvoker.getUrl()).thenReturn(url);
    Mockito.when(mockClusterInvoker.hasProxyInvokers()).thenReturn(hasProxyInvokers);
    <span class="hljs-keyword">return</span> mockClusterInvoker;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest251">Test Case ID #dubbo_Test_25_1</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationdefaultmigrationaddresscomparatortestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\DefaultMigrationAddressComparatorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-newinvoker">Mock Object Variable Name: <code>newInvoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    DefaultMigrationAddressComparator comparator = new DefaultMigrationAddressComparator();
<span class="hljs-deletion">-    ClusterInvoker newInvoker = Mockito.mock(ClusterInvoker.class);</span>
<span class="hljs-addition">+    ClusterInvoker newInvoker = createMockClusterInvoker(url, false);</span>
    ClusterInvoker oldInvoker = Mockito.mock(ClusterInvoker.class);
    Directory newDirectory = Mockito.mock(Directory.class);
    Directory oldDirectory = Mockito.mock(Directory.class);
    MigrationRule rule = Mockito.mock(MigrationRule.class);
    URL url = Mockito.mock(URL.class);
    Mockito.when(url.getDisplayServiceKey()).thenReturn("test");
<span class="hljs-deletion">-    Mockito.when(newInvoker.getDirectory()).thenReturn(newDirectory);</span>
<span class="hljs-addition">+    Mockito.when(newInvoker.getDirectory()).thenReturn(newDirectory);</span>
    Mockito.when(oldInvoker.getDirectory()).thenReturn(oldDirectory);
<span class="hljs-deletion">-    Mockito.when(newInvoker.getUrl()).thenReturn(url);</span>
    Mockito.when(oldInvoker.getUrl()).thenReturn(url);
<span class="hljs-deletion">-    Mockito.when(newInvoker.hasProxyInvokers()).thenReturn(false);</span>
    Mockito.when(newDirectory.getAllInvokers()).thenReturn(Collections.emptyList());
    Assertions.assertFalse(comparator.shouldMigrate(newInvoker, oldInvoker, rule));
    Assertions.assertEquals(-1, comparator.getAddressSize("test").get(NEW_ADDRESS_SIZE));
    Assertions.assertEquals(0, comparator.getAddressSize("test").get(OLD_ADDRESS_SIZE));
    Mockito.when(newInvoker.hasProxyInvokers()).thenReturn(true);
    Mockito.when(oldInvoker.hasProxyInvokers()).thenReturn(false);
    Mockito.when(oldDirectory.getAllInvokers()).thenReturn(Collections.emptyList());
    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, rule));
    Assertions.assertEquals(0, comparator.getAddressSize("test").get(NEW_ADDRESS_SIZE));
    Assertions.assertEquals(-1, comparator.getAddressSize("test").get(OLD_ADDRESS_SIZE));
    Mockito.when(oldInvoker.hasProxyInvokers()).thenReturn(true);
    List&lt;Invoker&lt;?&gt;&gt; newInvokerList = new LinkedList&lt;&gt;();
    newInvokerList.add(Mockito.mock(Invoker.class));
    newInvokerList.add(Mockito.mock(Invoker.class));
    newInvokerList.add(Mockito.mock(Invoker.class));
    Mockito.when(newDirectory.getAllInvokers()).thenReturn(newInvokerList);
    List&lt;Invoker&lt;?&gt;&gt; oldInvokerList = new LinkedList&lt;&gt;();
    oldInvokerList.add(Mockito.mock(Invoker.class));
    oldInvokerList.add(Mockito.mock(Invoker.class));
    Mockito.when(oldDirectory.getAllInvokers()).thenReturn(oldInvokerList);
    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, null));
    Mockito.when(rule.getThreshold(url)).thenReturn(0.5f);
    newInvokerList.clear();
    newInvokerList.add(Mockito.mock(Invoker.class));
    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, rule));
    newInvokerList.clear();
    // hasProxyInvokers will check if invokers list is empty
    // if hasProxyInvokers return true, comparator will directly because default threshold is 0.0
    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, null));
    Assertions.assertFalse(comparator.shouldMigrate(newInvoker, oldInvoker, rule));
    Assertions.assertEquals(0, comparator.getAddressSize("test").get(NEW_ADDRESS_SIZE));
    Assertions.assertEquals(2, comparator.getAddressSize("test").get(OLD_ADDRESS_SIZE));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"all"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    DefaultMigrationAddressComparator comparator = <span class="hljs-keyword">new</span> DefaultMigrationAddressComparator();

    ClusterInvoker newInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker oldInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Directory newDirectory = Mockito.mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Directory oldDirectory = Mockito.mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRule rule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(url.getDisplayServiceKey()).thenReturn(<span class="hljs-string">"test"</span>);

    Mockito.when(newInvoker.getDirectory()).thenReturn(newDirectory);

    Mockito.when(oldInvoker.getDirectory()).thenReturn(oldDirectory);

    Mockito.when(newInvoker.getUrl()).thenReturn(url);

    Mockito.when(oldInvoker.getUrl()).thenReturn(url);

    Mockito.when(newInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(newDirectory.getAllInvokers()).thenReturn(Collections.emptyList());

    Assertions.assertFalse(comparator.shouldMigrate(newInvoker, oldInvoker, rule));

    Assertions.assertEquals(-<span class="hljs-number">1</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(NEW_ADDRESS_SIZE));

    Assertions.assertEquals(<span class="hljs-number">0</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(OLD_ADDRESS_SIZE));

    Mockito.when(newInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(oldInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(oldDirectory.getAllInvokers()).thenReturn(Collections.emptyList());

    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, rule));

    Assertions.assertEquals(<span class="hljs-number">0</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(NEW_ADDRESS_SIZE));

    Assertions.assertEquals(-<span class="hljs-number">1</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(OLD_ADDRESS_SIZE));

    Mockito.when(oldInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;Invoker&lt;?&gt;&gt; newInvokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    newInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    newInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    newInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(newDirectory.getAllInvokers()).thenReturn(newInvokerList);

    List&lt;Invoker&lt;?&gt;&gt; oldInvokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    oldInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    oldInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(oldDirectory.getAllInvokers()).thenReturn(oldInvokerList);

    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, <span class="hljs-keyword">null</span>));

    Mockito.when(rule.getThreshold(url)).thenReturn(<span class="hljs-number">0.5f</span>);

    newInvokerList.clear();

    newInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, rule));

    newInvokerList.clear();

    <span class="hljs-comment">// hasProxyInvokers will check if invokers list is empty</span>

    <span class="hljs-comment">// if hasProxyInvokers return true, comparator will directly because default threshold is 0.0</span>

    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, <span class="hljs-keyword">null</span>));

    Assertions.assertFalse(comparator.shouldMigrate(newInvoker, oldInvoker, rule));

    Assertions.assertEquals(<span class="hljs-number">0</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(NEW_ADDRESS_SIZE));

    Assertions.assertEquals(<span class="hljs-number">2</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(OLD_ADDRESS_SIZE));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ClusterInvoker <span class="hljs-title">createMockClusterInvoker</span><span class="hljs-params">(URL url, <span class="hljs-keyword">boolean</span> hasProxyInvokers)</span> </span>{
    ClusterInvoker mockClusterInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(mockClusterInvoker.getUrl()).thenReturn(url);
    Mockito.when(mockClusterInvoker.hasProxyInvokers()).thenReturn(hasProxyInvokers);
    <span class="hljs-keyword">return</span> mockClusterInvoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest252">Test Case ID #dubbo_Test_25_2</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationdefaultmigrationaddresscomparatortestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\DefaultMigrationAddressComparatorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-oldinvoker">Mock Object Variable Name: <code>oldInvoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ClusterInvoker newInvoker = Mockito.mock(ClusterInvoker.class);
<span class="hljs-deletion">-    ClusterInvoker oldInvoker = Mockito.mock(ClusterInvoker.class);</span>
<span class="hljs-addition">+    ClusterInvoker oldInvoker = createMockClusterInvoker(url, false);</span>
    Directory newDirectory = Mockito.mock(Directory.class);
    Directory oldDirectory = Mockito.mock(Directory.class);
    MigrationRule rule = Mockito.mock(MigrationRule.class);
    URL url = Mockito.mock(URL.class);
    Mockito.when(url.getDisplayServiceKey()).thenReturn("test");
    Mockito.when(newInvoker.getDirectory()).thenReturn(newDirectory);
<span class="hljs-deletion">-    Mockito.when(oldInvoker.getDirectory()).thenReturn(oldDirectory);</span>
<span class="hljs-addition">+    Mockito.when(oldInvoker.getDirectory()).thenReturn(oldDirectory);</span>
    Mockito.when(newInvoker.getUrl()).thenReturn(url);
<span class="hljs-deletion">-    Mockito.when(oldInvoker.getUrl()).thenReturn(url);</span>
    Mockito.when(newInvoker.hasProxyInvokers()).thenReturn(false);
    Mockito.when(newDirectory.getAllInvokers()).thenReturn(Collections.emptyList());
    Assertions.assertFalse(comparator.shouldMigrate(newInvoker, oldInvoker, rule));
    Assertions.assertEquals(-1, comparator.getAddressSize("test").get(NEW_ADDRESS_SIZE));
    Assertions.assertEquals(0, comparator.getAddressSize("test").get(OLD_ADDRESS_SIZE));
    Mockito.when(newInvoker.hasProxyInvokers()).thenReturn(true);
    Mockito.when(oldDirectory.getAllInvokers()).thenReturn(Collections.emptyList());
    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, rule));
    Assertions.assertEquals(0, comparator.getAddressSize("test").get(NEW_ADDRESS_SIZE));
    Assertions.assertEquals(-1, comparator.getAddressSize("test").get(OLD_ADDRESS_SIZE));
<span class="hljs-deletion">-    Mockito.when(oldInvoker.hasProxyInvokers()).thenReturn(true);</span>
<span class="hljs-addition">+    Mockito.when(oldInvoker.hasProxyInvokers()).thenReturn(true);</span>
    List&lt;Invoker&lt;?&gt;&gt; newInvokerList = new LinkedList&lt;&gt;();
    newInvokerList.add(Mockito.mock(Invoker.class));
    newInvokerList.add(Mockito.mock(Invoker.class));
    newInvokerList.add(Mockito.mock(Invoker.class));
    Mockito.when(newDirectory.getAllInvokers()).thenReturn(newInvokerList);
    List&lt;Invoker&lt;?&gt;&gt; oldInvokerList = new LinkedList&lt;&gt;();
    oldInvokerList.add(Mockito.mock(Invoker.class));
    oldInvokerList.add(Mockito.mock(Invoker.class));
    Mockito.when(oldDirectory.getAllInvokers()).thenReturn(oldInvokerList);
    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, null));
    Mockito.when(rule.getThreshold(url)).thenReturn(0.5f);
    newInvokerList.clear();
    newInvokerList.add(Mockito.mock(Invoker.class));
    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, rule));
    newInvokerList.clear();
    // hasProxyInvokers will check if invokers list is empty
    // if hasProxyInvokers return true, comparator will directly because default threshold is 0.0
    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, null));
    Assertions.assertFalse(comparator.shouldMigrate(newInvoker, oldInvoker, rule));
    Assertions.assertEquals(0, comparator.getAddressSize("test").get(NEW_ADDRESS_SIZE));
    Assertions.assertEquals(2, comparator.getAddressSize("test").get(OLD_ADDRESS_SIZE));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"all"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    DefaultMigrationAddressComparator comparator = <span class="hljs-keyword">new</span> DefaultMigrationAddressComparator();

    ClusterInvoker newInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker oldInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Directory newDirectory = Mockito.mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Directory oldDirectory = Mockito.mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRule rule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(url.getDisplayServiceKey()).thenReturn(<span class="hljs-string">"test"</span>);

    Mockito.when(newInvoker.getDirectory()).thenReturn(newDirectory);

    Mockito.when(oldInvoker.getDirectory()).thenReturn(oldDirectory);

    Mockito.when(newInvoker.getUrl()).thenReturn(url);

    Mockito.when(oldInvoker.getUrl()).thenReturn(url);

    Mockito.when(newInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(newDirectory.getAllInvokers()).thenReturn(Collections.emptyList());

    Assertions.assertFalse(comparator.shouldMigrate(newInvoker, oldInvoker, rule));

    Assertions.assertEquals(-<span class="hljs-number">1</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(NEW_ADDRESS_SIZE));

    Assertions.assertEquals(<span class="hljs-number">0</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(OLD_ADDRESS_SIZE));

    Mockito.when(newInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(oldInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(oldDirectory.getAllInvokers()).thenReturn(Collections.emptyList());

    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, rule));

    Assertions.assertEquals(<span class="hljs-number">0</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(NEW_ADDRESS_SIZE));

    Assertions.assertEquals(-<span class="hljs-number">1</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(OLD_ADDRESS_SIZE));

    Mockito.when(oldInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;Invoker&lt;?&gt;&gt; newInvokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    newInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    newInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    newInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(newDirectory.getAllInvokers()).thenReturn(newInvokerList);

    List&lt;Invoker&lt;?&gt;&gt; oldInvokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    oldInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    oldInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(oldDirectory.getAllInvokers()).thenReturn(oldInvokerList);

    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, <span class="hljs-keyword">null</span>));

    Mockito.when(rule.getThreshold(url)).thenReturn(<span class="hljs-number">0.5f</span>);

    newInvokerList.clear();

    newInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, rule));

    newInvokerList.clear();

    <span class="hljs-comment">// hasProxyInvokers will check if invokers list is empty</span>

    <span class="hljs-comment">// if hasProxyInvokers return true, comparator will directly because default threshold is 0.0</span>

    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, <span class="hljs-keyword">null</span>));

    Assertions.assertFalse(comparator.shouldMigrate(newInvoker, oldInvoker, rule));

    Assertions.assertEquals(<span class="hljs-number">0</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(NEW_ADDRESS_SIZE));

    Assertions.assertEquals(<span class="hljs-number">2</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(OLD_ADDRESS_SIZE));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ClusterInvoker <span class="hljs-title">createMockClusterInvoker</span><span class="hljs-params">(URL url, <span class="hljs-keyword">boolean</span> hasProxyInvokers)</span> </span>{
    ClusterInvoker mockClusterInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(mockClusterInvoker.getUrl()).thenReturn(url);
    Mockito.when(mockClusterInvoker.hasProxyInvokers()).thenReturn(hasProxyInvokers);
    <span class="hljs-keyword">return</span> mockClusterInvoker;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci26">Mock Clone Instance #dubbo_MCI_26</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.common.config.CompositeConfiguration</code></li>
<li><strong>Test Case Count</strong>: 7</li>
<li><strong>MO Count</strong>: 7</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CompositeConfiguration <span class="hljs-title">createMockCompositeConfiguration</span><span class="hljs-params">()</span> </span>{
    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;
    <span class="hljs-keyword">return</span> compositeConfiguration;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest261">Test Case ID #dubbo_Test_26_1</h4>
<h4 id="test-case-name-testconsumerurlwithoutprotocolfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testConsumerUrlWithoutProtocol</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-compositeconfiguration">Mock Object Variable Name: <code>compositeConfiguration</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ConfigManager configManager = mock(ConfigManager.class);
    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);
<span class="hljs-deletion">-    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration.class);</span>
<span class="hljs-deletion">-    when(compositeConfiguration.convert(Boolean.class, ENABLE_CONFIGURATION_LISTEN, true)).thenReturn(true);</span>
<span class="hljs-addition">+    CompositeConfiguration compositeConfiguration = createMockCompositeConfiguration();</span>
    Map&lt;String, String&gt; parameters = new HashMap&lt;&gt;();
    parameters.put(INTERFACE_KEY, DemoService.class.getName());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify the generated consumer url information

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumerUrlWithoutProtocol</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    <span class="hljs-comment">// verify that the protocol header of consumerUrl is set to "consumer"</span>

    Assertions.assertEquals(<span class="hljs-string">"consumer"</span>, consumerUrl.getProtocol());

    Assertions.assertEquals(parameters.get(REGISTER_IP_KEY), consumerUrl.getHost());

    Assertions.assertFalse(consumerUrl.getAttributes().containsKey(REFER_KEY));

    Assertions.assertEquals(<span class="hljs-string">"value1"</span>, consumerUrl.getAttribute(<span class="hljs-string">"key1"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CompositeConfiguration <span class="hljs-title">createMockCompositeConfiguration</span><span class="hljs-params">()</span> </span>{
    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;
    <span class="hljs-keyword">return</span> compositeConfiguration;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest262">Test Case ID #dubbo_Test_26_2</h4>
<h4 id="test-case-name-testconsumerurlwithprotocolfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testConsumerUrlWithProtocol</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-compositeconfiguration">Mock Object Variable Name: <code>compositeConfiguration</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);
<span class="hljs-deletion">-    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration.class);</span>
<span class="hljs-deletion">-    when(compositeConfiguration.convert(Boolean.class, ENABLE_CONFIGURATION_LISTEN, true)).thenReturn(true);</span>
<span class="hljs-addition">+    CompositeConfiguration compositeConfiguration = createMockCompositeConfiguration();</span>
    Map&lt;String, String&gt; parameters = new HashMap&lt;&gt;();
    parameters.put(INTERFACE_KEY, DemoService.class.getName());
    parameters.put("registry", "zookeeper");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that when the protocol is configured, the protocol of consumer url is the configured protocol

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumerUrlWithProtocol</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    parameters.put(PROTOCOL_KEY, <span class="hljs-string">"tri"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    <span class="hljs-comment">// verify that the protocol of consumer url</span>

    Assertions.assertEquals(<span class="hljs-string">"tri"</span>, consumerUrl.getProtocol());

    Assertions.assertEquals(parameters.get(REGISTER_IP_KEY), consumerUrl.getHost());

    Assertions.assertFalse(consumerUrl.getAttributes().containsKey(REFER_KEY));

    Assertions.assertEquals(<span class="hljs-string">"value1"</span>, consumerUrl.getAttribute(<span class="hljs-string">"key1"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CompositeConfiguration <span class="hljs-title">createMockCompositeConfiguration</span><span class="hljs-params">()</span> </span>{
    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;
    <span class="hljs-keyword">return</span> compositeConfiguration;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest263">Test Case ID #dubbo_Test_26_3</h4>
<h4 id="test-case-name-testreferwithoutgroupfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testReferWithoutGroup</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-compositeconfiguration">Mock Object Variable Name: <code>compositeConfiguration</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);
<span class="hljs-deletion">-    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration.class);</span>
<span class="hljs-deletion">-    when(compositeConfiguration.convert(Boolean.class, ENABLE_CONFIGURATION_LISTEN, true)).thenReturn(true);</span>
<span class="hljs-addition">+    CompositeConfiguration compositeConfiguration = createMockCompositeConfiguration();</span>
    Map&lt;String, String&gt; parameters = new HashMap&lt;&gt;();
    parameters.put(INTERFACE_KEY, DemoService.class.getName());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that if multiple groups are not configured, the service reference of the registration center

 * the default is FailoverCluster

 *

 * <span class="hljs-doctag">@see</span> FailoverCluster

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testReferWithoutGroup</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Invoker&lt;?&gt; invoker = registryProtocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    Assertions.assertTrue(((MigrationInvoker&lt;?&gt;) invoker).getCluster() <span class="hljs-keyword">instanceof</span> ScopeClusterWrapper);

    Assertions.assertTrue(((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> MockClusterWrapper);

    Assertions.assertTrue(((MockClusterWrapper) ((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> FailoverCluster);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CompositeConfiguration <span class="hljs-title">createMockCompositeConfiguration</span><span class="hljs-params">()</span> </span>{
    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;
    <span class="hljs-keyword">return</span> compositeConfiguration;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest264">Test Case ID #dubbo_Test_26_4</h4>
<h4 id="test-case-name-testreferwithgroupfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testReferWithGroup</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-compositeconfiguration">Mock Object Variable Name: <code>compositeConfiguration</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);
<span class="hljs-deletion">-    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration.class);</span>
<span class="hljs-deletion">-    when(compositeConfiguration.convert(Boolean.class, ENABLE_CONFIGURATION_LISTEN, true)).thenReturn(true);</span>
<span class="hljs-addition">+    CompositeConfiguration compositeConfiguration = createMockCompositeConfiguration();</span>
    Map&lt;String, String&gt; parameters = new HashMap&lt;&gt;();
    parameters.put(INTERFACE_KEY, DemoService.class.getName());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that if multiple groups are configured, the service reference of the registration center

 *

 * <span class="hljs-doctag">@see</span> MergeableCluster

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testReferWithGroup</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    refer.put(GROUP_KEY, <span class="hljs-string">"group1,group2"</span>);

    attributes.put(REFER_KEY, refer);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Invoker&lt;?&gt; invoker = registryProtocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    Assertions.assertTrue(((MigrationInvoker&lt;?&gt;) invoker).getCluster() <span class="hljs-keyword">instanceof</span> ScopeClusterWrapper);

    Assertions.assertTrue(((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> MockClusterWrapper);

    Assertions.assertTrue(((MockClusterWrapper) ((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> MergeableCluster);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CompositeConfiguration <span class="hljs-title">createMockCompositeConfiguration</span><span class="hljs-params">()</span> </span>{
    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;
    <span class="hljs-keyword">return</span> compositeConfiguration;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest265">Test Case ID #dubbo_Test_26_5</h4>
<h4 id="test-case-name-testinterceptinvokerformigrationrulelistenerfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testInterceptInvokerForMigrationRuleListener</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-compositeconfiguration">Mock Object Variable Name: <code>compositeConfiguration</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);
<span class="hljs-deletion">-    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration.class);</span>
<span class="hljs-deletion">-    when(compositeConfiguration.convert(Boolean.class, ENABLE_CONFIGURATION_LISTEN, true)).thenReturn(true);</span>
<span class="hljs-addition">+    CompositeConfiguration compositeConfiguration = createMockCompositeConfiguration();</span>
    Map&lt;String, String&gt; parameters = new HashMap&lt;&gt;();
    parameters.put(INTERFACE_KEY, DemoService.class.getName());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that the default RegistryProtocolListener will be executed

 *

 * <span class="hljs-doctag">@see</span> MigrationRuleListener

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInterceptInvokerForMigrationRuleListener</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    refer.put(GROUP_KEY, <span class="hljs-string">"group1,group2"</span>);

    attributes.put(REFER_KEY, refer);

    URL url = serviceConfigURL.addAttributes(attributes);

    MigrationInvoker&lt;?&gt; clusterInvoker = mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Map&lt;String, Object&gt; consumerAttribute = <span class="hljs-keyword">new</span> HashMap&lt;&gt;(url.getAttributes());

    consumerAttribute.remove(REFER_KEY);

    URL consumerUrl = <span class="hljs-keyword">new</span> ServiceConfigURL(parameters.get(PROTOCOL_KEY) == <span class="hljs-keyword">null</span> ? DUBBO : parameters.get(PROTOCOL_KEY), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, parameters.get(REGISTER_IP_KEY), <span class="hljs-number">0</span>, url.getPath(), parameters, consumerAttribute);

    url = url.putAttribute(CONSUMER_URL_KEY, consumerUrl);

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    registryProtocol.interceptInvoker(clusterInvoker, url, consumerUrl);

    verify(migrationRuleListener, times(<span class="hljs-number">1</span>)).onRefer(registryProtocol, clusterInvoker, consumerUrl, url);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CompositeConfiguration <span class="hljs-title">createMockCompositeConfiguration</span><span class="hljs-params">()</span> </span>{
    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;
    <span class="hljs-keyword">return</span> compositeConfiguration;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest266">Test Case ID #dubbo_Test_26_6</h4>
<h4 id="test-case-name-testinterceptinvokerforcustomregistryprotocollistenerfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testInterceptInvokerForCustomRegistryProtocolListener</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-compositeconfiguration">Mock Object Variable Name: <code>compositeConfiguration</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);
<span class="hljs-deletion">-    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration.class);</span>
<span class="hljs-deletion">-    when(compositeConfiguration.convert(Boolean.class, ENABLE_CONFIGURATION_LISTEN, true)).thenReturn(true);</span>
<span class="hljs-addition">+    CompositeConfiguration compositeConfiguration = createMockCompositeConfiguration();</span>
    Map&lt;String, String&gt; parameters = new HashMap&lt;&gt;();
    parameters.put(INTERFACE_KEY, DemoService.class.getName());
    parameters.put("registry", "zookeeper");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Verify that if registry.protocol.listener is configured,

 * whether the corresponding RegistryProtocolListener will be executed normally

 *

 * <span class="hljs-doctag">@see</span> CountRegistryProtocolListener

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInterceptInvokerForCustomRegistryProtocolListener</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    parameters.put(REGISTRY_PROTOCOL_LISTENER_KEY, <span class="hljs-string">"count"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    refer.put(GROUP_KEY, <span class="hljs-string">"group1,group2"</span>);

    attributes.put(REFER_KEY, refer);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    MigrationInvoker&lt;?&gt; clusterInvoker = mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Map&lt;String, Object&gt; consumerAttribute = <span class="hljs-keyword">new</span> HashMap&lt;&gt;(url.getAttributes());

    consumerAttribute.remove(REFER_KEY);

    URL consumerUrl = <span class="hljs-keyword">new</span> ServiceConfigURL(parameters.get(PROTOCOL_KEY) == <span class="hljs-keyword">null</span> ? DUBBO : parameters.get(PROTOCOL_KEY), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, parameters.get(REGISTER_IP_KEY), <span class="hljs-number">0</span>, url.getPath(), parameters, consumerAttribute);

    url = url.putAttribute(CONSUMER_URL_KEY, consumerUrl);

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(<span class="hljs-keyword">new</span> CountRegistryProtocolListener());

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    registryProtocol.interceptInvoker(clusterInvoker, url, consumerUrl);

    Assertions.assertEquals(<span class="hljs-number">1</span>, CountRegistryProtocolListener.getReferCounter().get());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CompositeConfiguration <span class="hljs-title">createMockCompositeConfiguration</span><span class="hljs-params">()</span> </span>{
    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;
    <span class="hljs-keyword">return</span> compositeConfiguration;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest267">Test Case ID #dubbo_Test_26_7</h4>
<h4 id="test-case-name-testregisterconsumerurlfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testRegisterConsumerUrl</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-compositeconfiguration">Mock Object Variable Name: <code>compositeConfiguration</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);
<span class="hljs-deletion">-    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration.class);</span>
<span class="hljs-deletion">-    when(compositeConfiguration.convert(Boolean.class, ENABLE_CONFIGURATION_LISTEN, true)).thenReturn(true);</span>
<span class="hljs-addition">+    CompositeConfiguration compositeConfiguration = createMockCompositeConfiguration();</span>
    Map&lt;String, String&gt; parameters = new HashMap&lt;&gt;();
    parameters.put(INTERFACE_KEY, DemoService.class.getName());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify the registered consumer url

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRegisterConsumerUrl</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"true"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);

    url = url.setScopeModel(moduleModel);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    Map&lt;String, String&gt; urlParameters = consumerUrl.getParameters();

    URL urlToRegistry = <span class="hljs-keyword">new</span> ServiceConfigURL(urlParameters.get(PROTOCOL_KEY) == <span class="hljs-keyword">null</span> ? CONSUMER : urlParameters.get(PROTOCOL_KEY), urlParameters.remove(REGISTER_IP_KEY), <span class="hljs-number">0</span>, consumerUrl.getPath(), urlParameters);

    URL registeredConsumerUrl = urlToRegistry.addParameters(CATEGORY_KEY, CONSUMERS_CATEGORY, CHECK_KEY, String.valueOf(<span class="hljs-keyword">false</span>)).setScopeModel(moduleModel);

    verify(registry, times(<span class="hljs-number">1</span>)).register(registeredConsumerUrl);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CompositeConfiguration <span class="hljs-title">createMockCompositeConfiguration</span><span class="hljs-params">()</span> </span>{
    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;
    <span class="hljs-keyword">return</span> compositeConfiguration;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci27">Mock Clone Instance #dubbo_MCI_27</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Invoker&lt;org.apache.dubbo.rpc.cluster.router.mock.MockInvokersSelectorTest.DemoService&gt;</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;DemoService&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker&lt;DemoService&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(invoker.getUrl()).thenReturn(url);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest271">Test Case ID #dubbo_Test_27_1</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclusterroutermockmockinvokersselectortestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\router\mock\MockInvokersSelectorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker1">Mock Object Variable Name: <code>invoker1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     // Data preparation
<span class="hljs-deletion">-    Invoker&lt;DemoService&gt; invoker1 = Mockito.mock(Invoker.class);</span>
<span class="hljs-addition">+    Invoker&lt;DemoService&gt; invoker1 = createMockInvoker(URL.valueOf("mock://127.0.0.1/test"));</span>
     Invoker&lt;DemoService&gt; invoker2 = Mockito.mock(Invoker.class);
     Invoker&lt;DemoService&gt; invoker3 = Mockito.mock(Invoker.class);
<span class="hljs-deletion">-    Mockito.when(invoker1.getUrl()).thenReturn(URL.valueOf("mock://127.0.0.1/test"));</span>
     Mockito.when(invoker2.getUrl()).thenReturn(URL.valueOf("mock://127.0.0.1/test"));
     Mockito.when(invoker3.getUrl()).thenReturn(URL.valueOf("dubbo://127.0.0.1/test"));
     BitList&lt;Invoker&lt;DemoService&gt;&gt; providers = new BitList&lt;&gt;(Arrays.asList(invoker1, invoker2, invoker3));
     RpcInvocation rpcInvocation = Mockito.mock(RpcInvocation.class);
     URL consumerURL = URL.valueOf("test://127.0.0.1");
     selector.notify(providers);
     // rpcInvocation does not have an attached "invocation.need.mock" parameter, so normal invokers will be filtered out
     List&lt;Invoker&lt;DemoService&gt;&gt; invokers = selector.route(providers.clone(), consumerURL, rpcInvocation, false, new Holder&lt;&gt;());
     Assertions.assertEquals(invokers.size(), 1);
     Assertions.assertTrue(invokers.contains(invoker3));
     // rpcInvocation have an attached "invocation.need.mock" parameter, so it will filter out the invoker whose protocol is mock
     Mockito.when(rpcInvocation.getObjectAttachmentWithoutConvert(INVOCATION_NEED_MOCK)).thenReturn("true");
     invokers = selector.route(providers.clone(), consumerURL, rpcInvocation, false, new Holder&lt;&gt;());
     Assertions.assertEquals(invokers.size(), 2);
     Assertions.assertTrue(invokers.contains(invoker1));
     Assertions.assertTrue(invokers.contains(invoker2));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    MockInvokersSelector selector = <span class="hljs-keyword">new</span> MockInvokersSelector(URL.valueOf(<span class="hljs-string">""</span>));

    <span class="hljs-comment">// Data preparation</span>

    Invoker&lt;DemoService&gt; invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;DemoService&gt; invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;DemoService&gt; invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(invoker1.getUrl()).thenReturn(URL.valueOf(<span class="hljs-string">"mock://127.0.0.1/test"</span>));

    Mockito.when(invoker2.getUrl()).thenReturn(URL.valueOf(<span class="hljs-string">"mock://127.0.0.1/test"</span>));

    Mockito.when(invoker3.getUrl()).thenReturn(URL.valueOf(<span class="hljs-string">"dubbo://127.0.0.1/test"</span>));

    BitList&lt;Invoker&lt;DemoService&gt;&gt; providers = <span class="hljs-keyword">new</span> BitList&lt;&gt;(Arrays.asList(invoker1, invoker2, invoker3));

    RpcInvocation rpcInvocation = Mockito.mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL consumerURL = URL.valueOf(<span class="hljs-string">"test://127.0.0.1"</span>);

    selector.notify(providers);

    <span class="hljs-comment">// rpcInvocation does not have an attached "invocation.need.mock" parameter, so normal invokers will be filtered out</span>

    List&lt;Invoker&lt;DemoService&gt;&gt; invokers = selector.route(providers.clone(), consumerURL, rpcInvocation, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">new</span> Holder&lt;&gt;());

    Assertions.assertEquals(invokers.size(), <span class="hljs-number">1</span>);

    Assertions.assertTrue(invokers.contains(invoker3));

    <span class="hljs-comment">// rpcInvocation have an attached "invocation.need.mock" parameter, so it will filter out the invoker whose protocol is mock</span>

    Mockito.when(rpcInvocation.getObjectAttachmentWithoutConvert(INVOCATION_NEED_MOCK)).thenReturn(<span class="hljs-string">"true"</span>);

    invokers = selector.route(providers.clone(), consumerURL, rpcInvocation, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">new</span> Holder&lt;&gt;());

    Assertions.assertEquals(invokers.size(), <span class="hljs-number">2</span>);

    Assertions.assertTrue(invokers.contains(invoker1));

    Assertions.assertTrue(invokers.contains(invoker2));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;DemoService&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker&lt;DemoService&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(invoker.getUrl()).thenReturn(url);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest272">Test Case ID #dubbo_Test_27_2</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclusterroutermockmockinvokersselectortestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\router\mock\MockInvokersSelectorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker2">Mock Object Variable Name: <code>invoker2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Invoker&lt;DemoService&gt; invoker1 = Mockito.mock(Invoker.class);
<span class="hljs-deletion">-    Invoker&lt;DemoService&gt; invoker2 = Mockito.mock(Invoker.class);</span>
<span class="hljs-addition">+    Invoker&lt;DemoService&gt; invoker2 = createMockInvoker(URL.valueOf("mock://127.0.0.1/test"));</span>
    Invoker&lt;DemoService&gt; invoker3 = Mockito.mock(Invoker.class);
    Mockito.when(invoker1.getUrl()).thenReturn(URL.valueOf("mock://127.0.0.1/test"));
<span class="hljs-deletion">-    Mockito.when(invoker2.getUrl()).thenReturn(URL.valueOf("mock://127.0.0.1/test"));</span>
    Mockito.when(invoker3.getUrl()).thenReturn(URL.valueOf("dubbo://127.0.0.1/test"));
    BitList&lt;Invoker&lt;DemoService&gt;&gt; providers = new BitList&lt;&gt;(Arrays.asList(invoker1, invoker2, invoker3));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    MockInvokersSelector selector = <span class="hljs-keyword">new</span> MockInvokersSelector(URL.valueOf(<span class="hljs-string">""</span>));

    <span class="hljs-comment">// Data preparation</span>

    Invoker&lt;DemoService&gt; invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;DemoService&gt; invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;DemoService&gt; invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(invoker1.getUrl()).thenReturn(URL.valueOf(<span class="hljs-string">"mock://127.0.0.1/test"</span>));

    Mockito.when(invoker2.getUrl()).thenReturn(URL.valueOf(<span class="hljs-string">"mock://127.0.0.1/test"</span>));

    Mockito.when(invoker3.getUrl()).thenReturn(URL.valueOf(<span class="hljs-string">"dubbo://127.0.0.1/test"</span>));

    BitList&lt;Invoker&lt;DemoService&gt;&gt; providers = <span class="hljs-keyword">new</span> BitList&lt;&gt;(Arrays.asList(invoker1, invoker2, invoker3));

    RpcInvocation rpcInvocation = Mockito.mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL consumerURL = URL.valueOf(<span class="hljs-string">"test://127.0.0.1"</span>);

    selector.notify(providers);

    <span class="hljs-comment">// rpcInvocation does not have an attached "invocation.need.mock" parameter, so normal invokers will be filtered out</span>

    List&lt;Invoker&lt;DemoService&gt;&gt; invokers = selector.route(providers.clone(), consumerURL, rpcInvocation, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">new</span> Holder&lt;&gt;());

    Assertions.assertEquals(invokers.size(), <span class="hljs-number">1</span>);

    Assertions.assertTrue(invokers.contains(invoker3));

    <span class="hljs-comment">// rpcInvocation have an attached "invocation.need.mock" parameter, so it will filter out the invoker whose protocol is mock</span>

    Mockito.when(rpcInvocation.getObjectAttachmentWithoutConvert(INVOCATION_NEED_MOCK)).thenReturn(<span class="hljs-string">"true"</span>);

    invokers = selector.route(providers.clone(), consumerURL, rpcInvocation, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">new</span> Holder&lt;&gt;());

    Assertions.assertEquals(invokers.size(), <span class="hljs-number">2</span>);

    Assertions.assertTrue(invokers.contains(invoker1));

    Assertions.assertTrue(invokers.contains(invoker2));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;DemoService&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker&lt;DemoService&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(invoker.getUrl()).thenReturn(url);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest273">Test Case ID #dubbo_Test_27_3</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclusterroutermockmockinvokersselectortestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\router\mock\MockInvokersSelectorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker3">Mock Object Variable Name: <code>invoker3</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Invoker&lt;DemoService&gt; invoker1 = Mockito.mock(Invoker.class);
    Invoker&lt;DemoService&gt; invoker2 = Mockito.mock(Invoker.class);
<span class="hljs-deletion">-    Invoker&lt;DemoService&gt; invoker3 = Mockito.mock(Invoker.class);</span>
    Mockito.when(invoker1.getUrl()).thenReturn(URL.valueOf("mock://127.0.0.1/test"));
    Mockito.when(invoker2.getUrl()).thenReturn(URL.valueOf("mock://127.0.0.1/test"));
<span class="hljs-deletion">-    Mockito.when(invoker3.getUrl()).thenReturn(URL.valueOf("dubbo://127.0.0.1/test"));</span>
<span class="hljs-addition">+    Invoker&lt;DemoService&gt; invoker3 = createMockInvoker(URL.valueOf("dubbo://127.0.0.1/test"));</span>
    BitList&lt;Invoker&lt;DemoService&gt;&gt; providers = new BitList&lt;&gt;(Arrays.asList(invoker1, invoker2, invoker3));
    RpcInvocation rpcInvocation = Mockito.mock(RpcInvocation.class);
    URL consumerURL = URL.valueOf("test://127.0.0.1");
    selector.notify(providers);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    MockInvokersSelector selector = <span class="hljs-keyword">new</span> MockInvokersSelector(URL.valueOf(<span class="hljs-string">""</span>));

    <span class="hljs-comment">// Data preparation</span>

    Invoker&lt;DemoService&gt; invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;DemoService&gt; invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;DemoService&gt; invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(invoker1.getUrl()).thenReturn(URL.valueOf(<span class="hljs-string">"mock://127.0.0.1/test"</span>));

    Mockito.when(invoker2.getUrl()).thenReturn(URL.valueOf(<span class="hljs-string">"mock://127.0.0.1/test"</span>));

    Mockito.when(invoker3.getUrl()).thenReturn(URL.valueOf(<span class="hljs-string">"dubbo://127.0.0.1/test"</span>));

    BitList&lt;Invoker&lt;DemoService&gt;&gt; providers = <span class="hljs-keyword">new</span> BitList&lt;&gt;(Arrays.asList(invoker1, invoker2, invoker3));

    RpcInvocation rpcInvocation = Mockito.mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL consumerURL = URL.valueOf(<span class="hljs-string">"test://127.0.0.1"</span>);

    selector.notify(providers);

    <span class="hljs-comment">// rpcInvocation does not have an attached "invocation.need.mock" parameter, so normal invokers will be filtered out</span>

    List&lt;Invoker&lt;DemoService&gt;&gt; invokers = selector.route(providers.clone(), consumerURL, rpcInvocation, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">new</span> Holder&lt;&gt;());

    Assertions.assertEquals(invokers.size(), <span class="hljs-number">1</span>);

    Assertions.assertTrue(invokers.contains(invoker3));

    <span class="hljs-comment">// rpcInvocation have an attached "invocation.need.mock" parameter, so it will filter out the invoker whose protocol is mock</span>

    Mockito.when(rpcInvocation.getObjectAttachmentWithoutConvert(INVOCATION_NEED_MOCK)).thenReturn(<span class="hljs-string">"true"</span>);

    invokers = selector.route(providers.clone(), consumerURL, rpcInvocation, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">new</span> Holder&lt;&gt;());

    Assertions.assertEquals(invokers.size(), <span class="hljs-number">2</span>);

    Assertions.assertTrue(invokers.contains(invoker1));

    Assertions.assertTrue(invokers.contains(invoker2));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;DemoService&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker&lt;DemoService&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(invoker.getUrl()).thenReturn(url);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci28">Mock Clone Instance #dubbo_MCI_28</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.registry.Registry</code></li>
<li><strong>Test Case Count</strong>: 5</li>
<li><strong>MO Count</strong>: 5</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Registry registry;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
registry

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest281">Test Case ID #dubbo_Test_28_1</h4>
<h4 id="test-case-name-testconsumerurlwithoutprotocolfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testConsumerUrlWithoutProtocol</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-registry">Mock Object Variable Name: <code>registry</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     RegistryFactory registryFactory = mock(RegistryFactory.class);
<span class="hljs-deletion">-    Registry registry = mock(Registry.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `registry`</span>
     RegistryProtocol registryProtocol = new RegistryProtocol();
     MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener.class);
     List&lt;RegistryProtocolListener&gt; registryProtocolListeners = new ArrayList&lt;&gt;();
     registryProtocolListeners.add(migrationRuleListener);
     ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());
     moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(new ApplicationConfig("application1"));
     ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader.class);
     Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener.class)).thenReturn(extensionLoaderMock);
     Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);
     url = url.setScopeModel(moduleModel);
     when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);
     Cluster cluster = mock(Cluster.class);
     Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService.class, url, parameters);
     Assertions.assertTrue(invoker instanceof MigrationInvoker);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify the generated consumer url information

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumerUrlWithoutProtocol</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    <span class="hljs-comment">// verify that the protocol header of consumerUrl is set to "consumer"</span>

    Assertions.assertEquals(<span class="hljs-string">"consumer"</span>, consumerUrl.getProtocol());

    Assertions.assertEquals(parameters.get(REGISTER_IP_KEY), consumerUrl.getHost());

    Assertions.assertFalse(consumerUrl.getAttributes().containsKey(REFER_KEY));

    Assertions.assertEquals(<span class="hljs-string">"value1"</span>, consumerUrl.getAttribute(<span class="hljs-string">"key1"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Registry registry;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
registry

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest282">Test Case ID #dubbo_Test_28_2</h4>
<h4 id="test-case-name-testconsumerurlwithprotocolfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testConsumerUrlWithProtocol</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-registry">Mock Object Variable Name: <code>registry</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     RegistryFactory registryFactory = mock(RegistryFactory.class);
     RegistryProtocol registryProtocol = new RegistryProtocol();
<span class="hljs-deletion">-    Registry registry = mock(Registry.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `registry`</span>
     MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener.class);
     List&lt;RegistryProtocolListener&gt; registryProtocolListeners = new ArrayList&lt;&gt;();
     registryProtocolListeners.add(migrationRuleListener);
@@
<span class="hljs-deletion">-    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);</span>
<span class="hljs-addition">+    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);</span>
     Cluster cluster = mock(Cluster.class);
<span class="hljs-deletion">-    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService.class, url, parameters);</span>
<span class="hljs-addition">+    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService.class, url, parameters);</span>
     Assertions.assertTrue(invoker instanceof MigrationInvoker);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that when the protocol is configured, the protocol of consumer url is the configured protocol

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumerUrlWithProtocol</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    parameters.put(PROTOCOL_KEY, <span class="hljs-string">"tri"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    <span class="hljs-comment">// verify that the protocol of consumer url</span>

    Assertions.assertEquals(<span class="hljs-string">"tri"</span>, consumerUrl.getProtocol());

    Assertions.assertEquals(parameters.get(REGISTER_IP_KEY), consumerUrl.getHost());

    Assertions.assertFalse(consumerUrl.getAttributes().containsKey(REFER_KEY));

    Assertions.assertEquals(<span class="hljs-string">"value1"</span>, consumerUrl.getAttribute(<span class="hljs-string">"key1"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Registry registry;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
registry

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest283">Test Case ID #dubbo_Test_28_3</h4>
<h4 id="test-case-name-testreferwithoutgroupfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testReferWithoutGroup</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-registry">Mock Object Variable Name: <code>registry</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     RegistryFactory registryFactory = mock(RegistryFactory.class);
<span class="hljs-deletion">-    Registry registry = mock(Registry.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `registry`</span>
     MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener.class);
     List&lt;RegistryProtocolListener&gt; registryProtocolListeners = new ArrayList&lt;&gt;();
     registryProtocolListeners.add(migrationRuleListener);
     RegistryProtocol registryProtocol = new RegistryProtocol();
     ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());
     moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(new ApplicationConfig("application1"));
     ExtensionLoader extensionLoaderMock = mock(ExtensionLoader.class);
     Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener.class)).thenReturn(extensionLoaderMock);
     Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);
     Mockito.when(moduleModel.getExtensionLoader(RegistryFactory.class)).thenReturn(extensionLoaderMock);
     Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);
     url = url.setScopeModel(moduleModel);
<span class="hljs-deletion">-    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);</span>
<span class="hljs-addition">+    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);</span>
     Invoker&lt;?&gt; invoker = registryProtocol.refer(DemoService.class, url);
     Assertions.assertTrue(invoker instanceof MigrationInvoker);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that if multiple groups are not configured, the service reference of the registration center

 * the default is FailoverCluster

 *

 * <span class="hljs-doctag">@see</span> FailoverCluster

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testReferWithoutGroup</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Invoker&lt;?&gt; invoker = registryProtocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    Assertions.assertTrue(((MigrationInvoker&lt;?&gt;) invoker).getCluster() <span class="hljs-keyword">instanceof</span> ScopeClusterWrapper);

    Assertions.assertTrue(((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> MockClusterWrapper);

    Assertions.assertTrue(((MockClusterWrapper) ((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> FailoverCluster);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Registry registry;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
registry

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest284">Test Case ID #dubbo_Test_28_4</h4>
<h4 id="test-case-name-testreferwithgroupfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testReferWithGroup</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-registry">Mock Object Variable Name: <code>registry</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     RegistryFactory registryFactory = mock(RegistryFactory.class);
<span class="hljs-deletion">-    Registry registry = mock(Registry.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `registry`</span>
     MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener.class);
     List&lt;RegistryProtocolListener&gt; registryProtocolListeners = new ArrayList&lt;&gt;();
     registryProtocolListeners.add(migrationRuleListener);
@@
     Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);
     url = url.setScopeModel(moduleModel);
<span class="hljs-deletion">-    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);</span>
<span class="hljs-addition">+    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);</span>
     Invoker&lt;?&gt; invoker = registryProtocol.refer(DemoService.class, url);
     Assertions.assertTrue(invoker instanceof MigrationInvoker);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that if multiple groups are configured, the service reference of the registration center

 *

 * <span class="hljs-doctag">@see</span> MergeableCluster

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testReferWithGroup</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    refer.put(GROUP_KEY, <span class="hljs-string">"group1,group2"</span>);

    attributes.put(REFER_KEY, refer);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Invoker&lt;?&gt; invoker = registryProtocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    Assertions.assertTrue(((MigrationInvoker&lt;?&gt;) invoker).getCluster() <span class="hljs-keyword">instanceof</span> ScopeClusterWrapper);

    Assertions.assertTrue(((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> MockClusterWrapper);

    Assertions.assertTrue(((MockClusterWrapper) ((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> MergeableCluster);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Registry registry;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
registry

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest285">Test Case ID #dubbo_Test_28_5</h4>
<h4 id="test-case-name-testregisterconsumerurlfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testRegisterConsumerUrl</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-registry">Mock Object Variable Name: <code>registry</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     RegistryFactory registryFactory = mock(RegistryFactory.class);
<span class="hljs-deletion">-    Registry registry = mock(Registry.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `registry`</span>
     ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());
     moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(new ApplicationConfig("application1"));
@@
     Cluster cluster = mock(Cluster.class);
<span class="hljs-deletion">-    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService.class, url, parameters);</span>
<span class="hljs-addition">+    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService.class, url, parameters);</span>
     Assertions.assertTrue(invoker instanceof MigrationInvoker);
     URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();
@@
     URL registeredConsumerUrl = urlToRegistry.addParameters(CATEGORY_KEY, CONSUMERS_CATEGORY, CHECK_KEY, String.valueOf(false)).setScopeModel(moduleModel);
<span class="hljs-deletion">-    verify(registry, times(1)).register(registeredConsumerUrl);</span>
<span class="hljs-addition">+    verify(registry, times(1)).register(registeredConsumerUrl);</span>
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify the registered consumer url

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRegisterConsumerUrl</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"true"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);

    url = url.setScopeModel(moduleModel);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    Map&lt;String, String&gt; urlParameters = consumerUrl.getParameters();

    URL urlToRegistry = <span class="hljs-keyword">new</span> ServiceConfigURL(urlParameters.get(PROTOCOL_KEY) == <span class="hljs-keyword">null</span> ? CONSUMER : urlParameters.get(PROTOCOL_KEY), urlParameters.remove(REGISTER_IP_KEY), <span class="hljs-number">0</span>, consumerUrl.getPath(), urlParameters);

    URL registeredConsumerUrl = urlToRegistry.addParameters(CATEGORY_KEY, CONSUMERS_CATEGORY, CHECK_KEY, String.valueOf(<span class="hljs-keyword">false</span>)).setScopeModel(moduleModel);

    verify(registry, times(<span class="hljs-number">1</span>)).register(registeredConsumerUrl);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Registry registry;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
registry

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci29">Mock Clone Instance #dubbo_MCI_29</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>Invoker&lt;DemoService&gt;</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker&lt;DemoService&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url, AppResponse result, Invocation invocation)</span> </span>{
        Invoker&lt;DemoService&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);
        given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.invoke(invocation)).willReturn(result);
        given(invoker.getUrl()).willReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest291">Test Case ID #dubbo_Test_29_1</h4>
<h4 id="test-case-name-testsetcontextfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltercontextfiltertestjava">Test Case Name: <code>testSetContext</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\ContextFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     given(invocation.getObjectAttachments()).willReturn(null);
<span class="hljs-deletion">-    invoker = mock(Invoker.class);</span>
<span class="hljs-deletion">-    given(invoker.isAvailable()).willReturn(true);</span>
<span class="hljs-deletion">-    given(invoker.getInterface()).willReturn(DemoService.class);</span>
     AppResponse result = new AppResponse();
     result.setValue("High");
<span class="hljs-deletion">-    given(invoker.invoke(invocation)).willReturn(result);</span>
     URL url = URL.valueOf("test://test:11/test?group=dubbo&amp;version=1.1");
<span class="hljs-deletion">-    given(invoker.getUrl()).willReturn(url);</span>
<span class="hljs-addition">+    invoker = MockInvoker.createMockInvoker(url, result, invocation);</span>
     contextFilter.invoke(invoker, invocation);
     assertNotNull(RpcContext.getServiceContext().getInvoker());
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testSetContext</span><span class="hljs-params">()</span> </span>{

    invocation = mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"$enumlength"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { Enum<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span> });

    given(invocation.getObjectAttachments()).willReturn(<span class="hljs-keyword">null</span>);

    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AppResponse result = <span class="hljs-keyword">new</span> AppResponse();

    result.setValue(<span class="hljs-string">"High"</span>);

    given(invoker.invoke(invocation)).willReturn(result);

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?group=dubbo&amp;version=1.1"</span>);

    given(invoker.getUrl()).willReturn(url);

    contextFilter.invoke(invoker, invocation);

    assertNotNull(RpcContext.getServiceContext().getInvoker());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker&lt;DemoService&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url, AppResponse result, Invocation invocation)</span> </span>{
        Invoker&lt;DemoService&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);
        given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.invoke(invocation)).willReturn(result);
        given(invoker.getUrl()).willReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest292">Test Case ID #dubbo_Test_29_2</h4>
<h4 id="test-case-name-testechofile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfilterechofiltertestjava">Test Case Name: <code>testEcho</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\EchoFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    given(invocation.getObjectAttachments()).willReturn(null);
<span class="hljs-deletion">-    Invoker&lt;DemoService&gt; invoker = mock(Invoker.class);</span>
<span class="hljs-deletion">-    given(invoker.isAvailable()).willReturn(true);</span>
<span class="hljs-deletion">-    given(invoker.getInterface()).willReturn(DemoService.class);</span>
    AppResponse result = new AppResponse();
    result.setValue("High");
<span class="hljs-deletion">-    given(invoker.invoke(invocation)).willReturn(result);</span>
    URL url = URL.valueOf("test://test:11/test?group=dubbo&amp;version=1.1");
<span class="hljs-deletion">-    given(invoker.getUrl()).willReturn(url);</span>
<span class="hljs-addition">+    Invoker&lt;DemoService&gt; invoker = MockInvoker.createMockInvoker(url, result, invocation);</span>
    Result filterResult = echoFilter.invoke(invoker, invocation);
    assertEquals("hello", filterResult.getValue());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testEcho</span><span class="hljs-params">()</span> </span>{

    Invocation invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"$echo"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { Enum<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span> });

    given(invocation.getObjectAttachments()).willReturn(<span class="hljs-keyword">null</span>);

    Invoker&lt;DemoService&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AppResponse result = <span class="hljs-keyword">new</span> AppResponse();

    result.setValue(<span class="hljs-string">"High"</span>);

    given(invoker.invoke(invocation)).willReturn(result);

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?group=dubbo&amp;version=1.1"</span>);

    given(invoker.getUrl()).willReturn(url);

    Result filterResult = echoFilter.invoke(invoker, invocation);

    assertEquals(<span class="hljs-string">"hello"</span>, filterResult.getValue());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker&lt;DemoService&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url, AppResponse result, Invocation invocation)</span> </span>{
        Invoker&lt;DemoService&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);
        given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.invoke(invocation)).willReturn(result);
        given(invoker.getUrl()).willReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest293">Test Case ID #dubbo_Test_29_3</h4>
<h4 id="test-case-name-testnonechofile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfilterechofiltertestjava">Test Case Name: <code>testNonEcho</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\EchoFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    given(invocation.getObjectAttachments()).willReturn(null);
<span class="hljs-deletion">-    Invoker&lt;DemoService&gt; invoker = mock(Invoker.class);</span>
<span class="hljs-deletion">-    given(invoker.isAvailable()).willReturn(true);</span>
<span class="hljs-deletion">-    given(invoker.getInterface()).willReturn(DemoService.class);</span>
    AppResponse result = new AppResponse();
    result.setValue("High");
<span class="hljs-deletion">-    given(invoker.invoke(invocation)).willReturn(result);</span>
    URL url = URL.valueOf("test://test:11/test?group=dubbo&amp;version=1.1");
<span class="hljs-deletion">-    given(invoker.getUrl()).willReturn(url);</span>
<span class="hljs-addition">+    Invoker&lt;DemoService&gt; invoker = MockInvoker.createMockInvoker(url, result, invocation);</span>
    Result filterResult = echoFilter.invoke(invoker, invocation);
    assertEquals("High", filterResult.getValue());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testNonEcho</span><span class="hljs-params">()</span> </span>{

    Invocation invocation = mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"echo"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { Enum<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span> });

    given(invocation.getObjectAttachments()).willReturn(<span class="hljs-keyword">null</span>);

    Invoker&lt;DemoService&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AppResponse result = <span class="hljs-keyword">new</span> AppResponse();

    result.setValue(<span class="hljs-string">"High"</span>);

    given(invoker.invoke(invocation)).willReturn(result);

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?group=dubbo&amp;version=1.1"</span>);

    given(invoker.getUrl()).willReturn(url);

    Result filterResult = echoFilter.invoke(invoker, invocation);

    assertEquals(<span class="hljs-string">"High"</span>, filterResult.getValue());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker&lt;DemoService&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url, AppResponse result, Invocation invocation)</span> </span>{
        Invoker&lt;DemoService&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);
        given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.invoke(invocation)).willReturn(result);
        given(invoker.getUrl()).willReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci30">Mock Clone Instance #dubbo_MCI_30</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>Invoker&lt;DemoService&gt;</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;DemoService&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">()</span> </span>{
    Invoker&lt;DemoService&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invoker.getInterface()).thenReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest301">Test Case ID #dubbo_Test_30_1</h4>
<h4 id="test-case-name-testrpcexceptionfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfilterexceptionfiltertestjava">Test Case Name: <code>testRpcException</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\ExceptionFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    RpcInvocation invocation = new RpcInvocation("sayHello", DemoService.class.getName(), "", new Class&lt;?&gt;[] { String.class }, new Object[] { "world" });
<span class="hljs-deletion">-    Invoker&lt;DemoService&gt; invoker = mock(Invoker.class);</span>
<span class="hljs-deletion">-    given(invoker.getInterface()).willReturn(DemoService.class);</span>
<span class="hljs-addition">+    Invoker&lt;DemoService&gt; invoker = createMockInvoker();</span>
     given(invoker.invoke(eq(invocation))).willThrow(exception);
     try {
         exceptionFilter.invoke(invoker, invocation);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRpcException</span><span class="hljs-params">()</span> </span>{

    Logger failLogger = mock(Logger<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    FailsafeErrorTypeAwareLogger failsafeLogger = <span class="hljs-keyword">new</span> FailsafeErrorTypeAwareLogger(failLogger);

    RpcContext.getServiceContext().setRemoteAddress(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">1234</span>);

    RpcException exception = <span class="hljs-keyword">new</span> RpcException(<span class="hljs-string">"TestRpcException"</span>);

    ExceptionFilter exceptionFilter = <span class="hljs-keyword">new</span> ExceptionFilter();

    RpcInvocation invocation = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"sayHello"</span>, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), "", <span class="hljs-title">new</span> <span class="hljs-title">Class</span>&lt;?&gt;[] </span>{ String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[] </span>{ <span class="hljs-string">"world"</span> });

    Invoker&lt;DemoService&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.invoke(eq(invocation))).willThrow(exception);

    <span class="hljs-keyword">try</span> {

        exceptionFilter.invoke(invoker, invocation);

    } <span class="hljs-keyword">catch</span> (RpcException e) {

        assertEquals(<span class="hljs-string">"TestRpcException"</span>, e.getMessage());

        exceptionFilter.setLogger(failsafeLogger);

        exceptionFilter.onError(e, invoker, invocation);

    }

    failsafeLogger.error(CONFIG_FILTER_VALIDATION_EXCEPTION, <span class="hljs-string">""</span>, <span class="hljs-string">""</span>, eq(<span class="hljs-string">"Got unchecked and undeclared exception which called by 127.0.0.1. service: "</span> + DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>() + ", <span class="hljs-title">method</span>: <span class="hljs-title">sayHello</span>, <span class="hljs-title">exception</span>: " + <span class="hljs-title">RpcException</span>.<span class="hljs-title">class</span>.<span class="hljs-title">getName</span>() + ": <span class="hljs-title">TestRpcException</span>"), <span class="hljs-title">eq</span>(<span class="hljs-title">exception</span>))</span>;

    RpcContext.removeContext();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;DemoService&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">()</span> </span>{
    Invoker&lt;DemoService&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invoker.getInterface()).thenReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest302">Test Case ID #dubbo_Test_30_2</h4>
<h4 id="test-case-name-testjavaexceptionfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfilterexceptionfiltertestjava">Test Case Name: <code>testJavaException</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\ExceptionFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    appResponse.setException(new IllegalArgumentException("java"));
<span class="hljs-deletion">-    Invoker&lt;DemoService&gt; invoker = mock(Invoker.class);</span>
<span class="hljs-deletion">-    when(invoker.invoke(invocation)).thenReturn(appResponse);</span>
<span class="hljs-deletion">-    when(invoker.getInterface()).thenReturn(DemoService.class);</span>
<span class="hljs-addition">+    Invoker&lt;DemoService&gt; invoker = createMockInvoker();</span>
<span class="hljs-addition">+    when(invoker.invoke(invocation)).thenReturn(appResponse);</span>
    Result newResult = exceptionFilter.invoke(invoker, invocation);
    Assertions.assertEquals(appResponse.getException(), newResult.getException());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testJavaException</span><span class="hljs-params">()</span> </span>{

    ExceptionFilter exceptionFilter = <span class="hljs-keyword">new</span> ExceptionFilter();

    RpcInvocation invocation = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"sayHello"</span>, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), "", <span class="hljs-title">new</span> <span class="hljs-title">Class</span>&lt;?&gt;[] </span>{ String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[] </span>{ <span class="hljs-string">"world"</span> });

    AppResponse appResponse = <span class="hljs-keyword">new</span> AppResponse();

    appResponse.setException(<span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"java"</span>));

    Invoker&lt;DemoService&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(invocation)).thenReturn(appResponse);

    when(invoker.getInterface()).thenReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result newResult = exceptionFilter.invoke(invoker, invocation);

    Assertions.assertEquals(appResponse.getException(), newResult.getException());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;DemoService&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">()</span> </span>{
    Invoker&lt;DemoService&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invoker.getInterface()).thenReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest303">Test Case ID #dubbo_Test_30_3</h4>
<h4 id="test-case-name-testruntimeexceptionfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfilterexceptionfiltertestjava">Test Case Name: <code>testRuntimeException</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\ExceptionFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    AppResponse appResponse = new AppResponse();
    appResponse.setException(new LocalException("localException"));
<span class="hljs-deletion">-    Invoker&lt;DemoService&gt; invoker = mock(Invoker.class);</span>
<span class="hljs-deletion">-    when(invoker.invoke(invocation)).thenReturn(appResponse);</span>
<span class="hljs-deletion">-    when(invoker.getInterface()).thenReturn(DemoService.class);</span>
<span class="hljs-addition">+    Invoker&lt;DemoService&gt; invoker = createMockInvoker();</span>
<span class="hljs-addition">+    when(invoker.invoke(invocation)).thenReturn(appResponse);</span>
    Result newResult = exceptionFilter.invoke(invoker, invocation);
    Assertions.assertEquals(appResponse.getException(), newResult.getException());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRuntimeException</span><span class="hljs-params">()</span> </span>{

    ExceptionFilter exceptionFilter = <span class="hljs-keyword">new</span> ExceptionFilter();

    RpcInvocation invocation = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"sayHello"</span>, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), "", <span class="hljs-title">new</span> <span class="hljs-title">Class</span>&lt;?&gt;[] </span>{ String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[] </span>{ <span class="hljs-string">"world"</span> });

    AppResponse appResponse = <span class="hljs-keyword">new</span> AppResponse();

    appResponse.setException(<span class="hljs-keyword">new</span> LocalException(<span class="hljs-string">"localException"</span>));

    Invoker&lt;DemoService&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(invocation)).thenReturn(appResponse);

    when(invoker.getInterface()).thenReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result newResult = exceptionFilter.invoke(invoker, invocation);

    Assertions.assertEquals(appResponse.getException(), newResult.getException());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;DemoService&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">()</span> </span>{
    Invoker&lt;DemoService&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invoker.getInterface()).thenReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest304">Test Case ID #dubbo_Test_30_4</h4>
<h4 id="test-case-name-testconverttoruntimeexceptionfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfilterexceptionfiltertestjava">Test Case Name: <code>testConvertToRunTimeException</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\ExceptionFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    AppResponse mockRpcResult = new AppResponse();
    mockRpcResult.setException(new HessianException("hessian"));
    Result mockAsyncResult = AsyncRpcResult.newDefaultAsyncResult(mockRpcResult, invocation);
<span class="hljs-deletion">-    Invoker&lt;DemoService&gt; invoker = mock(Invoker.class);</span>
<span class="hljs-deletion">-    when(invoker.invoke(invocation)).thenReturn(mockAsyncResult);</span>
<span class="hljs-deletion">-    when(invoker.getInterface()).thenReturn(DemoService.class);</span>
<span class="hljs-addition">+    Invoker&lt;DemoService&gt; invoker = createMockInvoker();</span>
<span class="hljs-addition">+    when(invoker.invoke(invocation)).thenReturn(mockAsyncResult);</span>
    Result asyncResult = exceptionFilter.invoke(invoker, invocation);
    AppResponse appResponse = (AppResponse) asyncResult.get();
    exceptionFilter.onResponse(appResponse, invoker, invocation);
    Assertions.assertFalse(appResponse.getException() instanceof HessianException);
    Assertions.assertEquals(appResponse.getException().getClass(), RuntimeException.class);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConvertToRunTimeException</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    ExceptionFilter exceptionFilter = <span class="hljs-keyword">new</span> ExceptionFilter();

    RpcInvocation invocation = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"sayHello"</span>, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), "", <span class="hljs-title">new</span> <span class="hljs-title">Class</span>&lt;?&gt;[] </span>{ String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[] </span>{ <span class="hljs-string">"world"</span> });

    AppResponse mockRpcResult = <span class="hljs-keyword">new</span> AppResponse();

    mockRpcResult.setException(<span class="hljs-keyword">new</span> HessianException(<span class="hljs-string">"hessian"</span>));

    Result mockAsyncResult = AsyncRpcResult.newDefaultAsyncResult(mockRpcResult, invocation);

    Invoker&lt;DemoService&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(invocation)).thenReturn(mockAsyncResult);

    when(invoker.getInterface()).thenReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result asyncResult = exceptionFilter.invoke(invoker, invocation);

    AppResponse appResponse = (AppResponse) asyncResult.get();

    exceptionFilter.onResponse(appResponse, invoker, invocation);

    Assertions.assertFalse(appResponse.getException() <span class="hljs-keyword">instanceof</span> HessianException);

    Assertions.assertEquals(appResponse.getException().getClass(), RuntimeException<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;DemoService&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">()</span> </span>{
    Invoker&lt;DemoService&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invoker.getInterface()).thenReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci31">Mock Clone Instance #dubbo_MCI_31</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.auth.model.AccessKeyPair</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AccessKeyPair <span class="hljs-title">createMockAccessKeyPair</span><span class="hljs-params">(String secretKeyReturn)</span> </span>{
    AccessKeyPair accessKeyPair = mock(AccessKeyPair<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(accessKeyPair.getSecretKey()).thenReturn(secretKeyReturn);
    <span class="hljs-keyword">return</span> accessKeyPair;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest311">Test Case ID #dubbo_Test_31_1</h4>
<h4 id="test-case-name-testsignforrequestfile-cjavaprojectsapachedubbodubbo-plugindubbo-authsrctestjavaorgapachedubboauthaccesskeyauthenticatortestjava">Test Case Name: <code>testSignForRequest</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-auth\src\test\java\org\apache\dubbo\auth\AccessKeyAuthenticatorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-accesskeypair">Mock Object Variable Name: <code>accessKeyPair</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    doCallRealMethod().when(helper).sign(invocation, url);
    when(helper.getSignature(eq(url), eq(invocation), eq("sk"), anyString())).thenReturn("dubbo");
<span class="hljs-deletion">-    AccessKeyPair accessKeyPair = mock(AccessKeyPair.class);</span>
<span class="hljs-deletion">-    when(accessKeyPair.getSecretKey()).thenReturn("sk");</span>
<span class="hljs-addition">+    AccessKeyPair accessKeyPair = createMockAccessKeyPair("sk");</span>
    when(helper.getAccessKeyPair(invocation, url)).thenReturn(accessKeyPair);
    helper.sign(invocation, url);
    assertEquals(String.valueOf(invocation.getAttachment(CommonConstants.CONSUMER)), url.getApplication());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testSignForRequest</span><span class="hljs-params">()</span> </span>{

    URL url = URL.valueOf(<span class="hljs-string">"dubbo://10.10.10.10:2181"</span>).addParameter(Constants.ACCESS_KEY_ID_KEY, <span class="hljs-string">"ak"</span>).addParameter(CommonConstants.APPLICATION_KEY, <span class="hljs-string">"test"</span>).addParameter(Constants.SECRET_ACCESS_KEY_KEY, <span class="hljs-string">"sk"</span>);

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    AccessKeyAuthenticator helper = mock(AccessKeyAuthenticator<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    doCallRealMethod().when(helper).sign(invocation, url);

    when(helper.getSignature(eq(url), eq(invocation), eq(<span class="hljs-string">"sk"</span>), anyString())).thenReturn(<span class="hljs-string">"dubbo"</span>);

    AccessKeyPair accessKeyPair = mock(AccessKeyPair<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(accessKeyPair.getSecretKey()).thenReturn(<span class="hljs-string">"sk"</span>);

    when(helper.getAccessKeyPair(invocation, url)).thenReturn(accessKeyPair);

    helper.sign(invocation, url);

    assertEquals(String.valueOf(invocation.getAttachment(CommonConstants.CONSUMER)), url.getApplication());

    assertNotNull(invocation.getAttachments().get(Constants.REQUEST_SIGNATURE_KEY));

    assertEquals(invocation.getAttachments().get(Constants.REQUEST_SIGNATURE_KEY), <span class="hljs-string">"dubbo"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AccessKeyPair <span class="hljs-title">createMockAccessKeyPair</span><span class="hljs-params">(String secretKeyReturn)</span> </span>{
    AccessKeyPair accessKeyPair = mock(AccessKeyPair<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(accessKeyPair.getSecretKey()).thenReturn(secretKeyReturn);
    <span class="hljs-keyword">return</span> accessKeyPair;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest312">Test Case ID #dubbo_Test_31_2</h4>
<h4 id="test-case-name-testauthenticaterequestfile-cjavaprojectsapachedubbodubbo-plugindubbo-authsrctestjavaorgapachedubboauthaccesskeyauthenticatortestjava">Test Case Name: <code>testAuthenticateRequest</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-auth\src\test\java\org\apache\dubbo\auth\AccessKeyAuthenticatorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-accesskeypair">Mock Object Variable Name: <code>accessKeyPair</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    doCallRealMethod().when(helper).authenticate(invocation, url);
    when(helper.getSignature(eq(url), eq(invocation), eq("sk"), anyString())).thenReturn("dubbo");
<span class="hljs-deletion">-    AccessKeyPair accessKeyPair = mock(AccessKeyPair.class);</span>
<span class="hljs-deletion">-    when(accessKeyPair.getSecretKey()).thenReturn("sk");</span>
<span class="hljs-addition">+    AccessKeyPair accessKeyPair = createMockAccessKeyPair("sk");</span>
    when(helper.getAccessKeyPair(invocation, url)).thenReturn(accessKeyPair);
    assertDoesNotThrow(() -&gt; helper.authenticate(invocation, url));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAuthenticateRequest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RpcAuthenticationException </span>{

    URL url = URL.valueOf(<span class="hljs-string">"dubbo://10.10.10.10:2181"</span>).addParameter(Constants.ACCESS_KEY_ID_KEY, <span class="hljs-string">"ak"</span>).addParameter(CommonConstants.APPLICATION_KEY, <span class="hljs-string">"test"</span>).addParameter(Constants.SECRET_ACCESS_KEY_KEY, <span class="hljs-string">"sk"</span>);

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    invocation.setAttachment(Constants.ACCESS_KEY_ID_KEY, <span class="hljs-string">"ak"</span>);

    invocation.setAttachment(Constants.REQUEST_SIGNATURE_KEY, <span class="hljs-string">"dubbo"</span>);

    invocation.setAttachment(Constants.REQUEST_TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));

    invocation.setAttachment(CommonConstants.CONSUMER, <span class="hljs-string">"test"</span>);

    AccessKeyAuthenticator helper = mock(AccessKeyAuthenticator<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    doCallRealMethod().when(helper).authenticate(invocation, url);

    when(helper.getSignature(eq(url), eq(invocation), eq(<span class="hljs-string">"sk"</span>), anyString())).thenReturn(<span class="hljs-string">"dubbo"</span>);

    AccessKeyPair accessKeyPair = mock(AccessKeyPair<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(accessKeyPair.getSecretKey()).thenReturn(<span class="hljs-string">"sk"</span>);

    when(helper.getAccessKeyPair(invocation, url)).thenReturn(accessKeyPair);

    assertDoesNotThrow(() -&gt; helper.authenticate(invocation, url));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AccessKeyPair <span class="hljs-title">createMockAccessKeyPair</span><span class="hljs-params">(String secretKeyReturn)</span> </span>{
    AccessKeyPair accessKeyPair = mock(AccessKeyPair<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(accessKeyPair.getSecretKey()).thenReturn(secretKeyReturn);
    <span class="hljs-keyword">return</span> accessKeyPair;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci32">Mock Clone Instance #dubbo_MCI_32</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.common.extension.ExtensionLoader</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ExtensionLoader <span class="hljs-title">createMockExtensionLoader</span><span class="hljs-params">(RegistryFactory registryFactory)</span> </span>{
    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);
    <span class="hljs-keyword">return</span> extensionLoaderMock;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest321">Test Case ID #dubbo_Test_32_1</h4>
<h4 id="test-case-name-testreferwithoutgroupfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testReferWithoutGroup</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-extensionloadermock">Mock Object Variable Name: <code>extensionLoaderMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(new ApplicationConfig("application1"));
<span class="hljs-deletion">-    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader.class);</span>
<span class="hljs-addition">+    ExtensionLoader extensionLoaderMock = createMockExtensionLoader(registryFactory);</span>
    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener.class)).thenReturn(extensionLoaderMock);
    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);
    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory.class)).thenReturn(extensionLoaderMock);
<span class="hljs-deletion">-    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);</span>
    url = url.setScopeModel(moduleModel);
    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that if multiple groups are not configured, the service reference of the registration center

 * the default is FailoverCluster

 *

 * <span class="hljs-doctag">@see</span> FailoverCluster

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testReferWithoutGroup</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Invoker&lt;?&gt; invoker = registryProtocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    Assertions.assertTrue(((MigrationInvoker&lt;?&gt;) invoker).getCluster() <span class="hljs-keyword">instanceof</span> ScopeClusterWrapper);

    Assertions.assertTrue(((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> MockClusterWrapper);

    Assertions.assertTrue(((MockClusterWrapper) ((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> FailoverCluster);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ExtensionLoader <span class="hljs-title">createMockExtensionLoader</span><span class="hljs-params">(RegistryFactory registryFactory)</span> </span>{
    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);
    <span class="hljs-keyword">return</span> extensionLoaderMock;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest322">Test Case ID #dubbo_Test_32_2</h4>
<h4 id="test-case-name-testreferwithgroupfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testReferWithGroup</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-extensionloadermock">Mock Object Variable Name: <code>extensionLoaderMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(new ApplicationConfig("application1"));
<span class="hljs-deletion">-    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader.class);</span>
<span class="hljs-addition">+    ExtensionLoader extensionLoaderMock = createMockExtensionLoader(registryFactory);</span>
    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener.class)).thenReturn(extensionLoaderMock);
    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);
    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory.class)).thenReturn(extensionLoaderMock);
<span class="hljs-deletion">-    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);</span>
    url = url.setScopeModel(moduleModel);
    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that if multiple groups are configured, the service reference of the registration center

 *

 * <span class="hljs-doctag">@see</span> MergeableCluster

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testReferWithGroup</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    refer.put(GROUP_KEY, <span class="hljs-string">"group1,group2"</span>);

    attributes.put(REFER_KEY, refer);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Invoker&lt;?&gt; invoker = registryProtocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    Assertions.assertTrue(((MigrationInvoker&lt;?&gt;) invoker).getCluster() <span class="hljs-keyword">instanceof</span> ScopeClusterWrapper);

    Assertions.assertTrue(((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> MockClusterWrapper);

    Assertions.assertTrue(((MockClusterWrapper) ((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> MergeableCluster);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ExtensionLoader <span class="hljs-title">createMockExtensionLoader</span><span class="hljs-params">(RegistryFactory registryFactory)</span> </span>{
    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);
    <span class="hljs-keyword">return</span> extensionLoaderMock;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest323">Test Case ID #dubbo_Test_32_3</h4>
<h4 id="test-case-name-testregisterconsumerurlfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testRegisterConsumerUrl</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-extensionloadermock">Mock Object Variable Name: <code>extensionLoaderMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());
    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(new ApplicationConfig("application1"));
<span class="hljs-deletion">-    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader.class);</span>
<span class="hljs-deletion">-    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory.class)).thenReturn(extensionLoaderMock);</span>
<span class="hljs-deletion">-    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);</span>
<span class="hljs-addition">+    ExtensionLoader extensionLoaderMock = createMockExtensionLoader(registryFactory);</span>
<span class="hljs-addition">+    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory.class)).thenReturn(extensionLoaderMock);</span>
    url = url.setScopeModel(moduleModel);
    RegistryProtocol registryProtocol = new RegistryProtocol();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify the registered consumer url

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRegisterConsumerUrl</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"true"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);

    url = url.setScopeModel(moduleModel);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    Map&lt;String, String&gt; urlParameters = consumerUrl.getParameters();

    URL urlToRegistry = <span class="hljs-keyword">new</span> ServiceConfigURL(urlParameters.get(PROTOCOL_KEY) == <span class="hljs-keyword">null</span> ? CONSUMER : urlParameters.get(PROTOCOL_KEY), urlParameters.remove(REGISTER_IP_KEY), <span class="hljs-number">0</span>, consumerUrl.getPath(), urlParameters);

    URL registeredConsumerUrl = urlToRegistry.addParameters(CATEGORY_KEY, CONSUMERS_CATEGORY, CHECK_KEY, String.valueOf(<span class="hljs-keyword">false</span>)).setScopeModel(moduleModel);

    verify(registry, times(<span class="hljs-number">1</span>)).register(registeredConsumerUrl);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ExtensionLoader <span class="hljs-title">createMockExtensionLoader</span><span class="hljs-params">(RegistryFactory registryFactory)</span> </span>{
    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);
    <span class="hljs-keyword">return</span> extensionLoaderMock;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci33">Mock Clone Instance #dubbo_MCI_33</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.registry.client.migration.MigrationRuleListener</code></li>
<li><strong>Test Case Count</strong>: 5</li>
<li><strong>MO Count</strong>: 5</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MigrationRuleListener migrationRuleListener;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
migrationRuleListener

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest331">Test Case ID #dubbo_Test_33_1</h4>
<h4 id="test-case-name-testconsumerurlwithoutprotocolfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testConsumerUrlWithoutProtocol</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-migrationrulelistener">Mock Object Variable Name: <code>migrationRuleListener</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     RegistryProtocol registryProtocol = new RegistryProtocol();
<span class="hljs-deletion">-    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `migrationRuleListener`</span>
     List&lt;RegistryProtocolListener&gt; registryProtocolListeners = new ArrayList&lt;&gt;();
     registryProtocolListeners.add(migrationRuleListener);
     ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify the generated consumer url information

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumerUrlWithoutProtocol</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    <span class="hljs-comment">// verify that the protocol header of consumerUrl is set to "consumer"</span>

    Assertions.assertEquals(<span class="hljs-string">"consumer"</span>, consumerUrl.getProtocol());

    Assertions.assertEquals(parameters.get(REGISTER_IP_KEY), consumerUrl.getHost());

    Assertions.assertFalse(consumerUrl.getAttributes().containsKey(REFER_KEY));

    Assertions.assertEquals(<span class="hljs-string">"value1"</span>, consumerUrl.getAttribute(<span class="hljs-string">"key1"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MigrationRuleListener migrationRuleListener;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
migrationRuleListener

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest332">Test Case ID #dubbo_Test_33_2</h4>
<h4 id="test-case-name-testconsumerurlwithprotocolfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testConsumerUrlWithProtocol</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-migrationrulelistener">Mock Object Variable Name: <code>migrationRuleListener</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     Registry registry = mock(Registry.class);
<span class="hljs-deletion">-    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `migrationRuleListener`</span>
     List&lt;RegistryProtocolListener&gt; registryProtocolListeners = new ArrayList&lt;&gt;();
     registryProtocolListeners.add(migrationRuleListener);
     ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that when the protocol is configured, the protocol of consumer url is the configured protocol

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumerUrlWithProtocol</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    parameters.put(PROTOCOL_KEY, <span class="hljs-string">"tri"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    <span class="hljs-comment">// verify that the protocol of consumer url</span>

    Assertions.assertEquals(<span class="hljs-string">"tri"</span>, consumerUrl.getProtocol());

    Assertions.assertEquals(parameters.get(REGISTER_IP_KEY), consumerUrl.getHost());

    Assertions.assertFalse(consumerUrl.getAttributes().containsKey(REFER_KEY));

    Assertions.assertEquals(<span class="hljs-string">"value1"</span>, consumerUrl.getAttribute(<span class="hljs-string">"key1"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MigrationRuleListener migrationRuleListener;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
migrationRuleListener

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest333">Test Case ID #dubbo_Test_33_3</h4>
<h4 id="test-case-name-testreferwithoutgroupfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testReferWithoutGroup</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-migrationrulelistener">Mock Object Variable Name: <code>migrationRuleListener</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     RegistryFactory registryFactory = mock(RegistryFactory.class);
     Registry registry = mock(Registry.class);
<span class="hljs-deletion">-    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `migrationRuleListener`</span>
     List&lt;RegistryProtocolListener&gt; registryProtocolListeners = new ArrayList&lt;&gt;();
     registryProtocolListeners.add(migrationRuleListener);
     RegistryProtocol registryProtocol = new RegistryProtocol();
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that if multiple groups are not configured, the service reference of the registration center

 * the default is FailoverCluster

 *

 * <span class="hljs-doctag">@see</span> FailoverCluster

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testReferWithoutGroup</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Invoker&lt;?&gt; invoker = registryProtocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    Assertions.assertTrue(((MigrationInvoker&lt;?&gt;) invoker).getCluster() <span class="hljs-keyword">instanceof</span> ScopeClusterWrapper);

    Assertions.assertTrue(((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> MockClusterWrapper);

    Assertions.assertTrue(((MockClusterWrapper) ((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> FailoverCluster);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MigrationRuleListener migrationRuleListener;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
migrationRuleListener

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest334">Test Case ID #dubbo_Test_33_4</h4>
<h4 id="test-case-name-testreferwithgroupfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testReferWithGroup</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-migrationrulelistener">Mock Object Variable Name: <code>migrationRuleListener</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     RegistryFactory registryFactory = mock(RegistryFactory.class);
     Registry registry = mock(Registry.class);
<span class="hljs-deletion">-    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `migrationRuleListener`</span>
     List&lt;RegistryProtocolListener&gt; registryProtocolListeners = new ArrayList&lt;&gt;();
<span class="hljs-deletion">-    registryProtocolListeners.add(migrationRuleListener);</span>
<span class="hljs-addition">+    registryProtocolListeners.add(migrationRuleListener);</span>
     RegistryProtocol registryProtocol = new RegistryProtocol();
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that if multiple groups are configured, the service reference of the registration center

 *

 * <span class="hljs-doctag">@see</span> MergeableCluster

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testReferWithGroup</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    refer.put(GROUP_KEY, <span class="hljs-string">"group1,group2"</span>);

    attributes.put(REFER_KEY, refer);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Invoker&lt;?&gt; invoker = registryProtocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    Assertions.assertTrue(((MigrationInvoker&lt;?&gt;) invoker).getCluster() <span class="hljs-keyword">instanceof</span> ScopeClusterWrapper);

    Assertions.assertTrue(((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> MockClusterWrapper);

    Assertions.assertTrue(((MockClusterWrapper) ((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> MergeableCluster);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MigrationRuleListener migrationRuleListener;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
migrationRuleListener

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest335">Test Case ID #dubbo_Test_33_5</h4>
<h4 id="test-case-name-testinterceptinvokerformigrationrulelistenerfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testInterceptInvokerForMigrationRuleListener</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-migrationrulelistener">Mock Object Variable Name: <code>migrationRuleListener</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     url = url.putAttribute(CONSUMER_URL_KEY, consumerUrl);
<span class="hljs-deletion">-    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `migrationRuleListener`</span>
     List&lt;RegistryProtocolListener&gt; registryProtocolListeners = new ArrayList&lt;&gt;();
     registryProtocolListeners.add(migrationRuleListener);
     RegistryProtocol registryProtocol = new RegistryProtocol();
@@
     registryProtocol.interceptInvoker(clusterInvoker, url, consumerUrl);
<span class="hljs-deletion">-    verify(migrationRuleListener, times(1)).onRefer(registryProtocol, clusterInvoker, consumerUrl, url);</span>
<span class="hljs-addition">+    verify(migrationRuleListener, times(1)).onRefer(registryProtocol, clusterInvoker, consumerUrl, url);</span>
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that the default RegistryProtocolListener will be executed

 *

 * <span class="hljs-doctag">@see</span> MigrationRuleListener

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInterceptInvokerForMigrationRuleListener</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    refer.put(GROUP_KEY, <span class="hljs-string">"group1,group2"</span>);

    attributes.put(REFER_KEY, refer);

    URL url = serviceConfigURL.addAttributes(attributes);

    MigrationInvoker&lt;?&gt; clusterInvoker = mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Map&lt;String, Object&gt; consumerAttribute = <span class="hljs-keyword">new</span> HashMap&lt;&gt;(url.getAttributes());

    consumerAttribute.remove(REFER_KEY);

    URL consumerUrl = <span class="hljs-keyword">new</span> ServiceConfigURL(parameters.get(PROTOCOL_KEY) == <span class="hljs-keyword">null</span> ? DUBBO : parameters.get(PROTOCOL_KEY), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, parameters.get(REGISTER_IP_KEY), <span class="hljs-number">0</span>, url.getPath(), parameters, consumerAttribute);

    url = url.putAttribute(CONSUMER_URL_KEY, consumerUrl);

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    registryProtocol.interceptInvoker(clusterInvoker, url, consumerUrl);

    verify(migrationRuleListener, times(<span class="hljs-number">1</span>)).onRefer(registryProtocol, clusterInvoker, consumerUrl, url);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MigrationRuleListener migrationRuleListener;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
migrationRuleListener

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci34">Mock Clone Instance #dubbo_MCI_34</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Invoker&lt;?&gt;</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with getUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> url the URL to return from getUrl()
     * <span class="hljs-doctag">@return</span> a mock Invoker with getUrl() stubbed
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker&lt;?&gt; createMockInvoker(URL url) {
        Invoker&lt;?&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest341">Test Case ID #dubbo_Test_34_1</h4>
<h4 id="test-case-name-dostartcallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcprotocoltricallreflectionservercalltestjava">Test Case Name: <code>doStartCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\protocol\tri\call\ReflectionServerCallTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 void doStartCall() throws NoSuchMethodException {
<span class="hljs-deletion">-    Invoker&lt;?&gt; invoker = Mockito.mock(Invoker.class);</span>
     TripleServerStream serverStream = Mockito.mock(TripleServerStream.class);
     ProviderModel providerModel = Mockito.mock(ProviderModel.class);
     Method method = DescriptorService.class.getMethod("sayHello", HelloReply.class);
     MethodDescriptor methodDescriptor = new ReflectionMethodDescriptor(method);
     URL url = Mockito.mock(URL.class);
<span class="hljs-addition">+    Invoker&lt;?&gt; invoker = MockInvoker.createMockInvoker(url);</span>
     when(url.getServiceModel()).thenReturn(providerModel);
     String service = "testService";
     String methodName = "method";
     try {
         ReflectionAbstractServerCall call = new ReflectionAbstractServerCall(invoker, serverStream, new FrameworkModel(), "", service, methodName, Collections.emptyList(), ImmediateEventExecutor.INSTANCE);
         fail();
     } catch (Exception e) {
         // pass
     }
     ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
     when(serviceDescriptor.getMethods(anyString())).thenReturn(Collections.singletonList(methodDescriptor));
     when(providerModel.getServiceModel()).thenReturn(serviceDescriptor);
     ReflectionAbstractServerCall call2 = new ReflectionAbstractServerCall(invoker, serverStream, new FrameworkModel(), "", service, methodName, Collections.emptyList(), ImmediateEventExecutor.INSTANCE);
     call2.onHeader(Collections.emptyMap());
     call2.onMessage(new byte[0], false);
     call2.onComplete();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">doStartCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NoSuchMethodException </span>{

    Invoker&lt;?&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TripleServerStream serverStream = Mockito.mock(TripleServerStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ProviderModel providerModel = Mockito.mock(ProviderModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Method method = DescriptorService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getMethod</span>("<span class="hljs-title">sayHello</span>", <span class="hljs-title">HelloReply</span>.<span class="hljs-title">class</span>)</span>;

    MethodDescriptor methodDescriptor = <span class="hljs-keyword">new</span> ReflectionMethodDescriptor(method);

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(url.getServiceModel()).thenReturn(providerModel);

    String service = <span class="hljs-string">"testService"</span>;

    String methodName = <span class="hljs-string">"method"</span>;

    <span class="hljs-keyword">try</span> {

        ReflectionAbstractServerCall call = <span class="hljs-keyword">new</span> ReflectionAbstractServerCall(invoker, serverStream, <span class="hljs-keyword">new</span> FrameworkModel(), <span class="hljs-string">""</span>, service, methodName, Collections.emptyList(), ImmediateEventExecutor.INSTANCE);

        fail();

    } <span class="hljs-keyword">catch</span> (Exception e) {

        <span class="hljs-comment">// pass</span>

    }

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(serviceDescriptor.getMethods(anyString())).thenReturn(Collections.singletonList(methodDescriptor));

    when(providerModel.getServiceModel()).thenReturn(serviceDescriptor);

    ReflectionAbstractServerCall call2 = <span class="hljs-keyword">new</span> ReflectionAbstractServerCall(invoker, serverStream, <span class="hljs-keyword">new</span> FrameworkModel(), <span class="hljs-string">""</span>, service, methodName, Collections.emptyList(), ImmediateEventExecutor.INSTANCE);

    call2.onHeader(Collections.emptyMap());

    call2.onMessage(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">0</span>], <span class="hljs-keyword">false</span>);

    call2.onComplete();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with getUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> url the URL to return from getUrl()
     * <span class="hljs-doctag">@return</span> a mock Invoker with getUrl() stubbed
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker&lt;?&gt; createMockInvoker(URL url) {
        Invoker&lt;?&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest342">Test Case ID #dubbo_Test_34_2</h4>
<h4 id="test-case-name-dostartcallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcprotocoltricallstubservercalltestjava">Test Case Name: <code>doStartCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\protocol\tri\call\StubServerCallTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 void doStartCall() throws IOException, ClassNotFoundException {
<span class="hljs-deletion">-    Invoker&lt;?&gt; invoker = Mockito.mock(Invoker.class);</span>
     TripleServerStream tripleServerStream = Mockito.mock(TripleServerStream.class);
     ProviderModel providerModel = Mockito.mock(ProviderModel.class);
     ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
     StubMethodDescriptor methodDescriptor = Mockito.mock(StubMethodDescriptor.class);
     URL url = Mockito.mock(URL.class);
<span class="hljs-addition">+    Invoker&lt;?&gt; invoker = MockInvoker.createMockInvoker(url);</span>
     when(url.getServiceModel()).thenReturn(providerModel);
     when(providerModel.getServiceModel()).thenReturn(serviceDescriptor);
     when(serviceDescriptor.getMethods(anyString())).thenReturn(Collections.singletonList(methodDescriptor));
     when(methodDescriptor.getRpcType()).thenReturn(RpcType.UNARY);
     when(methodDescriptor.parseRequest(any(byte[].class))).thenReturn("test");
     String service = "testService";
     String method = "method";
     StubAbstractServerCall call = new StubAbstractServerCall(invoker, tripleServerStream, new FrameworkModel(), "", service, method, ImmediateEventExecutor.INSTANCE);
     call.onHeader(Collections.emptyMap());
     call.onMessage(new byte[0], false);
     call.onComplete();
@@
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">doStartCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>{

    Invoker&lt;?&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TripleServerStream tripleServerStream = Mockito.mock(TripleServerStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ProviderModel providerModel = Mockito.mock(ProviderModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    StubMethodDescriptor methodDescriptor = Mockito.mock(StubMethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(url.getServiceModel()).thenReturn(providerModel);

    when(providerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(serviceDescriptor.getMethods(anyString())).thenReturn(Collections.singletonList(methodDescriptor));

    when(methodDescriptor.getRpcType()).thenReturn(RpcType.UNARY);

    when(methodDescriptor.parseRequest(any(<span class="hljs-keyword">byte</span>[]<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>("<span class="hljs-title">test</span>")</span>;

    String service = <span class="hljs-string">"testService"</span>;

    String method = <span class="hljs-string">"method"</span>;

    StubAbstractServerCall call = <span class="hljs-keyword">new</span> StubAbstractServerCall(invoker, tripleServerStream, <span class="hljs-keyword">new</span> FrameworkModel(), <span class="hljs-string">""</span>, service, method, ImmediateEventExecutor.INSTANCE);

    call.onHeader(Collections.emptyMap());

    call.onMessage(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">0</span>], <span class="hljs-keyword">false</span>);

    call.onComplete();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with getUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> url the URL to return from getUrl()
     * <span class="hljs-doctag">@return</span> a mock Invoker with getUrl() stubbed
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker&lt;?&gt; createMockInvoker(URL url) {
        Invoker&lt;?&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci35">Mock Clone Instance #dubbo_MCI_35</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.registry.client.migration.model.MigrationRule</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MigrationRule <span class="hljs-title">createMockMigrationRule</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> forceReturn)</span> </span>{
    MigrationRule migrationRule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(forceReturn);
    <span class="hljs-keyword">return</span> migrationRule;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest351">Test Case ID #dubbo_Test_35_1</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationinvokertestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-migrationrule">Mock Object Variable Name: <code>migrationRule</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    MigrationInvoker&lt;?&gt; migrationInvoker = new MigrationInvoker&lt;&gt;(registryProtocol, null, null, DemoService.class, null, consumerURL);
<span class="hljs-deletion">-    MigrationRule migrationRule = Mockito.mock(MigrationRule.class);</span>
<span class="hljs-deletion">-    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(true);</span>
<span class="hljs-addition">+    MigrationRule migrationRule = createMockMigrationRule(true);</span>
    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);
    migrationInvoker.invoke(null);
    Mockito.verify(invoker, Mockito.times(1)).invoke(null);
@@
    migrationInvoker.invoke(null);
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(1)).invoke(null);
<span class="hljs-deletion">-    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(1.0f);</span>
<span class="hljs-addition">+    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(1.0f);</span>
    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);
    migrationInvoker.invoke(null);
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(2)).invoke(null);
<span class="hljs-deletion">-    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(2.0f);</span>
<span class="hljs-addition">+    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(2.0f);</span>
    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);
    migrationInvoker.invoke(null);
    Mockito.verify(invoker, Mockito.times(2)).invoke(null);
<span class="hljs-deletion">-    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(false);</span>
<span class="hljs-deletion">-    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(1.0f);</span>
<span class="hljs-addition">+    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(false);</span>
<span class="hljs-addition">+    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(1.0f);</span>
    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);
    migrationInvoker.invoke(null);
    Mockito.verify(invoker, Mockito.times(3)).invoke(null);
    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);
    migrationInvoker.invoke(null);
    Mockito.verify(invoker, Mockito.times(4)).invoke(null);
<span class="hljs-deletion">-    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(2.0f);</span>
<span class="hljs-addition">+    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(2.0f);</span>
    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);
    migrationInvoker.invoke(null);
    Mockito.verify(invoker, Mockito.times(5)).invoke(null);
<span class="hljs-deletion">-    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(1.0f);</span>
<span class="hljs-addition">+    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(1.0f);</span>
    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);
    migrationInvoker.invoke(null);
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(3)).invoke(null);
    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);
    migrationInvoker.invoke(null);
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(4)).invoke(null);
<span class="hljs-deletion">-    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(2.0f);</span>
<span class="hljs-addition">+    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(2.0f);</span>
    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);
    migrationInvoker.invoke(null);
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(5)).invoke(null);
<span class="hljs-deletion">-    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(2.0f);</span>
<span class="hljs-deletion">-    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(true);</span>
<span class="hljs-addition">+    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(2.0f);</span>
<span class="hljs-addition">+    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(true);</span>
    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);
    migrationInvoker.invoke(null);
    Mockito.verify(invoker, Mockito.times(6)).invoke(null);
    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);
    migrationInvoker.invoke(null);
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(6)).invoke(null);
<span class="hljs-deletion">-    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(false);</span>
<span class="hljs-addition">+    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(false);</span>
    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);
    migrationInvoker.invoke(null);
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(7)).invoke(null);
    Assertions.assertNull(migrationInvoker.getInvoker());
<span class="hljs-deletion">-    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(true);</span>
<span class="hljs-addition">+    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(true);</span>
    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);
<span class="hljs-deletion">-    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(false);</span>
<span class="hljs-addition">+    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(false);</span>
    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);
    migrationInvoker.invoke(null);
    Mockito.verify(invoker, Mockito.times(7)).invoke(null);
    Assertions.assertNull(migrationInvoker.getServiceDiscoveryInvoker());
    ArgumentCaptor&lt;InvokersChangedListener&gt; argument = ArgumentCaptor.forClass(InvokersChangedListener.class);
    Mockito.verify(serviceDiscoveryDirectory, Mockito.atLeastOnce()).setInvokersChangedListener(argument.capture());
<span class="hljs-deletion">-    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(1.0f);</span>
<span class="hljs-addition">+    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(1.0f);</span>
    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);
    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);
    for (int i = 0; i &lt; 20; i++) {
        migrationInvoker.invoke(null);
    }
    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(27)).invoke(null);
    serviceDiscoveryInvokers.remove(1);
    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(false);
    argument.getAllValues().get(argument.getAllValues().size() - 1).onChange();
    for (int i = 0; i &lt; 20; i++) {
        migrationInvoker.invoke(null);
    }
    Mockito.verify(invoker, Mockito.times(27)).invoke(null);
    serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(true);
    argument.getAllValues().get(argument.getAllValues().size() - 1).onChange();
<span class="hljs-deletion">-    Mockito.when(migrationRule.getProportion(Mockito.any())).thenReturn(50);</span>
<span class="hljs-addition">+    Mockito.when(migrationRule.getProportion(Mockito.any())).thenReturn(50);</span>
    migrationInvoker.setMigrationRule(migrationRule);
    for (int i = 0; i &lt; 1000; i++) {
        migrationInvoker.invoke(null);
    }
    Mockito.verify(serviceDiscoveryInvoker, Mockito.atMost(1026)).invoke(null);
    Mockito.verify(invoker, Mockito.atLeast(28)).invoke(null);
<span class="hljs-deletion">-    Mockito.when(migrationRule.getDelay(Mockito.any())).thenReturn(1);</span>
<span class="hljs-addition">+    Mockito.when(migrationRule.getDelay(Mockito.any())).thenReturn(1);</span>
    long currentTimeMillis = System.currentTimeMillis();
    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);
    Assertions.assertTrue(System.currentTimeMillis() - currentTimeMillis &gt;= 2000);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"all"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker invoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory directory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(invoker.getDirectory()).thenReturn(directory);

    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);

    Mockito.when(invoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(invoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;Invoker&lt;?&gt;&gt; invokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);

    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);

    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);

    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceInterface()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getGroup()).thenReturn(<span class="hljs-string">"Group"</span>);

    Mockito.when(consumerURL.getVersion()).thenReturn(<span class="hljs-string">"0.0.0"</span>);

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Group/Test:0.0.0"</span>);

    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn(<span class="hljs-string">"Test:0.0.0"</span>);

    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());

    Mockito.when(invoker.getUrl()).thenReturn(consumerURL);

    Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);

    MigrationInvoker&lt;?&gt; migrationInvoker = <span class="hljs-keyword">new</span> MigrationInvoker&lt;&gt;(registryProtocol, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">null</span>, <span class="hljs-title">consumerURL</span>)</span>;

    MigrationRule migrationRule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">3</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">4</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">5</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">3</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">4</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">5</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">6</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">6</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">7</span>)).invoke(<span class="hljs-keyword">null</span>);

    Assertions.assertNull(migrationInvoker.getInvoker());

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">7</span>)).invoke(<span class="hljs-keyword">null</span>);

    Assertions.assertNull(migrationInvoker.getServiceDiscoveryInvoker());

    ArgumentCaptor&lt;InvokersChangedListener&gt; argument = ArgumentCaptor.forClass(InvokersChangedListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(serviceDiscoveryDirectory, Mockito.atLeastOnce()).setInvokersChangedListener(argument.capture());

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">27</span>)).invoke(<span class="hljs-keyword">null</span>);

    serviceDiscoveryInvokers.remove(<span class="hljs-number">1</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">false</span>);

    argument.getAllValues().get(argument.getAllValues().size() - <span class="hljs-number">1</span>).onChange();

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">27</span>)).invoke(<span class="hljs-keyword">null</span>);

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    argument.getAllValues().get(argument.getAllValues().size() - <span class="hljs-number">1</span>).onChange();

    Mockito.when(migrationRule.getProportion(Mockito.any())).thenReturn(<span class="hljs-number">50</span>);

    migrationInvoker.setMigrationRule(migrationRule);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(serviceDiscoveryInvoker, Mockito.atMost(<span class="hljs-number">1026</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.atLeast(<span class="hljs-number">28</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getDelay(Mockito.any())).thenReturn(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">long</span> currentTimeMillis = System.currentTimeMillis();

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    Assertions.assertTrue(System.currentTimeMillis() - currentTimeMillis &gt;= <span class="hljs-number">2000</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MigrationRule <span class="hljs-title">createMockMigrationRule</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> forceReturn)</span> </span>{
    MigrationRule migrationRule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(forceReturn);
    <span class="hljs-keyword">return</span> migrationRule;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest352">Test Case ID #dubbo_Test_35_2</h4>
<h4 id="test-case-name-testdecidefile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationinvokertestjava">Test Case Name: <code>testDecide</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-migrationrule">Mock Object Variable Name: <code>migrationRule</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);
     migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);
     migrationInvoker.invoke(null);
     Mockito.verify(serviceDiscoveryInvoker, Mockito.times(1)).invoke(null);
<span class="hljs-deletion">-    MigrationRule migrationRule = Mockito.mock(MigrationRule.class);</span>
<span class="hljs-deletion">-    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(true);</span>
<span class="hljs-addition">+    MigrationRule migrationRule = createMockMigrationRule(true);</span>
     migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);
     migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);
     migrationInvoker.invoke(null);
     Mockito.verify(serviceDiscoveryInvoker, Mockito.times(1)).invoke(null);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"all"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testDecide</span><span class="hljs-params">()</span> </span>{

    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker invoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory directory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(invoker.getDirectory()).thenReturn(directory);

    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);

    Mockito.when(invoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(invoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;Invoker&lt;?&gt;&gt; invokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);

    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);

    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);

    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceInterface()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getGroup()).thenReturn(<span class="hljs-string">"Group"</span>);

    Mockito.when(consumerURL.getVersion()).thenReturn(<span class="hljs-string">"0.0.0"</span>);

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Group/Test:0.0.0"</span>);

    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn(<span class="hljs-string">"Test:0.0.0"</span>);

    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());

    Mockito.when(invoker.getUrl()).thenReturn(consumerURL);

    Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);

    MigrationInvoker&lt;?&gt; migrationInvoker = <span class="hljs-keyword">new</span> MigrationInvoker&lt;&gt;(registryProtocol, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">null</span>, <span class="hljs-title">consumerURL</span>)</span>;

    MigrationRule migrationRule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MigrationRule <span class="hljs-title">createMockMigrationRule</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> forceReturn)</span> </span>{
    MigrationRule migrationRule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(forceReturn);
    <span class="hljs-keyword">return</span> migrationRule;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci36">Mock Clone Instance #dubbo_MCI_36</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Invocation</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(org.apache.dubbo.rpc.Invoker&lt;?&gt; invoker, String methodName)</span> </span>{
    org.apache.dubbo.rpc.Invocation invocation = Mockito.mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invocation.getInvoker()).thenReturn(invoker);
    when(invocation.getMethodName()).thenReturn(methodName);
    <span class="hljs-keyword">return</span> invocation;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest361">Test Case ID #dubbo_Test_36_1</h4>
<h4 id="test-case-name-testroutepathmatchfile-cjavaprojectsapachedubbodubbo-xdssrctestjavaorgapachedubborpcclusterrouterxdsxdsroutetestjava">Test Case Name: <code>testRoutePathMatch</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-xds\src\test\java\org\apache\dubbo\rpc\cluster\router\xds\XdsRouteTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    hostListener.parseVirtualHost(virtualHost);
<span class="hljs-deletion">-    Invocation invocation = Mockito.mock(Invocation.class);</span>
<span class="hljs-addition">+    Invocation invocation = createMockInvocation(invoker, "call");</span>
    Invoker invoker = Mockito.mock(Invoker.class);
    URL url1 = Mockito.mock(URL.class);
    when(invoker.getUrl()).thenReturn(url1);
    when(url1.getPath()).thenReturn("DemoInterface");
<span class="hljs-deletion">-    when(invocation.getInvoker()).thenReturn(invoker);</span>
<span class="hljs-deletion">-    when(invocation.getMethodName()).thenReturn("call");</span>
    Set&lt;Endpoint&gt; endpoints = new HashSet&lt;&gt;();
    Endpoint endpoint1 = new Endpoint();
    endpoint1.setAddress("1.1.1.1");
    endpoint1.setPortValue(20880);
    endpoints.add(endpoint1);
    edsEndpointManager.notifyEndpointChange(cluster1, endpoints);
    BitList&lt;Invoker&lt;Object&gt;&gt; routes = xdsRouter.route(invokers.clone(), null, invocation, false, null);
    assertEquals(1, routes.size());
    assertEquals(invoker1, routes.get(0));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRoutePathMatch</span><span class="hljs-params">()</span> </span>{

    XdsRouter&lt;Object&gt; xdsRouter = <span class="hljs-keyword">new</span> XdsRouter&lt;&gt;(url, rdsRouteRuleManager, edsEndpointManager, <span class="hljs-keyword">true</span>);

    String appName = <span class="hljs-string">"app1"</span>;

    String cluster1 = <span class="hljs-string">"cluster-test1"</span>;

    Invoker&lt;Object&gt; invoker1 = createInvoker(appName, <span class="hljs-string">"1.1.1.1:20880"</span>);

    BitList&lt;Invoker&lt;Object&gt;&gt; invokers = <span class="hljs-keyword">new</span> BitList&lt;&gt;(Arrays.asList(invoker1, createInvoker(appName, <span class="hljs-string">"2.2.2.2:20880"</span>)));

    xdsRouter.notify(invokers);

    String path = <span class="hljs-string">"/DemoInterface/call"</span>;

    VirtualHost virtualHost = VirtualHost.newBuilder().addDomains(appName).addRoutes(Route.newBuilder().setName(<span class="hljs-string">"route-test"</span>).setMatch(RouteMatch.newBuilder().setPath(path).build()).setRoute(RouteAction.newBuilder().setCluster(cluster1).build()).build()).build();

    RdsVirtualHostListener hostListener = <span class="hljs-keyword">new</span> RdsVirtualHostListener(appName, rdsRouteRuleManager);

    hostListener.parseVirtualHost(virtualHost);

    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url1 = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.getUrl()).thenReturn(url1);

    when(url1.getPath()).thenReturn(<span class="hljs-string">"DemoInterface"</span>);

    when(invocation.getInvoker()).thenReturn(invoker);

    when(invocation.getMethodName()).thenReturn(<span class="hljs-string">"call"</span>);

    Set&lt;Endpoint&gt; endpoints = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    Endpoint endpoint1 = <span class="hljs-keyword">new</span> Endpoint();

    endpoint1.setAddress(<span class="hljs-string">"1.1.1.1"</span>);

    endpoint1.setPortValue(<span class="hljs-number">20880</span>);

    endpoints.add(endpoint1);

    edsEndpointManager.notifyEndpointChange(cluster1, endpoints);

    BitList&lt;Invoker&lt;Object&gt;&gt; routes = xdsRouter.route(invokers.clone(), <span class="hljs-keyword">null</span>, invocation, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);

    assertEquals(<span class="hljs-number">1</span>, routes.size());

    assertEquals(invoker1, routes.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(org.apache.dubbo.rpc.Invoker&lt;?&gt; invoker, String methodName)</span> </span>{
    org.apache.dubbo.rpc.Invocation invocation = Mockito.mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invocation.getInvoker()).thenReturn(invoker);
    when(invocation.getMethodName()).thenReturn(methodName);
    <span class="hljs-keyword">return</span> invocation;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest362">Test Case ID #dubbo_Test_36_2</h4>
<h4 id="test-case-name-testroutemultiappfile-cjavaprojectsapachedubbodubbo-xdssrctestjavaorgapachedubborpcclusterrouterxdsxdsroutetestjava">Test Case Name: <code>testRouteMultiApp</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-xds\src\test\java\org\apache\dubbo\rpc\cluster\router\xds\XdsRouteTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    RdsVirtualHostListener hostListener = new RdsVirtualHostListener(appName2, rdsRouteRuleManager);
    hostListener.parseVirtualHost(virtualHost);
<span class="hljs-deletion">-    Invocation invocation = Mockito.mock(Invocation.class);</span>
<span class="hljs-addition">+    Invocation invocation = createMockInvocation(invoker, "call");</span>
    Invoker invoker = Mockito.mock(Invoker.class);
    URL url1 = Mockito.mock(URL.class);
    when(invoker.getUrl()).thenReturn(url1);
    when(url1.getPath()).thenReturn("DemoInterface");
<span class="hljs-deletion">-    when(invocation.getInvoker()).thenReturn(invoker);</span>
<span class="hljs-deletion">-    when(invocation.getMethodName()).thenReturn("call");</span>
    Set&lt;Endpoint&gt; endpoints = new HashSet&lt;&gt;();
    Endpoint endpoint1 = new Endpoint();
    endpoint1.setAddress("1.1.1.1");
    endpoint1.setPortValue(20880);
    endpoints.add(endpoint1);
    edsEndpointManager.notifyEndpointChange(cluster1, endpoints);
    BitList&lt;Invoker&lt;Object&gt;&gt; routes = xdsRouter.route(invokers.clone(), null, invocation, false, null);
    assertEquals(1, routes.size());
    assertEquals(invoker1, routes.get(0));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRouteMultiApp</span><span class="hljs-params">()</span> </span>{

    XdsRouter&lt;Object&gt; xdsRouter = <span class="hljs-keyword">new</span> XdsRouter&lt;&gt;(url, rdsRouteRuleManager, edsEndpointManager, <span class="hljs-keyword">true</span>);

    String appName1 = <span class="hljs-string">"app1"</span>;

    String appName2 = <span class="hljs-string">"app2"</span>;

    String cluster1 = <span class="hljs-string">"cluster-test1"</span>;

    Invoker&lt;Object&gt; invoker1 = createInvoker(appName2, <span class="hljs-string">"1.1.1.1:20880"</span>);

    Invoker&lt;Object&gt; invoker2 = createInvoker(appName1, <span class="hljs-string">"2.2.2.2:20880"</span>);

    BitList&lt;Invoker&lt;Object&gt;&gt; invokers = <span class="hljs-keyword">new</span> BitList&lt;&gt;(Arrays.asList(invoker1, invoker2));

    xdsRouter.notify(invokers);

    assertEquals(xdsRouter.getSubscribeApplications().size(), <span class="hljs-number">2</span>);

    String path = <span class="hljs-string">"/DemoInterface/call"</span>;

    VirtualHost virtualHost = VirtualHost.newBuilder().addDomains(appName2).addRoutes(Route.newBuilder().setName(<span class="hljs-string">"route-test"</span>).setMatch(RouteMatch.newBuilder().setPath(path).build()).setRoute(RouteAction.newBuilder().setCluster(cluster1).build()).build()).build();

    RdsVirtualHostListener hostListener = <span class="hljs-keyword">new</span> RdsVirtualHostListener(appName2, rdsRouteRuleManager);

    hostListener.parseVirtualHost(virtualHost);

    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url1 = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.getUrl()).thenReturn(url1);

    when(url1.getPath()).thenReturn(<span class="hljs-string">"DemoInterface"</span>);

    when(invocation.getInvoker()).thenReturn(invoker);

    when(invocation.getMethodName()).thenReturn(<span class="hljs-string">"call"</span>);

    Set&lt;Endpoint&gt; endpoints = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    Endpoint endpoint1 = <span class="hljs-keyword">new</span> Endpoint();

    endpoint1.setAddress(<span class="hljs-string">"1.1.1.1"</span>);

    endpoint1.setPortValue(<span class="hljs-number">20880</span>);

    endpoints.add(endpoint1);

    edsEndpointManager.notifyEndpointChange(cluster1, endpoints);

    BitList&lt;Invoker&lt;Object&gt;&gt; routes = xdsRouter.route(invokers.clone(), <span class="hljs-keyword">null</span>, invocation, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);

    assertEquals(<span class="hljs-number">1</span>, routes.size());

    assertEquals(invoker1, routes.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(org.apache.dubbo.rpc.Invoker&lt;?&gt; invoker, String methodName)</span> </span>{
    org.apache.dubbo.rpc.Invocation invocation = Mockito.mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invocation.getInvoker()).thenReturn(invoker);
    when(invocation.getMethodName()).thenReturn(methodName);
    <span class="hljs-keyword">return</span> invocation;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci37">Mock Clone Instance #dubbo_MCI_37</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Invocation</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String attachmentKey, String attachmentValue)</span> </span>{
    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invocation.getAttachment(attachmentKey)).thenReturn(attachmentValue);
    <span class="hljs-keyword">return</span> invocation;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest371">Test Case ID #dubbo_Test_37_1</h4>
<h4 id="test-case-name-testrouteheadmatchfile-cjavaprojectsapachedubbodubbo-xdssrctestjavaorgapachedubborpcclusterrouterxdsxdsroutetestjava">Test Case Name: <code>testRouteHeadMatch</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-xds\src\test\java\org\apache\dubbo\rpc\cluster\router\xds\XdsRouteTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    hostListener.parseVirtualHost(virtualHost);
<span class="hljs-deletion">-    Invocation invocation = Mockito.mock(Invocation.class);</span>
<span class="hljs-deletion">-    when(invocation.getAttachment("userId")).thenReturn("123");</span>
<span class="hljs-addition">+    Invocation invocation = createMockInvocation("userId", "123");</span>
    Set&lt;Endpoint&gt; endpoints = new HashSet&lt;&gt;();
    Endpoint endpoint1 = new Endpoint();
    endpoint1.setAddress("1.1.1.1");
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRouteHeadMatch</span><span class="hljs-params">()</span> </span>{

    XdsRouter&lt;Object&gt; xdsRouter = <span class="hljs-keyword">new</span> XdsRouter&lt;&gt;(url, rdsRouteRuleManager, edsEndpointManager, <span class="hljs-keyword">true</span>);

    String appName = <span class="hljs-string">"app1"</span>;

    String cluster1 = <span class="hljs-string">"cluster-test1"</span>;

    Invoker&lt;Object&gt; invoker1 = createInvoker(appName, <span class="hljs-string">"1.1.1.1:20880"</span>);

    BitList&lt;Invoker&lt;Object&gt;&gt; invokers = <span class="hljs-keyword">new</span> BitList&lt;&gt;(Arrays.asList(invoker1, createInvoker(appName, <span class="hljs-string">"2.2.2.2:20880"</span>)));

    xdsRouter.notify(invokers);

    VirtualHost virtualHost = VirtualHost.newBuilder().addDomains(appName).addRoutes(Route.newBuilder().setName(<span class="hljs-string">"route-test"</span>).setMatch(RouteMatch.newBuilder().addHeaders(HeaderMatcher.newBuilder().setName(<span class="hljs-string">"userId"</span>).setExactMatch(<span class="hljs-string">"123"</span>).build()).build()).setRoute(RouteAction.newBuilder().setCluster(cluster1).build()).build()).build();

    RdsVirtualHostListener hostListener = <span class="hljs-keyword">new</span> RdsVirtualHostListener(appName, rdsRouteRuleManager);

    hostListener.parseVirtualHost(virtualHost);

    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getAttachment(<span class="hljs-string">"userId"</span>)).thenReturn(<span class="hljs-string">"123"</span>);

    Set&lt;Endpoint&gt; endpoints = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    Endpoint endpoint1 = <span class="hljs-keyword">new</span> Endpoint();

    endpoint1.setAddress(<span class="hljs-string">"1.1.1.1"</span>);

    endpoint1.setPortValue(<span class="hljs-number">20880</span>);

    endpoints.add(endpoint1);

    edsEndpointManager.notifyEndpointChange(cluster1, endpoints);

    BitList&lt;Invoker&lt;Object&gt;&gt; routes = xdsRouter.route(invokers.clone(), <span class="hljs-keyword">null</span>, invocation, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);

    assertEquals(<span class="hljs-number">1</span>, routes.size());

    assertEquals(invoker1, routes.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String attachmentKey, String attachmentValue)</span> </span>{
    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invocation.getAttachment(attachmentKey)).thenReturn(attachmentValue);
    <span class="hljs-keyword">return</span> invocation;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest372">Test Case ID #dubbo_Test_37_2</h4>
<h4 id="test-case-name-testrouteweightclusterfile-cjavaprojectsapachedubbodubbo-xdssrctestjavaorgapachedubborpcclusterrouterxdsxdsroutetestjava">Test Case Name: <code>testRouteWeightCluster</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-xds\src\test\java\org\apache\dubbo\rpc\cluster\router\xds\XdsRouteTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    hostListener.parseVirtualHost(virtualHost);
<span class="hljs-deletion">-    Invocation invocation = Mockito.mock(Invocation.class);</span>
<span class="hljs-deletion">-    when(invocation.getAttachment("userId")).thenReturn("123");</span>
<span class="hljs-addition">+    Invocation invocation = createMockInvocation("userId", "123");</span>
    Set&lt;Endpoint&gt; endpoints = new HashSet&lt;&gt;();
    Endpoint endpoint1 = new Endpoint();
    endpoint1.setAddress("1.1.1.1");
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRouteWeightCluster</span><span class="hljs-params">()</span> </span>{

    XdsRouter&lt;Object&gt; xdsRouter = <span class="hljs-keyword">new</span> XdsRouter&lt;&gt;(url, rdsRouteRuleManager, edsEndpointManager, <span class="hljs-keyword">true</span>);

    String appName = <span class="hljs-string">"app1"</span>;

    String cluster1 = <span class="hljs-string">"cluster-test1"</span>;

    String cluster2 = <span class="hljs-string">"cluster-test2"</span>;

    Invoker&lt;Object&gt; invoker1 = createInvoker(appName, <span class="hljs-string">"1.1.1.1:20880"</span>);

    BitList&lt;Invoker&lt;Object&gt;&gt; invokers = <span class="hljs-keyword">new</span> BitList&lt;&gt;(Arrays.asList(invoker1, createInvoker(appName, <span class="hljs-string">"2.2.2.2:20880"</span>)));

    xdsRouter.notify(invokers);

    VirtualHost virtualHost = VirtualHost.newBuilder().addDomains(appName).addRoutes(Route.newBuilder().setName(<span class="hljs-string">"route-test"</span>).setMatch(RouteMatch.newBuilder().addHeaders(HeaderMatcher.newBuilder().setName(<span class="hljs-string">"userId"</span>).setExactMatch(<span class="hljs-string">"123"</span>).build()).build()).setRoute(RouteAction.newBuilder().setWeightedClusters(WeightedCluster.newBuilder().addClusters(WeightedCluster.ClusterWeight.newBuilder().setName(cluster1).setWeight(UInt32Value.newBuilder().setValue(<span class="hljs-number">100</span>).build()).build()).addClusters(WeightedCluster.ClusterWeight.newBuilder().setName(cluster2).setWeight(UInt32Value.newBuilder().setValue(<span class="hljs-number">0</span>).build()).build()).build()).build()).build()).build();

    RdsVirtualHostListener hostListener = <span class="hljs-keyword">new</span> RdsVirtualHostListener(appName, rdsRouteRuleManager);

    hostListener.parseVirtualHost(virtualHost);

    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getAttachment(<span class="hljs-string">"userId"</span>)).thenReturn(<span class="hljs-string">"123"</span>);

    Set&lt;Endpoint&gt; endpoints = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    Endpoint endpoint1 = <span class="hljs-keyword">new</span> Endpoint();

    endpoint1.setAddress(<span class="hljs-string">"1.1.1.1"</span>);

    endpoint1.setPortValue(<span class="hljs-number">20880</span>);

    endpoints.add(endpoint1);

    edsEndpointManager.notifyEndpointChange(cluster1, endpoints);

    endpoints = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    Endpoint endpoint2 = <span class="hljs-keyword">new</span> Endpoint();

    endpoint2.setAddress(<span class="hljs-string">"2.2.2.2"</span>);

    endpoint2.setPortValue(<span class="hljs-number">20880</span>);

    endpoints.add(endpoint2);

    edsEndpointManager.notifyEndpointChange(cluster2, endpoints);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {

        BitList&lt;Invoker&lt;Object&gt;&gt; routes = xdsRouter.route(invokers.clone(), <span class="hljs-keyword">null</span>, invocation, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);

        assertEquals(<span class="hljs-number">1</span>, routes.size());

        assertEquals(invoker1, routes.get(<span class="hljs-number">0</span>));

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String attachmentKey, String attachmentValue)</span> </span>{
    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invocation.getAttachment(attachmentKey)).thenReturn(attachmentValue);
    <span class="hljs-keyword">return</span> invocation;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci38">Mock Clone Instance #dubbo_MCI_38</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Invocation</code></li>
<li><strong>Test Case Count</strong>: 9</li>
<li><strong>MO Count</strong>: 9</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvocation</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String methodName, Class&lt;?&gt;[] parameterTypes, Object[] arguments)</span> </span>{
        org.apache.dubbo.rpc.Invocation invocation = mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invocation.getMethodName()).willReturn(methodName);
        given(invocation.getParameterTypes()).willReturn(parameterTypes);
        given(invocation.getArguments()).willReturn(arguments);
        <span class="hljs-keyword">return</span> invocation;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest381">Test Case ID #dubbo_Test_38_1</h4>
<h4 id="test-case-name-testinvokergenericfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltercompatiblefilterfiltertestjava">Test Case Name: <code>testInvokerGeneric</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\CompatibleFilterFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 void testInvokerGeneric() {
<span class="hljs-deletion">-    invocation = mock(RpcInvocation.class);</span>
<span class="hljs-deletion">-    given(invocation.getMethodName()).willReturn("$enumlength");</span>
<span class="hljs-deletion">-    given(invocation.getParameterTypes()).willReturn(new Class&lt;?&gt;[] { Enum.class });</span>
<span class="hljs-deletion">-    given(invocation.getArguments()).willReturn(new Object[] { "hello" });</span>
<span class="hljs-addition">+    invocation = MockInvocation.createMockInvocation("$enumlength", new Class&lt;?&gt;[] { Enum.class }, new Object[] { "hello" });</span>
    invoker = mock(Invoker.class);
    given(invoker.isAvailable()).willReturn(true);
    given(invoker.getInterface()).willReturn(DemoService.class);
    AppResponse result = new AppResponse();
    result.setValue("High");
    given(invoker.invoke(invocation)).willReturn(result);
    URL url = URL.valueOf("test://test:11/test?group=dubbo&amp;version=1.1");
    given(invoker.getUrl()).willReturn(url);
    Result filterResult = compatibleFilter.invoke(invoker, invocation);
    assertEquals(filterResult, result);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokerGeneric</span><span class="hljs-params">()</span> </span>{

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"$enumlength"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { Enum<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span> });

    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AppResponse result = <span class="hljs-keyword">new</span> AppResponse();

    result.setValue(<span class="hljs-string">"High"</span>);

    given(invoker.invoke(invocation)).willReturn(result);

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?group=dubbo&amp;version=1.1"</span>);

    given(invoker.getUrl()).willReturn(url);

    Result filterResult = compatibleFilter.invoke(invoker, invocation);

    assertEquals(filterResult, result);

}
<span class="hljs-meta">@AfterEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span> </span>{

    Mockito.reset(invocation, invoker);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvocation</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String methodName, Class&lt;?&gt;[] parameterTypes, Object[] arguments)</span> </span>{
        org.apache.dubbo.rpc.Invocation invocation = mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invocation.getMethodName()).willReturn(methodName);
        given(invocation.getParameterTypes()).willReturn(parameterTypes);
        given(invocation.getArguments()).willReturn(arguments);
        <span class="hljs-keyword">return</span> invocation;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest382">Test Case ID #dubbo_Test_38_2</h4>
<h4 id="test-case-name-testresulthasexceptionfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltercompatiblefilterfiltertestjava">Test Case Name: <code>testResultHasException</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\CompatibleFilterFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void testResultHasException() {
<span class="hljs-deletion">-    invocation = mock(RpcInvocation.class);</span>
<span class="hljs-deletion">-    given(invocation.getMethodName()).willReturn("enumlength");</span>
<span class="hljs-deletion">-    given(invocation.getParameterTypes()).willReturn(new Class&lt;?&gt;[] { Enum.class });</span>
<span class="hljs-deletion">-    given(invocation.getArguments()).willReturn(new Object[] { "hello" });</span>
<span class="hljs-addition">+    invocation = MockInvocation.createMockInvocation("enumlength", new Class&lt;?&gt;[] { Enum.class }, new Object[] { "hello" });</span>
     invoker = mock(Invoker.class);
     given(invoker.isAvailable()).willReturn(true);
     given(invoker.getInterface()).willReturn(DemoService.class);
     AppResponse result = new AppResponse();
     result.setException(new RuntimeException());
     result.setValue("High");
     given(invoker.invoke(invocation)).willReturn(result);
     URL url = URL.valueOf("test://test:11/test?group=dubbo&amp;version=1.1");
     given(invoker.getUrl()).willReturn(url);
     Result filterResult = compatibleFilter.invoke(invoker, invocation);
     assertEquals(filterResult, result);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testResultHasException</span><span class="hljs-params">()</span> </span>{

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"enumlength"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { Enum<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span> });

    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AppResponse result = <span class="hljs-keyword">new</span> AppResponse();

    result.setException(<span class="hljs-keyword">new</span> RuntimeException());

    result.setValue(<span class="hljs-string">"High"</span>);

    given(invoker.invoke(invocation)).willReturn(result);

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?group=dubbo&amp;version=1.1"</span>);

    given(invoker.getUrl()).willReturn(url);

    Result filterResult = compatibleFilter.invoke(invoker, invocation);

    assertEquals(filterResult, result);

}
<span class="hljs-meta">@AfterEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span> </span>{

    Mockito.reset(invocation, invoker);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvocation</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String methodName, Class&lt;?&gt;[] parameterTypes, Object[] arguments)</span> </span>{
        org.apache.dubbo.rpc.Invocation invocation = mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invocation.getMethodName()).willReturn(methodName);
        given(invocation.getParameterTypes()).willReturn(parameterTypes);
        given(invocation.getArguments()).willReturn(arguments);
        <span class="hljs-keyword">return</span> invocation;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest383">Test Case ID #dubbo_Test_38_3</h4>
<h4 id="test-case-name-testinvokerjsonpojoserializationfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltercompatiblefilterfiltertestjava">Test Case Name: <code>testInvokerJsonPojoSerialization</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\CompatibleFilterFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- a/TestClass.java</span>
<span class="hljs-comment">+++ b/TestClass.java</span>
@@
 @Test
 void testInvokerJsonPojoSerialization() throws Exception {
<span class="hljs-deletion">-    invocation = mock(RpcInvocation.class);</span>
<span class="hljs-deletion">-    given(invocation.getMethodName()).willReturn("enumlength");</span>
<span class="hljs-deletion">-    given(invocation.getParameterTypes()).willReturn(new Class&lt;?&gt;[] { Type[].class });</span>
<span class="hljs-deletion">-    given(invocation.getArguments()).willReturn(new Object[] { "hello" });</span>
<span class="hljs-addition">+    invocation = MockInvocation.createMockInvocation("enumlength", new Class&lt;?&gt;[] { Type[].class }, new Object[] { "hello" });</span>
     invoker = mock(Invoker.class);
     given(invoker.isAvailable()).willReturn(true);
     given(invoker.getInterface()).willReturn(DemoService.class);
     AppResponse result = new AppResponse();
     result.setValue("High");
     AsyncRpcResult defaultAsyncResult = AsyncRpcResult.newDefaultAsyncResult(result, invocation);
     given(invoker.invoke(invocation)).willReturn(defaultAsyncResult);
     URL url = URL.valueOf("test://test:11/test?group=dubbo&amp;version=1.1&amp;serialization=json");
     given(invoker.getUrl()).willReturn(url);
     Result asyncResult = compatibleFilter.invoke(invoker, invocation);
     AppResponse appResponse = (AppResponse) asyncResult.get();
     compatibleFilter.onResponse(appResponse, invoker, invocation);
     assertEquals(Type.High, appResponse.getValue());
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokerJsonPojoSerialization</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"enumlength"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { Type[]<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span> });

    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AppResponse result = <span class="hljs-keyword">new</span> AppResponse();

    result.setValue(<span class="hljs-string">"High"</span>);

    AsyncRpcResult defaultAsyncResult = AsyncRpcResult.newDefaultAsyncResult(result, invocation);

    given(invoker.invoke(invocation)).willReturn(defaultAsyncResult);

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?group=dubbo&amp;version=1.1&amp;serialization=json"</span>);

    given(invoker.getUrl()).willReturn(url);

    Result asyncResult = compatibleFilter.invoke(invoker, invocation);

    AppResponse appResponse = (AppResponse) asyncResult.get();

    compatibleFilter.onResponse(appResponse, invoker, invocation);

    assertEquals(Type.High, appResponse.getValue());

}
<span class="hljs-meta">@AfterEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span> </span>{

    Mockito.reset(invocation, invoker);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvocation</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String methodName, Class&lt;?&gt;[] parameterTypes, Object[] arguments)</span> </span>{
        org.apache.dubbo.rpc.Invocation invocation = mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invocation.getMethodName()).willReturn(methodName);
        given(invocation.getParameterTypes()).willReturn(parameterTypes);
        given(invocation.getArguments()).willReturn(arguments);
        <span class="hljs-keyword">return</span> invocation;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest384">Test Case ID #dubbo_Test_38_4</h4>
<h4 id="test-case-name-testinvokernonjsonenumserializationfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltercompatiblefilterfiltertestjava">Test Case Name: <code>testInvokerNonJsonEnumSerialization</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\CompatibleFilterFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void testInvokerNonJsonEnumSerialization() throws Exception {
<span class="hljs-deletion">-    invocation = mock(RpcInvocation.class);</span>
<span class="hljs-deletion">-    given(invocation.getMethodName()).willReturn("enumlength");</span>
<span class="hljs-deletion">-    given(invocation.getParameterTypes()).willReturn(new Class&lt;?&gt;[] { Type[].class });</span>
<span class="hljs-deletion">-    given(invocation.getArguments()).willReturn(new Object[] { "hello" });</span>
<span class="hljs-addition">+    invocation = MockInvocation.createMockInvocation("enumlength", new Class&lt;?&gt;[] { Type[].class }, new Object[] { "hello" });</span>
     invoker = mock(Invoker.class);
     given(invoker.isAvailable()).willReturn(true);
     given(invoker.getInterface()).willReturn(DemoService.class);
     AppResponse result = new AppResponse();
     result.setValue("High");
     AsyncRpcResult defaultAsyncResult = AsyncRpcResult.newDefaultAsyncResult(result, invocation);
     given(invoker.invoke(invocation)).willReturn(defaultAsyncResult);
     URL url = URL.valueOf("test://test:11/test?group=dubbo&amp;version=1.1");
     given(invoker.getUrl()).willReturn(url);
     Result asyncResult = compatibleFilter.invoke(invoker, invocation);
     AppResponse appResponse = (AppResponse) asyncResult.get();
     compatibleFilter.onResponse(appResponse, invoker, invocation);
     assertEquals(Type.High, appResponse.getValue());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokerNonJsonEnumSerialization</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"enumlength"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { Type[]<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span> });

    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AppResponse result = <span class="hljs-keyword">new</span> AppResponse();

    result.setValue(<span class="hljs-string">"High"</span>);

    AsyncRpcResult defaultAsyncResult = AsyncRpcResult.newDefaultAsyncResult(result, invocation);

    given(invoker.invoke(invocation)).willReturn(defaultAsyncResult);

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?group=dubbo&amp;version=1.1"</span>);

    given(invoker.getUrl()).willReturn(url);

    Result asyncResult = compatibleFilter.invoke(invoker, invocation);

    AppResponse appResponse = (AppResponse) asyncResult.get();

    compatibleFilter.onResponse(appResponse, invoker, invocation);

    assertEquals(Type.High, appResponse.getValue());

}
<span class="hljs-meta">@AfterEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span> </span>{

    Mockito.reset(invocation, invoker);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvocation</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String methodName, Class&lt;?&gt;[] parameterTypes, Object[] arguments)</span> </span>{
        org.apache.dubbo.rpc.Invocation invocation = mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invocation.getMethodName()).willReturn(methodName);
        given(invocation.getParameterTypes()).willReturn(parameterTypes);
        given(invocation.getArguments()).willReturn(arguments);
        <span class="hljs-keyword">return</span> invocation;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest385">Test Case ID #dubbo_Test_38_5</h4>
<h4 id="test-case-name-testinvokernonjsonnonpojoserializationfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltercompatiblefilterfiltertestjava">Test Case Name: <code>testInvokerNonJsonNonPojoSerialization</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\CompatibleFilterFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 void testInvokerNonJsonNonPojoSerialization() {
<span class="hljs-deletion">-    invocation = mock(RpcInvocation.class);</span>
<span class="hljs-deletion">-    given(invocation.getMethodName()).willReturn("echo");</span>
<span class="hljs-deletion">-    given(invocation.getParameterTypes()).willReturn(new Class&lt;?&gt;[] { String.class });</span>
<span class="hljs-deletion">-    given(invocation.getArguments()).willReturn(new Object[] { "hello" });</span>
<span class="hljs-addition">+    invocation = MockInvocation.createMockInvocation("echo", new Class&lt;?&gt;[] { String.class }, new Object[] { "hello" });</span>
    invoker = mock(Invoker.class);
    given(invoker.isAvailable()).willReturn(true);
    given(invoker.getInterface()).willReturn(DemoService.class);
    AppResponse result = new AppResponse();
    result.setValue(new String[] { "High" });
    given(invoker.invoke(invocation)).willReturn(result);
    URL url = URL.valueOf("test://test:11/test?group=dubbo&amp;version=1.1");
    given(invoker.getUrl()).willReturn(url);
    Result filterResult = compatibleFilter.invoke(invoker, invocation);
    assertArrayEquals(new String[] { "High" }, (String[]) filterResult.getValue());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokerNonJsonNonPojoSerialization</span><span class="hljs-params">()</span> </span>{

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"echo"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span> });

    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AppResponse result = <span class="hljs-keyword">new</span> AppResponse();

    result.setValue(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"High"</span> });

    given(invoker.invoke(invocation)).willReturn(result);

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?group=dubbo&amp;version=1.1"</span>);

    given(invoker.getUrl()).willReturn(url);

    Result filterResult = compatibleFilter.invoke(invoker, invocation);

    assertArrayEquals(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"High"</span> }, (String[]) filterResult.getValue());

}
<span class="hljs-meta">@AfterEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span> </span>{

    Mockito.reset(invocation, invoker);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvocation</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String methodName, Class&lt;?&gt;[] parameterTypes, Object[] arguments)</span> </span>{
        org.apache.dubbo.rpc.Invocation invocation = mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invocation.getMethodName()).willReturn(methodName);
        given(invocation.getParameterTypes()).willReturn(parameterTypes);
        given(invocation.getArguments()).willReturn(arguments);
        <span class="hljs-keyword">return</span> invocation;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest386">Test Case ID #dubbo_Test_38_6</h4>
<h4 id="test-case-name-testinvokernonjsonpojoserializationfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltercompatiblefilterfiltertestjava">Test Case Name: <code>testInvokerNonJsonPojoSerialization</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\CompatibleFilterFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 void testInvokerNonJsonPojoSerialization() {
<span class="hljs-deletion">-    invocation = mock(RpcInvocation.class);</span>
<span class="hljs-deletion">-    given(invocation.getMethodName()).willReturn("echo");</span>
<span class="hljs-deletion">-    given(invocation.getParameterTypes()).willReturn(new Class&lt;?&gt;[] { String.class });</span>
<span class="hljs-deletion">-    given(invocation.getArguments()).willReturn(new Object[] { "hello" });</span>
<span class="hljs-addition">+    invocation = MockInvocation.createMockInvocation("echo", new Class&lt;?&gt;[] { String.class }, new Object[] { "hello" });</span>
    invoker = mock(Invoker.class);
    given(invoker.isAvailable()).willReturn(true);
    given(invoker.getInterface()).willReturn(DemoService.class);
    AppResponse result = new AppResponse();
    result.setValue("hello");
    given(invoker.invoke(invocation)).willReturn(result);
    URL url = URL.valueOf("test://test:11/test?group=dubbo&amp;version=1.1");
    given(invoker.getUrl()).willReturn(url);
    Result filterResult = compatibleFilter.invoke(invoker, invocation);
    assertEquals("hello", filterResult.getValue());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokerNonJsonPojoSerialization</span><span class="hljs-params">()</span> </span>{

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"echo"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span> });

    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AppResponse result = <span class="hljs-keyword">new</span> AppResponse();

    result.setValue(<span class="hljs-string">"hello"</span>);

    given(invoker.invoke(invocation)).willReturn(result);

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?group=dubbo&amp;version=1.1"</span>);

    given(invoker.getUrl()).willReturn(url);

    Result filterResult = compatibleFilter.invoke(invoker, invocation);

    assertEquals(<span class="hljs-string">"hello"</span>, filterResult.getValue());

}
<span class="hljs-meta">@AfterEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span> </span>{

    Mockito.reset(invocation, invoker);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvocation</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String methodName, Class&lt;?&gt;[] parameterTypes, Object[] arguments)</span> </span>{
        org.apache.dubbo.rpc.Invocation invocation = mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invocation.getMethodName()).willReturn(methodName);
        given(invocation.getParameterTypes()).willReturn(parameterTypes);
        given(invocation.getArguments()).willReturn(arguments);
        <span class="hljs-keyword">return</span> invocation;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest387">Test Case ID #dubbo_Test_38_7</h4>
<h4 id="test-case-name-testsetcontextfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltercontextfiltertestjava">Test Case Name: <code>testSetContext</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\ContextFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 void testSetContext() {
<span class="hljs-deletion">-    invocation = mock(Invocation.class);</span>
<span class="hljs-deletion">-    given(invocation.getMethodName()).willReturn("$enumlength");</span>
<span class="hljs-deletion">-    given(invocation.getParameterTypes()).willReturn(new Class&lt;?&gt;[] { Enum.class });</span>
<span class="hljs-deletion">-    given(invocation.getArguments()).willReturn(new Object[] { "hello" });</span>
<span class="hljs-deletion">-    given(invocation.getObjectAttachments()).willReturn(null);</span>
<span class="hljs-addition">+    invocation = MockInvocation.createMockInvocation("$enumlength", new Class&lt;?&gt;[] { Enum.class }, new Object[] { "hello" });</span>
<span class="hljs-addition">+    given(invocation.getObjectAttachments()).willReturn(null);</span>
    invoker = mock(Invoker.class);
    given(invoker.isAvailable()).willReturn(true);
    given(invoker.getInterface()).willReturn(DemoService.class);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testSetContext</span><span class="hljs-params">()</span> </span>{

    invocation = mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"$enumlength"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { Enum<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span> });

    given(invocation.getObjectAttachments()).willReturn(<span class="hljs-keyword">null</span>);

    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AppResponse result = <span class="hljs-keyword">new</span> AppResponse();

    result.setValue(<span class="hljs-string">"High"</span>);

    given(invoker.invoke(invocation)).willReturn(result);

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?group=dubbo&amp;version=1.1"</span>);

    given(invoker.getUrl()).willReturn(url);

    contextFilter.invoke(invoker, invocation);

    assertNotNull(RpcContext.getServiceContext().getInvoker());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvocation</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String methodName, Class&lt;?&gt;[] parameterTypes, Object[] arguments)</span> </span>{
        org.apache.dubbo.rpc.Invocation invocation = mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invocation.getMethodName()).willReturn(methodName);
        given(invocation.getParameterTypes()).willReturn(parameterTypes);
        given(invocation.getArguments()).willReturn(arguments);
        <span class="hljs-keyword">return</span> invocation;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest388">Test Case ID #dubbo_Test_38_8</h4>
<h4 id="test-case-name-testechofile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfilterechofiltertestjava">Test Case Name: <code>testEcho</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\EchoFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 void testEcho() {
<span class="hljs-deletion">-    Invocation invocation = mock(RpcInvocation.class);</span>
<span class="hljs-deletion">-    given(invocation.getMethodName()).willReturn("$echo");</span>
<span class="hljs-deletion">-    given(invocation.getParameterTypes()).willReturn(new Class&lt;?&gt;[] { Enum.class });</span>
<span class="hljs-deletion">-    given(invocation.getArguments()).willReturn(new Object[] { "hello" });</span>
<span class="hljs-deletion">-    given(invocation.getObjectAttachments()).willReturn(null);</span>
<span class="hljs-addition">+    Invocation invocation = MockInvocation.createMockInvocation("$echo", new Class&lt;?&gt;[] { Enum.class }, new Object[] { "hello" });</span>
<span class="hljs-addition">+    given(invocation.getObjectAttachments()).willReturn(null);</span>
     Invoker&lt;DemoService&gt; invoker = mock(Invoker.class);
     given(invoker.isAvailable()).willReturn(true);
     given(invoker.getInterface()).willReturn(DemoService.class);
     AppResponse result = new AppResponse();
     result.setValue("High");
     given(invoker.invoke(invocation)).willReturn(result);
     URL url = URL.valueOf("test://test:11/test?group=dubbo&amp;version=1.1");
     given(invoker.getUrl()).willReturn(url);
     Result filterResult = echoFilter.invoke(invoker, invocation);
     assertEquals("hello", filterResult.getValue());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testEcho</span><span class="hljs-params">()</span> </span>{

    Invocation invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"$echo"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { Enum<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span> });

    given(invocation.getObjectAttachments()).willReturn(<span class="hljs-keyword">null</span>);

    Invoker&lt;DemoService&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AppResponse result = <span class="hljs-keyword">new</span> AppResponse();

    result.setValue(<span class="hljs-string">"High"</span>);

    given(invoker.invoke(invocation)).willReturn(result);

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?group=dubbo&amp;version=1.1"</span>);

    given(invoker.getUrl()).willReturn(url);

    Result filterResult = echoFilter.invoke(invoker, invocation);

    assertEquals(<span class="hljs-string">"hello"</span>, filterResult.getValue());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvocation</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String methodName, Class&lt;?&gt;[] parameterTypes, Object[] arguments)</span> </span>{
        org.apache.dubbo.rpc.Invocation invocation = mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invocation.getMethodName()).willReturn(methodName);
        given(invocation.getParameterTypes()).willReturn(parameterTypes);
        given(invocation.getArguments()).willReturn(arguments);
        <span class="hljs-keyword">return</span> invocation;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest389">Test Case ID #dubbo_Test_38_9</h4>
<h4 id="test-case-name-testnonechofile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfilterechofiltertestjava">Test Case Name: <code>testNonEcho</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\EchoFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testNonEcho() {
<span class="hljs-deletion">-    Invocation invocation = mock(Invocation.class);</span>
<span class="hljs-deletion">-    given(invocation.getMethodName()).willReturn("echo");</span>
<span class="hljs-deletion">-    given(invocation.getParameterTypes()).willReturn(new Class&lt;?&gt;[] { Enum.class });</span>
<span class="hljs-deletion">-    given(invocation.getArguments()).willReturn(new Object[] { "hello" });</span>
<span class="hljs-deletion">-    given(invocation.getObjectAttachments()).willReturn(null);</span>
<span class="hljs-addition">+    Invocation invocation = MockInvocation.createMockInvocation("echo", new Class&lt;?&gt;[] { Enum.class }, new Object[] { "hello" });</span>
<span class="hljs-addition">+    given(invocation.getObjectAttachments()).willReturn(null);</span>
    Invoker&lt;DemoService&gt; invoker = mock(Invoker.class);
    given(invoker.isAvailable()).willReturn(true);
    given(invoker.getInterface()).willReturn(DemoService.class);
    AppResponse result = new AppResponse();
    result.setValue("High");
    given(invoker.invoke(invocation)).willReturn(result);
    URL url = URL.valueOf("test://test:11/test?group=dubbo&amp;version=1.1");
    given(invoker.getUrl()).willReturn(url);
    Result filterResult = echoFilter.invoke(invoker, invocation);
    assertEquals("High", filterResult.getValue());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testNonEcho</span><span class="hljs-params">()</span> </span>{

    Invocation invocation = mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"echo"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { Enum<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span> });

    given(invocation.getObjectAttachments()).willReturn(<span class="hljs-keyword">null</span>);

    Invoker&lt;DemoService&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AppResponse result = <span class="hljs-keyword">new</span> AppResponse();

    result.setValue(<span class="hljs-string">"High"</span>);

    given(invoker.invoke(invocation)).willReturn(result);

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?group=dubbo&amp;version=1.1"</span>);

    given(invoker.getUrl()).willReturn(url);

    Result filterResult = echoFilter.invoke(invoker, invocation);

    assertEquals(<span class="hljs-string">"High"</span>, filterResult.getValue());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvocation</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String methodName, Class&lt;?&gt;[] parameterTypes, Object[] arguments)</span> </span>{
        org.apache.dubbo.rpc.Invocation invocation = mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invocation.getMethodName()).willReturn(methodName);
        given(invocation.getParameterTypes()).willReturn(parameterTypes);
        given(invocation.getArguments()).willReturn(arguments);
        <span class="hljs-keyword">return</span> invocation;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci39">Mock Clone Instance #dubbo_MCI_39</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Invocation</code></li>
<li><strong>Test Case Count</strong>: 6</li>
<li><strong>MO Count</strong>: 6</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvocation</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String methodNameReturn)</span> </span>{
        org.apache.dubbo.rpc.Invocation invocation = Mockito.mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invocation.getMethodName()).thenReturn(methodNameReturn);
        <span class="hljs-keyword">return</span> invocation;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest391">Test Case ID #dubbo_Test_39_1</h4>
<h4 id="test-case-name-testnoexecutelimitinvokefile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfilterexecutelimitfiltertestjava">Test Case Name: <code>testNoExecuteLimitInvoke</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\ExecuteLimitFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     when(invoker.getUrl()).thenReturn(URL.valueOf("test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1"));
<span class="hljs-deletion">-    Invocation invocation = Mockito.mock(Invocation.class);</span>
<span class="hljs-deletion">-    when(invocation.getMethodName()).thenReturn("testNoExecuteLimitInvoke");</span>
<span class="hljs-addition">+    Invocation invocation = MockInvocation.createMockInvocation("testNoExecuteLimitInvoke");</span>
     Result result = executeLimitFilter.invoke(invoker, invocation);
     Assertions.assertEquals("result", result.getValue());
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testNoExecuteLimitInvoke</span><span class="hljs-params">()</span> </span>{

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">AppResponse</span>("<span class="hljs-title">result</span>"))</span>;

    when(invoker.getUrl()).thenReturn(URL.valueOf(<span class="hljs-string">"test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1"</span>));

    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getMethodName()).thenReturn(<span class="hljs-string">"testNoExecuteLimitInvoke"</span>);

    Result result = executeLimitFilter.invoke(invoker, invocation);

    Assertions.assertEquals(<span class="hljs-string">"result"</span>, result.getValue());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvocation</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String methodNameReturn)</span> </span>{
        org.apache.dubbo.rpc.Invocation invocation = Mockito.mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invocation.getMethodName()).thenReturn(methodNameReturn);
        <span class="hljs-keyword">return</span> invocation;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest392">Test Case ID #dubbo_Test_39_2</h4>
<h4 id="test-case-name-testexecutelimitinvokefile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfilterexecutelimitfiltertestjava">Test Case Name: <code>testExecuteLimitInvoke</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\ExecuteLimitFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(invoker.getUrl()).thenReturn(URL.valueOf("test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1&amp;executes=10"));
<span class="hljs-deletion">-    Invocation invocation = Mockito.mock(Invocation.class);</span>
<span class="hljs-deletion">-    when(invocation.getMethodName()).thenReturn("testExecuteLimitInvoke");</span>
<span class="hljs-addition">+    Invocation invocation = MockInvocation.createMockInvocation("testExecuteLimitInvoke");</span>
    Result result = executeLimitFilter.invoke(invoker, invocation);
    Assertions.assertEquals("result", result.getValue());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testExecuteLimitInvoke</span><span class="hljs-params">()</span> </span>{

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">AppResponse</span>("<span class="hljs-title">result</span>"))</span>;

    when(invoker.getUrl()).thenReturn(URL.valueOf(<span class="hljs-string">"test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1&amp;executes=10"</span>));

    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getMethodName()).thenReturn(<span class="hljs-string">"testExecuteLimitInvoke"</span>);

    Result result = executeLimitFilter.invoke(invoker, invocation);

    Assertions.assertEquals(<span class="hljs-string">"result"</span>, result.getValue());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvocation</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String methodNameReturn)</span> </span>{
        org.apache.dubbo.rpc.Invocation invocation = Mockito.mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invocation.getMethodName()).thenReturn(methodNameReturn);
        <span class="hljs-keyword">return</span> invocation;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest393">Test Case ID #dubbo_Test_39_3</h4>
<h4 id="test-case-name-testexecutelimitinvokewithexceptionfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfilterexecutelimitfiltertestjava">Test Case Name: <code>testExecuteLimitInvokeWithException</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\ExecuteLimitFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    URL url = URL.valueOf("test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1&amp;executes=10");
    when(invoker.getUrl()).thenReturn(url);
<span class="hljs-deletion">-    Invocation invocation = Mockito.mock(Invocation.class);</span>
<span class="hljs-deletion">-    when(invocation.getMethodName()).thenReturn("testExecuteLimitInvokeWitException");</span>
<span class="hljs-addition">+    Invocation invocation = MockInvocation.createMockInvocation("testExecuteLimitInvokeWitException");</span>
    try {
        executeLimitFilter.invoke(invoker, invocation);
    } catch (Exception e) {
        Assertions.assertTrue(e instanceof RpcException);
        executeLimitFilter.onError(e, invoker, invocation);
    }
    Assertions.assertEquals(1, RpcStatus.getStatus(url, invocation.getMethodName()).getFailed());
    RpcStatus.removeStatus(url, invocation.getMethodName());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testExecuteLimitInvokeWithException</span><span class="hljs-params">()</span> </span>{

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    doThrow(<span class="hljs-keyword">new</span> RpcException()).when(invoker).invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1&amp;executes=10"</span>);

    when(invoker.getUrl()).thenReturn(url);

    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getMethodName()).thenReturn(<span class="hljs-string">"testExecuteLimitInvokeWitException"</span>);

    <span class="hljs-keyword">try</span> {

        executeLimitFilter.invoke(invoker, invocation);

    } <span class="hljs-keyword">catch</span> (Exception e) {

        Assertions.assertTrue(e <span class="hljs-keyword">instanceof</span> RpcException);

        executeLimitFilter.onError(e, invoker, invocation);

    }

    Assertions.assertEquals(<span class="hljs-number">1</span>, RpcStatus.getStatus(url, invocation.getMethodName()).getFailed());

    RpcStatus.removeStatus(url, invocation.getMethodName());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvocation</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String methodNameReturn)</span> </span>{
        org.apache.dubbo.rpc.Invocation invocation = Mockito.mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invocation.getMethodName()).thenReturn(methodNameReturn);
        <span class="hljs-keyword">return</span> invocation;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest394">Test Case ID #dubbo_Test_39_4</h4>
<h4 id="test-case-name-testmorethanexecutelimitinvokefile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfilterexecutelimitfiltertestjava">Test Case Name: <code>testMoreThanExecuteLimitInvoke</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\ExecuteLimitFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    int maxExecute = 10;
    int totalExecute = 20;
    final AtomicInteger failed = new AtomicInteger(0);
<span class="hljs-deletion">-    final Invocation invocation = Mockito.mock(RpcInvocation.class);</span>
<span class="hljs-deletion">-    when(invocation.getMethodName()).thenReturn("testMoreThanExecuteLimitInvoke");</span>
<span class="hljs-addition">+    final Invocation invocation = MockInvocation.createMockInvocation("testMoreThanExecuteLimitInvoke");</span>
    URL url = URL.valueOf("test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1&amp;executes=" + maxExecute);
    final Invoker&lt;ExecuteLimitFilter&gt; invoker = new BlockMyInvoker&lt;&gt;(url, 1000);
    final CountDownLatch latchThatWaitsAllThreadStarted = new CountDownLatch(1);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testMoreThanExecuteLimitInvoke</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">int</span> maxExecute = <span class="hljs-number">10</span>;

    <span class="hljs-keyword">int</span> totalExecute = <span class="hljs-number">20</span>;

    <span class="hljs-keyword">final</span> AtomicInteger failed = <span class="hljs-keyword">new</span> AtomicInteger(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">final</span> Invocation invocation = Mockito.mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getMethodName()).thenReturn(<span class="hljs-string">"testMoreThanExecuteLimitInvoke"</span>);

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1&amp;executes="</span> + maxExecute);

    <span class="hljs-keyword">final</span> Invoker&lt;ExecuteLimitFilter&gt; invoker = <span class="hljs-keyword">new</span> BlockMyInvoker&lt;&gt;(url, <span class="hljs-number">1000</span>);

    <span class="hljs-keyword">final</span> CountDownLatch latchThatWaitsAllThreadStarted = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">final</span> CountDownLatch latchThatWaitsAllThreadFinished = <span class="hljs-keyword">new</span> CountDownLatch(totalExecute);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; totalExecute; i++) {

        Thread thread = <span class="hljs-keyword">new</span> Thread(() -&gt; {

            <span class="hljs-keyword">try</span> {

                latchThatWaitsAllThreadStarted.await();

                executeLimitFilter.invoke(invoker, invocation);

            } <span class="hljs-keyword">catch</span> (InterruptedException e) {

                e.printStackTrace();

            } <span class="hljs-keyword">catch</span> (RpcException expected) {

                failed.incrementAndGet();

            } <span class="hljs-keyword">finally</span> {

                latchThatWaitsAllThreadFinished.countDown();

            }

        });

        thread.start();

    }

    latchThatWaitsAllThreadStarted.countDown();

    <span class="hljs-keyword">try</span> {

        latchThatWaitsAllThreadFinished.await();

    } <span class="hljs-keyword">catch</span> (InterruptedException e) {

        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);

    }

    Assertions.assertEquals(totalExecute - maxExecute, failed.get());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvocation</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String methodNameReturn)</span> </span>{
        org.apache.dubbo.rpc.Invocation invocation = Mockito.mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invocation.getMethodName()).thenReturn(methodNameReturn);
        <span class="hljs-keyword">return</span> invocation;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest395">Test Case ID #dubbo_Test_39_5</h4>
<h4 id="test-case-name-testinvokewithouttimeoutfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltertimeoutfiltertestjava">Test Case Name: <code>testInvokeWithoutTimeout</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\TimeoutFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(invoker.getUrl()).thenReturn(URL.valueOf("test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1&amp;timeout=" + timeout));
<span class="hljs-deletion">-    Invocation invocation = Mockito.mock(Invocation.class);</span>
<span class="hljs-deletion">-    when(invocation.getMethodName()).thenReturn("testInvokeWithoutTimeout");</span>
<span class="hljs-addition">+    Invocation invocation = MockInvocation.createMockInvocation("testInvokeWithoutTimeout");</span>
    Result result = timeoutFilter.invoke(invoker, invocation);
    Assertions.assertEquals("result", result.getValue());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokeWithoutTimeout</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">int</span> timeout = <span class="hljs-number">3000</span>;

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">AppResponse</span>("<span class="hljs-title">result</span>"))</span>;

    when(invoker.getUrl()).thenReturn(URL.valueOf(<span class="hljs-string">"test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1&amp;timeout="</span> + timeout));

    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getMethodName()).thenReturn(<span class="hljs-string">"testInvokeWithoutTimeout"</span>);

    Result result = timeoutFilter.invoke(invoker, invocation);

    Assertions.assertEquals(<span class="hljs-string">"result"</span>, result.getValue());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvocation</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String methodNameReturn)</span> </span>{
        org.apache.dubbo.rpc.Invocation invocation = Mockito.mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invocation.getMethodName()).thenReturn(methodNameReturn);
        <span class="hljs-keyword">return</span> invocation;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest396">Test Case ID #dubbo_Test_39_6</h4>
<h4 id="test-case-name-testinvokewithtimeoutfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltertimeoutfiltertestjava">Test Case Name: <code>testInvokeWithTimeout</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\TimeoutFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    Invoker invoker = new BlockMyInvoker(url, (timeout + 100));
<span class="hljs-deletion">-    Invocation invocation = Mockito.mock(RpcInvocation.class);</span>
<span class="hljs-deletion">-    when(invocation.getMethodName()).thenReturn("testInvokeWithTimeout");</span>
<span class="hljs-addition">+    Invocation invocation = MockInvocation.createMockInvocation("testInvokeWithTimeout");</span>
    Result result = timeoutFilter.invoke(invoker, invocation);
    Assertions.assertEquals("Dubbo", result.getValue());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokeWithTimeout</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">int</span> timeout = <span class="hljs-number">100</span>;

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1&amp;timeout="</span> + timeout);

    Invoker invoker = <span class="hljs-keyword">new</span> BlockMyInvoker(url, (timeout + <span class="hljs-number">100</span>));

    Invocation invocation = Mockito.mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getMethodName()).thenReturn(<span class="hljs-string">"testInvokeWithTimeout"</span>);

    Result result = timeoutFilter.invoke(invoker, invocation);

    Assertions.assertEquals(<span class="hljs-string">"Dubbo"</span>, result.getValue());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvocation</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> org.apache.dubbo.rpc.<span class="hljs-function">Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String methodNameReturn)</span> </span>{
        org.apache.dubbo.rpc.Invocation invocation = Mockito.mock(org.apache.dubbo.rpc.Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invocation.getMethodName()).thenReturn(methodNameReturn);
        <span class="hljs-keyword">return</span> invocation;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci40">Mock Clone Instance #dubbo_MCI_40</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Invocation</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String requestSignature, String ak, String consumer, <span class="hljs-keyword">long</span> requestTimestamp)</span> </span>{
    Invocation invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invocation.getObjectAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(requestSignature);
    when(invocation.getObjectAttachment(Constants.AK_KEY)).thenReturn(ak);
    when(invocation.getObjectAttachment(CommonConstants.CONSUMER)).thenReturn(consumer);
    when(invocation.getObjectAttachment(Constants.REQUEST_TIMESTAMP_KEY)).thenReturn(requestTimestamp);
    <span class="hljs-keyword">return</span> invocation;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest401">Test Case ID #dubbo_Test_40_1</h4>
<h4 id="test-case-name-testauthfailedwhennoaccesskeypairfile-cjavaprojectsapachedubbodubbo-plugindubbo-authsrctestjavaorgapachedubboauthfilterproviderauthfiltertestjava">Test Case Name: <code>testAuthFailedWhenNoAccessKeyPair</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-auth\src\test\java\org\apache\dubbo\auth\filter\ProviderAuthFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Invoker invoker = mock(Invoker.class);
<span class="hljs-deletion">-    Invocation invocation = mock(RpcInvocation.class);</span>
<span class="hljs-deletion">-    when(invocation.getObjectAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn("dubbo");</span>
<span class="hljs-deletion">-    when(invocation.getObjectAttachment(Constants.AK_KEY)).thenReturn("ak");</span>
<span class="hljs-deletion">-    when(invocation.getObjectAttachment(CommonConstants.CONSUMER)).thenReturn("test-consumer");</span>
<span class="hljs-deletion">-    when(invocation.getObjectAttachment(Constants.REQUEST_TIMESTAMP_KEY)).thenReturn(System.currentTimeMillis());</span>
<span class="hljs-addition">+    Invocation invocation = createMockInvocation(</span>
<span class="hljs-addition">+        "dubbo",</span>
<span class="hljs-addition">+        "ak",</span>
<span class="hljs-addition">+        "test-consumer",</span>
<span class="hljs-addition">+        System.currentTimeMillis()</span>
<span class="hljs-addition">+    );</span>
    when(invoker.getUrl()).thenReturn(url);
    ProviderAuthFilter providerAuthFilter = new ProviderAuthFilter(ApplicationModel.defaultModel());
    Result result = providerAuthFilter.invoke(invoker, invocation);
    assertTrue(result.hasException());
    assertTrue(result.getException() instanceof RpcAuthenticationException);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAuthFailedWhenNoAccessKeyPair</span><span class="hljs-params">()</span> </span>{

    URL url = URL.valueOf(<span class="hljs-string">"dubbo://10.10.10.10:2181"</span>).addParameter(CommonConstants.APPLICATION_KEY, <span class="hljs-string">"test-provider"</span>).addParameter(Constants.SERVICE_AUTH, <span class="hljs-keyword">true</span>);

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invocation invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getObjectAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(<span class="hljs-string">"dubbo"</span>);

    when(invocation.getObjectAttachment(Constants.AK_KEY)).thenReturn(<span class="hljs-string">"ak"</span>);

    when(invocation.getObjectAttachment(CommonConstants.CONSUMER)).thenReturn(<span class="hljs-string">"test-consumer"</span>);

    when(invocation.getObjectAttachment(Constants.REQUEST_TIMESTAMP_KEY)).thenReturn(System.currentTimeMillis());

    when(invoker.getUrl()).thenReturn(url);

    ProviderAuthFilter providerAuthFilter = <span class="hljs-keyword">new</span> ProviderAuthFilter(ApplicationModel.defaultModel());

    Result result = providerAuthFilter.invoke(invoker, invocation);

    assertTrue(result.hasException());

    assertTrue(result.getException() <span class="hljs-keyword">instanceof</span> RpcAuthenticationException);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String requestSignature, String ak, String consumer, <span class="hljs-keyword">long</span> requestTimestamp)</span> </span>{
    Invocation invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invocation.getObjectAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(requestSignature);
    when(invocation.getObjectAttachment(Constants.AK_KEY)).thenReturn(ak);
    when(invocation.getObjectAttachment(CommonConstants.CONSUMER)).thenReturn(consumer);
    when(invocation.getObjectAttachment(Constants.REQUEST_TIMESTAMP_KEY)).thenReturn(requestTimestamp);
    <span class="hljs-keyword">return</span> invocation;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest402">Test Case ID #dubbo_Test_40_2</h4>
<h4 id="test-case-name-testauthfailedwhenparametererrorfile-cjavaprojectsapachedubbodubbo-plugindubbo-authsrctestjavaorgapachedubboauthfilterproviderauthfiltertestjava">Test Case Name: <code>testAuthFailedWhenParameterError</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-auth\src\test\java\org\apache\dubbo\auth\filter\ProviderAuthFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Invoker invoker = mock(Invoker.class);
<span class="hljs-deletion">-    Invocation invocation = mock(RpcInvocation.class);</span>
<span class="hljs-deletion">-    when(invocation.getObjectAttachment(Constants.AK_KEY)).thenReturn("ak");</span>
<span class="hljs-deletion">-    when(invocation.getObjectAttachment(CommonConstants.CONSUMER)).thenReturn("test-consumer");</span>
<span class="hljs-deletion">-    when(invocation.getObjectAttachment(Constants.REQUEST_TIMESTAMP_KEY)).thenReturn(currentTimeMillis);</span>
<span class="hljs-addition">+    Invocation invocation = createMockInvocation(sign, "ak", "test-consumer", currentTimeMillis);</span>
    when(invocation.getMethodName()).thenReturn(method);
    Object[] fakeParams = new Object[] { "dubbo1", "dubbo3" };
    when(invocation.getArguments()).thenReturn(fakeParams);
    when(invoker.getUrl()).thenReturn(url);
    String requestString = String.format(Constants.SIGNATURE_STRING_FORMAT, url.getColonSeparatedKey(), invocation.getMethodName(), "sk", currentTimeMillis);
    String sign = SignatureUtils.sign(originalParams, requestString, "sk");
<span class="hljs-deletion">-    when(invocation.getObjectAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(sign);</span>
    ProviderAuthFilter providerAuthFilter = new ProviderAuthFilter(ApplicationModel.defaultModel());
    Result result = providerAuthFilter.invoke(invoker, invocation);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAuthFailedWhenParameterError</span><span class="hljs-params">()</span> </span>{

    String service = <span class="hljs-string">"org.apache.dubbo.DemoService"</span>;

    String method = <span class="hljs-string">"test"</span>;

    Object[] originalParams = <span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"dubbo1"</span>, <span class="hljs-string">"dubbo2"</span> };

    <span class="hljs-keyword">long</span> currentTimeMillis = System.currentTimeMillis();

    URL url = URL.valueOf(<span class="hljs-string">"dubbo://10.10.10.10:2181"</span>).setServiceInterface(service).addParameter(Constants.ACCESS_KEY_ID_KEY, <span class="hljs-string">"ak"</span>).addParameter(Constants.SECRET_ACCESS_KEY_KEY, <span class="hljs-string">"sk"</span>).addParameter(CommonConstants.APPLICATION_KEY, <span class="hljs-string">"test-provider"</span>).addParameter(Constants.PARAMETER_SIGNATURE_ENABLE_KEY, <span class="hljs-keyword">true</span>).addParameter(Constants.SERVICE_AUTH, <span class="hljs-keyword">true</span>);

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invocation invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getObjectAttachment(Constants.AK_KEY)).thenReturn(<span class="hljs-string">"ak"</span>);

    when(invocation.getObjectAttachment(CommonConstants.CONSUMER)).thenReturn(<span class="hljs-string">"test-consumer"</span>);

    when(invocation.getObjectAttachment(Constants.REQUEST_TIMESTAMP_KEY)).thenReturn(currentTimeMillis);

    when(invocation.getMethodName()).thenReturn(method);

    Object[] fakeParams = <span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"dubbo1"</span>, <span class="hljs-string">"dubbo3"</span> };

    when(invocation.getArguments()).thenReturn(fakeParams);

    when(invoker.getUrl()).thenReturn(url);

    String requestString = String.format(Constants.SIGNATURE_STRING_FORMAT, url.getColonSeparatedKey(), invocation.getMethodName(), <span class="hljs-string">"sk"</span>, currentTimeMillis);

    String sign = SignatureUtils.sign(originalParams, requestString, <span class="hljs-string">"sk"</span>);

    when(invocation.getObjectAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(sign);

    ProviderAuthFilter providerAuthFilter = <span class="hljs-keyword">new</span> ProviderAuthFilter(ApplicationModel.defaultModel());

    Result result = providerAuthFilter.invoke(invoker, invocation);

    assertTrue(result.hasException());

    assertTrue(result.getException() <span class="hljs-keyword">instanceof</span> RpcAuthenticationException);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">(String requestSignature, String ak, String consumer, <span class="hljs-keyword">long</span> requestTimestamp)</span> </span>{
    Invocation invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invocation.getObjectAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(requestSignature);
    when(invocation.getObjectAttachment(Constants.AK_KEY)).thenReturn(ak);
    when(invocation.getObjectAttachment(CommonConstants.CONSUMER)).thenReturn(consumer);
    when(invocation.getObjectAttachment(Constants.REQUEST_TIMESTAMP_KEY)).thenReturn(requestTimestamp);
    <span class="hljs-keyword">return</span> invocation;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci41">Mock Clone Instance #dubbo_MCI_41</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Invocation</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">()</span> </span>{
    Invocation invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invocation.getAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(<span class="hljs-keyword">null</span>);
    <span class="hljs-keyword">return</span> invocation;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest411">Test Case ID #dubbo_Test_41_1</h4>
<h4 id="test-case-name-testauthfailedfile-cjavaprojectsapachedubbodubbo-plugindubbo-authsrctestjavaorgapachedubboauthfilterproviderauthfiltertestjava">Test Case Name: <code>testAuthFailed</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-auth\src\test\java\org\apache\dubbo\auth\filter\ProviderAuthFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    Invoker invoker = mock(Invoker.class);
<span class="hljs-deletion">-    Invocation invocation = mock(RpcInvocation.class);</span>
<span class="hljs-deletion">-    when(invocation.getAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(null);</span>
<span class="hljs-addition">+    Invocation invocation = createMockInvocation();</span>
    when(invoker.getUrl()).thenReturn(url);
    ProviderAuthFilter providerAuthFilter = new ProviderAuthFilter(ApplicationModel.defaultModel());
    Result result = providerAuthFilter.invoke(invoker, invocation);
    assertTrue(result.hasException());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAuthFailed</span><span class="hljs-params">()</span> </span>{

    URL url = URL.valueOf(<span class="hljs-string">"dubbo://10.10.10.10:2181"</span>).addParameter(Constants.ACCESS_KEY_ID_KEY, <span class="hljs-string">"ak"</span>).addParameter(Constants.SECRET_ACCESS_KEY_KEY, <span class="hljs-string">"sk"</span>).addParameter(CommonConstants.APPLICATION_KEY, <span class="hljs-string">"test"</span>).addParameter(Constants.SERVICE_AUTH, <span class="hljs-keyword">true</span>);

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invocation invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(<span class="hljs-keyword">null</span>);

    when(invoker.getUrl()).thenReturn(url);

    ProviderAuthFilter providerAuthFilter = <span class="hljs-keyword">new</span> ProviderAuthFilter(ApplicationModel.defaultModel());

    Result result = providerAuthFilter.invoke(invoker, invocation);

    assertTrue(result.hasException());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">()</span> </span>{
    Invocation invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invocation.getAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(<span class="hljs-keyword">null</span>);
    <span class="hljs-keyword">return</span> invocation;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest412">Test Case ID #dubbo_Test_41_2</h4>
<h4 id="test-case-name-testauthfailedwhennosignaturefile-cjavaprojectsapachedubbodubbo-plugindubbo-authsrctestjavaorgapachedubboauthfilterproviderauthfiltertestjava">Test Case Name: <code>testAuthFailedWhenNoSignature</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-auth\src\test\java\org\apache\dubbo\auth\filter\ProviderAuthFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invocation">Mock Object Variable Name: <code>invocation</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    Invoker invoker = mock(Invoker.class);
<span class="hljs-deletion">-    Invocation invocation = mock(RpcInvocation.class);</span>
<span class="hljs-deletion">-    when(invocation.getAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(null);</span>
<span class="hljs-addition">+    Invocation invocation = createMockInvocation();</span>
    when(invoker.getUrl()).thenReturn(url);
    ProviderAuthFilter providerAuthFilter = new ProviderAuthFilter(ApplicationModel.defaultModel());
    Result result = providerAuthFilter.invoke(invoker, invocation);
    assertTrue(result.hasException());
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAuthFailedWhenNoSignature</span><span class="hljs-params">()</span> </span>{

    URL url = URL.valueOf(<span class="hljs-string">"dubbo://10.10.10.10:2181"</span>).addParameter(Constants.ACCESS_KEY_ID_KEY, <span class="hljs-string">"ak"</span>).addParameter(Constants.SECRET_ACCESS_KEY_KEY, <span class="hljs-string">"sk"</span>).addParameter(CommonConstants.APPLICATION_KEY, <span class="hljs-string">"test"</span>).addParameter(Constants.SERVICE_AUTH, <span class="hljs-keyword">true</span>);

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invocation invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(<span class="hljs-keyword">null</span>);

    when(invoker.getUrl()).thenReturn(url);

    ProviderAuthFilter providerAuthFilter = <span class="hljs-keyword">new</span> ProviderAuthFilter(ApplicationModel.defaultModel());

    Result result = providerAuthFilter.invoke(invoker, invocation);

    assertTrue(result.hasException());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invocation <span class="hljs-title">createMockInvocation</span><span class="hljs-params">()</span> </span>{
    Invocation invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invocation.getAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(<span class="hljs-keyword">null</span>);
    <span class="hljs-keyword">return</span> invocation;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci42">Mock Clone Instance #dubbo_MCI_42</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Invoker</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getUrl()).willReturn(url);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest421">Test Case ID #dubbo_Test_42_1</h4>
<h4 id="test-case-name-testavailablefile-cjavaprojectsapachedubbodubbo-monitordubbo-monitor-defaultsrctestjavaorgapachedubbomonitordubbodubbomonitortestjava">Test Case Name: <code>testAvailable</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-monitor\dubbo-monitor-default\src\test\java\org\apache\dubbo\monitor\dubbo\DubboMonitorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testAvailable() {
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
<span class="hljs-addition">+    Invoker invoker = createMockInvoker(URL.valueOf("dubbo://127.0.0.1:7070?interval=20"));</span>
    MonitorService monitorService = mock(MonitorService.class);
<span class="hljs-addition">+    given(invoker.isAvailable()).willReturn(true);</span>
    DubboMonitor dubboMonitor = new DubboMonitor(invoker, monitorService);
    assertThat(dubboMonitor.isAvailable(), is(true));
    verify(invoker).isAvailable();
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAvailable</span><span class="hljs-params">()</span> </span>{

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MonitorService monitorService = mock(MonitorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"dubbo://127.0.0.1:7070?interval=20"</span>));

    DubboMonitor dubboMonitor = <span class="hljs-keyword">new</span> DubboMonitor(invoker, monitorService);

    assertThat(dubboMonitor.isAvailable(), is(<span class="hljs-keyword">true</span>));

    verify(invoker).isAvailable();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getUrl()).willReturn(url);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest422">Test Case ID #dubbo_Test_42_2</h4>
<h4 id="test-case-name-testsumfile-cjavaprojectsapachedubbodubbo-monitordubbo-monitor-defaultsrctestjavaorgapachedubbomonitordubbodubbomonitortestjava">Test Case Name: <code>testSum</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-monitor\dubbo-monitor-default\src\test\java\org\apache\dubbo\monitor\dubbo\DubboMonitorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    URL statistics = new URLBuilder(DUBBO_PROTOCOL, "10.20.153.11", 0).addParameter(APPLICATION_KEY, "morgan").addParameter(INTERFACE_KEY, "MemberService").addParameter(METHOD_KEY, "findPerson").addParameter(CONSUMER, "10.20.153.11").addParameter(SUCCESS_KEY, 1).addParameter(FAILURE_KEY, 0).addParameter(ELAPSED_KEY, 3).addParameter(MAX_ELAPSED_KEY, 3).addParameter(CONCURRENT_KEY, 1).addParameter(MAX_CONCURRENT_KEY, 1).build();
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
<span class="hljs-addition">+    Invoker invoker = createMockInvoker(URL.valueOf("dubbo://127.0.0.1:7070?interval=20"));</span>
    MonitorService monitorService = mock(MonitorService.class);
<span class="hljs-deletion">-    given(invoker.getUrl()).willReturn(URL.valueOf("dubbo://127.0.0.1:7070?interval=20"));</span>
    DubboMonitor dubboMonitor = new DubboMonitor(invoker, monitorService);
    dubboMonitor.collect(statistics.toSerializableURL());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testSum</span><span class="hljs-params">()</span> </span>{

    URL statistics = <span class="hljs-keyword">new</span> URLBuilder(DUBBO_PROTOCOL, <span class="hljs-string">"10.20.153.11"</span>, <span class="hljs-number">0</span>).addParameter(APPLICATION_KEY, <span class="hljs-string">"morgan"</span>).addParameter(INTERFACE_KEY, <span class="hljs-string">"MemberService"</span>).addParameter(METHOD_KEY, <span class="hljs-string">"findPerson"</span>).addParameter(CONSUMER, <span class="hljs-string">"10.20.153.11"</span>).addParameter(SUCCESS_KEY, <span class="hljs-number">1</span>).addParameter(FAILURE_KEY, <span class="hljs-number">0</span>).addParameter(ELAPSED_KEY, <span class="hljs-number">3</span>).addParameter(MAX_ELAPSED_KEY, <span class="hljs-number">3</span>).addParameter(CONCURRENT_KEY, <span class="hljs-number">1</span>).addParameter(MAX_CONCURRENT_KEY, <span class="hljs-number">1</span>).build();

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MonitorService monitorService = mock(MonitorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"dubbo://127.0.0.1:7070?interval=20"</span>));

    DubboMonitor dubboMonitor = <span class="hljs-keyword">new</span> DubboMonitor(invoker, monitorService);

    dubboMonitor.collect(statistics.toSerializableURL());

    dubboMonitor.collect(statistics.addParameter(SUCCESS_KEY, <span class="hljs-number">3</span>).addParameter(CONCURRENT_KEY, <span class="hljs-number">2</span>).addParameter(INPUT_KEY, <span class="hljs-number">1</span>).addParameter(OUTPUT_KEY, <span class="hljs-number">2</span>).toSerializableURL());

    dubboMonitor.collect(statistics.addParameter(SUCCESS_KEY, <span class="hljs-number">6</span>).addParameter(ELAPSED_KEY, <span class="hljs-number">2</span>).toSerializableURL());

    dubboMonitor.send();

    ArgumentCaptor&lt;URL&gt; summaryCaptor = ArgumentCaptor.forClass(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(monitorService, atLeastOnce()).collect(summaryCaptor.capture());

    List&lt;URL&gt; allValues = summaryCaptor.getAllValues();

    assertThat(allValues, not(nullValue()));

    assertThat(allValues, hasItem(<span class="hljs-keyword">new</span> CustomMatcher&lt;URL&gt;(<span class="hljs-string">"Monitor count should greater than 1"</span>) {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">matches</span><span class="hljs-params">(Object item)</span> </span>{

            URL url = (URL) item;

            <span class="hljs-keyword">return</span> Integer.valueOf(url.getParameter(SUCCESS_KEY)) &gt; <span class="hljs-number">1</span>;

        }

    }));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getUrl()).willReturn(url);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest423">Test Case ID #dubbo_Test_42_3</h4>
<h4 id="test-case-name-testlookupfile-cjavaprojectsapachedubbodubbo-monitordubbo-monitor-defaultsrctestjavaorgapachedubbomonitordubbodubbomonitortestjava">Test Case Name: <code>testLookUp</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-monitor\dubbo-monitor-default\src\test\java\org\apache\dubbo\monitor\dubbo\DubboMonitorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 void testLookUp() {
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
     MonitorService monitorService = mock(MonitorService.class);
     URL queryUrl = URL.valueOf("dubbo://127.0.0.1:7070?interval=20");
<span class="hljs-deletion">-    given(invoker.getUrl()).willReturn(queryUrl);</span>
<span class="hljs-addition">+    Invoker invoker = createMockInvoker(queryUrl);</span>
     DubboMonitor dubboMonitor = new DubboMonitor(invoker, monitorService);
     dubboMonitor.lookup(queryUrl);
     verify(monitorService).lookup(queryUrl);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testLookUp</span><span class="hljs-params">()</span> </span>{

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MonitorService monitorService = mock(MonitorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL queryUrl = URL.valueOf(<span class="hljs-string">"dubbo://127.0.0.1:7070?interval=20"</span>);

    given(invoker.getUrl()).willReturn(queryUrl);

    DubboMonitor dubboMonitor = <span class="hljs-keyword">new</span> DubboMonitor(invoker, monitorService);

    dubboMonitor.lookup(queryUrl);

    verify(monitorService).lookup(queryUrl);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getUrl()).willReturn(url);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci43">Mock Clone Instance #dubbo_MCI_43</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Invoker</code></li>
<li><strong>Test Case Count</strong>: 7</li>
<li><strong>MO Count</strong>: 29</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest431">Test Case ID #dubbo_Test_43_1</h4>
<h4 id="test-case-name-testbasicfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testBasic</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker1">Mock Object Variable Name: <code>invoker1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- a/TestClass.java</span>
<span class="hljs-comment">+++ b/TestClass.java</span>
@@
 void testBasic() throws InterruptedException {
     Invocation invocation = new RpcInvocation();
     LoadBalance loadBalance = new RandomLoadBalance();
     Assertions.assertEquals(5, directory.list(invocation).size());
     Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));
<span class="hljs-deletion">-    when(invoker1.isAvailable()).thenReturn(false);</span>
<span class="hljs-addition">+    invoker1 = MockInvoker.createMockInvoker(false);</span>
     when(invoker2.isAvailable()).thenReturn(false);
     when(invoker3.isAvailable()).thenReturn(false);
     when(invoker4.isAvailable()).thenReturn(false);
     when(invoker5.isAvailable()).thenReturn(false);
     clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());
     Assertions.assertEquals(0, directory.list(invocation).size());
<span class="hljs-deletion">-    when(invoker1.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    invoker1 = MockInvoker.createMockInvoker(true);</span>
     Set&lt;Invoker&gt; invokerSet = new HashSet&lt;&gt;();
     invokerSet.add(invoker1);
     waitRefresh(invokerSet);
     Assertions.assertEquals(1, directory.list(invocation).size());
     Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testBasic</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    Assertions.assertEquals(<span class="hljs-number">5</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">1</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    invokerSet.add(invoker2);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">2</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    invokerList.remove(invoker5);

    directory.notify(invokerList);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">2</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">4</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest432">Test Case ID #dubbo_Test_43_2</h4>
<h4 id="test-case-name-testretryfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testRetry</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker1">Mock Object Variable Name: <code>invoker1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- Original.java</span>
<span class="hljs-comment">+++ Refactored.java</span>
@@
     Assertions.assertEquals(2, directory.list(invocation).size());
<span class="hljs-deletion">-    when(invoker1.isAvailable()).thenReturn(false);</span>
<span class="hljs-addition">+    invoker1 = MockInvoker.createMockInvoker(false);</span>
     Assertions.assertEquals(invoker2, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.singletonList(invoker2)));
     Assertions.assertEquals(1, directory.list(invocation).size());
<span class="hljs-deletion">-    when(invoker1.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    invoker1 = MockInvoker.createMockInvoker(true);</span>
     Set&lt;Invoker&gt; invokerSet = new HashSet&lt;&gt;();
     invokerSet.add(invoker1);
     waitRefresh(invokerSet);
     Assertions.assertEquals(2, directory.list(invocation).size());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRetry</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    invokerList.clear();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    directory.notify(invokerList);

    Assertions.assertEquals(<span class="hljs-number">2</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    Assertions.assertEquals(invoker2, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.singletonList(invoker2)));

    Assertions.assertEquals(<span class="hljs-number">1</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">2</span>, directory.list(invocation).size());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest433">Test Case ID #dubbo_Test_43_3</h4>
<h4 id="test-case-name-testrandomselectfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testRandomSelect</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker1">Mock Object Variable Name: <code>invoker1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
<span class="hljs-addition">+ // Cannot refactor this mock: The reusable helper does not cover all configuration (configInvoker(invoker1)) applied in @BeforeEach; using it would skip important setup and break test behavior.</span>
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRandomSelect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    invokerList.add(invoker6);

    invokerList.add(invoker7);

    invokerList.add(invoker8);

    invokerList.add(invoker9);

    invokerList.add(invoker10);

    invokerList.add(invoker11);

    invokerList.add(invoker12);

    invokerList.add(invoker13);

    invokerList.add(invoker14);

    invokerList.add(invoker15);

    directory.notify(invokerList);

    Assertions.assertEquals(<span class="hljs-number">15</span>, directory.list(invocation).size());

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++) {

        clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {

        Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    }

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    invokerSet.add(invoker2);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    invokerSet.add(invoker5);

    invokerSet.add(invoker6);

    invokerSet.add(invoker7);

    invokerSet.add(invoker8);

    invokerSet.add(invoker9);

    invokerSet.add(invoker10);

    invokerSet.add(invoker11);

    invokerSet.add(invoker12);

    invokerSet.add(invoker13);

    invokerSet.add(invoker14);

    invokerSet.add(invoker15);

    waitRefresh(invokerSet);

    Assertions.assertTrue(directory.list(invocation).size() &gt; <span class="hljs-number">1</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest434">Test Case ID #dubbo_Test_43_4</h4>
<h4 id="test-case-name-testbasicfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testBasic</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker2">Mock Object Variable Name: <code>invoker2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
<span class="hljs-addition">+ // Cannot refactor this mock: The helper method only stubs isAvailable(), but in @BeforeEach, configInvoker(invoker2) is called, which may apply additional stubbing or configuration. Replacing the mock creation and stubbing with the helper would skip configInvoker(invoker2), potentially breaking test setup or other tests. Thus, refactoring with the provided helper is unsafe.</span>
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testBasic</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    Assertions.assertEquals(<span class="hljs-number">5</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">1</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    invokerSet.add(invoker2);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">2</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    invokerList.remove(invoker5);

    directory.notify(invokerList);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">2</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">4</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest435">Test Case ID #dubbo_Test_43_5</h4>
<h4 id="test-case-name-testrandomselectfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testRandomSelect</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker2">Mock Object Variable Name: <code>invoker2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
<span class="hljs-addition">+ // Cannot refactor this mock: The reusable helper cannot express the sequence of stubbing invoker2.isAvailable() to false and then to true in the same test method.</span>
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRandomSelect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    invokerList.add(invoker6);

    invokerList.add(invoker7);

    invokerList.add(invoker8);

    invokerList.add(invoker9);

    invokerList.add(invoker10);

    invokerList.add(invoker11);

    invokerList.add(invoker12);

    invokerList.add(invoker13);

    invokerList.add(invoker14);

    invokerList.add(invoker15);

    directory.notify(invokerList);

    Assertions.assertEquals(<span class="hljs-number">15</span>, directory.list(invocation).size());

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++) {

        clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {

        Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    }

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    invokerSet.add(invoker2);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    invokerSet.add(invoker5);

    invokerSet.add(invoker6);

    invokerSet.add(invoker7);

    invokerSet.add(invoker8);

    invokerSet.add(invoker9);

    invokerSet.add(invoker10);

    invokerSet.add(invoker11);

    invokerSet.add(invoker12);

    invokerSet.add(invoker13);

    invokerSet.add(invoker14);

    invokerSet.add(invoker15);

    waitRefresh(invokerSet);

    Assertions.assertTrue(directory.list(invocation).size() &gt; <span class="hljs-number">1</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest436">Test Case ID #dubbo_Test_43_6</h4>
<h4 id="test-case-name-testbasicfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testBasic</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker3">Mock Object Variable Name: <code>invoker3</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     when(invoker2.isAvailable()).thenReturn(false);
<span class="hljs-deletion">-    when(invoker3.isAvailable()).thenReturn(false);</span>
<span class="hljs-addition">+    invoker3 = MockInvoker.createMockInvoker(false);</span>
     when(invoker4.isAvailable()).thenReturn(false);
     when(invoker5.isAvailable()).thenReturn(false);
     clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());
     Assertions.assertEquals(0, directory.list(invocation).size());
     when(invoker1.isAvailable()).thenReturn(true);
     Set&lt;Invoker&gt; invokerSet = new HashSet&lt;&gt;();
     invokerSet.add(invoker1);
     waitRefresh(invokerSet);
     Assertions.assertEquals(1, directory.list(invocation).size());
     Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));
     when(invoker2.isAvailable()).thenReturn(true);
     invokerSet.add(invoker2);
     waitRefresh(invokerSet);
     Assertions.assertEquals(2, directory.list(invocation).size());
     Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));
     invokerList.remove(invoker5);
     directory.notify(invokerList);
     when(invoker2.isAvailable()).thenReturn(true);
     waitRefresh(invokerSet);
     Assertions.assertEquals(2, directory.list(invocation).size());
     Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));
<span class="hljs-deletion">-    when(invoker3.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    invoker3 = MockInvoker.createMockInvoker(true);</span>
     when(invoker4.isAvailable()).thenReturn(true);
     invokerSet.add(invoker3);
     invokerSet.add(invoker4);
     waitRefresh(invokerSet);
     Assertions.assertEquals(4, directory.list(invocation).size());
     Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testBasic</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    Assertions.assertEquals(<span class="hljs-number">5</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">1</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    invokerSet.add(invoker2);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">2</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    invokerList.remove(invoker5);

    directory.notify(invokerList);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">2</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">4</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest437">Test Case ID #dubbo_Test_43_7</h4>
<h4 id="test-case-name-testrandomselectfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testRandomSelect</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker3">Mock Object Variable Name: <code>invoker3</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     when(invoker2.isAvailable()).thenReturn(false);
<span class="hljs-deletion">-    when(invoker3.isAvailable()).thenReturn(false);</span>
<span class="hljs-addition">+    invoker3 = MockInvoker.createMockInvoker(false);</span>
     when(invoker4.isAvailable()).thenReturn(false);
     when(invoker5.isAvailable()).thenReturn(false);
@@
     when(invoker1.isAvailable()).thenReturn(true);
     when(invoker2.isAvailable()).thenReturn(true);
<span class="hljs-deletion">-    when(invoker3.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    invoker3 = MockInvoker.createMockInvoker(true);</span>
     when(invoker4.isAvailable()).thenReturn(true);
     when(invoker5.isAvailable()).thenReturn(true);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRandomSelect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    invokerList.add(invoker6);

    invokerList.add(invoker7);

    invokerList.add(invoker8);

    invokerList.add(invoker9);

    invokerList.add(invoker10);

    invokerList.add(invoker11);

    invokerList.add(invoker12);

    invokerList.add(invoker13);

    invokerList.add(invoker14);

    invokerList.add(invoker15);

    directory.notify(invokerList);

    Assertions.assertEquals(<span class="hljs-number">15</span>, directory.list(invocation).size());

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++) {

        clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {

        Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    }

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    invokerSet.add(invoker2);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    invokerSet.add(invoker5);

    invokerSet.add(invoker6);

    invokerSet.add(invoker7);

    invokerSet.add(invoker8);

    invokerSet.add(invoker9);

    invokerSet.add(invoker10);

    invokerSet.add(invoker11);

    invokerSet.add(invoker12);

    invokerSet.add(invoker13);

    invokerSet.add(invoker14);

    invokerSet.add(invoker15);

    waitRefresh(invokerSet);

    Assertions.assertTrue(directory.list(invocation).size() &gt; <span class="hljs-number">1</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest438">Test Case ID #dubbo_Test_43_8</h4>
<h4 id="test-case-name-testbasicfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testBasic</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker4">Mock Object Variable Name: <code>invoker4</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- Original</span>
<span class="hljs-comment">+++ Refactored</span>
@@
     when(invoker3.isAvailable()).thenReturn(true);
<span class="hljs-deletion">-    when(invoker4.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    invoker4 = MockInvoker.createMockInvoker(true);</span>
     invokerSet.add(invoker3);
     invokerSet.add(invoker4);
     waitRefresh(invokerSet);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testBasic</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    Assertions.assertEquals(<span class="hljs-number">5</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">1</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    invokerSet.add(invoker2);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">2</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    invokerList.remove(invoker5);

    directory.notify(invokerList);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">2</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">4</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest439">Test Case ID #dubbo_Test_43_9</h4>
<h4 id="test-case-name-testrandomselectfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testRandomSelect</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker4">Mock Object Variable Name: <code>invoker4</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- a/TestClass.java</span>
<span class="hljs-comment">+++ b/TestClass.java</span>
@@
     when(invoker2.isAvailable()).thenReturn(false);
     when(invoker3.isAvailable()).thenReturn(false);
<span class="hljs-deletion">-    when(invoker4.isAvailable()).thenReturn(false);</span>
<span class="hljs-addition">+    invoker4 = MockInvoker.createMockInvoker(false);</span>
     when(invoker5.isAvailable()).thenReturn(false);
     when(invoker6.isAvailable()).thenReturn(false);
     when(invoker7.isAvailable()).thenReturn(false);
     when(invoker8.isAvailable()).thenReturn(false);
     when(invoker9.isAvailable()).thenReturn(false);
     when(invoker10.isAvailable()).thenReturn(false);
     when(invoker11.isAvailable()).thenReturn(false);
     when(invoker12.isAvailable()).thenReturn(false);
     when(invoker13.isAvailable()).thenReturn(false);
     when(invoker14.isAvailable()).thenReturn(false);
     when(invoker15.isAvailable()).thenReturn(false);
     for (int i = 0; i &lt; 15; i++) {
         clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());
     }
     for (int i = 0; i &lt; 5; i++) {
         Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));
     }
     when(invoker1.isAvailable()).thenReturn(false);
     clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());
     Assertions.assertEquals(0, directory.list(invocation).size());
<span class="hljs-deletion">-    when(invoker1.isAvailable()).thenReturn(true);</span>
<span class="hljs-deletion">-    when(invoker2.isAvailable()).thenReturn(true);</span>
<span class="hljs-deletion">-    when(invoker3.isAvailable()).thenReturn(true);</span>
<span class="hljs-deletion">-    when(invoker4.isAvailable()).thenReturn(true);</span>
<span class="hljs-deletion">-    when(invoker5.isAvailable()).thenReturn(true);</span>
<span class="hljs-deletion">-    when(invoker6.isAvailable()).thenReturn(true);</span>
<span class="hljs-deletion">-    when(invoker7.isAvailable()).thenReturn(true);</span>
<span class="hljs-deletion">-    when(invoker8.isAvailable()).thenReturn(true);</span>
<span class="hljs-deletion">-    when(invoker9.isAvailable()).thenReturn(true);</span>
<span class="hljs-deletion">-    when(invoker10.isAvailable()).thenReturn(true);</span>
<span class="hljs-deletion">-    when(invoker11.isAvailable()).thenReturn(true);</span>
<span class="hljs-deletion">-    when(invoker12.isAvailable()).thenReturn(true);</span>
<span class="hljs-deletion">-    when(invoker13.isAvailable()).thenReturn(true);</span>
<span class="hljs-deletion">-    when(invoker14.isAvailable()).thenReturn(true);</span>
<span class="hljs-deletion">-    when(invoker15.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    when(invoker1.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    when(invoker2.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    when(invoker3.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    invoker4 = MockInvoker.createMockInvoker(true);</span>
<span class="hljs-addition">+    when(invoker5.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    when(invoker6.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    when(invoker7.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    when(invoker8.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    when(invoker9.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    when(invoker10.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    when(invoker11.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    when(invoker12.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    when(invoker13.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    when(invoker14.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    when(invoker15.isAvailable()).thenReturn(true);</span>
     Set&lt;Invoker&gt; invokerSet = new HashSet&lt;&gt;();
     invokerSet.add(invoker1);
     invokerSet.add(invoker2);
     invokerSet.add(invoker3);
     invokerSet.add(invoker4);
     invokerSet.add(invoker5);
     invokerSet.add(invoker6);
     invokerSet.add(invoker7);
     invokerSet.add(invoker8);
     invokerSet.add(invoker9);
     invokerSet.add(invoker10);
     invokerSet.add(invoker11);
     invokerSet.add(invoker12);
     invokerSet.add(invoker13);
     invokerSet.add(invoker14);
     invokerSet.add(invoker15);
     waitRefresh(invokerSet);
     Assertions.assertTrue(directory.list(invocation).size() &gt; 1);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRandomSelect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    invokerList.add(invoker6);

    invokerList.add(invoker7);

    invokerList.add(invoker8);

    invokerList.add(invoker9);

    invokerList.add(invoker10);

    invokerList.add(invoker11);

    invokerList.add(invoker12);

    invokerList.add(invoker13);

    invokerList.add(invoker14);

    invokerList.add(invoker15);

    directory.notify(invokerList);

    Assertions.assertEquals(<span class="hljs-number">15</span>, directory.list(invocation).size());

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++) {

        clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {

        Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    }

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    invokerSet.add(invoker2);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    invokerSet.add(invoker5);

    invokerSet.add(invoker6);

    invokerSet.add(invoker7);

    invokerSet.add(invoker8);

    invokerSet.add(invoker9);

    invokerSet.add(invoker10);

    invokerSet.add(invoker11);

    invokerSet.add(invoker12);

    invokerSet.add(invoker13);

    invokerSet.add(invoker14);

    invokerSet.add(invoker15);

    waitRefresh(invokerSet);

    Assertions.assertTrue(directory.list(invocation).size() &gt; <span class="hljs-number">1</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4310">Test Case ID #dubbo_Test_43_10</h4>
<h4 id="test-case-name-testbasicfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testBasic</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker5">Mock Object Variable Name: <code>invoker5</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-addition">+ // Cannot refactor this mock: The reusable helper creates a new mock instance, but the test relies on the original mock instance being present in invokerList and directory. Replacing it would break references and test logic.</span>
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testBasic</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    Assertions.assertEquals(<span class="hljs-number">5</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">1</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    invokerSet.add(invoker2);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">2</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    invokerList.remove(invoker5);

    directory.notify(invokerList);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">2</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    waitRefresh(invokerSet);

    Assertions.assertEquals(<span class="hljs-number">4</span>, directory.list(invocation).size());

    Assertions.assertNotNull(clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4311">Test Case ID #dubbo_Test_43_11</h4>
<h4 id="test-case-name-testrandomselectfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testRandomSelect</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker5">Mock Object Variable Name: <code>invoker5</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     when(invoker3.isAvailable()).thenReturn(false);
     when(invoker4.isAvailable()).thenReturn(false);
<span class="hljs-deletion">-    when(invoker5.isAvailable()).thenReturn(false);</span>
<span class="hljs-addition">+    invoker5 = MockInvoker.createMockInvoker(false);</span>
     when(invoker6.isAvailable()).thenReturn(false);
     when(invoker7.isAvailable()).thenReturn(false);
@@
     when(invoker3.isAvailable()).thenReturn(true);
     when(invoker4.isAvailable()).thenReturn(true);
<span class="hljs-deletion">-    when(invoker5.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    invoker5 = MockInvoker.createMockInvoker(true);</span>
     when(invoker6.isAvailable()).thenReturn(true);
     when(invoker7.isAvailable()).thenReturn(true);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRandomSelect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    invokerList.add(invoker6);

    invokerList.add(invoker7);

    invokerList.add(invoker8);

    invokerList.add(invoker9);

    invokerList.add(invoker10);

    invokerList.add(invoker11);

    invokerList.add(invoker12);

    invokerList.add(invoker13);

    invokerList.add(invoker14);

    invokerList.add(invoker15);

    directory.notify(invokerList);

    Assertions.assertEquals(<span class="hljs-number">15</span>, directory.list(invocation).size());

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++) {

        clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {

        Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    }

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    invokerSet.add(invoker2);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    invokerSet.add(invoker5);

    invokerSet.add(invoker6);

    invokerSet.add(invoker7);

    invokerSet.add(invoker8);

    invokerSet.add(invoker9);

    invokerSet.add(invoker10);

    invokerSet.add(invoker11);

    invokerSet.add(invoker12);

    invokerSet.add(invoker13);

    invokerSet.add(invoker14);

    invokerSet.add(invoker15);

    waitRefresh(invokerSet);

    Assertions.assertTrue(directory.list(invocation).size() &gt; <span class="hljs-number">1</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4312">Test Case ID #dubbo_Test_43_12</h4>
<h4 id="test-case-name-testrandomselectfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testRandomSelect</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker6">Mock Object Variable Name: <code>invoker6</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     when(invoker5.isAvailable()).thenReturn(false);
<span class="hljs-deletion">-    when(invoker6.isAvailable()).thenReturn(false);</span>
<span class="hljs-addition">+    invoker6 = MockInvoker.createMockInvoker(false);</span>
     when(invoker7.isAvailable()).thenReturn(false);
     when(invoker8.isAvailable()).thenReturn(false);
@@
     when(invoker5.isAvailable()).thenReturn(true);
<span class="hljs-deletion">-    when(invoker6.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    invoker6 = MockInvoker.createMockInvoker(true);</span>
     when(invoker7.isAvailable()).thenReturn(true);
     when(invoker8.isAvailable()).thenReturn(true);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRandomSelect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    invokerList.add(invoker6);

    invokerList.add(invoker7);

    invokerList.add(invoker8);

    invokerList.add(invoker9);

    invokerList.add(invoker10);

    invokerList.add(invoker11);

    invokerList.add(invoker12);

    invokerList.add(invoker13);

    invokerList.add(invoker14);

    invokerList.add(invoker15);

    directory.notify(invokerList);

    Assertions.assertEquals(<span class="hljs-number">15</span>, directory.list(invocation).size());

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++) {

        clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {

        Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    }

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    invokerSet.add(invoker2);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    invokerSet.add(invoker5);

    invokerSet.add(invoker6);

    invokerSet.add(invoker7);

    invokerSet.add(invoker8);

    invokerSet.add(invoker9);

    invokerSet.add(invoker10);

    invokerSet.add(invoker11);

    invokerSet.add(invoker12);

    invokerSet.add(invoker13);

    invokerSet.add(invoker14);

    invokerSet.add(invoker15);

    waitRefresh(invokerSet);

    Assertions.assertTrue(directory.list(invocation).size() &gt; <span class="hljs-number">1</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4313">Test Case ID #dubbo_Test_43_13</h4>
<h4 id="test-case-name-testrandomselectfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testRandomSelect</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker7">Mock Object Variable Name: <code>invoker7</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     invoker6 = Mockito.mock(Invoker.class);
<span class="hljs-deletion">-    invoker7 = Mockito.mock(Invoker.class);</span>
<span class="hljs-addition">+    // invoker7 will be initialized in test method as needed</span>
     invoker8 = Mockito.mock(Invoker.class);
     invoker9 = Mockito.mock(Invoker.class);
@@
     configInvoker(invoker6);
<span class="hljs-deletion">-    configInvoker(invoker7);</span>
<span class="hljs-addition">+    // configInvoker(invoker7) will be called after mock creation in test method</span>
     configInvoker(invoker8);
     configInvoker(invoker9);
@@
    when(invoker5.isAvailable()).thenReturn(false);
    when(invoker6.isAvailable()).thenReturn(false);
<span class="hljs-deletion">-    when(invoker7.isAvailable()).thenReturn(false);</span>
<span class="hljs-addition">+    invoker7 = MockInvoker.createMockInvoker(false);</span>
<span class="hljs-addition">+    configInvoker(invoker7);</span>
    when(invoker8.isAvailable()).thenReturn(false);
    when(invoker9.isAvailable()).thenReturn(false);
@@
    when(invoker6.isAvailable()).thenReturn(true);
<span class="hljs-deletion">-    when(invoker7.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    invoker7 = MockInvoker.createMockInvoker(true);</span>
<span class="hljs-addition">+    configInvoker(invoker7);</span>
    when(invoker8.isAvailable()).thenReturn(true);
    when(invoker9.isAvailable()).thenReturn(true);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRandomSelect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    invokerList.add(invoker6);

    invokerList.add(invoker7);

    invokerList.add(invoker8);

    invokerList.add(invoker9);

    invokerList.add(invoker10);

    invokerList.add(invoker11);

    invokerList.add(invoker12);

    invokerList.add(invoker13);

    invokerList.add(invoker14);

    invokerList.add(invoker15);

    directory.notify(invokerList);

    Assertions.assertEquals(<span class="hljs-number">15</span>, directory.list(invocation).size());

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++) {

        clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {

        Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    }

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    invokerSet.add(invoker2);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    invokerSet.add(invoker5);

    invokerSet.add(invoker6);

    invokerSet.add(invoker7);

    invokerSet.add(invoker8);

    invokerSet.add(invoker9);

    invokerSet.add(invoker10);

    invokerSet.add(invoker11);

    invokerSet.add(invoker12);

    invokerSet.add(invoker13);

    invokerSet.add(invoker14);

    invokerSet.add(invoker15);

    waitRefresh(invokerSet);

    Assertions.assertTrue(directory.list(invocation).size() &gt; <span class="hljs-number">1</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4314">Test Case ID #dubbo_Test_43_14</h4>
<h4 id="test-case-name-testrandomselectfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testRandomSelect</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker8">Mock Object Variable Name: <code>invoker8</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- a/TestClass.java</span>
<span class="hljs-comment">+++ b/TestClass.java</span>
@@
<span class="hljs-deletion">-    invoker8 = Mockito.mock(Invoker.class);</span>
<span class="hljs-addition">+    // invoker8 will be created in the test method using MockInvoker.createMockInvoker</span>
     invoker9 = Mockito.mock(Invoker.class);
@@
<span class="hljs-deletion">-    configInvoker(invoker8);</span>
<span class="hljs-addition">+    // configInvoker(invoker8) will be handled in the test method after mock creation</span>
     configInvoker(invoker9);
@@
     invokerList.add(invoker6);
     invokerList.add(invoker7);
<span class="hljs-deletion">-    invokerList.add(invoker8);</span>
<span class="hljs-addition">+    invoker8 = MockInvoker.createMockInvoker(false);</span>
<span class="hljs-addition">+    configInvoker(invoker8);</span>
<span class="hljs-addition">+    invokerList.add(invoker8);</span>
     invokerList.add(invoker9);
     invokerList.add(invoker10);
@@
<span class="hljs-deletion">-    when(invoker8.isAvailable()).thenReturn(false);</span>
@@
     when(invoker7.isAvailable()).thenReturn(false);
<span class="hljs-deletion">-    when(invoker8.isAvailable()).thenReturn(false);</span>
     when(invoker9.isAvailable()).thenReturn(false);
@@
     when(invoker7.isAvailable()).thenReturn(true);
<span class="hljs-deletion">-    when(invoker8.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    invoker8 = MockInvoker.createMockInvoker(true);</span>
<span class="hljs-addition">+    configInvoker(invoker8);</span>
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRandomSelect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    invokerList.add(invoker6);

    invokerList.add(invoker7);

    invokerList.add(invoker8);

    invokerList.add(invoker9);

    invokerList.add(invoker10);

    invokerList.add(invoker11);

    invokerList.add(invoker12);

    invokerList.add(invoker13);

    invokerList.add(invoker14);

    invokerList.add(invoker15);

    directory.notify(invokerList);

    Assertions.assertEquals(<span class="hljs-number">15</span>, directory.list(invocation).size());

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++) {

        clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {

        Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    }

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    invokerSet.add(invoker2);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    invokerSet.add(invoker5);

    invokerSet.add(invoker6);

    invokerSet.add(invoker7);

    invokerSet.add(invoker8);

    invokerSet.add(invoker9);

    invokerSet.add(invoker10);

    invokerSet.add(invoker11);

    invokerSet.add(invoker12);

    invokerSet.add(invoker13);

    invokerSet.add(invoker14);

    invokerSet.add(invoker15);

    waitRefresh(invokerSet);

    Assertions.assertTrue(directory.list(invocation).size() &gt; <span class="hljs-number">1</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4315">Test Case ID #dubbo_Test_43_15</h4>
<h4 id="test-case-name-testrandomselectfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testRandomSelect</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker9">Mock Object Variable Name: <code>invoker9</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- a/TestClass.java</span>
<span class="hljs-comment">+++ b/TestClass.java</span>
@@
    invokerList.add(invoker8);
    invokerList.add(invoker9);
    invokerList.add(invoker10);
    invokerList.add(invoker11);
    invokerList.add(invoker12);
    invokerList.add(invoker13);
    invokerList.add(invoker14);
    invokerList.add(invoker15);
    directory.notify(invokerList);
    Assertions.assertEquals(15, directory.list(invocation).size());
    when(invoker2.isAvailable()).thenReturn(false);
    when(invoker3.isAvailable()).thenReturn(false);
    when(invoker4.isAvailable()).thenReturn(false);
    when(invoker5.isAvailable()).thenReturn(false);
    when(invoker6.isAvailable()).thenReturn(false);
    when(invoker7.isAvailable()).thenReturn(false);
    when(invoker8.isAvailable()).thenReturn(false);
<span class="hljs-deletion">-    when(invoker9.isAvailable()).thenReturn(false);</span>
<span class="hljs-addition">+    invoker9 = MockInvoker.createMockInvoker(false);</span>
    when(invoker10.isAvailable()).thenReturn(false);
    when(invoker11.isAvailable()).thenReturn(false);
    when(invoker12.isAvailable()).thenReturn(false);
    when(invoker13.isAvailable()).thenReturn(false);
    when(invoker14.isAvailable()).thenReturn(false);
    when(invoker15.isAvailable()).thenReturn(false);
    for (int i = 0; i &lt; 15; i++) {
        clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());
    }
    for (int i = 0; i &lt; 5; i++) {
        Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));
    }
    when(invoker1.isAvailable()).thenReturn(false);
    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());
    Assertions.assertEquals(0, directory.list(invocation).size());
    when(invoker1.isAvailable()).thenReturn(true);
    when(invoker2.isAvailable()).thenReturn(true);
    when(invoker3.isAvailable()).thenReturn(true);
    when(invoker4.isAvailable()).thenReturn(true);
    when(invoker5.isAvailable()).thenReturn(true);
    when(invoker6.isAvailable()).thenReturn(true);
    when(invoker7.isAvailable()).thenReturn(true);
    when(invoker8.isAvailable()).thenReturn(true);
<span class="hljs-deletion">-    when(invoker9.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    invoker9 = MockInvoker.createMockInvoker(true);</span>
    when(invoker10.isAvailable()).thenReturn(true);
    when(invoker11.isAvailable()).thenReturn(true);
    when(invoker12.isAvailable()).thenReturn(true);
    when(invoker13.isAvailable()).thenReturn(true);
    when(invoker14.isAvailable()).thenReturn(true);
    when(invoker15.isAvailable()).thenReturn(true);
    Set&lt;Invoker&gt; invokerSet = new HashSet&lt;&gt;();
    invokerSet.add(invoker1);
    invokerSet.add(invoker2);
    invokerSet.add(invoker3);
    invokerSet.add(invoker4);
    invokerSet.add(invoker5);
    invokerSet.add(invoker6);
    invokerSet.add(invoker7);
    invokerSet.add(invoker8);
    invokerSet.add(invoker9);
    invokerSet.add(invoker10);
    invokerSet.add(invoker11);
    invokerSet.add(invoker12);
    invokerSet.add(invoker13);
    invokerSet.add(invoker14);
    invokerSet.add(invoker15);
    waitRefresh(invokerSet);
    Assertions.assertTrue(directory.list(invocation).size() &gt; 1);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRandomSelect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    invokerList.add(invoker6);

    invokerList.add(invoker7);

    invokerList.add(invoker8);

    invokerList.add(invoker9);

    invokerList.add(invoker10);

    invokerList.add(invoker11);

    invokerList.add(invoker12);

    invokerList.add(invoker13);

    invokerList.add(invoker14);

    invokerList.add(invoker15);

    directory.notify(invokerList);

    Assertions.assertEquals(<span class="hljs-number">15</span>, directory.list(invocation).size());

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++) {

        clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {

        Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    }

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    invokerSet.add(invoker2);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    invokerSet.add(invoker5);

    invokerSet.add(invoker6);

    invokerSet.add(invoker7);

    invokerSet.add(invoker8);

    invokerSet.add(invoker9);

    invokerSet.add(invoker10);

    invokerSet.add(invoker11);

    invokerSet.add(invoker12);

    invokerSet.add(invoker13);

    invokerSet.add(invoker14);

    invokerSet.add(invoker15);

    waitRefresh(invokerSet);

    Assertions.assertTrue(directory.list(invocation).size() &gt; <span class="hljs-number">1</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4316">Test Case ID #dubbo_Test_43_16</h4>
<h4 id="test-case-name-testrandomselectfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testRandomSelect</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker10">Mock Object Variable Name: <code>invoker10</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     when(invoker8.isAvailable()).thenReturn(false);
     when(invoker9.isAvailable()).thenReturn(false);
<span class="hljs-deletion">-    when(invoker10.isAvailable()).thenReturn(false);</span>
<span class="hljs-addition">+    invoker10 = MockInvoker.createMockInvoker(false);</span>
     when(invoker11.isAvailable()).thenReturn(false);
     when(invoker12.isAvailable()).thenReturn(false);
     when(invoker13.isAvailable()).thenReturn(false);
@@
     when(invoker8.isAvailable()).thenReturn(true);
     when(invoker9.isAvailable()).thenReturn(true);
<span class="hljs-deletion">-    when(invoker10.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    invoker10 = MockInvoker.createMockInvoker(true);</span>
     when(invoker11.isAvailable()).thenReturn(true);
     when(invoker12.isAvailable()).thenReturn(true);
     when(invoker13.isAvailable()).thenReturn(true);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRandomSelect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    invokerList.add(invoker6);

    invokerList.add(invoker7);

    invokerList.add(invoker8);

    invokerList.add(invoker9);

    invokerList.add(invoker10);

    invokerList.add(invoker11);

    invokerList.add(invoker12);

    invokerList.add(invoker13);

    invokerList.add(invoker14);

    invokerList.add(invoker15);

    directory.notify(invokerList);

    Assertions.assertEquals(<span class="hljs-number">15</span>, directory.list(invocation).size());

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++) {

        clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {

        Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    }

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    invokerSet.add(invoker2);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    invokerSet.add(invoker5);

    invokerSet.add(invoker6);

    invokerSet.add(invoker7);

    invokerSet.add(invoker8);

    invokerSet.add(invoker9);

    invokerSet.add(invoker10);

    invokerSet.add(invoker11);

    invokerSet.add(invoker12);

    invokerSet.add(invoker13);

    invokerSet.add(invoker14);

    invokerSet.add(invoker15);

    waitRefresh(invokerSet);

    Assertions.assertTrue(directory.list(invocation).size() &gt; <span class="hljs-number">1</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4317">Test Case ID #dubbo_Test_43_17</h4>
<h4 id="test-case-name-testrandomselectfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testRandomSelect</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker11">Mock Object Variable Name: <code>invoker11</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- Original</span>
<span class="hljs-comment">+++ Refactored</span>
@@
<span class="hljs-deletion">-    invoker11 = Mockito.mock(Invoker.class);</span>
<span class="hljs-addition">+    // invoker11 will be assigned in the test method using MockInvoker.createMockInvoker</span>
     configInvoker(invoker11);
@@
 void testRandomSelect() throws InterruptedException {
     Invocation invocation = new RpcInvocation();
     LoadBalance loadBalance = new RandomLoadBalance();
     invokerList.add(invoker6);
     invokerList.add(invoker7);
     invokerList.add(invoker8);
     invokerList.add(invoker9);
     invokerList.add(invoker10);
<span class="hljs-deletion">-    invokerList.add(invoker11);</span>
<span class="hljs-addition">+    invoker11 = MockInvoker.createMockInvoker(false);</span>
<span class="hljs-addition">+    invokerList.add(invoker11);</span>
     invokerList.add(invoker12);
     invokerList.add(invoker13);
     invokerList.add(invoker14);
     invokerList.add(invoker15);
     directory.notify(invokerList);
     Assertions.assertEquals(15, directory.list(invocation).size());
     when(invoker2.isAvailable()).thenReturn(false);
     when(invoker3.isAvailable()).thenReturn(false);
     when(invoker4.isAvailable()).thenReturn(false);
     when(invoker5.isAvailable()).thenReturn(false);
     when(invoker6.isAvailable()).thenReturn(false);
     when(invoker7.isAvailable()).thenReturn(false);
     when(invoker8.isAvailable()).thenReturn(false);
     when(invoker9.isAvailable()).thenReturn(false);
     when(invoker10.isAvailable()).thenReturn(false);
<span class="hljs-deletion">-    when(invoker11.isAvailable()).thenReturn(false);</span>
     when(invoker12.isAvailable()).thenReturn(false);
     when(invoker13.isAvailable()).thenReturn(false);
     when(invoker14.isAvailable()).thenReturn(false);
     when(invoker15.isAvailable()).thenReturn(false);
     for (int i = 0; i &lt; 15; i++) {
         clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());
     }
     for (int i = 0; i &lt; 5; i++) {
         Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));
     }
     when(invoker1.isAvailable()).thenReturn(false);
     clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());
     Assertions.assertEquals(0, directory.list(invocation).size());
     when(invoker1.isAvailable()).thenReturn(true);
     when(invoker2.isAvailable()).thenReturn(true);
     when(invoker3.isAvailable()).thenReturn(true);
     when(invoker4.isAvailable()).thenReturn(true);
     when(invoker5.isAvailable()).thenReturn(true);
     when(invoker6.isAvailable()).thenReturn(true);
     when(invoker7.isAvailable()).thenReturn(true);
     when(invoker8.isAvailable()).thenReturn(true);
     when(invoker9.isAvailable()).thenReturn(true);
     when(invoker10.isAvailable()).thenReturn(true);
<span class="hljs-deletion">-    when(invoker11.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    invoker11 = MockInvoker.createMockInvoker(true);</span>
     when(invoker12.isAvailable()).thenReturn(true);
     when(invoker13.isAvailable()).thenReturn(true);
     when(invoker14.isAvailable()).thenReturn(true);
     when(invoker15.isAvailable()).thenReturn(true);
     Set&lt;Invoker&gt; invokerSet = new HashSet&lt;&gt;();
     invokerSet.add(invoker1);
     invokerSet.add(invoker2);
     invokerSet.add(invoker3);
     invokerSet.add(invoker4);
     invokerSet.add(invoker5);
     invokerSet.add(invoker6);
     invokerSet.add(invoker7);
     invokerSet.add(invoker8);
     invokerSet.add(invoker9);
     invokerSet.add(invoker10);
     invokerSet.add(invoker11);
     invokerSet.add(invoker12);
     invokerSet.add(invoker13);
     invokerSet.add(invoker14);
     invokerSet.add(invoker15);
     waitRefresh(invokerSet);
     Assertions.assertTrue(directory.list(invocation).size() &gt; 1);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRandomSelect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    invokerList.add(invoker6);

    invokerList.add(invoker7);

    invokerList.add(invoker8);

    invokerList.add(invoker9);

    invokerList.add(invoker10);

    invokerList.add(invoker11);

    invokerList.add(invoker12);

    invokerList.add(invoker13);

    invokerList.add(invoker14);

    invokerList.add(invoker15);

    directory.notify(invokerList);

    Assertions.assertEquals(<span class="hljs-number">15</span>, directory.list(invocation).size());

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++) {

        clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {

        Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    }

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    invokerSet.add(invoker2);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    invokerSet.add(invoker5);

    invokerSet.add(invoker6);

    invokerSet.add(invoker7);

    invokerSet.add(invoker8);

    invokerSet.add(invoker9);

    invokerSet.add(invoker10);

    invokerSet.add(invoker11);

    invokerSet.add(invoker12);

    invokerSet.add(invoker13);

    invokerSet.add(invoker14);

    invokerSet.add(invoker15);

    waitRefresh(invokerSet);

    Assertions.assertTrue(directory.list(invocation).size() &gt; <span class="hljs-number">1</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4318">Test Case ID #dubbo_Test_43_18</h4>
<h4 id="test-case-name-testrandomselectfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testRandomSelect</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker12">Mock Object Variable Name: <code>invoker12</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- a/TestClass.java</span>
<span class="hljs-comment">+++ b/TestClass.java</span>
@@
     when(invoker10.isAvailable()).thenReturn(false);
     when(invoker11.isAvailable()).thenReturn(false);
<span class="hljs-deletion">-    when(invoker12.isAvailable()).thenReturn(false);</span>
     when(invoker13.isAvailable()).thenReturn(false);
     when(invoker14.isAvailable()).thenReturn(false);
     when(invoker15.isAvailable()).thenReturn(false);
     for (int i = 0; i &lt; 15; i++) {
         clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());
     }
     for (int i = 0; i &lt; 5; i++) {
         Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));
     }
     when(invoker1.isAvailable()).thenReturn(false);
     clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());
     Assertions.assertEquals(0, directory.list(invocation).size());
     when(invoker1.isAvailable()).thenReturn(true);
     when(invoker2.isAvailable()).thenReturn(true);
     when(invoker3.isAvailable()).thenReturn(true);
     when(invoker4.isAvailable()).thenReturn(true);
     when(invoker5.isAvailable()).thenReturn(true);
     when(invoker6.isAvailable()).thenReturn(true);
     when(invoker7.isAvailable()).thenReturn(true);
     when(invoker8.isAvailable()).thenReturn(true);
     when(invoker9.isAvailable()).thenReturn(true);
     when(invoker10.isAvailable()).thenReturn(true);
     when(invoker11.isAvailable()).thenReturn(true);
<span class="hljs-deletion">-    when(invoker12.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    invoker12 = MockInvoker.createMockInvoker(true);</span>
     when(invoker13.isAvailable()).thenReturn(true);
     when(invoker14.isAvailable()).thenReturn(true);
     when(invoker15.isAvailable()).thenReturn(true);
     Set&lt;Invoker&gt; invokerSet = new HashSet&lt;&gt;();
     invokerSet.add(invoker1);
     invokerSet.add(invoker2);
     invokerSet.add(invoker3);
     invokerSet.add(invoker4);
     invokerSet.add(invoker5);
     invokerSet.add(invoker6);
     invokerSet.add(invoker7);
     invokerSet.add(invoker8);
     invokerSet.add(invoker9);
     invokerSet.add(invoker10);
     invokerSet.add(invoker11);
     invokerSet.add(invoker12);
     invokerSet.add(invoker13);
     invokerSet.add(invoker14);
     invokerSet.add(invoker15);
     waitRefresh(invokerSet);
     Assertions.assertTrue(directory.list(invocation).size() &gt; 1);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRandomSelect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    invokerList.add(invoker6);

    invokerList.add(invoker7);

    invokerList.add(invoker8);

    invokerList.add(invoker9);

    invokerList.add(invoker10);

    invokerList.add(invoker11);

    invokerList.add(invoker12);

    invokerList.add(invoker13);

    invokerList.add(invoker14);

    invokerList.add(invoker15);

    directory.notify(invokerList);

    Assertions.assertEquals(<span class="hljs-number">15</span>, directory.list(invocation).size());

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++) {

        clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {

        Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    }

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    invokerSet.add(invoker2);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    invokerSet.add(invoker5);

    invokerSet.add(invoker6);

    invokerSet.add(invoker7);

    invokerSet.add(invoker8);

    invokerSet.add(invoker9);

    invokerSet.add(invoker10);

    invokerSet.add(invoker11);

    invokerSet.add(invoker12);

    invokerSet.add(invoker13);

    invokerSet.add(invoker14);

    invokerSet.add(invoker15);

    waitRefresh(invokerSet);

    Assertions.assertTrue(directory.list(invocation).size() &gt; <span class="hljs-number">1</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4319">Test Case ID #dubbo_Test_43_19</h4>
<h4 id="test-case-name-testrandomselectfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testRandomSelect</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker13">Mock Object Variable Name: <code>invoker13</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- Original</span>
<span class="hljs-comment">+++ Refactored</span>
@@
     when(invoker12.isAvailable()).thenReturn(false);
<span class="hljs-deletion">-    when(invoker13.isAvailable()).thenReturn(false);</span>
     when(invoker14.isAvailable()).thenReturn(false);
     when(invoker15.isAvailable()).thenReturn(false);
     for (int i = 0; i &lt; 15; i++) {
@@
     when(invoker12.isAvailable()).thenReturn(true);
<span class="hljs-deletion">-    when(invoker13.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    invoker13 = MockInvoker.createMockInvoker(true);</span>
     when(invoker14.isAvailable()).thenReturn(true);
     when(invoker15.isAvailable()).thenReturn(true);
     Set&lt;Invoker&gt; invokerSet = new HashSet&lt;&gt;();
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRandomSelect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    invokerList.add(invoker6);

    invokerList.add(invoker7);

    invokerList.add(invoker8);

    invokerList.add(invoker9);

    invokerList.add(invoker10);

    invokerList.add(invoker11);

    invokerList.add(invoker12);

    invokerList.add(invoker13);

    invokerList.add(invoker14);

    invokerList.add(invoker15);

    directory.notify(invokerList);

    Assertions.assertEquals(<span class="hljs-number">15</span>, directory.list(invocation).size());

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++) {

        clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {

        Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    }

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    invokerSet.add(invoker2);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    invokerSet.add(invoker5);

    invokerSet.add(invoker6);

    invokerSet.add(invoker7);

    invokerSet.add(invoker8);

    invokerSet.add(invoker9);

    invokerSet.add(invoker10);

    invokerSet.add(invoker11);

    invokerSet.add(invoker12);

    invokerSet.add(invoker13);

    invokerSet.add(invoker14);

    invokerSet.add(invoker15);

    waitRefresh(invokerSet);

    Assertions.assertTrue(directory.list(invocation).size() &gt; <span class="hljs-number">1</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4320">Test Case ID #dubbo_Test_43_20</h4>
<h4 id="test-case-name-testrandomselectfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testRandomSelect</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker14">Mock Object Variable Name: <code>invoker14</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- Original.java</span>
<span class="hljs-comment">+++ Refactored.java</span>
@@
     when(invoker13.isAvailable()).thenReturn(false);
<span class="hljs-deletion">-    when(invoker14.isAvailable()).thenReturn(false);</span>
     when(invoker15.isAvailable()).thenReturn(false);
     for (int i = 0; i &lt; 15; i++) {
         clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());
     }
     for (int i = 0; i &lt; 5; i++) {
         Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));
     }
     when(invoker1.isAvailable()).thenReturn(false);
     clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());
     Assertions.assertEquals(0, directory.list(invocation).size());
     when(invoker1.isAvailable()).thenReturn(true);
     when(invoker2.isAvailable()).thenReturn(true);
     when(invoker3.isAvailable()).thenReturn(true);
     when(invoker4.isAvailable()).thenReturn(true);
     when(invoker5.isAvailable()).thenReturn(true);
     when(invoker6.isAvailable()).thenReturn(true);
     when(invoker7.isAvailable()).thenReturn(true);
     when(invoker8.isAvailable()).thenReturn(true);
     when(invoker9.isAvailable()).thenReturn(true);
     when(invoker10.isAvailable()).thenReturn(true);
     when(invoker11.isAvailable()).thenReturn(true);
     when(invoker12.isAvailable()).thenReturn(true);
     when(invoker13.isAvailable()).thenReturn(true);
<span class="hljs-deletion">-    when(invoker14.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    when(invoker14.isAvailable()).thenReturn(true); // replaced by helper if needed</span>
     when(invoker15.isAvailable()).thenReturn(true);
     Set&lt;Invoker&gt; invokerSet = new HashSet&lt;&gt;();
     invokerSet.add(invoker1);
     invokerSet.add(invoker2);
     invokerSet.add(invoker3);
     invokerSet.add(invoker4);
     invokerSet.add(invoker5);
     invokerSet.add(invoker6);
     invokerSet.add(invoker7);
     invokerSet.add(invoker8);
     invokerSet.add(invoker9);
     invokerSet.add(invoker10);
     invokerSet.add(invoker11);
     invokerSet.add(invoker12);
     invokerSet.add(invoker13);
     invokerSet.add(invoker14);
     invokerSet.add(invoker15);
     waitRefresh(invokerSet);
     Assertions.assertTrue(directory.list(invocation).size() &gt; 1);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRandomSelect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    invokerList.add(invoker6);

    invokerList.add(invoker7);

    invokerList.add(invoker8);

    invokerList.add(invoker9);

    invokerList.add(invoker10);

    invokerList.add(invoker11);

    invokerList.add(invoker12);

    invokerList.add(invoker13);

    invokerList.add(invoker14);

    invokerList.add(invoker15);

    directory.notify(invokerList);

    Assertions.assertEquals(<span class="hljs-number">15</span>, directory.list(invocation).size());

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++) {

        clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {

        Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    }

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    invokerSet.add(invoker2);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    invokerSet.add(invoker5);

    invokerSet.add(invoker6);

    invokerSet.add(invoker7);

    invokerSet.add(invoker8);

    invokerSet.add(invoker9);

    invokerSet.add(invoker10);

    invokerSet.add(invoker11);

    invokerSet.add(invoker12);

    invokerSet.add(invoker13);

    invokerSet.add(invoker14);

    invokerSet.add(invoker15);

    waitRefresh(invokerSet);

    Assertions.assertTrue(directory.list(invocation).size() &gt; <span class="hljs-number">1</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4321">Test Case ID #dubbo_Test_43_21</h4>
<h4 id="test-case-name-testrandomselectfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportconnectivityvalidationtestjava">Test Case Name: <code>testRandomSelect</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\ConnectivityValidationTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker15">Mock Object Variable Name: <code>invoker15</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     when(invoker14.isAvailable()).thenReturn(false);
<span class="hljs-deletion">-    when(invoker15.isAvailable()).thenReturn(false);</span>
<span class="hljs-addition">+    invoker15 = MockInvoker.createMockInvoker(false);</span>
     for (int i = 0; i &lt; 15; i++) {
         clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());
     }
     for (int i = 0; i &lt; 5; i++) {
         Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));
     }
     when(invoker1.isAvailable()).thenReturn(false);
     clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());
     Assertions.assertEquals(0, directory.list(invocation).size());
     when(invoker1.isAvailable()).thenReturn(true);
     when(invoker2.isAvailable()).thenReturn(true);
     when(invoker3.isAvailable()).thenReturn(true);
     when(invoker4.isAvailable()).thenReturn(true);
     when(invoker5.isAvailable()).thenReturn(true);
     when(invoker6.isAvailable()).thenReturn(true);
     when(invoker7.isAvailable()).thenReturn(true);
     when(invoker8.isAvailable()).thenReturn(true);
     when(invoker9.isAvailable()).thenReturn(true);
     when(invoker10.isAvailable()).thenReturn(true);
     when(invoker11.isAvailable()).thenReturn(true);
     when(invoker12.isAvailable()).thenReturn(true);
     when(invoker13.isAvailable()).thenReturn(true);
     when(invoker14.isAvailable()).thenReturn(true);
<span class="hljs-deletion">-    when(invoker15.isAvailable()).thenReturn(true);</span>
<span class="hljs-addition">+    invoker15 = MockInvoker.createMockInvoker(true);</span>
     Set&lt;Invoker&gt; invokerSet = new HashSet&lt;&gt;();
     invokerSet.add(invoker1);
     invokerSet.add(invoker2);
     invokerSet.add(invoker3);
     invokerSet.add(invoker4);
     invokerSet.add(invoker5);
     invokerSet.add(invoker6);
     invokerSet.add(invoker7);
     invokerSet.add(invoker8);
     invokerSet.add(invoker9);
     invokerSet.add(invoker10);
     invokerSet.add(invoker11);
     invokerSet.add(invoker12);
     invokerSet.add(invoker13);
     invokerSet.add(invoker14);
     invokerSet.add(invoker15);
     waitRefresh(invokerSet);
     Assertions.assertTrue(directory.list(invocation).size() &gt; 1);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getBeanFactory().registerBean(MetricsDispatcher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker1 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker2 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker3 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker4 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker5 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker6 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker7 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker8 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker9 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker10 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker11 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker12 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker13 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker14 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invoker15 = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    configInvoker(invoker1);

    configInvoker(invoker2);

    configInvoker(invoker3);

    configInvoker(invoker4);

    configInvoker(invoker5);

    configInvoker(invoker6);

    configInvoker(invoker7);

    configInvoker(invoker8);

    configInvoker(invoker9);

    configInvoker(invoker10);

    configInvoker(invoker11);

    configInvoker(invoker12);

    configInvoker(invoker13);

    configInvoker(invoker14);

    configInvoker(invoker15);

    invokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokerList.add(invoker1);

    invokerList.add(invoker2);

    invokerList.add(invoker3);

    invokerList.add(invoker4);

    invokerList.add(invoker5);

    directory = <span class="hljs-keyword">new</span> StaticDirectory(invokerList);

    clusterInvoker = <span class="hljs-keyword">new</span> ConnectivityClusterInvoker(directory);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRandomSelect</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    LoadBalance loadBalance = <span class="hljs-keyword">new</span> RandomLoadBalance();

    invokerList.add(invoker6);

    invokerList.add(invoker7);

    invokerList.add(invoker8);

    invokerList.add(invoker9);

    invokerList.add(invoker10);

    invokerList.add(invoker11);

    invokerList.add(invoker12);

    invokerList.add(invoker13);

    invokerList.add(invoker14);

    invokerList.add(invoker15);

    directory.notify(invokerList);

    Assertions.assertEquals(<span class="hljs-number">15</span>, directory.list(invocation).size());

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">15</span>; i++) {

        clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {

        Assertions.assertEquals(invoker1, clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList()));

    }

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    clusterInvoker.select(loadBalance, invocation, directory.list(invocation), Collections.emptyList());

    Assertions.assertEquals(<span class="hljs-number">0</span>, directory.list(invocation).size());

    when(invoker1.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker2.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker3.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker4.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker5.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker6.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker7.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker8.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker9.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker10.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker11.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker12.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker13.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker14.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    when(invoker15.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Set&lt;Invoker&gt; invokerSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    invokerSet.add(invoker1);

    invokerSet.add(invoker2);

    invokerSet.add(invoker3);

    invokerSet.add(invoker4);

    invokerSet.add(invoker5);

    invokerSet.add(invoker6);

    invokerSet.add(invoker7);

    invokerSet.add(invoker8);

    invokerSet.add(invoker9);

    invokerSet.add(invoker10);

    invokerSet.add(invoker11);

    invokerSet.add(invoker12);

    invokerSet.add(invoker13);

    invokerSet.add(invoker14);

    invokerSet.add(invoker15);

    waitRefresh(invokerSet);

    Assertions.assertTrue(directory.list(invocation).size() &gt; <span class="hljs-number">1</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4322">Test Case ID #dubbo_Test_43_22</h4>
<h4 id="test-case-name-testaddmenufile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportmergeableclusterinvokertestjava">Test Case Name: <code>testAddMenu</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\MergeableClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-firstinvoker">Mock Object Variable Name: <code>firstInvoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    given(invocation.getObjectAttachments()).willReturn(new HashMap&lt;&gt;());
    given(invocation.getInvoker()).willReturn(firstInvoker);
<span class="hljs-deletion">-    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "first"));</span>
<span class="hljs-deletion">-    given(firstInvoker.getInterface()).willReturn(MenuService.class);</span>
<span class="hljs-deletion">-    given(firstInvoker.invoke(invocation)).willReturn(new AppResponse());</span>
<span class="hljs-deletion">-    given(firstInvoker.isAvailable()).willReturn(true);</span>
<span class="hljs-addition">+    firstInvoker = MockInvoker.createMockInvoker(true);</span>
<span class="hljs-addition">+    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "first"));</span>
<span class="hljs-addition">+    given(firstInvoker.getInterface()).willReturn(MenuService.class);</span>
<span class="hljs-addition">+    given(firstInvoker.invoke(invocation)).willReturn(new AppResponse());</span>
    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "second"));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAddMenu</span><span class="hljs-params">()</span> </span>{

    String menu = <span class="hljs-string">"first"</span>;

    List&lt;String&gt; menuItems = <span class="hljs-keyword">new</span> ArrayList&lt;String&gt;() {



        {

            add(<span class="hljs-string">"1"</span>);

            add(<span class="hljs-string">"2"</span>);

        }

    };

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"addMenu"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">List</span>.<span class="hljs-title">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { menu, menuItems });

    given(invocation.getObjectAttachments()).willReturn(<span class="hljs-keyword">new</span> HashMap&lt;&gt;());

    given(invocation.getInvoker()).willReturn(firstInvoker);

    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"first"</span>));

    given(firstInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(firstInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(firstInvoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"second"</span>));

    given(secondInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(secondInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(secondInvoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(directory.list(invocation)).willReturn(<span class="hljs-keyword">new</span> ArrayList() {



        {

            add(firstInvoker);

            add(secondInvoker);

        }

    });

    given(directory.getUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    mergeableClusterInvoker = <span class="hljs-keyword">new</span> MergeableClusterInvoker&lt;MenuService&gt;(directory);

    Result result = mergeableClusterInvoker.invoke(invocation);

    Assertions.assertNull(result.getValue());

}
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    directory = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    firstInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    secondInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4323">Test Case ID #dubbo_Test_43_23</h4>
<h4 id="test-case-name-testinvokertonoinvokeravailableexceptionfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportmergeableclusterinvokertestjava">Test Case Name: <code>testInvokerToNoInvokerAvailableException</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\MergeableClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-firstinvoker">Mock Object Variable Name: <code>firstInvoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- a/TestClass.java</span>
<span class="hljs-comment">+++ b/TestClass.java</span>
@@
    given(invocation.getObjectAttachments()).willReturn(new HashMap&lt;&gt;());
    given(invocation.getInvoker()).willReturn(firstInvoker);
<span class="hljs-deletion">-    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "first"));</span>
<span class="hljs-deletion">-    given(firstInvoker.getInterface()).willReturn(MenuService.class);</span>
<span class="hljs-deletion">-    given(firstInvoker.invoke(invocation)).willReturn(new AppResponse());</span>
<span class="hljs-deletion">-    given(firstInvoker.isAvailable()).willReturn(true);</span>
<span class="hljs-deletion">-    given(firstInvoker.invoke(invocation)).willThrow(new RpcException(RpcException.NO_INVOKER_AVAILABLE_AFTER_FILTER));</span>
<span class="hljs-addition">+    firstInvoker = MockInvoker.createMockInvoker(true);</span>
<span class="hljs-addition">+    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "first"));</span>
<span class="hljs-addition">+    given(firstInvoker.getInterface()).willReturn(MenuService.class);</span>
<span class="hljs-addition">+    given(firstInvoker.invoke(invocation)).willReturn(new AppResponse());</span>
<span class="hljs-addition">+    given(firstInvoker.invoke(invocation)).willThrow(new RpcException(RpcException.NO_INVOKER_AVAILABLE_AFTER_FILTER));</span>
    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "second"));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokerToNoInvokerAvailableException</span><span class="hljs-params">()</span> </span>{

    String menu = <span class="hljs-string">"first"</span>;

    List&lt;String&gt; menuItems = <span class="hljs-keyword">new</span> ArrayList&lt;String&gt;() {



        {

            add(<span class="hljs-string">"1"</span>);

            add(<span class="hljs-string">"2"</span>);

        }

    };

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"addMenu"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">List</span>.<span class="hljs-title">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { menu, menuItems });

    given(invocation.getObjectAttachments()).willReturn(<span class="hljs-keyword">new</span> HashMap&lt;&gt;());

    given(invocation.getInvoker()).willReturn(firstInvoker);

    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"first"</span>));

    given(firstInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(firstInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(firstInvoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(firstInvoker.invoke(invocation)).willThrow(<span class="hljs-keyword">new</span> RpcException(RpcException.NO_INVOKER_AVAILABLE_AFTER_FILTER));

    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"second"</span>));

    given(secondInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(secondInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(secondInvoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(secondInvoker.invoke(invocation)).willThrow(<span class="hljs-keyword">new</span> RpcException(RpcException.NO_INVOKER_AVAILABLE_AFTER_FILTER));

    given(directory.list(invocation)).willReturn(<span class="hljs-keyword">new</span> ArrayList() {



        {

            add(firstInvoker);

            add(secondInvoker);

        }

    });

    given(directory.getUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    mergeableClusterInvoker = <span class="hljs-keyword">new</span> MergeableClusterInvoker&lt;MenuService&gt;(directory);

    <span class="hljs-comment">// invoke</span>

    <span class="hljs-keyword">try</span> {

        Result result = mergeableClusterInvoker.invoke(invocation);

        fail();

        Assertions.assertNull(result.getValue());

    } <span class="hljs-keyword">catch</span> (RpcException expected) {

        assertEquals(expected.getCode(), RpcException.NO_INVOKER_AVAILABLE_AFTER_FILTER);

    }

}
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    directory = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    firstInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    secondInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4324">Test Case ID #dubbo_Test_43_24</h4>
<h4 id="test-case-name-testinvokertoexceptionfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportmergeableclusterinvokertestjava">Test Case Name: <code>testInvokerToException</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\MergeableClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-firstinvoker">Mock Object Variable Name: <code>firstInvoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- a/TestClass.java</span>
<span class="hljs-comment">+++ b/TestClass.java</span>
@@
    given(invocation.getObjectAttachments()).willReturn(new HashMap&lt;&gt;());
    given(invocation.getInvoker()).willReturn(firstInvoker);
<span class="hljs-deletion">-    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "first"));</span>
<span class="hljs-deletion">-    given(firstInvoker.getInterface()).willReturn(MenuService.class);</span>
<span class="hljs-deletion">-    given(firstInvoker.invoke(invocation)).willReturn(new AppResponse());</span>
<span class="hljs-deletion">-    given(firstInvoker.isAvailable()).willReturn(true);</span>
<span class="hljs-deletion">-    given(firstInvoker.invoke(invocation)).willThrow(new RpcException(RpcException.NETWORK_EXCEPTION));</span>
<span class="hljs-addition">+    firstInvoker = MockInvoker.createMockInvoker(true);</span>
<span class="hljs-addition">+    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "first"));</span>
<span class="hljs-addition">+    given(firstInvoker.getInterface()).willReturn(MenuService.class);</span>
<span class="hljs-addition">+    given(firstInvoker.invoke(invocation)).willReturn(new AppResponse());</span>
<span class="hljs-addition">+    given(firstInvoker.invoke(invocation)).willThrow(new RpcException(RpcException.NETWORK_EXCEPTION));</span>
    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "second"));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    directory = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    firstInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    secondInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

}
<span class="hljs-comment">/**

 * test when network exception

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokerToException</span><span class="hljs-params">()</span> </span>{

    String menu = <span class="hljs-string">"first"</span>;

    List&lt;String&gt; menuItems = <span class="hljs-keyword">new</span> ArrayList&lt;String&gt;() {



        {

            add(<span class="hljs-string">"1"</span>);

            add(<span class="hljs-string">"2"</span>);

        }

    };

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"addMenu"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">List</span>.<span class="hljs-title">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { menu, menuItems });

    given(invocation.getObjectAttachments()).willReturn(<span class="hljs-keyword">new</span> HashMap&lt;&gt;());

    given(invocation.getInvoker()).willReturn(firstInvoker);

    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"first"</span>));

    given(firstInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(firstInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(firstInvoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(firstInvoker.invoke(invocation)).willThrow(<span class="hljs-keyword">new</span> RpcException(RpcException.NETWORK_EXCEPTION));

    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"second"</span>));

    given(secondInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(secondInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(secondInvoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(secondInvoker.invoke(invocation)).willThrow(<span class="hljs-keyword">new</span> RpcException(RpcException.NETWORK_EXCEPTION));

    given(directory.list(invocation)).willReturn(<span class="hljs-keyword">new</span> ArrayList() {



        {

            add(firstInvoker);

            add(secondInvoker);

        }

    });

    given(directory.getUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    mergeableClusterInvoker = <span class="hljs-keyword">new</span> MergeableClusterInvoker&lt;MenuService&gt;(directory);

    <span class="hljs-comment">// invoke</span>

    <span class="hljs-keyword">try</span> {

        Result result = mergeableClusterInvoker.invoke(invocation);

        fail();

        Assertions.assertNull(result.getValue());

    } <span class="hljs-keyword">catch</span> (RpcException expected) {

        assertEquals(expected.getCode(), RpcException.NETWORK_EXCEPTION);

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4325">Test Case ID #dubbo_Test_43_25</h4>
<h4 id="test-case-name-testgetmenuresulthasexceptionfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportmergeableclusterinvokertestjava">Test Case Name: <code>testGetMenuResultHasException</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\MergeableClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-firstinvoker">Mock Object Variable Name: <code>firstInvoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     given(invocation.getParameterTypes()).willReturn(new Class&lt;?&gt;[] {});
     given(invocation.getArguments()).willReturn(new Object[] {});
     given(invocation.getObjectAttachments()).willReturn(new HashMap&lt;&gt;());
     given(invocation.getInvoker()).willReturn(firstInvoker);
<span class="hljs-deletion">-    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "first"));</span>
<span class="hljs-deletion">-    given(firstInvoker.getInterface()).willReturn(MenuService.class);</span>
<span class="hljs-deletion">-    given(firstInvoker.invoke(invocation)).willReturn(new AppResponse());</span>
<span class="hljs-deletion">-    given(firstInvoker.isAvailable()).willReturn(true);</span>
<span class="hljs-addition">+    firstInvoker = MockInvoker.createMockInvoker(true);</span>
<span class="hljs-addition">+    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "first"));</span>
<span class="hljs-addition">+    given(firstInvoker.getInterface()).willReturn(MenuService.class);</span>
<span class="hljs-addition">+    given(firstInvoker.invoke(invocation)).willReturn(new AppResponse());</span>
     given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "second"));
     given(secondInvoker.getInterface()).willReturn(MenuService.class);
     given(secondInvoker.invoke(invocation)).willReturn(new AppResponse());
     given(secondInvoker.isAvailable()).willReturn(true);
     given(directory.list(invocation)).willReturn(new ArrayList() {

</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    directory = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    firstInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    secondInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testGetMenuResultHasException</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// setup</span>

    url = url.addParameter(MERGER_KEY, <span class="hljs-string">".merge"</span>);

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"getMenu"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] {});

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] {});

    given(invocation.getObjectAttachments()).willReturn(<span class="hljs-keyword">new</span> HashMap&lt;&gt;());

    given(invocation.getInvoker()).willReturn(firstInvoker);

    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"first"</span>));

    given(firstInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(firstInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(firstInvoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"second"</span>));

    given(secondInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(secondInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(secondInvoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(directory.list(invocation)).willReturn(<span class="hljs-keyword">new</span> ArrayList() {



        {

            add(firstInvoker);

            add(secondInvoker);

        }

    });

    given(directory.getUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    mergeableClusterInvoker = <span class="hljs-keyword">new</span> MergeableClusterInvoker&lt;MenuService&gt;(directory);

    <span class="hljs-comment">// invoke</span>

    <span class="hljs-keyword">try</span> {

        Result result = mergeableClusterInvoker.invoke(invocation);

        fail();

        Assertions.assertNull(result.getValue());

    } <span class="hljs-keyword">catch</span> (RpcException expected) {

        Assertions.assertTrue(expected.getMessage().contains(<span class="hljs-string">"Failed to invoke service"</span>));

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4326">Test Case ID #dubbo_Test_43_26</h4>
<h4 id="test-case-name-testaddmenufile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportmergeableclusterinvokertestjava">Test Case Name: <code>testAddMenu</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\MergeableClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-secondinvoker">Mock Object Variable Name: <code>secondInvoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "first"));
    given(firstInvoker.getInterface()).willReturn(MenuService.class);
    given(firstInvoker.invoke(invocation)).willReturn(new AppResponse());
    given(firstInvoker.isAvailable()).willReturn(true);
<span class="hljs-deletion">-    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "second"));</span>
<span class="hljs-deletion">-    given(secondInvoker.getInterface()).willReturn(MenuService.class);</span>
<span class="hljs-deletion">-    given(secondInvoker.invoke(invocation)).willReturn(new AppResponse());</span>
<span class="hljs-deletion">-    given(secondInvoker.isAvailable()).willReturn(true);</span>
<span class="hljs-addition">+    secondInvoker = MockInvoker.createMockInvoker(true);</span>
<span class="hljs-addition">+    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "second"));</span>
<span class="hljs-addition">+    given(secondInvoker.getInterface()).willReturn(MenuService.class);</span>
<span class="hljs-addition">+    given(secondInvoker.invoke(invocation)).willReturn(new AppResponse());</span>
    given(directory.list(invocation)).willReturn(new ArrayList() {

</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAddMenu</span><span class="hljs-params">()</span> </span>{

    String menu = <span class="hljs-string">"first"</span>;

    List&lt;String&gt; menuItems = <span class="hljs-keyword">new</span> ArrayList&lt;String&gt;() {



        {

            add(<span class="hljs-string">"1"</span>);

            add(<span class="hljs-string">"2"</span>);

        }

    };

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"addMenu"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">List</span>.<span class="hljs-title">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { menu, menuItems });

    given(invocation.getObjectAttachments()).willReturn(<span class="hljs-keyword">new</span> HashMap&lt;&gt;());

    given(invocation.getInvoker()).willReturn(firstInvoker);

    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"first"</span>));

    given(firstInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(firstInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(firstInvoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"second"</span>));

    given(secondInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(secondInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(secondInvoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(directory.list(invocation)).willReturn(<span class="hljs-keyword">new</span> ArrayList() {



        {

            add(firstInvoker);

            add(secondInvoker);

        }

    });

    given(directory.getUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    mergeableClusterInvoker = <span class="hljs-keyword">new</span> MergeableClusterInvoker&lt;MenuService&gt;(directory);

    Result result = mergeableClusterInvoker.invoke(invocation);

    Assertions.assertNull(result.getValue());

}
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    directory = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    firstInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    secondInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4327">Test Case ID #dubbo_Test_43_27</h4>
<h4 id="test-case-name-testinvokertonoinvokeravailableexceptionfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportmergeableclusterinvokertestjava">Test Case Name: <code>testInvokerToNoInvokerAvailableException</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\MergeableClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-secondinvoker">Mock Object Variable Name: <code>secondInvoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- a/TestClass.java</span>
<span class="hljs-comment">+++ b/TestClass.java</span>
@@
    given(firstInvoker.invoke(invocation)).willThrow(new RpcException(RpcException.NO_INVOKER_AVAILABLE_AFTER_FILTER));
<span class="hljs-deletion">-    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "second"));</span>
<span class="hljs-deletion">-    given(secondInvoker.getInterface()).willReturn(MenuService.class);</span>
<span class="hljs-deletion">-    given(secondInvoker.invoke(invocation)).willReturn(new AppResponse());</span>
<span class="hljs-deletion">-    given(secondInvoker.isAvailable()).willReturn(true);</span>
<span class="hljs-deletion">-    given(secondInvoker.invoke(invocation)).willThrow(new RpcException(RpcException.NO_INVOKER_AVAILABLE_AFTER_FILTER));</span>
<span class="hljs-addition">+    secondInvoker = MockInvoker.createMockInvoker(true);</span>
<span class="hljs-addition">+    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "second"));</span>
<span class="hljs-addition">+    given(secondInvoker.getInterface()).willReturn(MenuService.class);</span>
<span class="hljs-addition">+    given(secondInvoker.invoke(invocation)).willReturn(new AppResponse());</span>
<span class="hljs-addition">+    given(secondInvoker.invoke(invocation)).willThrow(new RpcException(RpcException.NO_INVOKER_AVAILABLE_AFTER_FILTER));</span>
    given(directory.list(invocation)).willReturn(new ArrayList() {
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokerToNoInvokerAvailableException</span><span class="hljs-params">()</span> </span>{

    String menu = <span class="hljs-string">"first"</span>;

    List&lt;String&gt; menuItems = <span class="hljs-keyword">new</span> ArrayList&lt;String&gt;() {



        {

            add(<span class="hljs-string">"1"</span>);

            add(<span class="hljs-string">"2"</span>);

        }

    };

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"addMenu"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">List</span>.<span class="hljs-title">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { menu, menuItems });

    given(invocation.getObjectAttachments()).willReturn(<span class="hljs-keyword">new</span> HashMap&lt;&gt;());

    given(invocation.getInvoker()).willReturn(firstInvoker);

    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"first"</span>));

    given(firstInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(firstInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(firstInvoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(firstInvoker.invoke(invocation)).willThrow(<span class="hljs-keyword">new</span> RpcException(RpcException.NO_INVOKER_AVAILABLE_AFTER_FILTER));

    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"second"</span>));

    given(secondInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(secondInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(secondInvoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(secondInvoker.invoke(invocation)).willThrow(<span class="hljs-keyword">new</span> RpcException(RpcException.NO_INVOKER_AVAILABLE_AFTER_FILTER));

    given(directory.list(invocation)).willReturn(<span class="hljs-keyword">new</span> ArrayList() {



        {

            add(firstInvoker);

            add(secondInvoker);

        }

    });

    given(directory.getUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    mergeableClusterInvoker = <span class="hljs-keyword">new</span> MergeableClusterInvoker&lt;MenuService&gt;(directory);

    <span class="hljs-comment">// invoke</span>

    <span class="hljs-keyword">try</span> {

        Result result = mergeableClusterInvoker.invoke(invocation);

        fail();

        Assertions.assertNull(result.getValue());

    } <span class="hljs-keyword">catch</span> (RpcException expected) {

        assertEquals(expected.getCode(), RpcException.NO_INVOKER_AVAILABLE_AFTER_FILTER);

    }

}
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    directory = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    firstInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    secondInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4328">Test Case ID #dubbo_Test_43_28</h4>
<h4 id="test-case-name-testinvokertoexceptionfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportmergeableclusterinvokertestjava">Test Case Name: <code>testInvokerToException</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\MergeableClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-secondinvoker">Mock Object Variable Name: <code>secondInvoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    given(firstInvoker.invoke(invocation)).willReturn(new AppResponse());
    given(firstInvoker.isAvailable()).willReturn(true);
    given(firstInvoker.invoke(invocation)).willThrow(new RpcException(RpcException.NETWORK_EXCEPTION));
<span class="hljs-deletion">-    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "second"));</span>
<span class="hljs-deletion">-    given(secondInvoker.getInterface()).willReturn(MenuService.class);</span>
<span class="hljs-deletion">-    given(secondInvoker.invoke(invocation)).willReturn(new AppResponse());</span>
<span class="hljs-deletion">-    given(secondInvoker.isAvailable()).willReturn(true);</span>
<span class="hljs-deletion">-    given(secondInvoker.invoke(invocation)).willThrow(new RpcException(RpcException.NETWORK_EXCEPTION));</span>
<span class="hljs-addition">+    secondInvoker = MockInvoker.createMockInvoker(true);</span>
<span class="hljs-addition">+    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "second"));</span>
<span class="hljs-addition">+    given(secondInvoker.getInterface()).willReturn(MenuService.class);</span>
<span class="hljs-addition">+    given(secondInvoker.invoke(invocation)).willReturn(new AppResponse());</span>
<span class="hljs-addition">+    given(secondInvoker.invoke(invocation)).willThrow(new RpcException(RpcException.NETWORK_EXCEPTION));</span>
    given(directory.list(invocation)).willReturn(new ArrayList() {

</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    directory = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    firstInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    secondInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

}
<span class="hljs-comment">/**

 * test when network exception

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokerToException</span><span class="hljs-params">()</span> </span>{

    String menu = <span class="hljs-string">"first"</span>;

    List&lt;String&gt; menuItems = <span class="hljs-keyword">new</span> ArrayList&lt;String&gt;() {



        {

            add(<span class="hljs-string">"1"</span>);

            add(<span class="hljs-string">"2"</span>);

        }

    };

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"addMenu"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">List</span>.<span class="hljs-title">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { menu, menuItems });

    given(invocation.getObjectAttachments()).willReturn(<span class="hljs-keyword">new</span> HashMap&lt;&gt;());

    given(invocation.getInvoker()).willReturn(firstInvoker);

    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"first"</span>));

    given(firstInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(firstInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(firstInvoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(firstInvoker.invoke(invocation)).willThrow(<span class="hljs-keyword">new</span> RpcException(RpcException.NETWORK_EXCEPTION));

    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"second"</span>));

    given(secondInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(secondInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(secondInvoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(secondInvoker.invoke(invocation)).willThrow(<span class="hljs-keyword">new</span> RpcException(RpcException.NETWORK_EXCEPTION));

    given(directory.list(invocation)).willReturn(<span class="hljs-keyword">new</span> ArrayList() {



        {

            add(firstInvoker);

            add(secondInvoker);

        }

    });

    given(directory.getUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    mergeableClusterInvoker = <span class="hljs-keyword">new</span> MergeableClusterInvoker&lt;MenuService&gt;(directory);

    <span class="hljs-comment">// invoke</span>

    <span class="hljs-keyword">try</span> {

        Result result = mergeableClusterInvoker.invoke(invocation);

        fail();

        Assertions.assertNull(result.getValue());

    } <span class="hljs-keyword">catch</span> (RpcException expected) {

        assertEquals(expected.getCode(), RpcException.NETWORK_EXCEPTION);

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4329">Test Case ID #dubbo_Test_43_29</h4>
<h4 id="test-case-name-testgetmenuresulthasexceptionfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportmergeableclusterinvokertestjava">Test Case Name: <code>testGetMenuResultHasException</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\MergeableClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-secondinvoker">Mock Object Variable Name: <code>secondInvoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- a/TestClass.java</span>
<span class="hljs-comment">+++ b/TestClass.java</span>
@@
     given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "first"));
     given(firstInvoker.getInterface()).willReturn(MenuService.class);
     given(firstInvoker.invoke(invocation)).willReturn(new AppResponse());
     given(firstInvoker.isAvailable()).willReturn(true);
<span class="hljs-deletion">-    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "second"));</span>
<span class="hljs-deletion">-    given(secondInvoker.getInterface()).willReturn(MenuService.class);</span>
<span class="hljs-deletion">-    given(secondInvoker.invoke(invocation)).willReturn(new AppResponse());</span>
<span class="hljs-deletion">-    given(secondInvoker.isAvailable()).willReturn(true);</span>
<span class="hljs-addition">+    secondInvoker = MockInvoker.createMockInvoker(true);</span>
<span class="hljs-addition">+    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "second"));</span>
<span class="hljs-addition">+    given(secondInvoker.getInterface()).willReturn(MenuService.class);</span>
<span class="hljs-addition">+    given(secondInvoker.invoke(invocation)).willReturn(new AppResponse());</span>
     given(directory.list(invocation)).willReturn(new ArrayList() {

</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    directory = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    firstInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    secondInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testGetMenuResultHasException</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// setup</span>

    url = url.addParameter(MERGER_KEY, <span class="hljs-string">".merge"</span>);

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"getMenu"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] {});

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] {});

    given(invocation.getObjectAttachments()).willReturn(<span class="hljs-keyword">new</span> HashMap&lt;&gt;());

    given(invocation.getInvoker()).willReturn(firstInvoker);

    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"first"</span>));

    given(firstInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(firstInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(firstInvoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"second"</span>));

    given(secondInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(secondInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(secondInvoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(directory.list(invocation)).willReturn(<span class="hljs-keyword">new</span> ArrayList() {



        {

            add(firstInvoker);

            add(secondInvoker);

        }

    });

    given(directory.getUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    mergeableClusterInvoker = <span class="hljs-keyword">new</span> MergeableClusterInvoker&lt;MenuService&gt;(directory);

    <span class="hljs-comment">// invoke</span>

    <span class="hljs-keyword">try</span> {

        Result result = mergeableClusterInvoker.invoke(invocation);

        fail();

        Assertions.assertNull(result.getValue());

    } <span class="hljs-keyword">catch</span> (RpcException expected) {

        Assertions.assertTrue(expected.getMessage().contains(<span class="hljs-string">"Failed to invoke service"</span>));

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker and stubs isAvailable() to return the given value.
     *
     * <span class="hljs-doctag">@param</span> isAvailableReturn the value to return from isAvailable()
     * <span class="hljs-doctag">@return</span> the configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAvailableReturn)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.isAvailable()).thenReturn(isAvailableReturn);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci44">Mock Clone Instance #dubbo_MCI_44</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Invoker</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url, Invocation invocation, AppResponse appResponse)</span> </span>{
    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getUrl()).willReturn(url);
    given(invoker.invoke(invocation)).willReturn(appResponse);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest441">Test Case ID #dubbo_Test_44_1</h4>
<h4 id="test-case-name-testdestroyfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportmergeableclusterinvokertestjava">Test Case Name: <code>testDestroy</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\MergeableClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-secondinvoker">Mock Object Variable Name: <code>secondInvoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
     given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "first"));
     given(firstInvoker.getInterface()).willReturn(MenuService.class);
     given(firstInvoker.invoke(invocation)).willReturn(new AppResponse());
<span class="hljs-deletion">-    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "second"));</span>
<span class="hljs-deletion">-    given(secondInvoker.getInterface()).willReturn(MenuService.class);</span>
<span class="hljs-deletion">-    given(secondInvoker.invoke(invocation)).willReturn(new AppResponse());</span>
<span class="hljs-addition">+    secondInvoker = createMockInvoker(url.addParameter(GROUP_KEY, "second"), invocation, new AppResponse());</span>
     given(directory.list(invocation)).willReturn(new ArrayList() {

</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testDestroy</span><span class="hljs-params">()</span> </span>{

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"getMenu"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] {});

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] {});

    given(invocation.getObjectAttachments()).willReturn(<span class="hljs-keyword">new</span> HashMap&lt;&gt;());

    given(invocation.getInvoker()).willReturn(firstInvoker);

    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"first"</span>));

    given(firstInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(firstInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"second"</span>));

    given(secondInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(secondInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(directory.list(invocation)).willReturn(<span class="hljs-keyword">new</span> ArrayList() {



        {

            add(firstInvoker);

            add(secondInvoker);

        }

    });

    given(directory.getUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    mergeableClusterInvoker = <span class="hljs-keyword">new</span> MergeableClusterInvoker&lt;MenuService&gt;(directory);

    mergeableClusterInvoker.destroy();

    assertFalse(firstInvoker.isAvailable());

    assertFalse(secondInvoker.isAvailable());

}
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    directory = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    firstInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    secondInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url, Invocation invocation, AppResponse appResponse)</span> </span>{
    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getUrl()).willReturn(url);
    given(invoker.invoke(invocation)).willReturn(appResponse);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest442">Test Case ID #dubbo_Test_44_2</h4>
<h4 id="test-case-name-testdestroyfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportmergeableclusterinvokertestjava">Test Case Name: <code>testDestroy</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\MergeableClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-firstinvoker">Mock Object Variable Name: <code>firstInvoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- a/TestClass.java</span>
<span class="hljs-comment">+++ b/TestClass.java</span>
@@
    given(invocation.getObjectAttachments()).willReturn(new HashMap&lt;&gt;());
    given(invocation.getInvoker()).willReturn(firstInvoker);
<span class="hljs-deletion">-    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "first"));</span>
<span class="hljs-deletion">-    given(firstInvoker.getInterface()).willReturn(MenuService.class);</span>
<span class="hljs-deletion">-    given(firstInvoker.invoke(invocation)).willReturn(new AppResponse());</span>
<span class="hljs-addition">+    firstInvoker = createMockInvoker(url.addParameter(GROUP_KEY, "first"), invocation, new AppResponse());</span>
    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, "second"));
    given(secondInvoker.getInterface()).willReturn(MenuService.class);
    given(secondInvoker.invoke(invocation)).willReturn(new AppResponse());
    given(directory.list(invocation)).willReturn(new ArrayList() {

</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testDestroy</span><span class="hljs-params">()</span> </span>{

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"getMenu"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] {});

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] {});

    given(invocation.getObjectAttachments()).willReturn(<span class="hljs-keyword">new</span> HashMap&lt;&gt;());

    given(invocation.getInvoker()).willReturn(firstInvoker);

    given(firstInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"first"</span>));

    given(firstInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(firstInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(secondInvoker.getUrl()).willReturn(url.addParameter(GROUP_KEY, <span class="hljs-string">"second"</span>));

    given(secondInvoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(secondInvoker.invoke(invocation)).willReturn(<span class="hljs-keyword">new</span> AppResponse());

    given(directory.list(invocation)).willReturn(<span class="hljs-keyword">new</span> ArrayList() {



        {

            add(firstInvoker);

            add(secondInvoker);

        }

    });

    given(directory.getUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getConsumerUrl()).willReturn(url);

    given(directory.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    mergeableClusterInvoker = <span class="hljs-keyword">new</span> MergeableClusterInvoker&lt;MenuService&gt;(directory);

    mergeableClusterInvoker.destroy();

    assertFalse(firstInvoker.isAvailable());

    assertFalse(secondInvoker.isAvailable());

}
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    directory = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    firstInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    secondInvoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url, Invocation invocation, AppResponse appResponse)</span> </span>{
    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getInterface()).willReturn(MenuService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getUrl()).willReturn(url);
    given(invoker.invoke(invocation)).willReturn(appResponse);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci45">Mock Clone Instance #dubbo_MCI_45</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Invoker</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;Object&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker&lt;Object&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invoker.getUrl()).thenReturn(url);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest451">Test Case ID #dubbo_Test_45_1</h4>
<h4 id="test-case-name-testroutepathmatchfile-cjavaprojectsapachedubbodubbo-xdssrctestjavaorgapachedubborpcclusterrouterxdsxdsroutetestjava">Test Case Name: <code>testRoutePathMatch</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-xds\src\test\java\org\apache\dubbo\rpc\cluster\router\xds\XdsRouteTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Invocation invocation = Mockito.mock(Invocation.class);
<span class="hljs-deletion">-    Invoker invoker = Mockito.mock(Invoker.class);</span>
<span class="hljs-deletion">-    URL url1 = Mockito.mock(URL.class);</span>
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url1);</span>
<span class="hljs-addition">+    URL url1 = Mockito.mock(URL.class);</span>
<span class="hljs-addition">+    Invoker&lt;Object&gt; invoker = createMockInvoker(url1);</span>
    when(url1.getPath()).thenReturn("DemoInterface");
    when(invocation.getInvoker()).thenReturn(invoker);
    when(invocation.getMethodName()).thenReturn("call");
    Set&lt;Endpoint&gt; endpoints = new HashSet&lt;&gt;();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRoutePathMatch</span><span class="hljs-params">()</span> </span>{

    XdsRouter&lt;Object&gt; xdsRouter = <span class="hljs-keyword">new</span> XdsRouter&lt;&gt;(url, rdsRouteRuleManager, edsEndpointManager, <span class="hljs-keyword">true</span>);

    String appName = <span class="hljs-string">"app1"</span>;

    String cluster1 = <span class="hljs-string">"cluster-test1"</span>;

    Invoker&lt;Object&gt; invoker1 = createInvoker(appName, <span class="hljs-string">"1.1.1.1:20880"</span>);

    BitList&lt;Invoker&lt;Object&gt;&gt; invokers = <span class="hljs-keyword">new</span> BitList&lt;&gt;(Arrays.asList(invoker1, createInvoker(appName, <span class="hljs-string">"2.2.2.2:20880"</span>)));

    xdsRouter.notify(invokers);

    String path = <span class="hljs-string">"/DemoInterface/call"</span>;

    VirtualHost virtualHost = VirtualHost.newBuilder().addDomains(appName).addRoutes(Route.newBuilder().setName(<span class="hljs-string">"route-test"</span>).setMatch(RouteMatch.newBuilder().setPath(path).build()).setRoute(RouteAction.newBuilder().setCluster(cluster1).build()).build()).build();

    RdsVirtualHostListener hostListener = <span class="hljs-keyword">new</span> RdsVirtualHostListener(appName, rdsRouteRuleManager);

    hostListener.parseVirtualHost(virtualHost);

    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url1 = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.getUrl()).thenReturn(url1);

    when(url1.getPath()).thenReturn(<span class="hljs-string">"DemoInterface"</span>);

    when(invocation.getInvoker()).thenReturn(invoker);

    when(invocation.getMethodName()).thenReturn(<span class="hljs-string">"call"</span>);

    Set&lt;Endpoint&gt; endpoints = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    Endpoint endpoint1 = <span class="hljs-keyword">new</span> Endpoint();

    endpoint1.setAddress(<span class="hljs-string">"1.1.1.1"</span>);

    endpoint1.setPortValue(<span class="hljs-number">20880</span>);

    endpoints.add(endpoint1);

    edsEndpointManager.notifyEndpointChange(cluster1, endpoints);

    BitList&lt;Invoker&lt;Object&gt;&gt; routes = xdsRouter.route(invokers.clone(), <span class="hljs-keyword">null</span>, invocation, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);

    assertEquals(<span class="hljs-number">1</span>, routes.size());

    assertEquals(invoker1, routes.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;Object&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker&lt;Object&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invoker.getUrl()).thenReturn(url);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest452">Test Case ID #dubbo_Test_45_2</h4>
<h4 id="test-case-name-testroutemultiappfile-cjavaprojectsapachedubbodubbo-xdssrctestjavaorgapachedubborpcclusterrouterxdsxdsroutetestjava">Test Case Name: <code>testRouteMultiApp</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-xds\src\test\java\org\apache\dubbo\rpc\cluster\router\xds\XdsRouteTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Invocation invocation = Mockito.mock(Invocation.class);
<span class="hljs-deletion">-    Invoker invoker = Mockito.mock(Invoker.class);</span>
<span class="hljs-deletion">-    URL url1 = Mockito.mock(URL.class);</span>
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url1);</span>
<span class="hljs-addition">+    URL url1 = Mockito.mock(URL.class);</span>
<span class="hljs-addition">+    Invoker&lt;Object&gt; invoker = createMockInvoker(url1);</span>
    when(url1.getPath()).thenReturn("DemoInterface");
    when(invocation.getInvoker()).thenReturn(invoker);
    when(invocation.getMethodName()).thenReturn("call");
    Set&lt;Endpoint&gt; endpoints = new HashSet&lt;&gt;();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRouteMultiApp</span><span class="hljs-params">()</span> </span>{

    XdsRouter&lt;Object&gt; xdsRouter = <span class="hljs-keyword">new</span> XdsRouter&lt;&gt;(url, rdsRouteRuleManager, edsEndpointManager, <span class="hljs-keyword">true</span>);

    String appName1 = <span class="hljs-string">"app1"</span>;

    String appName2 = <span class="hljs-string">"app2"</span>;

    String cluster1 = <span class="hljs-string">"cluster-test1"</span>;

    Invoker&lt;Object&gt; invoker1 = createInvoker(appName2, <span class="hljs-string">"1.1.1.1:20880"</span>);

    Invoker&lt;Object&gt; invoker2 = createInvoker(appName1, <span class="hljs-string">"2.2.2.2:20880"</span>);

    BitList&lt;Invoker&lt;Object&gt;&gt; invokers = <span class="hljs-keyword">new</span> BitList&lt;&gt;(Arrays.asList(invoker1, invoker2));

    xdsRouter.notify(invokers);

    assertEquals(xdsRouter.getSubscribeApplications().size(), <span class="hljs-number">2</span>);

    String path = <span class="hljs-string">"/DemoInterface/call"</span>;

    VirtualHost virtualHost = VirtualHost.newBuilder().addDomains(appName2).addRoutes(Route.newBuilder().setName(<span class="hljs-string">"route-test"</span>).setMatch(RouteMatch.newBuilder().setPath(path).build()).setRoute(RouteAction.newBuilder().setCluster(cluster1).build()).build()).build();

    RdsVirtualHostListener hostListener = <span class="hljs-keyword">new</span> RdsVirtualHostListener(appName2, rdsRouteRuleManager);

    hostListener.parseVirtualHost(virtualHost);

    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url1 = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.getUrl()).thenReturn(url1);

    when(url1.getPath()).thenReturn(<span class="hljs-string">"DemoInterface"</span>);

    when(invocation.getInvoker()).thenReturn(invoker);

    when(invocation.getMethodName()).thenReturn(<span class="hljs-string">"call"</span>);

    Set&lt;Endpoint&gt; endpoints = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    Endpoint endpoint1 = <span class="hljs-keyword">new</span> Endpoint();

    endpoint1.setAddress(<span class="hljs-string">"1.1.1.1"</span>);

    endpoint1.setPortValue(<span class="hljs-number">20880</span>);

    endpoints.add(endpoint1);

    edsEndpointManager.notifyEndpointChange(cluster1, endpoints);

    BitList&lt;Invoker&lt;Object&gt;&gt; routes = xdsRouter.route(invokers.clone(), <span class="hljs-keyword">null</span>, invocation, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);

    assertEquals(<span class="hljs-number">1</span>, routes.size());

    assertEquals(invoker1, routes.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;Object&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker&lt;Object&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invoker.getUrl()).thenReturn(url);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci46">Mock Clone Instance #dubbo_MCI_46</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Invoker</code></li>
<li><strong>Test Case Count</strong>: 11</li>
<li><strong>MO Count</strong>: 11</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with shared stubbing for getInterface() and getUrl().
     *
     * <span class="hljs-doctag">@param</span> url the URL to be returned by getUrl()
     * <span class="hljs-doctag">@return</span> a configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getUrl()).willReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest461">Test Case ID #dubbo_Test_46_1</h4>
<h4 id="test-case-name-testinvokergenericfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltercompatiblefilterfiltertestjava">Test Case Name: <code>testInvokerGeneric</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\CompatibleFilterFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    invocation = mock(RpcInvocation.class);
    given(invocation.getMethodName()).willReturn("$enumlength");
    given(invocation.getParameterTypes()).willReturn(new Class&lt;?&gt;[] { Enum.class });
    given(invocation.getArguments()).willReturn(new Object[] { "hello" });
<span class="hljs-deletion">-    invoker = mock(Invoker.class);</span>
<span class="hljs-deletion">-    given(invoker.isAvailable()).willReturn(true);</span>
<span class="hljs-deletion">-    given(invoker.getInterface()).willReturn(DemoService.class);</span>
<span class="hljs-addition">+    URL url = URL.valueOf("test://test:11/test?group=dubbo&amp;version=1.1");</span>
<span class="hljs-addition">+    invoker = MockInvoker.createMockInvoker(url);</span>
<span class="hljs-addition">+    given(invoker.isAvailable()).willReturn(true);</span>
    AppResponse result = new AppResponse();
    result.setValue("High");
<span class="hljs-deletion">-    given(invoker.invoke(invocation)).willReturn(result);</span>
<span class="hljs-deletion">-    URL url = URL.valueOf("test://test:11/test?group=dubbo&amp;version=1.1");</span>
<span class="hljs-deletion">-    given(invoker.getUrl()).willReturn(url);</span>
<span class="hljs-addition">+    given(invoker.invoke(invocation)).willReturn(result);</span>
    Result filterResult = compatibleFilter.invoke(invoker, invocation);
    assertEquals(filterResult, result);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokerGeneric</span><span class="hljs-params">()</span> </span>{

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"$enumlength"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { Enum<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span> });

    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AppResponse result = <span class="hljs-keyword">new</span> AppResponse();

    result.setValue(<span class="hljs-string">"High"</span>);

    given(invoker.invoke(invocation)).willReturn(result);

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?group=dubbo&amp;version=1.1"</span>);

    given(invoker.getUrl()).willReturn(url);

    Result filterResult = compatibleFilter.invoke(invoker, invocation);

    assertEquals(filterResult, result);

}
<span class="hljs-meta">@AfterEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span> </span>{

    Mockito.reset(invocation, invoker);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with shared stubbing for getInterface() and getUrl().
     *
     * <span class="hljs-doctag">@param</span> url the URL to be returned by getUrl()
     * <span class="hljs-doctag">@return</span> a configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getUrl()).willReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest462">Test Case ID #dubbo_Test_46_2</h4>
<h4 id="test-case-name-testresulthasexceptionfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltercompatiblefilterfiltertestjava">Test Case Name: <code>testResultHasException</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\CompatibleFilterFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    invocation = mock(RpcInvocation.class);
    given(invocation.getMethodName()).willReturn("enumlength");
    given(invocation.getParameterTypes()).willReturn(new Class&lt;?&gt;[] { Enum.class });
    given(invocation.getArguments()).willReturn(new Object[] { "hello" });
<span class="hljs-deletion">-    invoker = mock(Invoker.class);</span>
<span class="hljs-deletion">-    given(invoker.isAvailable()).willReturn(true);</span>
<span class="hljs-deletion">-    given(invoker.getInterface()).willReturn(DemoService.class);</span>
    AppResponse result = new AppResponse();
    result.setException(new RuntimeException());
    result.setValue("High");
<span class="hljs-deletion">-    given(invoker.invoke(invocation)).willReturn(result);</span>
    URL url = URL.valueOf("test://test:11/test?group=dubbo&amp;version=1.1");
<span class="hljs-deletion">-    given(invoker.getUrl()).willReturn(url);</span>
<span class="hljs-addition">+    invoker = MockInvoker.createMockInvoker(url);</span>
<span class="hljs-addition">+    given(invoker.isAvailable()).willReturn(true);</span>
<span class="hljs-addition">+    given(invoker.invoke(invocation)).willReturn(result);</span>
    Result filterResult = compatibleFilter.invoke(invoker, invocation);
    assertEquals(filterResult, result);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testResultHasException</span><span class="hljs-params">()</span> </span>{

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"enumlength"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { Enum<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span> });

    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AppResponse result = <span class="hljs-keyword">new</span> AppResponse();

    result.setException(<span class="hljs-keyword">new</span> RuntimeException());

    result.setValue(<span class="hljs-string">"High"</span>);

    given(invoker.invoke(invocation)).willReturn(result);

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?group=dubbo&amp;version=1.1"</span>);

    given(invoker.getUrl()).willReturn(url);

    Result filterResult = compatibleFilter.invoke(invoker, invocation);

    assertEquals(filterResult, result);

}
<span class="hljs-meta">@AfterEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span> </span>{

    Mockito.reset(invocation, invoker);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with shared stubbing for getInterface() and getUrl().
     *
     * <span class="hljs-doctag">@param</span> url the URL to be returned by getUrl()
     * <span class="hljs-doctag">@return</span> a configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getUrl()).willReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest463">Test Case ID #dubbo_Test_46_3</h4>
<h4 id="test-case-name-testinvokerjsonpojoserializationfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltercompatiblefilterfiltertestjava">Test Case Name: <code>testInvokerJsonPojoSerialization</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\CompatibleFilterFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    given(invocation.getParameterTypes()).willReturn(new Class&lt;?&gt;[] { Type[].class });
    given(invocation.getArguments()).willReturn(new Object[] { "hello" });
<span class="hljs-deletion">-    invoker = mock(Invoker.class);</span>
<span class="hljs-deletion">-    given(invoker.isAvailable()).willReturn(true);</span>
<span class="hljs-deletion">-    given(invoker.getInterface()).willReturn(DemoService.class);</span>
    AppResponse result = new AppResponse();
    result.setValue("High");
    AsyncRpcResult defaultAsyncResult = AsyncRpcResult.newDefaultAsyncResult(result, invocation);
<span class="hljs-deletion">-    given(invoker.invoke(invocation)).willReturn(defaultAsyncResult);</span>
    URL url = URL.valueOf("test://test:11/test?group=dubbo&amp;version=1.1&amp;serialization=json");
<span class="hljs-deletion">-    given(invoker.getUrl()).willReturn(url);</span>
<span class="hljs-addition">+    invoker = MockInvoker.createMockInvoker(url);</span>
<span class="hljs-addition">+    given(invoker.isAvailable()).willReturn(true);</span>
<span class="hljs-addition">+    given(invoker.invoke(invocation)).willReturn(defaultAsyncResult);</span>
    Result asyncResult = compatibleFilter.invoke(invoker, invocation);
    AppResponse appResponse = (AppResponse) asyncResult.get();
    compatibleFilter.onResponse(appResponse, invoker, invocation);
    assertEquals(Type.High, appResponse.getValue());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokerJsonPojoSerialization</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"enumlength"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { Type[]<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span> });

    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AppResponse result = <span class="hljs-keyword">new</span> AppResponse();

    result.setValue(<span class="hljs-string">"High"</span>);

    AsyncRpcResult defaultAsyncResult = AsyncRpcResult.newDefaultAsyncResult(result, invocation);

    given(invoker.invoke(invocation)).willReturn(defaultAsyncResult);

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?group=dubbo&amp;version=1.1&amp;serialization=json"</span>);

    given(invoker.getUrl()).willReturn(url);

    Result asyncResult = compatibleFilter.invoke(invoker, invocation);

    AppResponse appResponse = (AppResponse) asyncResult.get();

    compatibleFilter.onResponse(appResponse, invoker, invocation);

    assertEquals(Type.High, appResponse.getValue());

}
<span class="hljs-meta">@AfterEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span> </span>{

    Mockito.reset(invocation, invoker);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with shared stubbing for getInterface() and getUrl().
     *
     * <span class="hljs-doctag">@param</span> url the URL to be returned by getUrl()
     * <span class="hljs-doctag">@return</span> a configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getUrl()).willReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest464">Test Case ID #dubbo_Test_46_4</h4>
<h4 id="test-case-name-testinvokernonjsonenumserializationfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltercompatiblefilterfiltertestjava">Test Case Name: <code>testInvokerNonJsonEnumSerialization</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\CompatibleFilterFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    given(invocation.getParameterTypes()).willReturn(new Class&lt;?&gt;[] { Type[].class });
    given(invocation.getArguments()).willReturn(new Object[] { "hello" });
<span class="hljs-deletion">-    invoker = mock(Invoker.class);</span>
<span class="hljs-deletion">-    given(invoker.isAvailable()).willReturn(true);</span>
<span class="hljs-deletion">-    given(invoker.getInterface()).willReturn(DemoService.class);</span>
    AppResponse result = new AppResponse();
    result.setValue("High");
    AsyncRpcResult defaultAsyncResult = AsyncRpcResult.newDefaultAsyncResult(result, invocation);
<span class="hljs-deletion">-    given(invoker.invoke(invocation)).willReturn(defaultAsyncResult);</span>
    URL url = URL.valueOf("test://test:11/test?group=dubbo&amp;version=1.1");
<span class="hljs-deletion">-    given(invoker.getUrl()).willReturn(url);</span>
<span class="hljs-addition">+    invoker = MockInvoker.createMockInvoker(url);</span>
<span class="hljs-addition">+    given(invoker.isAvailable()).willReturn(true);</span>
<span class="hljs-addition">+    given(invoker.invoke(invocation)).willReturn(defaultAsyncResult);</span>
    Result asyncResult = compatibleFilter.invoke(invoker, invocation);
    AppResponse appResponse = (AppResponse) asyncResult.get();
    compatibleFilter.onResponse(appResponse, invoker, invocation);
    assertEquals(Type.High, appResponse.getValue());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokerNonJsonEnumSerialization</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"enumlength"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { Type[]<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span> });

    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AppResponse result = <span class="hljs-keyword">new</span> AppResponse();

    result.setValue(<span class="hljs-string">"High"</span>);

    AsyncRpcResult defaultAsyncResult = AsyncRpcResult.newDefaultAsyncResult(result, invocation);

    given(invoker.invoke(invocation)).willReturn(defaultAsyncResult);

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?group=dubbo&amp;version=1.1"</span>);

    given(invoker.getUrl()).willReturn(url);

    Result asyncResult = compatibleFilter.invoke(invoker, invocation);

    AppResponse appResponse = (AppResponse) asyncResult.get();

    compatibleFilter.onResponse(appResponse, invoker, invocation);

    assertEquals(Type.High, appResponse.getValue());

}
<span class="hljs-meta">@AfterEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span> </span>{

    Mockito.reset(invocation, invoker);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with shared stubbing for getInterface() and getUrl().
     *
     * <span class="hljs-doctag">@param</span> url the URL to be returned by getUrl()
     * <span class="hljs-doctag">@return</span> a configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getUrl()).willReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest465">Test Case ID #dubbo_Test_46_5</h4>
<h4 id="test-case-name-testinvokernonjsonnonpojoserializationfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltercompatiblefilterfiltertestjava">Test Case Name: <code>testInvokerNonJsonNonPojoSerialization</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\CompatibleFilterFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    given(invocation.getParameterTypes()).willReturn(new Class&lt;?&gt;[] { String.class });
    given(invocation.getArguments()).willReturn(new Object[] { "hello" });
<span class="hljs-deletion">-    invoker = mock(Invoker.class);</span>
<span class="hljs-deletion">-    given(invoker.isAvailable()).willReturn(true);</span>
<span class="hljs-deletion">-    given(invoker.getInterface()).willReturn(DemoService.class);</span>
    AppResponse result = new AppResponse();
    result.setValue(new String[] { "High" });
<span class="hljs-deletion">-    given(invoker.invoke(invocation)).willReturn(result);</span>
    URL url = URL.valueOf("test://test:11/test?group=dubbo&amp;version=1.1");
<span class="hljs-deletion">-    given(invoker.getUrl()).willReturn(url);</span>
<span class="hljs-addition">+    invoker = MockInvoker.createMockInvoker(url);</span>
<span class="hljs-addition">+    given(invoker.isAvailable()).willReturn(true);</span>
<span class="hljs-addition">+    given(invoker.invoke(invocation)).willReturn(result);</span>
    Result filterResult = compatibleFilter.invoke(invoker, invocation);
    assertArrayEquals(new String[] { "High" }, (String[]) filterResult.getValue());
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokerNonJsonNonPojoSerialization</span><span class="hljs-params">()</span> </span>{

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"echo"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span> });

    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AppResponse result = <span class="hljs-keyword">new</span> AppResponse();

    result.setValue(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"High"</span> });

    given(invoker.invoke(invocation)).willReturn(result);

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?group=dubbo&amp;version=1.1"</span>);

    given(invoker.getUrl()).willReturn(url);

    Result filterResult = compatibleFilter.invoke(invoker, invocation);

    assertArrayEquals(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"High"</span> }, (String[]) filterResult.getValue());

}
<span class="hljs-meta">@AfterEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span> </span>{

    Mockito.reset(invocation, invoker);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with shared stubbing for getInterface() and getUrl().
     *
     * <span class="hljs-doctag">@param</span> url the URL to be returned by getUrl()
     * <span class="hljs-doctag">@return</span> a configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getUrl()).willReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest466">Test Case ID #dubbo_Test_46_6</h4>
<h4 id="test-case-name-testinvokernonjsonpojoserializationfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltercompatiblefilterfiltertestjava">Test Case Name: <code>testInvokerNonJsonPojoSerialization</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\CompatibleFilterFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     given(invocation.getParameterTypes()).willReturn(new Class&lt;?&gt;[] { String.class });
     given(invocation.getArguments()).willReturn(new Object[] { "hello" });
<span class="hljs-deletion">-    invoker = mock(Invoker.class);</span>
<span class="hljs-deletion">-    given(invoker.isAvailable()).willReturn(true);</span>
<span class="hljs-deletion">-    given(invoker.getInterface()).willReturn(DemoService.class);</span>
     AppResponse result = new AppResponse();
     result.setValue("hello");
<span class="hljs-deletion">-    given(invoker.invoke(invocation)).willReturn(result);</span>
     URL url = URL.valueOf("test://test:11/test?group=dubbo&amp;version=1.1");
<span class="hljs-deletion">-    given(invoker.getUrl()).willReturn(url);</span>
<span class="hljs-addition">+    invoker = MockInvoker.createMockInvoker(url);</span>
<span class="hljs-addition">+    given(invoker.isAvailable()).willReturn(true);</span>
<span class="hljs-addition">+    given(invoker.invoke(invocation)).willReturn(result);</span>
     Result filterResult = compatibleFilter.invoke(invoker, invocation);
     assertEquals("hello", filterResult.getValue());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokerNonJsonPojoSerialization</span><span class="hljs-params">()</span> </span>{

    invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invocation.getMethodName()).willReturn(<span class="hljs-string">"echo"</span>);

    given(invocation.getParameterTypes()).willReturn(<span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    given(invocation.getArguments()).willReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span> });

    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AppResponse result = <span class="hljs-keyword">new</span> AppResponse();

    result.setValue(<span class="hljs-string">"hello"</span>);

    given(invoker.invoke(invocation)).willReturn(result);

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?group=dubbo&amp;version=1.1"</span>);

    given(invoker.getUrl()).willReturn(url);

    Result filterResult = compatibleFilter.invoke(invoker, invocation);

    assertEquals(<span class="hljs-string">"hello"</span>, filterResult.getValue());

}
<span class="hljs-meta">@AfterEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span> </span>{

    Mockito.reset(invocation, invoker);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with shared stubbing for getInterface() and getUrl().
     *
     * <span class="hljs-doctag">@param</span> url the URL to be returned by getUrl()
     * <span class="hljs-doctag">@return</span> a configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getUrl()).willReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest467">Test Case ID #dubbo_Test_46_7</h4>
<h4 id="test-case-name-testinvokewithdefaultfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltergenericfiltertestjava">Test Case Name: <code>testInvokeWithDefault</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\GenericFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    URL url = URL.valueOf("test://test:11/org.apache.dubbo.rpc.support.DemoService?" + "accesslog=true&amp;group=dubbo&amp;version=1.1");
<span class="hljs-deletion">-    Invoker invoker = Mockito.mock(Invoker.class);</span>
<span class="hljs-deletion">-    when(invoker.invoke(any(Invocation.class))).thenReturn(AsyncRpcResult.newDefaultAsyncResult(new Person("person", 10), invocation));</span>
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
<span class="hljs-deletion">-    when(invoker.getInterface()).thenReturn(DemoService.class);</span>
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(url);</span>
<span class="hljs-addition">+    when(invoker.invoke(any(Invocation.class))).thenReturn(AsyncRpcResult.newDefaultAsyncResult(new Person("person", 10), invocation));</span>
    Result asyncResult = genericFilter.invoke(invoker, invocation);
    AppResponse appResponse = (AppResponse) asyncResult.get();
    genericFilter.onResponse(appResponse, invoker, invocation);
    Assertions.assertEquals(HashMap.class, appResponse.getValue().getClass());
    Assertions.assertEquals(10, ((HashMap) appResponse.getValue()).get("age"));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokeWithDefault</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Method genericInvoke = GenericService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getMethods</span>()[0]</span>;

    Map&lt;String, Object&gt; person = <span class="hljs-keyword">new</span> HashMap&lt;String, Object&gt;();

    person.put(<span class="hljs-string">"name"</span>, <span class="hljs-string">"dubbo"</span>);

    person.put(<span class="hljs-string">"age"</span>, <span class="hljs-number">10</span>);

    RpcInvocation invocation = <span class="hljs-keyword">new</span> RpcInvocation($INVOKE, GenericService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), "", <span class="hljs-title">genericInvoke</span>.<span class="hljs-title">getParameterTypes</span>(), <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[] </span>{ <span class="hljs-string">"getPerson"</span>, <span class="hljs-keyword">new</span> String[] { Person<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getCanonicalName</span>() }, <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[] </span>{ person } });

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/org.apache.dubbo.rpc.support.DemoService?"</span> + <span class="hljs-string">"accesslog=true&amp;group=dubbo&amp;version=1.1"</span>);

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">AsyncRpcResult</span>.<span class="hljs-title">newDefaultAsyncResult</span>(<span class="hljs-title">new</span> <span class="hljs-title">Person</span>("<span class="hljs-title">person</span>", 10), <span class="hljs-title">invocation</span>))</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result asyncResult = genericFilter.invoke(invoker, invocation);

    AppResponse appResponse = (AppResponse) asyncResult.get();

    genericFilter.onResponse(appResponse, invoker, invocation);

    Assertions.assertEquals(HashMap<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">appResponse</span>.<span class="hljs-title">getValue</span>().<span class="hljs-title">getClass</span>())</span>;

    Assertions.assertEquals(<span class="hljs-number">10</span>, ((HashMap) appResponse.getValue()).get(<span class="hljs-string">"age"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with shared stubbing for getInterface() and getUrl().
     *
     * <span class="hljs-doctag">@param</span> url the URL to be returned by getUrl()
     * <span class="hljs-doctag">@return</span> a configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getUrl()).willReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest468">Test Case ID #dubbo_Test_46_8</h4>
<h4 id="test-case-name-testinvokewithmethodnamtnotinvokefile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltergenericfiltertestjava">Test Case Name: <code>testInvokeWithMethodNamtNot$Invoke</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\GenericFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    URL url = URL.valueOf("test://test:11/org.apache.dubbo.rpc.support.DemoService?" + "accesslog=true&amp;group=dubbo&amp;version=1.1");
<span class="hljs-deletion">-    Invoker invoker = Mockito.mock(Invoker.class);</span>
<span class="hljs-deletion">-    when(invoker.invoke(any(Invocation.class))).thenReturn(new AppResponse(new Person("person", 10)));</span>
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
<span class="hljs-deletion">-    when(invoker.getInterface()).thenReturn(DemoService.class);</span>
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(url);</span>
<span class="hljs-addition">+    when(invoker.invoke(any(Invocation.class))).thenReturn(new AppResponse(new Person("person", 10)));</span>
    Result result = genericFilter.invoke(invoker, invocation);
    Assertions.assertEquals(Person.class, result.getValue().getClass());
    Assertions.assertEquals(10, ((Person) (result.getValue())).getAge());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-keyword">void</span> testInvokeWithMethodNamtNot$Invoke() {

    Method genericInvoke = GenericService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getMethods</span>()[0]</span>;

    Map&lt;String, Object&gt; person = <span class="hljs-keyword">new</span> HashMap&lt;String, Object&gt;();

    person.put(<span class="hljs-string">"name"</span>, <span class="hljs-string">"dubbo"</span>);

    person.put(<span class="hljs-string">"age"</span>, <span class="hljs-number">10</span>);

    RpcInvocation invocation = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"sayHi"</span>, GenericService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), "", <span class="hljs-title">genericInvoke</span>.<span class="hljs-title">getParameterTypes</span>(), <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[] </span>{ <span class="hljs-string">"getPerson"</span>, <span class="hljs-keyword">new</span> String[] { Person<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getCanonicalName</span>() }, <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[] </span>{ person } });

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/org.apache.dubbo.rpc.support.DemoService?"</span> + <span class="hljs-string">"accesslog=true&amp;group=dubbo&amp;version=1.1"</span>);

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">AppResponse</span>(<span class="hljs-title">new</span> <span class="hljs-title">Person</span>("<span class="hljs-title">person</span>", 10)))</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = genericFilter.invoke(invoker, invocation);

    Assertions.assertEquals(Person<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">result</span>.<span class="hljs-title">getValue</span>().<span class="hljs-title">getClass</span>())</span>;

    Assertions.assertEquals(<span class="hljs-number">10</span>, ((Person) (result.getValue())).getAge());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with shared stubbing for getInterface() and getUrl().
     *
     * <span class="hljs-doctag">@param</span> url the URL to be returned by getUrl()
     * <span class="hljs-doctag">@return</span> a configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getUrl()).willReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest469">Test Case ID #dubbo_Test_46_9</h4>
<h4 id="test-case-name-testinvokewithmethodargumentsizeisnot3file-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltergenericfiltertestjava">Test Case Name: <code>testInvokeWithMethodArgumentSizeIsNot3</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\GenericFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    URL url = URL.valueOf("test://test:11/org.apache.dubbo.rpc.support.DemoService?" + "accesslog=true&amp;group=dubbo&amp;version=1.1");
<span class="hljs-deletion">-    Invoker invoker = Mockito.mock(Invoker.class);</span>
<span class="hljs-deletion">-    when(invoker.invoke(any(Invocation.class))).thenReturn(new AppResponse(new Person("person", 10)));</span>
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
<span class="hljs-deletion">-    when(invoker.getInterface()).thenReturn(DemoService.class);</span>
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(url);</span>
<span class="hljs-addition">+    when(invoker.invoke(any(Invocation.class))).thenReturn(new AppResponse(new Person("person", 10)));</span>
    Result result = genericFilter.invoke(invoker, invocation);
    Assertions.assertEquals(Person.class, result.getValue().getClass());
    Assertions.assertEquals(10, ((Person) (result.getValue())).getAge());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokeWithMethodArgumentSizeIsNot3</span><span class="hljs-params">()</span> </span>{

    Method genericInvoke = GenericService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getMethods</span>()[0]</span>;

    Map&lt;String, Object&gt; person = <span class="hljs-keyword">new</span> HashMap&lt;String, Object&gt;();

    person.put(<span class="hljs-string">"name"</span>, <span class="hljs-string">"dubbo"</span>);

    person.put(<span class="hljs-string">"age"</span>, <span class="hljs-number">10</span>);

    RpcInvocation invocation = <span class="hljs-keyword">new</span> RpcInvocation($INVOKE, GenericService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), "", <span class="hljs-title">genericInvoke</span>.<span class="hljs-title">getParameterTypes</span>(), <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[] </span>{ <span class="hljs-string">"getPerson"</span>, <span class="hljs-keyword">new</span> String[] { Person<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getCanonicalName</span>() } })</span>;

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/org.apache.dubbo.rpc.support.DemoService?"</span> + <span class="hljs-string">"accesslog=true&amp;group=dubbo&amp;version=1.1"</span>);

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">AppResponse</span>(<span class="hljs-title">new</span> <span class="hljs-title">Person</span>("<span class="hljs-title">person</span>", 10)))</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = genericFilter.invoke(invoker, invocation);

    Assertions.assertEquals(Person<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">result</span>.<span class="hljs-title">getValue</span>().<span class="hljs-title">getClass</span>())</span>;

    Assertions.assertEquals(<span class="hljs-number">10</span>, ((Person) (result.getValue())).getAge());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with shared stubbing for getInterface() and getUrl().
     *
     * <span class="hljs-doctag">@param</span> url the URL to be returned by getUrl()
     * <span class="hljs-doctag">@return</span> a configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getUrl()).willReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4610">Test Case ID #dubbo_Test_46_10</h4>
<h4 id="test-case-name-testinvokefile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltergenericimplfiltertestjava">Test Case Name: <code>testInvoke</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\GenericImplFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    URL url = URL.valueOf("test://test:11/org.apache.dubbo.rpc.support.DemoService?" + "accesslog=true&amp;group=dubbo&amp;version=1.1&amp;generic=true");
<span class="hljs-deletion">-    Invoker invoker = Mockito.mock(Invoker.class);</span>
    Map&lt;String, Object&gt; person = new HashMap&lt;String, Object&gt;();
    person.put("name", "dubbo");
    person.put("age", 10);
    AppResponse mockRpcResult = new AppResponse(person);
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(url);</span>
    when(invoker.invoke(any(Invocation.class))).thenReturn(AsyncRpcResult.newDefaultAsyncResult(mockRpcResult, invocation));
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
<span class="hljs-deletion">-    when(invoker.getInterface()).thenReturn(DemoService.class);</span>
    Result asyncResult = genericImplFilter.invoke(invoker, invocation);
    Result result = asyncResult.get();
    genericImplFilter.onResponse(result, invoker, invocation);
    Assertions.assertEquals(Person.class, result.getValue().getClass());
    Assertions.assertEquals(10, ((Person) result.getValue()).getAge());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvoke</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    RpcInvocation invocation = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"getPerson"</span>, <span class="hljs-string">"org.apache.dubbo.rpc.support.DemoService"</span>, <span class="hljs-string">"org.apache.dubbo.rpc.support.DemoService:dubbo"</span>, <span class="hljs-keyword">new</span> Class[] { Person<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[] </span>{ <span class="hljs-keyword">new</span> Person(<span class="hljs-string">"dubbo"</span>, <span class="hljs-number">10</span>) });

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/org.apache.dubbo.rpc.support.DemoService?"</span> + <span class="hljs-string">"accesslog=true&amp;group=dubbo&amp;version=1.1&amp;generic=true"</span>);

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Map&lt;String, Object&gt; person = <span class="hljs-keyword">new</span> HashMap&lt;String, Object&gt;();

    person.put(<span class="hljs-string">"name"</span>, <span class="hljs-string">"dubbo"</span>);

    person.put(<span class="hljs-string">"age"</span>, <span class="hljs-number">10</span>);

    AppResponse mockRpcResult = <span class="hljs-keyword">new</span> AppResponse(person);

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">AsyncRpcResult</span>.<span class="hljs-title">newDefaultAsyncResult</span>(<span class="hljs-title">mockRpcResult</span>, <span class="hljs-title">invocation</span>))</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result asyncResult = genericImplFilter.invoke(invoker, invocation);

    Result result = asyncResult.get();

    genericImplFilter.onResponse(result, invoker, invocation);

    Assertions.assertEquals(Person<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">result</span>.<span class="hljs-title">getValue</span>().<span class="hljs-title">getClass</span>())</span>;

    Assertions.assertEquals(<span class="hljs-number">10</span>, ((Person) result.getValue()).getAge());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with shared stubbing for getInterface() and getUrl().
     *
     * <span class="hljs-doctag">@param</span> url the URL to be returned by getUrl()
     * <span class="hljs-doctag">@return</span> a configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getUrl()).willReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest4611">Test Case ID #dubbo_Test_46_11</h4>
<h4 id="test-case-name-testinvokewithexceptionfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltergenericimplfiltertestjava">Test Case Name: <code>testInvokeWithException</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\GenericImplFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    URL url = URL.valueOf("test://test:11/org.apache.dubbo.rpc.support.DemoService?" + "accesslog=true&amp;group=dubbo&amp;version=1.1&amp;generic=true");
<span class="hljs-deletion">-    Invoker invoker = Mockito.mock(Invoker.class);</span>
    AppResponse mockRpcResult = new AppResponse(new GenericException(new RuntimeException("failed")));
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(url);</span>
    when(invoker.invoke(any(Invocation.class))).thenReturn(AsyncRpcResult.newDefaultAsyncResult(mockRpcResult, invocation));
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
<span class="hljs-deletion">-    when(invoker.getInterface()).thenReturn(DemoService.class);</span>
    Result asyncResult = genericImplFilter.invoke(invoker, invocation);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokeWithException</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    RpcInvocation invocation = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"getPerson"</span>, <span class="hljs-string">"org.apache.dubbo.rpc.support.DemoService"</span>, <span class="hljs-string">"org.apache.dubbo.rpc.support.DemoService:dubbo"</span>, <span class="hljs-keyword">new</span> Class[] { Person<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[] </span>{ <span class="hljs-keyword">new</span> Person(<span class="hljs-string">"dubbo"</span>, <span class="hljs-number">10</span>) });

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/org.apache.dubbo.rpc.support.DemoService?"</span> + <span class="hljs-string">"accesslog=true&amp;group=dubbo&amp;version=1.1&amp;generic=true"</span>);

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AppResponse mockRpcResult = <span class="hljs-keyword">new</span> AppResponse(<span class="hljs-keyword">new</span> GenericException(<span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"failed"</span>)));

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">AsyncRpcResult</span>.<span class="hljs-title">newDefaultAsyncResult</span>(<span class="hljs-title">mockRpcResult</span>, <span class="hljs-title">invocation</span>))</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result asyncResult = genericImplFilter.invoke(invoker, invocation);

    Result result = asyncResult.get();

    genericImplFilter.onResponse(result, invoker, invocation);

    Assertions.assertEquals(RuntimeException<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">result</span>.<span class="hljs-title">getException</span>().<span class="hljs-title">getClass</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with shared stubbing for getInterface() and getUrl().
     *
     * <span class="hljs-doctag">@param</span> url the URL to be returned by getUrl()
     * <span class="hljs-doctag">@return</span> a configured mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getInterface()).willReturn(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        given(invoker.getUrl()).willReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci47">Mock Clone Instance #dubbo_MCI_47</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Invoker</code></li>
<li><strong>Test Case Count</strong>: 6</li>
<li><strong>MO Count</strong>: 6</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with getUrl() stubbed to return the provided URL.
     *
     * <span class="hljs-doctag">@param</span> url the URL to return from getUrl()
     * <span class="hljs-doctag">@return</span> a mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest471">Test Case ID #dubbo_Test_47_1</h4>
<h4 id="test-case-name-testinvokewithtokenfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltertokenfiltertestjava">Test Case Name: <code>testInvokeWithToken</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\TokenFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 void testInvokeWithToken() throws Exception {
     String token = "token";
<span class="hljs-deletion">-    Invoker invoker = Mockito.mock(Invoker.class);</span>
     URL url = URL.valueOf("test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1&amp;token=" + token);
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(url);</span>
     when(invoker.invoke(any(Invocation.class))).thenReturn(new AppResponse("result"));
     Invocation invocation = Mockito.mock(Invocation.class);
     when(invocation.getObjectAttachmentWithoutConvert(TOKEN_KEY)).thenReturn(token);
     Result result = tokenFilter.invoke(invoker, invocation);
     Assertions.assertEquals("result", result.getValue());
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokeWithToken</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String token = <span class="hljs-string">"token"</span>;

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1&amp;token="</span> + token);

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">AppResponse</span>("<span class="hljs-title">result</span>"))</span>;

    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getObjectAttachmentWithoutConvert(TOKEN_KEY)).thenReturn(token);

    Result result = tokenFilter.invoke(invoker, invocation);

    Assertions.assertEquals(<span class="hljs-string">"result"</span>, result.getValue());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with getUrl() stubbed to return the provided URL.
     *
     * <span class="hljs-doctag">@param</span> url the URL to return from getUrl()
     * <span class="hljs-doctag">@return</span> a mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest472">Test Case ID #dubbo_Test_47_2</h4>
<h4 id="test-case-name-testnoexecutelimitinvokefile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfilterexecutelimitfiltertestjava">Test Case Name: <code>testNoExecuteLimitInvoke</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\ExecuteLimitFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testNoExecuteLimitInvoke() {
<span class="hljs-deletion">-    Invoker invoker = Mockito.mock(Invoker.class);</span>
<span class="hljs-deletion">-    when(invoker.invoke(any(Invocation.class))).thenReturn(new AppResponse("result"));</span>
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(URL.valueOf("test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1"));</span>
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(URL.valueOf("test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1"));</span>
<span class="hljs-addition">+    when(invoker.invoke(any(Invocation.class))).thenReturn(new AppResponse("result"));</span>
    Invocation invocation = Mockito.mock(Invocation.class);
    when(invocation.getMethodName()).thenReturn("testNoExecuteLimitInvoke");
    Result result = executeLimitFilter.invoke(invoker, invocation);
    Assertions.assertEquals("result", result.getValue());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testNoExecuteLimitInvoke</span><span class="hljs-params">()</span> </span>{

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">AppResponse</span>("<span class="hljs-title">result</span>"))</span>;

    when(invoker.getUrl()).thenReturn(URL.valueOf(<span class="hljs-string">"test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1"</span>));

    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getMethodName()).thenReturn(<span class="hljs-string">"testNoExecuteLimitInvoke"</span>);

    Result result = executeLimitFilter.invoke(invoker, invocation);

    Assertions.assertEquals(<span class="hljs-string">"result"</span>, result.getValue());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with getUrl() stubbed to return the provided URL.
     *
     * <span class="hljs-doctag">@param</span> url the URL to return from getUrl()
     * <span class="hljs-doctag">@return</span> a mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest473">Test Case ID #dubbo_Test_47_3</h4>
<h4 id="test-case-name-testexecutelimitinvokefile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfilterexecutelimitfiltertestjava">Test Case Name: <code>testExecuteLimitInvoke</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\ExecuteLimitFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testExecuteLimitInvoke() {
<span class="hljs-deletion">-    Invoker invoker = Mockito.mock(Invoker.class);</span>
<span class="hljs-deletion">-    when(invoker.invoke(any(Invocation.class))).thenReturn(new AppResponse("result"));</span>
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(URL.valueOf("test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1&amp;executes=10"));</span>
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(URL.valueOf("test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1&amp;executes=10"));</span>
<span class="hljs-addition">+    when(invoker.invoke(any(Invocation.class))).thenReturn(new AppResponse("result"));</span>
    Invocation invocation = Mockito.mock(Invocation.class);
    when(invocation.getMethodName()).thenReturn("testExecuteLimitInvoke");
    Result result = executeLimitFilter.invoke(invoker, invocation);
    Assertions.assertEquals("result", result.getValue());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testExecuteLimitInvoke</span><span class="hljs-params">()</span> </span>{

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">AppResponse</span>("<span class="hljs-title">result</span>"))</span>;

    when(invoker.getUrl()).thenReturn(URL.valueOf(<span class="hljs-string">"test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1&amp;executes=10"</span>));

    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getMethodName()).thenReturn(<span class="hljs-string">"testExecuteLimitInvoke"</span>);

    Result result = executeLimitFilter.invoke(invoker, invocation);

    Assertions.assertEquals(<span class="hljs-string">"result"</span>, result.getValue());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with getUrl() stubbed to return the provided URL.
     *
     * <span class="hljs-doctag">@param</span> url the URL to return from getUrl()
     * <span class="hljs-doctag">@return</span> a mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest474">Test Case ID #dubbo_Test_47_4</h4>
<h4 id="test-case-name-testexecutelimitinvokewithexceptionfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfilterexecutelimitfiltertestjava">Test Case Name: <code>testExecuteLimitInvokeWithException</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\ExecuteLimitFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testExecuteLimitInvokeWithException() {
<span class="hljs-deletion">-    Invoker invoker = Mockito.mock(Invoker.class);</span>
<span class="hljs-deletion">-    doThrow(new RpcException()).when(invoker).invoke(any(Invocation.class));</span>
    URL url = URL.valueOf("test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1&amp;executes=10");
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(url);</span>
<span class="hljs-addition">+    doThrow(new RpcException()).when(invoker).invoke(any(Invocation.class));</span>
    Invocation invocation = Mockito.mock(Invocation.class);
    when(invocation.getMethodName()).thenReturn("testExecuteLimitInvokeWitException");
    try {
        executeLimitFilter.invoke(invoker, invocation);
    } catch (Exception e) {
        Assertions.assertTrue(e instanceof RpcException);
        executeLimitFilter.onError(e, invoker, invocation);
    }
    Assertions.assertEquals(1, RpcStatus.getStatus(url, invocation.getMethodName()).getFailed());
    RpcStatus.removeStatus(url, invocation.getMethodName());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testExecuteLimitInvokeWithException</span><span class="hljs-params">()</span> </span>{

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    doThrow(<span class="hljs-keyword">new</span> RpcException()).when(invoker).invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1&amp;executes=10"</span>);

    when(invoker.getUrl()).thenReturn(url);

    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getMethodName()).thenReturn(<span class="hljs-string">"testExecuteLimitInvokeWitException"</span>);

    <span class="hljs-keyword">try</span> {

        executeLimitFilter.invoke(invoker, invocation);

    } <span class="hljs-keyword">catch</span> (Exception e) {

        Assertions.assertTrue(e <span class="hljs-keyword">instanceof</span> RpcException);

        executeLimitFilter.onError(e, invoker, invocation);

    }

    Assertions.assertEquals(<span class="hljs-number">1</span>, RpcStatus.getStatus(url, invocation.getMethodName()).getFailed());

    RpcStatus.removeStatus(url, invocation.getMethodName());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with getUrl() stubbed to return the provided URL.
     *
     * <span class="hljs-doctag">@param</span> url the URL to return from getUrl()
     * <span class="hljs-doctag">@return</span> a mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest475">Test Case ID #dubbo_Test_47_5</h4>
<h4 id="test-case-name-testinvokewithinvokefile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltergenericimplfiltertestjava">Test Case Name: <code>testInvokeWith$Invoke</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\GenericImplFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    URL url = URL.valueOf("test://test:11/org.apache.dubbo.rpc.support.DemoService?" + "accesslog=true&amp;group=dubbo&amp;version=1.1&amp;generic=true");
<span class="hljs-deletion">-    Invoker invoker = Mockito.mock(Invoker.class);</span>
<span class="hljs-deletion">-    when(invoker.invoke(any(Invocation.class))).thenReturn(new AppResponse(new Person("person", 10)));</span>
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(url);</span>
<span class="hljs-addition">+    when(invoker.invoke(any(Invocation.class))).thenReturn(new AppResponse(new Person("person", 10)));</span>
    genericImplFilter.invoke(invoker, invocation);
    Assertions.assertEquals("true", invocation.getAttachment(GENERIC_KEY));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-keyword">void</span> testInvokeWith$Invoke() <span class="hljs-keyword">throws</span> Exception {

    Method genericInvoke = GenericService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getMethods</span>()[0]</span>;

    Map&lt;String, Object&gt; person = <span class="hljs-keyword">new</span> HashMap&lt;String, Object&gt;();

    person.put(<span class="hljs-string">"name"</span>, <span class="hljs-string">"dubbo"</span>);

    person.put(<span class="hljs-string">"age"</span>, <span class="hljs-number">10</span>);

    RpcInvocation invocation = <span class="hljs-keyword">new</span> RpcInvocation($INVOKE, GenericService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), "<span class="hljs-title">org</span>.<span class="hljs-title">apache</span>.<span class="hljs-title">dubbo</span>.<span class="hljs-title">rpc</span>.<span class="hljs-title">support</span>.<span class="hljs-title">DemoService</span>:<span class="hljs-title">dubbo</span>", <span class="hljs-title">genericInvoke</span>.<span class="hljs-title">getParameterTypes</span>(), <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[] </span>{ <span class="hljs-string">"getPerson"</span>, <span class="hljs-keyword">new</span> String[] { Person<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getCanonicalName</span>() }, <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[] </span>{ person } });

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/org.apache.dubbo.rpc.support.DemoService?"</span> + <span class="hljs-string">"accesslog=true&amp;group=dubbo&amp;version=1.1&amp;generic=true"</span>);

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">AppResponse</span>(<span class="hljs-title">new</span> <span class="hljs-title">Person</span>("<span class="hljs-title">person</span>", 10)))</span>;

    when(invoker.getUrl()).thenReturn(url);

    genericImplFilter.invoke(invoker, invocation);

    Assertions.assertEquals(<span class="hljs-string">"true"</span>, invocation.getAttachment(GENERIC_KEY));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with getUrl() stubbed to return the provided URL.
     *
     * <span class="hljs-doctag">@param</span> url the URL to return from getUrl()
     * <span class="hljs-doctag">@return</span> a mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest476">Test Case ID #dubbo_Test_47_6</h4>
<h4 id="test-case-name-testinvokewithouttimeoutfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcfiltertimeoutfiltertestjava">Test Case Name: <code>testInvokeWithoutTimeout</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\filter\TimeoutFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testInvokeWithoutTimeout() {
    int timeout = 3000;
<span class="hljs-deletion">-    Invoker invoker = Mockito.mock(Invoker.class);</span>
<span class="hljs-deletion">-    when(invoker.invoke(any(Invocation.class))).thenReturn(new AppResponse("result"));</span>
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(URL.valueOf("test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1&amp;timeout=" + timeout));</span>
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(URL.valueOf("test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1&amp;timeout=" + timeout));</span>
<span class="hljs-addition">+    when(invoker.invoke(any(Invocation.class))).thenReturn(new AppResponse("result"));</span>
    Invocation invocation = Mockito.mock(Invocation.class);
    when(invocation.getMethodName()).thenReturn("testInvokeWithoutTimeout");
    Result result = timeoutFilter.invoke(invoker, invocation);
    Assertions.assertEquals("result", result.getValue());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokeWithoutTimeout</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">int</span> timeout = <span class="hljs-number">3000</span>;

    Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">AppResponse</span>("<span class="hljs-title">result</span>"))</span>;

    when(invoker.getUrl()).thenReturn(URL.valueOf(<span class="hljs-string">"test://test:11/test?accesslog=true&amp;group=dubbo&amp;version=1.1&amp;timeout="</span> + timeout));

    Invocation invocation = Mockito.mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getMethodName()).thenReturn(<span class="hljs-string">"testInvokeWithoutTimeout"</span>);

    Result result = timeoutFilter.invoke(invoker, invocation);

    Assertions.assertEquals(<span class="hljs-string">"result"</span>, result.getValue());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock Invoker with getUrl() stubbed to return the provided URL.
     *
     * <span class="hljs-doctag">@param</span> url the URL to return from getUrl()
     * <span class="hljs-doctag">@return</span> a mock Invoker
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci48">Mock Clone Instance #dubbo_MCI_48</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Invoker</code></li>
<li><strong>Test Case Count</strong>: 5</li>
<li><strong>MO Count</strong>: 5</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">()</span> </span>{
    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"test://127.0.0.1:1/org.apache.dubbo.rpc.support.DemoService?interface=org.apache.dubbo.rpc.support.DemoService"</span>));
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest481">Test Case ID #dubbo_Test_48_1</h4>
<h4 id="test-case-name-testgetreturntypefile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcsupportrpcutilstestjava">Test Case Name: <code>testGetReturnType</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\support\RpcUtilsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     Class&lt;?&gt; demoServiceClass = DemoService.class;
     String serviceName = demoServiceClass.getName();
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
<span class="hljs-deletion">-    given(invoker.getUrl()).willReturn(URL.valueOf("test://127.0.0.1:1/org.apache.dubbo.rpc.support.DemoService?interface=org.apache.dubbo.rpc.support.DemoService"));</span>
<span class="hljs-addition">+    Invoker invoker = createMockInvoker();</span>
     // void sayHello(String name);
     RpcInvocation inv = new RpcInvocation("sayHello", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
     Class&lt;?&gt; returnType = RpcUtils.getReturnType(inv);
     Assertions.assertNull(returnType);
     //String echo(String text);
     RpcInvocation inv1 = new RpcInvocation("echo", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
     Class&lt;?&gt; returnType1 = RpcUtils.getReturnType(inv1);
     Assertions.assertNotNull(returnType1);
     Assertions.assertEquals(String.class, returnType1);
     //int getSize(String[] strs);
     RpcInvocation inv2 = new RpcInvocation("getSize", serviceName, "", new Class&lt;?&gt;[] { String[].class }, null, null, invoker, null);
     Class&lt;?&gt; returnType2 = RpcUtils.getReturnType(inv2);
     Assertions.assertNotNull(returnType2);
     Assertions.assertEquals(int.class, returnType2);
     //Person getPerson(Person person);
     RpcInvocation inv3 = new RpcInvocation("getPerson", serviceName, "", new Class&lt;?&gt;[] { Person.class }, null, null, invoker, null);
     Class&lt;?&gt; returnType3 = RpcUtils.getReturnType(inv3);
     Assertions.assertNotNull(returnType3);
     Assertions.assertEquals(Person.class, returnType3);
     //List&lt;String&gt; testReturnType1(String str);
     RpcInvocation inv4 = new RpcInvocation("testReturnType1", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
     Class&lt;?&gt; returnType4 = RpcUtils.getReturnType(inv4);
     Assertions.assertNotNull(returnType4);
     Assertions.assertEquals(List.class, returnType4);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testGetReturnType</span><span class="hljs-params">()</span> </span>{

    Class&lt;?&gt; demoServiceClass = DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span></span>;

    String serviceName = demoServiceClass.getName();

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"test://127.0.0.1:1/org.apache.dubbo.rpc.support.DemoService?interface=org.apache.dubbo.rpc.support.DemoService"</span>));

    <span class="hljs-comment">// void sayHello(String name);</span>

    RpcInvocation inv = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"sayHello"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    Class&lt;?&gt; returnType = RpcUtils.getReturnType(inv);

    Assertions.assertNull(returnType);

    <span class="hljs-comment">//String echo(String text);</span>

    RpcInvocation inv1 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"echo"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    Class&lt;?&gt; returnType1 = RpcUtils.getReturnType(inv1);

    Assertions.assertNotNull(returnType1);

    Assertions.assertEquals(String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">returnType1</span>)</span>;

    <span class="hljs-comment">//int getSize(String[] strs);</span>

    RpcInvocation inv2 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"getSize"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String[]<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    Class&lt;?&gt; returnType2 = RpcUtils.getReturnType(inv2);

    Assertions.assertNotNull(returnType2);

    Assertions.assertEquals(<span class="hljs-keyword">int</span><span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">returnType2</span>)</span>;

    <span class="hljs-comment">//Person getPerson(Person person);</span>

    RpcInvocation inv3 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"getPerson"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { Person<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    Class&lt;?&gt; returnType3 = RpcUtils.getReturnType(inv3);

    Assertions.assertNotNull(returnType3);

    Assertions.assertEquals(Person<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">returnType3</span>)</span>;

    <span class="hljs-comment">//List&lt;String&gt; testReturnType1(String str);</span>

    RpcInvocation inv4 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType1"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    Class&lt;?&gt; returnType4 = RpcUtils.getReturnType(inv4);

    Assertions.assertNotNull(returnType4);

    Assertions.assertEquals(List<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">returnType4</span>)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">()</span> </span>{
    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"test://127.0.0.1:1/org.apache.dubbo.rpc.support.DemoService?interface=org.apache.dubbo.rpc.support.DemoService"</span>));
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest482">Test Case ID #dubbo_Test_48_2</h4>
<h4 id="test-case-name-testgetreturntypesusecachefile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcsupportrpcutilstestjava">Test Case Name: <code>testGetReturnTypesUseCache</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\support\RpcUtilsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Class&lt;?&gt; demoServiceClass = DemoService.class;
    String serviceName = demoServiceClass.getName();
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
<span class="hljs-deletion">-    given(invoker.getUrl()).willReturn(URL.valueOf("test://127.0.0.1:1/org.apache.dubbo.rpc.support.DemoService?interface=org.apache.dubbo.rpc.support.DemoService"));</span>
<span class="hljs-addition">+    Invoker invoker = createMockInvoker();</span>
    RpcInvocation inv = new RpcInvocation("testReturnType", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    Type[] types = RpcUtils.getReturnTypes(inv);
    Assertions.assertNotNull(types);
    Assertions.assertEquals(2, types.length);
    Assertions.assertEquals(String.class, types[0]);
    Assertions.assertEquals(String.class, types[1]);
    Assertions.assertArrayEquals(types, inv.getReturnTypes());
    RpcInvocation inv1 = new RpcInvocation("testReturnType1", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    java.lang.reflect.Type[] types1 = RpcUtils.getReturnTypes(inv1);
    Assertions.assertNotNull(types1);
    Assertions.assertEquals(2, types1.length);
    Assertions.assertEquals(List.class, types1[0]);
    Assertions.assertEquals(demoServiceClass.getMethod("testReturnType1", String.class).getGenericReturnType(), types1[1]);
    Assertions.assertArrayEquals(types1, inv1.getReturnTypes());
    RpcInvocation inv2 = new RpcInvocation("testReturnType2", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    java.lang.reflect.Type[] types2 = RpcUtils.getReturnTypes(inv2);
    Assertions.assertNotNull(types2);
    Assertions.assertEquals(2, types2.length);
    Assertions.assertEquals(String.class, types2[0]);
    Assertions.assertEquals(String.class, types2[1]);
    Assertions.assertArrayEquals(types2, inv2.getReturnTypes());
    RpcInvocation inv3 = new RpcInvocation("testReturnType3", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    java.lang.reflect.Type[] types3 = RpcUtils.getReturnTypes(inv3);
    Assertions.assertNotNull(types3);
    Assertions.assertEquals(2, types3.length);
    Assertions.assertEquals(List.class, types3[0]);
    java.lang.reflect.Type genericReturnType3 = demoServiceClass.getMethod("testReturnType3", String.class).getGenericReturnType();
    Assertions.assertEquals(((ParameterizedType) genericReturnType3).getActualTypeArguments()[0], types3[1]);
    Assertions.assertArrayEquals(types3, inv3.getReturnTypes());
    RpcInvocation inv4 = new RpcInvocation("testReturnType4", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    java.lang.reflect.Type[] types4 = RpcUtils.getReturnTypes(inv4);
    Assertions.assertNotNull(types4);
    Assertions.assertEquals(2, types4.length);
    Assertions.assertNull(types4[0]);
    Assertions.assertNull(types4[1]);
    Assertions.assertArrayEquals(types4, inv4.getReturnTypes());
    RpcInvocation inv5 = new RpcInvocation("testReturnType5", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    java.lang.reflect.Type[] types5 = RpcUtils.getReturnTypes(inv5);
    Assertions.assertNotNull(types5);
    Assertions.assertEquals(2, types5.length);
    Assertions.assertEquals(Map.class, types5[0]);
    java.lang.reflect.Type genericReturnType5 = demoServiceClass.getMethod("testReturnType5", String.class).getGenericReturnType();
    Assertions.assertEquals(((ParameterizedType) genericReturnType5).getActualTypeArguments()[0], types5[1]);
    Assertions.assertArrayEquals(types5, inv5.getReturnTypes());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testGetReturnTypesUseCache</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Class&lt;?&gt; demoServiceClass = DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span></span>;

    String serviceName = demoServiceClass.getName();

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"test://127.0.0.1:1/org.apache.dubbo.rpc.support.DemoService?interface=org.apache.dubbo.rpc.support.DemoService"</span>));

    RpcInvocation inv = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    Type[] types = RpcUtils.getReturnTypes(inv);

    Assertions.assertNotNull(types);

    Assertions.assertEquals(<span class="hljs-number">2</span>, types.length);

    Assertions.assertEquals(String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">types</span>[0])</span>;

    Assertions.assertEquals(String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">types</span>[1])</span>;

    Assertions.assertArrayEquals(types, inv.getReturnTypes());

    RpcInvocation inv1 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType1"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    java.lang.reflect.Type[] types1 = RpcUtils.getReturnTypes(inv1);

    Assertions.assertNotNull(types1);

    Assertions.assertEquals(<span class="hljs-number">2</span>, types1.length);

    Assertions.assertEquals(List<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">types1</span>[0])</span>;

    Assertions.assertEquals(demoServiceClass.getMethod(<span class="hljs-string">"testReturnType1"</span>, String<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">getGenericReturnType</span>(), <span class="hljs-title">types1</span>[1])</span>;

    Assertions.assertArrayEquals(types1, inv1.getReturnTypes());

    RpcInvocation inv2 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType2"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    java.lang.reflect.Type[] types2 = RpcUtils.getReturnTypes(inv2);

    Assertions.assertNotNull(types2);

    Assertions.assertEquals(<span class="hljs-number">2</span>, types2.length);

    Assertions.assertEquals(String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">types2</span>[0])</span>;

    Assertions.assertEquals(String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">types2</span>[1])</span>;

    Assertions.assertArrayEquals(types2, inv2.getReturnTypes());

    RpcInvocation inv3 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType3"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    java.lang.reflect.Type[] types3 = RpcUtils.getReturnTypes(inv3);

    Assertions.assertNotNull(types3);

    Assertions.assertEquals(<span class="hljs-number">2</span>, types3.length);

    Assertions.assertEquals(List<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">types3</span>[0])</span>;

    java.lang.reflect.Type genericReturnType3 = demoServiceClass.getMethod(<span class="hljs-string">"testReturnType3"</span>, String<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">getGenericReturnType</span>()</span>;

    Assertions.assertEquals(((ParameterizedType) genericReturnType3).getActualTypeArguments()[<span class="hljs-number">0</span>], types3[<span class="hljs-number">1</span>]);

    Assertions.assertArrayEquals(types3, inv3.getReturnTypes());

    RpcInvocation inv4 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType4"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    java.lang.reflect.Type[] types4 = RpcUtils.getReturnTypes(inv4);

    Assertions.assertNotNull(types4);

    Assertions.assertEquals(<span class="hljs-number">2</span>, types4.length);

    Assertions.assertNull(types4[<span class="hljs-number">0</span>]);

    Assertions.assertNull(types4[<span class="hljs-number">1</span>]);

    Assertions.assertArrayEquals(types4, inv4.getReturnTypes());

    RpcInvocation inv5 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType5"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    java.lang.reflect.Type[] types5 = RpcUtils.getReturnTypes(inv5);

    Assertions.assertNotNull(types5);

    Assertions.assertEquals(<span class="hljs-number">2</span>, types5.length);

    Assertions.assertEquals(Map<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">types5</span>[0])</span>;

    java.lang.reflect.Type genericReturnType5 = demoServiceClass.getMethod(<span class="hljs-string">"testReturnType5"</span>, String<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">getGenericReturnType</span>()</span>;

    Assertions.assertEquals(((ParameterizedType) genericReturnType5).getActualTypeArguments()[<span class="hljs-number">0</span>], types5[<span class="hljs-number">1</span>]);

    Assertions.assertArrayEquals(types5, inv5.getReturnTypes());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">()</span> </span>{
    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"test://127.0.0.1:1/org.apache.dubbo.rpc.support.DemoService?interface=org.apache.dubbo.rpc.support.DemoService"</span>));
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest483">Test Case ID #dubbo_Test_48_3</h4>
<h4 id="test-case-name-testgetreturntypeswithoutcachefile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcsupportrpcutilstestjava">Test Case Name: <code>testGetReturnTypesWithoutCache</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\support\RpcUtilsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Class&lt;?&gt; demoServiceClass = DemoService.class;
    String serviceName = demoServiceClass.getName();
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
<span class="hljs-deletion">-    given(invoker.getUrl()).willReturn(URL.valueOf("test://127.0.0.1:1/org.apache.dubbo.rpc.support.DemoService?interface=org.apache.dubbo.rpc.support.DemoService"));</span>
<span class="hljs-addition">+    Invoker invoker = createMockInvoker();</span>
    RpcInvocation inv = new RpcInvocation("testReturnType", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    inv.setReturnTypes(null);
    Type[] types = RpcUtils.getReturnTypes(inv);
    Assertions.assertNotNull(types);
    Assertions.assertEquals(2, types.length);
    Assertions.assertEquals(String.class, types[0]);
    Assertions.assertEquals(String.class, types[1]);
    RpcInvocation inv1 = new RpcInvocation("testReturnType1", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    inv1.setReturnTypes(null);
    java.lang.reflect.Type[] types1 = RpcUtils.getReturnTypes(inv1);
    Assertions.assertNotNull(types1);
    Assertions.assertEquals(2, types1.length);
    Assertions.assertEquals(List.class, types1[0]);
    Assertions.assertEquals(demoServiceClass.getMethod("testReturnType1", String.class).getGenericReturnType(), types1[1]);
    RpcInvocation inv2 = new RpcInvocation("testReturnType2", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    inv2.setReturnTypes(null);
    java.lang.reflect.Type[] types2 = RpcUtils.getReturnTypes(inv2);
    Assertions.assertNotNull(types2);
    Assertions.assertEquals(2, types2.length);
    Assertions.assertEquals(String.class, types2[0]);
    Assertions.assertEquals(String.class, types2[1]);
    RpcInvocation inv3 = new RpcInvocation("testReturnType3", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    inv3.setReturnTypes(null);
    java.lang.reflect.Type[] types3 = RpcUtils.getReturnTypes(inv3);
    Assertions.assertNotNull(types3);
    Assertions.assertEquals(2, types3.length);
    Assertions.assertEquals(List.class, types3[0]);
    java.lang.reflect.Type genericReturnType3 = demoServiceClass.getMethod("testReturnType3", String.class).getGenericReturnType();
    Assertions.assertEquals(((ParameterizedType) genericReturnType3).getActualTypeArguments()[0], types3[1]);
    RpcInvocation inv4 = new RpcInvocation("testReturnType4", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    inv4.setReturnTypes(null);
    java.lang.reflect.Type[] types4 = RpcUtils.getReturnTypes(inv4);
    Assertions.assertNotNull(types4);
    Assertions.assertEquals(2, types4.length);
    Assertions.assertNull(types4[0]);
    Assertions.assertNull(types4[1]);
    RpcInvocation inv5 = new RpcInvocation("testReturnType5", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    inv5.setReturnTypes(null);
    java.lang.reflect.Type[] types5 = RpcUtils.getReturnTypes(inv5);
    Assertions.assertNotNull(types5);
    Assertions.assertEquals(2, types5.length);
    Assertions.assertEquals(Map.class, types5[0]);
    java.lang.reflect.Type genericReturnType5 = demoServiceClass.getMethod("testReturnType5", String.class).getGenericReturnType();
    Assertions.assertEquals(((ParameterizedType) genericReturnType5).getActualTypeArguments()[0], types5[1]);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testGetReturnTypesWithoutCache</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Class&lt;?&gt; demoServiceClass = DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span></span>;

    String serviceName = demoServiceClass.getName();

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"test://127.0.0.1:1/org.apache.dubbo.rpc.support.DemoService?interface=org.apache.dubbo.rpc.support.DemoService"</span>));

    RpcInvocation inv = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    inv.setReturnTypes(<span class="hljs-keyword">null</span>);

    Type[] types = RpcUtils.getReturnTypes(inv);

    Assertions.assertNotNull(types);

    Assertions.assertEquals(<span class="hljs-number">2</span>, types.length);

    Assertions.assertEquals(String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">types</span>[0])</span>;

    Assertions.assertEquals(String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">types</span>[1])</span>;

    RpcInvocation inv1 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType1"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    inv1.setReturnTypes(<span class="hljs-keyword">null</span>);

    java.lang.reflect.Type[] types1 = RpcUtils.getReturnTypes(inv1);

    Assertions.assertNotNull(types1);

    Assertions.assertEquals(<span class="hljs-number">2</span>, types1.length);

    Assertions.assertEquals(List<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">types1</span>[0])</span>;

    Assertions.assertEquals(demoServiceClass.getMethod(<span class="hljs-string">"testReturnType1"</span>, String<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">getGenericReturnType</span>(), <span class="hljs-title">types1</span>[1])</span>;

    RpcInvocation inv2 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType2"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    inv2.setReturnTypes(<span class="hljs-keyword">null</span>);

    java.lang.reflect.Type[] types2 = RpcUtils.getReturnTypes(inv2);

    Assertions.assertNotNull(types2);

    Assertions.assertEquals(<span class="hljs-number">2</span>, types2.length);

    Assertions.assertEquals(String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">types2</span>[0])</span>;

    Assertions.assertEquals(String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">types2</span>[1])</span>;

    RpcInvocation inv3 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType3"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    inv3.setReturnTypes(<span class="hljs-keyword">null</span>);

    java.lang.reflect.Type[] types3 = RpcUtils.getReturnTypes(inv3);

    Assertions.assertNotNull(types3);

    Assertions.assertEquals(<span class="hljs-number">2</span>, types3.length);

    Assertions.assertEquals(List<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">types3</span>[0])</span>;

    java.lang.reflect.Type genericReturnType3 = demoServiceClass.getMethod(<span class="hljs-string">"testReturnType3"</span>, String<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">getGenericReturnType</span>()</span>;

    Assertions.assertEquals(((ParameterizedType) genericReturnType3).getActualTypeArguments()[<span class="hljs-number">0</span>], types3[<span class="hljs-number">1</span>]);

    RpcInvocation inv4 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType4"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    inv4.setReturnTypes(<span class="hljs-keyword">null</span>);

    java.lang.reflect.Type[] types4 = RpcUtils.getReturnTypes(inv4);

    Assertions.assertNotNull(types4);

    Assertions.assertEquals(<span class="hljs-number">2</span>, types4.length);

    Assertions.assertNull(types4[<span class="hljs-number">0</span>]);

    Assertions.assertNull(types4[<span class="hljs-number">1</span>]);

    RpcInvocation inv5 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType5"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    inv5.setReturnTypes(<span class="hljs-keyword">null</span>);

    java.lang.reflect.Type[] types5 = RpcUtils.getReturnTypes(inv5);

    Assertions.assertNotNull(types5);

    Assertions.assertEquals(<span class="hljs-number">2</span>, types5.length);

    Assertions.assertEquals(Map<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">types5</span>[0])</span>;

    java.lang.reflect.Type genericReturnType5 = demoServiceClass.getMethod(<span class="hljs-string">"testReturnType5"</span>, String<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">getGenericReturnType</span>()</span>;

    Assertions.assertEquals(((ParameterizedType) genericReturnType5).getActualTypeArguments()[<span class="hljs-number">0</span>], types5[<span class="hljs-number">1</span>]);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">()</span> </span>{
    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"test://127.0.0.1:1/org.apache.dubbo.rpc.support.DemoService?interface=org.apache.dubbo.rpc.support.DemoService"</span>));
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest484">Test Case ID #dubbo_Test_48_4</h4>
<h4 id="test-case-name-testgetreturntypeswhengenericfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcsupportrpcutilstestjava">Test Case Name: <code>testGetReturnTypesWhenGeneric</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\support\RpcUtilsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Class&lt;?&gt; demoServiceClass = DemoService.class;
    String serviceName = demoServiceClass.getName();
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
<span class="hljs-deletion">-    given(invoker.getUrl()).willReturn(URL.valueOf("test://127.0.0.1:1/org.apache.dubbo.rpc.support.DemoService?interface=org.apache.dubbo.rpc.support.DemoService"));</span>
<span class="hljs-addition">+    Invoker invoker = createMockInvoker();</span>
    RpcInvocation inv = new RpcInvocation("testReturnType", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    inv.setMethodName($INVOKE);
    Type[] types = RpcUtils.getReturnTypes(inv);
    Assertions.assertNull(types);
    RpcInvocation inv1 = new RpcInvocation("testReturnType1", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    inv1.setMethodName($INVOKE);
    java.lang.reflect.Type[] types1 = RpcUtils.getReturnTypes(inv1);
    Assertions.assertNull(types1);
    RpcInvocation inv2 = new RpcInvocation("testReturnType2", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    inv2.setMethodName($INVOKE);
    java.lang.reflect.Type[] types2 = RpcUtils.getReturnTypes(inv2);
    Assertions.assertNull(types2);
    RpcInvocation inv3 = new RpcInvocation("testReturnType3", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    inv3.setMethodName($INVOKE);
    java.lang.reflect.Type[] types3 = RpcUtils.getReturnTypes(inv3);
    Assertions.assertNull(types3);
    RpcInvocation inv4 = new RpcInvocation("testReturnType4", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    inv4.setMethodName($INVOKE);
    java.lang.reflect.Type[] types4 = RpcUtils.getReturnTypes(inv4);
    Assertions.assertNull(types4);
    RpcInvocation inv5 = new RpcInvocation("testReturnType5", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    inv5.setMethodName($INVOKE);
    java.lang.reflect.Type[] types5 = RpcUtils.getReturnTypes(inv5);
    Assertions.assertNull(types5);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testGetReturnTypesWhenGeneric</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Class&lt;?&gt; demoServiceClass = DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span></span>;

    String serviceName = demoServiceClass.getName();

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"test://127.0.0.1:1/org.apache.dubbo.rpc.support.DemoService?interface=org.apache.dubbo.rpc.support.DemoService"</span>));

    RpcInvocation inv = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    inv.setMethodName($INVOKE);

    Type[] types = RpcUtils.getReturnTypes(inv);

    Assertions.assertNull(types);

    RpcInvocation inv1 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType1"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    inv1.setMethodName($INVOKE);

    java.lang.reflect.Type[] types1 = RpcUtils.getReturnTypes(inv1);

    Assertions.assertNull(types1);

    RpcInvocation inv2 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType2"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    inv2.setMethodName($INVOKE);

    java.lang.reflect.Type[] types2 = RpcUtils.getReturnTypes(inv2);

    Assertions.assertNull(types2);

    RpcInvocation inv3 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType3"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    inv3.setMethodName($INVOKE);

    java.lang.reflect.Type[] types3 = RpcUtils.getReturnTypes(inv3);

    Assertions.assertNull(types3);

    RpcInvocation inv4 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType4"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    inv4.setMethodName($INVOKE);

    java.lang.reflect.Type[] types4 = RpcUtils.getReturnTypes(inv4);

    Assertions.assertNull(types4);

    RpcInvocation inv5 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType5"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    inv5.setMethodName($INVOKE);

    java.lang.reflect.Type[] types5 = RpcUtils.getReturnTypes(inv5);

    Assertions.assertNull(types5);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">()</span> </span>{
    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"test://127.0.0.1:1/org.apache.dubbo.rpc.support.DemoService?interface=org.apache.dubbo.rpc.support.DemoService"</span>));
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest485">Test Case ID #dubbo_Test_48_5</h4>
<h4 id="test-case-name-testisreturntypefuturefile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcsupportrpcutilstestjava">Test Case Name: <code>testIsReturnTypeFuture</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\support\RpcUtilsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Class&lt;?&gt; demoServiceClass = DemoService.class;
    String serviceName = demoServiceClass.getName();
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
<span class="hljs-deletion">-    given(invoker.getUrl()).willReturn(URL.valueOf("test://127.0.0.1:1/org.apache.dubbo.rpc.support.DemoService?interface=org.apache.dubbo.rpc.support.DemoService"));</span>
<span class="hljs-addition">+    Invoker invoker = createMockInvoker();</span>
    RpcInvocation inv = new RpcInvocation("testReturnType", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    Assertions.assertFalse(RpcUtils.isReturnTypeFuture(inv));
    ModuleServiceRepository repository = ApplicationModel.defaultModel().getDefaultModule().getServiceRepository();
    repository.registerService(demoServiceClass);
    inv = new RpcInvocation("testReturnType4", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
    Assertions.assertTrue(RpcUtils.isReturnTypeFuture(inv));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testIsReturnTypeFuture</span><span class="hljs-params">()</span> </span>{

    Class&lt;?&gt; demoServiceClass = DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span></span>;

    String serviceName = demoServiceClass.getName();

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"test://127.0.0.1:1/org.apache.dubbo.rpc.support.DemoService?interface=org.apache.dubbo.rpc.support.DemoService"</span>));

    RpcInvocation inv = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    Assertions.assertFalse(RpcUtils.isReturnTypeFuture(inv));

    ModuleServiceRepository repository = ApplicationModel.defaultModel().getDefaultModule().getServiceRepository();

    repository.registerService(demoServiceClass);

    inv = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"testReturnType4"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    Assertions.assertTrue(RpcUtils.isReturnTypeFuture(inv));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">()</span> </span>{
    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getUrl()).willReturn(URL.valueOf(<span class="hljs-string">"test://127.0.0.1:1/org.apache.dubbo.rpc.support.DemoService?interface=org.apache.dubbo.rpc.support.DemoService"</span>));
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci49">Mock Clone Instance #dubbo_MCI_49</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Invoker</code></li>
<li><strong>Test Case Count</strong>: 5</li>
<li><strong>MO Count</strong>: 5</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Invoker invoker;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
invoker;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest491">Test Case ID #dubbo_Test_49_1</h4>
<h4 id="test-case-name-testgetparametertypesfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcsupportrpcutilstestjava">Test Case Name: <code>testGetParameterTypes</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\support\RpcUtilsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void testGetParameterTypes() {
     Class&lt;?&gt; demoServiceClass = DemoService.class;
     String serviceName = demoServiceClass.getName();
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `invoker`</span>
     // void sayHello(String name);
     RpcInvocation inv1 = new RpcInvocation("sayHello", serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
     Class&lt;?&gt;[] parameterTypes1 = RpcUtils.getParameterTypes(inv1);
     Assertions.assertNotNull(parameterTypes1);
     Assertions.assertEquals(1, parameterTypes1.length);
     Assertions.assertEquals(String.class, parameterTypes1[0]);
     //long timestamp();
     RpcInvocation inv2 = new RpcInvocation("timestamp", serviceName, "", null, null, null, invoker, null);
     Class&lt;?&gt;[] parameterTypes2 = RpcUtils.getParameterTypes(inv2);
     Assertions.assertEquals(0, parameterTypes2.length);
     //Type enumlength(Type... types);
     RpcInvocation inv3 = new RpcInvocation("enumlength", serviceName, "", new Class&lt;?&gt;[] { Type.class, Type.class }, null, null, invoker, null);
     Class&lt;?&gt;[] parameterTypes3 = RpcUtils.getParameterTypes(inv3);
     Assertions.assertNotNull(parameterTypes3);
     Assertions.assertEquals(2, parameterTypes3.length);
     Assertions.assertEquals(Type.class, parameterTypes3[0]);
     Assertions.assertEquals(Type.class, parameterTypes3[1]);
     //byte getbyte(byte arg);
     RpcInvocation inv4 = new RpcInvocation("getbyte", serviceName, "", new Class&lt;?&gt;[] { byte.class }, null, null, invoker, null);
     Class&lt;?&gt;[] parameterTypes4 = RpcUtils.getParameterTypes(inv4);
     Assertions.assertNotNull(parameterTypes4);
     Assertions.assertEquals(1, parameterTypes4.length);
     Assertions.assertEquals(byte.class, parameterTypes4[0]);
     //void $invoke(String s1, String s2);
     RpcInvocation inv5 = new RpcInvocation("$invoke", serviceName, "", new Class&lt;?&gt;[] { String.class, String[].class }, new Object[] { "method", new String[] { "java.lang.String", "void", "java.lang.Object" } }, null, invoker, null);
     Class&lt;?&gt;[] parameterTypes5 = RpcUtils.getParameterTypes(inv5);
     Assertions.assertNotNull(parameterTypes5);
     Assertions.assertEquals(3, parameterTypes5.length);
     Assertions.assertEquals(String.class, parameterTypes5[0]);
     Assertions.assertEquals(void.class, parameterTypes5[1]);
     Assertions.assertEquals(Object.class, parameterTypes5[2]);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testGetParameterTypes</span><span class="hljs-params">()</span> </span>{

    Class&lt;?&gt; demoServiceClass = DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span></span>;

    String serviceName = demoServiceClass.getName();

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// void sayHello(String name);</span>

    RpcInvocation inv1 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"sayHello"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    Class&lt;?&gt;[] parameterTypes1 = RpcUtils.getParameterTypes(inv1);

    Assertions.assertNotNull(parameterTypes1);

    Assertions.assertEquals(<span class="hljs-number">1</span>, parameterTypes1.length);

    Assertions.assertEquals(String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">parameterTypes1</span>[0])</span>;

    <span class="hljs-comment">//long timestamp();</span>

    RpcInvocation inv2 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"timestamp"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, invoker, <span class="hljs-keyword">null</span>);

    Class&lt;?&gt;[] parameterTypes2 = RpcUtils.getParameterTypes(inv2);

    Assertions.assertEquals(<span class="hljs-number">0</span>, parameterTypes2.length);

    <span class="hljs-comment">//Type enumlength(Type... types);</span>

    RpcInvocation inv3 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"enumlength"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { Type<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Type</span>.<span class="hljs-title">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    Class&lt;?&gt;[] parameterTypes3 = RpcUtils.getParameterTypes(inv3);

    Assertions.assertNotNull(parameterTypes3);

    Assertions.assertEquals(<span class="hljs-number">2</span>, parameterTypes3.length);

    Assertions.assertEquals(Type<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">parameterTypes3</span>[0])</span>;

    Assertions.assertEquals(Type<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">parameterTypes3</span>[1])</span>;

    <span class="hljs-comment">//byte getbyte(byte arg);</span>

    RpcInvocation inv4 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"getbyte"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { <span class="hljs-keyword">byte</span><span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    Class&lt;?&gt;[] parameterTypes4 = RpcUtils.getParameterTypes(inv4);

    Assertions.assertNotNull(parameterTypes4);

    Assertions.assertEquals(<span class="hljs-number">1</span>, parameterTypes4.length);

    Assertions.assertEquals(<span class="hljs-keyword">byte</span><span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">parameterTypes4</span>[0])</span>;

    <span class="hljs-comment">//void $invoke(String s1, String s2);</span>

    RpcInvocation inv5 = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"$invoke"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">String</span>[].<span class="hljs-title">class</span> }, <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[] </span>{ <span class="hljs-string">"method"</span>, <span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"java.lang.String"</span>, <span class="hljs-string">"void"</span>, <span class="hljs-string">"java.lang.Object"</span> } }, <span class="hljs-keyword">null</span>, invoker, <span class="hljs-keyword">null</span>);

    Class&lt;?&gt;[] parameterTypes5 = RpcUtils.getParameterTypes(inv5);

    Assertions.assertNotNull(parameterTypes5);

    Assertions.assertEquals(<span class="hljs-number">3</span>, parameterTypes5.length);

    Assertions.assertEquals(String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">parameterTypes5</span>[0])</span>;

    Assertions.assertEquals(<span class="hljs-keyword">void</span><span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">parameterTypes5</span>[1])</span>;

    Assertions.assertEquals(Object<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">parameterTypes5</span>[2])</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Invoker invoker;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
invoker;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest492">Test Case ID #dubbo_Test_49_2</h4>
<h4 id="test-case-name-testgetmethodnamefile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcsupportrpcutilstestjava">Test Case Name: <code>testGetMethodName</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\support\RpcUtilsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @ParameterizedTest
 @CsvSource({ "echo", "stringLength", "testReturnType" })
 public void testGetMethodName(String methodName) {
     Class&lt;?&gt; demoServiceClass = DemoService.class;
     String serviceName = demoServiceClass.getName();
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `invoker`</span>
     RpcInvocation inv1 = new RpcInvocation(methodName, serviceName, "", new Class&lt;?&gt;[] { String.class }, null, null, invoker, null);
     String actual = RpcUtils.getMethodName(inv1);
     Assertions.assertNotNull(actual);
     Assertions.assertEquals(methodName, actual);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@ParameterizedTest</span>

<span class="hljs-meta">@CsvSource</span>({ <span class="hljs-string">"echo"</span>, <span class="hljs-string">"stringLength"</span>, <span class="hljs-string">"testReturnType"</span> })

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetMethodName</span><span class="hljs-params">(String methodName)</span> </span>{

    Class&lt;?&gt; demoServiceClass = DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span></span>;

    String serviceName = demoServiceClass.getName();

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RpcInvocation inv1 = <span class="hljs-keyword">new</span> RpcInvocation(methodName, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> }, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">invoker</span>, <span class="hljs-title">null</span>)</span>;

    String actual = RpcUtils.getMethodName(inv1);

    Assertions.assertNotNull(actual);

    Assertions.assertEquals(methodName, actual);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Invoker invoker;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
invoker;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest493">Test Case ID #dubbo_Test_49_3</h4>
<h4 id="test-case-name-testgetinvokemethodnamefile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcsupportrpcutilstestjava">Test Case Name: <code>testGet_$invoke_MethodName</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\support\RpcUtilsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @ParameterizedTest
 @CsvSource({ "hello", "apache", "dubbo" })
 public void testGet_$invoke_MethodName(String method) {
     Class&lt;?&gt; demoServiceClass = DemoService.class;
     String serviceName = demoServiceClass.getName();
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `invoker`</span>
     RpcInvocation inv = new RpcInvocation("$invoke", serviceName, "", new Class&lt;?&gt;[] { String.class, String[].class }, new Object[] { method, new String[] { "java.lang.String", "void", "java.lang.Object" } }, null, invoker, null);
     String actual = RpcUtils.getMethodName(inv);
     Assertions.assertNotNull(actual);
     Assertions.assertEquals(method, actual);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@ParameterizedTest</span>

<span class="hljs-meta">@CsvSource</span>({ <span class="hljs-string">"hello"</span>, <span class="hljs-string">"apache"</span>, <span class="hljs-string">"dubbo"</span> })

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> testGet_$invoke_MethodName(String method) {

    Class&lt;?&gt; demoServiceClass = DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span></span>;

    String serviceName = demoServiceClass.getName();

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RpcInvocation inv = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"$invoke"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">String</span>[].<span class="hljs-title">class</span> }, <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[] </span>{ method, <span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"java.lang.String"</span>, <span class="hljs-string">"void"</span>, <span class="hljs-string">"java.lang.Object"</span> } }, <span class="hljs-keyword">null</span>, invoker, <span class="hljs-keyword">null</span>);

    String actual = RpcUtils.getMethodName(inv);

    Assertions.assertNotNull(actual);

    Assertions.assertEquals(method, actual);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Invoker invoker;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
invoker;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest494">Test Case ID #dubbo_Test_49_4</h4>
<h4 id="test-case-name-testgetinvokeargumentsfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcsupportrpcutilstestjava">Test Case Name: <code>testGet_$invoke_Arguments</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\support\RpcUtilsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void testGet_$invoke_Arguments() {
     Object[] args = new Object[] { "hello", "dubbo", 520 };
     Class&lt;?&gt; demoServiceClass = DemoService.class;
     String serviceName = demoServiceClass.getName();
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `invoker`</span>
     RpcInvocation inv = new RpcInvocation("$invoke", serviceName, "", new Class&lt;?&gt;[] { String.class, String[].class, Object[].class }, new Object[] { "method", new String[] {}, args }, null, invoker, null);
     Object[] arguments = RpcUtils.getArguments(inv);
     for (int i = 0; i &lt; args.length; i++) {
         Assertions.assertNotNull(arguments[i]);
         Assertions.assertEquals(args[i].getClass().getName(), arguments[i].getClass().getName());
         Assertions.assertEquals(args[i], arguments[i]);
     }
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-keyword">void</span> testGet_$invoke_Arguments() {

    Object[] args = <span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span>, <span class="hljs-string">"dubbo"</span>, <span class="hljs-number">520</span> };

    Class&lt;?&gt; demoServiceClass = DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span></span>;

    String serviceName = demoServiceClass.getName();

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RpcInvocation inv = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"$invoke"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">String</span>[].<span class="hljs-title">class</span>, <span class="hljs-title">Object</span>[].<span class="hljs-title">class</span> }, <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[] </span>{ <span class="hljs-string">"method"</span>, <span class="hljs-keyword">new</span> String[] {}, args }, <span class="hljs-keyword">null</span>, invoker, <span class="hljs-keyword">null</span>);

    Object[] arguments = RpcUtils.getArguments(inv);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; args.length; i++) {

        Assertions.assertNotNull(arguments[i]);

        Assertions.assertEquals(args[i].getClass().getName(), arguments[i].getClass().getName());

        Assertions.assertEquals(args[i], arguments[i]);

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Invoker invoker;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
invoker;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest495">Test Case ID #dubbo_Test_49_5</h4>
<h4 id="test-case-name-testisasyncfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcsupportrpcutilstestjava">Test Case Name: <code>testIsAsync</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\support\RpcUtilsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void testIsAsync() {
     Object[] args = new Object[] { "hello", "dubbo", 520 };
     Class&lt;?&gt; demoServiceClass = DemoService.class;
     String serviceName = demoServiceClass.getName();
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `invoker`</span>
     URL url = URL.valueOf("test://127.0.0.1:1/org.apache.dubbo.rpc.support.DemoService?interface=org.apache.dubbo.rpc.support.DemoService");
<span class="hljs-deletion">-    RpcInvocation inv = new RpcInvocation("test", serviceName, "", new Class&lt;?&gt;[] { String.class, String[].class, Object[].class }, new Object[] { "method", new String[] {}, args }, null, invoker, null);</span>
<span class="hljs-addition">+    RpcInvocation inv = new RpcInvocation("test", serviceName, "", new Class&lt;?&gt;[] { String.class, String[].class, Object[].class }, new Object[] { "method", new String[] {}, args }, null, invoker, null);</span>
     Assertions.assertFalse(RpcUtils.isAsync(url, inv));
     inv.setInvokeMode(InvokeMode.ASYNC);
     Assertions.assertTrue(RpcUtils.isAsync(url, inv));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testIsAsync</span><span class="hljs-params">()</span> </span>{

    Object[] args = <span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"hello"</span>, <span class="hljs-string">"dubbo"</span>, <span class="hljs-number">520</span> };

    Class&lt;?&gt; demoServiceClass = DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span></span>;

    String serviceName = demoServiceClass.getName();

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = URL.valueOf(<span class="hljs-string">"test://127.0.0.1:1/org.apache.dubbo.rpc.support.DemoService?interface=org.apache.dubbo.rpc.support.DemoService"</span>);

    RpcInvocation inv = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"test"</span>, serviceName, <span class="hljs-string">""</span>, <span class="hljs-keyword">new</span> Class&lt;?&gt;[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">String</span>[].<span class="hljs-title">class</span>, <span class="hljs-title">Object</span>[].<span class="hljs-title">class</span> }, <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[] </span>{ <span class="hljs-string">"method"</span>, <span class="hljs-keyword">new</span> String[] {}, args }, <span class="hljs-keyword">null</span>, invoker, <span class="hljs-keyword">null</span>);

    Assertions.assertFalse(RpcUtils.isAsync(url, inv));

    inv.setInvokeMode(InvokeMode.ASYNC);

    Assertions.assertTrue(RpcUtils.isAsync(url, inv));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Invoker invoker;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
invoker;

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci50">Mock Clone Instance #dubbo_MCI_50</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Invoker</code></li>
<li><strong>Test Case Count</strong>: 7</li>
<li><strong>MO Count</strong>: 9</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest501">Test Case ID #dubbo_Test_50_1</h4>
<h4 id="test-case-name-testauthdisabledfile-cjavaprojectsapachedubbodubbo-plugindubbo-authsrctestjavaorgapachedubboauthfilterconsumersignfiltertestjava">Test Case Name: <code>testAuthDisabled</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-auth\src\test\java\org\apache\dubbo\auth\filter\ConsumerSignFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    URL url = mock(URL.class);
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
    Invocation invocation = mock(Invocation.class);
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(url);</span>
    ConsumerSignFilter consumerSignFilter = new ConsumerSignFilter(ApplicationModel.defaultModel());
    consumerSignFilter.invoke(invoker, invocation);
    verify(invocation, never()).setAttachment(eq(Constants.REQUEST_SIGNATURE_KEY), anyString());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAuthDisabled</span><span class="hljs-params">()</span> </span>{

    URL url = mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invocation invocation = mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.getUrl()).thenReturn(url);

    ConsumerSignFilter consumerSignFilter = <span class="hljs-keyword">new</span> ConsumerSignFilter(ApplicationModel.defaultModel());

    consumerSignFilter.invoke(invoker, invocation);

    verify(invocation, never()).setAttachment(eq(Constants.REQUEST_SIGNATURE_KEY), anyString());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest502">Test Case ID #dubbo_Test_50_2</h4>
<h4 id="test-case-name-testauthenabledfile-cjavaprojectsapachedubbodubbo-plugindubbo-authsrctestjavaorgapachedubboauthfilterconsumersignfiltertestjava">Test Case Name: <code>testAuthEnabled</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-auth\src\test\java\org\apache\dubbo\auth\filter\ConsumerSignFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     URL url = URL.valueOf("dubbo://10.10.10.10:2181").addParameter(Constants.ACCESS_KEY_ID_KEY, "ak").addParameter(Constants.SECRET_ACCESS_KEY_KEY, "sk").addParameter(CommonConstants.APPLICATION_KEY, "test").addParameter(Constants.SERVICE_AUTH, true);
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
     Invocation invocation = mock(Invocation.class);
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(url);</span>
     ConsumerSignFilter consumerSignFilter = new ConsumerSignFilter(ApplicationModel.defaultModel());
     consumerSignFilter.invoke(invoker, invocation);
     verify(invocation, times(1)).setAttachment(eq(Constants.REQUEST_SIGNATURE_KEY), anyString());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAuthEnabled</span><span class="hljs-params">()</span> </span>{

    URL url = URL.valueOf(<span class="hljs-string">"dubbo://10.10.10.10:2181"</span>).addParameter(Constants.ACCESS_KEY_ID_KEY, <span class="hljs-string">"ak"</span>).addParameter(Constants.SECRET_ACCESS_KEY_KEY, <span class="hljs-string">"sk"</span>).addParameter(CommonConstants.APPLICATION_KEY, <span class="hljs-string">"test"</span>).addParameter(Constants.SERVICE_AUTH, <span class="hljs-keyword">true</span>);

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invocation invocation = mock(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.getUrl()).thenReturn(url);

    ConsumerSignFilter consumerSignFilter = <span class="hljs-keyword">new</span> ConsumerSignFilter(ApplicationModel.defaultModel());

    consumerSignFilter.invoke(invoker, invocation);

    verify(invocation, times(<span class="hljs-number">1</span>)).setAttachment(eq(Constants.REQUEST_SIGNATURE_KEY), anyString());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest503">Test Case ID #dubbo_Test_50_3</h4>
<h4 id="test-case-name-testauthdisabledfile-cjavaprojectsapachedubbodubbo-plugindubbo-authsrctestjavaorgapachedubboauthfilterproviderauthfiltertestjava">Test Case Name: <code>testAuthDisabled</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-auth\src\test\java\org\apache\dubbo\auth\filter\ProviderAuthFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    URL url = mock(URL.class);
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
<span class="hljs-deletion">-    Invocation invocation = mock(RpcInvocation.class);</span>
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(url);</span>
<span class="hljs-addition">+    Invocation invocation = mock(RpcInvocation.class);</span>
    ProviderAuthFilter providerAuthFilter = new ProviderAuthFilter(ApplicationModel.defaultModel());
    providerAuthFilter.invoke(invoker, invocation);
    verify(url, never()).getParameter(eq(Constants.AUTHENTICATOR), eq(Constants.DEFAULT_AUTHENTICATOR));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAuthDisabled</span><span class="hljs-params">()</span> </span>{

    URL url = mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invocation invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.getUrl()).thenReturn(url);

    ProviderAuthFilter providerAuthFilter = <span class="hljs-keyword">new</span> ProviderAuthFilter(ApplicationModel.defaultModel());

    providerAuthFilter.invoke(invoker, invocation);

    verify(url, never()).getParameter(eq(Constants.AUTHENTICATOR), eq(Constants.DEFAULT_AUTHENTICATOR));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest504">Test Case ID #dubbo_Test_50_4</h4>
<h4 id="test-case-name-testauthenabledfile-cjavaprojectsapachedubbodubbo-plugindubbo-authsrctestjavaorgapachedubboauthfilterproviderauthfiltertestjava">Test Case Name: <code>testAuthEnabled</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-auth\src\test\java\org\apache\dubbo\auth\filter\ProviderAuthFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     URL url = URL.valueOf("dubbo://10.10.10.10:2181").addParameter(Constants.ACCESS_KEY_ID_KEY, "ak").addParameter(Constants.SECRET_ACCESS_KEY_KEY, "sk").addParameter(CommonConstants.APPLICATION_KEY, "test").addParameter(Constants.SERVICE_AUTH, true);
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
     Invocation invocation = mock(RpcInvocation.class);
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(url);</span>
     ProviderAuthFilter providerAuthFilter = new ProviderAuthFilter(ApplicationModel.defaultModel());
     providerAuthFilter.invoke(invoker, invocation);
     verify(invocation, atLeastOnce()).getAttachment(anyString());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAuthEnabled</span><span class="hljs-params">()</span> </span>{

    URL url = URL.valueOf(<span class="hljs-string">"dubbo://10.10.10.10:2181"</span>).addParameter(Constants.ACCESS_KEY_ID_KEY, <span class="hljs-string">"ak"</span>).addParameter(Constants.SECRET_ACCESS_KEY_KEY, <span class="hljs-string">"sk"</span>).addParameter(CommonConstants.APPLICATION_KEY, <span class="hljs-string">"test"</span>).addParameter(Constants.SERVICE_AUTH, <span class="hljs-keyword">true</span>);

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invocation invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.getUrl()).thenReturn(url);

    ProviderAuthFilter providerAuthFilter = <span class="hljs-keyword">new</span> ProviderAuthFilter(ApplicationModel.defaultModel());

    providerAuthFilter.invoke(invoker, invocation);

    verify(invocation, atLeastOnce()).getAttachment(anyString());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest505">Test Case ID #dubbo_Test_50_5</h4>
<h4 id="test-case-name-testauthfailedfile-cjavaprojectsapachedubbodubbo-plugindubbo-authsrctestjavaorgapachedubboauthfilterproviderauthfiltertestjava">Test Case Name: <code>testAuthFailed</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-auth\src\test\java\org\apache\dubbo\auth\filter\ProviderAuthFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    URL url = URL.valueOf("dubbo://10.10.10.10:2181").addParameter(Constants.ACCESS_KEY_ID_KEY, "ak").addParameter(Constants.SECRET_ACCESS_KEY_KEY, "sk").addParameter(CommonConstants.APPLICATION_KEY, "test").addParameter(Constants.SERVICE_AUTH, true);
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
    Invocation invocation = mock(RpcInvocation.class);
    when(invocation.getAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(null);
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(url);</span>
    ProviderAuthFilter providerAuthFilter = new ProviderAuthFilter(ApplicationModel.defaultModel());
    Result result = providerAuthFilter.invoke(invoker, invocation);
    assertTrue(result.hasException());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAuthFailed</span><span class="hljs-params">()</span> </span>{

    URL url = URL.valueOf(<span class="hljs-string">"dubbo://10.10.10.10:2181"</span>).addParameter(Constants.ACCESS_KEY_ID_KEY, <span class="hljs-string">"ak"</span>).addParameter(Constants.SECRET_ACCESS_KEY_KEY, <span class="hljs-string">"sk"</span>).addParameter(CommonConstants.APPLICATION_KEY, <span class="hljs-string">"test"</span>).addParameter(Constants.SERVICE_AUTH, <span class="hljs-keyword">true</span>);

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invocation invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(<span class="hljs-keyword">null</span>);

    when(invoker.getUrl()).thenReturn(url);

    ProviderAuthFilter providerAuthFilter = <span class="hljs-keyword">new</span> ProviderAuthFilter(ApplicationModel.defaultModel());

    Result result = providerAuthFilter.invoke(invoker, invocation);

    assertTrue(result.hasException());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest506">Test Case ID #dubbo_Test_50_6</h4>
<h4 id="test-case-name-testauthfailedwhennosignaturefile-cjavaprojectsapachedubbodubbo-plugindubbo-authsrctestjavaorgapachedubboauthfilterproviderauthfiltertestjava">Test Case Name: <code>testAuthFailedWhenNoSignature</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-auth\src\test\java\org\apache\dubbo\auth\filter\ProviderAuthFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    URL url = URL.valueOf("dubbo://10.10.10.10:2181").addParameter(Constants.ACCESS_KEY_ID_KEY, "ak").addParameter(Constants.SECRET_ACCESS_KEY_KEY, "sk").addParameter(CommonConstants.APPLICATION_KEY, "test").addParameter(Constants.SERVICE_AUTH, true);
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
    Invocation invocation = mock(RpcInvocation.class);
    when(invocation.getAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(null);
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(url);</span>
    ProviderAuthFilter providerAuthFilter = new ProviderAuthFilter(ApplicationModel.defaultModel());
    Result result = providerAuthFilter.invoke(invoker, invocation);
    assertTrue(result.hasException());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAuthFailedWhenNoSignature</span><span class="hljs-params">()</span> </span>{

    URL url = URL.valueOf(<span class="hljs-string">"dubbo://10.10.10.10:2181"</span>).addParameter(Constants.ACCESS_KEY_ID_KEY, <span class="hljs-string">"ak"</span>).addParameter(Constants.SECRET_ACCESS_KEY_KEY, <span class="hljs-string">"sk"</span>).addParameter(CommonConstants.APPLICATION_KEY, <span class="hljs-string">"test"</span>).addParameter(Constants.SERVICE_AUTH, <span class="hljs-keyword">true</span>);

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invocation invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(<span class="hljs-keyword">null</span>);

    when(invoker.getUrl()).thenReturn(url);

    ProviderAuthFilter providerAuthFilter = <span class="hljs-keyword">new</span> ProviderAuthFilter(ApplicationModel.defaultModel());

    Result result = providerAuthFilter.invoke(invoker, invocation);

    assertTrue(result.hasException());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest507">Test Case ID #dubbo_Test_50_7</h4>
<h4 id="test-case-name-testauthfailedwhennoaccesskeypairfile-cjavaprojectsapachedubbodubbo-plugindubbo-authsrctestjavaorgapachedubboauthfilterproviderauthfiltertestjava">Test Case Name: <code>testAuthFailedWhenNoAccessKeyPair</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-auth\src\test\java\org\apache\dubbo\auth\filter\ProviderAuthFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    URL url = URL.valueOf("dubbo://10.10.10.10:2181").addParameter(CommonConstants.APPLICATION_KEY, "test-provider").addParameter(Constants.SERVICE_AUTH, true);
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(url);</span>
    Invocation invocation = mock(RpcInvocation.class);
    when(invocation.getObjectAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn("dubbo");
    when(invocation.getObjectAttachment(Constants.AK_KEY)).thenReturn("ak");
    when(invocation.getObjectAttachment(CommonConstants.CONSUMER)).thenReturn("test-consumer");
    when(invocation.getObjectAttachment(Constants.REQUEST_TIMESTAMP_KEY)).thenReturn(System.currentTimeMillis());
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
    ProviderAuthFilter providerAuthFilter = new ProviderAuthFilter(ApplicationModel.defaultModel());
    Result result = providerAuthFilter.invoke(invoker, invocation);
    assertTrue(result.hasException());
    assertTrue(result.getException() instanceof RpcAuthenticationException);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAuthFailedWhenNoAccessKeyPair</span><span class="hljs-params">()</span> </span>{

    URL url = URL.valueOf(<span class="hljs-string">"dubbo://10.10.10.10:2181"</span>).addParameter(CommonConstants.APPLICATION_KEY, <span class="hljs-string">"test-provider"</span>).addParameter(Constants.SERVICE_AUTH, <span class="hljs-keyword">true</span>);

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invocation invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getObjectAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(<span class="hljs-string">"dubbo"</span>);

    when(invocation.getObjectAttachment(Constants.AK_KEY)).thenReturn(<span class="hljs-string">"ak"</span>);

    when(invocation.getObjectAttachment(CommonConstants.CONSUMER)).thenReturn(<span class="hljs-string">"test-consumer"</span>);

    when(invocation.getObjectAttachment(Constants.REQUEST_TIMESTAMP_KEY)).thenReturn(System.currentTimeMillis());

    when(invoker.getUrl()).thenReturn(url);

    ProviderAuthFilter providerAuthFilter = <span class="hljs-keyword">new</span> ProviderAuthFilter(ApplicationModel.defaultModel());

    Result result = providerAuthFilter.invoke(invoker, invocation);

    assertTrue(result.hasException());

    assertTrue(result.getException() <span class="hljs-keyword">instanceof</span> RpcAuthenticationException);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest508">Test Case ID #dubbo_Test_50_8</h4>
<h4 id="test-case-name-testauthfailedwhenparametererrorfile-cjavaprojectsapachedubbodubbo-plugindubbo-authsrctestjavaorgapachedubboauthfilterproviderauthfiltertestjava">Test Case Name: <code>testAuthFailedWhenParameterError</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-auth\src\test\java\org\apache\dubbo\auth\filter\ProviderAuthFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    URL url = URL.valueOf("dubbo://10.10.10.10:2181").setServiceInterface(service).addParameter(Constants.ACCESS_KEY_ID_KEY, "ak").addParameter(Constants.SECRET_ACCESS_KEY_KEY, "sk").addParameter(CommonConstants.APPLICATION_KEY, "test-provider").addParameter(Constants.PARAMETER_SIGNATURE_ENABLE_KEY, true).addParameter(Constants.SERVICE_AUTH, true);
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
    Invocation invocation = mock(RpcInvocation.class);
    when(invocation.getObjectAttachment(Constants.AK_KEY)).thenReturn("ak");
    when(invocation.getObjectAttachment(CommonConstants.CONSUMER)).thenReturn("test-consumer");
    when(invocation.getObjectAttachment(Constants.REQUEST_TIMESTAMP_KEY)).thenReturn(currentTimeMillis);
    when(invocation.getMethodName()).thenReturn(method);
    Object[] fakeParams = new Object[] { "dubbo1", "dubbo3" };
    when(invocation.getArguments()).thenReturn(fakeParams);
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(url);</span>
    String requestString = String.format(Constants.SIGNATURE_STRING_FORMAT, url.getColonSeparatedKey(), invocation.getMethodName(), "sk", currentTimeMillis);
    String sign = SignatureUtils.sign(originalParams, requestString, "sk");
    when(invocation.getObjectAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(sign);
    ProviderAuthFilter providerAuthFilter = new ProviderAuthFilter(ApplicationModel.defaultModel());
    Result result = providerAuthFilter.invoke(invoker, invocation);
    assertTrue(result.hasException());
    assertTrue(result.getException() instanceof RpcAuthenticationException);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAuthFailedWhenParameterError</span><span class="hljs-params">()</span> </span>{

    String service = <span class="hljs-string">"org.apache.dubbo.DemoService"</span>;

    String method = <span class="hljs-string">"test"</span>;

    Object[] originalParams = <span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"dubbo1"</span>, <span class="hljs-string">"dubbo2"</span> };

    <span class="hljs-keyword">long</span> currentTimeMillis = System.currentTimeMillis();

    URL url = URL.valueOf(<span class="hljs-string">"dubbo://10.10.10.10:2181"</span>).setServiceInterface(service).addParameter(Constants.ACCESS_KEY_ID_KEY, <span class="hljs-string">"ak"</span>).addParameter(Constants.SECRET_ACCESS_KEY_KEY, <span class="hljs-string">"sk"</span>).addParameter(CommonConstants.APPLICATION_KEY, <span class="hljs-string">"test-provider"</span>).addParameter(Constants.PARAMETER_SIGNATURE_ENABLE_KEY, <span class="hljs-keyword">true</span>).addParameter(Constants.SERVICE_AUTH, <span class="hljs-keyword">true</span>);

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invocation invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getObjectAttachment(Constants.AK_KEY)).thenReturn(<span class="hljs-string">"ak"</span>);

    when(invocation.getObjectAttachment(CommonConstants.CONSUMER)).thenReturn(<span class="hljs-string">"test-consumer"</span>);

    when(invocation.getObjectAttachment(Constants.REQUEST_TIMESTAMP_KEY)).thenReturn(currentTimeMillis);

    when(invocation.getMethodName()).thenReturn(method);

    Object[] fakeParams = <span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"dubbo1"</span>, <span class="hljs-string">"dubbo3"</span> };

    when(invocation.getArguments()).thenReturn(fakeParams);

    when(invoker.getUrl()).thenReturn(url);

    String requestString = String.format(Constants.SIGNATURE_STRING_FORMAT, url.getColonSeparatedKey(), invocation.getMethodName(), <span class="hljs-string">"sk"</span>, currentTimeMillis);

    String sign = SignatureUtils.sign(originalParams, requestString, <span class="hljs-string">"sk"</span>);

    when(invocation.getObjectAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(sign);

    ProviderAuthFilter providerAuthFilter = <span class="hljs-keyword">new</span> ProviderAuthFilter(ApplicationModel.defaultModel());

    Result result = providerAuthFilter.invoke(invoker, invocation);

    assertTrue(result.hasException());

    assertTrue(result.getException() <span class="hljs-keyword">instanceof</span> RpcAuthenticationException);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest509">Test Case ID #dubbo_Test_50_9</h4>
<h4 id="test-case-name-testauthsuccessfullyfile-cjavaprojectsapachedubbodubbo-plugindubbo-authsrctestjavaorgapachedubboauthfilterproviderauthfiltertestjava">Test Case Name: <code>testAuthSuccessfully</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-auth\src\test\java\org\apache\dubbo\auth\filter\ProviderAuthFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    long currentTimeMillis = System.currentTimeMillis();
    URL url = URL.valueOf("dubbo://10.10.10.10:2181").setServiceInterface(service).addParameter(Constants.ACCESS_KEY_ID_KEY, "ak").addParameter(Constants.SECRET_ACCESS_KEY_KEY, "sk").addParameter(CommonConstants.APPLICATION_KEY, "test-provider").addParameter(Constants.SERVICE_AUTH, true);
<span class="hljs-deletion">-    Invoker invoker = mock(Invoker.class);</span>
<span class="hljs-addition">+    Invoker invoker = MockInvoker.createMockInvoker(url);</span>
    Invocation invocation = mock(RpcInvocation.class);
    when(invocation.getAttachment(Constants.AK_KEY)).thenReturn("ak");
    when(invocation.getAttachment(CommonConstants.CONSUMER)).thenReturn("test-consumer");
    when(invocation.getAttachment(Constants.REQUEST_TIMESTAMP_KEY)).thenReturn(String.valueOf(currentTimeMillis));
    when(invocation.getMethodName()).thenReturn(method);
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
    String requestString = String.format(Constants.SIGNATURE_STRING_FORMAT, url.getColonSeparatedKey(), invocation.getMethodName(), "sk", currentTimeMillis);
    String sign = SignatureUtils.sign(requestString, "sk");
    when(invocation.getAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(sign);
    ProviderAuthFilter providerAuthFilter = new ProviderAuthFilter(ApplicationModel.defaultModel());
    Result result = providerAuthFilter.invoke(invoker, invocation);
    assertNull(result);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAuthSuccessfully</span><span class="hljs-params">()</span> </span>{

    String service = <span class="hljs-string">"org.apache.dubbo.DemoService"</span>;

    String method = <span class="hljs-string">"test"</span>;

    <span class="hljs-keyword">long</span> currentTimeMillis = System.currentTimeMillis();

    URL url = URL.valueOf(<span class="hljs-string">"dubbo://10.10.10.10:2181"</span>).setServiceInterface(service).addParameter(Constants.ACCESS_KEY_ID_KEY, <span class="hljs-string">"ak"</span>).addParameter(Constants.SECRET_ACCESS_KEY_KEY, <span class="hljs-string">"sk"</span>).addParameter(CommonConstants.APPLICATION_KEY, <span class="hljs-string">"test-provider"</span>).addParameter(Constants.SERVICE_AUTH, <span class="hljs-keyword">true</span>);

    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invocation invocation = mock(RpcInvocation<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invocation.getAttachment(Constants.AK_KEY)).thenReturn(<span class="hljs-string">"ak"</span>);

    when(invocation.getAttachment(CommonConstants.CONSUMER)).thenReturn(<span class="hljs-string">"test-consumer"</span>);

    when(invocation.getAttachment(Constants.REQUEST_TIMESTAMP_KEY)).thenReturn(String.valueOf(currentTimeMillis));

    when(invocation.getMethodName()).thenReturn(method);

    when(invoker.getUrl()).thenReturn(url);

    String requestString = String.format(Constants.SIGNATURE_STRING_FORMAT, url.getColonSeparatedKey(), invocation.getMethodName(), <span class="hljs-string">"sk"</span>, currentTimeMillis);

    String sign = SignatureUtils.sign(requestString, <span class="hljs-string">"sk"</span>);

    when(invocation.getAttachment(Constants.REQUEST_SIGNATURE_KEY)).thenReturn(sign);

    ProviderAuthFilter providerAuthFilter = <span class="hljs-keyword">new</span> ProviderAuthFilter(ApplicationModel.defaultModel());

    Result result = providerAuthFilter.invoke(invoker, invocation);

    assertNull(result);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockInvoker</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
        Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(invoker.getUrl()).thenReturn(url);
        <span class="hljs-keyword">return</span> invoker;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci51">Mock Clone Instance #dubbo_MCI_51</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Invoker</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvokerWithUrl</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">stubOnly</span>())</span>;
    given(invoker.getUrl()).willReturn(url);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest511">Test Case ID #dubbo_Test_51_1</h4>
<h4 id="test-case-name-testgetweightfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclusterloadbalanceabstractloadbalancetestjava">Test Case Name: <code>testGetWeight</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\loadbalance\AbstractLoadBalanceTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker1">Mock Object Variable Name: <code>invoker1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    invocation.setMethodName("say");
<span class="hljs-deletion">-    Invoker invoker1 = mock(Invoker.class, Mockito.withSettings().stubOnly());</span>
    URL url1 = new ServiceConfigURL("", "", 0, "DemoService", new HashMap&lt;&gt;());
    url1 = url1.addParameter(TIMESTAMP_KEY, System.currentTimeMillis() - Integer.MAX_VALUE - 1);
<span class="hljs-deletion">-    given(invoker1.getUrl()).willReturn(url1);</span>
<span class="hljs-addition">+    Invoker invoker1 = createMockInvokerWithUrl(url1);</span>
    Invoker invoker2 = mock(Invoker.class, Mockito.withSettings().stubOnly());
    URL url2 = new ServiceConfigURL("", "", 0, "DemoService", new HashMap&lt;&gt;());
    url2 = url2.addParameter(TIMESTAMP_KEY, System.currentTimeMillis() - 10 * 60 * 1000L - 1);
    given(invoker2.getUrl()).willReturn(url2);
    Assertions.assertEquals(balance.getWeight(invoker1, invocation), balance.getWeight(invoker2, invocation));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testGetWeight</span><span class="hljs-params">()</span> </span>{

    RpcInvocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    invocation.setMethodName(<span class="hljs-string">"say"</span>);

    Invoker invoker1 = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">stubOnly</span>())</span>;

    URL url1 = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"DemoService"</span>, <span class="hljs-keyword">new</span> HashMap&lt;&gt;());

    url1 = url1.addParameter(TIMESTAMP_KEY, System.currentTimeMillis() - Integer.MAX_VALUE - <span class="hljs-number">1</span>);

    given(invoker1.getUrl()).willReturn(url1);

    Invoker invoker2 = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">stubOnly</span>())</span>;

    URL url2 = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"DemoService"</span>, <span class="hljs-keyword">new</span> HashMap&lt;&gt;());

    url2 = url2.addParameter(TIMESTAMP_KEY, System.currentTimeMillis() - <span class="hljs-number">10</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000L</span> - <span class="hljs-number">1</span>);

    given(invoker2.getUrl()).willReturn(url2);

    Assertions.assertEquals(balance.getWeight(invoker1, invocation), balance.getWeight(invoker2, invocation));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvokerWithUrl</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">stubOnly</span>())</span>;
    given(invoker.getUrl()).willReturn(url);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest512">Test Case ID #dubbo_Test_51_2</h4>
<h4 id="test-case-name-testgetweightfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclusterloadbalanceabstractloadbalancetestjava">Test Case Name: <code>testGetWeight</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\loadbalance\AbstractLoadBalanceTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker2">Mock Object Variable Name: <code>invoker2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    URL url1 = new ServiceConfigURL("", "", 0, "DemoService", new HashMap&lt;&gt;());
    url1 = url1.addParameter(TIMESTAMP_KEY, System.currentTimeMillis() - Integer.MAX_VALUE - 1);
    given(invoker1.getUrl()).willReturn(url1);
<span class="hljs-deletion">-    Invoker invoker2 = mock(Invoker.class, Mockito.withSettings().stubOnly());</span>
    URL url2 = new ServiceConfigURL("", "", 0, "DemoService", new HashMap&lt;&gt;());
    url2 = url2.addParameter(TIMESTAMP_KEY, System.currentTimeMillis() - 10 * 60 * 1000L - 1);
<span class="hljs-deletion">-    given(invoker2.getUrl()).willReturn(url2);</span>
<span class="hljs-addition">+    Invoker invoker2 = createMockInvokerWithUrl(url2);</span>
    Assertions.assertEquals(balance.getWeight(invoker1, invocation), balance.getWeight(invoker2, invocation));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testGetWeight</span><span class="hljs-params">()</span> </span>{

    RpcInvocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    invocation.setMethodName(<span class="hljs-string">"say"</span>);

    Invoker invoker1 = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">stubOnly</span>())</span>;

    URL url1 = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"DemoService"</span>, <span class="hljs-keyword">new</span> HashMap&lt;&gt;());

    url1 = url1.addParameter(TIMESTAMP_KEY, System.currentTimeMillis() - Integer.MAX_VALUE - <span class="hljs-number">1</span>);

    given(invoker1.getUrl()).willReturn(url1);

    Invoker invoker2 = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">stubOnly</span>())</span>;

    URL url2 = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"DemoService"</span>, <span class="hljs-keyword">new</span> HashMap&lt;&gt;());

    url2 = url2.addParameter(TIMESTAMP_KEY, System.currentTimeMillis() - <span class="hljs-number">10</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000L</span> - <span class="hljs-number">1</span>);

    given(invoker2.getUrl()).willReturn(url2);

    Assertions.assertEquals(balance.getWeight(invoker1, invocation), balance.getWeight(invoker2, invocation));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvokerWithUrl</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">stubOnly</span>())</span>;
    given(invoker.getUrl()).willReturn(url);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest513">Test Case ID #dubbo_Test_51_3</h4>
<h4 id="test-case-name-testgetregistryweightfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclusterloadbalanceabstractloadbalancetestjava">Test Case Name: <code>testGetRegistryWeight</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\loadbalance\AbstractLoadBalanceTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker1">Mock Object Variable Name: <code>invoker1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     invocation.setMethodName("say");
<span class="hljs-deletion">-    Invoker invoker1 = mock(Invoker.class, Mockito.withSettings().stubOnly());</span>
     URL url1 = new ServiceConfigURL("", "", 0, "DemoService", new HashMap&lt;&gt;());
<span class="hljs-deletion">-    given(invoker1.getUrl()).willReturn(url1);</span>
<span class="hljs-addition">+    Invoker invoker1 = createMockInvokerWithUrl(url1);</span>
     ClusterInvoker invoker2 = mock(ClusterInvoker.class, Mockito.withSettings().stubOnly());
     URL url2 = new ServiceConfigURL("", "", 0, "org.apache.dubbo.registry.RegistryService", new HashMap&lt;&gt;());
     url2 = url2.addParameter(WEIGHT_KEY, 20);
     URL registryUrl2 = new ServiceConfigURL("", "", 0, "org.apache.dubbo.registry.RegistryService", new HashMap&lt;&gt;());
     registryUrl2 = registryUrl2.addParameter(WEIGHT_KEY, 30);
     given(invoker2.getUrl()).willReturn(url2);
     given(invoker2.getRegistryUrl()).willReturn(registryUrl2);
     Assertions.assertEquals(100, balance.getWeight(invoker1, invocation));
     Assertions.assertEquals(30, balance.getWeight(invoker2, invocation));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testGetRegistryWeight</span><span class="hljs-params">()</span> </span>{

    RpcInvocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    invocation.setMethodName(<span class="hljs-string">"say"</span>);

    Invoker invoker1 = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">stubOnly</span>())</span>;

    URL url1 = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"DemoService"</span>, <span class="hljs-keyword">new</span> HashMap&lt;&gt;());

    given(invoker1.getUrl()).willReturn(url1);

    ClusterInvoker invoker2 = mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">stubOnly</span>())</span>;

    URL url2 = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, <span class="hljs-keyword">new</span> HashMap&lt;&gt;());

    url2 = url2.addParameter(WEIGHT_KEY, <span class="hljs-number">20</span>);

    URL registryUrl2 = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-number">0</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, <span class="hljs-keyword">new</span> HashMap&lt;&gt;());

    registryUrl2 = registryUrl2.addParameter(WEIGHT_KEY, <span class="hljs-number">30</span>);

    given(invoker2.getUrl()).willReturn(url2);

    given(invoker2.getRegistryUrl()).willReturn(registryUrl2);

    Assertions.assertEquals(<span class="hljs-number">100</span>, balance.getWeight(invoker1, invocation));

    Assertions.assertEquals(<span class="hljs-number">30</span>, balance.getWeight(invoker2, invocation));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker <span class="hljs-title">createMockInvokerWithUrl</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">stubOnly</span>())</span>;
    given(invoker.getUrl()).willReturn(url);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci52">Mock Clone Instance #dubbo_MCI_52</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.config.context.ConfigManager</code></li>
<li><strong>Test Case Count</strong>: 7</li>
<li><strong>MO Count</strong>: 7</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConfigManager <span class="hljs-title">createMockConfigManager</span><span class="hljs-params">(ApplicationConfig applicationConfig)</span> </span>{
    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);
    <span class="hljs-keyword">return</span> configManager;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest521">Test Case ID #dubbo_Test_52_1</h4>
<h4 id="test-case-name-testconsumerurlwithoutprotocolfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testConsumerUrlWithoutProtocol</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-configmanager">Mock Object Variable Name: <code>configManager</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ApplicationConfig applicationConfig = new ApplicationConfig();
    applicationConfig.setName("application1");
<span class="hljs-deletion">-    ConfigManager configManager = mock(ConfigManager.class);</span>
<span class="hljs-deletion">-    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);</span>
<span class="hljs-addition">+    ConfigManager configManager = createMockConfigManager(applicationConfig);</span>
    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration.class);
    when(compositeConfiguration.convert(Boolean.class, ENABLE_CONFIGURATION_LISTEN, true)).thenReturn(true);
    Map&lt;String, String&gt; parameters = new HashMap&lt;&gt;();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify the generated consumer url information

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumerUrlWithoutProtocol</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    <span class="hljs-comment">// verify that the protocol header of consumerUrl is set to "consumer"</span>

    Assertions.assertEquals(<span class="hljs-string">"consumer"</span>, consumerUrl.getProtocol());

    Assertions.assertEquals(parameters.get(REGISTER_IP_KEY), consumerUrl.getHost());

    Assertions.assertFalse(consumerUrl.getAttributes().containsKey(REFER_KEY));

    Assertions.assertEquals(<span class="hljs-string">"value1"</span>, consumerUrl.getAttribute(<span class="hljs-string">"key1"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConfigManager <span class="hljs-title">createMockConfigManager</span><span class="hljs-params">(ApplicationConfig applicationConfig)</span> </span>{
    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);
    <span class="hljs-keyword">return</span> configManager;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest522">Test Case ID #dubbo_Test_52_2</h4>
<h4 id="test-case-name-testconsumerurlwithprotocolfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testConsumerUrlWithProtocol</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-configmanager">Mock Object Variable Name: <code>configManager</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ApplicationConfig applicationConfig = new ApplicationConfig();
    applicationConfig.setName("application1");
<span class="hljs-deletion">-    ConfigManager configManager = mock(ConfigManager.class);</span>
<span class="hljs-deletion">-    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);</span>
<span class="hljs-addition">+    ConfigManager configManager = createMockConfigManager(applicationConfig);</span>
    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration.class);
    when(compositeConfiguration.convert(Boolean.class, ENABLE_CONFIGURATION_LISTEN, true)).thenReturn(true);
    Map&lt;String, String&gt; parameters = new HashMap&lt;&gt;();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that when the protocol is configured, the protocol of consumer url is the configured protocol

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumerUrlWithProtocol</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    parameters.put(PROTOCOL_KEY, <span class="hljs-string">"tri"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    <span class="hljs-comment">// verify that the protocol of consumer url</span>

    Assertions.assertEquals(<span class="hljs-string">"tri"</span>, consumerUrl.getProtocol());

    Assertions.assertEquals(parameters.get(REGISTER_IP_KEY), consumerUrl.getHost());

    Assertions.assertFalse(consumerUrl.getAttributes().containsKey(REFER_KEY));

    Assertions.assertEquals(<span class="hljs-string">"value1"</span>, consumerUrl.getAttribute(<span class="hljs-string">"key1"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConfigManager <span class="hljs-title">createMockConfigManager</span><span class="hljs-params">(ApplicationConfig applicationConfig)</span> </span>{
    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);
    <span class="hljs-keyword">return</span> configManager;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest523">Test Case ID #dubbo_Test_52_3</h4>
<h4 id="test-case-name-testreferwithoutgroupfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testReferWithoutGroup</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-configmanager">Mock Object Variable Name: <code>configManager</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ApplicationConfig applicationConfig = new ApplicationConfig();
    applicationConfig.setName("application1");
<span class="hljs-deletion">-    ConfigManager configManager = mock(ConfigManager.class);</span>
<span class="hljs-deletion">-    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);</span>
<span class="hljs-addition">+    ConfigManager configManager = createMockConfigManager(applicationConfig);</span>
    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration.class);
    when(compositeConfiguration.convert(Boolean.class, ENABLE_CONFIGURATION_LISTEN, true)).thenReturn(true);
    Map&lt;String, String&gt; parameters = new HashMap&lt;&gt;();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that if multiple groups are not configured, the service reference of the registration center

 * the default is FailoverCluster

 *

 * <span class="hljs-doctag">@see</span> FailoverCluster

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testReferWithoutGroup</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Invoker&lt;?&gt; invoker = registryProtocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    Assertions.assertTrue(((MigrationInvoker&lt;?&gt;) invoker).getCluster() <span class="hljs-keyword">instanceof</span> ScopeClusterWrapper);

    Assertions.assertTrue(((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> MockClusterWrapper);

    Assertions.assertTrue(((MockClusterWrapper) ((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> FailoverCluster);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConfigManager <span class="hljs-title">createMockConfigManager</span><span class="hljs-params">(ApplicationConfig applicationConfig)</span> </span>{
    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);
    <span class="hljs-keyword">return</span> configManager;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest524">Test Case ID #dubbo_Test_52_4</h4>
<h4 id="test-case-name-testreferwithgroupfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testReferWithGroup</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-configmanager">Mock Object Variable Name: <code>configManager</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ApplicationConfig applicationConfig = new ApplicationConfig();
    applicationConfig.setName("application1");
<span class="hljs-deletion">-    ConfigManager configManager = mock(ConfigManager.class);</span>
<span class="hljs-deletion">-    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);</span>
<span class="hljs-addition">+    ConfigManager configManager = createMockConfigManager(applicationConfig);</span>
    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration.class);
    when(compositeConfiguration.convert(Boolean.class, ENABLE_CONFIGURATION_LISTEN, true)).thenReturn(true);
    Map&lt;String, String&gt; parameters = new HashMap&lt;&gt;();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that if multiple groups are configured, the service reference of the registration center

 *

 * <span class="hljs-doctag">@see</span> MergeableCluster

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testReferWithGroup</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    refer.put(GROUP_KEY, <span class="hljs-string">"group1,group2"</span>);

    attributes.put(REFER_KEY, refer);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Invoker&lt;?&gt; invoker = registryProtocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    Assertions.assertTrue(((MigrationInvoker&lt;?&gt;) invoker).getCluster() <span class="hljs-keyword">instanceof</span> ScopeClusterWrapper);

    Assertions.assertTrue(((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> MockClusterWrapper);

    Assertions.assertTrue(((MockClusterWrapper) ((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> MergeableCluster);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConfigManager <span class="hljs-title">createMockConfigManager</span><span class="hljs-params">(ApplicationConfig applicationConfig)</span> </span>{
    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);
    <span class="hljs-keyword">return</span> configManager;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest525">Test Case ID #dubbo_Test_52_5</h4>
<h4 id="test-case-name-testinterceptinvokerformigrationrulelistenerfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testInterceptInvokerForMigrationRuleListener</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-configmanager">Mock Object Variable Name: <code>configManager</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ApplicationConfig applicationConfig = new ApplicationConfig();
    applicationConfig.setName("application1");
<span class="hljs-deletion">-    ConfigManager configManager = mock(ConfigManager.class);</span>
<span class="hljs-deletion">-    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);</span>
<span class="hljs-addition">+    ConfigManager configManager = createMockConfigManager(applicationConfig);</span>
    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration.class);
    when(compositeConfiguration.convert(Boolean.class, ENABLE_CONFIGURATION_LISTEN, true)).thenReturn(true);
    Map&lt;String, String&gt; parameters = new HashMap&lt;&gt;();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that the default RegistryProtocolListener will be executed

 *

 * <span class="hljs-doctag">@see</span> MigrationRuleListener

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInterceptInvokerForMigrationRuleListener</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    refer.put(GROUP_KEY, <span class="hljs-string">"group1,group2"</span>);

    attributes.put(REFER_KEY, refer);

    URL url = serviceConfigURL.addAttributes(attributes);

    MigrationInvoker&lt;?&gt; clusterInvoker = mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Map&lt;String, Object&gt; consumerAttribute = <span class="hljs-keyword">new</span> HashMap&lt;&gt;(url.getAttributes());

    consumerAttribute.remove(REFER_KEY);

    URL consumerUrl = <span class="hljs-keyword">new</span> ServiceConfigURL(parameters.get(PROTOCOL_KEY) == <span class="hljs-keyword">null</span> ? DUBBO : parameters.get(PROTOCOL_KEY), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, parameters.get(REGISTER_IP_KEY), <span class="hljs-number">0</span>, url.getPath(), parameters, consumerAttribute);

    url = url.putAttribute(CONSUMER_URL_KEY, consumerUrl);

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    registryProtocol.interceptInvoker(clusterInvoker, url, consumerUrl);

    verify(migrationRuleListener, times(<span class="hljs-number">1</span>)).onRefer(registryProtocol, clusterInvoker, consumerUrl, url);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConfigManager <span class="hljs-title">createMockConfigManager</span><span class="hljs-params">(ApplicationConfig applicationConfig)</span> </span>{
    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);
    <span class="hljs-keyword">return</span> configManager;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest526">Test Case ID #dubbo_Test_52_6</h4>
<h4 id="test-case-name-testinterceptinvokerforcustomregistryprotocollistenerfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testInterceptInvokerForCustomRegistryProtocolListener</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-configmanager">Mock Object Variable Name: <code>configManager</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ApplicationConfig applicationConfig = new ApplicationConfig();
    applicationConfig.setName("application1");
<span class="hljs-deletion">-    ConfigManager configManager = mock(ConfigManager.class);</span>
<span class="hljs-deletion">-    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);</span>
<span class="hljs-addition">+    ConfigManager configManager = createMockConfigManager(applicationConfig);</span>
    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration.class);
    when(compositeConfiguration.convert(Boolean.class, ENABLE_CONFIGURATION_LISTEN, true)).thenReturn(true);
    Map&lt;String, String&gt; parameters = new HashMap&lt;&gt;();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Verify that if registry.protocol.listener is configured,

 * whether the corresponding RegistryProtocolListener will be executed normally

 *

 * <span class="hljs-doctag">@see</span> CountRegistryProtocolListener

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInterceptInvokerForCustomRegistryProtocolListener</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    parameters.put(REGISTRY_PROTOCOL_LISTENER_KEY, <span class="hljs-string">"count"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    refer.put(GROUP_KEY, <span class="hljs-string">"group1,group2"</span>);

    attributes.put(REFER_KEY, refer);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    MigrationInvoker&lt;?&gt; clusterInvoker = mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Map&lt;String, Object&gt; consumerAttribute = <span class="hljs-keyword">new</span> HashMap&lt;&gt;(url.getAttributes());

    consumerAttribute.remove(REFER_KEY);

    URL consumerUrl = <span class="hljs-keyword">new</span> ServiceConfigURL(parameters.get(PROTOCOL_KEY) == <span class="hljs-keyword">null</span> ? DUBBO : parameters.get(PROTOCOL_KEY), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, parameters.get(REGISTER_IP_KEY), <span class="hljs-number">0</span>, url.getPath(), parameters, consumerAttribute);

    url = url.putAttribute(CONSUMER_URL_KEY, consumerUrl);

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(<span class="hljs-keyword">new</span> CountRegistryProtocolListener());

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    registryProtocol.interceptInvoker(clusterInvoker, url, consumerUrl);

    Assertions.assertEquals(<span class="hljs-number">1</span>, CountRegistryProtocolListener.getReferCounter().get());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConfigManager <span class="hljs-title">createMockConfigManager</span><span class="hljs-params">(ApplicationConfig applicationConfig)</span> </span>{
    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);
    <span class="hljs-keyword">return</span> configManager;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest527">Test Case ID #dubbo_Test_52_7</h4>
<h4 id="test-case-name-testregisterconsumerurlfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testRegisterConsumerUrl</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-configmanager">Mock Object Variable Name: <code>configManager</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     applicationConfig.setName("application1");
<span class="hljs-deletion">-    ConfigManager configManager = mock(ConfigManager.class);</span>
<span class="hljs-deletion">-    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);</span>
<span class="hljs-addition">+    ConfigManager configManager = createMockConfigManager(applicationConfig);</span>
     CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration.class);
     when(compositeConfiguration.convert(Boolean.class, ENABLE_CONFIGURATION_LISTEN, true)).thenReturn(true);
     Map&lt;String, String&gt; parameters = new HashMap&lt;&gt;();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify the registered consumer url

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRegisterConsumerUrl</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"true"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);

    url = url.setScopeModel(moduleModel);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    Map&lt;String, String&gt; urlParameters = consumerUrl.getParameters();

    URL urlToRegistry = <span class="hljs-keyword">new</span> ServiceConfigURL(urlParameters.get(PROTOCOL_KEY) == <span class="hljs-keyword">null</span> ? CONSUMER : urlParameters.get(PROTOCOL_KEY), urlParameters.remove(REGISTER_IP_KEY), <span class="hljs-number">0</span>, consumerUrl.getPath(), urlParameters);

    URL registeredConsumerUrl = urlToRegistry.addParameters(CATEGORY_KEY, CONSUMERS_CATEGORY, CHECK_KEY, String.valueOf(<span class="hljs-keyword">false</span>)).setScopeModel(moduleModel);

    verify(registry, times(<span class="hljs-number">1</span>)).register(registeredConsumerUrl);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConfigManager <span class="hljs-title">createMockConfigManager</span><span class="hljs-params">(ApplicationConfig applicationConfig)</span> </span>{
    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);
    <span class="hljs-keyword">return</span> configManager;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci53">Mock Clone Instance #dubbo_MCI_53</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.registry.NotifyListener</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
    NotifyListener notifyListener = mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
    <span class="hljs-keyword">return</span> notifyListener;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest531">Test Case ID #dubbo_Test_53_1</h4>
<h4 id="test-case-name-testsubscribeurlsfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientservicediscoveryregistrytestjava">Test Case Name: <code>testSubscribeURLs</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\ServiceDiscoveryRegistryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-testservicelistener2">Mock Object Variable Name: <code>testServiceListener2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    assertEquals(urls, captor.getValue());
    // different interface mapping to the same apps
<span class="hljs-deletion">-    NotifyListener testServiceListener2 = mock(NotifyListener.class);</span>
     URL url2 = URL.valueOf("tri://127.0.0.1/TestService2?interface=TestService2&amp;check=false&amp;protocol=tri");
<span class="hljs-deletion">-    when(testServiceListener2.getConsumerUrl()).thenReturn(url2);</span>
<span class="hljs-addition">+    NotifyListener testServiceListener2 = createMockNotifyListener(url2);</span>
     serviceDiscoveryRegistry.subscribeURLs(url2, testServiceListener2, multiApps);
     // check instance listeners not changed, methods not called
     assertEquals(2, serviceDiscoveryRegistry.getServiceListeners().size());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Test instance listener registration

 * - one app

 * - multi apps

 * - repeat same multi apps, instance listener shared

 * - protocol included in key

 * - instance listener gets notified

 * - instance listener and service listener rightly mapped

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testSubscribeURLs</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// interface to single app mapping</span>

    Set&lt;String&gt; singleApp = <span class="hljs-keyword">new</span> TreeSet&lt;&gt;();

    singleApp.add(APP_NAME1);

    serviceDiscoveryRegistry.subscribeURLs(url, testServiceListener, singleApp);

    assertEquals(<span class="hljs-number">1</span>, serviceDiscoveryRegistry.getServiceListeners().size());

    verify(testServiceListener, times(<span class="hljs-number">1</span>)).addServiceListener(instanceListener);

    verify(instanceListener, never()).onEvent(any());

    verify(serviceDiscovery, times(<span class="hljs-number">1</span>)).addServiceInstancesChangedListener(instanceListener);

    <span class="hljs-comment">// interface to multiple apps mapping</span>

    Set&lt;String&gt; multiApps = <span class="hljs-keyword">new</span> TreeSet&lt;&gt;();

    multiApps.add(APP_NAME1);

    multiApps.add(APP_NAME2);

    MockServiceInstancesChangedListener multiAppsInstanceListener = spy(<span class="hljs-keyword">new</span> MockServiceInstancesChangedListener(multiApps, serviceDiscovery));

    doNothing().when(multiAppsInstanceListener).onEvent(any());

    List&lt;URL&gt; urls = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urls.add(URL.valueOf(<span class="hljs-string">"dubbo://127.0.0.1:20880/TestService"</span>));

    doReturn(urls).when(multiAppsInstanceListener).getAddresses(any(), any());

    when(serviceDiscovery.createListener(multiApps)).thenReturn(multiAppsInstanceListener);

    when(serviceDiscovery.getInstances(APP_NAME1)).thenReturn(instanceList1);

    when(serviceDiscovery.getInstances(APP_NAME2)).thenReturn(instanceList2);

    serviceDiscoveryRegistry.subscribeURLs(url, testServiceListener, multiApps);

    assertEquals(<span class="hljs-number">2</span>, serviceDiscoveryRegistry.getServiceListeners().size());

    assertEquals(instanceListener, serviceDiscoveryRegistry.getServiceListeners().get(toStringKeys(singleApp)));

    assertEquals(multiAppsInstanceListener, serviceDiscoveryRegistry.getServiceListeners().get(toStringKeys(multiApps)));

    verify(testServiceListener, times(<span class="hljs-number">1</span>)).addServiceListener(multiAppsInstanceListener);

    verify(multiAppsInstanceListener, times(<span class="hljs-number">2</span>)).onEvent(any());

    verify(multiAppsInstanceListener, times(<span class="hljs-number">1</span>)).addListenerAndNotify(any(), eq(testServiceListener));

    verify(serviceDiscovery, times(<span class="hljs-number">1</span>)).addServiceInstancesChangedListener(multiAppsInstanceListener);

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(testServiceListener).notify(captor.capture());

    assertEquals(urls, captor.getValue());

    <span class="hljs-comment">// different interface mapping to the same apps</span>

    NotifyListener testServiceListener2 = mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url2 = URL.valueOf(<span class="hljs-string">"tri://127.0.0.1/TestService2?interface=TestService2&amp;check=false&amp;protocol=tri"</span>);

    when(testServiceListener2.getConsumerUrl()).thenReturn(url2);

    serviceDiscoveryRegistry.subscribeURLs(url2, testServiceListener2, multiApps);

    <span class="hljs-comment">// check instance listeners not changed, methods not called</span>

    assertEquals(<span class="hljs-number">2</span>, serviceDiscoveryRegistry.getServiceListeners().size());

    assertEquals(multiAppsInstanceListener, serviceDiscoveryRegistry.getServiceListeners().get(toStringKeys(multiApps)));

    verify(multiAppsInstanceListener, times(<span class="hljs-number">1</span>)).addListenerAndNotify(any(), eq(testServiceListener));

    <span class="hljs-comment">// still called once, not executed this time</span>

    verify(serviceDiscovery, times(<span class="hljs-number">2</span>)).addServiceInstancesChangedListener(multiAppsInstanceListener);

    <span class="hljs-comment">// check different protocol</span>

    Map&lt;String, Set&lt;ServiceInstancesChangedListener.NotifyListenerWithKey&gt;&gt; serviceListeners = multiAppsInstanceListener.getServiceListeners();

    assertEquals(<span class="hljs-number">2</span>, serviceListeners.size());

    assertEquals(<span class="hljs-number">1</span>, serviceListeners.get(url.getServiceKey()).size());

    assertEquals(<span class="hljs-number">1</span>, serviceListeners.get(url2.getServiceKey()).size());

    ProtocolServiceKey protocolServiceKey = <span class="hljs-keyword">new</span> ProtocolServiceKey(url2.getServiceInterface(), url2.getVersion(), url2.getGroup(), url2.getParameter(PROTOCOL_KEY, DUBBO));

    assertTrue(serviceListeners.get(url2.getServiceKey()).contains(<span class="hljs-keyword">new</span> ServiceInstancesChangedListener.NotifyListenerWithKey(protocolServiceKey, testServiceListener2)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
    NotifyListener notifyListener = mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
    <span class="hljs-keyword">return</span> notifyListener;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest532">Test Case ID #dubbo_Test_53_2</h4>
<h4 id="test-case-name-testunsubscribefile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientservicediscoveryregistrytestjava">Test Case Name: <code>testUnsubscribe</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\ServiceDiscoveryRegistryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-testservicelistener2">Mock Object Variable Name: <code>testServiceListener2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    multiApps.add(APP_NAME1);
    multiApps.add(APP_NAME2);
<span class="hljs-deletion">-    NotifyListener testServiceListener2 = mock(NotifyListener.class);</span>
    URL url2 = URL.valueOf("consumer://127.0.0.1/TestService2?interface=TestService1&amp;check=false&amp;protocol=tri");
<span class="hljs-deletion">-    when(testServiceListener2.getConsumerUrl()).thenReturn(url2);</span>
<span class="hljs-addition">+    NotifyListener testServiceListener2 = createMockNotifyListener(url2);</span>
    serviceDiscoveryRegistry.subscribeURLs(url, testServiceListener, multiApps);
    serviceDiscoveryRegistry.subscribeURLs(url2, testServiceListener2, multiApps);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testUnsubscribe</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// do subscribe to prepare for unsubscribe verification</span>

    Set&lt;String&gt; multiApps = <span class="hljs-keyword">new</span> TreeSet&lt;&gt;();

    multiApps.add(APP_NAME1);

    multiApps.add(APP_NAME2);

    NotifyListener testServiceListener2 = mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url2 = URL.valueOf(<span class="hljs-string">"consumer://127.0.0.1/TestService2?interface=TestService1&amp;check=false&amp;protocol=tri"</span>);

    when(testServiceListener2.getConsumerUrl()).thenReturn(url2);

    serviceDiscoveryRegistry.subscribeURLs(url, testServiceListener, multiApps);

    serviceDiscoveryRegistry.subscribeURLs(url2, testServiceListener2, multiApps);

    assertEquals(<span class="hljs-number">1</span>, serviceDiscoveryRegistry.getServiceListeners().size());

    <span class="hljs-comment">// do unsubscribe</span>

    when(mapping.getMapping(url2)).thenReturn(multiApps);

    serviceDiscoveryRegistry.doUnsubscribe(url2, testServiceListener2);

    assertEquals(<span class="hljs-number">1</span>, serviceDiscoveryRegistry.getServiceListeners().size());

    ServiceInstancesChangedListener instancesChangedListener = serviceDiscoveryRegistry.getServiceListeners().entrySet().iterator().next().getValue();

    assertTrue(instancesChangedListener.hasListeners());

    when(mapping.getMapping(url)).thenReturn(multiApps);

    serviceDiscoveryRegistry.doUnsubscribe(url, testServiceListener);

    assertEquals(<span class="hljs-number">0</span>, serviceDiscoveryRegistry.getServiceListeners().size());

    assertFalse(instancesChangedListener.hasListeners());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
    NotifyListener notifyListener = mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
    <span class="hljs-keyword">return</span> notifyListener;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest533">Test Case ID #dubbo_Test_53_3</h4>
<h4 id="test-case-name-testsubscribeurlsfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientservicediscoveryregistrytestjava">Test Case Name: <code>testSubscribeURLs</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\ServiceDiscoveryRegistryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-testservicelistener">Mock Object Variable Name: <code>testServiceListener</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- a/TestClass.java</span>
<span class="hljs-comment">+++ b/TestClass.java</span>
@@
<span class="hljs-deletion">-    private static NotifyListener testServiceListener = mock(NotifyListener.class);</span>
<span class="hljs-addition">+    private static NotifyListener testServiceListener;</span>
     
@@
<span class="hljs-deletion">-    when(testServiceListener.getConsumerUrl()).thenReturn(url);</span>
<span class="hljs-addition">+    testServiceListener = createMockNotifyListener(url);</span>
     
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>{

    serviceDiscovery = mock(ServiceDiscovery<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    instanceListener = spy(<span class="hljs-keyword">new</span> MockServiceInstancesChangedListener(Collections.emptySet(), serviceDiscovery));

    doNothing().when(instanceListener).onEvent(any());

    when(serviceDiscovery.createListener(any())).thenReturn(instanceListener);

    when(serviceDiscovery.getInstances(any())).thenReturn(Collections.emptyList());

    when(serviceDiscovery.getUrl()).thenReturn(url);

    ApplicationModel applicationModel = spy(ApplicationModel.defaultModel());

    when(applicationModel.getDefaultExtension(ServiceNameMapping<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">mapping</span>)</span>;

    registryURL = registryURL.setScopeModel(applicationModel);

    serviceDiscoveryRegistry = <span class="hljs-keyword">new</span> ServiceDiscoveryRegistry(registryURL, serviceDiscovery, mapping);

    when(mapping.getMappingLock(any())).thenReturn(lock);

    when(testServiceListener.getConsumerUrl()).thenReturn(url);

}
<span class="hljs-comment">/**

 * Test instance listener registration

 * - one app

 * - multi apps

 * - repeat same multi apps, instance listener shared

 * - protocol included in key

 * - instance listener gets notified

 * - instance listener and service listener rightly mapped

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testSubscribeURLs</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// interface to single app mapping</span>

    Set&lt;String&gt; singleApp = <span class="hljs-keyword">new</span> TreeSet&lt;&gt;();

    singleApp.add(APP_NAME1);

    serviceDiscoveryRegistry.subscribeURLs(url, testServiceListener, singleApp);

    assertEquals(<span class="hljs-number">1</span>, serviceDiscoveryRegistry.getServiceListeners().size());

    verify(testServiceListener, times(<span class="hljs-number">1</span>)).addServiceListener(instanceListener);

    verify(instanceListener, never()).onEvent(any());

    verify(serviceDiscovery, times(<span class="hljs-number">1</span>)).addServiceInstancesChangedListener(instanceListener);

    <span class="hljs-comment">// interface to multiple apps mapping</span>

    Set&lt;String&gt; multiApps = <span class="hljs-keyword">new</span> TreeSet&lt;&gt;();

    multiApps.add(APP_NAME1);

    multiApps.add(APP_NAME2);

    MockServiceInstancesChangedListener multiAppsInstanceListener = spy(<span class="hljs-keyword">new</span> MockServiceInstancesChangedListener(multiApps, serviceDiscovery));

    doNothing().when(multiAppsInstanceListener).onEvent(any());

    List&lt;URL&gt; urls = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    urls.add(URL.valueOf(<span class="hljs-string">"dubbo://127.0.0.1:20880/TestService"</span>));

    doReturn(urls).when(multiAppsInstanceListener).getAddresses(any(), any());

    when(serviceDiscovery.createListener(multiApps)).thenReturn(multiAppsInstanceListener);

    when(serviceDiscovery.getInstances(APP_NAME1)).thenReturn(instanceList1);

    when(serviceDiscovery.getInstances(APP_NAME2)).thenReturn(instanceList2);

    serviceDiscoveryRegistry.subscribeURLs(url, testServiceListener, multiApps);

    assertEquals(<span class="hljs-number">2</span>, serviceDiscoveryRegistry.getServiceListeners().size());

    assertEquals(instanceListener, serviceDiscoveryRegistry.getServiceListeners().get(toStringKeys(singleApp)));

    assertEquals(multiAppsInstanceListener, serviceDiscoveryRegistry.getServiceListeners().get(toStringKeys(multiApps)));

    verify(testServiceListener, times(<span class="hljs-number">1</span>)).addServiceListener(multiAppsInstanceListener);

    verify(multiAppsInstanceListener, times(<span class="hljs-number">2</span>)).onEvent(any());

    verify(multiAppsInstanceListener, times(<span class="hljs-number">1</span>)).addListenerAndNotify(any(), eq(testServiceListener));

    verify(serviceDiscovery, times(<span class="hljs-number">1</span>)).addServiceInstancesChangedListener(multiAppsInstanceListener);

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    verify(testServiceListener).notify(captor.capture());

    assertEquals(urls, captor.getValue());

    <span class="hljs-comment">// different interface mapping to the same apps</span>

    NotifyListener testServiceListener2 = mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url2 = URL.valueOf(<span class="hljs-string">"tri://127.0.0.1/TestService2?interface=TestService2&amp;check=false&amp;protocol=tri"</span>);

    when(testServiceListener2.getConsumerUrl()).thenReturn(url2);

    serviceDiscoveryRegistry.subscribeURLs(url2, testServiceListener2, multiApps);

    <span class="hljs-comment">// check instance listeners not changed, methods not called</span>

    assertEquals(<span class="hljs-number">2</span>, serviceDiscoveryRegistry.getServiceListeners().size());

    assertEquals(multiAppsInstanceListener, serviceDiscoveryRegistry.getServiceListeners().get(toStringKeys(multiApps)));

    verify(multiAppsInstanceListener, times(<span class="hljs-number">1</span>)).addListenerAndNotify(any(), eq(testServiceListener));

    <span class="hljs-comment">// still called once, not executed this time</span>

    verify(serviceDiscovery, times(<span class="hljs-number">2</span>)).addServiceInstancesChangedListener(multiAppsInstanceListener);

    <span class="hljs-comment">// check different protocol</span>

    Map&lt;String, Set&lt;ServiceInstancesChangedListener.NotifyListenerWithKey&gt;&gt; serviceListeners = multiAppsInstanceListener.getServiceListeners();

    assertEquals(<span class="hljs-number">2</span>, serviceListeners.size());

    assertEquals(<span class="hljs-number">1</span>, serviceListeners.get(url.getServiceKey()).size());

    assertEquals(<span class="hljs-number">1</span>, serviceListeners.get(url2.getServiceKey()).size());

    ProtocolServiceKey protocolServiceKey = <span class="hljs-keyword">new</span> ProtocolServiceKey(url2.getServiceInterface(), url2.getVersion(), url2.getGroup(), url2.getParameter(PROTOCOL_KEY, DUBBO));

    assertTrue(serviceListeners.get(url2.getServiceKey()).contains(<span class="hljs-keyword">new</span> ServiceInstancesChangedListener.NotifyListenerWithKey(protocolServiceKey, testServiceListener2)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
    NotifyListener notifyListener = mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
    <span class="hljs-keyword">return</span> notifyListener;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci54">Mock Clone Instance #dubbo_MCI_54</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.registry.NotifyListener</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 22</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest541">Test Case ID #dubbo_Test_54_1</h4>
<h4 id="test-case-name-testservicelistenernotificationfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenertestjava">Test Case Name: <code>testServiceListenerNotification</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservicelistener">Mock Object Variable Name: <code>demoServiceListener</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    listener = new ServiceInstancesChangedListener(serviceNames, serviceDiscovery);
<span class="hljs-deletion">-    NotifyListener demoServiceListener = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoServiceListener.getConsumerUrl()).thenReturn(consumerURL);</span>
<span class="hljs-addition">+    NotifyListener demoServiceListener = MockNotifyListener.createMockNotifyListener(consumerURL);</span>
    NotifyListener demoService2Listener = Mockito.mock(NotifyListener.class);
    when(demoService2Listener.getConsumerUrl()).thenReturn(consumerURL2);
    listener.addListenerAndNotify(consumerURL, demoServiceListener);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// instance listener -&gt; service listener(Directory)</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">5</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testServiceListenerNotification</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    serviceNames.add(<span class="hljs-string">"app2"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    NotifyListener demoServiceListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoService2Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener.getConsumerUrl()).thenReturn(consumerURL2);

    listener.addListenerAndNotify(consumerURL, demoServiceListener);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1Instances);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener, Mockito.times(<span class="hljs-number">1</span>)).notify(captor.capture());

    List&lt;URL&gt; notifiedUrls = captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">3</span>, notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(captor2.capture());

    List&lt;URL&gt; notifiedUrls2 = captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">0</span>, notifiedUrls2.size());

    <span class="hljs-comment">// notify app2 instance change</span>

    ServiceInstancesChangedEvent app2_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app2"</span>, app2Instances);

    listener.onEvent(app2_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor.capture());

    List&lt;URL&gt; app2_notifiedUrls = app2_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">7</span>, app2_notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor2.capture());

    List&lt;URL&gt; app2_notifiedUrls2 = app2_captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, app2_notifiedUrls2.size());

    <span class="hljs-comment">// test service listener still get notified when added after instance notification.</span>

    NotifyListener demoService3Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);

    listener.addListenerAndNotify(consumerURL3, demoService3Listener);

    Mockito.verify(demoService3Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(Mockito.anyList());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest542">Test Case ID #dubbo_Test_54_2</h4>
<h4 id="test-case-name-testservicelistenernotificationfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenertestjava">Test Case Name: <code>testServiceListenerNotification</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservice2listener">Mock Object Variable Name: <code>demoService2Listener</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    NotifyListener demoServiceListener = Mockito.mock(NotifyListener.class);
    when(demoServiceListener.getConsumerUrl()).thenReturn(consumerURL);
<span class="hljs-deletion">-    NotifyListener demoService2Listener = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoService2Listener.getConsumerUrl()).thenReturn(consumerURL2);</span>
<span class="hljs-addition">+    NotifyListener demoService2Listener = MockNotifyListener.createMockNotifyListener(consumerURL2);</span>
    listener.addListenerAndNotify(consumerURL, demoServiceListener);
    listener.addListenerAndNotify(consumerURL2, demoService2Listener);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// instance listener -&gt; service listener(Directory)</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">5</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testServiceListenerNotification</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    serviceNames.add(<span class="hljs-string">"app2"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    NotifyListener demoServiceListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoService2Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener.getConsumerUrl()).thenReturn(consumerURL2);

    listener.addListenerAndNotify(consumerURL, demoServiceListener);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1Instances);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener, Mockito.times(<span class="hljs-number">1</span>)).notify(captor.capture());

    List&lt;URL&gt; notifiedUrls = captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">3</span>, notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(captor2.capture());

    List&lt;URL&gt; notifiedUrls2 = captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">0</span>, notifiedUrls2.size());

    <span class="hljs-comment">// notify app2 instance change</span>

    ServiceInstancesChangedEvent app2_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app2"</span>, app2Instances);

    listener.onEvent(app2_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor.capture());

    List&lt;URL&gt; app2_notifiedUrls = app2_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">7</span>, app2_notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor2.capture());

    List&lt;URL&gt; app2_notifiedUrls2 = app2_captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, app2_notifiedUrls2.size());

    <span class="hljs-comment">// test service listener still get notified when added after instance notification.</span>

    NotifyListener demoService3Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);

    listener.addListenerAndNotify(consumerURL3, demoService3Listener);

    Mockito.verify(demoService3Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(Mockito.anyList());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest543">Test Case ID #dubbo_Test_54_3</h4>
<h4 id="test-case-name-testservicelistenernotificationfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenertestjava">Test Case Name: <code>testServiceListenerNotification</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservice3listener">Mock Object Variable Name: <code>demoService3Listener</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     // test service listener still get notified when added after instance notification.
<span class="hljs-deletion">-    NotifyListener demoService3Listener = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);</span>
<span class="hljs-addition">+    NotifyListener demoService3Listener = MockNotifyListener.createMockNotifyListener(consumerURL3);</span>
     listener.addListenerAndNotify(consumerURL3, demoService3Listener);
     Mockito.verify(demoService3Listener, Mockito.times(1)).notify(Mockito.anyList());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// instance listener -&gt; service listener(Directory)</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">5</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testServiceListenerNotification</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    serviceNames.add(<span class="hljs-string">"app2"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    NotifyListener demoServiceListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoService2Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener.getConsumerUrl()).thenReturn(consumerURL2);

    listener.addListenerAndNotify(consumerURL, demoServiceListener);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1Instances);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener, Mockito.times(<span class="hljs-number">1</span>)).notify(captor.capture());

    List&lt;URL&gt; notifiedUrls = captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">3</span>, notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(captor2.capture());

    List&lt;URL&gt; notifiedUrls2 = captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">0</span>, notifiedUrls2.size());

    <span class="hljs-comment">// notify app2 instance change</span>

    ServiceInstancesChangedEvent app2_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app2"</span>, app2Instances);

    listener.onEvent(app2_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor.capture());

    List&lt;URL&gt; app2_notifiedUrls = app2_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">7</span>, app2_notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor2.capture());

    List&lt;URL&gt; app2_notifiedUrls2 = app2_captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, app2_notifiedUrls2.size());

    <span class="hljs-comment">// test service listener still get notified when added after instance notification.</span>

    NotifyListener demoService3Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);

    listener.addListenerAndNotify(consumerURL3, demoService3Listener);

    Mockito.verify(demoService3Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(Mockito.anyList());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest544">Test Case ID #dubbo_Test_54_4</h4>
<h4 id="test-case-name-testmultiservicelistenernotificationfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenertestjava">Test Case Name: <code>testMultiServiceListenerNotification</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservicelistener1">Mock Object Variable Name: <code>demoServiceListener1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    listener = new ServiceInstancesChangedListener(serviceNames, serviceDiscovery);
<span class="hljs-deletion">-    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoServiceListener1.getConsumerUrl()).thenReturn(consumerURL);</span>
<span class="hljs-addition">+    NotifyListener demoServiceListener1 = MockNotifyListener.createMockNotifyListener(consumerURL);</span>
    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener.class);
    when(demoServiceListener2.getConsumerUrl()).thenReturn(consumerURL);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">6</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMultiServiceListenerNotification</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    serviceNames.add(<span class="hljs-string">"app2"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener1.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener2.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoService2Listener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener1.getConsumerUrl()).thenReturn(consumerURL2);

    NotifyListener demoService2Listener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener2.getConsumerUrl()).thenReturn(consumerURL2);

    listener.addListenerAndNotify(consumerURL, demoServiceListener1);

    listener.addListenerAndNotify(consumerURL, demoServiceListener2);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener1);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener2);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1Instances);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor.capture());

    List&lt;URL&gt; notifiedUrls = captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">3</span>, notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor2.capture());

    List&lt;URL&gt; notifiedUrls2 = captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">0</span>, notifiedUrls2.size());

    <span class="hljs-comment">// notify app2 instance change</span>

    ServiceInstancesChangedEvent app2_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app2"</span>, app2Instances);

    listener.onEvent(app2_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor.capture());

    List&lt;URL&gt; app2_notifiedUrls = app2_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">7</span>, app2_notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor2.capture());

    List&lt;URL&gt; app2_notifiedUrls2 = app2_captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, app2_notifiedUrls2.size());

    <span class="hljs-comment">// test service listener still get notified when added after instance notification.</span>

    NotifyListener demoService3Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);

    listener.addListenerAndNotify(consumerURL3, demoService3Listener);

    Mockito.verify(demoService3Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(Mockito.anyList());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest545">Test Case ID #dubbo_Test_54_5</h4>
<h4 id="test-case-name-testmultiservicelistenernotificationfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenertestjava">Test Case Name: <code>testMultiServiceListenerNotification</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservicelistener2">Mock Object Variable Name: <code>demoServiceListener2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener.class);
    when(demoServiceListener1.getConsumerUrl()).thenReturn(consumerURL);
<span class="hljs-deletion">-    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoServiceListener2.getConsumerUrl()).thenReturn(consumerURL);</span>
<span class="hljs-addition">+    NotifyListener demoServiceListener2 = MockNotifyListener.createMockNotifyListener(consumerURL);</span>
    NotifyListener demoService2Listener1 = Mockito.mock(NotifyListener.class);
    when(demoService2Listener1.getConsumerUrl()).thenReturn(consumerURL2);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">6</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMultiServiceListenerNotification</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    serviceNames.add(<span class="hljs-string">"app2"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener1.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener2.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoService2Listener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener1.getConsumerUrl()).thenReturn(consumerURL2);

    NotifyListener demoService2Listener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener2.getConsumerUrl()).thenReturn(consumerURL2);

    listener.addListenerAndNotify(consumerURL, demoServiceListener1);

    listener.addListenerAndNotify(consumerURL, demoServiceListener2);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener1);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener2);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1Instances);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor.capture());

    List&lt;URL&gt; notifiedUrls = captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">3</span>, notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor2.capture());

    List&lt;URL&gt; notifiedUrls2 = captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">0</span>, notifiedUrls2.size());

    <span class="hljs-comment">// notify app2 instance change</span>

    ServiceInstancesChangedEvent app2_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app2"</span>, app2Instances);

    listener.onEvent(app2_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor.capture());

    List&lt;URL&gt; app2_notifiedUrls = app2_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">7</span>, app2_notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor2.capture());

    List&lt;URL&gt; app2_notifiedUrls2 = app2_captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, app2_notifiedUrls2.size());

    <span class="hljs-comment">// test service listener still get notified when added after instance notification.</span>

    NotifyListener demoService3Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);

    listener.addListenerAndNotify(consumerURL3, demoService3Listener);

    Mockito.verify(demoService3Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(Mockito.anyList());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest546">Test Case ID #dubbo_Test_54_6</h4>
<h4 id="test-case-name-testmultiservicelistenernotificationfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenertestjava">Test Case Name: <code>testMultiServiceListenerNotification</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservice2listener1">Mock Object Variable Name: <code>demoService2Listener1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener.class);
    when(demoServiceListener2.getConsumerUrl()).thenReturn(consumerURL);
<span class="hljs-deletion">-    NotifyListener demoService2Listener1 = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoService2Listener1.getConsumerUrl()).thenReturn(consumerURL2);</span>
<span class="hljs-addition">+    NotifyListener demoService2Listener1 = MockNotifyListener.createMockNotifyListener(consumerURL2);</span>
    NotifyListener demoService2Listener2 = Mockito.mock(NotifyListener.class);
    when(demoService2Listener2.getConsumerUrl()).thenReturn(consumerURL2);
    listener.addListenerAndNotify(consumerURL, demoServiceListener1);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">6</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMultiServiceListenerNotification</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    serviceNames.add(<span class="hljs-string">"app2"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener1.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener2.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoService2Listener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener1.getConsumerUrl()).thenReturn(consumerURL2);

    NotifyListener demoService2Listener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener2.getConsumerUrl()).thenReturn(consumerURL2);

    listener.addListenerAndNotify(consumerURL, demoServiceListener1);

    listener.addListenerAndNotify(consumerURL, demoServiceListener2);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener1);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener2);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1Instances);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor.capture());

    List&lt;URL&gt; notifiedUrls = captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">3</span>, notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor2.capture());

    List&lt;URL&gt; notifiedUrls2 = captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">0</span>, notifiedUrls2.size());

    <span class="hljs-comment">// notify app2 instance change</span>

    ServiceInstancesChangedEvent app2_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app2"</span>, app2Instances);

    listener.onEvent(app2_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor.capture());

    List&lt;URL&gt; app2_notifiedUrls = app2_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">7</span>, app2_notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor2.capture());

    List&lt;URL&gt; app2_notifiedUrls2 = app2_captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, app2_notifiedUrls2.size());

    <span class="hljs-comment">// test service listener still get notified when added after instance notification.</span>

    NotifyListener demoService3Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);

    listener.addListenerAndNotify(consumerURL3, demoService3Listener);

    Mockito.verify(demoService3Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(Mockito.anyList());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest547">Test Case ID #dubbo_Test_54_7</h4>
<h4 id="test-case-name-testmultiservicelistenernotificationfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenertestjava">Test Case Name: <code>testMultiServiceListenerNotification</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservice2listener2">Mock Object Variable Name: <code>demoService2Listener2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    NotifyListener demoService2Listener1 = Mockito.mock(NotifyListener.class);
    when(demoService2Listener1.getConsumerUrl()).thenReturn(consumerURL2);
<span class="hljs-deletion">-    NotifyListener demoService2Listener2 = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoService2Listener2.getConsumerUrl()).thenReturn(consumerURL2);</span>
<span class="hljs-addition">+    NotifyListener demoService2Listener2 = MockNotifyListener.createMockNotifyListener(consumerURL2);</span>
    listener.addListenerAndNotify(consumerURL, demoServiceListener1);
    listener.addListenerAndNotify(consumerURL, demoServiceListener2);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">6</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMultiServiceListenerNotification</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    serviceNames.add(<span class="hljs-string">"app2"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener1.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener2.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoService2Listener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener1.getConsumerUrl()).thenReturn(consumerURL2);

    NotifyListener demoService2Listener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener2.getConsumerUrl()).thenReturn(consumerURL2);

    listener.addListenerAndNotify(consumerURL, demoServiceListener1);

    listener.addListenerAndNotify(consumerURL, demoServiceListener2);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener1);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener2);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1Instances);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor.capture());

    List&lt;URL&gt; notifiedUrls = captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">3</span>, notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor2.capture());

    List&lt;URL&gt; notifiedUrls2 = captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">0</span>, notifiedUrls2.size());

    <span class="hljs-comment">// notify app2 instance change</span>

    ServiceInstancesChangedEvent app2_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app2"</span>, app2Instances);

    listener.onEvent(app2_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor.capture());

    List&lt;URL&gt; app2_notifiedUrls = app2_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">7</span>, app2_notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor2.capture());

    List&lt;URL&gt; app2_notifiedUrls2 = app2_captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, app2_notifiedUrls2.size());

    <span class="hljs-comment">// test service listener still get notified when added after instance notification.</span>

    NotifyListener demoService3Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);

    listener.addListenerAndNotify(consumerURL3, demoService3Listener);

    Mockito.verify(demoService3Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(Mockito.anyList());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest548">Test Case ID #dubbo_Test_54_8</h4>
<h4 id="test-case-name-testmultiservicelistenernotificationfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenertestjava">Test Case Name: <code>testMultiServiceListenerNotification</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservice3listener">Mock Object Variable Name: <code>demoService3Listener</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Assertions.assertEquals(4, app2_notifiedUrls2.size());
    // test service listener still get notified when added after instance notification.
<span class="hljs-deletion">-    NotifyListener demoService3Listener = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);</span>
<span class="hljs-addition">+    NotifyListener demoService3Listener = MockNotifyListener.createMockNotifyListener(consumerURL3);</span>
    listener.addListenerAndNotify(consumerURL3, demoService3Listener);
    Mockito.verify(demoService3Listener, Mockito.times(1)).notify(Mockito.anyList());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">6</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMultiServiceListenerNotification</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    serviceNames.add(<span class="hljs-string">"app2"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener1.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener2.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoService2Listener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener1.getConsumerUrl()).thenReturn(consumerURL2);

    NotifyListener demoService2Listener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener2.getConsumerUrl()).thenReturn(consumerURL2);

    listener.addListenerAndNotify(consumerURL, demoServiceListener1);

    listener.addListenerAndNotify(consumerURL, demoServiceListener2);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener1);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener2);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1Instances);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor.capture());

    List&lt;URL&gt; notifiedUrls = captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">3</span>, notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor2.capture());

    List&lt;URL&gt; notifiedUrls2 = captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">0</span>, notifiedUrls2.size());

    <span class="hljs-comment">// notify app2 instance change</span>

    ServiceInstancesChangedEvent app2_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app2"</span>, app2Instances);

    listener.onEvent(app2_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor.capture());

    List&lt;URL&gt; app2_notifiedUrls = app2_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">7</span>, app2_notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor2.capture());

    List&lt;URL&gt; app2_notifiedUrls2 = app2_captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, app2_notifiedUrls2.size());

    <span class="hljs-comment">// test service listener still get notified when added after instance notification.</span>

    NotifyListener demoService3Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);

    listener.addListenerAndNotify(consumerURL3, demoService3Listener);

    Mockito.verify(demoService3Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(Mockito.anyList());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest549">Test Case ID #dubbo_Test_54_9</h4>
<h4 id="test-case-name-testsubscribemultipleprotocolsfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenertestjava">Test Case Name: <code>testSubscribeMultipleProtocols</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservicelistener1">Mock Object Variable Name: <code>demoServiceListener1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    listener = new ServiceInstancesChangedListener(serviceNames, serviceDiscovery);
    // no protocol specified, consume all instances
<span class="hljs-deletion">-    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoServiceListener1.getConsumerUrl()).thenReturn(noProtocolConsumerURL);</span>
<span class="hljs-addition">+    NotifyListener demoServiceListener1 = MockNotifyListener.createMockNotifyListener(noProtocolConsumerURL);</span>
    listener.addListenerAndNotify(noProtocolConsumerURL, demoServiceListener1);
    // multiple protocols specified
    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener.class);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Test subscribe multiple protocols

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">7</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSubscribeMultipleProtocols</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    <span class="hljs-comment">// no protocol specified, consume all instances</span>

    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener1.getConsumerUrl()).thenReturn(noProtocolConsumerURL);

    listener.addListenerAndNotify(noProtocolConsumerURL, demoServiceListener1);

    <span class="hljs-comment">// multiple protocols specified</span>

    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener2.getConsumerUrl()).thenReturn(multipleProtocolsConsumerURL);

    listener.addListenerAndNotify(multipleProtocolsConsumerURL, demoServiceListener2);

    <span class="hljs-comment">// one protocol specified</span>

    NotifyListener demoServiceListener3 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener3.getConsumerUrl()).thenReturn(singleProtocolsConsumerURL);

    listener.addListenerAndNotify(singleProtocolsConsumerURL, demoServiceListener3);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1InstancesMultipleProtocols);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check instances expose framework supported default protocols(currently dubbo, triple and rest) are notified</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; default_protocol_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">1</span>)).notify(default_protocol_captor.capture());

    List&lt;URL&gt; default_protocol_notifiedUrls = default_protocol_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, default_protocol_notifiedUrls.size());

    <span class="hljs-comment">// check instances expose protocols in consuming list(dubbo and triple) are notified</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; multi_protocols_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener2, Mockito.times(<span class="hljs-number">1</span>)).notify(multi_protocols_captor.capture());

    List&lt;URL&gt; multi_protocol_notifiedUrls = multi_protocols_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, multi_protocol_notifiedUrls.size());

    <span class="hljs-comment">// check instances expose protocols in consuming list(only triple) are notified</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; single_protocols_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener3, Mockito.times(<span class="hljs-number">1</span>)).notify(single_protocols_captor.capture());

    List&lt;URL&gt; single_protocol_notifiedUrls = single_protocols_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">1</span>, single_protocol_notifiedUrls.size());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest5410">Test Case ID #dubbo_Test_54_10</h4>
<h4 id="test-case-name-testsubscribemultipleprotocolsfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenertestjava">Test Case Name: <code>testSubscribeMultipleProtocols</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservicelistener2">Mock Object Variable Name: <code>demoServiceListener2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    // no protocol specified, consume all instances
    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener.class);
    when(demoServiceListener1.getConsumerUrl()).thenReturn(noProtocolConsumerURL);
    listener.addListenerAndNotify(noProtocolConsumerURL, demoServiceListener1);
    // multiple protocols specified
<span class="hljs-deletion">-    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoServiceListener2.getConsumerUrl()).thenReturn(multipleProtocolsConsumerURL);</span>
<span class="hljs-addition">+    NotifyListener demoServiceListener2 = MockNotifyListener.createMockNotifyListener(multipleProtocolsConsumerURL);</span>
    listener.addListenerAndNotify(multipleProtocolsConsumerURL, demoServiceListener2);
    // one protocol specified
    NotifyListener demoServiceListener3 = Mockito.mock(NotifyListener.class);
    when(demoServiceListener3.getConsumerUrl()).thenReturn(singleProtocolsConsumerURL);
    listener.addListenerAndNotify(singleProtocolsConsumerURL, demoServiceListener3);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Test subscribe multiple protocols

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">7</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSubscribeMultipleProtocols</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    <span class="hljs-comment">// no protocol specified, consume all instances</span>

    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener1.getConsumerUrl()).thenReturn(noProtocolConsumerURL);

    listener.addListenerAndNotify(noProtocolConsumerURL, demoServiceListener1);

    <span class="hljs-comment">// multiple protocols specified</span>

    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener2.getConsumerUrl()).thenReturn(multipleProtocolsConsumerURL);

    listener.addListenerAndNotify(multipleProtocolsConsumerURL, demoServiceListener2);

    <span class="hljs-comment">// one protocol specified</span>

    NotifyListener demoServiceListener3 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener3.getConsumerUrl()).thenReturn(singleProtocolsConsumerURL);

    listener.addListenerAndNotify(singleProtocolsConsumerURL, demoServiceListener3);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1InstancesMultipleProtocols);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check instances expose framework supported default protocols(currently dubbo, triple and rest) are notified</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; default_protocol_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">1</span>)).notify(default_protocol_captor.capture());

    List&lt;URL&gt; default_protocol_notifiedUrls = default_protocol_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, default_protocol_notifiedUrls.size());

    <span class="hljs-comment">// check instances expose protocols in consuming list(dubbo and triple) are notified</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; multi_protocols_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener2, Mockito.times(<span class="hljs-number">1</span>)).notify(multi_protocols_captor.capture());

    List&lt;URL&gt; multi_protocol_notifiedUrls = multi_protocols_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, multi_protocol_notifiedUrls.size());

    <span class="hljs-comment">// check instances expose protocols in consuming list(only triple) are notified</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; single_protocols_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener3, Mockito.times(<span class="hljs-number">1</span>)).notify(single_protocols_captor.capture());

    List&lt;URL&gt; single_protocol_notifiedUrls = single_protocols_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">1</span>, single_protocol_notifiedUrls.size());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest5411">Test Case ID #dubbo_Test_54_11</h4>
<h4 id="test-case-name-testsubscribemultipleprotocolsfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenertestjava">Test Case Name: <code>testSubscribeMultipleProtocols</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservicelistener3">Mock Object Variable Name: <code>demoServiceListener3</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    // multiple protocols specified
    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener.class);
    when(demoServiceListener2.getConsumerUrl()).thenReturn(multipleProtocolsConsumerURL);
    listener.addListenerAndNotify(multipleProtocolsConsumerURL, demoServiceListener2);
    // one protocol specified
<span class="hljs-deletion">-    NotifyListener demoServiceListener3 = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoServiceListener3.getConsumerUrl()).thenReturn(singleProtocolsConsumerURL);</span>
<span class="hljs-addition">+    NotifyListener demoServiceListener3 = MockNotifyListener.createMockNotifyListener(singleProtocolsConsumerURL);</span>
    listener.addListenerAndNotify(singleProtocolsConsumerURL, demoServiceListener3);
    // notify app1 instance change
    ServiceInstancesChangedEvent app1_event = new ServiceInstancesChangedEvent("app1", app1InstancesMultipleProtocols);
    listener.onEvent(app1_event);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Test subscribe multiple protocols

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">7</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSubscribeMultipleProtocols</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    <span class="hljs-comment">// no protocol specified, consume all instances</span>

    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener1.getConsumerUrl()).thenReturn(noProtocolConsumerURL);

    listener.addListenerAndNotify(noProtocolConsumerURL, demoServiceListener1);

    <span class="hljs-comment">// multiple protocols specified</span>

    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener2.getConsumerUrl()).thenReturn(multipleProtocolsConsumerURL);

    listener.addListenerAndNotify(multipleProtocolsConsumerURL, demoServiceListener2);

    <span class="hljs-comment">// one protocol specified</span>

    NotifyListener demoServiceListener3 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener3.getConsumerUrl()).thenReturn(singleProtocolsConsumerURL);

    listener.addListenerAndNotify(singleProtocolsConsumerURL, demoServiceListener3);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1InstancesMultipleProtocols);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check instances expose framework supported default protocols(currently dubbo, triple and rest) are notified</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; default_protocol_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">1</span>)).notify(default_protocol_captor.capture());

    List&lt;URL&gt; default_protocol_notifiedUrls = default_protocol_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, default_protocol_notifiedUrls.size());

    <span class="hljs-comment">// check instances expose protocols in consuming list(dubbo and triple) are notified</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; multi_protocols_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener2, Mockito.times(<span class="hljs-number">1</span>)).notify(multi_protocols_captor.capture());

    List&lt;URL&gt; multi_protocol_notifiedUrls = multi_protocols_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, multi_protocol_notifiedUrls.size());

    <span class="hljs-comment">// check instances expose protocols in consuming list(only triple) are notified</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; single_protocols_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener3, Mockito.times(<span class="hljs-number">1</span>)).notify(single_protocols_captor.capture());

    List&lt;URL&gt; single_protocol_notifiedUrls = single_protocols_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">1</span>, single_protocol_notifiedUrls.size());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest5412">Test Case ID #dubbo_Test_54_12</h4>
<h4 id="test-case-name-testservicelistenernotificationfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenerwithoutemptyprotecttestjava">Test Case Name: <code>testServiceListenerNotification</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerWithoutEmptyProtectTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservicelistener">Mock Object Variable Name: <code>demoServiceListener</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    listener = new ServiceInstancesChangedListener(serviceNames, serviceDiscovery);
<span class="hljs-deletion">-    NotifyListener demoServiceListener = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoServiceListener.getConsumerUrl()).thenReturn(consumerURL);</span>
<span class="hljs-addition">+    NotifyListener demoServiceListener = MockNotifyListener.createMockNotifyListener(consumerURL);</span>
    NotifyListener demoService2Listener = Mockito.mock(NotifyListener.class);
    when(demoService2Listener.getConsumerUrl()).thenReturn(consumerURL2);
    listener.addListenerAndNotify(consumerURL, demoServiceListener);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// instance listener -&gt; service listener(Directory)</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">5</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testServiceListenerNotification</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    serviceNames.add(<span class="hljs-string">"app2"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    NotifyListener demoServiceListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoService2Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener.getConsumerUrl()).thenReturn(consumerURL2);

    listener.addListenerAndNotify(consumerURL, demoServiceListener);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1Instances);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener, Mockito.times(<span class="hljs-number">1</span>)).notify(captor.capture());

    List&lt;URL&gt; notifiedUrls = captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">3</span>, notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(captor2.capture());

    List&lt;URL&gt; notifiedUrls2 = captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">1</span>, notifiedUrls2.size());

    <span class="hljs-comment">// notify app2 instance change</span>

    ServiceInstancesChangedEvent app2_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app2"</span>, app2Instances);

    listener.onEvent(app2_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor.capture());

    List&lt;URL&gt; app2_notifiedUrls = app2_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">7</span>, app2_notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor2.capture());

    List&lt;URL&gt; app2_notifiedUrls2 = app2_captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, app2_notifiedUrls2.size());

    <span class="hljs-comment">// test service listener still get notified when added after instance notification.</span>

    NotifyListener demoService3Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);

    listener.addListenerAndNotify(consumerURL3, demoService3Listener);

    Mockito.verify(demoService3Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(Mockito.anyList());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest5413">Test Case ID #dubbo_Test_54_13</h4>
<h4 id="test-case-name-testservicelistenernotificationfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenerwithoutemptyprotecttestjava">Test Case Name: <code>testServiceListenerNotification</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerWithoutEmptyProtectTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservice2listener">Mock Object Variable Name: <code>demoService2Listener</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    NotifyListener demoServiceListener = Mockito.mock(NotifyListener.class);
    when(demoServiceListener.getConsumerUrl()).thenReturn(consumerURL);
<span class="hljs-deletion">-    NotifyListener demoService2Listener = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoService2Listener.getConsumerUrl()).thenReturn(consumerURL2);</span>
<span class="hljs-addition">+    NotifyListener demoService2Listener = MockNotifyListener.createMockNotifyListener(consumerURL2);</span>
    listener.addListenerAndNotify(consumerURL, demoServiceListener);
    listener.addListenerAndNotify(consumerURL2, demoService2Listener);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// instance listener -&gt; service listener(Directory)</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">5</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testServiceListenerNotification</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    serviceNames.add(<span class="hljs-string">"app2"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    NotifyListener demoServiceListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoService2Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener.getConsumerUrl()).thenReturn(consumerURL2);

    listener.addListenerAndNotify(consumerURL, demoServiceListener);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1Instances);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener, Mockito.times(<span class="hljs-number">1</span>)).notify(captor.capture());

    List&lt;URL&gt; notifiedUrls = captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">3</span>, notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(captor2.capture());

    List&lt;URL&gt; notifiedUrls2 = captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">1</span>, notifiedUrls2.size());

    <span class="hljs-comment">// notify app2 instance change</span>

    ServiceInstancesChangedEvent app2_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app2"</span>, app2Instances);

    listener.onEvent(app2_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor.capture());

    List&lt;URL&gt; app2_notifiedUrls = app2_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">7</span>, app2_notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor2.capture());

    List&lt;URL&gt; app2_notifiedUrls2 = app2_captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, app2_notifiedUrls2.size());

    <span class="hljs-comment">// test service listener still get notified when added after instance notification.</span>

    NotifyListener demoService3Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);

    listener.addListenerAndNotify(consumerURL3, demoService3Listener);

    Mockito.verify(demoService3Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(Mockito.anyList());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest5414">Test Case ID #dubbo_Test_54_14</h4>
<h4 id="test-case-name-testservicelistenernotificationfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenerwithoutemptyprotecttestjava">Test Case Name: <code>testServiceListenerNotification</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerWithoutEmptyProtectTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservice3listener">Mock Object Variable Name: <code>demoService3Listener</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Assertions.assertEquals(4, app2_notifiedUrls2.size());
    // test service listener still get notified when added after instance notification.
<span class="hljs-deletion">-    NotifyListener demoService3Listener = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);</span>
<span class="hljs-addition">+    NotifyListener demoService3Listener = MockNotifyListener.createMockNotifyListener(consumerURL3);</span>
    listener.addListenerAndNotify(consumerURL3, demoService3Listener);
    Mockito.verify(demoService3Listener, Mockito.times(1)).notify(Mockito.anyList());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// instance listener -&gt; service listener(Directory)</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">5</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testServiceListenerNotification</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    serviceNames.add(<span class="hljs-string">"app2"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    NotifyListener demoServiceListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoService2Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener.getConsumerUrl()).thenReturn(consumerURL2);

    listener.addListenerAndNotify(consumerURL, demoServiceListener);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1Instances);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener, Mockito.times(<span class="hljs-number">1</span>)).notify(captor.capture());

    List&lt;URL&gt; notifiedUrls = captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">3</span>, notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(captor2.capture());

    List&lt;URL&gt; notifiedUrls2 = captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">1</span>, notifiedUrls2.size());

    <span class="hljs-comment">// notify app2 instance change</span>

    ServiceInstancesChangedEvent app2_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app2"</span>, app2Instances);

    listener.onEvent(app2_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor.capture());

    List&lt;URL&gt; app2_notifiedUrls = app2_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">7</span>, app2_notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor2.capture());

    List&lt;URL&gt; app2_notifiedUrls2 = app2_captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, app2_notifiedUrls2.size());

    <span class="hljs-comment">// test service listener still get notified when added after instance notification.</span>

    NotifyListener demoService3Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);

    listener.addListenerAndNotify(consumerURL3, demoService3Listener);

    Mockito.verify(demoService3Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(Mockito.anyList());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest5415">Test Case ID #dubbo_Test_54_15</h4>
<h4 id="test-case-name-testmultiservicelistenernotificationfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenerwithoutemptyprotecttestjava">Test Case Name: <code>testMultiServiceListenerNotification</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerWithoutEmptyProtectTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservicelistener1">Mock Object Variable Name: <code>demoServiceListener1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    listener = new ServiceInstancesChangedListener(serviceNames, serviceDiscovery);
<span class="hljs-deletion">-    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoServiceListener1.getConsumerUrl()).thenReturn(consumerURL);</span>
<span class="hljs-addition">+    NotifyListener demoServiceListener1 = MockNotifyListener.createMockNotifyListener(consumerURL);</span>
    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener.class);
    when(demoServiceListener2.getConsumerUrl()).thenReturn(consumerURL);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">6</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMultiServiceListenerNotification</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    serviceNames.add(<span class="hljs-string">"app2"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener1.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener2.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoService2Listener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener1.getConsumerUrl()).thenReturn(consumerURL2);

    NotifyListener demoService2Listener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener2.getConsumerUrl()).thenReturn(consumerURL2);

    listener.addListenerAndNotify(consumerURL, demoServiceListener1);

    listener.addListenerAndNotify(consumerURL, demoServiceListener2);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener1);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener2);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1Instances);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor.capture());

    List&lt;URL&gt; notifiedUrls = captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">3</span>, notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor2.capture());

    List&lt;URL&gt; notifiedUrls2 = captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">1</span>, notifiedUrls2.size());

    <span class="hljs-comment">// notify app2 instance change</span>

    ServiceInstancesChangedEvent app2_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app2"</span>, app2Instances);

    listener.onEvent(app2_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor.capture());

    List&lt;URL&gt; app2_notifiedUrls = app2_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">7</span>, app2_notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor2.capture());

    List&lt;URL&gt; app2_notifiedUrls2 = app2_captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, app2_notifiedUrls2.size());

    <span class="hljs-comment">// test service listener still get notified when added after instance notification.</span>

    NotifyListener demoService3Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);

    listener.addListenerAndNotify(consumerURL3, demoService3Listener);

    Mockito.verify(demoService3Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(Mockito.anyList());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest5416">Test Case ID #dubbo_Test_54_16</h4>
<h4 id="test-case-name-testmultiservicelistenernotificationfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenerwithoutemptyprotecttestjava">Test Case Name: <code>testMultiServiceListenerNotification</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerWithoutEmptyProtectTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservicelistener2">Mock Object Variable Name: <code>demoServiceListener2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener.class);
    when(demoServiceListener1.getConsumerUrl()).thenReturn(consumerURL);
<span class="hljs-deletion">-    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoServiceListener2.getConsumerUrl()).thenReturn(consumerURL);</span>
<span class="hljs-addition">+    NotifyListener demoServiceListener2 = MockNotifyListener.createMockNotifyListener(consumerURL);</span>
    NotifyListener demoService2Listener1 = Mockito.mock(NotifyListener.class);
    when(demoService2Listener1.getConsumerUrl()).thenReturn(consumerURL2);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">6</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMultiServiceListenerNotification</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    serviceNames.add(<span class="hljs-string">"app2"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener1.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener2.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoService2Listener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener1.getConsumerUrl()).thenReturn(consumerURL2);

    NotifyListener demoService2Listener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener2.getConsumerUrl()).thenReturn(consumerURL2);

    listener.addListenerAndNotify(consumerURL, demoServiceListener1);

    listener.addListenerAndNotify(consumerURL, demoServiceListener2);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener1);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener2);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1Instances);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor.capture());

    List&lt;URL&gt; notifiedUrls = captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">3</span>, notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor2.capture());

    List&lt;URL&gt; notifiedUrls2 = captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">1</span>, notifiedUrls2.size());

    <span class="hljs-comment">// notify app2 instance change</span>

    ServiceInstancesChangedEvent app2_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app2"</span>, app2Instances);

    listener.onEvent(app2_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor.capture());

    List&lt;URL&gt; app2_notifiedUrls = app2_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">7</span>, app2_notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor2.capture());

    List&lt;URL&gt; app2_notifiedUrls2 = app2_captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, app2_notifiedUrls2.size());

    <span class="hljs-comment">// test service listener still get notified when added after instance notification.</span>

    NotifyListener demoService3Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);

    listener.addListenerAndNotify(consumerURL3, demoService3Listener);

    Mockito.verify(demoService3Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(Mockito.anyList());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest5417">Test Case ID #dubbo_Test_54_17</h4>
<h4 id="test-case-name-testmultiservicelistenernotificationfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenerwithoutemptyprotecttestjava">Test Case Name: <code>testMultiServiceListenerNotification</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerWithoutEmptyProtectTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservice2listener1">Mock Object Variable Name: <code>demoService2Listener1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener.class);
    when(demoServiceListener2.getConsumerUrl()).thenReturn(consumerURL);
<span class="hljs-deletion">-    NotifyListener demoService2Listener1 = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoService2Listener1.getConsumerUrl()).thenReturn(consumerURL2);</span>
<span class="hljs-addition">+    NotifyListener demoService2Listener1 = MockNotifyListener.createMockNotifyListener(consumerURL2);</span>
    NotifyListener demoService2Listener2 = Mockito.mock(NotifyListener.class);
    when(demoService2Listener2.getConsumerUrl()).thenReturn(consumerURL2);
    listener.addListenerAndNotify(consumerURL, demoServiceListener1);
    listener.addListenerAndNotify(consumerURL, demoServiceListener2);
    listener.addListenerAndNotify(consumerURL2, demoService2Listener1);
    listener.addListenerAndNotify(consumerURL2, demoService2Listener2);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">6</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMultiServiceListenerNotification</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    serviceNames.add(<span class="hljs-string">"app2"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener1.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener2.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoService2Listener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener1.getConsumerUrl()).thenReturn(consumerURL2);

    NotifyListener demoService2Listener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener2.getConsumerUrl()).thenReturn(consumerURL2);

    listener.addListenerAndNotify(consumerURL, demoServiceListener1);

    listener.addListenerAndNotify(consumerURL, demoServiceListener2);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener1);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener2);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1Instances);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor.capture());

    List&lt;URL&gt; notifiedUrls = captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">3</span>, notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor2.capture());

    List&lt;URL&gt; notifiedUrls2 = captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">1</span>, notifiedUrls2.size());

    <span class="hljs-comment">// notify app2 instance change</span>

    ServiceInstancesChangedEvent app2_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app2"</span>, app2Instances);

    listener.onEvent(app2_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor.capture());

    List&lt;URL&gt; app2_notifiedUrls = app2_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">7</span>, app2_notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor2.capture());

    List&lt;URL&gt; app2_notifiedUrls2 = app2_captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, app2_notifiedUrls2.size());

    <span class="hljs-comment">// test service listener still get notified when added after instance notification.</span>

    NotifyListener demoService3Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);

    listener.addListenerAndNotify(consumerURL3, demoService3Listener);

    Mockito.verify(demoService3Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(Mockito.anyList());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest5418">Test Case ID #dubbo_Test_54_18</h4>
<h4 id="test-case-name-testmultiservicelistenernotificationfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenerwithoutemptyprotecttestjava">Test Case Name: <code>testMultiServiceListenerNotification</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerWithoutEmptyProtectTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservice2listener2">Mock Object Variable Name: <code>demoService2Listener2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    NotifyListener demoService2Listener1 = Mockito.mock(NotifyListener.class);
    when(demoService2Listener1.getConsumerUrl()).thenReturn(consumerURL2);
<span class="hljs-deletion">-    NotifyListener demoService2Listener2 = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoService2Listener2.getConsumerUrl()).thenReturn(consumerURL2);</span>
<span class="hljs-addition">+    NotifyListener demoService2Listener2 = MockNotifyListener.createMockNotifyListener(consumerURL2);</span>
    listener.addListenerAndNotify(consumerURL, demoServiceListener1);
    listener.addListenerAndNotify(consumerURL, demoServiceListener2);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">6</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMultiServiceListenerNotification</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    serviceNames.add(<span class="hljs-string">"app2"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener1.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener2.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoService2Listener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener1.getConsumerUrl()).thenReturn(consumerURL2);

    NotifyListener demoService2Listener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener2.getConsumerUrl()).thenReturn(consumerURL2);

    listener.addListenerAndNotify(consumerURL, demoServiceListener1);

    listener.addListenerAndNotify(consumerURL, demoServiceListener2);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener1);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener2);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1Instances);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor.capture());

    List&lt;URL&gt; notifiedUrls = captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">3</span>, notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor2.capture());

    List&lt;URL&gt; notifiedUrls2 = captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">1</span>, notifiedUrls2.size());

    <span class="hljs-comment">// notify app2 instance change</span>

    ServiceInstancesChangedEvent app2_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app2"</span>, app2Instances);

    listener.onEvent(app2_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor.capture());

    List&lt;URL&gt; app2_notifiedUrls = app2_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">7</span>, app2_notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor2.capture());

    List&lt;URL&gt; app2_notifiedUrls2 = app2_captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, app2_notifiedUrls2.size());

    <span class="hljs-comment">// test service listener still get notified when added after instance notification.</span>

    NotifyListener demoService3Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);

    listener.addListenerAndNotify(consumerURL3, demoService3Listener);

    Mockito.verify(demoService3Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(Mockito.anyList());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest5419">Test Case ID #dubbo_Test_54_19</h4>
<h4 id="test-case-name-testmultiservicelistenernotificationfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenerwithoutemptyprotecttestjava">Test Case Name: <code>testMultiServiceListenerNotification</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerWithoutEmptyProtectTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservice3listener">Mock Object Variable Name: <code>demoService3Listener</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Assertions.assertEquals(4, app2_notifiedUrls2.size());
    // test service listener still get notified when added after instance notification.
<span class="hljs-deletion">-    NotifyListener demoService3Listener = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);</span>
<span class="hljs-addition">+    NotifyListener demoService3Listener = MockNotifyListener.createMockNotifyListener(consumerURL3);</span>
    listener.addListenerAndNotify(consumerURL3, demoService3Listener);
    Mockito.verify(demoService3Listener, Mockito.times(1)).notify(Mockito.anyList());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">6</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMultiServiceListenerNotification</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    serviceNames.add(<span class="hljs-string">"app2"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener1.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener2.getConsumerUrl()).thenReturn(consumerURL);

    NotifyListener demoService2Listener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener1.getConsumerUrl()).thenReturn(consumerURL2);

    NotifyListener demoService2Listener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService2Listener2.getConsumerUrl()).thenReturn(consumerURL2);

    listener.addListenerAndNotify(consumerURL, demoServiceListener1);

    listener.addListenerAndNotify(consumerURL, demoServiceListener2);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener1);

    listener.addListenerAndNotify(consumerURL2, demoService2Listener2);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1Instances);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor.capture());

    List&lt;URL&gt; notifiedUrls = captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">3</span>, notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">1</span>)).notify(captor2.capture());

    List&lt;URL&gt; notifiedUrls2 = captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">1</span>, notifiedUrls2.size());

    <span class="hljs-comment">// notify app2 instance change</span>

    ServiceInstancesChangedEvent app2_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app2"</span>, app2Instances);

    listener.onEvent(app2_event);

    <span class="hljs-comment">// check</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor.capture());

    List&lt;URL&gt; app2_notifiedUrls = app2_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">7</span>, app2_notifiedUrls.size());

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; app2_captor2 = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoService2Listener1, Mockito.times(<span class="hljs-number">2</span>)).notify(app2_captor2.capture());

    List&lt;URL&gt; app2_notifiedUrls2 = app2_captor2.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, app2_notifiedUrls2.size());

    <span class="hljs-comment">// test service listener still get notified when added after instance notification.</span>

    NotifyListener demoService3Listener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoService3Listener.getConsumerUrl()).thenReturn(consumerURL3);

    listener.addListenerAndNotify(consumerURL3, demoService3Listener);

    Mockito.verify(demoService3Listener, Mockito.times(<span class="hljs-number">1</span>)).notify(Mockito.anyList());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest5420">Test Case ID #dubbo_Test_54_20</h4>
<h4 id="test-case-name-testsubscribemultipleprotocolsfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenerwithoutemptyprotecttestjava">Test Case Name: <code>testSubscribeMultipleProtocols</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerWithoutEmptyProtectTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservicelistener1">Mock Object Variable Name: <code>demoServiceListener1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    listener = new ServiceInstancesChangedListener(serviceNames, serviceDiscovery);
    // no protocol specified, consume all instances
<span class="hljs-deletion">-    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoServiceListener1.getConsumerUrl()).thenReturn(noProtocolConsumerURL);</span>
<span class="hljs-addition">+    NotifyListener demoServiceListener1 = MockNotifyListener.createMockNotifyListener(noProtocolConsumerURL);</span>
    listener.addListenerAndNotify(noProtocolConsumerURL, demoServiceListener1);
    // multiple protocols specified
    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener.class);
    when(demoServiceListener2.getConsumerUrl()).thenReturn(multipleProtocolsConsumerURL);
    listener.addListenerAndNotify(multipleProtocolsConsumerURL, demoServiceListener2);
    // one protocol specified
    NotifyListener demoServiceListener3 = Mockito.mock(NotifyListener.class);
    when(demoServiceListener3.getConsumerUrl()).thenReturn(singleProtocolsConsumerURL);
    listener.addListenerAndNotify(singleProtocolsConsumerURL, demoServiceListener3);
    // notify app1 instance change
    ServiceInstancesChangedEvent app1_event = new ServiceInstancesChangedEvent("app1", app1InstancesMultipleProtocols);
    listener.onEvent(app1_event);
    // check instances expose framework supported default protocols(currently dubbo, triple and rest) are notified
    ArgumentCaptor&lt;List&lt;URL&gt;&gt; default_protocol_captor = ArgumentCaptor.forClass(List.class);
    Mockito.verify(demoServiceListener1, Mockito.times(1)).notify(default_protocol_captor.capture());
    List&lt;URL&gt; default_protocol_notifiedUrls = default_protocol_captor.getValue();
    Assertions.assertEquals(4, default_protocol_notifiedUrls.size());
    // check instances expose protocols in consuming list(dubbo and triple) are notified
    ArgumentCaptor&lt;List&lt;URL&gt;&gt; multi_protocols_captor = ArgumentCaptor.forClass(List.class);
    Mockito.verify(demoServiceListener2, Mockito.times(1)).notify(multi_protocols_captor.capture());
    List&lt;URL&gt; multi_protocol_notifiedUrls = multi_protocols_captor.getValue();
    Assertions.assertEquals(4, multi_protocol_notifiedUrls.size());
    // check instances expose protocols in consuming list(only triple) are notified
    ArgumentCaptor&lt;List&lt;URL&gt;&gt; single_protocols_captor = ArgumentCaptor.forClass(List.class);
    Mockito.verify(demoServiceListener3, Mockito.times(1)).notify(single_protocols_captor.capture());
    List&lt;URL&gt; single_protocol_notifiedUrls = single_protocols_captor.getValue();
    Assertions.assertEquals(1, single_protocol_notifiedUrls.size());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Test subscribe multiple protocols

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">7</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSubscribeMultipleProtocols</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    <span class="hljs-comment">// no protocol specified, consume all instances</span>

    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener1.getConsumerUrl()).thenReturn(noProtocolConsumerURL);

    listener.addListenerAndNotify(noProtocolConsumerURL, demoServiceListener1);

    <span class="hljs-comment">// multiple protocols specified</span>

    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener2.getConsumerUrl()).thenReturn(multipleProtocolsConsumerURL);

    listener.addListenerAndNotify(multipleProtocolsConsumerURL, demoServiceListener2);

    <span class="hljs-comment">// one protocol specified</span>

    NotifyListener demoServiceListener3 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener3.getConsumerUrl()).thenReturn(singleProtocolsConsumerURL);

    listener.addListenerAndNotify(singleProtocolsConsumerURL, demoServiceListener3);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1InstancesMultipleProtocols);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check instances expose framework supported default protocols(currently dubbo, triple and rest) are notified</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; default_protocol_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">1</span>)).notify(default_protocol_captor.capture());

    List&lt;URL&gt; default_protocol_notifiedUrls = default_protocol_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, default_protocol_notifiedUrls.size());

    <span class="hljs-comment">// check instances expose protocols in consuming list(dubbo and triple) are notified</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; multi_protocols_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener2, Mockito.times(<span class="hljs-number">1</span>)).notify(multi_protocols_captor.capture());

    List&lt;URL&gt; multi_protocol_notifiedUrls = multi_protocols_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, multi_protocol_notifiedUrls.size());

    <span class="hljs-comment">// check instances expose protocols in consuming list(only triple) are notified</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; single_protocols_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener3, Mockito.times(<span class="hljs-number">1</span>)).notify(single_protocols_captor.capture());

    List&lt;URL&gt; single_protocol_notifiedUrls = single_protocols_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">1</span>, single_protocol_notifiedUrls.size());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest5421">Test Case ID #dubbo_Test_54_21</h4>
<h4 id="test-case-name-testsubscribemultipleprotocolsfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenerwithoutemptyprotecttestjava">Test Case Name: <code>testSubscribeMultipleProtocols</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerWithoutEmptyProtectTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservicelistener2">Mock Object Variable Name: <code>demoServiceListener2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    // no protocol specified, consume all instances
    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener.class);
    when(demoServiceListener1.getConsumerUrl()).thenReturn(noProtocolConsumerURL);
    listener.addListenerAndNotify(noProtocolConsumerURL, demoServiceListener1);
    // multiple protocols specified
<span class="hljs-deletion">-    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoServiceListener2.getConsumerUrl()).thenReturn(multipleProtocolsConsumerURL);</span>
<span class="hljs-addition">+    NotifyListener demoServiceListener2 = MockNotifyListener.createMockNotifyListener(multipleProtocolsConsumerURL);</span>
    listener.addListenerAndNotify(multipleProtocolsConsumerURL, demoServiceListener2);
    // one protocol specified
    NotifyListener demoServiceListener3 = Mockito.mock(NotifyListener.class);
    when(demoServiceListener3.getConsumerUrl()).thenReturn(singleProtocolsConsumerURL);
    listener.addListenerAndNotify(singleProtocolsConsumerURL, demoServiceListener3);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Test subscribe multiple protocols

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">7</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSubscribeMultipleProtocols</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    <span class="hljs-comment">// no protocol specified, consume all instances</span>

    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener1.getConsumerUrl()).thenReturn(noProtocolConsumerURL);

    listener.addListenerAndNotify(noProtocolConsumerURL, demoServiceListener1);

    <span class="hljs-comment">// multiple protocols specified</span>

    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener2.getConsumerUrl()).thenReturn(multipleProtocolsConsumerURL);

    listener.addListenerAndNotify(multipleProtocolsConsumerURL, demoServiceListener2);

    <span class="hljs-comment">// one protocol specified</span>

    NotifyListener demoServiceListener3 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener3.getConsumerUrl()).thenReturn(singleProtocolsConsumerURL);

    listener.addListenerAndNotify(singleProtocolsConsumerURL, demoServiceListener3);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1InstancesMultipleProtocols);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check instances expose framework supported default protocols(currently dubbo, triple and rest) are notified</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; default_protocol_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">1</span>)).notify(default_protocol_captor.capture());

    List&lt;URL&gt; default_protocol_notifiedUrls = default_protocol_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, default_protocol_notifiedUrls.size());

    <span class="hljs-comment">// check instances expose protocols in consuming list(dubbo and triple) are notified</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; multi_protocols_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener2, Mockito.times(<span class="hljs-number">1</span>)).notify(multi_protocols_captor.capture());

    List&lt;URL&gt; multi_protocol_notifiedUrls = multi_protocols_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, multi_protocol_notifiedUrls.size());

    <span class="hljs-comment">// check instances expose protocols in consuming list(only triple) are notified</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; single_protocols_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener3, Mockito.times(<span class="hljs-number">1</span>)).notify(single_protocols_captor.capture());

    List&lt;URL&gt; single_protocol_notifiedUrls = single_protocols_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">1</span>, single_protocol_notifiedUrls.size());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest5422">Test Case ID #dubbo_Test_54_22</h4>
<h4 id="test-case-name-testsubscribemultipleprotocolsfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclienteventlistenerserviceinstanceschangedlistenerwithoutemptyprotecttestjava">Test Case Name: <code>testSubscribeMultipleProtocols</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\event\listener\ServiceInstancesChangedListenerWithoutEmptyProtectTest.java</code>)</h4>
<h4 id="mock-object-variable-name-demoservicelistener3">Mock Object Variable Name: <code>demoServiceListener3</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    // multiple protocols specified
    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener.class);
    when(demoServiceListener2.getConsumerUrl()).thenReturn(multipleProtocolsConsumerURL);
    listener.addListenerAndNotify(multipleProtocolsConsumerURL, demoServiceListener2);
    // one protocol specified
<span class="hljs-deletion">-    NotifyListener demoServiceListener3 = Mockito.mock(NotifyListener.class);</span>
<span class="hljs-deletion">-    when(demoServiceListener3.getConsumerUrl()).thenReturn(singleProtocolsConsumerURL);</span>
<span class="hljs-addition">+    NotifyListener demoServiceListener3 = MockNotifyListener.createMockNotifyListener(singleProtocolsConsumerURL);</span>
    listener.addListenerAndNotify(singleProtocolsConsumerURL, demoServiceListener3);
    // notify app1 instance change
    ServiceInstancesChangedEvent app1_event = new ServiceInstancesChangedEvent("app1", app1InstancesMultipleProtocols);
    listener.onEvent(app1_event);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Test subscribe multiple protocols

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">7</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSubscribeMultipleProtocols</span><span class="hljs-params">()</span> </span>{

    Set&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    serviceNames.add(<span class="hljs-string">"app1"</span>);

    listener = <span class="hljs-keyword">new</span> ServiceInstancesChangedListener(serviceNames, serviceDiscovery);

    <span class="hljs-comment">// no protocol specified, consume all instances</span>

    NotifyListener demoServiceListener1 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener1.getConsumerUrl()).thenReturn(noProtocolConsumerURL);

    listener.addListenerAndNotify(noProtocolConsumerURL, demoServiceListener1);

    <span class="hljs-comment">// multiple protocols specified</span>

    NotifyListener demoServiceListener2 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener2.getConsumerUrl()).thenReturn(multipleProtocolsConsumerURL);

    listener.addListenerAndNotify(multipleProtocolsConsumerURL, demoServiceListener2);

    <span class="hljs-comment">// one protocol specified</span>

    NotifyListener demoServiceListener3 = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(demoServiceListener3.getConsumerUrl()).thenReturn(singleProtocolsConsumerURL);

    listener.addListenerAndNotify(singleProtocolsConsumerURL, demoServiceListener3);

    <span class="hljs-comment">// notify app1 instance change</span>

    ServiceInstancesChangedEvent app1_event = <span class="hljs-keyword">new</span> ServiceInstancesChangedEvent(<span class="hljs-string">"app1"</span>, app1InstancesMultipleProtocols);

    listener.onEvent(app1_event);

    <span class="hljs-comment">// check instances expose framework supported default protocols(currently dubbo, triple and rest) are notified</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; default_protocol_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener1, Mockito.times(<span class="hljs-number">1</span>)).notify(default_protocol_captor.capture());

    List&lt;URL&gt; default_protocol_notifiedUrls = default_protocol_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, default_protocol_notifiedUrls.size());

    <span class="hljs-comment">// check instances expose protocols in consuming list(dubbo and triple) are notified</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; multi_protocols_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener2, Mockito.times(<span class="hljs-number">1</span>)).notify(multi_protocols_captor.capture());

    List&lt;URL&gt; multi_protocol_notifiedUrls = multi_protocols_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">4</span>, multi_protocol_notifiedUrls.size());

    <span class="hljs-comment">// check instances expose protocols in consuming list(only triple) are notified</span>

    ArgumentCaptor&lt;List&lt;URL&gt;&gt; single_protocols_captor = ArgumentCaptor.forClass(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(demoServiceListener3, Mockito.times(<span class="hljs-number">1</span>)).notify(single_protocols_captor.capture());

    List&lt;URL&gt; single_protocol_notifiedUrls = single_protocols_captor.getValue();

    Assertions.assertEquals(<span class="hljs-number">1</span>, single_protocol_notifiedUrls.size());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockNotifyListener</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock NotifyListener with getConsumerUrl() stubbed to return the given URL.
     *
     * <span class="hljs-doctag">@param</span> consumerUrl the URL to return from getConsumerUrl()
     * <span class="hljs-doctag">@return</span> a mock NotifyListener
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NotifyListener <span class="hljs-title">createMockNotifyListener</span><span class="hljs-params">(URL consumerUrl)</span> </span>{
        NotifyListener notifyListener = Mockito.mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(notifyListener.getConsumerUrl()).thenReturn(consumerUrl);
        <span class="hljs-keyword">return</span> notifyListener;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci55">Mock Clone Instance #dubbo_MCI_55</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.registry.NotifyListener</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> NotifyListener listener;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    listener = mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
listener;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest551">Test Case ID #dubbo_Test_55_1</h4>
<h4 id="test-case-name-testsubscribefile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-nacossrctestjavaorgapachedubboregistrynacosnacosregistrytestjava">Test Case Name: <code>testSubscribe</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-nacos\src\test\java\org\apache\dubbo\registry\nacos\NacosRegistryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-listener">Mock Object Variable Name: <code>listener</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     nacosRegistry = new NacosRegistry(this.registryUrl, nacosNamingServiceWrapper);
<span class="hljs-deletion">-    NotifyListener listener = mock(NotifyListener.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `listener`</span>
     nacosRegistry.subscribe(serviceUrl, listener);
     Map&lt;URL, Set&lt;NotifyListener&gt;&gt; subscribed = nacosRegistry.getSubscribed();
     Assertions.assertEquals(1, subscribed.size());
     Assertions.assertEquals(1, subscribed.get(serviceUrl).size());
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testSubscribe</span><span class="hljs-params">()</span> </span>{

    NamingService namingService = mock(NacosNamingService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">try</span> {

        String serviceName = <span class="hljs-string">"providers:org.apache.dubbo.registry.nacos.NacosService:1.0.0:default"</span>;

        String category = <span class="hljs-keyword">this</span>.serviceUrl.getParameter(CATEGORY_KEY, DEFAULT_CATEGORY);

        URL newUrl = <span class="hljs-keyword">this</span>.serviceUrl.addParameter(CATEGORY_KEY, category);

        newUrl = newUrl.addParameter(PROTOCOL_KEY, <span class="hljs-keyword">this</span>.serviceUrl.getProtocol());

        newUrl = newUrl.addParameter(PATH_KEY, <span class="hljs-keyword">this</span>.serviceUrl.getPath());

        String ip = newUrl.getHost();

        <span class="hljs-keyword">int</span> port = newUrl.getPort();

        Instance instance = <span class="hljs-keyword">new</span> Instance();

        instance.setIp(ip);

        instance.setPort(port);

        instance.setMetadata(<span class="hljs-keyword">new</span> HashMap&lt;&gt;(newUrl.getParameters()));

        List&lt;Instance&gt; instances = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

        instances.add(instance);

        when(namingService.getAllInstances(serviceName, <span class="hljs-keyword">this</span>.registryUrl.getParameter(GROUP_KEY, Constants.DEFAULT_GROUP))).thenReturn(instances);

    } <span class="hljs-keyword">catch</span> (NacosException e) {

        <span class="hljs-comment">// ignore</span>

    }

    NacosNamingServiceWrapper nacosNamingServiceWrapper = <span class="hljs-keyword">new</span> NacosNamingServiceWrapper(<span class="hljs-keyword">new</span> NacosConnectionManager(namingService), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

    nacosRegistry = <span class="hljs-keyword">new</span> NacosRegistry(<span class="hljs-keyword">this</span>.registryUrl, nacosNamingServiceWrapper);

    NotifyListener listener = mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    nacosRegistry.subscribe(serviceUrl, listener);

    Map&lt;URL, Set&lt;NotifyListener&gt;&gt; subscribed = nacosRegistry.getSubscribed();

    Assertions.assertEquals(<span class="hljs-number">1</span>, subscribed.size());

    Assertions.assertEquals(<span class="hljs-number">1</span>, subscribed.get(serviceUrl).size());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> NotifyListener listener;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    listener = mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
listener;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest552">Test Case ID #dubbo_Test_55_2</h4>
<h4 id="test-case-name-testunsubscribefile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-nacossrctestjavaorgapachedubboregistrynacosnacosregistrytestjava">Test Case Name: <code>testUnSubscribe</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-nacos\src\test\java\org\apache\dubbo\registry\nacos\NacosRegistryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-listener">Mock Object Variable Name: <code>listener</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     nacosRegistry = new NacosRegistry(this.registryUrl, nacosNamingServiceWrapper);
<span class="hljs-deletion">-    NotifyListener listener = mock(NotifyListener.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `listener`</span>
     nacosRegistry.subscribe(serviceUrl, listener);
     Map&lt;URL, Set&lt;NotifyListener&gt;&gt; subscribed = nacosRegistry.getSubscribed();
     Assertions.assertEquals(1, subscribed.size());
     Assertions.assertEquals(1, subscribed.get(serviceUrl).size());
     nacosRegistry.unsubscribe(serviceUrl, listener);
     subscribed = nacosRegistry.getSubscribed();
     Assertions.assertEquals(1, subscribed.size());
     Assertions.assertEquals(0, subscribed.get(serviceUrl).size());
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testUnSubscribe</span><span class="hljs-params">()</span> </span>{

    NamingService namingService = mock(NacosNamingService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">try</span> {

        String serviceName = <span class="hljs-string">"providers:org.apache.dubbo.registry.nacos.NacosService:1.0.0:default"</span>;

        String category = <span class="hljs-keyword">this</span>.serviceUrl.getParameter(CATEGORY_KEY, DEFAULT_CATEGORY);

        URL newUrl = <span class="hljs-keyword">this</span>.serviceUrl.addParameter(CATEGORY_KEY, category);

        newUrl = newUrl.addParameter(PROTOCOL_KEY, <span class="hljs-keyword">this</span>.serviceUrl.getProtocol());

        newUrl = newUrl.addParameter(PATH_KEY, <span class="hljs-keyword">this</span>.serviceUrl.getPath());

        String ip = newUrl.getHost();

        <span class="hljs-keyword">int</span> port = newUrl.getPort();

        Instance instance = <span class="hljs-keyword">new</span> Instance();

        instance.setIp(ip);

        instance.setPort(port);

        instance.setMetadata(<span class="hljs-keyword">new</span> HashMap&lt;&gt;(newUrl.getParameters()));

        List&lt;Instance&gt; instances = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

        instances.add(instance);

        when(namingService.getAllInstances(serviceName, <span class="hljs-keyword">this</span>.registryUrl.getParameter(GROUP_KEY, Constants.DEFAULT_GROUP))).thenReturn(instances);

    } <span class="hljs-keyword">catch</span> (NacosException e) {

        <span class="hljs-comment">// ignore</span>

    }

    NacosNamingServiceWrapper nacosNamingServiceWrapper = <span class="hljs-keyword">new</span> NacosNamingServiceWrapper(<span class="hljs-keyword">new</span> NacosConnectionManager(namingService), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

    nacosRegistry = <span class="hljs-keyword">new</span> NacosRegistry(<span class="hljs-keyword">this</span>.registryUrl, nacosNamingServiceWrapper);

    NotifyListener listener = mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    nacosRegistry.subscribe(serviceUrl, listener);

    Map&lt;URL, Set&lt;NotifyListener&gt;&gt; subscribed = nacosRegistry.getSubscribed();

    Assertions.assertEquals(<span class="hljs-number">1</span>, subscribed.size());

    Assertions.assertEquals(<span class="hljs-number">1</span>, subscribed.get(serviceUrl).size());

    nacosRegistry.unsubscribe(serviceUrl, listener);

    subscribed = nacosRegistry.getSubscribed();

    Assertions.assertEquals(<span class="hljs-number">1</span>, subscribed.size());

    Assertions.assertEquals(<span class="hljs-number">0</span>, subscribed.get(serviceUrl).size());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> NotifyListener listener;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    listener = mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
listener;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest553">Test Case ID #dubbo_Test_55_3</h4>
<h4 id="test-case-name-testisconformrulesfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-nacossrctestjavaorgapachedubboregistrynacosnacosregistrytestjava">Test Case Name: <code>testIsConformRules</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-nacos\src\test\java\org\apache\dubbo\registry\nacos\NacosRegistryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-listener">Mock Object Variable Name: <code>listener</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     URL serviceUrlWithWildcard = URL.valueOf("nacos://127.0.0.1:3333/" + serviceInterface + "?interface=org.apache.dubbo.registry.nacos.NacosService" + "&amp;notify=false&amp;methods=test1,test2&amp;category=providers&amp;version=*&amp;group=default");
     URL serviceUrlWithOutWildcard = URL.valueOf("nacos://127.0.0.1:3333/" + serviceInterface + "?interface=org.apache.dubbo.registry.nacos.NacosService" + "&amp;notify=false&amp;methods=test1,test2&amp;category=providers&amp;version=1.0.0&amp;group=default");
<span class="hljs-deletion">-    NotifyListener listener = mock(NotifyListener.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `listener`</span>
     nacosRegistry.subscribe(serviceUrlWithWildcard, listener);
     nacosRegistry.subscribe(serviceUrlWithOutWildcard, listener);
     Map&lt;URL, Set&lt;NotifyListener&gt;&gt; subscribed = nacosRegistry.getSubscribed();
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testIsConformRules</span><span class="hljs-params">()</span> </span>{

    NamingService namingService = mock(NacosNamingService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL serviceUrlWithoutCategory = URL.valueOf(<span class="hljs-string">"nacos://127.0.0.1:3333/"</span> + serviceInterface + <span class="hljs-string">"?interface="</span> + serviceInterface + <span class="hljs-string">"&amp;notify=false&amp;methods=test1,test2&amp;version=1.0.0&amp;group=default"</span>);

    <span class="hljs-keyword">try</span> {

        String serviceName = <span class="hljs-string">"providers:org.apache.dubbo.registry.nacos.NacosService:1.0.0:default"</span>;

        String category = <span class="hljs-keyword">this</span>.serviceUrl.getParameter(CATEGORY_KEY, DEFAULT_CATEGORY);

        URL newUrl = <span class="hljs-keyword">this</span>.serviceUrl.addParameter(CATEGORY_KEY, category);

        newUrl = newUrl.addParameter(PROTOCOL_KEY, <span class="hljs-keyword">this</span>.serviceUrl.getProtocol());

        newUrl = newUrl.addParameter(PATH_KEY, <span class="hljs-keyword">this</span>.serviceUrl.getPath());

        String ip = newUrl.getHost();

        <span class="hljs-keyword">int</span> port = newUrl.getPort();

        Instance instance = <span class="hljs-keyword">new</span> Instance();

        instance.setIp(ip);

        instance.setPort(port);

        instance.setMetadata(<span class="hljs-keyword">new</span> HashMap&lt;&gt;(newUrl.getParameters()));

        List&lt;Instance&gt; instances = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

        instances.add(instance);

        when(namingService.getAllInstances(serviceName, <span class="hljs-keyword">this</span>.registryUrl.getParameter(GROUP_KEY, Constants.DEFAULT_GROUP))).thenReturn(instances);

        String serviceNameWithoutVersion = <span class="hljs-string">"providers:org.apache.dubbo.registry.nacos.NacosService:default"</span>;

        String serviceName1 = <span class="hljs-string">"providers:org.apache.dubbo.registry.nacos.NacosService:1.0.0:default"</span>;

        List&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

        serviceNames.add(serviceNameWithoutVersion);

        serviceNames.add(serviceName1);

        ListView&lt;String&gt; result = <span class="hljs-keyword">new</span> ListView&lt;&gt;();

        result.setData(serviceNames);

        when(namingService.getServicesOfServer(<span class="hljs-number">1</span>, Integer.MAX_VALUE, registryUrl.getParameter(GROUP_KEY, Constants.DEFAULT_GROUP))).thenReturn(result);

    } <span class="hljs-keyword">catch</span> (NacosException e) {

        <span class="hljs-comment">// ignore</span>

    }

    NacosNamingServiceWrapper nacosNamingServiceWrapper = <span class="hljs-keyword">new</span> NacosNamingServiceWrapper(<span class="hljs-keyword">new</span> NacosConnectionManager(namingService), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

    nacosRegistry = <span class="hljs-keyword">new</span> NacosRegistry(<span class="hljs-keyword">this</span>.registryUrl, nacosNamingServiceWrapper);

    Set&lt;URL&gt; registered;

    nacosRegistry.register(<span class="hljs-keyword">this</span>.serviceUrl);

    nacosRegistry.register(serviceUrlWithoutCategory);

    registered = nacosRegistry.getRegistered();

    Assertions.assertTrue(registered.contains(serviceUrl));

    Assertions.assertTrue(registered.contains(serviceUrlWithoutCategory));

    Assertions.assertEquals(<span class="hljs-number">2</span>, registered.size());

    URL serviceUrlWithWildcard = URL.valueOf(<span class="hljs-string">"nacos://127.0.0.1:3333/"</span> + serviceInterface + <span class="hljs-string">"?interface=org.apache.dubbo.registry.nacos.NacosService"</span> + <span class="hljs-string">"&amp;notify=false&amp;methods=test1,test2&amp;category=providers&amp;version=*&amp;group=default"</span>);

    URL serviceUrlWithOutWildcard = URL.valueOf(<span class="hljs-string">"nacos://127.0.0.1:3333/"</span> + serviceInterface + <span class="hljs-string">"?interface=org.apache.dubbo.registry.nacos.NacosService"</span> + <span class="hljs-string">"&amp;notify=false&amp;methods=test1,test2&amp;category=providers&amp;version=1.0.0&amp;group=default"</span>);

    NotifyListener listener = mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    nacosRegistry.subscribe(serviceUrlWithWildcard, listener);

    nacosRegistry.subscribe(serviceUrlWithOutWildcard, listener);

    Map&lt;URL, Set&lt;NotifyListener&gt;&gt; subscribed = nacosRegistry.getSubscribed();

    Assertions.assertEquals(<span class="hljs-number">2</span>, registered.size());

    Assertions.assertEquals(<span class="hljs-number">1</span>, subscribed.get(serviceUrlWithOutWildcard).size());

    Assertions.assertEquals(<span class="hljs-number">2</span>, registered.size());

    Assertions.assertEquals(<span class="hljs-number">1</span>, subscribed.get(serviceUrlWithWildcard).size());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> NotifyListener listener;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    listener = mock(NotifyListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
listener;

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci56">Mock Clone Instance #dubbo_MCI_56</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Protocol</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Protocol <span class="hljs-title">createMockProtocol</span><span class="hljs-params">(URL url, Invoker&lt;?&gt; invoker)</span> </span>{
    Protocol protocol = mock(Protocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(protocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">invoker</span>)</span>;
    <span class="hljs-keyword">return</span> protocol;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest561">Test Case ID #dubbo_Test_56_1</h4>
<h4 id="test-case-name-testloadinglistenerforlocalreferencefile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcprotocolprotocollistenerwrappertestjava">Test Case Name: <code>testLoadingListenerForLocalReference</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\protocol\ProtocolListenerWrapperTest.java</code>)</h4>
<h4 id="mock-object-variable-name-protocolwithoutlistener">Mock Object Variable Name: <code>protocolWithoutListener</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    AbstractInvoker&lt;DemoService&gt; invokerWithoutListener = new AbstractInvoker&lt;DemoService&gt;(DemoService.class, urlWithoutListener) {

        @Override
        protected Result doInvoke(Invocation invocation) throws Throwable {
            return null;
        }
    };
<span class="hljs-deletion">-    Protocol protocolWithoutListener = mock(Protocol.class);</span>
<span class="hljs-deletion">-    when(protocolWithoutListener.refer(DemoService.class, urlWithoutListener)).thenReturn(invokerWithoutListener);</span>
<span class="hljs-addition">+    Protocol protocolWithoutListener = createMockProtocol(urlWithoutListener, invokerWithoutListener);</span>
    ProtocolListenerWrapper protocolListenerWrapperWithoutListener = new ProtocolListenerWrapper(protocolWithoutListener);
    Invoker&lt;?&gt; invoker = protocolListenerWrapperWithoutListener.refer(DemoService.class, urlWithoutListener);
    Assertions.assertTrue(invoker instanceof ListenerInvokerWrapper);
    Assertions.assertEquals(0, ((ListenerInvokerWrapper&lt;?&gt;) invoker).getListeners().size());
    // verify that if the invoker.listener is configured, then load the specified listener
    URL urlWithListener = URL.valueOf("injvm://127.0.0.1/DemoService").addParameter(INTERFACE_KEY, DemoService.class.getName()).addParameter(INVOKER_LISTENER_KEY, "count");
    AbstractInvoker&lt;DemoService&gt; invokerWithListener = new AbstractInvoker&lt;DemoService&gt;(DemoService.class, urlWithListener) {

        @Override
        protected Result doInvoke(Invocation invocation) throws Throwable {
            return null;
        }
    };
    Protocol protocol = mock(Protocol.class);
    when(protocol.refer(DemoService.class, urlWithListener)).thenReturn(invokerWithListener);
    ProtocolListenerWrapper protocolListenerWrapper = new ProtocolListenerWrapper(protocol);
    invoker = protocolListenerWrapper.refer(DemoService.class, urlWithListener);
    Assertions.assertTrue(invoker instanceof ListenerInvokerWrapper);
    Assertions.assertEquals(1, CountInvokerListener.getCounter());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testLoadingListenerForLocalReference</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// verify that no listener is loaded by default</span>

    URL urlWithoutListener = URL.valueOf(<span class="hljs-string">"injvm://127.0.0.1/DemoService"</span>).addParameter(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    AbstractInvoker&lt;DemoService&gt; invokerWithoutListener = <span class="hljs-keyword">new</span> AbstractInvoker&lt;DemoService&gt;(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithoutListener</span>) </span>{



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">protected</span> Result <span class="hljs-title">doInvoke</span><span class="hljs-params">(Invocation invocation)</span> <span class="hljs-keyword">throws</span> Throwable </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

        }

    };

    Protocol protocolWithoutListener = mock(Protocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(protocolWithoutListener.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithoutListener</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">invokerWithoutListener</span>)</span>;

    ProtocolListenerWrapper protocolListenerWrapperWithoutListener = <span class="hljs-keyword">new</span> ProtocolListenerWrapper(protocolWithoutListener);

    Invoker&lt;?&gt; invoker = protocolListenerWrapperWithoutListener.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithoutListener</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> ListenerInvokerWrapper);

    Assertions.assertEquals(<span class="hljs-number">0</span>, ((ListenerInvokerWrapper&lt;?&gt;) invoker).getListeners().size());

    <span class="hljs-comment">// verify that if the invoker.listener is configured, then load the specified listener</span>

    URL urlWithListener = URL.valueOf(<span class="hljs-string">"injvm://127.0.0.1/DemoService"</span>).addParameter(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>()).<span class="hljs-title">addParameter</span>(<span class="hljs-title">INVOKER_LISTENER_KEY</span>, "<span class="hljs-title">count</span>")</span>;

    AbstractInvoker&lt;DemoService&gt; invokerWithListener = <span class="hljs-keyword">new</span> AbstractInvoker&lt;DemoService&gt;(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithListener</span>) </span>{



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">protected</span> Result <span class="hljs-title">doInvoke</span><span class="hljs-params">(Invocation invocation)</span> <span class="hljs-keyword">throws</span> Throwable </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

        }

    };

    Protocol protocol = mock(Protocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(protocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithListener</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">invokerWithListener</span>)</span>;

    ProtocolListenerWrapper protocolListenerWrapper = <span class="hljs-keyword">new</span> ProtocolListenerWrapper(protocol);

    invoker = protocolListenerWrapper.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithListener</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> ListenerInvokerWrapper);

    Assertions.assertEquals(<span class="hljs-number">1</span>, CountInvokerListener.getCounter());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Protocol <span class="hljs-title">createMockProtocol</span><span class="hljs-params">(URL url, Invoker&lt;?&gt; invoker)</span> </span>{
    Protocol protocol = mock(Protocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(protocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">invoker</span>)</span>;
    <span class="hljs-keyword">return</span> protocol;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest562">Test Case ID #dubbo_Test_56_2</h4>
<h4 id="test-case-name-testloadinglistenerforremotereferencefile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcprotocolprotocollistenerwrappertestjava">Test Case Name: <code>testLoadingListenerForRemoteReference</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\protocol\ProtocolListenerWrapperTest.java</code>)</h4>
<h4 id="mock-object-variable-name-protocolwithoutlistener">Mock Object Variable Name: <code>protocolWithoutListener</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    AbstractInvoker&lt;DemoService&gt; invokerWithoutListener = new AbstractInvoker&lt;DemoService&gt;(DemoService.class, urlWithoutListener) {

        @Override
        protected Result doInvoke(Invocation invocation) throws Throwable {
            return null;
        }
    };
<span class="hljs-deletion">-    Protocol protocolWithoutListener = mock(Protocol.class);</span>
<span class="hljs-deletion">-    when(protocolWithoutListener.refer(DemoService.class, urlWithoutListener)).thenReturn(invokerWithoutListener);</span>
<span class="hljs-addition">+    Protocol protocolWithoutListener = createMockProtocol(urlWithoutListener, invokerWithoutListener);</span>
    ProtocolListenerWrapper protocolListenerWrapperWithoutListener = new ProtocolListenerWrapper(protocolWithoutListener);
    Invoker&lt;?&gt; invoker = protocolListenerWrapperWithoutListener.refer(DemoService.class, urlWithoutListener);
    Assertions.assertTrue(invoker instanceof ListenerInvokerWrapper);
    Assertions.assertEquals(0, ((ListenerInvokerWrapper&lt;?&gt;) invoker).getListeners().size());
    // verify that if the invoker.listener is configured, then load the specified listener
    URL urlWithListener = URL.valueOf("dubbo://127.0.0.1:20880/DemoService").addParameter(INTERFACE_KEY, DemoService.class.getName()).addParameter(INVOKER_LISTENER_KEY, "count");
    AbstractInvoker&lt;DemoService&gt; invokerWithListener = new AbstractInvoker&lt;DemoService&gt;(DemoService.class, urlWithListener) {

        @Override
        protected Result doInvoke(Invocation invocation) throws Throwable {
            return null;
        }
    };
    Protocol protocol = mock(Protocol.class);
    when(protocol.refer(DemoService.class, urlWithListener)).thenReturn(invokerWithListener);
    ProtocolListenerWrapper protocolListenerWrapper = new ProtocolListenerWrapper(protocol);
    invoker = protocolListenerWrapper.refer(DemoService.class, urlWithListener);
    Assertions.assertTrue(invoker instanceof ListenerInvokerWrapper);
    Assertions.assertEquals(1, CountInvokerListener.getCounter());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testLoadingListenerForRemoteReference</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// verify that no listener is loaded by default</span>

    URL urlWithoutListener = URL.valueOf(<span class="hljs-string">"dubbo://127.0.0.1:20880/DemoService"</span>).addParameter(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    AbstractInvoker&lt;DemoService&gt; invokerWithoutListener = <span class="hljs-keyword">new</span> AbstractInvoker&lt;DemoService&gt;(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithoutListener</span>) </span>{



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">protected</span> Result <span class="hljs-title">doInvoke</span><span class="hljs-params">(Invocation invocation)</span> <span class="hljs-keyword">throws</span> Throwable </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

        }

    };

    Protocol protocolWithoutListener = mock(Protocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(protocolWithoutListener.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithoutListener</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">invokerWithoutListener</span>)</span>;

    ProtocolListenerWrapper protocolListenerWrapperWithoutListener = <span class="hljs-keyword">new</span> ProtocolListenerWrapper(protocolWithoutListener);

    Invoker&lt;?&gt; invoker = protocolListenerWrapperWithoutListener.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithoutListener</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> ListenerInvokerWrapper);

    Assertions.assertEquals(<span class="hljs-number">0</span>, ((ListenerInvokerWrapper&lt;?&gt;) invoker).getListeners().size());

    <span class="hljs-comment">// verify that if the invoker.listener is configured, then load the specified listener</span>

    URL urlWithListener = URL.valueOf(<span class="hljs-string">"dubbo://127.0.0.1:20880/DemoService"</span>).addParameter(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>()).<span class="hljs-title">addParameter</span>(<span class="hljs-title">INVOKER_LISTENER_KEY</span>, "<span class="hljs-title">count</span>")</span>;

    AbstractInvoker&lt;DemoService&gt; invokerWithListener = <span class="hljs-keyword">new</span> AbstractInvoker&lt;DemoService&gt;(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithListener</span>) </span>{



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">protected</span> Result <span class="hljs-title">doInvoke</span><span class="hljs-params">(Invocation invocation)</span> <span class="hljs-keyword">throws</span> Throwable </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

        }

    };

    Protocol protocol = mock(Protocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(protocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithListener</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">invokerWithListener</span>)</span>;

    ProtocolListenerWrapper protocolListenerWrapper = <span class="hljs-keyword">new</span> ProtocolListenerWrapper(protocol);

    invoker = protocolListenerWrapper.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithListener</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> ListenerInvokerWrapper);

    Assertions.assertEquals(<span class="hljs-number">1</span>, CountInvokerListener.getCounter());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Protocol <span class="hljs-title">createMockProtocol</span><span class="hljs-params">(URL url, Invoker&lt;?&gt; invoker)</span> </span>{
    Protocol protocol = mock(Protocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(protocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">invoker</span>)</span>;
    <span class="hljs-keyword">return</span> protocol;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci57">Mock Clone Instance #dubbo_MCI_57</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Protocol</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Protocol <span class="hljs-title">createMockProtocol</span><span class="hljs-params">(URL urlWithListener, Invoker&lt;DemoService&gt; invokerWithListener)</span> </span>{
    Protocol protocol = mock(Protocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(protocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithListener</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">invokerWithListener</span>)</span>;
    <span class="hljs-keyword">return</span> protocol;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest571">Test Case ID #dubbo_Test_57_1</h4>
<h4 id="test-case-name-testloadinglistenerforlocalreferencefile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcprotocolprotocollistenerwrappertestjava">Test Case Name: <code>testLoadingListenerForLocalReference</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\protocol\ProtocolListenerWrapperTest.java</code>)</h4>
<h4 id="mock-object-variable-name-protocol">Mock Object Variable Name: <code>protocol</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    AbstractInvoker&lt;DemoService&gt; invokerWithListener = new AbstractInvoker&lt;DemoService&gt;(DemoService.class, urlWithListener) {

        @Override
        protected Result doInvoke(Invocation invocation) throws Throwable {
            return null;
        }
    };
<span class="hljs-deletion">-    Protocol protocol = mock(Protocol.class);</span>
<span class="hljs-deletion">-    when(protocol.refer(DemoService.class, urlWithListener)).thenReturn(invokerWithListener);</span>
<span class="hljs-addition">+    Protocol protocol = createMockProtocol(urlWithListener, invokerWithListener);</span>
    ProtocolListenerWrapper protocolListenerWrapper = new ProtocolListenerWrapper(protocol);
    invoker = protocolListenerWrapper.refer(DemoService.class, urlWithListener);
    Assertions.assertTrue(invoker instanceof ListenerInvokerWrapper);
    Assertions.assertEquals(1, CountInvokerListener.getCounter());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testLoadingListenerForLocalReference</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// verify that no listener is loaded by default</span>

    URL urlWithoutListener = URL.valueOf(<span class="hljs-string">"injvm://127.0.0.1/DemoService"</span>).addParameter(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    AbstractInvoker&lt;DemoService&gt; invokerWithoutListener = <span class="hljs-keyword">new</span> AbstractInvoker&lt;DemoService&gt;(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithoutListener</span>) </span>{



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">protected</span> Result <span class="hljs-title">doInvoke</span><span class="hljs-params">(Invocation invocation)</span> <span class="hljs-keyword">throws</span> Throwable </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

        }

    };

    Protocol protocolWithoutListener = mock(Protocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(protocolWithoutListener.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithoutListener</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">invokerWithoutListener</span>)</span>;

    ProtocolListenerWrapper protocolListenerWrapperWithoutListener = <span class="hljs-keyword">new</span> ProtocolListenerWrapper(protocolWithoutListener);

    Invoker&lt;?&gt; invoker = protocolListenerWrapperWithoutListener.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithoutListener</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> ListenerInvokerWrapper);

    Assertions.assertEquals(<span class="hljs-number">0</span>, ((ListenerInvokerWrapper&lt;?&gt;) invoker).getListeners().size());

    <span class="hljs-comment">// verify that if the invoker.listener is configured, then load the specified listener</span>

    URL urlWithListener = URL.valueOf(<span class="hljs-string">"injvm://127.0.0.1/DemoService"</span>).addParameter(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>()).<span class="hljs-title">addParameter</span>(<span class="hljs-title">INVOKER_LISTENER_KEY</span>, "<span class="hljs-title">count</span>")</span>;

    AbstractInvoker&lt;DemoService&gt; invokerWithListener = <span class="hljs-keyword">new</span> AbstractInvoker&lt;DemoService&gt;(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithListener</span>) </span>{



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">protected</span> Result <span class="hljs-title">doInvoke</span><span class="hljs-params">(Invocation invocation)</span> <span class="hljs-keyword">throws</span> Throwable </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

        }

    };

    Protocol protocol = mock(Protocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(protocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithListener</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">invokerWithListener</span>)</span>;

    ProtocolListenerWrapper protocolListenerWrapper = <span class="hljs-keyword">new</span> ProtocolListenerWrapper(protocol);

    invoker = protocolListenerWrapper.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithListener</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> ListenerInvokerWrapper);

    Assertions.assertEquals(<span class="hljs-number">1</span>, CountInvokerListener.getCounter());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Protocol <span class="hljs-title">createMockProtocol</span><span class="hljs-params">(URL urlWithListener, Invoker&lt;DemoService&gt; invokerWithListener)</span> </span>{
    Protocol protocol = mock(Protocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(protocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithListener</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">invokerWithListener</span>)</span>;
    <span class="hljs-keyword">return</span> protocol;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest572">Test Case ID #dubbo_Test_57_2</h4>
<h4 id="test-case-name-testloadinglistenerforremotereferencefile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-apisrctestjavaorgapachedubborpcprotocolprotocollistenerwrappertestjava">Test Case Name: <code>testLoadingListenerForRemoteReference</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-api\src\test\java\org\apache\dubbo\rpc\protocol\ProtocolListenerWrapperTest.java</code>)</h4>
<h4 id="mock-object-variable-name-protocol">Mock Object Variable Name: <code>protocol</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    AbstractInvoker&lt;DemoService&gt; invokerWithListener = new AbstractInvoker&lt;DemoService&gt;(DemoService.class, urlWithListener) {

        @Override
        protected Result doInvoke(Invocation invocation) throws Throwable {
            return null;
        }
    };
<span class="hljs-deletion">-    Protocol protocol = mock(Protocol.class);</span>
<span class="hljs-deletion">-    when(protocol.refer(DemoService.class, urlWithListener)).thenReturn(invokerWithListener);</span>
<span class="hljs-addition">+    Protocol protocol = createMockProtocol(urlWithListener, invokerWithListener);</span>
    ProtocolListenerWrapper protocolListenerWrapper = new ProtocolListenerWrapper(protocol);
    invoker = protocolListenerWrapper.refer(DemoService.class, urlWithListener);
    Assertions.assertTrue(invoker instanceof ListenerInvokerWrapper);
    Assertions.assertEquals(1, CountInvokerListener.getCounter());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testLoadingListenerForRemoteReference</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// verify that no listener is loaded by default</span>

    URL urlWithoutListener = URL.valueOf(<span class="hljs-string">"dubbo://127.0.0.1:20880/DemoService"</span>).addParameter(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    AbstractInvoker&lt;DemoService&gt; invokerWithoutListener = <span class="hljs-keyword">new</span> AbstractInvoker&lt;DemoService&gt;(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithoutListener</span>) </span>{



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">protected</span> Result <span class="hljs-title">doInvoke</span><span class="hljs-params">(Invocation invocation)</span> <span class="hljs-keyword">throws</span> Throwable </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

        }

    };

    Protocol protocolWithoutListener = mock(Protocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(protocolWithoutListener.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithoutListener</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">invokerWithoutListener</span>)</span>;

    ProtocolListenerWrapper protocolListenerWrapperWithoutListener = <span class="hljs-keyword">new</span> ProtocolListenerWrapper(protocolWithoutListener);

    Invoker&lt;?&gt; invoker = protocolListenerWrapperWithoutListener.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithoutListener</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> ListenerInvokerWrapper);

    Assertions.assertEquals(<span class="hljs-number">0</span>, ((ListenerInvokerWrapper&lt;?&gt;) invoker).getListeners().size());

    <span class="hljs-comment">// verify that if the invoker.listener is configured, then load the specified listener</span>

    URL urlWithListener = URL.valueOf(<span class="hljs-string">"dubbo://127.0.0.1:20880/DemoService"</span>).addParameter(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>()).<span class="hljs-title">addParameter</span>(<span class="hljs-title">INVOKER_LISTENER_KEY</span>, "<span class="hljs-title">count</span>")</span>;

    AbstractInvoker&lt;DemoService&gt; invokerWithListener = <span class="hljs-keyword">new</span> AbstractInvoker&lt;DemoService&gt;(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithListener</span>) </span>{



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">protected</span> Result <span class="hljs-title">doInvoke</span><span class="hljs-params">(Invocation invocation)</span> <span class="hljs-keyword">throws</span> Throwable </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

        }

    };

    Protocol protocol = mock(Protocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(protocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithListener</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">invokerWithListener</span>)</span>;

    ProtocolListenerWrapper protocolListenerWrapper = <span class="hljs-keyword">new</span> ProtocolListenerWrapper(protocol);

    invoker = protocolListenerWrapper.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithListener</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> ListenerInvokerWrapper);

    Assertions.assertEquals(<span class="hljs-number">1</span>, CountInvokerListener.getCounter());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Protocol <span class="hljs-title">createMockProtocol</span><span class="hljs-params">(URL urlWithListener, Invoker&lt;DemoService&gt; invokerWithListener)</span> </span>{
    Protocol protocol = mock(Protocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(protocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">urlWithListener</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">invokerWithListener</span>)</span>;
    <span class="hljs-keyword">return</span> protocol;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci58">Mock Clone Instance #dubbo_MCI_58</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.common.extension.ExtensionLoader&lt;org.apache.dubbo.registry.integration.RegistryProtocolListener&gt;</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ExtensionLoader&lt;RegistryProtocolListener&gt; <span class="hljs-title">createMockExtensionLoader</span><span class="hljs-params">(URL url, String registryProtocolListenerKey, List&lt;RegistryProtocolListener&gt; registryProtocolListeners)</span> </span>{
    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(extensionLoaderMock.getActivateExtension(url, registryProtocolListenerKey)).thenReturn(registryProtocolListeners);
    <span class="hljs-keyword">return</span> extensionLoaderMock;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest581">Test Case ID #dubbo_Test_58_1</h4>
<h4 id="test-case-name-testconsumerurlwithoutprotocolfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testConsumerUrlWithoutProtocol</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-extensionloadermock">Mock Object Variable Name: <code>extensionLoaderMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(new ApplicationConfig("application1"));
<span class="hljs-deletion">-    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader.class);</span>
<span class="hljs-deletion">-    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener.class)).thenReturn(extensionLoaderMock);</span>
<span class="hljs-deletion">-    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);</span>
<span class="hljs-addition">+    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = createMockExtensionLoader(url, REGISTRY_PROTOCOL_LISTENER_KEY, registryProtocolListeners);</span>
<span class="hljs-addition">+    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener.class)).thenReturn(extensionLoaderMock);</span>
    url = url.setScopeModel(moduleModel);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify the generated consumer url information

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumerUrlWithoutProtocol</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    <span class="hljs-comment">// verify that the protocol header of consumerUrl is set to "consumer"</span>

    Assertions.assertEquals(<span class="hljs-string">"consumer"</span>, consumerUrl.getProtocol());

    Assertions.assertEquals(parameters.get(REGISTER_IP_KEY), consumerUrl.getHost());

    Assertions.assertFalse(consumerUrl.getAttributes().containsKey(REFER_KEY));

    Assertions.assertEquals(<span class="hljs-string">"value1"</span>, consumerUrl.getAttribute(<span class="hljs-string">"key1"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ExtensionLoader&lt;RegistryProtocolListener&gt; <span class="hljs-title">createMockExtensionLoader</span><span class="hljs-params">(URL url, String registryProtocolListenerKey, List&lt;RegistryProtocolListener&gt; registryProtocolListeners)</span> </span>{
    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(extensionLoaderMock.getActivateExtension(url, registryProtocolListenerKey)).thenReturn(registryProtocolListeners);
    <span class="hljs-keyword">return</span> extensionLoaderMock;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest582">Test Case ID #dubbo_Test_58_2</h4>
<h4 id="test-case-name-testconsumerurlwithprotocolfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testConsumerUrlWithProtocol</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-extensionloadermock">Mock Object Variable Name: <code>extensionLoaderMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(new ApplicationConfig("application1"));
<span class="hljs-deletion">-    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader.class);</span>
<span class="hljs-deletion">-    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener.class)).thenReturn(extensionLoaderMock);</span>
<span class="hljs-deletion">-    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);</span>
<span class="hljs-addition">+    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = createMockExtensionLoader(url, REGISTRY_PROTOCOL_LISTENER_KEY, registryProtocolListeners);</span>
<span class="hljs-addition">+    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener.class)).thenReturn(extensionLoaderMock);</span>
    url = url.setScopeModel(moduleModel);
    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that when the protocol is configured, the protocol of consumer url is the configured protocol

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumerUrlWithProtocol</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    parameters.put(PROTOCOL_KEY, <span class="hljs-string">"tri"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    <span class="hljs-comment">// verify that the protocol of consumer url</span>

    Assertions.assertEquals(<span class="hljs-string">"tri"</span>, consumerUrl.getProtocol());

    Assertions.assertEquals(parameters.get(REGISTER_IP_KEY), consumerUrl.getHost());

    Assertions.assertFalse(consumerUrl.getAttributes().containsKey(REFER_KEY));

    Assertions.assertEquals(<span class="hljs-string">"value1"</span>, consumerUrl.getAttribute(<span class="hljs-string">"key1"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ExtensionLoader&lt;RegistryProtocolListener&gt; <span class="hljs-title">createMockExtensionLoader</span><span class="hljs-params">(URL url, String registryProtocolListenerKey, List&lt;RegistryProtocolListener&gt; registryProtocolListeners)</span> </span>{
    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(extensionLoaderMock.getActivateExtension(url, registryProtocolListenerKey)).thenReturn(registryProtocolListeners);
    <span class="hljs-keyword">return</span> extensionLoaderMock;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest583">Test Case ID #dubbo_Test_58_3</h4>
<h4 id="test-case-name-testinterceptinvokerformigrationrulelistenerfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testInterceptInvokerForMigrationRuleListener</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-extensionloadermock">Mock Object Variable Name: <code>extensionLoaderMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(new ApplicationConfig("application1"));
<span class="hljs-deletion">-    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader.class);</span>
<span class="hljs-deletion">-    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener.class)).thenReturn(extensionLoaderMock);</span>
<span class="hljs-deletion">-    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);</span>
<span class="hljs-addition">+    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = createMockExtensionLoader(url, REGISTRY_PROTOCOL_LISTENER_KEY, registryProtocolListeners);</span>
<span class="hljs-addition">+    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener.class)).thenReturn(extensionLoaderMock);</span>
    url = url.setScopeModel(moduleModel);
    registryProtocol.interceptInvoker(clusterInvoker, url, consumerUrl);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that the default RegistryProtocolListener will be executed

 *

 * <span class="hljs-doctag">@see</span> MigrationRuleListener

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInterceptInvokerForMigrationRuleListener</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    refer.put(GROUP_KEY, <span class="hljs-string">"group1,group2"</span>);

    attributes.put(REFER_KEY, refer);

    URL url = serviceConfigURL.addAttributes(attributes);

    MigrationInvoker&lt;?&gt; clusterInvoker = mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Map&lt;String, Object&gt; consumerAttribute = <span class="hljs-keyword">new</span> HashMap&lt;&gt;(url.getAttributes());

    consumerAttribute.remove(REFER_KEY);

    URL consumerUrl = <span class="hljs-keyword">new</span> ServiceConfigURL(parameters.get(PROTOCOL_KEY) == <span class="hljs-keyword">null</span> ? DUBBO : parameters.get(PROTOCOL_KEY), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, parameters.get(REGISTER_IP_KEY), <span class="hljs-number">0</span>, url.getPath(), parameters, consumerAttribute);

    url = url.putAttribute(CONSUMER_URL_KEY, consumerUrl);

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    registryProtocol.interceptInvoker(clusterInvoker, url, consumerUrl);

    verify(migrationRuleListener, times(<span class="hljs-number">1</span>)).onRefer(registryProtocol, clusterInvoker, consumerUrl, url);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ExtensionLoader&lt;RegistryProtocolListener&gt; <span class="hljs-title">createMockExtensionLoader</span><span class="hljs-params">(URL url, String registryProtocolListenerKey, List&lt;RegistryProtocolListener&gt; registryProtocolListeners)</span> </span>{
    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(extensionLoaderMock.getActivateExtension(url, registryProtocolListenerKey)).thenReturn(registryProtocolListeners);
    <span class="hljs-keyword">return</span> extensionLoaderMock;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest584">Test Case ID #dubbo_Test_58_4</h4>
<h4 id="test-case-name-testinterceptinvokerforcustomregistryprotocollistenerfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testInterceptInvokerForCustomRegistryProtocolListener</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-extensionloadermock">Mock Object Variable Name: <code>extensionLoaderMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(new ApplicationConfig("application1"));
<span class="hljs-deletion">-    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader.class);</span>
<span class="hljs-addition">+    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = createMockExtensionLoader(url, REGISTRY_PROTOCOL_LISTENER_KEY, registryProtocolListeners);</span>
    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener.class)).thenReturn(extensionLoaderMock);
<span class="hljs-deletion">-    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);</span>
    url = url.setScopeModel(moduleModel);
    registryProtocol.interceptInvoker(clusterInvoker, url, consumerUrl);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Verify that if registry.protocol.listener is configured,

 * whether the corresponding RegistryProtocolListener will be executed normally

 *

 * <span class="hljs-doctag">@see</span> CountRegistryProtocolListener

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInterceptInvokerForCustomRegistryProtocolListener</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    parameters.put(REGISTRY_PROTOCOL_LISTENER_KEY, <span class="hljs-string">"count"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    refer.put(GROUP_KEY, <span class="hljs-string">"group1,group2"</span>);

    attributes.put(REFER_KEY, refer);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    MigrationInvoker&lt;?&gt; clusterInvoker = mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Map&lt;String, Object&gt; consumerAttribute = <span class="hljs-keyword">new</span> HashMap&lt;&gt;(url.getAttributes());

    consumerAttribute.remove(REFER_KEY);

    URL consumerUrl = <span class="hljs-keyword">new</span> ServiceConfigURL(parameters.get(PROTOCOL_KEY) == <span class="hljs-keyword">null</span> ? DUBBO : parameters.get(PROTOCOL_KEY), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, parameters.get(REGISTER_IP_KEY), <span class="hljs-number">0</span>, url.getPath(), parameters, consumerAttribute);

    url = url.putAttribute(CONSUMER_URL_KEY, consumerUrl);

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(<span class="hljs-keyword">new</span> CountRegistryProtocolListener());

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    registryProtocol.interceptInvoker(clusterInvoker, url, consumerUrl);

    Assertions.assertEquals(<span class="hljs-number">1</span>, CountRegistryProtocolListener.getReferCounter().get());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ExtensionLoader&lt;RegistryProtocolListener&gt; <span class="hljs-title">createMockExtensionLoader</span><span class="hljs-params">(URL url, String registryProtocolListenerKey, List&lt;RegistryProtocolListener&gt; registryProtocolListeners)</span> </span>{
    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(extensionLoaderMock.getActivateExtension(url, registryProtocolListenerKey)).thenReturn(registryProtocolListeners);
    <span class="hljs-keyword">return</span> extensionLoaderMock;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci59">Mock Clone Instance #dubbo_MCI_59</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.auth.AccessKeyAuthenticator</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AccessKeyAuthenticator <span class="hljs-title">createMockAccessKeyAuthenticator</span><span class="hljs-params">(Invocation invocation, URL url, AccessKeyPair accessKeyPair, String signatureReturn)</span> </span>{
    AccessKeyAuthenticator helper = mock(AccessKeyAuthenticator<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(helper.getAccessKeyPair(invocation, url)).thenReturn(accessKeyPair);
    when(helper.getSignature(eq(url), eq(invocation), eq(<span class="hljs-string">"sk"</span>), anyString())).thenReturn(signatureReturn);
    <span class="hljs-keyword">return</span> helper;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest591">Test Case ID #dubbo_Test_59_1</h4>
<h4 id="test-case-name-testsignforrequestfile-cjavaprojectsapachedubbodubbo-plugindubbo-authsrctestjavaorgapachedubboauthaccesskeyauthenticatortestjava">Test Case Name: <code>testSignForRequest</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-auth\src\test\java\org\apache\dubbo\auth\AccessKeyAuthenticatorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-helper">Mock Object Variable Name: <code>helper</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    URL url = URL.valueOf("dubbo://10.10.10.10:2181").addParameter(Constants.ACCESS_KEY_ID_KEY, "ak").addParameter(CommonConstants.APPLICATION_KEY, "test").addParameter(Constants.SECRET_ACCESS_KEY_KEY, "sk");
    Invocation invocation = new RpcInvocation();
<span class="hljs-deletion">-    AccessKeyAuthenticator helper = mock(AccessKeyAuthenticator.class);</span>
<span class="hljs-deletion">-    doCallRealMethod().when(helper).sign(invocation, url);</span>
<span class="hljs-deletion">-    when(helper.getSignature(eq(url), eq(invocation), eq("sk"), anyString())).thenReturn("dubbo");</span>
    AccessKeyPair accessKeyPair = mock(AccessKeyPair.class);
    when(accessKeyPair.getSecretKey()).thenReturn("sk");
<span class="hljs-addition">+    AccessKeyAuthenticator helper = createMockAccessKeyAuthenticator(invocation, url, accessKeyPair, "dubbo");</span>
<span class="hljs-addition">+    doCallRealMethod().when(helper).sign(invocation, url);</span>
    helper.sign(invocation, url);
    assertEquals(String.valueOf(invocation.getAttachment(CommonConstants.CONSUMER)), url.getApplication());
    assertNotNull(invocation.getAttachments().get(Constants.REQUEST_SIGNATURE_KEY));
    assertEquals(invocation.getAttachments().get(Constants.REQUEST_SIGNATURE_KEY), "dubbo");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testSignForRequest</span><span class="hljs-params">()</span> </span>{

    URL url = URL.valueOf(<span class="hljs-string">"dubbo://10.10.10.10:2181"</span>).addParameter(Constants.ACCESS_KEY_ID_KEY, <span class="hljs-string">"ak"</span>).addParameter(CommonConstants.APPLICATION_KEY, <span class="hljs-string">"test"</span>).addParameter(Constants.SECRET_ACCESS_KEY_KEY, <span class="hljs-string">"sk"</span>);

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    AccessKeyAuthenticator helper = mock(AccessKeyAuthenticator<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    doCallRealMethod().when(helper).sign(invocation, url);

    when(helper.getSignature(eq(url), eq(invocation), eq(<span class="hljs-string">"sk"</span>), anyString())).thenReturn(<span class="hljs-string">"dubbo"</span>);

    AccessKeyPair accessKeyPair = mock(AccessKeyPair<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(accessKeyPair.getSecretKey()).thenReturn(<span class="hljs-string">"sk"</span>);

    when(helper.getAccessKeyPair(invocation, url)).thenReturn(accessKeyPair);

    helper.sign(invocation, url);

    assertEquals(String.valueOf(invocation.getAttachment(CommonConstants.CONSUMER)), url.getApplication());

    assertNotNull(invocation.getAttachments().get(Constants.REQUEST_SIGNATURE_KEY));

    assertEquals(invocation.getAttachments().get(Constants.REQUEST_SIGNATURE_KEY), <span class="hljs-string">"dubbo"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AccessKeyAuthenticator <span class="hljs-title">createMockAccessKeyAuthenticator</span><span class="hljs-params">(Invocation invocation, URL url, AccessKeyPair accessKeyPair, String signatureReturn)</span> </span>{
    AccessKeyAuthenticator helper = mock(AccessKeyAuthenticator<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(helper.getAccessKeyPair(invocation, url)).thenReturn(accessKeyPair);
    when(helper.getSignature(eq(url), eq(invocation), eq(<span class="hljs-string">"sk"</span>), anyString())).thenReturn(signatureReturn);
    <span class="hljs-keyword">return</span> helper;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest592">Test Case ID #dubbo_Test_59_2</h4>
<h4 id="test-case-name-testauthenticaterequestfile-cjavaprojectsapachedubbodubbo-plugindubbo-authsrctestjavaorgapachedubboauthaccesskeyauthenticatortestjava">Test Case Name: <code>testAuthenticateRequest</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-auth\src\test\java\org\apache\dubbo\auth\AccessKeyAuthenticatorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-helper">Mock Object Variable Name: <code>helper</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    invocation.setAttachment(CommonConstants.CONSUMER, "test");
<span class="hljs-deletion">-    AccessKeyAuthenticator helper = mock(AccessKeyAuthenticator.class);</span>
<span class="hljs-deletion">-    doCallRealMethod().when(helper).authenticate(invocation, url);</span>
<span class="hljs-deletion">-    when(helper.getSignature(eq(url), eq(invocation), eq("sk"), anyString())).thenReturn("dubbo");</span>
    AccessKeyPair accessKeyPair = mock(AccessKeyPair.class);
    when(accessKeyPair.getSecretKey()).thenReturn("sk");
<span class="hljs-deletion">-    when(helper.getAccessKeyPair(invocation, url)).thenReturn(accessKeyPair);</span>
<span class="hljs-addition">+    AccessKeyAuthenticator helper = createMockAccessKeyAuthenticator(invocation, url, accessKeyPair, "dubbo");</span>
<span class="hljs-addition">+    doCallRealMethod().when(helper).authenticate(invocation, url);</span>
    assertDoesNotThrow(() -&gt; helper.authenticate(invocation, url));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testAuthenticateRequest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RpcAuthenticationException </span>{

    URL url = URL.valueOf(<span class="hljs-string">"dubbo://10.10.10.10:2181"</span>).addParameter(Constants.ACCESS_KEY_ID_KEY, <span class="hljs-string">"ak"</span>).addParameter(CommonConstants.APPLICATION_KEY, <span class="hljs-string">"test"</span>).addParameter(Constants.SECRET_ACCESS_KEY_KEY, <span class="hljs-string">"sk"</span>);

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    invocation.setAttachment(Constants.ACCESS_KEY_ID_KEY, <span class="hljs-string">"ak"</span>);

    invocation.setAttachment(Constants.REQUEST_SIGNATURE_KEY, <span class="hljs-string">"dubbo"</span>);

    invocation.setAttachment(Constants.REQUEST_TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));

    invocation.setAttachment(CommonConstants.CONSUMER, <span class="hljs-string">"test"</span>);

    AccessKeyAuthenticator helper = mock(AccessKeyAuthenticator<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    doCallRealMethod().when(helper).authenticate(invocation, url);

    when(helper.getSignature(eq(url), eq(invocation), eq(<span class="hljs-string">"sk"</span>), anyString())).thenReturn(<span class="hljs-string">"dubbo"</span>);

    AccessKeyPair accessKeyPair = mock(AccessKeyPair<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(accessKeyPair.getSecretKey()).thenReturn(<span class="hljs-string">"sk"</span>);

    when(helper.getAccessKeyPair(invocation, url)).thenReturn(accessKeyPair);

    assertDoesNotThrow(() -&gt; helper.authenticate(invocation, url));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AccessKeyAuthenticator <span class="hljs-title">createMockAccessKeyAuthenticator</span><span class="hljs-params">(Invocation invocation, URL url, AccessKeyPair accessKeyPair, String signatureReturn)</span> </span>{
    AccessKeyAuthenticator helper = mock(AccessKeyAuthenticator<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(helper.getAccessKeyPair(invocation, url)).thenReturn(accessKeyPair);
    when(helper.getSignature(eq(url), eq(invocation), eq(<span class="hljs-string">"sk"</span>), anyString())).thenReturn(signatureReturn);
    <span class="hljs-keyword">return</span> helper;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci60">Mock Clone Instance #dubbo_MCI_60</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.common.threadpool.support.eager.EagerThreadPoolExecutor</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> EagerThreadPoolExecutor <span class="hljs-title">createMockEagerThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-keyword">int</span> poolSizeReturn, <span class="hljs-keyword">int</span> activeCountReturn)</span> </span>{
    EagerThreadPoolExecutor executor = mock(EagerThreadPoolExecutor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(executor.getPoolSize()).thenReturn(poolSizeReturn);
    Mockito.when(executor.getActiveCount()).thenReturn(activeCountReturn);
    <span class="hljs-keyword">return</span> executor;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest601">Test Case ID #dubbo_Test_60_1</h4>
<h4 id="test-case-name-testoffer2file-cjavaprojectsapachedubbodubbo-commonsrctestjavaorgapachedubbocommonthreadpoolsupporteagertaskqueuetestjava">Test Case Name: <code>testOffer2</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-common\src\test\java\org\apache\dubbo\common\threadpool\support\eager\TaskQueueTest.java</code>)</h4>
<h4 id="mock-object-variable-name-executor">Mock Object Variable Name: <code>executor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 void testOffer2() throws Exception {
     TaskQueue&lt;Runnable&gt; queue = new TaskQueue&lt;Runnable&gt;(1);
<span class="hljs-deletion">-    EagerThreadPoolExecutor executor = mock(EagerThreadPoolExecutor.class);</span>
<span class="hljs-deletion">-    Mockito.when(executor.getPoolSize()).thenReturn(2);</span>
<span class="hljs-deletion">-    Mockito.when(executor.getActiveCount()).thenReturn(1);</span>
<span class="hljs-addition">+    EagerThreadPoolExecutor executor = createMockEagerThreadPoolExecutor(2, 1);</span>
     queue.setExecutor(executor);
     assertThat(queue.offer(mock(Runnable.class)), is(true));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testOffer2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TaskQueue&lt;Runnable&gt; queue = <span class="hljs-keyword">new</span> TaskQueue&lt;Runnable&gt;(<span class="hljs-number">1</span>);

    EagerThreadPoolExecutor executor = mock(EagerThreadPoolExecutor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(executor.getPoolSize()).thenReturn(<span class="hljs-number">2</span>);

    Mockito.when(executor.getActiveCount()).thenReturn(<span class="hljs-number">1</span>);

    queue.setExecutor(executor);

    assertThat(queue.offer(mock(Runnable<span class="hljs-class">.<span class="hljs-keyword">class</span>)), <span class="hljs-title">is</span>(<span class="hljs-title">true</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> EagerThreadPoolExecutor <span class="hljs-title">createMockEagerThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-keyword">int</span> poolSizeReturn, <span class="hljs-keyword">int</span> activeCountReturn)</span> </span>{
    EagerThreadPoolExecutor executor = mock(EagerThreadPoolExecutor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(executor.getPoolSize()).thenReturn(poolSizeReturn);
    Mockito.when(executor.getActiveCount()).thenReturn(activeCountReturn);
    <span class="hljs-keyword">return</span> executor;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest602">Test Case ID #dubbo_Test_60_2</h4>
<h4 id="test-case-name-testoffer3file-cjavaprojectsapachedubbodubbo-commonsrctestjavaorgapachedubbocommonthreadpoolsupporteagertaskqueuetestjava">Test Case Name: <code>testOffer3</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-common\src\test\java\org\apache\dubbo\common\threadpool\support\eager\TaskQueueTest.java</code>)</h4>
<h4 id="mock-object-variable-name-executor">Mock Object Variable Name: <code>executor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 void testOffer3() throws Exception {
     TaskQueue&lt;Runnable&gt; queue = new TaskQueue&lt;Runnable&gt;(1);
<span class="hljs-deletion">-    EagerThreadPoolExecutor executor = mock(EagerThreadPoolExecutor.class);</span>
<span class="hljs-deletion">-    Mockito.when(executor.getPoolSize()).thenReturn(2);</span>
<span class="hljs-deletion">-    Mockito.when(executor.getActiveCount()).thenReturn(2);</span>
<span class="hljs-deletion">-    Mockito.when(executor.getMaximumPoolSize()).thenReturn(4);</span>
<span class="hljs-addition">+    EagerThreadPoolExecutor executor = createMockEagerThreadPoolExecutor(2, 2);</span>
<span class="hljs-addition">+    Mockito.when(executor.getMaximumPoolSize()).thenReturn(4);</span>
     queue.setExecutor(executor);
     assertThat(queue.offer(mock(Runnable.class)), is(false));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testOffer3</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TaskQueue&lt;Runnable&gt; queue = <span class="hljs-keyword">new</span> TaskQueue&lt;Runnable&gt;(<span class="hljs-number">1</span>);

    EagerThreadPoolExecutor executor = mock(EagerThreadPoolExecutor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(executor.getPoolSize()).thenReturn(<span class="hljs-number">2</span>);

    Mockito.when(executor.getActiveCount()).thenReturn(<span class="hljs-number">2</span>);

    Mockito.when(executor.getMaximumPoolSize()).thenReturn(<span class="hljs-number">4</span>);

    queue.setExecutor(executor);

    assertThat(queue.offer(mock(Runnable<span class="hljs-class">.<span class="hljs-keyword">class</span>)), <span class="hljs-title">is</span>(<span class="hljs-title">false</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> EagerThreadPoolExecutor <span class="hljs-title">createMockEagerThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-keyword">int</span> poolSizeReturn, <span class="hljs-keyword">int</span> activeCountReturn)</span> </span>{
    EagerThreadPoolExecutor executor = mock(EagerThreadPoolExecutor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(executor.getPoolSize()).thenReturn(poolSizeReturn);
    Mockito.when(executor.getActiveCount()).thenReturn(activeCountReturn);
    <span class="hljs-keyword">return</span> executor;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest603">Test Case ID #dubbo_Test_60_3</h4>
<h4 id="test-case-name-testoffer4file-cjavaprojectsapachedubbodubbo-commonsrctestjavaorgapachedubbocommonthreadpoolsupporteagertaskqueuetestjava">Test Case Name: <code>testOffer4</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-common\src\test\java\org\apache\dubbo\common\threadpool\support\eager\TaskQueueTest.java</code>)</h4>
<h4 id="mock-object-variable-name-executor">Mock Object Variable Name: <code>executor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    TaskQueue&lt;Runnable&gt; queue = new TaskQueue&lt;Runnable&gt;(1);
<span class="hljs-deletion">-    EagerThreadPoolExecutor executor = mock(EagerThreadPoolExecutor.class);</span>
<span class="hljs-deletion">-    Mockito.when(executor.getPoolSize()).thenReturn(4);</span>
<span class="hljs-deletion">-    Mockito.when(executor.getActiveCount()).thenReturn(4);</span>
<span class="hljs-deletion">-    Mockito.when(executor.getMaximumPoolSize()).thenReturn(4);</span>
<span class="hljs-addition">+    EagerThreadPoolExecutor executor = createMockEagerThreadPoolExecutor(4, 4);</span>
<span class="hljs-addition">+    Mockito.when(executor.getMaximumPoolSize()).thenReturn(4);</span>
    queue.setExecutor(executor);
    assertThat(queue.offer(mock(Runnable.class)), is(true));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testOffer4</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TaskQueue&lt;Runnable&gt; queue = <span class="hljs-keyword">new</span> TaskQueue&lt;Runnable&gt;(<span class="hljs-number">1</span>);

    EagerThreadPoolExecutor executor = mock(EagerThreadPoolExecutor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(executor.getPoolSize()).thenReturn(<span class="hljs-number">4</span>);

    Mockito.when(executor.getActiveCount()).thenReturn(<span class="hljs-number">4</span>);

    Mockito.when(executor.getMaximumPoolSize()).thenReturn(<span class="hljs-number">4</span>);

    queue.setExecutor(executor);

    assertThat(queue.offer(mock(Runnable<span class="hljs-class">.<span class="hljs-keyword">class</span>)), <span class="hljs-title">is</span>(<span class="hljs-title">true</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> EagerThreadPoolExecutor <span class="hljs-title">createMockEagerThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-keyword">int</span> poolSizeReturn, <span class="hljs-keyword">int</span> activeCountReturn)</span> </span>{
    EagerThreadPoolExecutor executor = mock(EagerThreadPoolExecutor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(executor.getPoolSize()).thenReturn(poolSizeReturn);
    Mockito.when(executor.getActiveCount()).thenReturn(activeCountReturn);
    <span class="hljs-keyword">return</span> executor;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci61">Mock Clone Instance #dubbo_MCI_61</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.model.ProviderModel</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockProviderModel</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ProviderModel <span class="hljs-title">createMockProviderModel</span><span class="hljs-params">(ServiceDescriptor serviceDescriptor)</span> </span>{
        ProviderModel providerModel = Mockito.mock(ProviderModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(providerModel.getServiceModel()).thenReturn(serviceDescriptor);
        <span class="hljs-keyword">return</span> providerModel;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest611">Test Case ID #dubbo_Test_61_1</h4>
<h4 id="test-case-name-dostartcallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcprotocoltricallreflectionservercalltestjava">Test Case Name: <code>doStartCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\protocol\tri\call\ReflectionServerCallTest.java</code>)</h4>
<h4 id="mock-object-variable-name-providermodel">Mock Object Variable Name: <code>providerModel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    TripleServerStream serverStream = Mockito.mock(TripleServerStream.class);
<span class="hljs-deletion">-    ProviderModel providerModel = Mockito.mock(ProviderModel.class);</span>
    Method method = DescriptorService.class.getMethod("sayHello", HelloReply.class);
    MethodDescriptor methodDescriptor = new ReflectionMethodDescriptor(method);
    URL url = Mockito.mock(URL.class);
    when(invoker.getUrl()).thenReturn(url);
    when(url.getServiceModel()).thenReturn(providerModel);
    String service = "testService";
    String methodName = "method";
    try {
        ReflectionAbstractServerCall call = new ReflectionAbstractServerCall(invoker, serverStream, new FrameworkModel(), "", service, methodName, Collections.emptyList(), ImmediateEventExecutor.INSTANCE);
        fail();
    } catch (Exception e) {
        // pass
    }
    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
    when(serviceDescriptor.getMethods(anyString())).thenReturn(Collections.singletonList(methodDescriptor));
<span class="hljs-addition">+    ProviderModel providerModel = MockProviderModel.createMockProviderModel(serviceDescriptor);</span>
    ReflectionAbstractServerCall call2 = new ReflectionAbstractServerCall(invoker, serverStream, new FrameworkModel(), "", service, methodName, Collections.emptyList(), ImmediateEventExecutor.INSTANCE);
    call2.onHeader(Collections.emptyMap());
    call2.onMessage(new byte[0], false);
    call2.onComplete();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">doStartCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> NoSuchMethodException </span>{

    Invoker&lt;?&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TripleServerStream serverStream = Mockito.mock(TripleServerStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ProviderModel providerModel = Mockito.mock(ProviderModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Method method = DescriptorService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getMethod</span>("<span class="hljs-title">sayHello</span>", <span class="hljs-title">HelloReply</span>.<span class="hljs-title">class</span>)</span>;

    MethodDescriptor methodDescriptor = <span class="hljs-keyword">new</span> ReflectionMethodDescriptor(method);

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(url.getServiceModel()).thenReturn(providerModel);

    String service = <span class="hljs-string">"testService"</span>;

    String methodName = <span class="hljs-string">"method"</span>;

    <span class="hljs-keyword">try</span> {

        ReflectionAbstractServerCall call = <span class="hljs-keyword">new</span> ReflectionAbstractServerCall(invoker, serverStream, <span class="hljs-keyword">new</span> FrameworkModel(), <span class="hljs-string">""</span>, service, methodName, Collections.emptyList(), ImmediateEventExecutor.INSTANCE);

        fail();

    } <span class="hljs-keyword">catch</span> (Exception e) {

        <span class="hljs-comment">// pass</span>

    }

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(serviceDescriptor.getMethods(anyString())).thenReturn(Collections.singletonList(methodDescriptor));

    when(providerModel.getServiceModel()).thenReturn(serviceDescriptor);

    ReflectionAbstractServerCall call2 = <span class="hljs-keyword">new</span> ReflectionAbstractServerCall(invoker, serverStream, <span class="hljs-keyword">new</span> FrameworkModel(), <span class="hljs-string">""</span>, service, methodName, Collections.emptyList(), ImmediateEventExecutor.INSTANCE);

    call2.onHeader(Collections.emptyMap());

    call2.onMessage(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">0</span>], <span class="hljs-keyword">false</span>);

    call2.onComplete();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockProviderModel</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ProviderModel <span class="hljs-title">createMockProviderModel</span><span class="hljs-params">(ServiceDescriptor serviceDescriptor)</span> </span>{
        ProviderModel providerModel = Mockito.mock(ProviderModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(providerModel.getServiceModel()).thenReturn(serviceDescriptor);
        <span class="hljs-keyword">return</span> providerModel;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest612">Test Case ID #dubbo_Test_61_2</h4>
<h4 id="test-case-name-dostartcallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcprotocoltricallstubservercalltestjava">Test Case Name: <code>doStartCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\protocol\tri\call\StubServerCallTest.java</code>)</h4>
<h4 id="mock-object-variable-name-providermodel">Mock Object Variable Name: <code>providerModel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Invoker&lt;?&gt; invoker = Mockito.mock(Invoker.class);
    TripleServerStream tripleServerStream = Mockito.mock(TripleServerStream.class);
<span class="hljs-deletion">-    ProviderModel providerModel = Mockito.mock(ProviderModel.class);</span>
    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
    StubMethodDescriptor methodDescriptor = Mockito.mock(StubMethodDescriptor.class);
    URL url = Mockito.mock(URL.class);
    when(invoker.getUrl()).thenReturn(url);
    when(url.getServiceModel()).thenReturn(providerModel);
<span class="hljs-addition">+    ProviderModel providerModel = MockProviderModel.createMockProviderModel(serviceDescriptor);</span>
    when(serviceDescriptor.getMethods(anyString())).thenReturn(Collections.singletonList(methodDescriptor));
    when(methodDescriptor.getRpcType()).thenReturn(RpcType.UNARY);
    when(methodDescriptor.parseRequest(any(byte[].class))).thenReturn("test");
    String service = "testService";
    String method = "method";
    StubAbstractServerCall call = new StubAbstractServerCall(invoker, tripleServerStream, new FrameworkModel(), "", service, method, ImmediateEventExecutor.INSTANCE);
    call.onHeader(Collections.emptyMap());
    call.onMessage(new byte[0], false);
    call.onComplete();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">doStartCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>{

    Invoker&lt;?&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TripleServerStream tripleServerStream = Mockito.mock(TripleServerStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ProviderModel providerModel = Mockito.mock(ProviderModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    StubMethodDescriptor methodDescriptor = Mockito.mock(StubMethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(url.getServiceModel()).thenReturn(providerModel);

    when(providerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(serviceDescriptor.getMethods(anyString())).thenReturn(Collections.singletonList(methodDescriptor));

    when(methodDescriptor.getRpcType()).thenReturn(RpcType.UNARY);

    when(methodDescriptor.parseRequest(any(<span class="hljs-keyword">byte</span>[]<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>("<span class="hljs-title">test</span>")</span>;

    String service = <span class="hljs-string">"testService"</span>;

    String method = <span class="hljs-string">"method"</span>;

    StubAbstractServerCall call = <span class="hljs-keyword">new</span> StubAbstractServerCall(invoker, tripleServerStream, <span class="hljs-keyword">new</span> FrameworkModel(), <span class="hljs-string">""</span>, service, method, ImmediateEventExecutor.INSTANCE);

    call.onHeader(Collections.emptyMap());

    call.onMessage(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">0</span>], <span class="hljs-keyword">false</span>);

    call.onComplete();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockProviderModel</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ProviderModel <span class="hljs-title">createMockProviderModel</span><span class="hljs-params">(ServiceDescriptor serviceDescriptor)</span> </span>{
        ProviderModel providerModel = Mockito.mock(ProviderModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        when(providerModel.getServiceModel()).thenReturn(serviceDescriptor);
        <span class="hljs-keyword">return</span> providerModel;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci62">Mock Clone Instance #dubbo_MCI_62</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Invoker&lt;org.apache.dubbo.rpc.cluster.StickyTest&gt;</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;StickyTest&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url, Result result, RpcInvocation invocation)</span> </span>{
    Invoker&lt;StickyTest&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getInterface()).willReturn(StickyTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getUrl()).willReturn(url);
    given(invoker.invoke(invocation)).willReturn(result);
    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest621">Test Case ID #dubbo_Test_62_1</h4>
<h4 id="test-case-name-teststickyfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclusterstickytestjava">Test Case Name: <code>testSticky</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\StickyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker1">Mock Object Variable Name: <code>invoker1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- Original.java</span>
<span class="hljs-comment">+++ Refactored.java</span>
@@
public int testSticky(String methodName, boolean check) {
    if (methodName == null) {
        url = url.addParameter(CLUSTER_STICKY_KEY, String.valueOf(check));
    } else {
        url = url.addParameter(methodName + "." + CLUSTER_STICKY_KEY, String.valueOf(check));
    }
<span class="hljs-deletion">-    given(invoker1.invoke(invocation)).willReturn(result);</span>
<span class="hljs-deletion">-    given(invoker1.isAvailable()).willReturn(true);</span>
<span class="hljs-deletion">-    given(invoker1.getUrl()).willReturn(url.setPort(1));</span>
<span class="hljs-deletion">-    given(invoker1.getInterface()).willReturn(StickyTest.class);</span>
<span class="hljs-addition">+    invoker1 = createMockInvoker(url.setPort(1), result, invocation);</span>
    given(invoker2.invoke(invocation)).willReturn(result);
    given(invoker2.isAvailable()).willReturn(true);
    given(invoker2.getUrl()).willReturn(url.setPort(2));
    given(invoker2.getInterface()).willReturn(StickyTest.class);
    invocation.setMethodName(methodName);
    int count = 0;
    for (int i = 0; i &lt; runs; i++) {
        Assertions.assertNull(clusterinvoker.invoke(invocation));
        if (invoker1 == clusterinvoker.getSelectedInvoker()) {
            count++;
        }
    }
    return count;
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    given(dic.getUrl()).willReturn(url);

    given(dic.getConsumerUrl()).willReturn(url);

    given(dic.list(invocation)).willReturn(invokers);

    given(dic.getInterface()).willReturn(StickyTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invokers.add(invoker1);

    invokers.add(invoker2);

    clusterinvoker = <span class="hljs-keyword">new</span> StickyClusterInvoker&lt;StickyTest&gt;(dic);

}
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">testSticky</span><span class="hljs-params">(String methodName, <span class="hljs-keyword">boolean</span> check)</span> </span>{

    <span class="hljs-keyword">if</span> (methodName == <span class="hljs-keyword">null</span>) {

        url = url.addParameter(CLUSTER_STICKY_KEY, String.valueOf(check));

    } <span class="hljs-keyword">else</span> {

        url = url.addParameter(methodName + <span class="hljs-string">"."</span> + CLUSTER_STICKY_KEY, String.valueOf(check));

    }

    given(invoker1.invoke(invocation)).willReturn(result);

    given(invoker1.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker1.getUrl()).willReturn(url.setPort(<span class="hljs-number">1</span>));

    given(invoker1.getInterface()).willReturn(StickyTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker2.invoke(invocation)).willReturn(result);

    given(invoker2.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker2.getUrl()).willReturn(url.setPort(<span class="hljs-number">2</span>));

    given(invoker2.getInterface()).willReturn(StickyTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation.setMethodName(methodName);

    <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; runs; i++) {

        Assertions.assertNull(clusterinvoker.invoke(invocation));

        <span class="hljs-keyword">if</span> (invoker1 == clusterinvoker.getSelectedInvoker()) {

            count++;

        }

    }

    <span class="hljs-keyword">return</span> count;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;StickyTest&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url, Result result, RpcInvocation invocation)</span> </span>{
    Invoker&lt;StickyTest&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getInterface()).willReturn(StickyTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getUrl()).willReturn(url);
    given(invoker.invoke(invocation)).willReturn(result);
    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest622">Test Case ID #dubbo_Test_62_2</h4>
<h4 id="test-case-name-teststickyfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclusterstickytestjava">Test Case Name: <code>testSticky</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\StickyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker2">Mock Object Variable Name: <code>invoker2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- Original</span>
<span class="hljs-comment">+++ Refactored</span>
@@
<span class="hljs-deletion">-private Invoker&lt;StickyTest&gt; invoker2 = mock(Invoker.class);</span>
@@
public int testSticky(String methodName, boolean check) {
    if (methodName == null) {
        url = url.addParameter(CLUSTER_STICKY_KEY, String.valueOf(check));
    } else {
        url = url.addParameter(methodName + "." + CLUSTER_STICKY_KEY, String.valueOf(check));
    }
    given(invoker1.invoke(invocation)).willReturn(result);
    given(invoker1.isAvailable()).willReturn(true);
    given(invoker1.getUrl()).willReturn(url.setPort(1));
    given(invoker1.getInterface()).willReturn(StickyTest.class);
<span class="hljs-deletion">-    given(invoker2.invoke(invocation)).willReturn(result);</span>
<span class="hljs-deletion">-    given(invoker2.isAvailable()).willReturn(true);</span>
<span class="hljs-deletion">-    given(invoker2.getUrl()).willReturn(url.setPort(2));</span>
<span class="hljs-deletion">-    given(invoker2.getInterface()).willReturn(StickyTest.class);</span>
<span class="hljs-addition">+    invoker2 = createMockInvoker(url.setPort(2), result, invocation);</span>
    invocation.setMethodName(methodName);
    int count = 0;
    for (int i = 0; i &lt; runs; i++) {
        Assertions.assertNull(clusterinvoker.invoke(invocation));
        if (invoker1 == clusterinvoker.getSelectedInvoker()) {
            count++;
        }
    }
    return count;
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    given(dic.getUrl()).willReturn(url);

    given(dic.getConsumerUrl()).willReturn(url);

    given(dic.list(invocation)).willReturn(invokers);

    given(dic.getInterface()).willReturn(StickyTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invokers.add(invoker1);

    invokers.add(invoker2);

    clusterinvoker = <span class="hljs-keyword">new</span> StickyClusterInvoker&lt;StickyTest&gt;(dic);

}
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">testSticky</span><span class="hljs-params">(String methodName, <span class="hljs-keyword">boolean</span> check)</span> </span>{

    <span class="hljs-keyword">if</span> (methodName == <span class="hljs-keyword">null</span>) {

        url = url.addParameter(CLUSTER_STICKY_KEY, String.valueOf(check));

    } <span class="hljs-keyword">else</span> {

        url = url.addParameter(methodName + <span class="hljs-string">"."</span> + CLUSTER_STICKY_KEY, String.valueOf(check));

    }

    given(invoker1.invoke(invocation)).willReturn(result);

    given(invoker1.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker1.getUrl()).willReturn(url.setPort(<span class="hljs-number">1</span>));

    given(invoker1.getInterface()).willReturn(StickyTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(invoker2.invoke(invocation)).willReturn(result);

    given(invoker2.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);

    given(invoker2.getUrl()).willReturn(url.setPort(<span class="hljs-number">2</span>));

    given(invoker2.getInterface()).willReturn(StickyTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation.setMethodName(methodName);

    <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; runs; i++) {

        Assertions.assertNull(clusterinvoker.invoke(invocation));

        <span class="hljs-keyword">if</span> (invoker1 == clusterinvoker.getSelectedInvoker()) {

            count++;

        }

    }

    <span class="hljs-keyword">return</span> count;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;StickyTest&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url, Result result, RpcInvocation invocation)</span> </span>{
    Invoker&lt;StickyTest&gt; invoker = mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getInterface()).willReturn(StickyTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(invoker.getUrl()).willReturn(url);
    given(invoker.invoke(invocation)).willReturn(result);
    given(invoker.isAvailable()).willReturn(<span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci63">Mock Clone Instance #dubbo_MCI_63</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>javax.sql.DataSource</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DataSource <span class="hljs-title">createMockDataSource</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException </span>{
    DataSource dataSource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(dataSource.getConnection()).willReturn(connection);
    <span class="hljs-keyword">return</span> dataSource;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest631">Test Case ID #dubbo_Test_63_1</h4>
<h4 id="test-case-name-testwithdatasourcehasnextresultfile-cjavaprojectsapachedubbodubbo-configdubbo-config-springsrctestjavaorgapachedubboconfigspringstatusdatasourcestatuscheckertestjava">Test Case Name: <code>testWithDatasourceHasNextResult</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-config\dubbo-config-spring\src\test\java\org\apache\dubbo\config\spring\status\DataSourceStatusCheckerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-datasource">Mock Object Variable Name: <code>dataSource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     Map&lt;String, DataSource&gt; map = new HashMap&lt;String, DataSource&gt;();
<span class="hljs-deletion">-    DataSource dataSource = mock(DataSource.class);</span>
     Connection connection = mock(Connection.class, Answers.RETURNS_DEEP_STUBS);
<span class="hljs-deletion">-    given(dataSource.getConnection()).willReturn(connection);</span>
<span class="hljs-addition">+    DataSource dataSource = createMockDataSource(connection);</span>
     given(connection.getMetaData().getTypeInfo().next()).willReturn(true);
     map.put("mockDatabase", dataSource);
     given(applicationContext.getBeansOfType(eq(DataSource.class), anyBoolean(), anyBoolean())).willReturn(map);
     Status status = dataSourceStatusChecker.check();
     assertThat(status.getLevel(), is(Status.Level.OK));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testWithDatasourceHasNextResult</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException </span>{

    Map&lt;String, DataSource&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;String, DataSource&gt;();

    DataSource dataSource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Answers</span>.<span class="hljs-title">RETURNS_DEEP_STUBS</span>)</span>;

    given(dataSource.getConnection()).willReturn(connection);

    given(connection.getMetaData().getTypeInfo().next()).willReturn(<span class="hljs-keyword">true</span>);

    map.put(<span class="hljs-string">"mockDatabase"</span>, dataSource);

    given(applicationContext.getBeansOfType(eq(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyBoolean</span>(), <span class="hljs-title">anyBoolean</span>())).<span class="hljs-title">willReturn</span>(<span class="hljs-title">map</span>)</span>;

    Status status = dataSourceStatusChecker.check();

    assertThat(status.getLevel(), is(Status.Level.OK));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DataSource <span class="hljs-title">createMockDataSource</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException </span>{
    DataSource dataSource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(dataSource.getConnection()).willReturn(connection);
    <span class="hljs-keyword">return</span> dataSource;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest632">Test Case ID #dubbo_Test_63_2</h4>
<h4 id="test-case-name-testwithdatasourcenothasnextresultfile-cjavaprojectsapachedubbodubbo-configdubbo-config-springsrctestjavaorgapachedubboconfigspringstatusdatasourcestatuscheckertestjava">Test Case Name: <code>testWithDatasourceNotHasNextResult</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-config\dubbo-config-spring\src\test\java\org\apache\dubbo\config\spring\status\DataSourceStatusCheckerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-datasource">Mock Object Variable Name: <code>dataSource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 void testWithDatasourceNotHasNextResult() throws SQLException {
     Map&lt;String, DataSource&gt; map = new HashMap&lt;String, DataSource&gt;();
<span class="hljs-deletion">-    DataSource dataSource = mock(DataSource.class);</span>
     Connection connection = mock(Connection.class, Answers.RETURNS_DEEP_STUBS);
<span class="hljs-deletion">-    given(dataSource.getConnection()).willReturn(connection);</span>
<span class="hljs-addition">+    DataSource dataSource = createMockDataSource(connection);</span>
     given(connection.getMetaData().getTypeInfo().next()).willReturn(false);
     map.put("mockDatabase", dataSource);
     given(applicationContext.getBeansOfType(eq(DataSource.class), anyBoolean(), anyBoolean())).willReturn(map);
     Status status = dataSourceStatusChecker.check();
     assertThat(status.getLevel(), is(Status.Level.ERROR));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testWithDatasourceNotHasNextResult</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException </span>{

    Map&lt;String, DataSource&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;String, DataSource&gt;();

    DataSource dataSource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Connection connection = mock(Connection<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Answers</span>.<span class="hljs-title">RETURNS_DEEP_STUBS</span>)</span>;

    given(dataSource.getConnection()).willReturn(connection);

    given(connection.getMetaData().getTypeInfo().next()).willReturn(<span class="hljs-keyword">false</span>);

    map.put(<span class="hljs-string">"mockDatabase"</span>, dataSource);

    given(applicationContext.getBeansOfType(eq(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyBoolean</span>(), <span class="hljs-title">anyBoolean</span>())).<span class="hljs-title">willReturn</span>(<span class="hljs-title">map</span>)</span>;

    Status status = dataSourceStatusChecker.check();

    assertThat(status.getLevel(), is(Status.Level.ERROR));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DataSource <span class="hljs-title">createMockDataSource</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException </span>{
    DataSource dataSource = mock(DataSource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(dataSource.getConnection()).willReturn(connection);
    <span class="hljs-keyword">return</span> dataSource;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci64">Mock Clone Instance #dubbo_MCI_64</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.registry.integration.DynamicDirectory</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DynamicDirectory <span class="hljs-title">createMockDynamicDirectory</span><span class="hljs-params">(List&lt;Invoker&lt;?&gt;&gt; invokers)</span> </span>{
    DynamicDirectory directory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(directory.getAllInvokers()).thenReturn((List&lt;Invoker&lt;?&gt;&gt;) invokers);
    <span class="hljs-keyword">return</span> directory;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest641">Test Case ID #dubbo_Test_64_1</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationinvokertestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-directory">Mock Object Variable Name: <code>directory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol.class);
    ClusterInvoker invoker = Mockito.mock(ClusterInvoker.class);
    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker.class);
<span class="hljs-deletion">-    DynamicDirectory directory = Mockito.mock(DynamicDirectory.class);</span>
<span class="hljs-addition">+    DynamicDirectory directory = createMockDynamicDirectory(invokers);</span>
    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory.class);
    Mockito.when(invoker.getDirectory()).thenReturn(directory);
    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);
    Mockito.when(invoker.isAvailable()).thenReturn(true);
    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(true);
    Mockito.when(invoker.hasProxyInvokers()).thenReturn(true);
    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(true);
    List&lt;Invoker&lt;?&gt;&gt; invokers = new LinkedList&lt;&gt;();
    invokers.add(Mockito.mock(Invoker.class));
    invokers.add(Mockito.mock(Invoker.class));
    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = new LinkedList&lt;&gt;();
    serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
    serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
<span class="hljs-deletion">-    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);</span>
    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"all"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker invoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory directory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(invoker.getDirectory()).thenReturn(directory);

    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);

    Mockito.when(invoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(invoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;Invoker&lt;?&gt;&gt; invokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);

    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);

    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);

    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceInterface()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getGroup()).thenReturn(<span class="hljs-string">"Group"</span>);

    Mockito.when(consumerURL.getVersion()).thenReturn(<span class="hljs-string">"0.0.0"</span>);

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Group/Test:0.0.0"</span>);

    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn(<span class="hljs-string">"Test:0.0.0"</span>);

    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());

    Mockito.when(invoker.getUrl()).thenReturn(consumerURL);

    Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);

    MigrationInvoker&lt;?&gt; migrationInvoker = <span class="hljs-keyword">new</span> MigrationInvoker&lt;&gt;(registryProtocol, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">null</span>, <span class="hljs-title">consumerURL</span>)</span>;

    MigrationRule migrationRule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">3</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">4</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">5</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">3</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">4</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">5</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">6</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">6</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">7</span>)).invoke(<span class="hljs-keyword">null</span>);

    Assertions.assertNull(migrationInvoker.getInvoker());

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">7</span>)).invoke(<span class="hljs-keyword">null</span>);

    Assertions.assertNull(migrationInvoker.getServiceDiscoveryInvoker());

    ArgumentCaptor&lt;InvokersChangedListener&gt; argument = ArgumentCaptor.forClass(InvokersChangedListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(serviceDiscoveryDirectory, Mockito.atLeastOnce()).setInvokersChangedListener(argument.capture());

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">27</span>)).invoke(<span class="hljs-keyword">null</span>);

    serviceDiscoveryInvokers.remove(<span class="hljs-number">1</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">false</span>);

    argument.getAllValues().get(argument.getAllValues().size() - <span class="hljs-number">1</span>).onChange();

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">27</span>)).invoke(<span class="hljs-keyword">null</span>);

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    argument.getAllValues().get(argument.getAllValues().size() - <span class="hljs-number">1</span>).onChange();

    Mockito.when(migrationRule.getProportion(Mockito.any())).thenReturn(<span class="hljs-number">50</span>);

    migrationInvoker.setMigrationRule(migrationRule);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(serviceDiscoveryInvoker, Mockito.atMost(<span class="hljs-number">1026</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.atLeast(<span class="hljs-number">28</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getDelay(Mockito.any())).thenReturn(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">long</span> currentTimeMillis = System.currentTimeMillis();

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    Assertions.assertTrue(System.currentTimeMillis() - currentTimeMillis &gt;= <span class="hljs-number">2000</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DynamicDirectory <span class="hljs-title">createMockDynamicDirectory</span><span class="hljs-params">(List&lt;Invoker&lt;?&gt;&gt; invokers)</span> </span>{
    DynamicDirectory directory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(directory.getAllInvokers()).thenReturn((List&lt;Invoker&lt;?&gt;&gt;) invokers);
    <span class="hljs-keyword">return</span> directory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest642">Test Case ID #dubbo_Test_64_2</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationinvokertestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-servicediscoverydirectory">Mock Object Variable Name: <code>serviceDiscoveryDirectory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    DynamicDirectory directory = Mockito.mock(DynamicDirectory.class);
<span class="hljs-deletion">-    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory.class);</span>
     Mockito.when(invoker.getDirectory()).thenReturn(directory);
     Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);
     Mockito.when(invoker.isAvailable()).thenReturn(true);
     Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(true);
     Mockito.when(invoker.hasProxyInvokers()).thenReturn(true);
     Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(true);
     List&lt;Invoker&lt;?&gt;&gt; invokers = new LinkedList&lt;&gt;();
     invokers.add(Mockito.mock(Invoker.class));
     invokers.add(Mockito.mock(Invoker.class));
     List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = new LinkedList&lt;&gt;();
     serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
     serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
     Mockito.when(directory.getAllInvokers()).thenReturn(invokers);
<span class="hljs-deletion">-    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);</span>
<span class="hljs-addition">+    DynamicDirectory serviceDiscoveryDirectory = createMockDynamicDirectory(serviceDiscoveryInvokers);</span>
     Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);
     Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);
     URL consumerURL = Mockito.mock(URL.class);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"all"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker invoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory directory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(invoker.getDirectory()).thenReturn(directory);

    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);

    Mockito.when(invoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(invoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;Invoker&lt;?&gt;&gt; invokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);

    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);

    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);

    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceInterface()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getGroup()).thenReturn(<span class="hljs-string">"Group"</span>);

    Mockito.when(consumerURL.getVersion()).thenReturn(<span class="hljs-string">"0.0.0"</span>);

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Group/Test:0.0.0"</span>);

    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn(<span class="hljs-string">"Test:0.0.0"</span>);

    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());

    Mockito.when(invoker.getUrl()).thenReturn(consumerURL);

    Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);

    MigrationInvoker&lt;?&gt; migrationInvoker = <span class="hljs-keyword">new</span> MigrationInvoker&lt;&gt;(registryProtocol, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">null</span>, <span class="hljs-title">consumerURL</span>)</span>;

    MigrationRule migrationRule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">3</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">4</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">5</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">3</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">4</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">5</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">2.0f</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">6</span>)).invoke(<span class="hljs-keyword">null</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">6</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">7</span>)).invoke(<span class="hljs-keyword">null</span>);

    Assertions.assertNull(migrationInvoker.getInvoker());

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToForceInterfaceInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_INTERFACE);

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.FORCE_APPLICATION);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">7</span>)).invoke(<span class="hljs-keyword">null</span>);

    Assertions.assertNull(migrationInvoker.getServiceDiscoveryInvoker());

    ArgumentCaptor&lt;InvokersChangedListener&gt; argument = ArgumentCaptor.forClass(InvokersChangedListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(serviceDiscoveryDirectory, Mockito.atLeastOnce()).setInvokersChangedListener(argument.capture());

    Mockito.when(migrationRule.getThreshold(Mockito.any())).thenReturn(<span class="hljs-number">1.0f</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">27</span>)).invoke(<span class="hljs-keyword">null</span>);

    serviceDiscoveryInvokers.remove(<span class="hljs-number">1</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">false</span>);

    argument.getAllValues().get(argument.getAllValues().size() - <span class="hljs-number">1</span>).onChange();

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">27</span>)).invoke(<span class="hljs-keyword">null</span>);

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    argument.getAllValues().get(argument.getAllValues().size() - <span class="hljs-number">1</span>).onChange();

    Mockito.when(migrationRule.getProportion(Mockito.any())).thenReturn(<span class="hljs-number">50</span>);

    migrationInvoker.setMigrationRule(migrationRule);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {

        migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    }

    Mockito.verify(serviceDiscoveryInvoker, Mockito.atMost(<span class="hljs-number">1026</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.atLeast(<span class="hljs-number">28</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(migrationRule.getDelay(Mockito.any())).thenReturn(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">long</span> currentTimeMillis = System.currentTimeMillis();

    migrationInvoker.migrateToForceApplicationInvoker(migrationRule);

    Assertions.assertTrue(System.currentTimeMillis() - currentTimeMillis &gt;= <span class="hljs-number">2000</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DynamicDirectory <span class="hljs-title">createMockDynamicDirectory</span><span class="hljs-params">(List&lt;Invoker&lt;?&gt;&gt; invokers)</span> </span>{
    DynamicDirectory directory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(directory.getAllInvokers()).thenReturn((List&lt;Invoker&lt;?&gt;&gt;) invokers);
    <span class="hljs-keyword">return</span> directory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest643">Test Case ID #dubbo_Test_64_3</h4>
<h4 id="test-case-name-testdecidefile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationinvokertestjava">Test Case Name: <code>testDecide</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-directory">Mock Object Variable Name: <code>directory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ClusterInvoker invoker = Mockito.mock(ClusterInvoker.class);
    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker.class);
<span class="hljs-deletion">-    DynamicDirectory directory = Mockito.mock(DynamicDirectory.class);</span>
    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory.class);
    Mockito.when(invoker.getDirectory()).thenReturn(directory);
    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);
    Mockito.when(invoker.isAvailable()).thenReturn(true);
    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(true);
    Mockito.when(invoker.hasProxyInvokers()).thenReturn(true);
    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(true);
    List&lt;Invoker&lt;?&gt;&gt; invokers = new LinkedList&lt;&gt;();
    invokers.add(Mockito.mock(Invoker.class));
    invokers.add(Mockito.mock(Invoker.class));
    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = new LinkedList&lt;&gt;();
    serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
    serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
<span class="hljs-addition">+    DynamicDirectory directory = createMockDynamicDirectory(invokers);</span>
    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);
<span class="hljs-deletion">-    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);</span>
    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);
    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"all"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testDecide</span><span class="hljs-params">()</span> </span>{

    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker invoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory directory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(invoker.getDirectory()).thenReturn(directory);

    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);

    Mockito.when(invoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(invoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;Invoker&lt;?&gt;&gt; invokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);

    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);

    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);

    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceInterface()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getGroup()).thenReturn(<span class="hljs-string">"Group"</span>);

    Mockito.when(consumerURL.getVersion()).thenReturn(<span class="hljs-string">"0.0.0"</span>);

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Group/Test:0.0.0"</span>);

    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn(<span class="hljs-string">"Test:0.0.0"</span>);

    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());

    Mockito.when(invoker.getUrl()).thenReturn(consumerURL);

    Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);

    MigrationInvoker&lt;?&gt; migrationInvoker = <span class="hljs-keyword">new</span> MigrationInvoker&lt;&gt;(registryProtocol, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">null</span>, <span class="hljs-title">consumerURL</span>)</span>;

    MigrationRule migrationRule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DynamicDirectory <span class="hljs-title">createMockDynamicDirectory</span><span class="hljs-params">(List&lt;Invoker&lt;?&gt;&gt; invokers)</span> </span>{
    DynamicDirectory directory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(directory.getAllInvokers()).thenReturn((List&lt;Invoker&lt;?&gt;&gt;) invokers);
    <span class="hljs-keyword">return</span> directory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest644">Test Case ID #dubbo_Test_64_4</h4>
<h4 id="test-case-name-testdecidefile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationinvokertestjava">Test Case Name: <code>testDecide</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-servicediscoverydirectory">Mock Object Variable Name: <code>serviceDiscoveryDirectory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    DynamicDirectory directory = Mockito.mock(DynamicDirectory.class);
<span class="hljs-deletion">-    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory.class);</span>
     Mockito.when(invoker.getDirectory()).thenReturn(directory);
     Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);
     Mockito.when(invoker.isAvailable()).thenReturn(true);
     Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(true);
     Mockito.when(invoker.hasProxyInvokers()).thenReturn(true);
     Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(true);
     List&lt;Invoker&lt;?&gt;&gt; invokers = new LinkedList&lt;&gt;();
     invokers.add(Mockito.mock(Invoker.class));
     invokers.add(Mockito.mock(Invoker.class));
     List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = new LinkedList&lt;&gt;();
     serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
     serviceDiscoveryInvokers.add(Mockito.mock(Invoker.class));
     Mockito.when(directory.getAllInvokers()).thenReturn(invokers);
<span class="hljs-deletion">-    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);</span>
<span class="hljs-addition">+    DynamicDirectory serviceDiscoveryDirectory = createMockDynamicDirectory(serviceDiscoveryInvokers);</span>
     Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);
     Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);
     URL consumerURL = Mockito.mock(URL.class);
     Mockito.when(consumerURL.getServiceInterface()).thenReturn("Test");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"all"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testDecide</span><span class="hljs-params">()</span> </span>{

    RegistryProtocol registryProtocol = Mockito.mock(RegistryProtocol<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker invoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker serviceDiscoveryInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory directory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DynamicDirectory serviceDiscoveryDirectory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(invoker.getDirectory()).thenReturn(directory);

    Mockito.when(serviceDiscoveryInvoker.getDirectory()).thenReturn(serviceDiscoveryDirectory);

    Mockito.when(invoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(invoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(serviceDiscoveryInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;Invoker&lt;?&gt;&gt; invokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    invokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    List&lt;Invoker&lt;?&gt;&gt; serviceDiscoveryInvokers = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    serviceDiscoveryInvokers.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(directory.getAllInvokers()).thenReturn(invokers);

    Mockito.when(serviceDiscoveryDirectory.getAllInvokers()).thenReturn(serviceDiscoveryInvokers);

    Mockito.when(registryProtocol.getInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(invoker);

    Mockito.when(registryProtocol.getServiceDiscoveryInvoker(Mockito.any(), Mockito.any(), Mockito.any(), Mockito.any())).thenReturn(serviceDiscoveryInvoker);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceInterface()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getGroup()).thenReturn(<span class="hljs-string">"Group"</span>);

    Mockito.when(consumerURL.getVersion()).thenReturn(<span class="hljs-string">"0.0.0"</span>);

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Group/Test:0.0.0"</span>);

    Mockito.when(consumerURL.getDisplayServiceKey()).thenReturn(<span class="hljs-string">"Test:0.0.0"</span>);

    Mockito.when(consumerURL.getOrDefaultApplicationModel()).thenReturn(ApplicationModel.defaultModel());

    Mockito.when(invoker.getUrl()).thenReturn(consumerURL);

    Mockito.when(serviceDiscoveryInvoker.getUrl()).thenReturn(consumerURL);

    MigrationInvoker&lt;?&gt; migrationInvoker = <span class="hljs-keyword">new</span> MigrationInvoker&lt;&gt;(registryProtocol, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">null</span>, <span class="hljs-title">consumerURL</span>)</span>;

    MigrationRule migrationRule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(migrationRule.getForce(Mockito.any())).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.migrateToApplicationFirstInvoker(migrationRule);

    migrationInvoker.setMigrationStep(MigrationStep.APPLICATION_FIRST);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">false</span>);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(invoker, Mockito.times(<span class="hljs-number">1</span>)).invoke(<span class="hljs-keyword">null</span>);

    Mockito.when(serviceDiscoveryInvoker.isAvailable()).thenReturn(<span class="hljs-keyword">true</span>);

    migrationInvoker.invoke(<span class="hljs-keyword">null</span>);

    Mockito.verify(serviceDiscoveryInvoker, Mockito.times(<span class="hljs-number">2</span>)).invoke(<span class="hljs-keyword">null</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DynamicDirectory <span class="hljs-title">createMockDynamicDirectory</span><span class="hljs-params">(List&lt;Invoker&lt;?&gt;&gt; invokers)</span> </span>{
    DynamicDirectory directory = Mockito.mock(DynamicDirectory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(directory.getAllInvokers()).thenReturn((List&lt;Invoker&lt;?&gt;&gt;) invokers);
    <span class="hljs-keyword">return</span> directory;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci65">Mock Clone Instance #dubbo_MCI_65</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.qos.api.CommandContext</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockCommandContext</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CommandContext <span class="hljs-title">createMockCommandContext</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isHttpReturn)</span> </span>{
        CommandContext commandContext = Mockito.mock(CommandContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        Mockito.when(commandContext.isHttp()).thenReturn(isHttpReturn);
        <span class="hljs-keyword">return</span> commandContext;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest651">Test Case ID #dubbo_Test_65_1</h4>
<h4 id="test-case-name-testnotifyfile-cjavaprojectsapachedubbodubbo-plugindubbo-qossrctestjavaorgapachedubboqoscommandimplserializecheckstatustestjava">Test Case Name: <code>testNotify</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-qos\src\test\java\org\apache\dubbo\qos\command\impl\SerializeCheckStatusTest.java</code>)</h4>
<h4 id="mock-object-variable-name-commandcontext1">Mock Object Variable Name: <code>commandContext1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SerializeCheckStatus serializeCheckStatus = new SerializeCheckStatus(frameworkModel);
<span class="hljs-deletion">-    CommandContext commandContext1 = Mockito.mock(CommandContext.class);</span>
<span class="hljs-deletion">-    Mockito.when(commandContext1.isHttp()).thenReturn(false);</span>
<span class="hljs-addition">+    CommandContext commandContext1 = MockCommandContext.createMockCommandContext(false);</span>
    CommandContext commandContext2 = Mockito.mock(CommandContext.class);
    Mockito.when(commandContext2.isHttp()).thenReturn(true);
    Assertions.assertFalse(serializeCheckStatus.execute(commandContext1, null).contains("Test1234"));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testNotify</span><span class="hljs-params">()</span> </span>{

    FrameworkModel frameworkModel = <span class="hljs-keyword">new</span> FrameworkModel();

    SerializeSecurityManager ssm = frameworkModel.getBeanFactory().getBean(SerializeSecurityManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SerializeCheckStatus serializeCheckStatus = <span class="hljs-keyword">new</span> SerializeCheckStatus(frameworkModel);

    CommandContext commandContext1 = Mockito.mock(CommandContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(commandContext1.isHttp()).thenReturn(<span class="hljs-keyword">false</span>);

    CommandContext commandContext2 = Mockito.mock(CommandContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(commandContext2.isHttp()).thenReturn(<span class="hljs-keyword">true</span>);

    Assertions.assertFalse(serializeCheckStatus.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test1234"</span>));

    Assertions.assertFalse(serializeCheckStatus.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test1234"</span>));

    ssm.addToAllowed(<span class="hljs-string">"Test1234"</span>);

    Assertions.assertTrue(serializeCheckStatus.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test1234"</span>));

    Assertions.assertTrue(serializeCheckStatus.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test1234"</span>));

    Assertions.assertFalse(serializeCheckStatus.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test4321"</span>));

    Assertions.assertFalse(serializeCheckStatus.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test4321"</span>));

    ssm.addToDisAllowed(<span class="hljs-string">"Test4321"</span>);

    Assertions.assertTrue(serializeCheckStatus.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test4321"</span>));

    Assertions.assertTrue(serializeCheckStatus.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test4321"</span>));

    Assertions.assertFalse(serializeCheckStatus.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"CheckSerializable: false"</span>));

    Assertions.assertFalse(serializeCheckStatus.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"\"checkSerializable\":false"</span>));

    ssm.setCheckSerializable(<span class="hljs-keyword">false</span>);

    Assertions.assertTrue(serializeCheckStatus.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"CheckSerializable: false"</span>));

    Assertions.assertTrue(serializeCheckStatus.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"\"checkSerializable\":false"</span>));

    Assertions.assertFalse(serializeCheckStatus.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"CheckStatus: DISABLE"</span>));

    Assertions.assertFalse(serializeCheckStatus.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"\"checkStatus\":\"DISABLE\""</span>));

    ssm.setCheckStatus(org.apache.dubbo.common.utils.SerializeCheckStatus.DISABLE);

    Assertions.assertTrue(serializeCheckStatus.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"CheckStatus: DISABLE"</span>));

    Assertions.assertTrue(serializeCheckStatus.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"\"checkStatus\":\"DISABLE\""</span>));

    frameworkModel.destroy();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockCommandContext</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CommandContext <span class="hljs-title">createMockCommandContext</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isHttpReturn)</span> </span>{
        CommandContext commandContext = Mockito.mock(CommandContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        Mockito.when(commandContext.isHttp()).thenReturn(isHttpReturn);
        <span class="hljs-keyword">return</span> commandContext;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest652">Test Case ID #dubbo_Test_65_2</h4>
<h4 id="test-case-name-testnotifyfile-cjavaprojectsapachedubbodubbo-plugindubbo-qossrctestjavaorgapachedubboqoscommandimplserializecheckstatustestjava">Test Case Name: <code>testNotify</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-qos\src\test\java\org\apache\dubbo\qos\command\impl\SerializeCheckStatusTest.java</code>)</h4>
<h4 id="mock-object-variable-name-commandcontext2">Mock Object Variable Name: <code>commandContext2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    CommandContext commandContext1 = Mockito.mock(CommandContext.class);
    Mockito.when(commandContext1.isHttp()).thenReturn(false);
<span class="hljs-deletion">-    CommandContext commandContext2 = Mockito.mock(CommandContext.class);</span>
<span class="hljs-deletion">-    Mockito.when(commandContext2.isHttp()).thenReturn(true);</span>
<span class="hljs-addition">+    CommandContext commandContext2 = MockCommandContext.createMockCommandContext(true);</span>
    Assertions.assertFalse(serializeCheckStatus.execute(commandContext1, null).contains("Test1234"));
    Assertions.assertFalse(serializeCheckStatus.execute(commandContext2, null).contains("Test1234"));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testNotify</span><span class="hljs-params">()</span> </span>{

    FrameworkModel frameworkModel = <span class="hljs-keyword">new</span> FrameworkModel();

    SerializeSecurityManager ssm = frameworkModel.getBeanFactory().getBean(SerializeSecurityManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SerializeCheckStatus serializeCheckStatus = <span class="hljs-keyword">new</span> SerializeCheckStatus(frameworkModel);

    CommandContext commandContext1 = Mockito.mock(CommandContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(commandContext1.isHttp()).thenReturn(<span class="hljs-keyword">false</span>);

    CommandContext commandContext2 = Mockito.mock(CommandContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(commandContext2.isHttp()).thenReturn(<span class="hljs-keyword">true</span>);

    Assertions.assertFalse(serializeCheckStatus.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test1234"</span>));

    Assertions.assertFalse(serializeCheckStatus.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test1234"</span>));

    ssm.addToAllowed(<span class="hljs-string">"Test1234"</span>);

    Assertions.assertTrue(serializeCheckStatus.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test1234"</span>));

    Assertions.assertTrue(serializeCheckStatus.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test1234"</span>));

    Assertions.assertFalse(serializeCheckStatus.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test4321"</span>));

    Assertions.assertFalse(serializeCheckStatus.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test4321"</span>));

    ssm.addToDisAllowed(<span class="hljs-string">"Test4321"</span>);

    Assertions.assertTrue(serializeCheckStatus.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test4321"</span>));

    Assertions.assertTrue(serializeCheckStatus.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test4321"</span>));

    Assertions.assertFalse(serializeCheckStatus.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"CheckSerializable: false"</span>));

    Assertions.assertFalse(serializeCheckStatus.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"\"checkSerializable\":false"</span>));

    ssm.setCheckSerializable(<span class="hljs-keyword">false</span>);

    Assertions.assertTrue(serializeCheckStatus.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"CheckSerializable: false"</span>));

    Assertions.assertTrue(serializeCheckStatus.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"\"checkSerializable\":false"</span>));

    Assertions.assertFalse(serializeCheckStatus.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"CheckStatus: DISABLE"</span>));

    Assertions.assertFalse(serializeCheckStatus.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"\"checkStatus\":\"DISABLE\""</span>));

    ssm.setCheckStatus(org.apache.dubbo.common.utils.SerializeCheckStatus.DISABLE);

    Assertions.assertTrue(serializeCheckStatus.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"CheckStatus: DISABLE"</span>));

    Assertions.assertTrue(serializeCheckStatus.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"\"checkStatus\":\"DISABLE\""</span>));

    frameworkModel.destroy();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockCommandContext</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CommandContext <span class="hljs-title">createMockCommandContext</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isHttpReturn)</span> </span>{
        CommandContext commandContext = Mockito.mock(CommandContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        Mockito.when(commandContext.isHttp()).thenReturn(isHttpReturn);
        <span class="hljs-keyword">return</span> commandContext;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest653">Test Case ID #dubbo_Test_65_3</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-plugindubbo-qossrctestjavaorgapachedubboqoscommandimplserializewarnedclassestestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-qos\src\test\java\org\apache\dubbo\qos\command\impl\SerializeWarnedClassesTest.java</code>)</h4>
<h4 id="mock-object-variable-name-commandcontext1">Mock Object Variable Name: <code>commandContext1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    SerializeWarnedClasses serializeWarnedClasses = new SerializeWarnedClasses(frameworkModel);
<span class="hljs-deletion">-    CommandContext commandContext1 = Mockito.mock(CommandContext.class);</span>
<span class="hljs-deletion">-    Mockito.when(commandContext1.isHttp()).thenReturn(false);</span>
<span class="hljs-addition">+    CommandContext commandContext1 = MockCommandContext.createMockCommandContext(false);</span>
    CommandContext commandContext2 = Mockito.mock(CommandContext.class);
    Mockito.when(commandContext2.isHttp()).thenReturn(true);
    Assertions.assertFalse(serializeWarnedClasses.execute(commandContext1, null).contains("Test1234"));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    FrameworkModel frameworkModel = <span class="hljs-keyword">new</span> FrameworkModel();

    SerializeSecurityManager ssm = frameworkModel.getBeanFactory().getBean(SerializeSecurityManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SerializeWarnedClasses serializeWarnedClasses = <span class="hljs-keyword">new</span> SerializeWarnedClasses(frameworkModel);

    CommandContext commandContext1 = Mockito.mock(CommandContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(commandContext1.isHttp()).thenReturn(<span class="hljs-keyword">false</span>);

    CommandContext commandContext2 = Mockito.mock(CommandContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(commandContext2.isHttp()).thenReturn(<span class="hljs-keyword">true</span>);

    Assertions.assertFalse(serializeWarnedClasses.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test1234"</span>));

    Assertions.assertFalse(serializeWarnedClasses.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test1234"</span>));

    ssm.getWarnedClasses().add(<span class="hljs-string">"Test1234"</span>);

    Assertions.assertTrue(serializeWarnedClasses.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test1234"</span>));

    Assertions.assertTrue(serializeWarnedClasses.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test1234"</span>));

    Assertions.assertFalse(serializeWarnedClasses.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test4321"</span>));

    Assertions.assertFalse(serializeWarnedClasses.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test4321"</span>));

    ssm.getWarnedClasses().add(<span class="hljs-string">"Test4321"</span>);

    Assertions.assertTrue(serializeWarnedClasses.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test4321"</span>));

    Assertions.assertTrue(serializeWarnedClasses.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test4321"</span>));

    frameworkModel.destroy();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockCommandContext</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CommandContext <span class="hljs-title">createMockCommandContext</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isHttpReturn)</span> </span>{
        CommandContext commandContext = Mockito.mock(CommandContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        Mockito.when(commandContext.isHttp()).thenReturn(isHttpReturn);
        <span class="hljs-keyword">return</span> commandContext;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest654">Test Case ID #dubbo_Test_65_4</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-plugindubbo-qossrctestjavaorgapachedubboqoscommandimplserializewarnedclassestestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-plugin\dubbo-qos\src\test\java\org\apache\dubbo\qos\command\impl\SerializeWarnedClassesTest.java</code>)</h4>
<h4 id="mock-object-variable-name-commandcontext2">Mock Object Variable Name: <code>commandContext2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     CommandContext commandContext1 = Mockito.mock(CommandContext.class);
     Mockito.when(commandContext1.isHttp()).thenReturn(false);
<span class="hljs-deletion">-    CommandContext commandContext2 = Mockito.mock(CommandContext.class);</span>
<span class="hljs-deletion">-    Mockito.when(commandContext2.isHttp()).thenReturn(true);</span>
<span class="hljs-addition">+    CommandContext commandContext2 = MockCommandContext.createMockCommandContext(true);</span>
     Assertions.assertFalse(serializeWarnedClasses.execute(commandContext1, null).contains("Test1234"));
     Assertions.assertFalse(serializeWarnedClasses.execute(commandContext2, null).contains("Test1234"));
     ssm.getWarnedClasses().add("Test1234");
     Assertions.assertTrue(serializeWarnedClasses.execute(commandContext1, null).contains("Test1234"));
     Assertions.assertTrue(serializeWarnedClasses.execute(commandContext2, null).contains("Test1234"));
     Assertions.assertFalse(serializeWarnedClasses.execute(commandContext1, null).contains("Test4321"));
     Assertions.assertFalse(serializeWarnedClasses.execute(commandContext2, null).contains("Test4321"));
     ssm.getWarnedClasses().add("Test4321");
     Assertions.assertTrue(serializeWarnedClasses.execute(commandContext1, null).contains("Test4321"));
     Assertions.assertTrue(serializeWarnedClasses.execute(commandContext2, null).contains("Test4321"));
     frameworkModel.destroy();
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    FrameworkModel frameworkModel = <span class="hljs-keyword">new</span> FrameworkModel();

    SerializeSecurityManager ssm = frameworkModel.getBeanFactory().getBean(SerializeSecurityManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SerializeWarnedClasses serializeWarnedClasses = <span class="hljs-keyword">new</span> SerializeWarnedClasses(frameworkModel);

    CommandContext commandContext1 = Mockito.mock(CommandContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(commandContext1.isHttp()).thenReturn(<span class="hljs-keyword">false</span>);

    CommandContext commandContext2 = Mockito.mock(CommandContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(commandContext2.isHttp()).thenReturn(<span class="hljs-keyword">true</span>);

    Assertions.assertFalse(serializeWarnedClasses.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test1234"</span>));

    Assertions.assertFalse(serializeWarnedClasses.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test1234"</span>));

    ssm.getWarnedClasses().add(<span class="hljs-string">"Test1234"</span>);

    Assertions.assertTrue(serializeWarnedClasses.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test1234"</span>));

    Assertions.assertTrue(serializeWarnedClasses.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test1234"</span>));

    Assertions.assertFalse(serializeWarnedClasses.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test4321"</span>));

    Assertions.assertFalse(serializeWarnedClasses.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test4321"</span>));

    ssm.getWarnedClasses().add(<span class="hljs-string">"Test4321"</span>);

    Assertions.assertTrue(serializeWarnedClasses.execute(commandContext1, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test4321"</span>));

    Assertions.assertTrue(serializeWarnedClasses.execute(commandContext2, <span class="hljs-keyword">null</span>).contains(<span class="hljs-string">"Test4321"</span>));

    frameworkModel.destroy();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockCommandContext</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CommandContext <span class="hljs-title">createMockCommandContext</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isHttpReturn)</span> </span>{
        CommandContext commandContext = Mockito.mock(CommandContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        Mockito.when(commandContext.isHttp()).thenReturn(isHttpReturn);
        <span class="hljs-keyword">return</span> commandContext;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci66">Mock Clone Instance #dubbo_MCI_66</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>java.util.concurrent.ExecutorService</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title">createMockExecutorService</span><span class="hljs-params">()</span> </span>{
    ExecutorService executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(executor.isTerminated()).thenReturn(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> executor;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest661">Test Case ID #dubbo_Test_66_1</h4>
<h4 id="test-case-name-testgracefulshutdown1file-cjavaprojectsapachedubbodubbo-commonsrctestjavaorgapachedubbocommonutilsexecutorutiltestjava">Test Case Name: <code>testGracefulShutdown1</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-common\src\test\java\org\apache\dubbo\common\utils\ExecutorUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-executor">Mock Object Variable Name: <code>executor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 void testGracefulShutdown1() throws Exception {
<span class="hljs-deletion">-    ExecutorService executor = Mockito.mock(ExecutorService.class);</span>
<span class="hljs-deletion">-    when(executor.isTerminated()).thenReturn(false, true);</span>
<span class="hljs-addition">+    ExecutorService executor = createMockExecutorService();</span>
     when(executor.awaitTermination(20, TimeUnit.MILLISECONDS)).thenReturn(false);
     ExecutorUtil.gracefulShutdown(executor, 20);
     verify(executor).shutdown();
     verify(executor).shutdownNow();
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testGracefulShutdown1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    ExecutorService executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(executor.isTerminated()).thenReturn(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>);

    when(executor.awaitTermination(<span class="hljs-number">20</span>, TimeUnit.MILLISECONDS)).thenReturn(<span class="hljs-keyword">false</span>);

    ExecutorUtil.gracefulShutdown(executor, <span class="hljs-number">20</span>);

    verify(executor).shutdown();

    verify(executor).shutdownNow();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title">createMockExecutorService</span><span class="hljs-params">()</span> </span>{
    ExecutorService executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(executor.isTerminated()).thenReturn(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> executor;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest662">Test Case ID #dubbo_Test_66_2</h4>
<h4 id="test-case-name-testshutdownnowfile-cjavaprojectsapachedubbodubbo-commonsrctestjavaorgapachedubbocommonutilsexecutorutiltestjava">Test Case Name: <code>testShutdownNow</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-common\src\test\java\org\apache\dubbo\common\utils\ExecutorUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-executor">Mock Object Variable Name: <code>executor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 void testShutdownNow() throws Exception {
<span class="hljs-deletion">-    ExecutorService executor = Mockito.mock(ExecutorService.class);</span>
<span class="hljs-deletion">-    when(executor.isTerminated()).thenReturn(false, true);</span>
<span class="hljs-addition">+    ExecutorService executor = createMockExecutorService();</span>
     ExecutorUtil.shutdownNow(executor, 20);
     verify(executor).shutdownNow();
     verify(executor).awaitTermination(20, TimeUnit.MILLISECONDS);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testShutdownNow</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    ExecutorService executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(executor.isTerminated()).thenReturn(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>);

    ExecutorUtil.shutdownNow(executor, <span class="hljs-number">20</span>);

    verify(executor).shutdownNow();

    verify(executor).awaitTermination(<span class="hljs-number">20</span>, TimeUnit.MILLISECONDS);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title">createMockExecutorService</span><span class="hljs-params">()</span> </span>{
    ExecutorService executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(executor.isTerminated()).thenReturn(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>);
    <span class="hljs-keyword">return</span> executor;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci67">Mock Clone Instance #dubbo_MCI_67</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>Invoker&lt;IGreeter&gt;</code></li>
<li><strong>Test Case Count</strong>: 5</li>
<li><strong>MO Count</strong>: 5</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;IGreeter&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invoker.getUrl()).thenReturn(url);
    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest671">Test Case ID #dubbo_Test_67_1</h4>
<h4 id="test-case-name-unarycallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>unaryCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void unaryCall() throws Throwable {
<span class="hljs-deletion">-    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker.class);</span>
     URL url = Mockito.mock(URL.class);
     ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);
     ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
     when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
     when(url.getServiceModel()).thenReturn(consumerModel);
     when(url.getServiceInterface()).thenReturn(IGreeter.class.getName());
     when(url.getProtocolServiceKey()).thenReturn(IGreeter.class.getName());
<span class="hljs-addition">+    Invoker&lt;IGreeter&gt; invoker = createMockInvoker(url);</span>
     Result result = Mockito.mock(Result.class);
     when(invoker.invoke(any(Invocation.class))).thenReturn(result);
     String response = "response";
     when(result.recreate()).thenReturn(response);
     MethodDescriptor method = Mockito.mock(MethodDescriptor.class);
     when(method.getParameterClasses()).thenReturn(new Class[] { String.class });
     when(method.getMethodName()).thenReturn("sayHello");
     String request = "request";
     Object ret = StubInvocationUtil.unaryCall(invoker, method, request);
     Assertions.assertEquals(response, ret);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unaryCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">result</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(result.recreate()).thenReturn(response);

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    Object ret = StubInvocationUtil.unaryCall(invoker, method, request);

    Assertions.assertEquals(response, ret);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;IGreeter&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invoker.getUrl()).thenReturn(url);
    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest672">Test Case ID #dubbo_Test_67_2</h4>
<h4 id="test-case-name-unarycall2file-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>unaryCall2</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void unaryCall2() throws Throwable {
<span class="hljs-deletion">-    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker.class);</span>
     URL url = Mockito.mock(URL.class);
     ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);
     ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
     when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
     when(url.getServiceModel()).thenReturn(consumerModel);
     when(url.getServiceInterface()).thenReturn(IGreeter.class.getName());
     when(url.getProtocolServiceKey()).thenReturn(IGreeter.class.getName());
<span class="hljs-addition">+    Invoker&lt;IGreeter&gt; invoker = createMockInvoker(url);</span>
     Result result = Mockito.mock(Result.class);
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
<span class="hljs-deletion">-    when(invoker.getInterface()).thenReturn(IGreeter.class);</span>
     when(invoker.invoke(any(Invocation.class))).thenThrow(new RuntimeException("a")).thenThrow(new Error("b"));
     String response = "response";
     when(result.recreate()).thenReturn(response);
     MethodDescriptor method = Mockito.mock(MethodDescriptor.class);
     when(method.getParameterClasses()).thenReturn(new Class[] { String.class });
     when(method.getMethodName()).thenReturn("sayHello");
     String request = "request";
     try {
         StubInvocationUtil.unaryCall(invoker, method, request);
         fail();
     } catch (Throwable t) {
         // pass
     }
     try {
         StubInvocationUtil.unaryCall(invoker, method, request);
         fail();
     } catch (Throwable t) {
         // pass
     }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unaryCall2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenThrow</span>(<span class="hljs-title">new</span> <span class="hljs-title">RuntimeException</span>("<span class="hljs-title">a</span>")).<span class="hljs-title">thenThrow</span>(<span class="hljs-title">new</span> <span class="hljs-title">Error</span>("<span class="hljs-title">b</span>"))</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(result.recreate()).thenReturn(response);

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    <span class="hljs-keyword">try</span> {

        StubInvocationUtil.unaryCall(invoker, method, request);

        fail();

    } <span class="hljs-keyword">catch</span> (Throwable t) {

        <span class="hljs-comment">// pass</span>

    }

    <span class="hljs-keyword">try</span> {

        StubInvocationUtil.unaryCall(invoker, method, request);

        fail();

    } <span class="hljs-keyword">catch</span> (Throwable t) {

        <span class="hljs-comment">// pass</span>

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;IGreeter&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invoker.getUrl()).thenReturn(url);
    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest673">Test Case ID #dubbo_Test_67_3</h4>
<h4 id="test-case-name-testunarycallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>testUnaryCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 void testUnaryCall() throws Throwable {
<span class="hljs-deletion">-    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker.class);</span>
     URL url = Mockito.mock(URL.class);
     ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);
     ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
     when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
     when(url.getServiceModel()).thenReturn(consumerModel);
     when(url.getServiceInterface()).thenReturn(IGreeter.class.getName());
     when(url.getProtocolServiceKey()).thenReturn(IGreeter.class.getName());
<span class="hljs-addition">+    Invoker&lt;IGreeter&gt; invoker = createMockInvoker(url);</span>
     Result result = Mockito.mock(Result.class);
     String response = "response";
     when(invoker.invoke(any(Invocation.class))).then(invocationOnMock -&gt; result);
     when(result.recreate()).thenReturn(response);
     MethodDescriptor method = Mockito.mock(MethodDescriptor.class);
     when(method.getParameterClasses()).thenReturn(new Class[] { String.class });
     when(method.getMethodName()).thenReturn("sayHello");
     String request = "request";
     CountDownLatch latch = new CountDownLatch(1);
     AtomicReference&lt;Object&gt; atomicReference = new AtomicReference&lt;&gt;();
     StreamObserver&lt;Object&gt; responseObserver = new StreamObserver&lt;Object&gt;() {

         @Override
         public void onNext(Object data) {
             atomicReference.set(data);
         }

         @Override
         public void onError(Throwable throwable) {
         }

         @Override
         public void onCompleted() {
             latch.countDown();
         }
     };
     StubInvocationUtil.unaryCall(invoker, method, request, responseObserver);
     latch.await(1, TimeUnit.SECONDS);
     Assertions.assertEquals(response, atomicReference.get());
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testUnaryCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">then</span>(<span class="hljs-title">invocationOnMock</span> -&gt; <span class="hljs-title">result</span>)</span>;

    when(result.recreate()).thenReturn(response);

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    AtomicReference&lt;Object&gt; atomicReference = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    StreamObserver&lt;Object&gt; responseObserver = <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

            atomicReference.set(data);

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

            latch.countDown();

        }

    };

    StubInvocationUtil.unaryCall(invoker, method, request, responseObserver);

    latch.await(<span class="hljs-number">1</span>, TimeUnit.SECONDS);

    Assertions.assertEquals(response, atomicReference.get());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;IGreeter&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invoker.getUrl()).thenReturn(url);
    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest674">Test Case ID #dubbo_Test_67_4</h4>
<h4 id="test-case-name-biorclientstreamcallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>biOrClientStreamCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void biOrClientStreamCall() throws InterruptedException {
<span class="hljs-deletion">-    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker.class);</span>
<span class="hljs-addition">+    Invoker&lt;IGreeter&gt; invoker = createMockInvoker(url);</span>
    URL url = Mockito.mock(URL.class);
    ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);
    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
    when(url.getServiceModel()).thenReturn(consumerModel);
    when(url.getServiceInterface()).thenReturn(IGreeter.class.getName());
    when(url.getProtocolServiceKey()).thenReturn(IGreeter.class.getName());
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
<span class="hljs-deletion">-    when(invoker.getInterface()).thenReturn(IGreeter.class);</span>
    Result result = Mockito.mock(Result.class);
    String response = "response";
    when(invoker.invoke(any(Invocation.class))).then(invocationOnMock -&gt; {
        Invocation invocation = (Invocation) invocationOnMock.getArguments()[0];
        StreamObserver&lt;Object&gt; observer = (StreamObserver&lt;Object&gt;) invocation.getArguments()[0];
        observer.onNext(response);
        observer.onCompleted();
        when(result.recreate()).then(invocationOnMock1 -&gt; new StreamObserver&lt;Object&gt;() {

            @Override
            public void onNext(Object data) {
                observer.onNext(data);
            }

            @Override
            public void onError(Throwable throwable) {
            }

            @Override
            public void onCompleted() {
                observer.onCompleted();
            }
        });
        return result;
    });
    MethodDescriptor method = Mockito.mock(MethodDescriptor.class);
    when(method.getParameterClasses()).thenReturn(new Class[] { String.class });
    when(method.getMethodName()).thenReturn("sayHello");
    String request = "request";
    CountDownLatch latch = new CountDownLatch(11);
    StreamObserver&lt;Object&gt; responseObserver = new StreamObserver&lt;Object&gt;() {

        @Override
        public void onNext(Object data) {
            latch.countDown();
        }

        @Override
        public void onError(Throwable throwable) {
        }

        @Override
        public void onCompleted() {
            latch.countDown();
        }
    };
    StreamObserver&lt;Object&gt; observer = StubInvocationUtil.biOrClientStreamCall(invoker, method, responseObserver);
    for (int i = 0; i &lt; 10; i++) {
        observer.onNext(request);
    }
    observer.onCompleted();
    Assertions.assertTrue(latch.await(1, TimeUnit.SECONDS));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">biOrClientStreamCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">then</span>(<span class="hljs-title">invocationOnMock</span> -&gt; </span>{

        Invocation invocation = (Invocation) invocationOnMock.getArguments()[<span class="hljs-number">0</span>];

        StreamObserver&lt;Object&gt; observer = (StreamObserver&lt;Object&gt;) invocation.getArguments()[<span class="hljs-number">0</span>];

        observer.onNext(response);

        observer.onCompleted();

        when(result.recreate()).then(invocationOnMock1 -&gt; <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



            <span class="hljs-meta">@Override</span>

            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

                observer.onNext(data);

            }



            <span class="hljs-meta">@Override</span>

            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

            }



            <span class="hljs-meta">@Override</span>

            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

                observer.onCompleted();

            }

        });

        <span class="hljs-keyword">return</span> result;

    });

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">11</span>);

    StreamObserver&lt;Object&gt; responseObserver = <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

            latch.countDown();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

            latch.countDown();

        }

    };

    StreamObserver&lt;Object&gt; observer = StubInvocationUtil.biOrClientStreamCall(invoker, method, responseObserver);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {

        observer.onNext(request);

    }

    observer.onCompleted();

    Assertions.assertTrue(latch.await(<span class="hljs-number">1</span>, TimeUnit.SECONDS));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;IGreeter&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invoker.getUrl()).thenReturn(url);
    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest675">Test Case ID #dubbo_Test_67_5</h4>
<h4 id="test-case-name-serverstreamcallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>serverStreamCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-invoker">Mock Object Variable Name: <code>invoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void serverStreamCall() throws InterruptedException {
<span class="hljs-deletion">-    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker.class);</span>
<span class="hljs-addition">+    Invoker&lt;IGreeter&gt; invoker = createMockInvoker(url);</span>
    URL url = Mockito.mock(URL.class);
    ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);
    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
    when(url.getServiceModel()).thenReturn(consumerModel);
    when(url.getServiceInterface()).thenReturn(IGreeter.class.getName());
    when(url.getProtocolServiceKey()).thenReturn(IGreeter.class.getName());
<span class="hljs-deletion">-    when(invoker.getUrl()).thenReturn(url);</span>
<span class="hljs-deletion">-    when(invoker.getInterface()).thenReturn(IGreeter.class);</span>
    Result result = Mockito.mock(Result.class);
    String response = "response";
    when(invoker.invoke(any(Invocation.class))).then(invocationOnMock -&gt; {
        Invocation invocation = (Invocation) invocationOnMock.getArguments()[0];
        StreamObserver&lt;Object&gt; observer = (StreamObserver&lt;Object&gt;) invocation.getArguments()[1];
        for (int i = 0; i &lt; 10; i++) {
            observer.onNext(response);
        }
        observer.onCompleted();
        return result;
    });
    MethodDescriptor method = Mockito.mock(MethodDescriptor.class);
    when(method.getParameterClasses()).thenReturn(new Class[] { String.class });
    when(method.getMethodName()).thenReturn("sayHello");
    String request = "request";
    CountDownLatch latch = new CountDownLatch(11);
    StreamObserver&lt;Object&gt; responseObserver = new StreamObserver&lt;Object&gt;() {

        @Override
        public void onNext(Object data) {
            latch.countDown();
        }

        @Override
        public void onError(Throwable throwable) {
        }

        @Override
        public void onCompleted() {
            latch.countDown();
        }
    };
    StubInvocationUtil.serverStreamCall(invoker, method, request, responseObserver);
    Assertions.assertTrue(latch.await(1, TimeUnit.SECONDS));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">serverStreamCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">then</span>(<span class="hljs-title">invocationOnMock</span> -&gt; </span>{

        Invocation invocation = (Invocation) invocationOnMock.getArguments()[<span class="hljs-number">0</span>];

        StreamObserver&lt;Object&gt; observer = (StreamObserver&lt;Object&gt;) invocation.getArguments()[<span class="hljs-number">1</span>];

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {

            observer.onNext(response);

        }

        observer.onCompleted();

        <span class="hljs-keyword">return</span> result;

    });

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">11</span>);

    StreamObserver&lt;Object&gt; responseObserver = <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

            latch.countDown();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

            latch.countDown();

        }

    };

    StubInvocationUtil.serverStreamCall(invoker, method, request, responseObserver);

    Assertions.assertTrue(latch.await(<span class="hljs-number">1</span>, TimeUnit.SECONDS));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Invoker&lt;IGreeter&gt; <span class="hljs-title">createMockInvoker</span><span class="hljs-params">(URL url)</span> </span>{
    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(invoker.getUrl()).thenReturn(url);
    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> invoker;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci68">Mock Clone Instance #dubbo_MCI_68</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.common.logger.Logger</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockLogger</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Logger <span class="hljs-title">createMockLoggerWithFailingMethods</span><span class="hljs-params">()</span> </span>{
        Logger logger = mock(Logger<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).debug(anyString());
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).debug(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).error(anyString());
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).error(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).info(anyString());
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).info(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).trace(anyString());
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).trace(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).warn(anyString());
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).warn(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        <span class="hljs-keyword">return</span> logger;
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest681">Test Case ID #dubbo_Test_68_1</h4>
<h4 id="test-case-name-testfailsafeerrortypeawareforloggingmethodfile-cjavaprojectsapachedubbodubbo-commonsrctestjavaorgapachedubbocommonloggersupportfailsafeerrortypeawareloggertestjava">Test Case Name: <code>testFailsafeErrorTypeAwareForLoggingMethod</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-common\src\test\java\org\apache\dubbo\common\logger\support\FailsafeErrorTypeAwareLoggerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-faillogger">Mock Object Variable Name: <code>failLogger</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testFailsafeErrorTypeAwareForLoggingMethod() {
<span class="hljs-deletion">-    Logger failLogger = mock(Logger.class);</span>
<span class="hljs-addition">+    Logger failLogger = MockLogger.createMockLoggerWithFailingMethods();</span>
    FailsafeErrorTypeAwareLogger failsafeLogger = new FailsafeErrorTypeAwareLogger(failLogger);
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).error(anyString());</span>
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).warn(anyString());</span>
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).info(anyString());</span>
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).debug(anyString());</span>
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).trace(anyString());</span>
    failsafeLogger.error(REGISTRY_ADDRESS_INVALID, "Registry center", "May be it's offline.", "error");
    failsafeLogger.warn(REGISTRY_ADDRESS_INVALID, "Registry center", "May be it's offline.", "warn");
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).error(any(Throwable.class));</span>
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).warn(any(Throwable.class));</span>
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).info(any(Throwable.class));</span>
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).debug(any(Throwable.class));</span>
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).trace(any(Throwable.class));</span>
    failsafeLogger.error(REGISTRY_ADDRESS_INVALID, "Registry center", "May be it's offline.", "error", new Exception("error"));
    failsafeLogger.warn(REGISTRY_ADDRESS_INVALID, "Registry center", "May be it's offline.", "warn", new Exception("warn"));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testFailsafeErrorTypeAwareForLoggingMethod</span><span class="hljs-params">()</span> </span>{

    Logger failLogger = mock(Logger<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    FailsafeErrorTypeAwareLogger failsafeLogger = <span class="hljs-keyword">new</span> FailsafeErrorTypeAwareLogger(failLogger);

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).error(anyString());

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).warn(anyString());

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).info(anyString());

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).debug(anyString());

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).trace(anyString());

    failsafeLogger.error(REGISTRY_ADDRESS_INVALID, <span class="hljs-string">"Registry center"</span>, <span class="hljs-string">"May be it's offline."</span>, <span class="hljs-string">"error"</span>);

    failsafeLogger.warn(REGISTRY_ADDRESS_INVALID, <span class="hljs-string">"Registry center"</span>, <span class="hljs-string">"May be it's offline."</span>, <span class="hljs-string">"warn"</span>);

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).error(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).warn(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).info(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).debug(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).trace(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    failsafeLogger.error(REGISTRY_ADDRESS_INVALID, <span class="hljs-string">"Registry center"</span>, <span class="hljs-string">"May be it's offline."</span>, <span class="hljs-string">"error"</span>, <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"error"</span>));

    failsafeLogger.warn(REGISTRY_ADDRESS_INVALID, <span class="hljs-string">"Registry center"</span>, <span class="hljs-string">"May be it's offline."</span>, <span class="hljs-string">"warn"</span>, <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"warn"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockLogger</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Logger <span class="hljs-title">createMockLoggerWithFailingMethods</span><span class="hljs-params">()</span> </span>{
        Logger logger = mock(Logger<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).debug(anyString());
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).debug(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).error(anyString());
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).error(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).info(anyString());
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).info(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).trace(anyString());
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).trace(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).warn(anyString());
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).warn(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        <span class="hljs-keyword">return</span> logger;
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest682">Test Case ID #dubbo_Test_68_2</h4>
<h4 id="test-case-name-testfailsafeforloggingmethodfile-cjavaprojectsapachedubbodubbo-commonsrctestjavaorgapachedubbocommonloggersupportfailsafeloggertestjava">Test Case Name: <code>testFailSafeForLoggingMethod</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-common\src\test\java\org\apache\dubbo\common\logger\support\FailsafeLoggerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-faillogger">Mock Object Variable Name: <code>failLogger</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testFailSafeForLoggingMethod() {
<span class="hljs-deletion">-    Logger failLogger = mock(Logger.class);</span>
<span class="hljs-addition">+    Logger failLogger = MockLogger.createMockLoggerWithFailingMethods();</span>
    FailsafeLogger failsafeLogger = new FailsafeLogger(failLogger);
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).error(anyString());</span>
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).warn(anyString());</span>
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).info(anyString());</span>
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).debug(anyString());</span>
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).trace(anyString());</span>
    failsafeLogger.error("error");
    failsafeLogger.warn("warn");
    failsafeLogger.info("info");
    failsafeLogger.debug("debug");
    failsafeLogger.trace("info");
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).error(any(Throwable.class));</span>
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).warn(any(Throwable.class));</span>
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).info(any(Throwable.class));</span>
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).debug(any(Throwable.class));</span>
<span class="hljs-deletion">-    doThrow(new RuntimeException()).when(failLogger).trace(any(Throwable.class));</span>
    failsafeLogger.error(new Exception("error"));
    failsafeLogger.warn(new Exception("warn"));
    failsafeLogger.info(new Exception("info"));
    failsafeLogger.debug(new Exception("debug"));
    failsafeLogger.trace(new Exception("trace"));
    failsafeLogger.error("error", new Exception("error"));
    failsafeLogger.warn("warn", new Exception("warn"));
    failsafeLogger.info("info", new Exception("info"));
    failsafeLogger.debug("debug", new Exception("debug"));
    failsafeLogger.trace("trace", new Exception("trace"));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testFailSafeForLoggingMethod</span><span class="hljs-params">()</span> </span>{

    Logger failLogger = mock(Logger<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    FailsafeLogger failsafeLogger = <span class="hljs-keyword">new</span> FailsafeLogger(failLogger);

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).error(anyString());

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).warn(anyString());

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).info(anyString());

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).debug(anyString());

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).trace(anyString());

    failsafeLogger.error(<span class="hljs-string">"error"</span>);

    failsafeLogger.warn(<span class="hljs-string">"warn"</span>);

    failsafeLogger.info(<span class="hljs-string">"info"</span>);

    failsafeLogger.debug(<span class="hljs-string">"debug"</span>);

    failsafeLogger.trace(<span class="hljs-string">"info"</span>);

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).error(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).warn(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).info(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).debug(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(failLogger).trace(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    failsafeLogger.error(<span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"error"</span>));

    failsafeLogger.warn(<span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"warn"</span>));

    failsafeLogger.info(<span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"info"</span>));

    failsafeLogger.debug(<span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"debug"</span>));

    failsafeLogger.trace(<span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"trace"</span>));

    failsafeLogger.error(<span class="hljs-string">"error"</span>, <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"error"</span>));

    failsafeLogger.warn(<span class="hljs-string">"warn"</span>, <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"warn"</span>));

    failsafeLogger.info(<span class="hljs-string">"info"</span>, <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"info"</span>));

    failsafeLogger.debug(<span class="hljs-string">"debug"</span>, <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"debug"</span>));

    failsafeLogger.trace(<span class="hljs-string">"trace"</span>, <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"trace"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockLogger</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Logger <span class="hljs-title">createMockLoggerWithFailingMethods</span><span class="hljs-params">()</span> </span>{
        Logger logger = mock(Logger<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).debug(anyString());
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).debug(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).error(anyString());
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).error(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).info(anyString());
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).info(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).trace(anyString());
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).trace(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).warn(anyString());
        doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(logger).warn(any(Throwable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;
        <span class="hljs-keyword">return</span> logger;
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci69">Mock Clone Instance #dubbo_MCI_69</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.cluster.router.mesh.route.MeshEnvListener</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MeshEnvListener <span class="hljs-title">createMockMeshEnvListener</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isEnableReturn)</span> </span>{
    MeshEnvListener meshEnvListener = Mockito.mock(MeshEnvListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(meshEnvListener.isEnable()).thenReturn(isEnableReturn);
    <span class="hljs-keyword">return</span> meshEnvListener;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest691">Test Case ID #dubbo_Test_69_1</h4>
<h4 id="test-case-name-testregister3file-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclusterroutermeshroutemeshrulemanagertestjava">Test Case Name: <code>testRegister3</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\router\mesh\route\MeshRuleManagerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-meshenvlistener1">Mock Object Variable Name: <code>meshEnvListener1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    MeshEnvListenerFactory meshEnvListener1 = Mockito.mock(MeshEnvListenerFactory.class);
    MeshEnvListenerFactory meshEnvListenerFactory2 = Mockito.mock(MeshEnvListenerFactory.class);
<span class="hljs-deletion">-    MeshEnvListener meshEnvListener1 = Mockito.mock(MeshEnvListener.class);</span>
<span class="hljs-addition">+    MeshEnvListener meshEnvListener1 = createMockMeshEnvListener(false);</span>
    when(meshEnvListenerFactory1.getListener()).thenReturn(meshEnvListener1);
    MeshEnvListener meshEnvListener2 = Mockito.mock(MeshEnvListener.class);
    when(meshEnvListenerFactory2.getListener()).thenReturn(meshEnvListener2);
    envListenerFactories.add(meshEnvListenerFactory1);
    envListenerFactories.add(meshEnvListenerFactory2);
    MeshRuleManager meshRuleManager = new MeshRuleManager(moduleModel);
    MeshRuleListener meshRuleListener1 = new MeshRuleListener() {
@@
        public String ruleSuffix() {
            return "Type1";
        }
    };
<span class="hljs-deletion">-    when(meshEnvListener1.isEnable()).thenReturn(false);</span>
    when(meshEnvListener2.isEnable()).thenReturn(true);
    meshRuleManager.register("dubbo-demo", meshRuleListener1);
    assertEquals(1, meshRuleManager.getAppRuleListeners().size());
    verify(ruleRepository, times(1)).getRule("dubbo-demo.MESHAPPRULE", "dubbo", 5000L);
    MeshAppRuleListener meshAppRuleListener = meshRuleManager.getAppRuleListeners().values().iterator().next();
    verify(ruleRepository, times(1)).addListener("dubbo-demo.MESHAPPRULE", "dubbo", meshAppRuleListener);
    verify(meshEnvListener2, times(1)).onSubscribe("dubbo-demo", meshAppRuleListener);
    meshRuleManager.register("dubbo-demo", meshRuleListener1);
    assertEquals(1, meshRuleManager.getAppRuleListeners().size());
    MeshRuleListener meshRuleListener2 = new MeshRuleListener() {
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRegister3</span><span class="hljs-params">()</span> </span>{

    MeshEnvListenerFactory meshEnvListenerFactory1 = Mockito.mock(MeshEnvListenerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MeshEnvListenerFactory meshEnvListenerFactory2 = Mockito.mock(MeshEnvListenerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MeshEnvListener meshEnvListener1 = Mockito.mock(MeshEnvListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(meshEnvListenerFactory1.getListener()).thenReturn(meshEnvListener1);

    MeshEnvListener meshEnvListener2 = Mockito.mock(MeshEnvListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(meshEnvListenerFactory2.getListener()).thenReturn(meshEnvListener2);

    envListenerFactories.add(meshEnvListenerFactory1);

    envListenerFactories.add(meshEnvListenerFactory2);

    MeshRuleManager meshRuleManager = <span class="hljs-keyword">new</span> MeshRuleManager(moduleModel);

    MeshRuleListener meshRuleListener1 = <span class="hljs-keyword">new</span> MeshRuleListener() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onRuleChange</span><span class="hljs-params">(String appName, List&lt;Map&lt;String, Object&gt;&gt; rules)</span> </span>{

            fail();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clearRule</span><span class="hljs-params">(String appName)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">ruleSuffix</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-string">"Type1"</span>;

        }

    };

    when(meshEnvListener1.isEnable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(meshEnvListener2.isEnable()).thenReturn(<span class="hljs-keyword">true</span>);

    meshRuleManager.register(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener1);

    assertEquals(<span class="hljs-number">1</span>, meshRuleManager.getAppRuleListeners().size());

    verify(ruleRepository, times(<span class="hljs-number">1</span>)).getRule(<span class="hljs-string">"dubbo-demo.MESHAPPRULE"</span>, <span class="hljs-string">"dubbo"</span>, <span class="hljs-number">5000L</span>);

    MeshAppRuleListener meshAppRuleListener = meshRuleManager.getAppRuleListeners().values().iterator().next();

    verify(ruleRepository, times(<span class="hljs-number">1</span>)).addListener(<span class="hljs-string">"dubbo-demo.MESHAPPRULE"</span>, <span class="hljs-string">"dubbo"</span>, meshAppRuleListener);

    verify(meshEnvListener2, times(<span class="hljs-number">1</span>)).onSubscribe(<span class="hljs-string">"dubbo-demo"</span>, meshAppRuleListener);

    meshRuleManager.register(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener1);

    assertEquals(<span class="hljs-number">1</span>, meshRuleManager.getAppRuleListeners().size());

    MeshRuleListener meshRuleListener2 = <span class="hljs-keyword">new</span> MeshRuleListener() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onRuleChange</span><span class="hljs-params">(String appName, List&lt;Map&lt;String, Object&gt;&gt; rules)</span> </span>{

            fail();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clearRule</span><span class="hljs-params">(String appName)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">ruleSuffix</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-string">"Type2"</span>;

        }

    };

    meshRuleManager.register(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener2);

    assertEquals(<span class="hljs-number">1</span>, meshRuleManager.getAppRuleListeners().size());

    assertEquals(<span class="hljs-number">2</span>, meshAppRuleListener.getMeshRuleDispatcher().getListenerMap().size());

    meshRuleManager.unregister(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener1);

    assertEquals(<span class="hljs-number">1</span>, meshRuleManager.getAppRuleListeners().size());

    assertEquals(<span class="hljs-number">1</span>, meshAppRuleListener.getMeshRuleDispatcher().getListenerMap().size());

    meshRuleManager.unregister(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener2);

    assertEquals(<span class="hljs-number">0</span>, meshRuleManager.getAppRuleListeners().size());

    verify(ruleRepository, times(<span class="hljs-number">1</span>)).removeListener(<span class="hljs-string">"dubbo-demo.MESHAPPRULE"</span>, <span class="hljs-string">"dubbo"</span>, meshAppRuleListener);

    verify(meshEnvListener2, times(<span class="hljs-number">1</span>)).onUnSubscribe(<span class="hljs-string">"dubbo-demo"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MeshEnvListener <span class="hljs-title">createMockMeshEnvListener</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isEnableReturn)</span> </span>{
    MeshEnvListener meshEnvListener = Mockito.mock(MeshEnvListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(meshEnvListener.isEnable()).thenReturn(isEnableReturn);
    <span class="hljs-keyword">return</span> meshEnvListener;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest692">Test Case ID #dubbo_Test_69_2</h4>
<h4 id="test-case-name-testregister3file-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclusterroutermeshroutemeshrulemanagertestjava">Test Case Name: <code>testRegister3</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\router\mesh\route\MeshRuleManagerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-meshenvlistener2">Mock Object Variable Name: <code>meshEnvListener2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    MeshEnvListenerFactory meshEnvListener1 = Mockito.mock(MeshEnvListenerFactory.class);
    MeshEnvListenerFactory meshEnvListener2 = Mockito.mock(MeshEnvListenerFactory.class);
    MeshEnvListener meshEnvListener1 = Mockito.mock(MeshEnvListener.class);
    when(meshEnvListenerFactory1.getListener()).thenReturn(meshEnvListener1);
<span class="hljs-deletion">-    MeshEnvListener meshEnvListener2 = Mockito.mock(MeshEnvListener.class);</span>
<span class="hljs-deletion">-    when(meshEnvListenerFactory2.getListener()).thenReturn(meshEnvListener2);</span>
<span class="hljs-addition">+    MeshEnvListener meshEnvListener2 = createMockMeshEnvListener(true);</span>
<span class="hljs-addition">+    when(meshEnvListenerFactory2.getListener()).thenReturn(meshEnvListener2);</span>
    envListenerFactories.add(meshEnvListenerFactory1);
    envListenerFactories.add(meshEnvListenerFactory2);
    MeshRuleManager meshRuleManager = new MeshRuleManager(moduleModel);
    MeshRuleListener meshRuleListener1 = new MeshRuleListener() {
@@
        @Override
        public String ruleSuffix() {
            return "Type1";
        }
    };
    when(meshEnvListener1.isEnable()).thenReturn(false);
<span class="hljs-deletion">-    when(meshEnvListener2.isEnable()).thenReturn(true);</span>
    meshRuleManager.register("dubbo-demo", meshRuleListener1);
    assertEquals(1, meshRuleManager.getAppRuleListeners().size());
    verify(ruleRepository, times(1)).getRule("dubbo-demo.MESHAPPRULE", "dubbo", 5000L);
    MeshAppRuleListener meshAppRuleListener = meshRuleManager.getAppRuleListeners().values().iterator().next();
    verify(ruleRepository, times(1)).addListener("dubbo-demo.MESHAPPRULE", "dubbo", meshAppRuleListener);
    verify(meshEnvListener2, times(1)).onSubscribe("dubbo-demo", meshAppRuleListener);
    meshRuleManager.register("dubbo-demo", meshRuleListener1);
    assertEquals(1, meshRuleManager.getAppRuleListeners().size());
    MeshRuleListener meshRuleListener2 = new MeshRuleListener() {
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRegister3</span><span class="hljs-params">()</span> </span>{

    MeshEnvListenerFactory meshEnvListenerFactory1 = Mockito.mock(MeshEnvListenerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MeshEnvListenerFactory meshEnvListenerFactory2 = Mockito.mock(MeshEnvListenerFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MeshEnvListener meshEnvListener1 = Mockito.mock(MeshEnvListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(meshEnvListenerFactory1.getListener()).thenReturn(meshEnvListener1);

    MeshEnvListener meshEnvListener2 = Mockito.mock(MeshEnvListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(meshEnvListenerFactory2.getListener()).thenReturn(meshEnvListener2);

    envListenerFactories.add(meshEnvListenerFactory1);

    envListenerFactories.add(meshEnvListenerFactory2);

    MeshRuleManager meshRuleManager = <span class="hljs-keyword">new</span> MeshRuleManager(moduleModel);

    MeshRuleListener meshRuleListener1 = <span class="hljs-keyword">new</span> MeshRuleListener() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onRuleChange</span><span class="hljs-params">(String appName, List&lt;Map&lt;String, Object&gt;&gt; rules)</span> </span>{

            fail();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clearRule</span><span class="hljs-params">(String appName)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">ruleSuffix</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-string">"Type1"</span>;

        }

    };

    when(meshEnvListener1.isEnable()).thenReturn(<span class="hljs-keyword">false</span>);

    when(meshEnvListener2.isEnable()).thenReturn(<span class="hljs-keyword">true</span>);

    meshRuleManager.register(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener1);

    assertEquals(<span class="hljs-number">1</span>, meshRuleManager.getAppRuleListeners().size());

    verify(ruleRepository, times(<span class="hljs-number">1</span>)).getRule(<span class="hljs-string">"dubbo-demo.MESHAPPRULE"</span>, <span class="hljs-string">"dubbo"</span>, <span class="hljs-number">5000L</span>);

    MeshAppRuleListener meshAppRuleListener = meshRuleManager.getAppRuleListeners().values().iterator().next();

    verify(ruleRepository, times(<span class="hljs-number">1</span>)).addListener(<span class="hljs-string">"dubbo-demo.MESHAPPRULE"</span>, <span class="hljs-string">"dubbo"</span>, meshAppRuleListener);

    verify(meshEnvListener2, times(<span class="hljs-number">1</span>)).onSubscribe(<span class="hljs-string">"dubbo-demo"</span>, meshAppRuleListener);

    meshRuleManager.register(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener1);

    assertEquals(<span class="hljs-number">1</span>, meshRuleManager.getAppRuleListeners().size());

    MeshRuleListener meshRuleListener2 = <span class="hljs-keyword">new</span> MeshRuleListener() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onRuleChange</span><span class="hljs-params">(String appName, List&lt;Map&lt;String, Object&gt;&gt; rules)</span> </span>{

            fail();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clearRule</span><span class="hljs-params">(String appName)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">ruleSuffix</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-string">"Type2"</span>;

        }

    };

    meshRuleManager.register(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener2);

    assertEquals(<span class="hljs-number">1</span>, meshRuleManager.getAppRuleListeners().size());

    assertEquals(<span class="hljs-number">2</span>, meshAppRuleListener.getMeshRuleDispatcher().getListenerMap().size());

    meshRuleManager.unregister(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener1);

    assertEquals(<span class="hljs-number">1</span>, meshRuleManager.getAppRuleListeners().size());

    assertEquals(<span class="hljs-number">1</span>, meshAppRuleListener.getMeshRuleDispatcher().getListenerMap().size());

    meshRuleManager.unregister(<span class="hljs-string">"dubbo-demo"</span>, meshRuleListener2);

    assertEquals(<span class="hljs-number">0</span>, meshRuleManager.getAppRuleListeners().size());

    verify(ruleRepository, times(<span class="hljs-number">1</span>)).removeListener(<span class="hljs-string">"dubbo-demo.MESHAPPRULE"</span>, <span class="hljs-string">"dubbo"</span>, meshAppRuleListener);

    verify(meshEnvListener2, times(<span class="hljs-number">1</span>)).onUnSubscribe(<span class="hljs-string">"dubbo-demo"</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MeshEnvListener <span class="hljs-title">createMockMeshEnvListener</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isEnableReturn)</span> </span>{
    MeshEnvListener meshEnvListener = Mockito.mock(MeshEnvListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(meshEnvListener.isEnable()).thenReturn(isEnableReturn);
    <span class="hljs-keyword">return</span> meshEnvListener;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci70">Mock Clone Instance #dubbo_MCI_70</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.monitor.MonitorFactory</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MonitorFactory <span class="hljs-title">createMockMonitorFactory</span><span class="hljs-params">(Monitor mockMonitor)</span> </span>{
    MonitorFactory mockMonitorFactory = mock(MonitorFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(mockMonitorFactory.getMonitor(any(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">mockMonitor</span>)</span>;
    <span class="hljs-keyword">return</span> mockMonitorFactory;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest701">Test Case ID #dubbo_Test_70_1</h4>
<h4 id="test-case-name-testsafefailformonitorcollectfailfile-cjavaprojectsapachedubbodubbo-monitordubbo-monitor-apisrctestjavaorgapachedubbomonitorsupportmonitorfiltertestjava">Test Case Name: <code>testSafeFailForMonitorCollectFail</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-monitor\dubbo-monitor-api\src\test\java\org\apache\dubbo\monitor\support\MonitorFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockmonitorfactory">Mock Object Variable Name: <code>mockMonitorFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    MonitorFilter monitorFilter = new MonitorFilter();
<span class="hljs-deletion">-    MonitorFactory mockMonitorFactory = mock(MonitorFactory.class);</span>
    Monitor mockMonitor = mock(Monitor.class);
    Mockito.doThrow(new RuntimeException()).when(mockMonitor).collect(any(URL.class));
<span class="hljs-addition">+    MonitorFactory mockMonitorFactory = createMockMonitorFactory(mockMonitor);</span>
    monitorFilter.setMonitorFactory(mockMonitorFactory);
<span class="hljs-deletion">-    given(mockMonitorFactory.getMonitor(any(URL.class))).willReturn(mockMonitor);</span>
    Invocation invocation = new RpcInvocation("aaa", MonitorService.class.getName(), "", new Class&lt;?&gt;[0], new Object[0]);
    monitorFilter.invoke(serviceInvoker, invocation);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testSafeFailForMonitorCollectFail</span><span class="hljs-params">()</span> </span>{

    MonitorFilter monitorFilter = <span class="hljs-keyword">new</span> MonitorFilter();

    MonitorFactory mockMonitorFactory = mock(MonitorFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Monitor mockMonitor = mock(Monitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.doThrow(<span class="hljs-keyword">new</span> RuntimeException()).when(mockMonitor).collect(any(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    monitorFilter.setMonitorFactory(mockMonitorFactory);

    given(mockMonitorFactory.getMonitor(any(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">mockMonitor</span>)</span>;

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"aaa"</span>, MonitorService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), "", <span class="hljs-title">new</span> <span class="hljs-title">Class</span>&lt;?&gt;[0], <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[0])</span>;

    monitorFilter.invoke(serviceInvoker, invocation);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MonitorFactory <span class="hljs-title">createMockMonitorFactory</span><span class="hljs-params">(Monitor mockMonitor)</span> </span>{
    MonitorFactory mockMonitorFactory = mock(MonitorFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(mockMonitorFactory.getMonitor(any(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">mockMonitor</span>)</span>;
    <span class="hljs-keyword">return</span> mockMonitorFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest702">Test Case ID #dubbo_Test_70_2</h4>
<h4 id="test-case-name-testonresponsewithoutstarttimefile-cjavaprojectsapachedubbodubbo-monitordubbo-monitor-apisrctestjavaorgapachedubbomonitorsupportmonitorfiltertestjava">Test Case Name: <code>testOnResponseWithoutStartTime</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-monitor\dubbo-monitor-api\src\test\java\org\apache\dubbo\monitor\support\MonitorFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockmonitorfactory">Mock Object Variable Name: <code>mockMonitorFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    MonitorFilter monitorFilter = new MonitorFilter();
<span class="hljs-deletion">-    MonitorFactory mockMonitorFactory = mock(MonitorFactory.class);</span>
    Monitor mockMonitor = mock(Monitor.class);
<span class="hljs-deletion">-    monitorFilter.setMonitorFactory(mockMonitorFactory);</span>
<span class="hljs-deletion">-    given(mockMonitorFactory.getMonitor(any(URL.class))).willReturn(mockMonitor);</span>
<span class="hljs-addition">+    MonitorFactory mockMonitorFactory = createMockMonitorFactory(mockMonitor);</span>
<span class="hljs-addition">+    monitorFilter.setMonitorFactory(mockMonitorFactory);</span>
    Invocation invocation = new RpcInvocation("aaa", MonitorService.class.getName(), "", new Class&lt;?&gt;[0], new Object[0]);
    Result result = monitorFilter.invoke(serviceInvoker, invocation);
    invocation.getAttributes().remove("monitor_filter_start_time");
    monitorFilter.onResponse(result, serviceInvoker, invocation);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testOnResponseWithoutStartTime</span><span class="hljs-params">()</span> </span>{

    MonitorFilter monitorFilter = <span class="hljs-keyword">new</span> MonitorFilter();

    MonitorFactory mockMonitorFactory = mock(MonitorFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Monitor mockMonitor = mock(Monitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    monitorFilter.setMonitorFactory(mockMonitorFactory);

    given(mockMonitorFactory.getMonitor(any(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">mockMonitor</span>)</span>;

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"aaa"</span>, MonitorService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), "", <span class="hljs-title">new</span> <span class="hljs-title">Class</span>&lt;?&gt;[0], <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[0])</span>;

    Result result = monitorFilter.invoke(serviceInvoker, invocation);

    invocation.getAttributes().remove(<span class="hljs-string">"monitor_filter_start_time"</span>);

    monitorFilter.onResponse(result, serviceInvoker, invocation);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MonitorFactory <span class="hljs-title">createMockMonitorFactory</span><span class="hljs-params">(Monitor mockMonitor)</span> </span>{
    MonitorFactory mockMonitorFactory = mock(MonitorFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(mockMonitorFactory.getMonitor(any(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">mockMonitor</span>)</span>;
    <span class="hljs-keyword">return</span> mockMonitorFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest703">Test Case ID #dubbo_Test_70_3</h4>
<h4 id="test-case-name-testonerrorwithoutstarttimefile-cjavaprojectsapachedubbodubbo-monitordubbo-monitor-apisrctestjavaorgapachedubbomonitorsupportmonitorfiltertestjava">Test Case Name: <code>testOnErrorWithoutStartTime</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-monitor\dubbo-monitor-api\src\test\java\org\apache\dubbo\monitor\support\MonitorFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockmonitorfactory">Mock Object Variable Name: <code>mockMonitorFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    MonitorFilter monitorFilter = new MonitorFilter();
<span class="hljs-deletion">-    MonitorFactory mockMonitorFactory = mock(MonitorFactory.class);</span>
    Monitor mockMonitor = mock(Monitor.class);
<span class="hljs-addition">+    MonitorFactory mockMonitorFactory = createMockMonitorFactory(mockMonitor);</span>
    monitorFilter.setMonitorFactory(mockMonitorFactory);
<span class="hljs-deletion">-    given(mockMonitorFactory.getMonitor(any(URL.class))).willReturn(mockMonitor);</span>
    Invocation invocation = new RpcInvocation("aaa", MonitorService.class.getName(), "", new Class&lt;?&gt;[0], new Object[0]);
    Throwable rpcException = new RpcException();
    monitorFilter.onError(rpcException, serviceInvoker, invocation);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testOnErrorWithoutStartTime</span><span class="hljs-params">()</span> </span>{

    MonitorFilter monitorFilter = <span class="hljs-keyword">new</span> MonitorFilter();

    MonitorFactory mockMonitorFactory = mock(MonitorFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Monitor mockMonitor = mock(Monitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    monitorFilter.setMonitorFactory(mockMonitorFactory);

    given(mockMonitorFactory.getMonitor(any(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">mockMonitor</span>)</span>;

    Invocation invocation = <span class="hljs-keyword">new</span> RpcInvocation(<span class="hljs-string">"aaa"</span>, MonitorService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), "", <span class="hljs-title">new</span> <span class="hljs-title">Class</span>&lt;?&gt;[0], <span class="hljs-title">new</span> <span class="hljs-title">Object</span>[0])</span>;

    Throwable rpcException = <span class="hljs-keyword">new</span> RpcException();

    monitorFilter.onError(rpcException, serviceInvoker, invocation);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> MonitorFactory <span class="hljs-title">createMockMonitorFactory</span><span class="hljs-params">(Monitor mockMonitor)</span> </span>{
    MonitorFactory mockMonitorFactory = mock(MonitorFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(mockMonitorFactory.getMonitor(any(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">willReturn</span>(<span class="hljs-title">mockMonitor</span>)</span>;
    <span class="hljs-keyword">return</span> mockMonitorFactory;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci71">Mock Clone Instance #dubbo_MCI_71</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.cluster.Cluster</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Cluster cluster;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
cluster;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest711">Test Case ID #dubbo_Test_71_1</h4>
<h4 id="test-case-name-testconsumerurlwithoutprotocolfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testConsumerUrlWithoutProtocol</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-cluster">Mock Object Variable Name: <code>cluster</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);
<span class="hljs-deletion">-    Cluster cluster = mock(Cluster.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `cluster`</span>
     Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService.class, url, parameters);
     Assertions.assertTrue(invoker instanceof MigrationInvoker);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify the generated consumer url information

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumerUrlWithoutProtocol</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    <span class="hljs-comment">// verify that the protocol header of consumerUrl is set to "consumer"</span>

    Assertions.assertEquals(<span class="hljs-string">"consumer"</span>, consumerUrl.getProtocol());

    Assertions.assertEquals(parameters.get(REGISTER_IP_KEY), consumerUrl.getHost());

    Assertions.assertFalse(consumerUrl.getAttributes().containsKey(REFER_KEY));

    Assertions.assertEquals(<span class="hljs-string">"value1"</span>, consumerUrl.getAttribute(<span class="hljs-string">"key1"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Cluster cluster;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
cluster;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest712">Test Case ID #dubbo_Test_71_2</h4>
<h4 id="test-case-name-testconsumerurlwithprotocolfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testConsumerUrlWithProtocol</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-cluster">Mock Object Variable Name: <code>cluster</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);
<span class="hljs-deletion">-    Cluster cluster = mock(Cluster.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `cluster`</span>
     Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService.class, url, parameters);
     Assertions.assertTrue(invoker instanceof MigrationInvoker);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that when the protocol is configured, the protocol of consumer url is the configured protocol

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumerUrlWithProtocol</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    parameters.put(PROTOCOL_KEY, <span class="hljs-string">"tri"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    <span class="hljs-comment">// verify that the protocol of consumer url</span>

    Assertions.assertEquals(<span class="hljs-string">"tri"</span>, consumerUrl.getProtocol());

    Assertions.assertEquals(parameters.get(REGISTER_IP_KEY), consumerUrl.getHost());

    Assertions.assertFalse(consumerUrl.getAttributes().containsKey(REFER_KEY));

    Assertions.assertEquals(<span class="hljs-string">"value1"</span>, consumerUrl.getAttribute(<span class="hljs-string">"key1"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Cluster cluster;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
cluster;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest713">Test Case ID #dubbo_Test_71_3</h4>
<h4 id="test-case-name-testregisterconsumerurlfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testRegisterConsumerUrl</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-cluster">Mock Object Variable Name: <code>cluster</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);
<span class="hljs-deletion">-    Cluster cluster = mock(Cluster.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `cluster`</span>
     Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService.class, url, parameters);
     Assertions.assertTrue(invoker instanceof MigrationInvoker);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify the registered consumer url

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRegisterConsumerUrl</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"true"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);

    url = url.setScopeModel(moduleModel);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    Map&lt;String, String&gt; urlParameters = consumerUrl.getParameters();

    URL urlToRegistry = <span class="hljs-keyword">new</span> ServiceConfigURL(urlParameters.get(PROTOCOL_KEY) == <span class="hljs-keyword">null</span> ? CONSUMER : urlParameters.get(PROTOCOL_KEY), urlParameters.remove(REGISTER_IP_KEY), <span class="hljs-number">0</span>, consumerUrl.getPath(), urlParameters);

    URL registeredConsumerUrl = urlToRegistry.addParameters(CATEGORY_KEY, CONSUMERS_CATEGORY, CHECK_KEY, String.valueOf(<span class="hljs-keyword">false</span>)).setScopeModel(moduleModel);

    verify(registry, times(<span class="hljs-number">1</span>)).register(registeredConsumerUrl);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Cluster cluster;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
cluster;

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci72">Mock Clone Instance #dubbo_MCI_72</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.model.ConsumerModel</code></li>
<li><strong>Test Case Count</strong>: 5</li>
<li><strong>MO Count</strong>: 5</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConsumerModel <span class="hljs-title">createMockConsumerModel</span><span class="hljs-params">(ServiceDescriptor serviceDescriptor)</span> </span>{
    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
    <span class="hljs-keyword">return</span> consumerModel;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest721">Test Case ID #dubbo_Test_72_1</h4>
<h4 id="test-case-name-unarycallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>unaryCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-consumermodel">Mock Object Variable Name: <code>consumerModel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker.class);
    URL url = Mockito.mock(URL.class);
<span class="hljs-deletion">-    ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);</span>
    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
<span class="hljs-addition">+    ConsumerModel consumerModel = createMockConsumerModel(serviceDescriptor);</span>
    when(url.getServiceModel()).thenReturn(consumerModel);
    when(url.getServiceInterface()).thenReturn(IGreeter.class.getName());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unaryCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">result</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(result.recreate()).thenReturn(response);

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    Object ret = StubInvocationUtil.unaryCall(invoker, method, request);

    Assertions.assertEquals(response, ret);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConsumerModel <span class="hljs-title">createMockConsumerModel</span><span class="hljs-params">(ServiceDescriptor serviceDescriptor)</span> </span>{
    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
    <span class="hljs-keyword">return</span> consumerModel;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest722">Test Case ID #dubbo_Test_72_2</h4>
<h4 id="test-case-name-unarycall2file-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>unaryCall2</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-consumermodel">Mock Object Variable Name: <code>consumerModel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker.class);
    URL url = Mockito.mock(URL.class);
<span class="hljs-deletion">-    ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);</span>
    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
<span class="hljs-addition">+    ConsumerModel consumerModel = createMockConsumerModel(serviceDescriptor);</span>
    when(url.getServiceModel()).thenReturn(consumerModel);
    when(url.getServiceInterface()).thenReturn(IGreeter.class.getName());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unaryCall2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenThrow</span>(<span class="hljs-title">new</span> <span class="hljs-title">RuntimeException</span>("<span class="hljs-title">a</span>")).<span class="hljs-title">thenThrow</span>(<span class="hljs-title">new</span> <span class="hljs-title">Error</span>("<span class="hljs-title">b</span>"))</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(result.recreate()).thenReturn(response);

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    <span class="hljs-keyword">try</span> {

        StubInvocationUtil.unaryCall(invoker, method, request);

        fail();

    } <span class="hljs-keyword">catch</span> (Throwable t) {

        <span class="hljs-comment">// pass</span>

    }

    <span class="hljs-keyword">try</span> {

        StubInvocationUtil.unaryCall(invoker, method, request);

        fail();

    } <span class="hljs-keyword">catch</span> (Throwable t) {

        <span class="hljs-comment">// pass</span>

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConsumerModel <span class="hljs-title">createMockConsumerModel</span><span class="hljs-params">(ServiceDescriptor serviceDescriptor)</span> </span>{
    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
    <span class="hljs-keyword">return</span> consumerModel;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest723">Test Case ID #dubbo_Test_72_3</h4>
<h4 id="test-case-name-testunarycallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>testUnaryCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-consumermodel">Mock Object Variable Name: <code>consumerModel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    URL url = Mockito.mock(URL.class);
<span class="hljs-deletion">-    ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);</span>
<span class="hljs-deletion">-    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);</span>
<span class="hljs-deletion">-    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);</span>
<span class="hljs-addition">+    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);</span>
<span class="hljs-addition">+    ConsumerModel consumerModel = createMockConsumerModel(serviceDescriptor);</span>
    when(url.getServiceModel()).thenReturn(consumerModel);
    when(url.getServiceInterface()).thenReturn(IGreeter.class.getName());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testUnaryCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">then</span>(<span class="hljs-title">invocationOnMock</span> -&gt; <span class="hljs-title">result</span>)</span>;

    when(result.recreate()).thenReturn(response);

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    AtomicReference&lt;Object&gt; atomicReference = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    StreamObserver&lt;Object&gt; responseObserver = <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

            atomicReference.set(data);

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

            latch.countDown();

        }

    };

    StubInvocationUtil.unaryCall(invoker, method, request, responseObserver);

    latch.await(<span class="hljs-number">1</span>, TimeUnit.SECONDS);

    Assertions.assertEquals(response, atomicReference.get());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConsumerModel <span class="hljs-title">createMockConsumerModel</span><span class="hljs-params">(ServiceDescriptor serviceDescriptor)</span> </span>{
    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
    <span class="hljs-keyword">return</span> consumerModel;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest724">Test Case ID #dubbo_Test_72_4</h4>
<h4 id="test-case-name-biorclientstreamcallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>biOrClientStreamCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-consumermodel">Mock Object Variable Name: <code>consumerModel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker.class);
    URL url = Mockito.mock(URL.class);
<span class="hljs-deletion">-    ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);</span>
    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
<span class="hljs-addition">+    ConsumerModel consumerModel = createMockConsumerModel(serviceDescriptor);</span>
    when(url.getServiceModel()).thenReturn(consumerModel);
    when(url.getServiceInterface()).thenReturn(IGreeter.class.getName());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">biOrClientStreamCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">then</span>(<span class="hljs-title">invocationOnMock</span> -&gt; </span>{

        Invocation invocation = (Invocation) invocationOnMock.getArguments()[<span class="hljs-number">0</span>];

        StreamObserver&lt;Object&gt; observer = (StreamObserver&lt;Object&gt;) invocation.getArguments()[<span class="hljs-number">0</span>];

        observer.onNext(response);

        observer.onCompleted();

        when(result.recreate()).then(invocationOnMock1 -&gt; <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



            <span class="hljs-meta">@Override</span>

            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

                observer.onNext(data);

            }



            <span class="hljs-meta">@Override</span>

            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

            }



            <span class="hljs-meta">@Override</span>

            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

                observer.onCompleted();

            }

        });

        <span class="hljs-keyword">return</span> result;

    });

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">11</span>);

    StreamObserver&lt;Object&gt; responseObserver = <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

            latch.countDown();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

            latch.countDown();

        }

    };

    StreamObserver&lt;Object&gt; observer = StubInvocationUtil.biOrClientStreamCall(invoker, method, responseObserver);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {

        observer.onNext(request);

    }

    observer.onCompleted();

    Assertions.assertTrue(latch.await(<span class="hljs-number">1</span>, TimeUnit.SECONDS));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConsumerModel <span class="hljs-title">createMockConsumerModel</span><span class="hljs-params">(ServiceDescriptor serviceDescriptor)</span> </span>{
    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
    <span class="hljs-keyword">return</span> consumerModel;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest725">Test Case ID #dubbo_Test_72_5</h4>
<h4 id="test-case-name-serverstreamcallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>serverStreamCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-consumermodel">Mock Object Variable Name: <code>consumerModel</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker.class);
    URL url = Mockito.mock(URL.class);
<span class="hljs-deletion">-    ConsumerModel consumerModel = Mockito.mock(ConsumerModel.class);</span>
    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor.class);
<span class="hljs-addition">+    ConsumerModel consumerModel = createMockConsumerModel(serviceDescriptor);</span>
    when(url.getServiceModel()).thenReturn(consumerModel);
    when(url.getServiceInterface()).thenReturn(IGreeter.class.getName());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">serverStreamCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">then</span>(<span class="hljs-title">invocationOnMock</span> -&gt; </span>{

        Invocation invocation = (Invocation) invocationOnMock.getArguments()[<span class="hljs-number">0</span>];

        StreamObserver&lt;Object&gt; observer = (StreamObserver&lt;Object&gt;) invocation.getArguments()[<span class="hljs-number">1</span>];

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {

            observer.onNext(response);

        }

        observer.onCompleted();

        <span class="hljs-keyword">return</span> result;

    });

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">11</span>);

    StreamObserver&lt;Object&gt; responseObserver = <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

            latch.countDown();

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

            latch.countDown();

        }

    };

    StubInvocationUtil.serverStreamCall(invoker, method, request, responseObserver);

    Assertions.assertTrue(latch.await(<span class="hljs-number">1</span>, TimeUnit.SECONDS));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ConsumerModel <span class="hljs-title">createMockConsumerModel</span><span class="hljs-params">(ServiceDescriptor serviceDescriptor)</span> </span>{
    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);
    <span class="hljs-keyword">return</span> consumerModel;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci73">Mock Clone Instance #dubbo_MCI_73</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.Result</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Result <span class="hljs-title">createMockResult</span><span class="hljs-params">(String recreateReturn)</span> </span>{
    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(result.recreate()).thenReturn(recreateReturn);
    <span class="hljs-keyword">return</span> result;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest731">Test Case ID #dubbo_Test_73_1</h4>
<h4 id="test-case-name-unarycallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>unaryCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-result">Mock Object Variable Name: <code>result</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(invoker.getInterface()).thenReturn(IGreeter.class);
<span class="hljs-deletion">-    Result result = Mockito.mock(Result.class);</span>
<span class="hljs-deletion">-    when(invoker.invoke(any(Invocation.class))).thenReturn(result);</span>
    String response = "response";
<span class="hljs-addition">+    Result result = createMockResult(response);</span>
<span class="hljs-addition">+    when(invoker.invoke(any(Invocation.class))).thenReturn(result);</span>
    MethodDescriptor method = Mockito.mock(MethodDescriptor.class);
    when(method.getParameterClasses()).thenReturn(new Class[] { String.class });
    when(method.getMethodName()).thenReturn("sayHello");
    String request = "request";
    Object ret = StubInvocationUtil.unaryCall(invoker, method, request);
    Assertions.assertEquals(response, ret);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unaryCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">result</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(result.recreate()).thenReturn(response);

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    Object ret = StubInvocationUtil.unaryCall(invoker, method, request);

    Assertions.assertEquals(response, ret);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Result <span class="hljs-title">createMockResult</span><span class="hljs-params">(String recreateReturn)</span> </span>{
    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(result.recreate()).thenReturn(recreateReturn);
    <span class="hljs-keyword">return</span> result;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest732">Test Case ID #dubbo_Test_73_2</h4>
<h4 id="test-case-name-unarycall2file-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>unaryCall2</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-result">Mock Object Variable Name: <code>result</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(invoker.getInterface()).thenReturn(IGreeter.class);
<span class="hljs-deletion">-    Result result = Mockito.mock(Result.class);</span>
<span class="hljs-deletion">-    when(invoker.invoke(any(Invocation.class))).thenThrow(new RuntimeException("a")).thenThrow(new Error("b"));</span>
    String response = "response";
<span class="hljs-deletion">-    when(result.recreate()).thenReturn(response);</span>
<span class="hljs-addition">+    Result result = createMockResult(response);</span>
    MethodDescriptor method = Mockito.mock(MethodDescriptor.class);
    when(method.getParameterClasses()).thenReturn(new Class[] { String.class });
    when(method.getMethodName()).thenReturn("sayHello");
    String request = "request";
    try {
        StubInvocationUtil.unaryCall(invoker, method, request);
        fail();
    } catch (Throwable t) {
        // pass
    }
    try {
        StubInvocationUtil.unaryCall(invoker, method, request);
        fail();
    } catch (Throwable t) {
        // pass
    }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">unaryCall2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenThrow</span>(<span class="hljs-title">new</span> <span class="hljs-title">RuntimeException</span>("<span class="hljs-title">a</span>")).<span class="hljs-title">thenThrow</span>(<span class="hljs-title">new</span> <span class="hljs-title">Error</span>("<span class="hljs-title">b</span>"))</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(result.recreate()).thenReturn(response);

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    <span class="hljs-keyword">try</span> {

        StubInvocationUtil.unaryCall(invoker, method, request);

        fail();

    } <span class="hljs-keyword">catch</span> (Throwable t) {

        <span class="hljs-comment">// pass</span>

    }

    <span class="hljs-keyword">try</span> {

        StubInvocationUtil.unaryCall(invoker, method, request);

        fail();

    } <span class="hljs-keyword">catch</span> (Throwable t) {

        <span class="hljs-comment">// pass</span>

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Result <span class="hljs-title">createMockResult</span><span class="hljs-params">(String recreateReturn)</span> </span>{
    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(result.recreate()).thenReturn(recreateReturn);
    <span class="hljs-keyword">return</span> result;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest733">Test Case ID #dubbo_Test_73_3</h4>
<h4 id="test-case-name-testunarycallfile-cjavaprojectsapachedubbodubbo-rpcdubbo-rpc-triplesrctestjavaorgapachedubborpcstubstubinvocationutiltestjava">Test Case Name: <code>testUnaryCall</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-rpc\dubbo-rpc-triple\src\test\java\org\apache\dubbo\rpc\stub\StubInvocationUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-result">Mock Object Variable Name: <code>result</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(invoker.getInterface()).thenReturn(IGreeter.class);
<span class="hljs-deletion">-    Result result = Mockito.mock(Result.class);</span>
    String response = "response";
    when(invoker.invoke(any(Invocation.class))).then(invocationOnMock -&gt; result);
<span class="hljs-deletion">-    when(result.recreate()).thenReturn(response);</span>
<span class="hljs-addition">+    Result result = createMockResult(response);</span>
    MethodDescriptor method = Mockito.mock(MethodDescriptor.class);
    when(method.getParameterClasses()).thenReturn(new Class[] { String.class });
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testUnaryCall</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>{

    Invoker&lt;IGreeter&gt; invoker = Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConsumerModel consumerModel = Mockito.mock(ConsumerModel<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServiceDescriptor serviceDescriptor = Mockito.mock(ServiceDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(consumerModel.getServiceModel()).thenReturn(serviceDescriptor);

    when(url.getServiceModel()).thenReturn(consumerModel);

    when(url.getServiceInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(url.getProtocolServiceKey()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    when(invoker.getUrl()).thenReturn(url);

    when(invoker.getInterface()).thenReturn(IGreeter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    String response = <span class="hljs-string">"response"</span>;

    when(invoker.invoke(any(Invocation<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">then</span>(<span class="hljs-title">invocationOnMock</span> -&gt; <span class="hljs-title">result</span>)</span>;

    when(result.recreate()).thenReturn(response);

    MethodDescriptor method = Mockito.mock(MethodDescriptor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(method.getParameterClasses()).thenReturn(<span class="hljs-keyword">new</span> Class[] { String<span class="hljs-class">.<span class="hljs-keyword">class</span> })</span>;

    when(method.getMethodName()).thenReturn(<span class="hljs-string">"sayHello"</span>);

    String request = <span class="hljs-string">"request"</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    AtomicReference&lt;Object&gt; atomicReference = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;();

    StreamObserver&lt;Object&gt; responseObserver = <span class="hljs-keyword">new</span> StreamObserver&lt;Object&gt;() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onNext</span><span class="hljs-params">(Object data)</span> </span>{

            atomicReference.set(data);

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onError</span><span class="hljs-params">(Throwable throwable)</span> </span>{

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCompleted</span><span class="hljs-params">()</span> </span>{

            latch.countDown();

        }

    };

    StubInvocationUtil.unaryCall(invoker, method, request, responseObserver);

    latch.await(<span class="hljs-number">1</span>, TimeUnit.SECONDS);

    Assertions.assertEquals(response, atomicReference.get());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Result <span class="hljs-title">createMockResult</span><span class="hljs-params">(String recreateReturn)</span> </span>{
    Result result = Mockito.mock(Result<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(result.recreate()).thenReturn(recreateReturn);
    <span class="hljs-keyword">return</span> result;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci74">Mock Clone Instance #dubbo_MCI_74</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.config.spring.status.SpringStatusCheckerTest.ApplicationLifeCycle</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApplicationLifeCycle <span class="hljs-title">createMockApplicationLifeCycle</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isRunningReturn)</span> </span>{
    ApplicationLifeCycle applicationLifeCycle = mock(ApplicationLifeCycle<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(applicationLifeCycle.isRunning()).willReturn(isRunningReturn);
    <span class="hljs-keyword">return</span> applicationLifeCycle;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest741">Test Case ID #dubbo_Test_74_1</h4>
<h4 id="test-case-name-testwithlifecyclerunningfile-cjavaprojectsapachedubbodubbo-configdubbo-config-springsrctestjavaorgapachedubboconfigspringstatusspringstatuscheckertestjava">Test Case Name: <code>testWithLifeCycleRunning</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-config\dubbo-config-spring\src\test\java\org\apache\dubbo\config\spring\status\SpringStatusCheckerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-applicationlifecycle">Mock Object Variable Name: <code>applicationLifeCycle</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
void testWithLifeCycleRunning() {
<span class="hljs-deletion">-    ApplicationLifeCycle applicationLifeCycle = mock(ApplicationLifeCycle.class);</span>
<span class="hljs-deletion">-    given(applicationLifeCycle.getConfigLocations()).willReturn(new String[] { "test1", "test2" });</span>
<span class="hljs-deletion">-    given(applicationLifeCycle.isRunning()).willReturn(true);</span>
<span class="hljs-addition">+    ApplicationLifeCycle applicationLifeCycle = createMockApplicationLifeCycle(true);</span>
<span class="hljs-addition">+    given(applicationLifeCycle.getConfigLocations()).willReturn(new String[] { "test1", "test2" });</span>
    SpringStatusChecker springStatusChecker = new SpringStatusChecker(applicationLifeCycle);
    Status status = springStatusChecker.check();
    assertThat(status.getLevel(), is(Status.Level.OK));
    assertThat(status.getMessage(), is("test1,test2"));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testWithLifeCycleRunning</span><span class="hljs-params">()</span> </span>{

    ApplicationLifeCycle applicationLifeCycle = mock(ApplicationLifeCycle<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(applicationLifeCycle.getConfigLocations()).willReturn(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"test1"</span>, <span class="hljs-string">"test2"</span> });

    given(applicationLifeCycle.isRunning()).willReturn(<span class="hljs-keyword">true</span>);

    SpringStatusChecker springStatusChecker = <span class="hljs-keyword">new</span> SpringStatusChecker(applicationLifeCycle);

    Status status = springStatusChecker.check();

    assertThat(status.getLevel(), is(Status.Level.OK));

    assertThat(status.getMessage(), is(<span class="hljs-string">"test1,test2"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApplicationLifeCycle <span class="hljs-title">createMockApplicationLifeCycle</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isRunningReturn)</span> </span>{
    ApplicationLifeCycle applicationLifeCycle = mock(ApplicationLifeCycle<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(applicationLifeCycle.isRunning()).willReturn(isRunningReturn);
    <span class="hljs-keyword">return</span> applicationLifeCycle;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest742">Test Case ID #dubbo_Test_74_2</h4>
<h4 id="test-case-name-testwithoutlifecyclerunningfile-cjavaprojectsapachedubbodubbo-configdubbo-config-springsrctestjavaorgapachedubboconfigspringstatusspringstatuscheckertestjava">Test Case Name: <code>testWithoutLifeCycleRunning</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-config\dubbo-config-spring\src\test\java\org\apache\dubbo\config\spring\status\SpringStatusCheckerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-applicationlifecycle">Mock Object Variable Name: <code>applicationLifeCycle</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 void testWithoutLifeCycleRunning() {
<span class="hljs-deletion">-    ApplicationLifeCycle applicationLifeCycle = mock(ApplicationLifeCycle.class);</span>
<span class="hljs-deletion">-    given(applicationLifeCycle.isRunning()).willReturn(false);</span>
<span class="hljs-addition">+    ApplicationLifeCycle applicationLifeCycle = createMockApplicationLifeCycle(false);</span>
     SpringStatusChecker springStatusChecker = new SpringStatusChecker(applicationLifeCycle);
     Status status = springStatusChecker.check();
     assertThat(status.getLevel(), is(Status.Level.ERROR));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testWithoutLifeCycleRunning</span><span class="hljs-params">()</span> </span>{

    ApplicationLifeCycle applicationLifeCycle = mock(ApplicationLifeCycle<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(applicationLifeCycle.isRunning()).willReturn(<span class="hljs-keyword">false</span>);

    SpringStatusChecker springStatusChecker = <span class="hljs-keyword">new</span> SpringStatusChecker(applicationLifeCycle);

    Status status = springStatusChecker.check();

    assertThat(status.getLevel(), is(Status.Level.ERROR));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApplicationLifeCycle <span class="hljs-title">createMockApplicationLifeCycle</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isRunningReturn)</span> </span>{
    ApplicationLifeCycle applicationLifeCycle = mock(ApplicationLifeCycle<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(applicationLifeCycle.isRunning()).willReturn(isRunningReturn);
    <span class="hljs-keyword">return</span> applicationLifeCycle;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci75">Mock Clone Instance #dubbo_MCI_75</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.registry.RegistryFactory</code></li>
<li><strong>Test Case Count</strong>: 5</li>
<li><strong>MO Count</strong>: 5</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RegistryFactory <span class="hljs-title">createMockRegistryFactory</span><span class="hljs-params">(URL url, Registry registry, RegistryProtocol registryProtocol)</span> </span>{
    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);
    <span class="hljs-keyword">return</span> registryFactory;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest751">Test Case ID #dubbo_Test_75_1</h4>
<h4 id="test-case-name-testconsumerurlwithoutprotocolfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testConsumerUrlWithoutProtocol</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-registryfactory">Mock Object Variable Name: <code>registryFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    url = url.setScopeModel(moduleModel);
<span class="hljs-deletion">-    RegistryFactory registryFactory = mock(RegistryFactory.class);</span>
<span class="hljs-deletion">-    Registry registry = mock(Registry.class);</span>
<span class="hljs-deletion">-    RegistryProtocol registryProtocol = new RegistryProtocol();</span>
<span class="hljs-deletion">-    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener.class);</span>
<span class="hljs-deletion">-    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = new ArrayList&lt;&gt;();</span>
<span class="hljs-deletion">-    registryProtocolListeners.add(migrationRuleListener);</span>
<span class="hljs-deletion">-    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());</span>
<span class="hljs-deletion">-    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(new ApplicationConfig("application1"));</span>
<span class="hljs-deletion">-    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader.class);</span>
<span class="hljs-deletion">-    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener.class)).thenReturn(extensionLoaderMock);</span>
<span class="hljs-deletion">-    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);</span>
<span class="hljs-deletion">-    url = url.setScopeModel(moduleModel);</span>
<span class="hljs-deletion">-    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);</span>
<span class="hljs-addition">+    Registry registry = mock(Registry.class);</span>
<span class="hljs-addition">+    RegistryProtocol registryProtocol = new RegistryProtocol();</span>
<span class="hljs-addition">+    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener.class);</span>
<span class="hljs-addition">+    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = new ArrayList&lt;&gt;();</span>
<span class="hljs-addition">+    registryProtocolListeners.add(migrationRuleListener);</span>
<span class="hljs-addition">+    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());</span>
<span class="hljs-addition">+    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(new ApplicationConfig("application1"));</span>
<span class="hljs-addition">+    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader.class);</span>
<span class="hljs-addition">+    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener.class)).thenReturn(extensionLoaderMock);</span>
<span class="hljs-addition">+    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);</span>
<span class="hljs-addition">+    url = url.setScopeModel(moduleModel);</span>
<span class="hljs-addition">+    RegistryFactory registryFactory = createMockRegistryFactory(url, registry, registryProtocol);</span>
    Cluster cluster = mock(Cluster.class);
    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService.class, url, parameters);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify the generated consumer url information

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumerUrlWithoutProtocol</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    <span class="hljs-comment">// verify that the protocol header of consumerUrl is set to "consumer"</span>

    Assertions.assertEquals(<span class="hljs-string">"consumer"</span>, consumerUrl.getProtocol());

    Assertions.assertEquals(parameters.get(REGISTER_IP_KEY), consumerUrl.getHost());

    Assertions.assertFalse(consumerUrl.getAttributes().containsKey(REFER_KEY));

    Assertions.assertEquals(<span class="hljs-string">"value1"</span>, consumerUrl.getAttribute(<span class="hljs-string">"key1"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RegistryFactory <span class="hljs-title">createMockRegistryFactory</span><span class="hljs-params">(URL url, Registry registry, RegistryProtocol registryProtocol)</span> </span>{
    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);
    <span class="hljs-keyword">return</span> registryFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest752">Test Case ID #dubbo_Test_75_2</h4>
<h4 id="test-case-name-testconsumerurlwithprotocolfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testConsumerUrlWithProtocol</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-registryfactory">Mock Object Variable Name: <code>registryFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    URL url = serviceConfigURL.addAttributes(attributes);
<span class="hljs-deletion">-    RegistryFactory registryFactory = mock(RegistryFactory.class);</span>
    RegistryProtocol registryProtocol = new RegistryProtocol();
    Registry registry = mock(Registry.class);
    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener.class);
    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = new ArrayList&lt;&gt;();
    registryProtocolListeners.add(migrationRuleListener);
    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());
    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(new ApplicationConfig("application1"));
    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader.class);
    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener.class)).thenReturn(extensionLoaderMock);
    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);
    url = url.setScopeModel(moduleModel);
<span class="hljs-addition">+    RegistryFactory registryFactory = createMockRegistryFactory(url, registry, registryProtocol);</span>
<span class="hljs-deletion">-    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);</span>
    Cluster cluster = mock(Cluster.class);
    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService.class, url, parameters);
    Assertions.assertTrue(invoker instanceof MigrationInvoker);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that when the protocol is configured, the protocol of consumer url is the configured protocol

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testConsumerUrlWithProtocol</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    parameters.put(PROTOCOL_KEY, <span class="hljs-string">"tri"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader&lt;RegistryProtocolListener&gt; extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    <span class="hljs-comment">// verify that the protocol of consumer url</span>

    Assertions.assertEquals(<span class="hljs-string">"tri"</span>, consumerUrl.getProtocol());

    Assertions.assertEquals(parameters.get(REGISTER_IP_KEY), consumerUrl.getHost());

    Assertions.assertFalse(consumerUrl.getAttributes().containsKey(REFER_KEY));

    Assertions.assertEquals(<span class="hljs-string">"value1"</span>, consumerUrl.getAttribute(<span class="hljs-string">"key1"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RegistryFactory <span class="hljs-title">createMockRegistryFactory</span><span class="hljs-params">(URL url, Registry registry, RegistryProtocol registryProtocol)</span> </span>{
    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);
    <span class="hljs-keyword">return</span> registryFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest753">Test Case ID #dubbo_Test_75_3</h4>
<h4 id="test-case-name-testreferwithoutgroupfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testReferWithoutGroup</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-registryfactory">Mock Object Variable Name: <code>registryFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    url = url.setScopeModel(moduleModel);
<span class="hljs-deletion">-    RegistryFactory registryFactory = mock(RegistryFactory.class);</span>
    Registry registry = mock(Registry.class);
    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener.class);
    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = new ArrayList&lt;&gt;();
    registryProtocolListeners.add(migrationRuleListener);
    RegistryProtocol registryProtocol = new RegistryProtocol();
    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());
    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(new ApplicationConfig("application1"));
    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader.class);
    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener.class)).thenReturn(extensionLoaderMock);
    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);
    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory.class)).thenReturn(extensionLoaderMock);
    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);
    url = url.setScopeModel(moduleModel);
<span class="hljs-deletion">-    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);</span>
<span class="hljs-addition">+    RegistryFactory registryFactory = createMockRegistryFactory(url, registry, registryProtocol);</span>
    Invoker&lt;?&gt; invoker = registryProtocol.refer(DemoService.class, url);
    Assertions.assertTrue(invoker instanceof MigrationInvoker);
    Assertions.assertTrue(((MigrationInvoker&lt;?&gt;) invoker).getCluster() instanceof ScopeClusterWrapper);
    Assertions.assertTrue(((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster() instanceof MockClusterWrapper);
    Assertions.assertTrue(((MockClusterWrapper) ((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster()).getCluster() instanceof FailoverCluster);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that if multiple groups are not configured, the service reference of the registration center

 * the default is FailoverCluster

 *

 * <span class="hljs-doctag">@see</span> FailoverCluster

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testReferWithoutGroup</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Invoker&lt;?&gt; invoker = registryProtocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    Assertions.assertTrue(((MigrationInvoker&lt;?&gt;) invoker).getCluster() <span class="hljs-keyword">instanceof</span> ScopeClusterWrapper);

    Assertions.assertTrue(((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> MockClusterWrapper);

    Assertions.assertTrue(((MockClusterWrapper) ((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> FailoverCluster);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RegistryFactory <span class="hljs-title">createMockRegistryFactory</span><span class="hljs-params">(URL url, Registry registry, RegistryProtocol registryProtocol)</span> </span>{
    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);
    <span class="hljs-keyword">return</span> registryFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest754">Test Case ID #dubbo_Test_75_4</h4>
<h4 id="test-case-name-testreferwithgroupfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testReferWithGroup</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-registryfactory">Mock Object Variable Name: <code>registryFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    url = url.setScopeModel(moduleModel);
<span class="hljs-deletion">-    RegistryFactory registryFactory = mock(RegistryFactory.class);</span>
<span class="hljs-deletion">-    Registry registry = mock(Registry.class);</span>
<span class="hljs-addition">+    Registry registry = mock(Registry.class);</span>
    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener.class);
    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = new ArrayList&lt;&gt;();
    registryProtocolListeners.add(migrationRuleListener);
    RegistryProtocol registryProtocol = new RegistryProtocol();
    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());
    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(new ApplicationConfig("application1"));
    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader.class);
    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener.class)).thenReturn(extensionLoaderMock);
    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);
    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory.class)).thenReturn(extensionLoaderMock);
    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);
    url = url.setScopeModel(moduleModel);
<span class="hljs-addition">+    RegistryFactory registryFactory = createMockRegistryFactory(url, registry, registryProtocol);</span>
<span class="hljs-deletion">-    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);</span>
    Invoker&lt;?&gt; invoker = registryProtocol.refer(DemoService.class, url);
    Assertions.assertTrue(invoker instanceof MigrationInvoker);
    Assertions.assertTrue(((MigrationInvoker&lt;?&gt;) invoker).getCluster() instanceof ScopeClusterWrapper);
    Assertions.assertTrue(((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster() instanceof MockClusterWrapper);
    Assertions.assertTrue(((MockClusterWrapper) ((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster()).getCluster() instanceof MergeableCluster);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify that if multiple groups are configured, the service reference of the registration center

 *

 * <span class="hljs-doctag">@see</span> MergeableCluster

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testReferWithGroup</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"false"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    refer.put(GROUP_KEY, <span class="hljs-string">"group1,group2"</span>);

    attributes.put(REFER_KEY, refer);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRuleListener migrationRuleListener = mock(MigrationRuleListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;RegistryProtocolListener&gt; registryProtocolListeners = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    registryProtocolListeners.add(migrationRuleListener);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryProtocolListener<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getActivateExtension(url, REGISTRY_PROTOCOL_LISTENER_KEY)).thenReturn(registryProtocolListeners);

    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);

    url = url.setScopeModel(moduleModel);

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Invoker&lt;?&gt; invoker = registryProtocol.refer(DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    Assertions.assertTrue(((MigrationInvoker&lt;?&gt;) invoker).getCluster() <span class="hljs-keyword">instanceof</span> ScopeClusterWrapper);

    Assertions.assertTrue(((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> MockClusterWrapper);

    Assertions.assertTrue(((MockClusterWrapper) ((ScopeClusterWrapper) ((MigrationInvoker&lt;?&gt;) invoker).getCluster()).getCluster()).getCluster() <span class="hljs-keyword">instanceof</span> MergeableCluster);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RegistryFactory <span class="hljs-title">createMockRegistryFactory</span><span class="hljs-params">(URL url, Registry registry, RegistryProtocol registryProtocol)</span> </span>{
    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);
    <span class="hljs-keyword">return</span> registryFactory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest755">Test Case ID #dubbo_Test_75_5</h4>
<h4 id="test-case-name-testregisterconsumerurlfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryintegrationregistryprotocoltestjava">Test Case Name: <code>testRegisterConsumerUrl</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\integration\RegistryProtocolTest.java</code>)</h4>
<h4 id="mock-object-variable-name-registryfactory">Mock Object Variable Name: <code>registryFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    URL url = serviceConfigURL.addAttributes(attributes);
<span class="hljs-deletion">-    RegistryFactory registryFactory = mock(RegistryFactory.class);</span>
    Registry registry = mock(Registry.class);
    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());
    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(new ApplicationConfig("application1"));
    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader.class);
    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory.class)).thenReturn(extensionLoaderMock);
    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);
    url = url.setScopeModel(moduleModel);
    RegistryProtocol registryProtocol = new RegistryProtocol();
<span class="hljs-deletion">-    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);</span>
<span class="hljs-addition">+    RegistryFactory registryFactory = createMockRegistryFactory(url, registry, registryProtocol);</span>
    Cluster cluster = mock(Cluster.class);
    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService.class, url, parameters);
    Assertions.assertTrue(invoker instanceof MigrationInvoker);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * verify the registered consumer url

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testRegisterConsumerUrl</span><span class="hljs-params">()</span> </span>{

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"application1"</span>);

    ConfigManager configManager = mock(ConfigManager<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(configManager.getApplicationOrElseThrow()).thenReturn(applicationConfig);

    CompositeConfiguration compositeConfiguration = mock(CompositeConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(compositeConfiguration.convert(Boolean<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">ENABLE_CONFIGURATION_LISTEN</span>, <span class="hljs-title">true</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    Map&lt;String, String&gt; parameters = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    parameters.put(INTERFACE_KEY, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>())</span>;

    parameters.put(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"zookeeper"</span>);

    parameters.put(<span class="hljs-string">"register"</span>, <span class="hljs-string">"true"</span>);

    parameters.put(REGISTER_IP_KEY, <span class="hljs-string">"172.23.236.180"</span>);

    Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    ServiceConfigURL serviceConfigURL = <span class="hljs-keyword">new</span> ServiceConfigURL(<span class="hljs-string">"registry"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">2181</span>, <span class="hljs-string">"org.apache.dubbo.registry.RegistryService"</span>, parameters);

    Map&lt;String, String&gt; refer = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    attributes.put(REFER_KEY, refer);

    attributes.put(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);

    URL url = serviceConfigURL.addAttributes(attributes);

    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Registry registry = mock(Registry<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ModuleModel moduleModel = Mockito.spy(ApplicationModel.defaultModel().getDefaultModule());

    moduleModel.getApplicationModel().getApplicationConfigManager().setApplication(<span class="hljs-keyword">new</span> ApplicationConfig(<span class="hljs-string">"application1"</span>));

    ExtensionLoader extensionLoaderMock = mock(ExtensionLoader<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(moduleModel.getExtensionLoader(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">extensionLoaderMock</span>)</span>;

    Mockito.when(extensionLoaderMock.getAdaptiveExtension()).thenReturn(registryFactory);

    url = url.setScopeModel(moduleModel);

    RegistryProtocol registryProtocol = <span class="hljs-keyword">new</span> RegistryProtocol();

    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);

    Cluster cluster = mock(Cluster<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Invoker&lt;?&gt; invoker = registryProtocol.doRefer(cluster, registry, DemoService<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">url</span>, <span class="hljs-title">parameters</span>)</span>;

    Assertions.assertTrue(invoker <span class="hljs-keyword">instanceof</span> MigrationInvoker);

    URL consumerUrl = ((MigrationInvoker&lt;?&gt;) invoker).getConsumerUrl();

    Assertions.assertTrue((consumerUrl != <span class="hljs-keyword">null</span>));

    Map&lt;String, String&gt; urlParameters = consumerUrl.getParameters();

    URL urlToRegistry = <span class="hljs-keyword">new</span> ServiceConfigURL(urlParameters.get(PROTOCOL_KEY) == <span class="hljs-keyword">null</span> ? CONSUMER : urlParameters.get(PROTOCOL_KEY), urlParameters.remove(REGISTER_IP_KEY), <span class="hljs-number">0</span>, consumerUrl.getPath(), urlParameters);

    URL registeredConsumerUrl = urlToRegistry.addParameters(CATEGORY_KEY, CONSUMERS_CATEGORY, CHECK_KEY, String.valueOf(<span class="hljs-keyword">false</span>)).setScopeModel(moduleModel);

    verify(registry, times(<span class="hljs-number">1</span>)).register(registeredConsumerUrl);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> RegistryFactory <span class="hljs-title">createMockRegistryFactory</span><span class="hljs-params">(URL url, Registry registry, RegistryProtocol registryProtocol)</span> </span>{
    RegistryFactory registryFactory = mock(RegistryFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(registryFactory.getRegistry(registryProtocol.getRegistryUrl(url))).thenReturn(registry);
    <span class="hljs-keyword">return</span> registryFactory;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci76">Mock Clone Instance #dubbo_MCI_76</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.cluster.Directory&lt;org.apache.dubbo.rpc.cluster.support.FailbackClusterInvokerTest&gt;</code></li>
<li><strong>Test Case Count</strong>: 7</li>
<li><strong>MO Count</strong>: 7</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Directory&lt;FailbackClusterInvokerTest&gt; <span class="hljs-title">createMockDirectory</span><span class="hljs-params">(URL url)</span> </span>{
    Directory&lt;FailbackClusterInvokerTest&gt; dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(dic.getUrl()).willReturn(url);
    given(dic.getConsumerUrl()).willReturn(url);
    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> dic;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest761">Test Case ID #dubbo_Test_76_1</h4>
<h4 id="test-case-name-testinvokewithillegalretriesparamfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportfailbackclusterinvokertestjava">Test Case Name: <code>testInvokeWithIllegalRetriesParam</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\FailbackClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-dic">Mock Object Variable Name: <code>dic</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    URL url = URL.valueOf("test://test:11/test?retries=-1&amp;failbacktasks=2");
<span class="hljs-deletion">-    Directory&lt;FailbackClusterInvokerTest&gt; dic = mock(Directory.class);</span>
<span class="hljs-deletion">-    given(dic.getUrl()).willReturn(url);</span>
<span class="hljs-deletion">-    given(dic.getConsumerUrl()).willReturn(url);</span>
<span class="hljs-deletion">-    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest.class);</span>
<span class="hljs-addition">+    Directory&lt;FailbackClusterInvokerTest&gt; dic = createMockDirectory(url);</span>
    FailbackClusterInvoker&lt;FailbackClusterInvokerTest&gt; invoker = new FailbackClusterInvoker&lt;&gt;(dic);
    invoker.invoke(invocation);
    Assertions.assertNull(RpcContext.getServiceContext().getInvoker());
    DubboAppender.clear();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokeWithIllegalRetriesParam</span><span class="hljs-params">()</span> </span>{

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?retries=-1&amp;failbacktasks=2"</span>);

    Directory&lt;FailbackClusterInvokerTest&gt; dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(dic.getUrl()).willReturn(url);

    given(dic.getConsumerUrl()).willReturn(url);

    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    FailbackClusterInvoker&lt;FailbackClusterInvokerTest&gt; invoker = <span class="hljs-keyword">new</span> FailbackClusterInvoker&lt;&gt;(dic);

    invoker.invoke(invocation);

    Assertions.assertNull(RpcContext.getServiceContext().getInvoker());

    DubboAppender.clear();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Directory&lt;FailbackClusterInvokerTest&gt; <span class="hljs-title">createMockDirectory</span><span class="hljs-params">(URL url)</span> </span>{
    Directory&lt;FailbackClusterInvokerTest&gt; dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(dic.getUrl()).willReturn(url);
    given(dic.getConsumerUrl()).willReturn(url);
    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> dic;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest762">Test Case ID #dubbo_Test_76_2</h4>
<h4 id="test-case-name-testinvokewithillegalfailbacktasksparamfile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportfailbackclusterinvokertestjava">Test Case Name: <code>testInvokeWithIllegalFailbacktasksParam</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\FailbackClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-dic">Mock Object Variable Name: <code>dic</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    URL url = URL.valueOf("test://test:11/test?retries=2&amp;failbacktasks=-1");
<span class="hljs-deletion">-    Directory&lt;FailbackClusterInvokerTest&gt; dic = mock(Directory.class);</span>
<span class="hljs-deletion">-    given(dic.getUrl()).willReturn(url);</span>
<span class="hljs-deletion">-    given(dic.getConsumerUrl()).willReturn(url);</span>
<span class="hljs-deletion">-    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest.class);</span>
<span class="hljs-addition">+    Directory&lt;FailbackClusterInvokerTest&gt; dic = createMockDirectory(url);</span>
    FailbackClusterInvoker&lt;FailbackClusterInvokerTest&gt; invoker = new FailbackClusterInvoker&lt;&gt;(dic);
    invoker.invoke(invocation);
    Assertions.assertNull(RpcContext.getServiceContext().getInvoker());
    DubboAppender.clear();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testInvokeWithIllegalFailbacktasksParam</span><span class="hljs-params">()</span> </span>{

    URL url = URL.valueOf(<span class="hljs-string">"test://test:11/test?retries=2&amp;failbacktasks=-1"</span>);

    Directory&lt;FailbackClusterInvokerTest&gt; dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(dic.getUrl()).willReturn(url);

    given(dic.getConsumerUrl()).willReturn(url);

    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    FailbackClusterInvoker&lt;FailbackClusterInvokerTest&gt; invoker = <span class="hljs-keyword">new</span> FailbackClusterInvoker&lt;&gt;(dic);

    invoker.invoke(invocation);

    Assertions.assertNull(RpcContext.getServiceContext().getInvoker());

    DubboAppender.clear();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Directory&lt;FailbackClusterInvokerTest&gt; <span class="hljs-title">createMockDirectory</span><span class="hljs-params">(URL url)</span> </span>{
    Directory&lt;FailbackClusterInvokerTest&gt; dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(dic.getUrl()).willReturn(url);
    given(dic.getConsumerUrl()).willReturn(url);
    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> dic;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest763">Test Case ID #dubbo_Test_76_3</h4>
<h4 id="test-case-name-testnoinvokefile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportfailbackclusterinvokertestjava">Test Case Name: <code>testNoInvoke</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\FailbackClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-dic">Mock Object Variable Name: <code>dic</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 @Order(3)
 public void testNoInvoke() {
<span class="hljs-deletion">-    dic = mock(Directory.class);</span>
<span class="hljs-deletion">-    given(dic.getUrl()).willReturn(url);</span>
<span class="hljs-deletion">-    given(dic.getConsumerUrl()).willReturn(url);</span>
<span class="hljs-deletion">-    given(dic.list(invocation)).willReturn(null);</span>
<span class="hljs-deletion">-    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest.class);</span>
<span class="hljs-addition">+    dic = createMockDirectory(url);</span>
<span class="hljs-addition">+    given(dic.list(invocation)).willReturn(null);</span>
     invocation.setMethodName("method1");
     invokers.add(invoker);
     resetInvokerToNoException();
     FailbackClusterInvoker&lt;FailbackClusterInvokerTest&gt; invoker = new FailbackClusterInvoker&lt;&gt;(dic);
     LogUtil.start();
     DubboAppender.clear();
     invoker.invoke(invocation);
     assertEquals(1, LogUtil.findMessage("Failback to invoke"));
     LogUtil.stop();
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">3</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNoInvoke</span><span class="hljs-params">()</span> </span>{

    dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(dic.getUrl()).willReturn(url);

    given(dic.getConsumerUrl()).willReturn(url);

    given(dic.list(invocation)).willReturn(<span class="hljs-keyword">null</span>);

    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation.setMethodName(<span class="hljs-string">"method1"</span>);

    invokers.add(invoker);

    resetInvokerToNoException();

    FailbackClusterInvoker&lt;FailbackClusterInvokerTest&gt; invoker = <span class="hljs-keyword">new</span> FailbackClusterInvoker&lt;&gt;(dic);

    LogUtil.start();

    DubboAppender.clear();

    invoker.invoke(invocation);

    assertEquals(<span class="hljs-number">1</span>, LogUtil.findMessage(<span class="hljs-string">"Failback to invoke"</span>));

    LogUtil.stop();

}
<span class="hljs-comment">/**

 * <span class="hljs-doctag">@throws</span> java.lang.Exception

 */</span>

<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(dic.getUrl()).willReturn(url);

    given(dic.getConsumerUrl()).willReturn(url);

    given(dic.list(invocation)).willReturn(invokers);

    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation.setMethodName(<span class="hljs-string">"method1"</span>);

    invokers.add(invoker);

}
<span class="hljs-meta">@AfterEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span> </span>{

    dic = <span class="hljs-keyword">null</span>;

    invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    invokers.clear();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Directory&lt;FailbackClusterInvokerTest&gt; <span class="hljs-title">createMockDirectory</span><span class="hljs-params">(URL url)</span> </span>{
    Directory&lt;FailbackClusterInvokerTest&gt; dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(dic.getUrl()).willReturn(url);
    given(dic.getConsumerUrl()).willReturn(url);
    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> dic;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest764">Test Case ID #dubbo_Test_76_4</h4>
<h4 id="test-case-name-testinvokeretrytimeswithzerovaluefile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportfailbackclusterinvokertestjava">Test Case Name: <code>testInvokeRetryTimesWithZeroValue</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\FailbackClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-dic">Mock Object Variable Name: <code>dic</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 @Order(5)
 public void testInvokeRetryTimesWithZeroValue() throws InterruptedException, NoSuchFieldException, IllegalAccessException {
     int retries = 0;
     resetInvokerToException();
<span class="hljs-deletion">-    given(dic.getConsumerUrl()).willReturn(url.addParameter(RETRIES_KEY, retries));</span>
<span class="hljs-addition">+    dic = createMockDirectory(url);</span>
<span class="hljs-addition">+    given(dic.getConsumerUrl()).willReturn(url.addParameter(RETRIES_KEY, retries));</span>
     FailbackClusterInvoker&lt;FailbackClusterInvokerTest&gt; invoker = new FailbackClusterInvoker&lt;&gt;(dic);
     LogUtil.start();
     DubboAppender.clear();
     invocation.setMethodName("testInvokeRetryTimesWithZeroValue");
     invoker.invoke(invocation);
     CountDownLatch countDown = new CountDownLatch(1);
     countDown.await(getRetryFailedPeriod() * (retries + 1), TimeUnit.SECONDS);
     LogUtil.stop();
     Assertions.assertEquals(0, LogUtil.findMessage(Level.INFO, "Attempt to retry to invoke method " + "testInvokeRetryTimesWithZeroValue"), "No retry messages allowed");
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">5</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInvokeRetryTimesWithZeroValue</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, NoSuchFieldException, IllegalAccessException </span>{

    <span class="hljs-keyword">int</span> retries = <span class="hljs-number">0</span>;

    resetInvokerToException();

    given(dic.getConsumerUrl()).willReturn(url.addParameter(RETRIES_KEY, retries));

    FailbackClusterInvoker&lt;FailbackClusterInvokerTest&gt; invoker = <span class="hljs-keyword">new</span> FailbackClusterInvoker&lt;&gt;(dic);

    LogUtil.start();

    DubboAppender.clear();

    invocation.setMethodName(<span class="hljs-string">"testInvokeRetryTimesWithZeroValue"</span>);

    invoker.invoke(invocation);

    CountDownLatch countDown = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    countDown.await(getRetryFailedPeriod() * (retries + <span class="hljs-number">1</span>), TimeUnit.SECONDS);

    LogUtil.stop();

    Assertions.assertEquals(<span class="hljs-number">0</span>, LogUtil.findMessage(Level.INFO, <span class="hljs-string">"Attempt to retry to invoke method "</span> + <span class="hljs-string">"testInvokeRetryTimesWithZeroValue"</span>), <span class="hljs-string">"No retry messages allowed"</span>);

}
<span class="hljs-comment">/**

 * <span class="hljs-doctag">@throws</span> java.lang.Exception

 */</span>

<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(dic.getUrl()).willReturn(url);

    given(dic.getConsumerUrl()).willReturn(url);

    given(dic.list(invocation)).willReturn(invokers);

    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation.setMethodName(<span class="hljs-string">"method1"</span>);

    invokers.add(invoker);

}
<span class="hljs-meta">@AfterEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span> </span>{

    dic = <span class="hljs-keyword">null</span>;

    invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    invokers.clear();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Directory&lt;FailbackClusterInvokerTest&gt; <span class="hljs-title">createMockDirectory</span><span class="hljs-params">(URL url)</span> </span>{
    Directory&lt;FailbackClusterInvokerTest&gt; dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(dic.getUrl()).willReturn(url);
    given(dic.getConsumerUrl()).willReturn(url);
    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> dic;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest765">Test Case ID #dubbo_Test_76_5</h4>
<h4 id="test-case-name-testinvokeretrytimeswithtwovaluefile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportfailbackclusterinvokertestjava">Test Case Name: <code>testInvokeRetryTimesWithTwoValue</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\FailbackClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-dic">Mock Object Variable Name: <code>dic</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @BeforeEach
 public void setUp() throws Exception {
<span class="hljs-deletion">-    dic = mock(Directory.class);</span>
<span class="hljs-deletion">-    given(dic.getUrl()).willReturn(url);</span>
<span class="hljs-deletion">-    given(dic.getConsumerUrl()).willReturn(url);</span>
<span class="hljs-deletion">-    given(dic.list(invocation)).willReturn(invokers);</span>
<span class="hljs-deletion">-    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest.class);</span>
<span class="hljs-addition">+    dic = createMockDirectory(url);</span>
     invocation.setMethodName("method1");
     invokers.add(invoker);
 }

 @Test
 @Order(6)
 public void testInvokeRetryTimesWithTwoValue() throws InterruptedException, NoSuchFieldException, IllegalAccessException {
     int retries = 2;
     resetInvokerToException();
<span class="hljs-deletion">-    given(dic.getConsumerUrl()).willReturn(url.addParameter(RETRIES_KEY, retries));</span>
<span class="hljs-addition">+    given(dic.getConsumerUrl()).willReturn(url.addParameter(RETRIES_KEY, retries));</span>
     FailbackClusterInvoker&lt;FailbackClusterInvokerTest&gt; invoker = new FailbackClusterInvoker&lt;&gt;(dic);
     LogUtil.start();
     DubboAppender.clear();
     invocation.setMethodName("testInvokeRetryTimesWithTwoValue");
     invoker.invoke(invocation);
     CountDownLatch countDown = new CountDownLatch(1);
     countDown.await(getRetryFailedPeriod() * (retries + 1), TimeUnit.SECONDS);
     LogUtil.stop();
     Assertions.assertEquals(2, LogUtil.findMessage(Level.INFO, "Attempt to retry to invoke method " + "testInvokeRetryTimesWithTwoValue"), "Must have two error message ");
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-comment">/**

 * <span class="hljs-doctag">@throws</span> java.lang.Exception

 */</span>

<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(dic.getUrl()).willReturn(url);

    given(dic.getConsumerUrl()).willReturn(url);

    given(dic.list(invocation)).willReturn(invokers);

    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation.setMethodName(<span class="hljs-string">"method1"</span>);

    invokers.add(invoker);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">6</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInvokeRetryTimesWithTwoValue</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, NoSuchFieldException, IllegalAccessException </span>{

    <span class="hljs-keyword">int</span> retries = <span class="hljs-number">2</span>;

    resetInvokerToException();

    given(dic.getConsumerUrl()).willReturn(url.addParameter(RETRIES_KEY, retries));

    FailbackClusterInvoker&lt;FailbackClusterInvokerTest&gt; invoker = <span class="hljs-keyword">new</span> FailbackClusterInvoker&lt;&gt;(dic);

    LogUtil.start();

    DubboAppender.clear();

    invocation.setMethodName(<span class="hljs-string">"testInvokeRetryTimesWithTwoValue"</span>);

    invoker.invoke(invocation);

    CountDownLatch countDown = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    countDown.await(getRetryFailedPeriod() * (retries + <span class="hljs-number">1</span>), TimeUnit.SECONDS);

    LogUtil.stop();

    Assertions.assertEquals(<span class="hljs-number">2</span>, LogUtil.findMessage(Level.INFO, <span class="hljs-string">"Attempt to retry to invoke method "</span> + <span class="hljs-string">"testInvokeRetryTimesWithTwoValue"</span>), <span class="hljs-string">"Must have two error message "</span>);

}
<span class="hljs-meta">@AfterEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span> </span>{

    dic = <span class="hljs-keyword">null</span>;

    invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    invokers.clear();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Directory&lt;FailbackClusterInvokerTest&gt; <span class="hljs-title">createMockDirectory</span><span class="hljs-params">(URL url)</span> </span>{
    Directory&lt;FailbackClusterInvokerTest&gt; dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(dic.getUrl()).willReturn(url);
    given(dic.getConsumerUrl()).willReturn(url);
    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> dic;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest766">Test Case ID #dubbo_Test_76_6</h4>
<h4 id="test-case-name-testinvokeretrytimeswithdefaultvaluefile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportfailbackclusterinvokertestjava">Test Case Name: <code>testInvokeRetryTimesWithDefaultValue</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\FailbackClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-dic">Mock Object Variable Name: <code>dic</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    resetInvokerToException();
<span class="hljs-deletion">-    given(dic.getConsumerUrl()).willReturn(URL.valueOf("test://test:11/test"));</span>
<span class="hljs-addition">+    dic = createMockDirectory(URL.valueOf("test://test:11/test"));</span>
    FailbackClusterInvoker&lt;FailbackClusterInvokerTest&gt; invoker = new FailbackClusterInvoker&lt;&gt;(dic);
    LogUtil.start();
    DubboAppender.clear();
    invocation.setMethodName("testInvokeRetryTimesWithDefaultValue");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">7</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInvokeRetryTimesWithDefaultValue</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, NoSuchFieldException, IllegalAccessException </span>{

    resetInvokerToException();

    given(dic.getConsumerUrl()).willReturn(URL.valueOf(<span class="hljs-string">"test://test:11/test"</span>));

    FailbackClusterInvoker&lt;FailbackClusterInvokerTest&gt; invoker = <span class="hljs-keyword">new</span> FailbackClusterInvoker&lt;&gt;(dic);

    LogUtil.start();

    DubboAppender.clear();

    invocation.setMethodName(<span class="hljs-string">"testInvokeRetryTimesWithDefaultValue"</span>);

    invoker.invoke(invocation);

    CountDownLatch countDown = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    countDown.await(getRetryFailedPeriod() * (CommonConstants.DEFAULT_FAILBACK_TIMES + <span class="hljs-number">1</span>), TimeUnit.SECONDS);

    LogUtil.stop();

    Assertions.assertEquals(<span class="hljs-number">3</span>, LogUtil.findMessage(Level.INFO, <span class="hljs-string">"Attempt to retry to invoke method "</span> + <span class="hljs-string">"testInvokeRetryTimesWithDefaultValue"</span>), <span class="hljs-string">"Must have three error message "</span>);

}
<span class="hljs-comment">/**

 * <span class="hljs-doctag">@throws</span> java.lang.Exception

 */</span>

<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(dic.getUrl()).willReturn(url);

    given(dic.getConsumerUrl()).willReturn(url);

    given(dic.list(invocation)).willReturn(invokers);

    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation.setMethodName(<span class="hljs-string">"method1"</span>);

    invokers.add(invoker);

}
<span class="hljs-meta">@AfterEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span> </span>{

    dic = <span class="hljs-keyword">null</span>;

    invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    invokers.clear();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Directory&lt;FailbackClusterInvokerTest&gt; <span class="hljs-title">createMockDirectory</span><span class="hljs-params">(URL url)</span> </span>{
    Directory&lt;FailbackClusterInvokerTest&gt; dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(dic.getUrl()).willReturn(url);
    given(dic.getConsumerUrl()).willReturn(url);
    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> dic;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest767">Test Case ID #dubbo_Test_76_7</h4>
<h4 id="test-case-name-testinvokeretrytimeswithillegalvaluefile-cjavaprojectsapachedubbodubbo-clustersrctestjavaorgapachedubborpcclustersupportfailbackclusterinvokertestjava">Test Case Name: <code>testInvokeRetryTimesWithIllegalValue</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-cluster\src\test\java\org\apache\dubbo\rpc\cluster\support\FailbackClusterInvokerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-dic">Mock Object Variable Name: <code>dic</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void setUp() throws Exception {
<span class="hljs-deletion">-    dic = mock(Directory.class);</span>
<span class="hljs-deletion">-    given(dic.getUrl()).willReturn(url);</span>
<span class="hljs-deletion">-    given(dic.getConsumerUrl()).willReturn(url);</span>
<span class="hljs-deletion">-    given(dic.list(invocation)).willReturn(invokers);</span>
<span class="hljs-deletion">-    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest.class);</span>
<span class="hljs-addition">+    dic = createMockDirectory(url);</span>
<span class="hljs-addition">+    given(dic.list(invocation)).willReturn(invokers);</span>
    invocation.setMethodName("method1");
    invokers.add(invoker);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-meta">@Order</span>(<span class="hljs-number">8</span>)

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInvokeRetryTimesWithIllegalValue</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, NoSuchFieldException, IllegalAccessException </span>{

    resetInvokerToException();

    given(dic.getConsumerUrl()).willReturn(url.addParameter(RETRIES_KEY, -<span class="hljs-number">100</span>));

    FailbackClusterInvoker&lt;FailbackClusterInvokerTest&gt; invoker = <span class="hljs-keyword">new</span> FailbackClusterInvoker&lt;&gt;(dic);

    LogUtil.start();

    DubboAppender.clear();

    invocation.setMethodName(<span class="hljs-string">"testInvokeRetryTimesWithIllegalValue"</span>);

    invoker.invoke(invocation);

    CountDownLatch countDown = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    countDown.await(getRetryFailedPeriod() * (CommonConstants.DEFAULT_FAILBACK_TIMES + <span class="hljs-number">1</span>), TimeUnit.SECONDS);

    LogUtil.stop();

    Assertions.assertEquals(<span class="hljs-number">3</span>, LogUtil.findMessage(Level.INFO, <span class="hljs-string">"Attempt to retry to invoke method "</span> + <span class="hljs-string">"testInvokeRetryTimesWithIllegalValue"</span>), <span class="hljs-string">"Must have three error message "</span>);

}
<span class="hljs-comment">/**

 * <span class="hljs-doctag">@throws</span> java.lang.Exception

 */</span>

<span class="hljs-meta">@BeforeEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(dic.getUrl()).willReturn(url);

    given(dic.getConsumerUrl()).willReturn(url);

    given(dic.list(invocation)).willReturn(invokers);

    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    invocation.setMethodName(<span class="hljs-string">"method1"</span>);

    invokers.add(invoker);

}
<span class="hljs-meta">@AfterEach</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">tearDown</span><span class="hljs-params">()</span> </span>{

    dic = <span class="hljs-keyword">null</span>;

    invocation = <span class="hljs-keyword">new</span> RpcInvocation();

    invokers.clear();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Directory&lt;FailbackClusterInvokerTest&gt; <span class="hljs-title">createMockDirectory</span><span class="hljs-params">(URL url)</span> </span>{
    Directory&lt;FailbackClusterInvokerTest&gt; dic = mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(dic.getUrl()).willReturn(url);
    given(dic.getConsumerUrl()).willReturn(url);
    given(dic.getInterface()).willReturn(FailbackClusterInvokerTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> dic;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci77">Mock Clone Instance #dubbo_MCI_77</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.rpc.cluster.Directory</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Directory <span class="hljs-title">createMockDirectory</span><span class="hljs-params">(List&lt;Invoker&lt;?&gt;&gt; invokerList)</span> </span>{
    Directory directory = Mockito.mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(directory.getAllInvokers()).thenReturn(invokerList);
    <span class="hljs-keyword">return</span> directory;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest771">Test Case ID #dubbo_Test_77_1</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationdefaultmigrationaddresscomparatortestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\DefaultMigrationAddressComparatorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-newdirectory">Mock Object Variable Name: <code>newDirectory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ClusterInvoker newInvoker = Mockito.mock(ClusterInvoker.class);
    ClusterInvoker oldInvoker = Mockito.mock(ClusterInvoker.class);
<span class="hljs-deletion">-    Directory newDirectory = Mockito.mock(Directory.class);</span>
    Directory oldDirectory = Mockito.mock(Directory.class);
    MigrationRule rule = Mockito.mock(MigrationRule.class);
    URL url = Mockito.mock(URL.class);
    Mockito.when(url.getDisplayServiceKey()).thenReturn("test");
    Mockito.when(newInvoker.getDirectory()).thenReturn(newDirectory);
    Mockito.when(oldInvoker.getDirectory()).thenReturn(oldDirectory);
    Mockito.when(newInvoker.getUrl()).thenReturn(url);
    Mockito.when(oldInvoker.getUrl()).thenReturn(url);
    Mockito.when(newInvoker.hasProxyInvokers()).thenReturn(false);
<span class="hljs-deletion">-    Mockito.when(newDirectory.getAllInvokers()).thenReturn(Collections.emptyList());</span>
<span class="hljs-addition">+    Directory newDirectory = createMockDirectory(Collections.emptyList());</span>
    Assertions.assertFalse(comparator.shouldMigrate(newInvoker, oldInvoker, rule));
    Assertions.assertEquals(-1, comparator.getAddressSize("test").get(NEW_ADDRESS_SIZE));
    Assertions.assertEquals(0, comparator.getAddressSize("test").get(OLD_ADDRESS_SIZE));
    Mockito.when(newInvoker.hasProxyInvokers()).thenReturn(true);
    Mockito.when(oldInvoker.hasProxyInvokers()).thenReturn(false);
    Mockito.when(oldDirectory.getAllInvokers()).thenReturn(Collections.emptyList());
    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, rule));
    Assertions.assertEquals(0, comparator.getAddressSize("test").get(NEW_ADDRESS_SIZE));
    Assertions.assertEquals(-1, comparator.getAddressSize("test").get(OLD_ADDRESS_SIZE));
    Mockito.when(oldInvoker.hasProxyInvokers()).thenReturn(true);
    List&lt;Invoker&lt;?&gt;&gt; newInvokerList = new LinkedList&lt;&gt;();
    newInvokerList.add(Mockito.mock(Invoker.class));
    newInvokerList.add(Mockito.mock(Invoker.class));
    newInvokerList.add(Mockito.mock(Invoker.class));
<span class="hljs-deletion">-    Mockito.when(newDirectory.getAllInvokers()).thenReturn(newInvokerList);</span>
<span class="hljs-addition">+    Mockito.when(newDirectory.getAllInvokers()).thenReturn(newInvokerList);</span>
    List&lt;Invoker&lt;?&gt;&gt; oldInvokerList = new LinkedList&lt;&gt;();
    oldInvokerList.add(Mockito.mock(Invoker.class));
    oldInvokerList.add(Mockito.mock(Invoker.class));
    Mockito.when(oldDirectory.getAllInvokers()).thenReturn(oldInvokerList);
    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, null));
    Mockito.when(rule.getThreshold(url)).thenReturn(0.5f);
    newInvokerList.clear();
    newInvokerList.add(Mockito.mock(Invoker.class));
    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, rule));
    newInvokerList.clear();
    // hasProxyInvokers will check if invokers list is empty
    // if hasProxyInvokers return true, comparator will directly because default threshold is 0.0
    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, null));
    Assertions.assertFalse(comparator.shouldMigrate(newInvoker, oldInvoker, rule));
    Assertions.assertEquals(0, comparator.getAddressSize("test").get(NEW_ADDRESS_SIZE));
    Assertions.assertEquals(2, comparator.getAddressSize("test").get(OLD_ADDRESS_SIZE));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"all"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    DefaultMigrationAddressComparator comparator = <span class="hljs-keyword">new</span> DefaultMigrationAddressComparator();

    ClusterInvoker newInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker oldInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Directory newDirectory = Mockito.mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Directory oldDirectory = Mockito.mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRule rule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(url.getDisplayServiceKey()).thenReturn(<span class="hljs-string">"test"</span>);

    Mockito.when(newInvoker.getDirectory()).thenReturn(newDirectory);

    Mockito.when(oldInvoker.getDirectory()).thenReturn(oldDirectory);

    Mockito.when(newInvoker.getUrl()).thenReturn(url);

    Mockito.when(oldInvoker.getUrl()).thenReturn(url);

    Mockito.when(newInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(newDirectory.getAllInvokers()).thenReturn(Collections.emptyList());

    Assertions.assertFalse(comparator.shouldMigrate(newInvoker, oldInvoker, rule));

    Assertions.assertEquals(-<span class="hljs-number">1</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(NEW_ADDRESS_SIZE));

    Assertions.assertEquals(<span class="hljs-number">0</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(OLD_ADDRESS_SIZE));

    Mockito.when(newInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(oldInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(oldDirectory.getAllInvokers()).thenReturn(Collections.emptyList());

    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, rule));

    Assertions.assertEquals(<span class="hljs-number">0</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(NEW_ADDRESS_SIZE));

    Assertions.assertEquals(-<span class="hljs-number">1</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(OLD_ADDRESS_SIZE));

    Mockito.when(oldInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;Invoker&lt;?&gt;&gt; newInvokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    newInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    newInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    newInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(newDirectory.getAllInvokers()).thenReturn(newInvokerList);

    List&lt;Invoker&lt;?&gt;&gt; oldInvokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    oldInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    oldInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(oldDirectory.getAllInvokers()).thenReturn(oldInvokerList);

    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, <span class="hljs-keyword">null</span>));

    Mockito.when(rule.getThreshold(url)).thenReturn(<span class="hljs-number">0.5f</span>);

    newInvokerList.clear();

    newInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, rule));

    newInvokerList.clear();

    <span class="hljs-comment">// hasProxyInvokers will check if invokers list is empty</span>

    <span class="hljs-comment">// if hasProxyInvokers return true, comparator will directly because default threshold is 0.0</span>

    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, <span class="hljs-keyword">null</span>));

    Assertions.assertFalse(comparator.shouldMigrate(newInvoker, oldInvoker, rule));

    Assertions.assertEquals(<span class="hljs-number">0</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(NEW_ADDRESS_SIZE));

    Assertions.assertEquals(<span class="hljs-number">2</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(OLD_ADDRESS_SIZE));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Directory <span class="hljs-title">createMockDirectory</span><span class="hljs-params">(List&lt;Invoker&lt;?&gt;&gt; invokerList)</span> </span>{
    Directory directory = Mockito.mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(directory.getAllInvokers()).thenReturn(invokerList);
    <span class="hljs-keyword">return</span> directory;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest772">Test Case ID #dubbo_Test_77_2</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationdefaultmigrationaddresscomparatortestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\DefaultMigrationAddressComparatorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-olddirectory">Mock Object Variable Name: <code>oldDirectory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ClusterInvoker newInvoker = Mockito.mock(ClusterInvoker.class);
    ClusterInvoker oldInvoker = Mockito.mock(ClusterInvoker.class);
    Directory newDirectory = Mockito.mock(Directory.class);
<span class="hljs-deletion">-    Directory oldDirectory = Mockito.mock(Directory.class);</span>
<span class="hljs-addition">+    Directory oldDirectory = createMockDirectory(Collections.emptyList());</span>
    MigrationRule rule = Mockito.mock(MigrationRule.class);
    URL url = Mockito.mock(URL.class);
    Mockito.when(url.getDisplayServiceKey()).thenReturn("test");
    Mockito.when(newInvoker.getDirectory()).thenReturn(newDirectory);
    Mockito.when(oldInvoker.getDirectory()).thenReturn(oldDirectory);
    Mockito.when(newInvoker.getUrl()).thenReturn(url);
    Mockito.when(oldInvoker.getUrl()).thenReturn(url);
    Mockito.when(newInvoker.hasProxyInvokers()).thenReturn(false);
    Mockito.when(newDirectory.getAllInvokers()).thenReturn(Collections.emptyList());
    Assertions.assertFalse(comparator.shouldMigrate(newInvoker, oldInvoker, rule));
    Assertions.assertEquals(-1, comparator.getAddressSize("test").get(NEW_ADDRESS_SIZE));
    Assertions.assertEquals(0, comparator.getAddressSize("test").get(OLD_ADDRESS_SIZE));
    Mockito.when(newInvoker.hasProxyInvokers()).thenReturn(true);
    Mockito.when(oldInvoker.hasProxyInvokers()).thenReturn(false);
<span class="hljs-deletion">-    Mockito.when(oldDirectory.getAllInvokers()).thenReturn(Collections.emptyList());</span>
    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, rule));
    Assertions.assertEquals(0, comparator.getAddressSize("test").get(NEW_ADDRESS_SIZE));
    Assertions.assertEquals(-1, comparator.getAddressSize("test").get(OLD_ADDRESS_SIZE));
    Mockito.when(oldInvoker.hasProxyInvokers()).thenReturn(true);
    List&lt;Invoker&lt;?&gt;&gt; newInvokerList = new LinkedList&lt;&gt;();
    newInvokerList.add(Mockito.mock(Invoker.class));
    newInvokerList.add(Mockito.mock(Invoker.class));
    newInvokerList.add(Mockito.mock(Invoker.class));
    Mockito.when(newDirectory.getAllInvokers()).thenReturn(newInvokerList);
    List&lt;Invoker&lt;?&gt;&gt; oldInvokerList = new LinkedList&lt;&gt;();
    oldInvokerList.add(Mockito.mock(Invoker.class));
    oldInvokerList.add(Mockito.mock(Invoker.class));
<span class="hljs-deletion">-    Mockito.when(oldDirectory.getAllInvokers()).thenReturn(oldInvokerList);</span>
<span class="hljs-addition">+    Mockito.when(oldDirectory.getAllInvokers()).thenReturn(oldInvokerList);</span>
    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, null));
    Mockito.when(rule.getThreshold(url)).thenReturn(0.5f);
    newInvokerList.clear();
    newInvokerList.add(Mockito.mock(Invoker.class));
    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, rule));
    newInvokerList.clear();
    // hasProxyInvokers will check if invokers list is empty
    // if hasProxyInvokers return true, comparator will directly because default threshold is 0.0
    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, null));
    Assertions.assertFalse(comparator.shouldMigrate(newInvoker, oldInvoker, rule));
    Assertions.assertEquals(0, comparator.getAddressSize("test").get(NEW_ADDRESS_SIZE));
    Assertions.assertEquals(2, comparator.getAddressSize("test").get(OLD_ADDRESS_SIZE));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"all"</span>)

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    DefaultMigrationAddressComparator comparator = <span class="hljs-keyword">new</span> DefaultMigrationAddressComparator();

    ClusterInvoker newInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ClusterInvoker oldInvoker = Mockito.mock(ClusterInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Directory newDirectory = Mockito.mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Directory oldDirectory = Mockito.mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationRule rule = Mockito.mock(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    URL url = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(url.getDisplayServiceKey()).thenReturn(<span class="hljs-string">"test"</span>);

    Mockito.when(newInvoker.getDirectory()).thenReturn(newDirectory);

    Mockito.when(oldInvoker.getDirectory()).thenReturn(oldDirectory);

    Mockito.when(newInvoker.getUrl()).thenReturn(url);

    Mockito.when(oldInvoker.getUrl()).thenReturn(url);

    Mockito.when(newInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(newDirectory.getAllInvokers()).thenReturn(Collections.emptyList());

    Assertions.assertFalse(comparator.shouldMigrate(newInvoker, oldInvoker, rule));

    Assertions.assertEquals(-<span class="hljs-number">1</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(NEW_ADDRESS_SIZE));

    Assertions.assertEquals(<span class="hljs-number">0</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(OLD_ADDRESS_SIZE));

    Mockito.when(newInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(oldInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(oldDirectory.getAllInvokers()).thenReturn(Collections.emptyList());

    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, rule));

    Assertions.assertEquals(<span class="hljs-number">0</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(NEW_ADDRESS_SIZE));

    Assertions.assertEquals(-<span class="hljs-number">1</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(OLD_ADDRESS_SIZE));

    Mockito.when(oldInvoker.hasProxyInvokers()).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;Invoker&lt;?&gt;&gt; newInvokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    newInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    newInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    newInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(newDirectory.getAllInvokers()).thenReturn(newInvokerList);

    List&lt;Invoker&lt;?&gt;&gt; oldInvokerList = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();

    oldInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    oldInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(oldDirectory.getAllInvokers()).thenReturn(oldInvokerList);

    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, <span class="hljs-keyword">null</span>));

    Mockito.when(rule.getThreshold(url)).thenReturn(<span class="hljs-number">0.5f</span>);

    newInvokerList.clear();

    newInvokerList.add(Mockito.mock(Invoker<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, rule));

    newInvokerList.clear();

    <span class="hljs-comment">// hasProxyInvokers will check if invokers list is empty</span>

    <span class="hljs-comment">// if hasProxyInvokers return true, comparator will directly because default threshold is 0.0</span>

    Assertions.assertTrue(comparator.shouldMigrate(newInvoker, oldInvoker, <span class="hljs-keyword">null</span>));

    Assertions.assertFalse(comparator.shouldMigrate(newInvoker, oldInvoker, rule));

    Assertions.assertEquals(<span class="hljs-number">0</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(NEW_ADDRESS_SIZE));

    Assertions.assertEquals(<span class="hljs-number">2</span>, comparator.getAddressSize(<span class="hljs-string">"test"</span>).get(OLD_ADDRESS_SIZE));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Directory <span class="hljs-title">createMockDirectory</span><span class="hljs-params">(List&lt;Invoker&lt;?&gt;&gt; invokerList)</span> </span>{
    Directory directory = Mockito.mock(Directory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(directory.getAllInvokers()).thenReturn(invokerList);
    <span class="hljs-keyword">return</span> directory;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-dubbomci78">Mock Clone Instance #dubbo_MCI_78</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.dubbo.registry.client.migration.MigrationInvoker&lt;?&gt;</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MigrationInvoker&lt;?&gt; migrationInvoker;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    migrationInvoker = Mockito.mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
migrationInvoker;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-dubbotest781">Test Case ID #dubbo_Test_78_1</h4>
<h4 id="test-case-name-testfile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationrulelistenertestjava">Test Case Name: <code>test</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationRuleListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-migrationinvoker">Mock Object Variable Name: <code>migrationInvoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     MigrationRuleListener migrationRuleListener = new MigrationRuleListener(ApplicationModel.defaultModel().getDefaultModule()) {
 
         @Override
         public synchronized void process(ConfigChangedEvent event) {
             try {
                 countDownLatch.await();
             } catch (InterruptedException e) {
                 throw new RuntimeException(e);
             }
             super.process(event);
         }
     };
<span class="hljs-deletion">-    MigrationInvoker&lt;?&gt; migrationInvoker = Mockito.mock(MigrationInvoker.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `migrationInvoker`</span>
     migrationRuleListener.getHandlers().put(migrationInvoker, handler);
     countDownLatch.countDown();
     await().untilAsserted(() -&gt; {
         Mockito.verify(handler).doMigrate(Mockito.any());
     });
     //        Mockito.verify(handler, Mockito.timeout(5000)).doMigrate(Mockito.any());
     migrationRuleListener.onRefer(null, migrationInvoker, consumerURL, null);
     Mockito.verify(handler, Mockito.times(2)).doMigrate(Mockito.any());
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Listener started with config center and local rule, no initial remote rule.

 * Check local rule take effect

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{

    DynamicConfiguration dynamicConfiguration = Mockito.mock(DynamicConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ApplicationModel.reset();

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setDynamicConfiguration(dynamicConfiguration);

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setLocalMigrationRule(localRule);

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"demo-consumer"</span>);

    ApplicationModel.defaultModel().getApplicationConfigManager().setApplication(applicationConfig);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getParameter(<span class="hljs-string">"timestamp"</span>)).thenReturn(<span class="hljs-string">"1"</span>);

    System.setProperty(<span class="hljs-string">"dubbo.application.migration.delay"</span>, <span class="hljs-string">"1"</span>);

    MigrationRuleHandler&lt;?&gt; handler = Mockito.mock(MigrationRuleHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">verboseLogging</span>())</span>;

    CountDownLatch countDownLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    MigrationRuleListener migrationRuleListener = <span class="hljs-keyword">new</span> MigrationRuleListener(ApplicationModel.defaultModel().getDefaultModule()) {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">process</span><span class="hljs-params">(ConfigChangedEvent event)</span> </span>{

            <span class="hljs-keyword">try</span> {

                countDownLatch.await();

            } <span class="hljs-keyword">catch</span> (InterruptedException e) {

                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(e);

            }

            <span class="hljs-keyword">super</span>.process(event);

        }

    };

    MigrationInvoker&lt;?&gt; migrationInvoker = Mockito.mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    migrationRuleListener.getHandlers().put(migrationInvoker, handler);

    countDownLatch.countDown();

    await().untilAsserted(() -&gt; {

        Mockito.verify(handler).doMigrate(Mockito.any());

    });

    <span class="hljs-comment">//        Mockito.verify(handler, Mockito.timeout(5000)).doMigrate(Mockito.any());</span>

    migrationRuleListener.onRefer(<span class="hljs-keyword">null</span>, migrationInvoker, consumerURL, <span class="hljs-keyword">null</span>);

    Mockito.verify(handler, Mockito.times(<span class="hljs-number">2</span>)).doMigrate(Mockito.any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MigrationInvoker&lt;?&gt; migrationInvoker;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    migrationInvoker = Mockito.mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
migrationInvoker;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest782">Test Case ID #dubbo_Test_78_2</h4>
<h4 id="test-case-name-testwithinitandnolocalrulefile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationrulelistenertestjava">Test Case Name: <code>testWithInitAndNoLocalRule</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationRuleListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-migrationinvoker">Mock Object Variable Name: <code>migrationInvoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     MigrationRuleListener migrationRuleListener = new MigrationRuleListener(ApplicationModel.defaultModel().getDefaultModule());
<span class="hljs-deletion">-    MigrationInvoker&lt;?&gt; migrationInvoker = Mockito.mock(MigrationInvoker.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `migrationInvoker`</span>
     migrationRuleListener.getHandlers().put(migrationInvoker, handler);
     migrationRuleListener.onRefer(null, migrationInvoker, consumerURL, null);
     // check migration happened after invoker referred
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Test listener started without local rule and config center, INIT should be used and no scheduled task should be started.

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testWithInitAndNoLocalRule</span><span class="hljs-params">()</span> </span>{

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setDynamicConfiguration(<span class="hljs-keyword">null</span>);

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setLocalMigrationRule(<span class="hljs-string">""</span>);

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"demo-consumer"</span>);

    ApplicationModel.defaultModel().getApplicationConfigManager().setApplication(applicationConfig);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getParameter(<span class="hljs-string">"timestamp"</span>)).thenReturn(<span class="hljs-string">"1"</span>);

    System.setProperty(<span class="hljs-string">"dubbo.application.migration.delay"</span>, <span class="hljs-string">"1000"</span>);

    MigrationRuleHandler&lt;?&gt; handler = Mockito.mock(MigrationRuleHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">verboseLogging</span>())</span>;

    MigrationRuleListener migrationRuleListener = <span class="hljs-keyword">new</span> MigrationRuleListener(ApplicationModel.defaultModel().getDefaultModule());

    MigrationInvoker&lt;?&gt; migrationInvoker = Mockito.mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    migrationRuleListener.getHandlers().put(migrationInvoker, handler);

    migrationRuleListener.onRefer(<span class="hljs-keyword">null</span>, migrationInvoker, consumerURL, <span class="hljs-keyword">null</span>);

    <span class="hljs-comment">// check migration happened after invoker referred</span>

    Mockito.verify(handler, Mockito.times(<span class="hljs-number">1</span>)).doMigrate(MigrationRule.getInitRule());

    <span class="hljs-comment">// check no delay tasks created for there's no local rule and no config center</span>

    Assertions.assertNull(migrationRuleListener.localRuleMigrationFuture);

    Assertions.assertNull(migrationRuleListener.ruleMigrationFuture);

    Assertions.assertEquals(<span class="hljs-number">0</span>, migrationRuleListener.ruleQueue.size());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MigrationInvoker&lt;?&gt; migrationInvoker;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    migrationInvoker = Mockito.mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
migrationInvoker;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-dubbotest783">Test Case ID #dubbo_Test_78_3</h4>
<h4 id="test-case-name-testwithconfigurationlistenerandlocalrulefile-cjavaprojectsapachedubbodubbo-registrydubbo-registry-apisrctestjavaorgapachedubboregistryclientmigrationmigrationrulelistenertestjava">Test Case Name: <code>testWithConfigurationListenerAndLocalRule</code>(File: <code>C:\Java_projects\Apache\dubbo\dubbo-registry\dubbo-registry-api\src\test\java\org\apache\dubbo\registry\client\migration\MigrationRuleListenerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-migrationinvoker">Mock Object Variable Name: <code>migrationInvoker</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     Assertions.assertNull(migrationRuleListener.ruleMigrationFuture);
<span class="hljs-deletion">-    MigrationInvoker&lt;?&gt; migrationInvoker = Mockito.mock(MigrationInvoker.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `migrationInvoker`</span>
     MigrationInvoker&lt;?&gt; migrationInvoker2 = Mockito.mock(MigrationInvoker.class);
     // Remote rule will be applied when onRefer gets executed
     migrationRuleListener.getHandlers().put(migrationInvoker, handler);
     migrationRuleListener.onRefer(null, migrationInvoker, consumerURL, null);
     MigrationRule tmpRemoteRule = migrationRuleListener.getRule();
     ArgumentCaptor&lt;MigrationRule&gt; captor = ArgumentCaptor.forClass(MigrationRule.class);
     Mockito.verify(handler, Mockito.times(1)).doMigrate(captor.capture());
     Assertions.assertEquals(tmpRemoteRule, captor.getValue());
     await().until(() -&gt; migrationRuleListener.localRuleMigrationFuture.isDone());
     Assertions.assertNull(migrationRuleListener.ruleMigrationFuture);
     Assertions.assertEquals(tmpRemoteRule, migrationRuleListener.getRule());
     Mockito.verify(handler, Mockito.times(1)).doMigrate(Mockito.any());
     ArgumentCaptor&lt;MigrationRule&gt; captor2 = ArgumentCaptor.forClass(MigrationRule.class);
     migrationRuleListener.getHandlers().put(migrationInvoker2, handler2);
     migrationRuleListener.onRefer(null, migrationInvoker2, consumerURL2, null);
     Mockito.verify(handler2, Mockito.times(1)).doMigrate(captor2.capture());
     Assertions.assertEquals(tmpRemoteRule, captor2.getValue());
     migrationRuleListener.process(new ConfigChangedEvent("key", "group", dynamicRemoteRule));
     await().until(migrationRuleListener.ruleQueue::isEmpty);
     await().untilAsserted(() -&gt; {
         Mockito.verify(handler, Mockito.times(2)).doMigrate(Mockito.any());
         Mockito.verify(handler2, Mockito.times(2)).doMigrate(Mockito.any());
     });
     Assertions.assertNotNull(migrationRuleListener.ruleMigrationFuture);
     ArgumentCaptor&lt;MigrationRule&gt; captor_event = ArgumentCaptor.forClass(MigrationRule.class);
     Mockito.verify(handler, Mockito.times(2)).doMigrate(captor_event.capture());
     Assertions.assertEquals("APPLICATION_FIRST", captor_event.getValue().getStep().toString());
     Mockito.verify(handler2, Mockito.times(2)).doMigrate(captor_event.capture());
     Assertions.assertEquals("APPLICATION_FIRST", captor_event.getValue().getStep().toString());
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * Listener with config center initial remote rule and local rule, check

 * 1. initial remote rule other than local rule take effect

 * 2. remote rule change and all invokers gets notified

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">testWithConfigurationListenerAndLocalRule</span><span class="hljs-params">()</span> </span>{

    DynamicConfiguration dynamicConfiguration = Mockito.mock(DynamicConfiguration<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.doReturn(remoteRule).when(dynamicConfiguration).getConfig(Mockito.anyString(), Mockito.anyString());

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setDynamicConfiguration(dynamicConfiguration);

    ApplicationModel.defaultModel().getDefaultModule().getModelEnvironment().setLocalMigrationRule(localRule);

    ApplicationConfig applicationConfig = <span class="hljs-keyword">new</span> ApplicationConfig();

    applicationConfig.setName(<span class="hljs-string">"demo-consumer"</span>);

    ApplicationModel.defaultModel().getApplicationConfigManager().setApplication(applicationConfig);

    URL consumerURL = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL.getServiceKey()).thenReturn(<span class="hljs-string">"Test"</span>);

    Mockito.when(consumerURL.getParameter(<span class="hljs-string">"timestamp"</span>)).thenReturn(<span class="hljs-string">"1"</span>);

    URL consumerURL2 = Mockito.mock(URL<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(consumerURL2.getServiceKey()).thenReturn(<span class="hljs-string">"Test2"</span>);

    Mockito.when(consumerURL2.getParameter(<span class="hljs-string">"timestamp"</span>)).thenReturn(<span class="hljs-string">"2"</span>);

    System.setProperty(<span class="hljs-string">"dubbo.application.migration.delay"</span>, <span class="hljs-string">"10"</span>);

    MigrationRuleHandler&lt;?&gt; handler = Mockito.mock(MigrationRuleHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">verboseLogging</span>())</span>;

    MigrationRuleHandler&lt;?&gt; handler2 = Mockito.mock(MigrationRuleHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">verboseLogging</span>())</span>;

    <span class="hljs-comment">// Both local rule and remote rule are here</span>

    <span class="hljs-comment">// Local rule with one delayed task started to apply</span>

    MigrationRuleListener migrationRuleListener = <span class="hljs-keyword">new</span> MigrationRuleListener(ApplicationModel.defaultModel().getDefaultModule());

    Assertions.assertNotNull(migrationRuleListener.localRuleMigrationFuture);

    Assertions.assertNull(migrationRuleListener.ruleMigrationFuture);

    MigrationInvoker&lt;?&gt; migrationInvoker = Mockito.mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    MigrationInvoker&lt;?&gt; migrationInvoker2 = Mockito.mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// Remote rule will be applied when onRefer gets executed</span>

    migrationRuleListener.getHandlers().put(migrationInvoker, handler);

    migrationRuleListener.onRefer(<span class="hljs-keyword">null</span>, migrationInvoker, consumerURL, <span class="hljs-keyword">null</span>);

    MigrationRule tmpRemoteRule = migrationRuleListener.getRule();

    ArgumentCaptor&lt;MigrationRule&gt; captor = ArgumentCaptor.forClass(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(handler, Mockito.times(<span class="hljs-number">1</span>)).doMigrate(captor.capture());

    Assertions.assertEquals(tmpRemoteRule, captor.getValue());

    await().until(() -&gt; migrationRuleListener.localRuleMigrationFuture.isDone());

    Assertions.assertNull(migrationRuleListener.ruleMigrationFuture);

    Assertions.assertEquals(tmpRemoteRule, migrationRuleListener.getRule());

    Mockito.verify(handler, Mockito.times(<span class="hljs-number">1</span>)).doMigrate(Mockito.any());

    ArgumentCaptor&lt;MigrationRule&gt; captor2 = ArgumentCaptor.forClass(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    migrationRuleListener.getHandlers().put(migrationInvoker2, handler2);

    migrationRuleListener.onRefer(<span class="hljs-keyword">null</span>, migrationInvoker2, consumerURL2, <span class="hljs-keyword">null</span>);

    Mockito.verify(handler2, Mockito.times(<span class="hljs-number">1</span>)).doMigrate(captor2.capture());

    Assertions.assertEquals(tmpRemoteRule, captor2.getValue());

    migrationRuleListener.process(<span class="hljs-keyword">new</span> ConfigChangedEvent(<span class="hljs-string">"key"</span>, <span class="hljs-string">"group"</span>, dynamicRemoteRule));

    await().until(migrationRuleListener.ruleQueue::isEmpty);

    await().untilAsserted(() -&gt; {

        Mockito.verify(handler, Mockito.times(<span class="hljs-number">2</span>)).doMigrate(Mockito.any());

        Mockito.verify(handler2, Mockito.times(<span class="hljs-number">2</span>)).doMigrate(Mockito.any());

    });

    Assertions.assertNotNull(migrationRuleListener.ruleMigrationFuture);

    ArgumentCaptor&lt;MigrationRule&gt; captor_event = ArgumentCaptor.forClass(MigrationRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(handler, Mockito.times(<span class="hljs-number">2</span>)).doMigrate(captor_event.capture());

    Assertions.assertEquals(<span class="hljs-string">"APPLICATION_FIRST"</span>, captor_event.getValue().getStep().toString());

    Mockito.verify(handler2, Mockito.times(<span class="hljs-number">2</span>)).doMigrate(captor_event.capture());

    Assertions.assertEquals(<span class="hljs-string">"APPLICATION_FIRST"</span>, captor_event.getValue().getStep().toString());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MigrationInvoker&lt;?&gt; migrationInvoker;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    migrationInvoker = Mockito.mock(MigrationInvoker<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
migrationInvoker;

</div></code></pre>
</details>
<hr>

</body>
</html>
