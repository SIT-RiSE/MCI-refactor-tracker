<!DOCTYPE html>
<html>
<head>
<title>druid-Refactoring-guide.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="a-guide-to-refactoring-mock-clones-in-druid">A guide to Refactoring mock clones in druid</h1>
<h2 id="mock-clone-instance-druidmci1">Mock Clone Instance #druid_MCI_1</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.indexing.common.TaskToolbox</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TaskToolbox <span class="hljs-title">createMockTaskToolbox</span><span class="hljs-params">(
    String attemptId,
    DruidNode taskExecutorNode,
    TaskLogPusher taskLogPusher,
    TaskConfig config,
    ObjectMapper objectMapper,
    TaskActionClient taskActionClient
)</span> </span>{
    TaskToolbox toolbox = mock(TaskToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(toolbox.getAttemptId()).thenReturn(attemptId);
    when(toolbox.getTaskExecutorNode()).thenReturn(taskExecutorNode);
    when(toolbox.getTaskLogPusher()).thenReturn(taskLogPusher);
    when(toolbox.getConfig()).thenReturn(config);
    when(toolbox.getJsonMapper()).thenReturn(objectMapper);
    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);
    <span class="hljs-keyword">return</span> toolbox;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest11">Test Case ID #druid_Test_1_1</h4>
<h4 id="test-case-name-testsetupandcleanupiscalledwtihparameterfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommontaskabstracttasktestjava">Test Case Name: <code>testSetupAndCleanupIsCalledWtihParameter</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\task\AbstractTaskTest.java</code>)</h4>
<h4 id="mock-object-variable-name-toolbox">Mock Object Variable Name: <code>toolbox</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    // These tests apparently use Mockito.  Mockito is bad as we've seen it rewrite byte code and effectively cause
    // impact to other totally unrelated tests.  Mockito needs to be completely erradicated from the codebase.  This
    // comment is here to either cause me to do it in this commit or just for posterity so that it is clear that it
    // should happen in the future.
<span class="hljs-deletion">-    TaskToolbox toolbox = mock(TaskToolbox.class);</span>
<span class="hljs-deletion">-    when(toolbox.getAttemptId()).thenReturn("1");</span>
<span class="hljs-addition">+    DruidNode node = new DruidNode("foo", "foo", false, 1, 2, true, true);</span>
<span class="hljs-addition">+    TaskLogPusher pusher = mock(TaskLogPusher.class);</span>
<span class="hljs-addition">+    TaskConfig config = mock(TaskConfig.class);</span>
<span class="hljs-addition">+    when(config.isEncapsulatedTask()).thenReturn(true);</span>
<span class="hljs-addition">+    File folder = temporaryFolder.newFolder();</span>
<span class="hljs-addition">+    when(config.getTaskDir(eq("myID"))).thenReturn(folder);</span>
<span class="hljs-addition">+    TaskActionClient taskActionClient = mock(TaskActionClient.class);</span>
<span class="hljs-addition">+    when(taskActionClient.submit(any())).thenReturn(TaskConfig.class);</span>
<span class="hljs-addition">+    TaskToolbox toolbox = createMockTaskToolbox(</span>
<span class="hljs-addition">+        "1",</span>
<span class="hljs-addition">+        node,</span>
<span class="hljs-addition">+        pusher,</span>
<span class="hljs-addition">+        config,</span>
<span class="hljs-addition">+        objectMapper,</span>
<span class="hljs-addition">+        taskActionClient</span>
<span class="hljs-addition">+    );</span>
     DruidNode node = new DruidNode("foo", "foo", false, 1, 2, true, true);
<span class="hljs-deletion">-    when(toolbox.getTaskExecutorNode()).thenReturn(node);</span>
     TaskLogPusher pusher = mock(TaskLogPusher.class);
<span class="hljs-deletion">-    when(toolbox.getTaskLogPusher()).thenReturn(pusher);</span>
     TaskConfig config = mock(TaskConfig.class);
     when(config.isEncapsulatedTask()).thenReturn(true);
     File folder = temporaryFolder.newFolder();
     when(config.getTaskDir(eq("myID"))).thenReturn(folder);
<span class="hljs-deletion">-    when(toolbox.getConfig()).thenReturn(config);</span>
<span class="hljs-deletion">-    when(toolbox.getJsonMapper()).thenReturn(objectMapper);</span>
     TaskActionClient taskActionClient = mock(TaskActionClient.class);
     when(taskActionClient.submit(any())).thenReturn(TaskConfig.class);
<span class="hljs-deletion">-    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);</span>
     AbstractTask task = new NoopTask("myID", null, null, 1, 0, null) {

         @Nullable
         @Override
         public String setup(TaskToolbox toolbox) throws Exception {
             // create a reports file to test the taskLogPusher pushes task reports
             String result = super.setup(toolbox);
             File attemptDir = Paths.get(folder.getAbsolutePath(), "attempt", toolbox.getAttemptId()).toFile();
             File reportsDir = new File(attemptDir, "report.json");
             File statusDir = new File(attemptDir, "status.json");
             FileUtils.write(reportsDir, "foo", StandardCharsets.UTF_8);
             FileUtils.write(statusDir, "{}", StandardCharsets.UTF_8);
             return result;
         }
     };
     task.run(toolbox);
     // call it 3 times, once to update location in setup, then one for status and location in cleanup
     Mockito.verify(taskActionClient, times(3)).submit(any());
     verify(pusher, times(1)).pushTaskReports(eq("myID"), any());
     verify(pusher, times(1)).pushTaskStatus(eq("myID"), any());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSetupAndCleanupIsCalledWtihParameter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-comment">// These tests apparently use Mockito.  Mockito is bad as we've seen it rewrite byte code and effectively cause</span>

    <span class="hljs-comment">// impact to other totally unrelated tests.  Mockito needs to be completely erradicated from the codebase.  This</span>

    <span class="hljs-comment">// comment is here to either cause me to do it in this commit or just for posterity so that it is clear that it</span>

    <span class="hljs-comment">// should happen in the future.</span>

    TaskToolbox toolbox = mock(TaskToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getAttemptId()).thenReturn(<span class="hljs-string">"1"</span>);

    DruidNode node = <span class="hljs-keyword">new</span> DruidNode(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>);

    when(toolbox.getTaskExecutorNode()).thenReturn(node);

    TaskLogPusher pusher = mock(TaskLogPusher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskLogPusher()).thenReturn(pusher);

    TaskConfig config = mock(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(config.isEncapsulatedTask()).thenReturn(<span class="hljs-keyword">true</span>);

    File folder = temporaryFolder.newFolder();

    when(config.getTaskDir(eq(<span class="hljs-string">"myID"</span>))).thenReturn(folder);

    when(toolbox.getConfig()).thenReturn(config);

    when(toolbox.getJsonMapper()).thenReturn(objectMapper);

    TaskActionClient taskActionClient = mock(TaskActionClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskActionClient.submit(any())).thenReturn(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);

    AbstractTask task = <span class="hljs-keyword">new</span> NoopTask(<span class="hljs-string">"myID"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>) {



        <span class="hljs-meta">@Nullable</span>

        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">setup</span><span class="hljs-params">(TaskToolbox toolbox)</span> <span class="hljs-keyword">throws</span> Exception </span>{

            <span class="hljs-comment">// create a reports file to test the taskLogPusher pushes task reports</span>

            String result = <span class="hljs-keyword">super</span>.setup(toolbox);

            File attemptDir = Paths.get(folder.getAbsolutePath(), <span class="hljs-string">"attempt"</span>, toolbox.getAttemptId()).toFile();

            File reportsDir = <span class="hljs-keyword">new</span> File(attemptDir, <span class="hljs-string">"report.json"</span>);

            File statusDir = <span class="hljs-keyword">new</span> File(attemptDir, <span class="hljs-string">"status.json"</span>);

            FileUtils.write(reportsDir, <span class="hljs-string">"foo"</span>, StandardCharsets.UTF_8);

            FileUtils.write(statusDir, <span class="hljs-string">"{}"</span>, StandardCharsets.UTF_8);

            <span class="hljs-keyword">return</span> result;

        }

    };

    task.run(toolbox);

    <span class="hljs-comment">// call it 3 times, once to update location in setup, then one for status and location in cleanup</span>

    Mockito.verify(taskActionClient, times(<span class="hljs-number">3</span>)).submit(any());

    verify(pusher, times(<span class="hljs-number">1</span>)).pushTaskReports(eq(<span class="hljs-string">"myID"</span>), any());

    verify(pusher, times(<span class="hljs-number">1</span>)).pushTaskStatus(eq(<span class="hljs-string">"myID"</span>), any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TaskToolbox <span class="hljs-title">createMockTaskToolbox</span><span class="hljs-params">(
    String attemptId,
    DruidNode taskExecutorNode,
    TaskLogPusher taskLogPusher,
    TaskConfig config,
    ObjectMapper objectMapper,
    TaskActionClient taskActionClient
)</span> </span>{
    TaskToolbox toolbox = mock(TaskToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(toolbox.getAttemptId()).thenReturn(attemptId);
    when(toolbox.getTaskExecutorNode()).thenReturn(taskExecutorNode);
    when(toolbox.getTaskLogPusher()).thenReturn(taskLogPusher);
    when(toolbox.getConfig()).thenReturn(config);
    when(toolbox.getJsonMapper()).thenReturn(objectMapper);
    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);
    <span class="hljs-keyword">return</span> toolbox;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest12">Test Case ID #druid_Test_1_2</h4>
<h4 id="test-case-name-testwithnoencapsulatedtaskfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommontaskabstracttasktestjava">Test Case Name: <code>testWithNoEncapsulatedTask</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\task\AbstractTaskTest.java</code>)</h4>
<h4 id="mock-object-variable-name-toolbox">Mock Object Variable Name: <code>toolbox</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testWithNoEncapsulatedTask() throws Exception {
<span class="hljs-deletion">-    TaskToolbox toolbox = mock(TaskToolbox.class);</span>
<span class="hljs-deletion">-    when(toolbox.getAttemptId()).thenReturn("1");</span>
     DruidNode node = new DruidNode("foo", "foo", false, 1, 2, true, true);
     when(toolbox.getTaskExecutorNode()).thenReturn(node);
     TaskLogPusher pusher = mock(TaskLogPusher.class);
     when(toolbox.getTaskLogPusher()).thenReturn(pusher);
     TaskConfig config = mock(TaskConfig.class);
     when(config.isEncapsulatedTask()).thenReturn(false);
     File folder = temporaryFolder.newFolder();
     when(config.getTaskDir(eq("myID"))).thenReturn(folder);
<span class="hljs-addition">+    TaskToolbox toolbox = createMockTaskToolbox(</span>
<span class="hljs-addition">+        "1",</span>
<span class="hljs-addition">+        node,</span>
<span class="hljs-addition">+        pusher,</span>
<span class="hljs-addition">+        config,</span>
<span class="hljs-addition">+        objectMapper,</span>
<span class="hljs-addition">+        taskActionClient</span>
<span class="hljs-addition">+    );</span>
     when(toolbox.getConfig()).thenReturn(config);
     when(toolbox.getJsonMapper()).thenReturn(objectMapper);
     TaskActionClient taskActionClient = mock(TaskActionClient.class);
     when(taskActionClient.submit(any())).thenReturn(TaskConfig.class);
     when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);
     AbstractTask task = new NoopTask("myID", null, null, 1, 0, null) {

         @Nullable
         @Override
         public String setup(TaskToolbox toolbox) throws Exception {
             // create a reports file to test the taskLogPusher pushes task reports
             String result = super.setup(toolbox);
             File attemptDir = Paths.get(folder.getAbsolutePath(), "attempt", toolbox.getAttemptId()).toFile();
             File reportsDir = new File(attemptDir, "report.json");
             FileUtils.write(reportsDir, "foo", StandardCharsets.UTF_8);
             return result;
         }
     };
     task.run(toolbox);
     // encapsulated task is set to false, should never get called
     Mockito.verify(taskActionClient, never()).submit(any());
     verify(pusher, never()).pushTaskReports(eq("myID"), any());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testWithNoEncapsulatedTask</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TaskToolbox toolbox = mock(TaskToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getAttemptId()).thenReturn(<span class="hljs-string">"1"</span>);

    DruidNode node = <span class="hljs-keyword">new</span> DruidNode(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>);

    when(toolbox.getTaskExecutorNode()).thenReturn(node);

    TaskLogPusher pusher = mock(TaskLogPusher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskLogPusher()).thenReturn(pusher);

    TaskConfig config = mock(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(config.isEncapsulatedTask()).thenReturn(<span class="hljs-keyword">false</span>);

    File folder = temporaryFolder.newFolder();

    when(config.getTaskDir(eq(<span class="hljs-string">"myID"</span>))).thenReturn(folder);

    when(toolbox.getConfig()).thenReturn(config);

    when(toolbox.getJsonMapper()).thenReturn(objectMapper);

    TaskActionClient taskActionClient = mock(TaskActionClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskActionClient.submit(any())).thenReturn(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);

    AbstractTask task = <span class="hljs-keyword">new</span> NoopTask(<span class="hljs-string">"myID"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>) {



        <span class="hljs-meta">@Nullable</span>

        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">setup</span><span class="hljs-params">(TaskToolbox toolbox)</span> <span class="hljs-keyword">throws</span> Exception </span>{

            <span class="hljs-comment">// create a reports file to test the taskLogPusher pushes task reports</span>

            String result = <span class="hljs-keyword">super</span>.setup(toolbox);

            File attemptDir = Paths.get(folder.getAbsolutePath(), <span class="hljs-string">"attempt"</span>, toolbox.getAttemptId()).toFile();

            File reportsDir = <span class="hljs-keyword">new</span> File(attemptDir, <span class="hljs-string">"report.json"</span>);

            FileUtils.write(reportsDir, <span class="hljs-string">"foo"</span>, StandardCharsets.UTF_8);

            <span class="hljs-keyword">return</span> result;

        }

    };

    task.run(toolbox);

    <span class="hljs-comment">// encapsulated task is set to false, should never get called</span>

    Mockito.verify(taskActionClient, never()).submit(any());

    verify(pusher, never()).pushTaskReports(eq(<span class="hljs-string">"myID"</span>), any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TaskToolbox <span class="hljs-title">createMockTaskToolbox</span><span class="hljs-params">(
    String attemptId,
    DruidNode taskExecutorNode,
    TaskLogPusher taskLogPusher,
    TaskConfig config,
    ObjectMapper objectMapper,
    TaskActionClient taskActionClient
)</span> </span>{
    TaskToolbox toolbox = mock(TaskToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(toolbox.getAttemptId()).thenReturn(attemptId);
    when(toolbox.getTaskExecutorNode()).thenReturn(taskExecutorNode);
    when(toolbox.getTaskLogPusher()).thenReturn(taskLogPusher);
    when(toolbox.getConfig()).thenReturn(config);
    when(toolbox.getJsonMapper()).thenReturn(objectMapper);
    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);
    <span class="hljs-keyword">return</span> toolbox;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest13">Test Case ID #druid_Test_1_3</h4>
<h4 id="test-case-name-testtaskfailurewithoutexceptiongetsreportedcorrectlyfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommontaskabstracttasktestjava">Test Case Name: <code>testTaskFailureWithoutExceptionGetsReportedCorrectly</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\task\AbstractTaskTest.java</code>)</h4>
<h4 id="mock-object-variable-name-toolbox">Mock Object Variable Name: <code>toolbox</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
<span class="hljs-deletion">-    TaskToolbox toolbox = mock(TaskToolbox.class);</span>
<span class="hljs-deletion">-    when(toolbox.getAttemptId()).thenReturn("1");</span>
     DruidNode node = new DruidNode("foo", "foo", false, 1, 2, true, true);
     TaskLogPusher pusher = mock(TaskLogPusher.class);
     when(toolbox.getTaskLogPusher()).thenReturn(pusher);
     TaskConfig config = mock(TaskConfig.class);
     when(config.isEncapsulatedTask()).thenReturn(true);
     File folder = temporaryFolder.newFolder();
     when(config.getTaskDir(eq("myID"))).thenReturn(folder);
<span class="hljs-addition">+    TaskToolbox toolbox = createMockTaskToolbox(</span>
<span class="hljs-addition">+        "1",</span>
<span class="hljs-addition">+        node,</span>
<span class="hljs-addition">+        pusher,</span>
<span class="hljs-addition">+        config,</span>
<span class="hljs-addition">+        objectMapper,</span>
<span class="hljs-addition">+        taskActionClient</span>
<span class="hljs-addition">+    );</span>
     when(toolbox.getConfig()).thenReturn(config);
     when(toolbox.getJsonMapper()).thenReturn(objectMapper);
     TaskActionClient taskActionClient = mock(TaskActionClient.class);
     when(taskActionClient.submit(any())).thenReturn(TaskConfig.class);
     when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);
     AbstractTask task = new NoopTask("myID", null, null, 1, 0, null) {

         @Override
         public TaskStatus runTask(TaskToolbox toolbox) {
             return TaskStatus.failure("myId", "failed");
         }
     };
     task.run(toolbox);
     UpdateStatusAction action = new UpdateStatusAction("failure");
     verify(taskActionClient).submit(eq(action));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testTaskFailureWithoutExceptionGetsReportedCorrectly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TaskToolbox toolbox = mock(TaskToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getAttemptId()).thenReturn(<span class="hljs-string">"1"</span>);

    DruidNode node = <span class="hljs-keyword">new</span> DruidNode(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>);

    when(toolbox.getTaskExecutorNode()).thenReturn(node);

    TaskLogPusher pusher = mock(TaskLogPusher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskLogPusher()).thenReturn(pusher);

    TaskConfig config = mock(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(config.isEncapsulatedTask()).thenReturn(<span class="hljs-keyword">true</span>);

    File folder = temporaryFolder.newFolder();

    when(config.getTaskDir(eq(<span class="hljs-string">"myID"</span>))).thenReturn(folder);

    when(toolbox.getConfig()).thenReturn(config);

    when(toolbox.getJsonMapper()).thenReturn(objectMapper);

    TaskActionClient taskActionClient = mock(TaskActionClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskActionClient.submit(any())).thenReturn(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);

    AbstractTask task = <span class="hljs-keyword">new</span> NoopTask(<span class="hljs-string">"myID"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>) {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> TaskStatus <span class="hljs-title">runTask</span><span class="hljs-params">(TaskToolbox toolbox)</span> </span>{

            <span class="hljs-keyword">return</span> TaskStatus.failure(<span class="hljs-string">"myId"</span>, <span class="hljs-string">"failed"</span>);

        }

    };

    task.run(toolbox);

    UpdateStatusAction action = <span class="hljs-keyword">new</span> UpdateStatusAction(<span class="hljs-string">"failure"</span>);

    verify(taskActionClient).submit(eq(action));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TaskToolbox <span class="hljs-title">createMockTaskToolbox</span><span class="hljs-params">(
    String attemptId,
    DruidNode taskExecutorNode,
    TaskLogPusher taskLogPusher,
    TaskConfig config,
    ObjectMapper objectMapper,
    TaskActionClient taskActionClient
)</span> </span>{
    TaskToolbox toolbox = mock(TaskToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(toolbox.getAttemptId()).thenReturn(attemptId);
    when(toolbox.getTaskExecutorNode()).thenReturn(taskExecutorNode);
    when(toolbox.getTaskLogPusher()).thenReturn(taskLogPusher);
    when(toolbox.getConfig()).thenReturn(config);
    when(toolbox.getJsonMapper()).thenReturn(objectMapper);
    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);
    <span class="hljs-keyword">return</span> toolbox;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci2">Mock Clone Instance #druid_MCI_2</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.query.filter.ColumnIndexSelector</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockColumnIndexSelector</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ColumnIndexSelector <span class="hljs-title">createMockColumnIndexSelector</span><span class="hljs-params">(String columnName, ColumnIndexSupplier indexSupplier)</span> </span>{
    ColumnIndexSelector indexSelector = Mockito.mock(ColumnIndexSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(indexSelector.getIndexSupplier(columnName)).thenReturn(indexSupplier);
    <span class="hljs-keyword">return</span> indexSelector;
  }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest21">Test Case ID #druid_Test_2_1</h4>
<h4 id="test-case-name-testusesutf8setindexfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidqueryfilterindimfiltertestjava">Test Case Name: <code>testUsesUtf8SetIndex</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\filter\InDimFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-indexselector">Mock Object Variable Name: <code>indexSelector</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final Filter inFilter = new InDimFilter("dim0", ImmutableSet.of("v1", "v2")).toFilter();
<span class="hljs-deletion">-    final ColumnIndexSelector indexSelector = Mockito.mock(ColumnIndexSelector.class);</span>
<span class="hljs-addition">+    final ColumnIndexSelector indexSelector = MockColumnIndexSelector.createMockColumnIndexSelector("dim0", indexSupplier);</span>
    final ColumnIndexSupplier indexSupplier = Mockito.mock(ColumnIndexSupplier.class);
    final Utf8ValueSetIndexes valueIndexes = Mockito.mock(Utf8ValueSetIndexes.class);
    final BitmapColumnIndex bitmapColumnIndex = Mockito.mock(BitmapColumnIndex.class);
    final InDimFilter.ValuesSet expectedValuesSet = new InDimFilter.ValuesSet();
    expectedValuesSet.addAll(Arrays.asList("v1", "v2"));
<span class="hljs-deletion">-    Mockito.when(indexSelector.getIndexSupplier("dim0")).thenReturn(indexSupplier);</span>
    Mockito.when(indexSupplier.as(Utf8ValueSetIndexes.class)).thenReturn(valueIndexes);
    Mockito.when(valueIndexes.forSortedValuesUtf8(expectedValuesSet.toUtf8())).thenReturn(bitmapColumnIndex);
    final BitmapColumnIndex retVal = inFilter.getBitmapColumnIndex(indexSelector);
    Assert.assertSame("inFilter returns the intended bitmapColumnIndex", bitmapColumnIndex, retVal);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testUsesUtf8SetIndex</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// An implementation test.</span>

    <span class="hljs-comment">// This test confirms that "in" filters use utf8 index lookups when available.</span>

    <span class="hljs-keyword">final</span> Filter inFilter = <span class="hljs-keyword">new</span> InDimFilter(<span class="hljs-string">"dim0"</span>, ImmutableSet.of(<span class="hljs-string">"v1"</span>, <span class="hljs-string">"v2"</span>)).toFilter();

    <span class="hljs-keyword">final</span> ColumnIndexSelector indexSelector = Mockito.mock(ColumnIndexSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ColumnIndexSupplier indexSupplier = Mockito.mock(ColumnIndexSupplier<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Utf8ValueSetIndexes valueIndexes = Mockito.mock(Utf8ValueSetIndexes<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> BitmapColumnIndex bitmapColumnIndex = Mockito.mock(BitmapColumnIndex<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> InDimFilter.ValuesSet expectedValuesSet = <span class="hljs-keyword">new</span> InDimFilter.ValuesSet();

    expectedValuesSet.addAll(Arrays.asList(<span class="hljs-string">"v1"</span>, <span class="hljs-string">"v2"</span>));

    Mockito.when(indexSelector.getIndexSupplier(<span class="hljs-string">"dim0"</span>)).thenReturn(indexSupplier);

    Mockito.when(indexSupplier.as(Utf8ValueSetIndexes<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">valueIndexes</span>)</span>;

    Mockito.when(valueIndexes.forSortedValuesUtf8(expectedValuesSet.toUtf8())).thenReturn(bitmapColumnIndex);

    <span class="hljs-keyword">final</span> BitmapColumnIndex retVal = inFilter.getBitmapColumnIndex(indexSelector);

    Assert.assertSame(<span class="hljs-string">"inFilter returns the intended bitmapColumnIndex"</span>, bitmapColumnIndex, retVal);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockColumnIndexSelector</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ColumnIndexSelector <span class="hljs-title">createMockColumnIndexSelector</span><span class="hljs-params">(String columnName, ColumnIndexSupplier indexSupplier)</span> </span>{
    ColumnIndexSelector indexSelector = Mockito.mock(ColumnIndexSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(indexSelector.getIndexSupplier(columnName)).thenReturn(indexSupplier);
    <span class="hljs-keyword">return</span> indexSelector;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest22">Test Case ID #druid_Test_2_2</h4>
<h4 id="test-case-name-testusesstringsetindexfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidqueryfilterindimfiltertestjava">Test Case Name: <code>testUsesStringSetIndex</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\filter\InDimFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-indexselector">Mock Object Variable Name: <code>indexSelector</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final Filter inFilter = new InDimFilter("dim0", ImmutableSet.of("v1", "v2")).toFilter();
<span class="hljs-deletion">-    final ColumnIndexSelector indexSelector = Mockito.mock(ColumnIndexSelector.class);</span>
<span class="hljs-addition">+    final ColumnIndexSelector indexSelector = MockColumnIndexSelector.createMockColumnIndexSelector("dim0", indexSupplier);</span>
    final ColumnIndexSupplier indexSupplier = Mockito.mock(ColumnIndexSupplier.class);
    final StringValueSetIndexes valueIndex = Mockito.mock(StringValueSetIndexes.class);
    final BitmapColumnIndex bitmapColumnIndex = Mockito.mock(BitmapColumnIndex.class);
    final InDimFilter.ValuesSet expectedValuesSet = new InDimFilter.ValuesSet();
    expectedValuesSet.addAll(Arrays.asList("v1", "v2"));
<span class="hljs-deletion">-    Mockito.when(indexSelector.getIndexSupplier("dim0")).thenReturn(indexSupplier);</span>
    // Will check for UTF-8 first.
    Mockito.when(indexSupplier.as(Utf8ValueSetIndexes.class)).thenReturn(null);
    Mockito.when(indexSupplier.as(StringValueSetIndexes.class)).thenReturn(valueIndex);
    Mockito.when(valueIndex.forSortedValues(expectedValuesSet)).thenReturn(bitmapColumnIndex);
    final BitmapColumnIndex retVal = inFilter.getBitmapColumnIndex(indexSelector);
    Assert.assertSame("inFilter returns the intended bitmapColumnIndex", bitmapColumnIndex, retVal);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testUsesStringSetIndex</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// An implementation test.</span>

    <span class="hljs-comment">// This test confirms that "in" filters use non-utf8 string index lookups when utf8 indexes are not available.</span>

    <span class="hljs-keyword">final</span> Filter inFilter = <span class="hljs-keyword">new</span> InDimFilter(<span class="hljs-string">"dim0"</span>, ImmutableSet.of(<span class="hljs-string">"v1"</span>, <span class="hljs-string">"v2"</span>)).toFilter();

    <span class="hljs-keyword">final</span> ColumnIndexSelector indexSelector = Mockito.mock(ColumnIndexSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ColumnIndexSupplier indexSupplier = Mockito.mock(ColumnIndexSupplier<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> StringValueSetIndexes valueIndex = Mockito.mock(StringValueSetIndexes<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> BitmapColumnIndex bitmapColumnIndex = Mockito.mock(BitmapColumnIndex<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> InDimFilter.ValuesSet expectedValuesSet = <span class="hljs-keyword">new</span> InDimFilter.ValuesSet();

    expectedValuesSet.addAll(Arrays.asList(<span class="hljs-string">"v1"</span>, <span class="hljs-string">"v2"</span>));

    Mockito.when(indexSelector.getIndexSupplier(<span class="hljs-string">"dim0"</span>)).thenReturn(indexSupplier);

    <span class="hljs-comment">// Will check for UTF-8 first.</span>

    Mockito.when(indexSupplier.as(Utf8ValueSetIndexes<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">null</span>)</span>;

    Mockito.when(indexSupplier.as(StringValueSetIndexes<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">valueIndex</span>)</span>;

    Mockito.when(valueIndex.forSortedValues(expectedValuesSet)).thenReturn(bitmapColumnIndex);

    <span class="hljs-keyword">final</span> BitmapColumnIndex retVal = inFilter.getBitmapColumnIndex(indexSelector);

    Assert.assertSame(<span class="hljs-string">"inFilter returns the intended bitmapColumnIndex"</span>, bitmapColumnIndex, retVal);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockColumnIndexSelector</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ColumnIndexSelector <span class="hljs-title">createMockColumnIndexSelector</span><span class="hljs-params">(String columnName, ColumnIndexSupplier indexSupplier)</span> </span>{
    ColumnIndexSelector indexSelector = Mockito.mock(ColumnIndexSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(indexSelector.getIndexSupplier(columnName)).thenReturn(indexSupplier);
    <span class="hljs-keyword">return</span> indexSelector;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest23">Test Case ID #druid_Test_2_3</h4>
<h4 id="test-case-name-testprefixmatchusesrangeindexfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidqueryfilterlikedimfiltertestjava">Test Case Name: <code>testPrefixMatchUsesRangeIndex</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\filter\LikeDimFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-indexselector">Mock Object Variable Name: <code>indexSelector</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final Filter likeFilter = new LikeDimFilter("dim0", "f%", null, null, null).toFilter();
<span class="hljs-deletion">-    final ColumnIndexSelector indexSelector = Mockito.mock(ColumnIndexSelector.class);</span>
<span class="hljs-addition">+    final ColumnIndexSelector indexSelector = MockColumnIndexSelector.createMockColumnIndexSelector("dim0", indexSupplier);</span>
    final ColumnIndexSupplier indexSupplier = Mockito.mock(ColumnIndexSupplier.class);
    final LexicographicalRangeIndexes rangeIndex = Mockito.mock(LexicographicalRangeIndexes.class);
    final BitmapColumnIndex bitmapColumnIndex = Mockito.mock(BitmapColumnIndex.class);
<span class="hljs-deletion">-    Mockito.when(indexSelector.getIndexSupplier("dim0")).thenReturn(indexSupplier);</span>
    Mockito.when(indexSupplier.as(LexicographicalRangeIndexes.class)).thenReturn(rangeIndex);
    Mockito.when(// Verify that likeFilter uses forRange without a matcher predicate; it's unnecessary and slows things down
    rangeIndex.forRange("f", false, "f" + Character.MAX_VALUE, false)).thenReturn(bitmapColumnIndex);
    final BitmapColumnIndex retVal = likeFilter.getBitmapColumnIndex(indexSelector);
    Assert.assertSame("likeFilter returns the intended bitmapColumnIndex", bitmapColumnIndex, retVal);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testPrefixMatchUsesRangeIndex</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// An implementation test.</span>

    <span class="hljs-comment">// This test confirms that "like" filters with prefix matchers use index-range lookups without matcher predicates.</span>

    <span class="hljs-keyword">final</span> Filter likeFilter = <span class="hljs-keyword">new</span> LikeDimFilter(<span class="hljs-string">"dim0"</span>, <span class="hljs-string">"f%"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>).toFilter();

    <span class="hljs-keyword">final</span> ColumnIndexSelector indexSelector = Mockito.mock(ColumnIndexSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ColumnIndexSupplier indexSupplier = Mockito.mock(ColumnIndexSupplier<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> LexicographicalRangeIndexes rangeIndex = Mockito.mock(LexicographicalRangeIndexes<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> BitmapColumnIndex bitmapColumnIndex = Mockito.mock(BitmapColumnIndex<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(indexSelector.getIndexSupplier(<span class="hljs-string">"dim0"</span>)).thenReturn(indexSupplier);

    Mockito.when(indexSupplier.as(LexicographicalRangeIndexes<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">rangeIndex</span>)</span>;

    Mockito.when(<span class="hljs-comment">// Verify that likeFilter uses forRange without a matcher predicate; it's unnecessary and slows things down</span>

    rangeIndex.forRange(<span class="hljs-string">"f"</span>, <span class="hljs-keyword">false</span>, <span class="hljs-string">"f"</span> + Character.MAX_VALUE, <span class="hljs-keyword">false</span>)).thenReturn(bitmapColumnIndex);

    <span class="hljs-keyword">final</span> BitmapColumnIndex retVal = likeFilter.getBitmapColumnIndex(indexSelector);

    Assert.assertSame(<span class="hljs-string">"likeFilter returns the intended bitmapColumnIndex"</span>, bitmapColumnIndex, retVal);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockColumnIndexSelector</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ColumnIndexSelector <span class="hljs-title">createMockColumnIndexSelector</span><span class="hljs-params">(String columnName, ColumnIndexSupplier indexSupplier)</span> </span>{
    ColumnIndexSelector indexSelector = Mockito.mock(ColumnIndexSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(indexSelector.getIndexSupplier(columnName)).thenReturn(indexSupplier);
    <span class="hljs-keyword">return</span> indexSelector;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest24">Test Case ID #druid_Test_2_4</h4>
<h4 id="test-case-name-testexactmatchusesvalueindexfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidqueryfilterlikedimfiltertestjava">Test Case Name: <code>testExactMatchUsesValueIndex</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\filter\LikeDimFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-indexselector">Mock Object Variable Name: <code>indexSelector</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final Filter likeFilter = new LikeDimFilter("dim0", "f", null, null, null).toFilter();
<span class="hljs-deletion">-    final ColumnIndexSelector indexSelector = Mockito.mock(ColumnIndexSelector.class);</span>
<span class="hljs-addition">+    final ColumnIndexSelector indexSelector = MockColumnIndexSelector.createMockColumnIndexSelector("dim0", indexSupplier);</span>
    final ColumnIndexSupplier indexSupplier = Mockito.mock(ColumnIndexSupplier.class);
    final StringValueSetIndexes valueIndex = Mockito.mock(StringValueSetIndexes.class);
    final BitmapColumnIndex bitmapColumnIndex = Mockito.mock(BitmapColumnIndex.class);
<span class="hljs-deletion">-    Mockito.when(indexSelector.getIndexSupplier("dim0")).thenReturn(indexSupplier);</span>
    Mockito.when(indexSupplier.as(StringValueSetIndexes.class)).thenReturn(valueIndex);
    Mockito.when(valueIndex.forValue("f")).thenReturn(bitmapColumnIndex);
    final BitmapColumnIndex retVal = likeFilter.getBitmapColumnIndex(indexSelector);
    Assert.assertSame("likeFilter returns the intended bitmapColumnIndex", bitmapColumnIndex, retVal);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testExactMatchUsesValueIndex</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// An implementation test.</span>

    <span class="hljs-comment">// This test confirms that "like" filters with exact matchers use index lookups.</span>

    <span class="hljs-keyword">final</span> Filter likeFilter = <span class="hljs-keyword">new</span> LikeDimFilter(<span class="hljs-string">"dim0"</span>, <span class="hljs-string">"f"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>).toFilter();

    <span class="hljs-keyword">final</span> ColumnIndexSelector indexSelector = Mockito.mock(ColumnIndexSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ColumnIndexSupplier indexSupplier = Mockito.mock(ColumnIndexSupplier<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> StringValueSetIndexes valueIndex = Mockito.mock(StringValueSetIndexes<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> BitmapColumnIndex bitmapColumnIndex = Mockito.mock(BitmapColumnIndex<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(indexSelector.getIndexSupplier(<span class="hljs-string">"dim0"</span>)).thenReturn(indexSupplier);

    Mockito.when(indexSupplier.as(StringValueSetIndexes<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">valueIndex</span>)</span>;

    Mockito.when(valueIndex.forValue(<span class="hljs-string">"f"</span>)).thenReturn(bitmapColumnIndex);

    <span class="hljs-keyword">final</span> BitmapColumnIndex retVal = likeFilter.getBitmapColumnIndex(indexSelector);

    Assert.assertSame(<span class="hljs-string">"likeFilter returns the intended bitmapColumnIndex"</span>, bitmapColumnIndex, retVal);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockColumnIndexSelector</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ColumnIndexSelector <span class="hljs-title">createMockColumnIndexSelector</span><span class="hljs-params">(String columnName, ColumnIndexSupplier indexSupplier)</span> </span>{
    ColumnIndexSelector indexSelector = Mockito.mock(ColumnIndexSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(indexSelector.getIndexSupplier(columnName)).thenReturn(indexSupplier);
    <span class="hljs-keyword">return</span> indexSelector;
  }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci3">Mock Clone Instance #druid_MCI_3</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.indexing.common.config.TaskConfig</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TaskConfig <span class="hljs-title">createMockTaskConfig</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isEncapsulatedTaskReturn, File getTaskDirReturn)</span> </span>{
    TaskConfig config = mock(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(config.isEncapsulatedTask()).thenReturn(isEncapsulatedTaskReturn);
    when(config.getTaskDir(eq(<span class="hljs-string">"myID"</span>))).thenReturn(getTaskDirReturn);
    <span class="hljs-keyword">return</span> config;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest31">Test Case ID #druid_Test_3_1</h4>
<h4 id="test-case-name-testsetupandcleanupiscalledwtihparameterfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommontaskabstracttasktestjava">Test Case Name: <code>testSetupAndCleanupIsCalledWtihParameter</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\task\AbstractTaskTest.java</code>)</h4>
<h4 id="mock-object-variable-name-config">Mock Object Variable Name: <code>config</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(toolbox.getTaskLogPusher()).thenReturn(pusher);
<span class="hljs-deletion">-    TaskConfig config = mock(TaskConfig.class);</span>
<span class="hljs-deletion">-    when(config.isEncapsulatedTask()).thenReturn(true);</span>
    File folder = temporaryFolder.newFolder();
<span class="hljs-deletion">-    when(config.getTaskDir(eq("myID"))).thenReturn(folder);</span>
<span class="hljs-addition">+    TaskConfig config = createMockTaskConfig(true, folder);</span>
    when(toolbox.getConfig()).thenReturn(config);
    when(toolbox.getJsonMapper()).thenReturn(objectMapper);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSetupAndCleanupIsCalledWtihParameter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-comment">// These tests apparently use Mockito.  Mockito is bad as we've seen it rewrite byte code and effectively cause</span>

    <span class="hljs-comment">// impact to other totally unrelated tests.  Mockito needs to be completely erradicated from the codebase.  This</span>

    <span class="hljs-comment">// comment is here to either cause me to do it in this commit or just for posterity so that it is clear that it</span>

    <span class="hljs-comment">// should happen in the future.</span>

    TaskToolbox toolbox = mock(TaskToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getAttemptId()).thenReturn(<span class="hljs-string">"1"</span>);

    DruidNode node = <span class="hljs-keyword">new</span> DruidNode(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>);

    when(toolbox.getTaskExecutorNode()).thenReturn(node);

    TaskLogPusher pusher = mock(TaskLogPusher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskLogPusher()).thenReturn(pusher);

    TaskConfig config = mock(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(config.isEncapsulatedTask()).thenReturn(<span class="hljs-keyword">true</span>);

    File folder = temporaryFolder.newFolder();

    when(config.getTaskDir(eq(<span class="hljs-string">"myID"</span>))).thenReturn(folder);

    when(toolbox.getConfig()).thenReturn(config);

    when(toolbox.getJsonMapper()).thenReturn(objectMapper);

    TaskActionClient taskActionClient = mock(TaskActionClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskActionClient.submit(any())).thenReturn(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);

    AbstractTask task = <span class="hljs-keyword">new</span> NoopTask(<span class="hljs-string">"myID"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>) {



        <span class="hljs-meta">@Nullable</span>

        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">setup</span><span class="hljs-params">(TaskToolbox toolbox)</span> <span class="hljs-keyword">throws</span> Exception </span>{

            <span class="hljs-comment">// create a reports file to test the taskLogPusher pushes task reports</span>

            String result = <span class="hljs-keyword">super</span>.setup(toolbox);

            File attemptDir = Paths.get(folder.getAbsolutePath(), <span class="hljs-string">"attempt"</span>, toolbox.getAttemptId()).toFile();

            File reportsDir = <span class="hljs-keyword">new</span> File(attemptDir, <span class="hljs-string">"report.json"</span>);

            File statusDir = <span class="hljs-keyword">new</span> File(attemptDir, <span class="hljs-string">"status.json"</span>);

            FileUtils.write(reportsDir, <span class="hljs-string">"foo"</span>, StandardCharsets.UTF_8);

            FileUtils.write(statusDir, <span class="hljs-string">"{}"</span>, StandardCharsets.UTF_8);

            <span class="hljs-keyword">return</span> result;

        }

    };

    task.run(toolbox);

    <span class="hljs-comment">// call it 3 times, once to update location in setup, then one for status and location in cleanup</span>

    Mockito.verify(taskActionClient, times(<span class="hljs-number">3</span>)).submit(any());

    verify(pusher, times(<span class="hljs-number">1</span>)).pushTaskReports(eq(<span class="hljs-string">"myID"</span>), any());

    verify(pusher, times(<span class="hljs-number">1</span>)).pushTaskStatus(eq(<span class="hljs-string">"myID"</span>), any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TaskConfig <span class="hljs-title">createMockTaskConfig</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isEncapsulatedTaskReturn, File getTaskDirReturn)</span> </span>{
    TaskConfig config = mock(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(config.isEncapsulatedTask()).thenReturn(isEncapsulatedTaskReturn);
    when(config.getTaskDir(eq(<span class="hljs-string">"myID"</span>))).thenReturn(getTaskDirReturn);
    <span class="hljs-keyword">return</span> config;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest32">Test Case ID #druid_Test_3_2</h4>
<h4 id="test-case-name-testwithnoencapsulatedtaskfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommontaskabstracttasktestjava">Test Case Name: <code>testWithNoEncapsulatedTask</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\task\AbstractTaskTest.java</code>)</h4>
<h4 id="mock-object-variable-name-config">Mock Object Variable Name: <code>config</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    TaskLogPusher pusher = mock(TaskLogPusher.class);
    when(toolbox.getTaskLogPusher()).thenReturn(pusher);
<span class="hljs-deletion">-    TaskConfig config = mock(TaskConfig.class);</span>
<span class="hljs-deletion">-    when(config.isEncapsulatedTask()).thenReturn(false);</span>
    File folder = temporaryFolder.newFolder();
<span class="hljs-deletion">-    when(config.getTaskDir(eq("myID"))).thenReturn(folder);</span>
<span class="hljs-addition">+    TaskConfig config = createMockTaskConfig(false, folder);</span>
    when(toolbox.getConfig()).thenReturn(config);
    when(toolbox.getJsonMapper()).thenReturn(objectMapper);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testWithNoEncapsulatedTask</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TaskToolbox toolbox = mock(TaskToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getAttemptId()).thenReturn(<span class="hljs-string">"1"</span>);

    DruidNode node = <span class="hljs-keyword">new</span> DruidNode(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>);

    when(toolbox.getTaskExecutorNode()).thenReturn(node);

    TaskLogPusher pusher = mock(TaskLogPusher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskLogPusher()).thenReturn(pusher);

    TaskConfig config = mock(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(config.isEncapsulatedTask()).thenReturn(<span class="hljs-keyword">false</span>);

    File folder = temporaryFolder.newFolder();

    when(config.getTaskDir(eq(<span class="hljs-string">"myID"</span>))).thenReturn(folder);

    when(toolbox.getConfig()).thenReturn(config);

    when(toolbox.getJsonMapper()).thenReturn(objectMapper);

    TaskActionClient taskActionClient = mock(TaskActionClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskActionClient.submit(any())).thenReturn(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);

    AbstractTask task = <span class="hljs-keyword">new</span> NoopTask(<span class="hljs-string">"myID"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>) {



        <span class="hljs-meta">@Nullable</span>

        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">setup</span><span class="hljs-params">(TaskToolbox toolbox)</span> <span class="hljs-keyword">throws</span> Exception </span>{

            <span class="hljs-comment">// create a reports file to test the taskLogPusher pushes task reports</span>

            String result = <span class="hljs-keyword">super</span>.setup(toolbox);

            File attemptDir = Paths.get(folder.getAbsolutePath(), <span class="hljs-string">"attempt"</span>, toolbox.getAttemptId()).toFile();

            File reportsDir = <span class="hljs-keyword">new</span> File(attemptDir, <span class="hljs-string">"report.json"</span>);

            FileUtils.write(reportsDir, <span class="hljs-string">"foo"</span>, StandardCharsets.UTF_8);

            <span class="hljs-keyword">return</span> result;

        }

    };

    task.run(toolbox);

    <span class="hljs-comment">// encapsulated task is set to false, should never get called</span>

    Mockito.verify(taskActionClient, never()).submit(any());

    verify(pusher, never()).pushTaskReports(eq(<span class="hljs-string">"myID"</span>), any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TaskConfig <span class="hljs-title">createMockTaskConfig</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isEncapsulatedTaskReturn, File getTaskDirReturn)</span> </span>{
    TaskConfig config = mock(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(config.isEncapsulatedTask()).thenReturn(isEncapsulatedTaskReturn);
    when(config.getTaskDir(eq(<span class="hljs-string">"myID"</span>))).thenReturn(getTaskDirReturn);
    <span class="hljs-keyword">return</span> config;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest33">Test Case ID #druid_Test_3_3</h4>
<h4 id="test-case-name-testtaskfailurewithoutexceptiongetsreportedcorrectlyfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommontaskabstracttasktestjava">Test Case Name: <code>testTaskFailureWithoutExceptionGetsReportedCorrectly</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\task\AbstractTaskTest.java</code>)</h4>
<h4 id="mock-object-variable-name-config">Mock Object Variable Name: <code>config</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    TaskLogPusher pusher = mock(TaskLogPusher.class);
    when(toolbox.getTaskLogPusher()).thenReturn(pusher);
<span class="hljs-deletion">-    TaskConfig config = mock(TaskConfig.class);</span>
<span class="hljs-deletion">-    when(config.isEncapsulatedTask()).thenReturn(true);</span>
    File folder = temporaryFolder.newFolder();
<span class="hljs-deletion">-    when(config.getTaskDir(eq("myID"))).thenReturn(folder);</span>
<span class="hljs-addition">+    TaskConfig config = createMockTaskConfig(true, folder);</span>
    when(toolbox.getConfig()).thenReturn(config);
    when(toolbox.getJsonMapper()).thenReturn(objectMapper);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testTaskFailureWithoutExceptionGetsReportedCorrectly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TaskToolbox toolbox = mock(TaskToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getAttemptId()).thenReturn(<span class="hljs-string">"1"</span>);

    DruidNode node = <span class="hljs-keyword">new</span> DruidNode(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>);

    when(toolbox.getTaskExecutorNode()).thenReturn(node);

    TaskLogPusher pusher = mock(TaskLogPusher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskLogPusher()).thenReturn(pusher);

    TaskConfig config = mock(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(config.isEncapsulatedTask()).thenReturn(<span class="hljs-keyword">true</span>);

    File folder = temporaryFolder.newFolder();

    when(config.getTaskDir(eq(<span class="hljs-string">"myID"</span>))).thenReturn(folder);

    when(toolbox.getConfig()).thenReturn(config);

    when(toolbox.getJsonMapper()).thenReturn(objectMapper);

    TaskActionClient taskActionClient = mock(TaskActionClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskActionClient.submit(any())).thenReturn(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);

    AbstractTask task = <span class="hljs-keyword">new</span> NoopTask(<span class="hljs-string">"myID"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>) {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> TaskStatus <span class="hljs-title">runTask</span><span class="hljs-params">(TaskToolbox toolbox)</span> </span>{

            <span class="hljs-keyword">return</span> TaskStatus.failure(<span class="hljs-string">"myId"</span>, <span class="hljs-string">"failed"</span>);

        }

    };

    task.run(toolbox);

    UpdateStatusAction action = <span class="hljs-keyword">new</span> UpdateStatusAction(<span class="hljs-string">"failure"</span>);

    verify(taskActionClient).submit(eq(action));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TaskConfig <span class="hljs-title">createMockTaskConfig</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isEncapsulatedTaskReturn, File getTaskDirReturn)</span> </span>{
    TaskConfig config = mock(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(config.isEncapsulatedTask()).thenReturn(isEncapsulatedTaskReturn);
    when(config.getTaskDir(eq(<span class="hljs-string">"myID"</span>))).thenReturn(getTaskDirReturn);
    <span class="hljs-keyword">return</span> config;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci4">Mock Clone Instance #druid_MCI_4</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.segment.loading.DataSegmentKiller</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> DataSegmentKiller killer;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    killer = Mockito.mock(DataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
killer

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest41">Test Case ID #druid_Test_4_1</h4>
<h4 id="test-case-name-testkillsegmentwithtypefile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidsegmentloadingomnidatasegmentkillertestjava">Test Case Name: <code>testKillSegmentWithType</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\segment\loading\OmniDataSegmentKillerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-killer">Mock Object Variable Name: <code>killer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testKillSegmentWithType() throws SegmentLoadingException {
<span class="hljs-deletion">-    final DataSegmentKiller killer = Mockito.mock(DataSegmentKiller.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `killer`</span>
     final DataSegment segment = Mockito.mock(DataSegment.class);
     Mockito.when(segment.isTombstone()).thenReturn(false);
     Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of("type", "sane"));
     final Injector injector = createInjector(killer);
     final OmniDataSegmentKiller segmentKiller = injector.getInstance(OmniDataSegmentKiller.class);
     segmentKiller.kill(segment);
<span class="hljs-deletion">-    Mockito.verify(killer, Mockito.times(1)).kill(segment);</span>
<span class="hljs-addition">+    Mockito.verify(killer, Mockito.times(1)).kill(segment);</span>
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testKillSegmentWithType</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SegmentLoadingException </span>{

    <span class="hljs-keyword">final</span> DataSegmentKiller killer = Mockito.mock(DataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(segment.isTombstone()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"sane"</span>));

    <span class="hljs-keyword">final</span> Injector injector = createInjector(killer);

    <span class="hljs-keyword">final</span> OmniDataSegmentKiller segmentKiller = injector.getInstance(OmniDataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    segmentKiller.kill(segment);

    Mockito.verify(killer, Mockito.times(<span class="hljs-number">1</span>)).kill(segment);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> DataSegmentKiller killer;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    killer = Mockito.mock(DataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
killer

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest42">Test Case ID #druid_Test_4_2</h4>
<h4 id="test-case-name-testkillmultiplesegmentswithtypefile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidsegmentloadingomnidatasegmentkillertestjava">Test Case Name: <code>testKillMultipleSegmentsWithType</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\segment\loading\OmniDataSegmentKillerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-killersane">Mock Object Variable Name: <code>killerSane</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testKillMultipleSegmentsWithType() throws SegmentLoadingException {
<span class="hljs-deletion">-    final DataSegmentKiller killerSane = Mockito.mock(DataSegmentKiller.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `killer`</span>
     final DataSegmentKiller killerSaneTwo = Mockito.mock(DataSegmentKiller.class);
     final DataSegment segment1 = Mockito.mock(DataSegment.class);
     final DataSegment segment2 = Mockito.mock(DataSegment.class);
     final DataSegment segment3 = Mockito.mock(DataSegment.class);
     Mockito.when(segment1.isTombstone()).thenReturn(false);
     Mockito.when(segment1.getLoadSpec()).thenReturn(ImmutableMap.of("type", "sane"));
     Mockito.when(segment2.isTombstone()).thenReturn(false);
     Mockito.when(segment2.getLoadSpec()).thenReturn(ImmutableMap.of("type", "sane"));
     Mockito.when(segment3.isTombstone()).thenReturn(false);
     Mockito.when(segment3.getLoadSpec()).thenReturn(ImmutableMap.of("type", "sane_2"));
<span class="hljs-deletion">-    final Injector injector = createInjectorFromMap(ImmutableMap.of("sane", killerSane, "sane_2", killerSaneTwo));</span>
<span class="hljs-addition">+    final Injector injector = createInjectorFromMap(ImmutableMap.of("sane", killer, "sane_2", killerSaneTwo));</span>
     final OmniDataSegmentKiller segmentKiller = injector.getInstance(OmniDataSegmentKiller.class);
     segmentKiller.kill(ImmutableList.of(segment1, segment2, segment3));
<span class="hljs-deletion">-    Mockito.verify(killerSane, Mockito.times(1)).kill((List&lt;DataSegment&gt;) argThat(containsInAnyOrder(segment1, segment2)));</span>
<span class="hljs-addition">+    Mockito.verify(killer, Mockito.times(1)).kill((List&lt;DataSegment&gt;) argThat(containsInAnyOrder(segment1, segment2)));</span>
     Mockito.verify(killerSaneTwo, Mockito.times(1)).kill((List&lt;DataSegment&gt;) argThat(containsInAnyOrder(segment3)));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testKillMultipleSegmentsWithType</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SegmentLoadingException </span>{

    <span class="hljs-keyword">final</span> DataSegmentKiller killerSane = Mockito.mock(DataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegmentKiller killerSaneTwo = Mockito.mock(DataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegment segment1 = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegment segment2 = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegment segment3 = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(segment1.isTombstone()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(segment1.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"sane"</span>));

    Mockito.when(segment2.isTombstone()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(segment2.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"sane"</span>));

    Mockito.when(segment3.isTombstone()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(segment3.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"sane_2"</span>));

    <span class="hljs-keyword">final</span> Injector injector = createInjectorFromMap(ImmutableMap.of(<span class="hljs-string">"sane"</span>, killerSane, <span class="hljs-string">"sane_2"</span>, killerSaneTwo));

    <span class="hljs-keyword">final</span> OmniDataSegmentKiller segmentKiller = injector.getInstance(OmniDataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    segmentKiller.kill(ImmutableList.of(segment1, segment2, segment3));

    Mockito.verify(killerSane, Mockito.times(<span class="hljs-number">1</span>)).kill((List&lt;DataSegment&gt;) argThat(containsInAnyOrder(segment1, segment2)));

    Mockito.verify(killerSaneTwo, Mockito.times(<span class="hljs-number">1</span>)).kill((List&lt;DataSegment&gt;) argThat(containsInAnyOrder(segment3)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> DataSegmentKiller killer;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    killer = Mockito.mock(DataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
killer

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci5">Mock Clone Instance #druid_MCI_5</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.segment.ColumnValueSelector</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockColumnValueSelector</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ColumnValueSelector <span class="hljs-title">createMockColumnValueSelector</span><span class="hljs-params">(Object[] getObjectReturn)</span> </span>{
    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(columnValueSelector.getObject()).thenReturn(getObjectReturn);
    <span class="hljs-keyword">return</span> columnValueSelector;
  }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest51">Test Case ID #druid_Test_5_1</h4>
<h4 id="test-case-name-testaddingindictionarywithobjectsfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaecolumnarraydoublegroupbycolumnselectorstrategytestjava">Test Case Name: <code>testAddingInDictionaryWithObjects</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\column\ArrayDoubleGroupByColumnSelectorStrategyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-columnvalueselector">Mock Object Variable Name: <code>columnValueSelector</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testAddingInDictionaryWithObjects() {
<span class="hljs-deletion">-    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector.class);</span>
<span class="hljs-deletion">-    Mockito.when(columnValueSelector.getObject()).thenReturn(new Object[] { 4.0D, 2.0D });</span>
<span class="hljs-addition">+    ColumnValueSelector columnValueSelector = MockColumnValueSelector.createMockColumnValueSelector(new Object[] { 4.0D, 2.0D });</span>
    Assert.assertEquals(3, strategy.computeDictionaryId(columnValueSelector));
    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus.class);
    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(0);
    ResultRow row = ResultRow.create(1);
    buffer1.putInt(3);
    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, 0);
    Assert.assertEquals(new ComparableList&lt;&gt;(ImmutableList.of(4.0, 2.0)), row.get(0));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAddingInDictionaryWithObjects</span><span class="hljs-params">()</span> </span>{

    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(columnValueSelector.getObject()).thenReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-number">4.0</span>D, <span class="hljs-number">2.0</span>D });

    Assert.assertEquals(<span class="hljs-number">3</span>, strategy.computeDictionaryId(columnValueSelector));

    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);

    ResultRow row = ResultRow.create(<span class="hljs-number">1</span>);

    buffer1.putInt(<span class="hljs-number">3</span>);

    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, <span class="hljs-number">0</span>);

    Assert.assertEquals(<span class="hljs-keyword">new</span> ComparableList&lt;&gt;(ImmutableList.of(<span class="hljs-number">4.0</span>, <span class="hljs-number">2.0</span>)), row.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockColumnValueSelector</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ColumnValueSelector <span class="hljs-title">createMockColumnValueSelector</span><span class="hljs-params">(Object[] getObjectReturn)</span> </span>{
    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(columnValueSelector.getObject()).thenReturn(getObjectReturn);
    <span class="hljs-keyword">return</span> columnValueSelector;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest52">Test Case ID #druid_Test_5_2</h4>
<h4 id="test-case-name-testaddingindictionarywithobjectsfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaecolumnarraylonggroupbycolumnselectorstrategytestjava">Test Case Name: <code>testAddingInDictionaryWithObjects</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\column\ArrayLongGroupByColumnSelectorStrategyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-columnvalueselector">Mock Object Variable Name: <code>columnValueSelector</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testAddingInDictionaryWithObjects() {
<span class="hljs-deletion">-    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector.class);</span>
<span class="hljs-deletion">-    Mockito.when(columnValueSelector.getObject()).thenReturn(new Object[] { 4L, 2L });</span>
<span class="hljs-addition">+    ColumnValueSelector columnValueSelector = MockColumnValueSelector.createMockColumnValueSelector(new Object[] { 4L, 2L });</span>
    Assert.assertEquals(3, strategy.computeDictionaryId(columnValueSelector));
    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus.class);
    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(0);
    ResultRow row = ResultRow.create(1);
    buffer1.putInt(3);
    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, 0);
    Assert.assertEquals(new ComparableList&lt;&gt;(ImmutableList.of(4L, 2L)), row.get(0));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAddingInDictionaryWithObjects</span><span class="hljs-params">()</span> </span>{

    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(columnValueSelector.getObject()).thenReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-number">4L</span>, <span class="hljs-number">2L</span> });

    Assert.assertEquals(<span class="hljs-number">3</span>, strategy.computeDictionaryId(columnValueSelector));

    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);

    ResultRow row = ResultRow.create(<span class="hljs-number">1</span>);

    buffer1.putInt(<span class="hljs-number">3</span>);

    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, <span class="hljs-number">0</span>);

    Assert.assertEquals(<span class="hljs-keyword">new</span> ComparableList&lt;&gt;(ImmutableList.of(<span class="hljs-number">4L</span>, <span class="hljs-number">2L</span>)), row.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockColumnValueSelector</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ColumnValueSelector <span class="hljs-title">createMockColumnValueSelector</span><span class="hljs-params">(Object[] getObjectReturn)</span> </span>{
    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(columnValueSelector.getObject()).thenReturn(getObjectReturn);
    <span class="hljs-keyword">return</span> columnValueSelector;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest53">Test Case ID #druid_Test_5_3</h4>
<h4 id="test-case-name-testaddingindictionarywithobjectsfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaecolumnarraystringgroupbycolumnselectorstrategytestjava">Test Case Name: <code>testAddingInDictionaryWithObjects</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\column\ArrayStringGroupByColumnSelectorStrategyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-columnvalueselector">Mock Object Variable Name: <code>columnValueSelector</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testAddingInDictionaryWithObjects() {
<span class="hljs-deletion">-    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector.class);</span>
<span class="hljs-deletion">-    Mockito.when(columnValueSelector.getObject()).thenReturn(new Object[] { "f", "a" });</span>
<span class="hljs-addition">+    ColumnValueSelector columnValueSelector = MockColumnValueSelector.createMockColumnValueSelector(new Object[] { "f", "a" });</span>
     Assert.assertEquals(3, strategy.computeDictionaryId(columnValueSelector));
     GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus.class);
     Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(0);
     ResultRow row = ResultRow.create(1);
     buffer1.putInt(3);
     strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, 0);
     Assert.assertEquals(ComparableStringArray.of("f", "a"), row.get(0));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAddingInDictionaryWithObjects</span><span class="hljs-params">()</span> </span>{

    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(columnValueSelector.getObject()).thenReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"f"</span>, <span class="hljs-string">"a"</span> });

    Assert.assertEquals(<span class="hljs-number">3</span>, strategy.computeDictionaryId(columnValueSelector));

    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);

    ResultRow row = ResultRow.create(<span class="hljs-number">1</span>);

    buffer1.putInt(<span class="hljs-number">3</span>);

    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, <span class="hljs-number">0</span>);

    Assert.assertEquals(ComparableStringArray.of(<span class="hljs-string">"f"</span>, <span class="hljs-string">"a"</span>), row.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockColumnValueSelector</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ColumnValueSelector <span class="hljs-title">createMockColumnValueSelector</span><span class="hljs-params">(Object[] getObjectReturn)</span> </span>{
    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(columnValueSelector.getObject()).thenReturn(getObjectReturn);
    <span class="hljs-keyword">return</span> columnValueSelector;
  }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci6">Mock Clone Instance #druid_MCI_6</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.segment.ColumnValueSelector</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ColumnValueSelector <span class="hljs-title">createMockColumnValueSelector</span><span class="hljs-params">(List&lt;Double&gt; objectReturn)</span> </span>{
    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.copyOf(objectReturn));
    <span class="hljs-keyword">return</span> columnValueSelector;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest61">Test Case ID #druid_Test_6_1</h4>
<h4 id="test-case-name-testsanityfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaecolumnarraydoublegroupbycolumnselectorstrategytestjava">Test Case Name: <code>testSanity</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\column\ArrayDoubleGroupByColumnSelectorStrategyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-columnvalueselector">Mock Object Variable Name: <code>columnValueSelector</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    @Test
    public void testSanity() {
<span class="hljs-deletion">-    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector.class);</span>
<span class="hljs-deletion">-    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.of(1.0, 2.0));</span>
<span class="hljs-addition">+    ColumnValueSelector columnValueSelector = createMockColumnValueSelector(ImmutableList.of(1.0, 2.0));</span>
    Assert.assertEquals(0, strategy.computeDictionaryId(columnValueSelector));
    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus.class);
    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(0);
    ResultRow row = ResultRow.create(1);
    buffer1.putInt(0);
    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, 0);
    Assert.assertEquals(new ComparableList&lt;&gt;(ImmutableList.of(1.0, 2.0)), row.get(0));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSanity</span><span class="hljs-params">()</span> </span>{

    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.of(<span class="hljs-number">1.0</span>, <span class="hljs-number">2.0</span>));

    Assert.assertEquals(<span class="hljs-number">0</span>, strategy.computeDictionaryId(columnValueSelector));

    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);

    ResultRow row = ResultRow.create(<span class="hljs-number">1</span>);

    buffer1.putInt(<span class="hljs-number">0</span>);

    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, <span class="hljs-number">0</span>);

    Assert.assertEquals(<span class="hljs-keyword">new</span> ComparableList&lt;&gt;(ImmutableList.of(<span class="hljs-number">1.0</span>, <span class="hljs-number">2.0</span>)), row.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ColumnValueSelector <span class="hljs-title">createMockColumnValueSelector</span><span class="hljs-params">(List&lt;Double&gt; objectReturn)</span> </span>{
    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.copyOf(objectReturn));
    <span class="hljs-keyword">return</span> columnValueSelector;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest62">Test Case ID #druid_Test_6_2</h4>
<h4 id="test-case-name-testaddingindictionaryfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaecolumnarraydoublegroupbycolumnselectorstrategytestjava">Test Case Name: <code>testAddingInDictionary</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\column\ArrayDoubleGroupByColumnSelectorStrategyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-columnvalueselector">Mock Object Variable Name: <code>columnValueSelector</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testAddingInDictionary() {
<span class="hljs-deletion">-    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector.class);</span>
<span class="hljs-deletion">-    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.of(4.0, 2.0));</span>
<span class="hljs-addition">+    ColumnValueSelector columnValueSelector = createMockColumnValueSelector(ImmutableList.of(4.0, 2.0));</span>
    Assert.assertEquals(3, strategy.computeDictionaryId(columnValueSelector));
    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus.class);
    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(0);
    ResultRow row = ResultRow.create(1);
    buffer1.putInt(3);
    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, 0);
    Assert.assertEquals(new ComparableList&lt;&gt;(ImmutableList.of(4.0, 2.0)), row.get(0));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAddingInDictionary</span><span class="hljs-params">()</span> </span>{

    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.of(<span class="hljs-number">4.0</span>, <span class="hljs-number">2.0</span>));

    Assert.assertEquals(<span class="hljs-number">3</span>, strategy.computeDictionaryId(columnValueSelector));

    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);

    ResultRow row = ResultRow.create(<span class="hljs-number">1</span>);

    buffer1.putInt(<span class="hljs-number">3</span>);

    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, <span class="hljs-number">0</span>);

    Assert.assertEquals(<span class="hljs-keyword">new</span> ComparableList&lt;&gt;(ImmutableList.of(<span class="hljs-number">4.0</span>, <span class="hljs-number">2.0</span>)), row.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ColumnValueSelector <span class="hljs-title">createMockColumnValueSelector</span><span class="hljs-params">(List&lt;Double&gt; objectReturn)</span> </span>{
    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.copyOf(objectReturn));
    <span class="hljs-keyword">return</span> columnValueSelector;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci7">Mock Clone Instance #druid_MCI_7</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.segment.ColumnValueSelector</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ColumnValueSelector <span class="hljs-title">createMockColumnValueSelector</span><span class="hljs-params">(List&lt;Long&gt; objectReturnList)</span> </span>{
    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.copyOf(objectReturnList));
    <span class="hljs-keyword">return</span> columnValueSelector;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest71">Test Case ID #druid_Test_7_1</h4>
<h4 id="test-case-name-testsanityfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaecolumnarraylonggroupbycolumnselectorstrategytestjava">Test Case Name: <code>testSanity</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\column\ArrayLongGroupByColumnSelectorStrategyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-columnvalueselector">Mock Object Variable Name: <code>columnValueSelector</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testSanity() {
<span class="hljs-deletion">-    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector.class);</span>
<span class="hljs-deletion">-    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.of(1L, 2L));</span>
<span class="hljs-addition">+    ColumnValueSelector columnValueSelector = createMockColumnValueSelector(ImmutableList.of(1L, 2L));</span>
    Assert.assertEquals(0, strategy.computeDictionaryId(columnValueSelector));
    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus.class);
    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(0);
    ResultRow row = ResultRow.create(1);
    buffer1.putInt(0);
    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, 0);
    Assert.assertEquals(new ComparableList&lt;&gt;(ImmutableList.of(1L, 2L)), row.get(0));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSanity</span><span class="hljs-params">()</span> </span>{

    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.of(<span class="hljs-number">1L</span>, <span class="hljs-number">2L</span>));

    Assert.assertEquals(<span class="hljs-number">0</span>, strategy.computeDictionaryId(columnValueSelector));

    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);

    ResultRow row = ResultRow.create(<span class="hljs-number">1</span>);

    buffer1.putInt(<span class="hljs-number">0</span>);

    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, <span class="hljs-number">0</span>);

    Assert.assertEquals(<span class="hljs-keyword">new</span> ComparableList&lt;&gt;(ImmutableList.of(<span class="hljs-number">1L</span>, <span class="hljs-number">2L</span>)), row.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ColumnValueSelector <span class="hljs-title">createMockColumnValueSelector</span><span class="hljs-params">(List&lt;Long&gt; objectReturnList)</span> </span>{
    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.copyOf(objectReturnList));
    <span class="hljs-keyword">return</span> columnValueSelector;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest72">Test Case ID #druid_Test_7_2</h4>
<h4 id="test-case-name-testaddingindictionaryfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaecolumnarraylonggroupbycolumnselectorstrategytestjava">Test Case Name: <code>testAddingInDictionary</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\column\ArrayLongGroupByColumnSelectorStrategyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-columnvalueselector">Mock Object Variable Name: <code>columnValueSelector</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testAddingInDictionary() {
<span class="hljs-deletion">-    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector.class);</span>
<span class="hljs-deletion">-    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.of(4L, 2L));</span>
<span class="hljs-addition">+    ColumnValueSelector columnValueSelector = createMockColumnValueSelector(ImmutableList.of(4L, 2L));</span>
     Assert.assertEquals(3, strategy.computeDictionaryId(columnValueSelector));
     GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus.class);
     Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(0);
     ResultRow row = ResultRow.create(1);
     buffer1.putInt(3);
     strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, 0);
     Assert.assertEquals(new ComparableList&lt;&gt;(ImmutableList.of(4L, 2L)), row.get(0));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAddingInDictionary</span><span class="hljs-params">()</span> </span>{

    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.of(<span class="hljs-number">4L</span>, <span class="hljs-number">2L</span>));

    Assert.assertEquals(<span class="hljs-number">3</span>, strategy.computeDictionaryId(columnValueSelector));

    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);

    ResultRow row = ResultRow.create(<span class="hljs-number">1</span>);

    buffer1.putInt(<span class="hljs-number">3</span>);

    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, <span class="hljs-number">0</span>);

    Assert.assertEquals(<span class="hljs-keyword">new</span> ComparableList&lt;&gt;(ImmutableList.of(<span class="hljs-number">4L</span>, <span class="hljs-number">2L</span>)), row.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ColumnValueSelector <span class="hljs-title">createMockColumnValueSelector</span><span class="hljs-params">(List&lt;Long&gt; objectReturnList)</span> </span>{
    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.copyOf(objectReturnList));
    <span class="hljs-keyword">return</span> columnValueSelector;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci8">Mock Clone Instance #druid_MCI_8</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.segment.ColumnValueSelector</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ColumnValueSelector <span class="hljs-title">createMockColumnValueSelector</span><span class="hljs-params">(ImmutableList&lt;String&gt; objectReturn)</span> </span>{
    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(columnValueSelector.getObject()).thenReturn(objectReturn);
    <span class="hljs-keyword">return</span> columnValueSelector;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest81">Test Case ID #druid_Test_8_1</h4>
<h4 id="test-case-name-testsanityfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaecolumnarraystringgroupbycolumnselectorstrategytestjava">Test Case Name: <code>testSanity</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\column\ArrayStringGroupByColumnSelectorStrategyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-columnvalueselector">Mock Object Variable Name: <code>columnValueSelector</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testSanity() {
<span class="hljs-deletion">-    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector.class);</span>
<span class="hljs-deletion">-    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.of("a", "b"));</span>
<span class="hljs-addition">+    ColumnValueSelector columnValueSelector = createMockColumnValueSelector(ImmutableList.of("a", "b"));</span>
     Assert.assertEquals(0, strategy.computeDictionaryId(columnValueSelector));
     GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus.class);
     Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(0);
     ResultRow row = ResultRow.create(1);
     buffer1.putInt(0);
     strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, 0);
     Assert.assertEquals(ComparableStringArray.of("a", "b"), row.get(0));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSanity</span><span class="hljs-params">()</span> </span>{

    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.of(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>));

    Assert.assertEquals(<span class="hljs-number">0</span>, strategy.computeDictionaryId(columnValueSelector));

    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);

    ResultRow row = ResultRow.create(<span class="hljs-number">1</span>);

    buffer1.putInt(<span class="hljs-number">0</span>);

    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, <span class="hljs-number">0</span>);

    Assert.assertEquals(ComparableStringArray.of(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>), row.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ColumnValueSelector <span class="hljs-title">createMockColumnValueSelector</span><span class="hljs-params">(ImmutableList&lt;String&gt; objectReturn)</span> </span>{
    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(columnValueSelector.getObject()).thenReturn(objectReturn);
    <span class="hljs-keyword">return</span> columnValueSelector;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest82">Test Case ID #druid_Test_8_2</h4>
<h4 id="test-case-name-testaddingindictionaryfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaecolumnarraystringgroupbycolumnselectorstrategytestjava">Test Case Name: <code>testAddingInDictionary</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\column\ArrayStringGroupByColumnSelectorStrategyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-columnvalueselector">Mock Object Variable Name: <code>columnValueSelector</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testAddingInDictionary() {
<span class="hljs-deletion">-    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector.class);</span>
<span class="hljs-deletion">-    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.of("f", "a"));</span>
<span class="hljs-addition">+    ColumnValueSelector columnValueSelector = createMockColumnValueSelector(ImmutableList.of("f", "a"));</span>
     Assert.assertEquals(3, strategy.computeDictionaryId(columnValueSelector));
     GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus.class);
     Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(0);
     ResultRow row = ResultRow.create(1);
     buffer1.putInt(3);
     strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, 0);
     Assert.assertEquals(ComparableStringArray.of("f", "a"), row.get(0));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAddingInDictionary</span><span class="hljs-params">()</span> </span>{

    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.of(<span class="hljs-string">"f"</span>, <span class="hljs-string">"a"</span>));

    Assert.assertEquals(<span class="hljs-number">3</span>, strategy.computeDictionaryId(columnValueSelector));

    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);

    ResultRow row = ResultRow.create(<span class="hljs-number">1</span>);

    buffer1.putInt(<span class="hljs-number">3</span>);

    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, <span class="hljs-number">0</span>);

    Assert.assertEquals(ComparableStringArray.of(<span class="hljs-string">"f"</span>, <span class="hljs-string">"a"</span>), row.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ColumnValueSelector <span class="hljs-title">createMockColumnValueSelector</span><span class="hljs-params">(ImmutableList&lt;String&gt; objectReturn)</span> </span>{
    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(columnValueSelector.getObject()).thenReturn(objectReturn);
    <span class="hljs-keyword">return</span> columnValueSelector;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci9">Mock Clone Instance #druid_MCI_9</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.server.coordinator.DruidCoordinatorRuntimeParams</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDruidCoordinatorRuntimeParams</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DruidCoordinatorRuntimeParams <span class="hljs-title">createMockDruidCoordinatorRuntimeParams</span><span class="hljs-params">(CoordinatorRunStats coordinatorRunStats)</span> </span>{
    DruidCoordinatorRuntimeParams mockDruidCoordinatorRuntimeParams = Mockito.mock(DruidCoordinatorRuntimeParams<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(mockDruidCoordinatorRuntimeParams.getCoordinatorStats()).thenReturn(coordinatorRunStats);
    <span class="hljs-keyword">return</span> mockDruidCoordinatorRuntimeParams;
  }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest91">Test Case ID #druid_Test_9_1</h4>
<h4 id="test-case-name-testrunnotskipiflastrunmorethanperiodfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservercoordinatordutykilldatasourcemetadatatestjava">Test Case Name: <code>testRunNotSkipIfLastRunMoreThanPeriod</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\coordinator\duty\KillDatasourceMetadataTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockdruidcoordinatorruntimeparams">Mock Object Variable Name: <code>mockDruidCoordinatorRuntimeParams</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testRunNotSkipIfLastRunMoreThanPeriod() {
<span class="hljs-deletion">-    Mockito.when(mockDruidCoordinatorRuntimeParams.getCoordinatorStats()).thenReturn(runStats);</span>
<span class="hljs-addition">+    mockDruidCoordinatorRuntimeParams = MockDruidCoordinatorRuntimeParams.createMockDruidCoordinatorRuntimeParams(runStats);</span>
     TestDruidCoordinatorConfig druidCoordinatorConfig = new TestDruidCoordinatorConfig.Builder().withMetadataStoreManagementPeriod(new Duration("PT5S")).withCoordinatorDatasourceKillPeriod(new Duration("PT6S")).withCoordinatorDatasourceKillDurationToRetain(new Duration("PT1S")).withCoordinatorKillMaxSegments(10).withCoordinatorKillIgnoreDurationToRetain(false).build();
     killDatasourceMetadata = new KillDatasourceMetadata(druidCoordinatorConfig, mockIndexerMetadataStorageCoordinator, mockMetadataSupervisorManager);
     killDatasourceMetadata.run(mockDruidCoordinatorRuntimeParams);
     Mockito.verify(mockIndexerMetadataStorageCoordinator).removeDataSourceMetadataOlderThan(ArgumentMatchers.anyLong(), ArgumentMatchers.anySet());
     Assert.assertTrue(runStats.hasStat(Stats.Kill.DATASOURCES));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRunNotSkipIfLastRunMoreThanPeriod</span><span class="hljs-params">()</span> </span>{

    Mockito.when(mockDruidCoordinatorRuntimeParams.getCoordinatorStats()).thenReturn(runStats);

    TestDruidCoordinatorConfig druidCoordinatorConfig = <span class="hljs-keyword">new</span> TestDruidCoordinatorConfig.Builder().withMetadataStoreManagementPeriod(<span class="hljs-keyword">new</span> Duration(<span class="hljs-string">"PT5S"</span>)).withCoordinatorDatasourceKillPeriod(<span class="hljs-keyword">new</span> Duration(<span class="hljs-string">"PT6S"</span>)).withCoordinatorDatasourceKillDurationToRetain(<span class="hljs-keyword">new</span> Duration(<span class="hljs-string">"PT1S"</span>)).withCoordinatorKillMaxSegments(<span class="hljs-number">10</span>).withCoordinatorKillIgnoreDurationToRetain(<span class="hljs-keyword">false</span>).build();

    killDatasourceMetadata = <span class="hljs-keyword">new</span> KillDatasourceMetadata(druidCoordinatorConfig, mockIndexerMetadataStorageCoordinator, mockMetadataSupervisorManager);

    killDatasourceMetadata.run(mockDruidCoordinatorRuntimeParams);

    Mockito.verify(mockIndexerMetadataStorageCoordinator).removeDataSourceMetadataOlderThan(ArgumentMatchers.anyLong(), ArgumentMatchers.anySet());

    Assert.assertTrue(runStats.hasStat(Stats.Kill.DATASOURCES));

}
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    runStats = <span class="hljs-keyword">new</span> CoordinatorRunStats();

    Mockito.when(mockDruidCoordinatorRuntimeParams.getCoordinatorStats()).thenReturn(runStats);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDruidCoordinatorRuntimeParams</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DruidCoordinatorRuntimeParams <span class="hljs-title">createMockDruidCoordinatorRuntimeParams</span><span class="hljs-params">(CoordinatorRunStats coordinatorRunStats)</span> </span>{
    DruidCoordinatorRuntimeParams mockDruidCoordinatorRuntimeParams = Mockito.mock(DruidCoordinatorRuntimeParams<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(mockDruidCoordinatorRuntimeParams.getCoordinatorStats()).thenReturn(coordinatorRunStats);
    <span class="hljs-keyword">return</span> mockDruidCoordinatorRuntimeParams;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest92">Test Case ID #druid_Test_9_2</h4>
<h4 id="test-case-name-testrunfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservercoordinatordutykillsupervisorscustomdutytestjava">Test Case Name: <code>testRun</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\coordinator\duty\KillSupervisorsCustomDutyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockdruidcoordinatorruntimeparams">Mock Object Variable Name: <code>mockDruidCoordinatorRuntimeParams</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testRun() {
     final CoordinatorRunStats runStats = new CoordinatorRunStats();
<span class="hljs-deletion">-    Mockito.when(mockDruidCoordinatorRuntimeParams.getCoordinatorStats()).thenReturn(runStats);</span>
<span class="hljs-addition">+    mockDruidCoordinatorRuntimeParams = MockDruidCoordinatorRuntimeParams.createMockDruidCoordinatorRuntimeParams(runStats);</span>
     killSupervisors = new KillSupervisorsCustomDuty(new Duration("PT1S"), mockMetadataSupervisorManager, coordinatorConfig);
     killSupervisors.run(mockDruidCoordinatorRuntimeParams);
     Mockito.verify(mockMetadataSupervisorManager).removeTerminatedSupervisorsOlderThan(ArgumentMatchers.anyLong());
     Assert.assertTrue(runStats.hasStat(Stats.Kill.SUPERVISOR_SPECS));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRun</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> CoordinatorRunStats runStats = <span class="hljs-keyword">new</span> CoordinatorRunStats();

    Mockito.when(mockDruidCoordinatorRuntimeParams.getCoordinatorStats()).thenReturn(runStats);

    killSupervisors = <span class="hljs-keyword">new</span> KillSupervisorsCustomDuty(<span class="hljs-keyword">new</span> Duration(<span class="hljs-string">"PT1S"</span>), mockMetadataSupervisorManager, coordinatorConfig);

    killSupervisors.run(mockDruidCoordinatorRuntimeParams);

    Mockito.verify(mockMetadataSupervisorManager).removeTerminatedSupervisorsOlderThan(ArgumentMatchers.anyLong());

    Assert.assertTrue(runStats.hasStat(Stats.Kill.SUPERVISOR_SPECS));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDruidCoordinatorRuntimeParams</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DruidCoordinatorRuntimeParams <span class="hljs-title">createMockDruidCoordinatorRuntimeParams</span><span class="hljs-params">(CoordinatorRunStats coordinatorRunStats)</span> </span>{
    DruidCoordinatorRuntimeParams mockDruidCoordinatorRuntimeParams = Mockito.mock(DruidCoordinatorRuntimeParams<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(mockDruidCoordinatorRuntimeParams.getCoordinatorStats()).thenReturn(coordinatorRunStats);
    <span class="hljs-keyword">return</span> mockDruidCoordinatorRuntimeParams;
  }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci10">Mock Clone Instance #druid_MCI_10</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.data.input.impl.CloudObjectInputSource</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CloudObjectInputSource <span class="hljs-title">createMockCloudObjectInputSource</span><span class="hljs-params">(String scheme, List&lt;URI&gt; uris, List&lt;CloudObjectLocation&gt; objects, List&lt;CloudObjectLocation&gt; objectsBeforeGlob, String objectGlob, MockSplitWidget splitWidget)</span> </span>{
    CloudObjectInputSource inputSource = Mockito.mock(
        CloudObjectInputSource<span class="hljs-class">.<span class="hljs-keyword">class</span>,
        <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>()
            .<span class="hljs-title">useConstructor</span>(<span class="hljs-title">scheme</span>, <span class="hljs-title">uris</span>, <span class="hljs-title">null</span>, <span class="hljs-title">objectsBeforeGlob</span>, <span class="hljs-title">objectGlob</span>)
            .<span class="hljs-title">defaultAnswer</span>(<span class="hljs-title">Mockito</span>.<span class="hljs-title">CALLS_REAL_METHODS</span>)
    )</span>;
    Mockito.when(inputSource.getSplitWidget()).thenReturn(splitWidget);
    <span class="hljs-keyword">return</span> inputSource;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest101">Test Case ID #druid_Test_10_1</h4>
<h4 id="test-case-name-testwithurisfilterfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruiddatainputimplcloudobjectinputsourcetestjava">Test Case Name: <code>testWithUrisFilter</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\data\input\impl\CloudObjectInputSourceTest.java</code>)</h4>
<h4 id="mock-object-variable-name-inputsource">Mock Object Variable Name: <code>inputSource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testWithUrisFilter() {
<span class="hljs-deletion">-    CloudObjectInputSource inputSource = Mockito.mock(CloudObjectInputSource.class, Mockito.withSettings().useConstructor(SCHEME, URIS2, null, null, "**.csv").defaultAnswer(Mockito.CALLS_REAL_METHODS));</span>
<span class="hljs-deletion">-    Mockito.when(inputSource.getSplitWidget()).thenReturn(new MockSplitWidget());</span>
<span class="hljs-addition">+    CloudObjectInputSource inputSource = createMockCloudObjectInputSource(SCHEME, URIS2, null, null, "**.csv", new MockSplitWidget());</span>
    Stream&lt;InputSplit&lt;List&lt;CloudObjectLocation&gt;&gt;&gt; splits = inputSource.createSplits(new JsonInputFormat(JSONPathSpec.DEFAULT, null, null, null, null), new MaxSizeSplitHintSpec(null, 1));
    List&lt;CloudObjectLocation&gt; returnedLocations = splits.map(InputSplit::get).collect(Collectors.toList()).get(0);
    List&lt;URI&gt; returnedLocationUris = returnedLocations.stream().map(object -&gt; object.toUri(SCHEME)).collect(Collectors.toList());
    Assert.assertEquals("**.csv", inputSource.getObjectGlob());
    Assert.assertEquals(URIS, returnedLocationUris);
    final List&lt;InputEntity&gt; entities = Lists.newArrayList(inputSource.getInputEntities(new JsonInputFormat(null, null, null, null, null)));
    Assert.assertEquals(URIS.size(), entities.size());
}
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testWithUrisFilter</span><span class="hljs-params">()</span> </span>{

    CloudObjectInputSource inputSource = Mockito.mock(CloudObjectInputSource<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">useConstructor</span>(<span class="hljs-title">SCHEME</span>, <span class="hljs-title">URIS2</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, "**.<span class="hljs-title">csv</span>").<span class="hljs-title">defaultAnswer</span>(<span class="hljs-title">Mockito</span>.<span class="hljs-title">CALLS_REAL_METHODS</span>))</span>;

    Mockito.when(inputSource.getSplitWidget()).thenReturn(<span class="hljs-keyword">new</span> MockSplitWidget());

    Stream&lt;InputSplit&lt;List&lt;CloudObjectLocation&gt;&gt;&gt; splits = inputSource.createSplits(<span class="hljs-keyword">new</span> JsonInputFormat(JSONPathSpec.DEFAULT, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">new</span> MaxSizeSplitHintSpec(<span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>));

    List&lt;CloudObjectLocation&gt; returnedLocations = splits.map(InputSplit::get).collect(Collectors.toList()).get(<span class="hljs-number">0</span>);

    List&lt;URI&gt; returnedLocationUris = returnedLocations.stream().map(object -&gt; object.toUri(SCHEME)).collect(Collectors.toList());

    Assert.assertEquals(<span class="hljs-string">"**.csv"</span>, inputSource.getObjectGlob());

    Assert.assertEquals(URIS, returnedLocationUris);

    <span class="hljs-keyword">final</span> List&lt;InputEntity&gt; entities = Lists.newArrayList(inputSource.getInputEntities(<span class="hljs-keyword">new</span> JsonInputFormat(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>)));

    Assert.assertEquals(URIS.size(), entities.size());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CloudObjectInputSource <span class="hljs-title">createMockCloudObjectInputSource</span><span class="hljs-params">(String scheme, List&lt;URI&gt; uris, List&lt;CloudObjectLocation&gt; objects, List&lt;CloudObjectLocation&gt; objectsBeforeGlob, String objectGlob, MockSplitWidget splitWidget)</span> </span>{
    CloudObjectInputSource inputSource = Mockito.mock(
        CloudObjectInputSource<span class="hljs-class">.<span class="hljs-keyword">class</span>,
        <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>()
            .<span class="hljs-title">useConstructor</span>(<span class="hljs-title">scheme</span>, <span class="hljs-title">uris</span>, <span class="hljs-title">null</span>, <span class="hljs-title">objectsBeforeGlob</span>, <span class="hljs-title">objectGlob</span>)
            .<span class="hljs-title">defaultAnswer</span>(<span class="hljs-title">Mockito</span>.<span class="hljs-title">CALLS_REAL_METHODS</span>)
    )</span>;
    Mockito.when(inputSource.getSplitWidget()).thenReturn(splitWidget);
    <span class="hljs-keyword">return</span> inputSource;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest102">Test Case ID #druid_Test_10_2</h4>
<h4 id="test-case-name-testwithurisfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruiddatainputimplcloudobjectinputsourcetestjava">Test Case Name: <code>testWithUris</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\data\input\impl\CloudObjectInputSourceTest.java</code>)</h4>
<h4 id="mock-object-variable-name-inputsource">Mock Object Variable Name: <code>inputSource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testWithUris() {
<span class="hljs-deletion">-    CloudObjectInputSource inputSource = Mockito.mock(CloudObjectInputSource.class, Mockito.withSettings().useConstructor(SCHEME, URIS, null, null, null).defaultAnswer(Mockito.CALLS_REAL_METHODS));</span>
<span class="hljs-deletion">-    Mockito.when(inputSource.getSplitWidget()).thenReturn(new MockSplitWidget());</span>
<span class="hljs-addition">+    CloudObjectInputSource inputSource = createMockCloudObjectInputSource(SCHEME, URIS, null, null, null, new MockSplitWidget());</span>
     Stream&lt;InputSplit&lt;List&lt;CloudObjectLocation&gt;&gt;&gt; splits = inputSource.createSplits(new JsonInputFormat(JSONPathSpec.DEFAULT, null, null, null, null), new MaxSizeSplitHintSpec(null, 1));
     List&lt;CloudObjectLocation&gt; returnedLocations = splits.map(InputSplit::get).collect(Collectors.toList()).get(0);
     List&lt;URI&gt; returnedLocationUris = returnedLocations.stream().map(object -&gt; object.toUri(SCHEME)).collect(Collectors.toList());
     Assert.assertEquals(null, inputSource.getObjectGlob());
     Assert.assertEquals(URIS, returnedLocationUris);
     final List&lt;InputEntity&gt; entities = Lists.newArrayList(inputSource.getInputEntities(new JsonInputFormat(null, null, null, null, null)));
     Assert.assertEquals(URIS.size(), entities.size());
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testWithUris</span><span class="hljs-params">()</span> </span>{

    CloudObjectInputSource inputSource = Mockito.mock(CloudObjectInputSource<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">useConstructor</span>(<span class="hljs-title">SCHEME</span>, <span class="hljs-title">URIS</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>).<span class="hljs-title">defaultAnswer</span>(<span class="hljs-title">Mockito</span>.<span class="hljs-title">CALLS_REAL_METHODS</span>))</span>;

    Mockito.when(inputSource.getSplitWidget()).thenReturn(<span class="hljs-keyword">new</span> MockSplitWidget());

    Stream&lt;InputSplit&lt;List&lt;CloudObjectLocation&gt;&gt;&gt; splits = inputSource.createSplits(<span class="hljs-keyword">new</span> JsonInputFormat(JSONPathSpec.DEFAULT, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">new</span> MaxSizeSplitHintSpec(<span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>));

    List&lt;CloudObjectLocation&gt; returnedLocations = splits.map(InputSplit::get).collect(Collectors.toList()).get(<span class="hljs-number">0</span>);

    List&lt;URI&gt; returnedLocationUris = returnedLocations.stream().map(object -&gt; object.toUri(SCHEME)).collect(Collectors.toList());

    Assert.assertEquals(<span class="hljs-keyword">null</span>, inputSource.getObjectGlob());

    Assert.assertEquals(URIS, returnedLocationUris);

    <span class="hljs-keyword">final</span> List&lt;InputEntity&gt; entities = Lists.newArrayList(inputSource.getInputEntities(<span class="hljs-keyword">new</span> JsonInputFormat(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>)));

    Assert.assertEquals(URIS.size(), entities.size());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CloudObjectInputSource <span class="hljs-title">createMockCloudObjectInputSource</span><span class="hljs-params">(String scheme, List&lt;URI&gt; uris, List&lt;CloudObjectLocation&gt; objects, List&lt;CloudObjectLocation&gt; objectsBeforeGlob, String objectGlob, MockSplitWidget splitWidget)</span> </span>{
    CloudObjectInputSource inputSource = Mockito.mock(
        CloudObjectInputSource<span class="hljs-class">.<span class="hljs-keyword">class</span>,
        <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>()
            .<span class="hljs-title">useConstructor</span>(<span class="hljs-title">scheme</span>, <span class="hljs-title">uris</span>, <span class="hljs-title">null</span>, <span class="hljs-title">objectsBeforeGlob</span>, <span class="hljs-title">objectGlob</span>)
            .<span class="hljs-title">defaultAnswer</span>(<span class="hljs-title">Mockito</span>.<span class="hljs-title">CALLS_REAL_METHODS</span>)
    )</span>;
    Mockito.when(inputSource.getSplitWidget()).thenReturn(splitWidget);
    <span class="hljs-keyword">return</span> inputSource;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest103">Test Case ID #druid_Test_10_3</h4>
<h4 id="test-case-name-testwithobjectsfilterfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruiddatainputimplcloudobjectinputsourcetestjava">Test Case Name: <code>testWithObjectsFilter</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\data\input\impl\CloudObjectInputSourceTest.java</code>)</h4>
<h4 id="mock-object-variable-name-inputsource">Mock Object Variable Name: <code>inputSource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testWithObjectsFilter() {
<span class="hljs-deletion">-    CloudObjectInputSource inputSource = Mockito.mock(CloudObjectInputSource.class, Mockito.withSettings().useConstructor(SCHEME, null, null, OBJECTS_BEFORE_GLOB, "**.csv").defaultAnswer(Mockito.CALLS_REAL_METHODS));</span>
<span class="hljs-deletion">-    Mockito.when(inputSource.getSplitWidget()).thenReturn(new MockSplitWidget());</span>
<span class="hljs-addition">+    CloudObjectInputSource inputSource = createMockCloudObjectInputSource(SCHEME, null, OBJECTS, OBJECTS_BEFORE_GLOB, "**.csv", new MockSplitWidget());</span>
    Stream&lt;InputSplit&lt;List&lt;CloudObjectLocation&gt;&gt;&gt; splits = inputSource.createSplits(new JsonInputFormat(JSONPathSpec.DEFAULT, null, null, null, null), new MaxSizeSplitHintSpec(null, 1));
    List&lt;CloudObjectLocation&gt; returnedLocations = splits.map(InputSplit::get).collect(Collectors.toList()).get(0);
    List&lt;URI&gt; returnedLocationUris = returnedLocations.stream().map(object -&gt; object.toUri(SCHEME)).collect(Collectors.toList());
    Assert.assertEquals("**.csv", inputSource.getObjectGlob());
    Assert.assertEquals(URIS, returnedLocationUris);
    final List&lt;InputEntity&gt; entities = Lists.newArrayList(inputSource.getInputEntities(new JsonInputFormat(null, null, null, null, null)));
    Assert.assertEquals(OBJECTS.size(), entities.size());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testWithObjectsFilter</span><span class="hljs-params">()</span> </span>{

    CloudObjectInputSource inputSource = Mockito.mock(CloudObjectInputSource<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">useConstructor</span>(<span class="hljs-title">SCHEME</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">OBJECTS_BEFORE_GLOB</span>, "**.<span class="hljs-title">csv</span>").<span class="hljs-title">defaultAnswer</span>(<span class="hljs-title">Mockito</span>.<span class="hljs-title">CALLS_REAL_METHODS</span>))</span>;

    Mockito.when(inputSource.getSplitWidget()).thenReturn(<span class="hljs-keyword">new</span> MockSplitWidget());

    Stream&lt;InputSplit&lt;List&lt;CloudObjectLocation&gt;&gt;&gt; splits = inputSource.createSplits(<span class="hljs-keyword">new</span> JsonInputFormat(JSONPathSpec.DEFAULT, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">new</span> MaxSizeSplitHintSpec(<span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>));

    List&lt;CloudObjectLocation&gt; returnedLocations = splits.map(InputSplit::get).collect(Collectors.toList()).get(<span class="hljs-number">0</span>);

    List&lt;URI&gt; returnedLocationUris = returnedLocations.stream().map(object -&gt; object.toUri(SCHEME)).collect(Collectors.toList());

    Assert.assertEquals(<span class="hljs-string">"**.csv"</span>, inputSource.getObjectGlob());

    Assert.assertEquals(URIS, returnedLocationUris);

    <span class="hljs-keyword">final</span> List&lt;InputEntity&gt; entities = Lists.newArrayList(inputSource.getInputEntities(<span class="hljs-keyword">new</span> JsonInputFormat(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>)));

    Assert.assertEquals(OBJECTS.size(), entities.size());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CloudObjectInputSource <span class="hljs-title">createMockCloudObjectInputSource</span><span class="hljs-params">(String scheme, List&lt;URI&gt; uris, List&lt;CloudObjectLocation&gt; objects, List&lt;CloudObjectLocation&gt; objectsBeforeGlob, String objectGlob, MockSplitWidget splitWidget)</span> </span>{
    CloudObjectInputSource inputSource = Mockito.mock(
        CloudObjectInputSource<span class="hljs-class">.<span class="hljs-keyword">class</span>,
        <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>()
            .<span class="hljs-title">useConstructor</span>(<span class="hljs-title">scheme</span>, <span class="hljs-title">uris</span>, <span class="hljs-title">null</span>, <span class="hljs-title">objectsBeforeGlob</span>, <span class="hljs-title">objectGlob</span>)
            .<span class="hljs-title">defaultAnswer</span>(<span class="hljs-title">Mockito</span>.<span class="hljs-title">CALLS_REAL_METHODS</span>)
    )</span>;
    Mockito.when(inputSource.getSplitWidget()).thenReturn(splitWidget);
    <span class="hljs-keyword">return</span> inputSource;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest104">Test Case ID #druid_Test_10_4</h4>
<h4 id="test-case-name-testwithobjectsfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruiddatainputimplcloudobjectinputsourcetestjava">Test Case Name: <code>testWithObjects</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\data\input\impl\CloudObjectInputSourceTest.java</code>)</h4>
<h4 id="mock-object-variable-name-inputsource">Mock Object Variable Name: <code>inputSource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testWithObjects() {
<span class="hljs-deletion">-    CloudObjectInputSource inputSource = Mockito.mock(CloudObjectInputSource.class, Mockito.withSettings().useConstructor(SCHEME, null, null, OBJECTS, null).defaultAnswer(Mockito.CALLS_REAL_METHODS));</span>
<span class="hljs-deletion">-    Mockito.when(inputSource.getSplitWidget()).thenReturn(new MockSplitWidget());</span>
<span class="hljs-addition">+    CloudObjectInputSource inputSource = createMockCloudObjectInputSource(SCHEME, null, OBJECTS, null, null, new MockSplitWidget());</span>
    Stream&lt;InputSplit&lt;List&lt;CloudObjectLocation&gt;&gt;&gt; splits = inputSource.createSplits(new JsonInputFormat(JSONPathSpec.DEFAULT, null, null, null, null), new MaxSizeSplitHintSpec(null, 1));
    List&lt;CloudObjectLocation&gt; returnedLocations = splits.map(InputSplit::get).collect(Collectors.toList()).get(0);
    Assert.assertNull(inputSource.getObjectGlob());
    Assert.assertEquals(OBJECTS, returnedLocations);
    final List&lt;InputEntity&gt; entities = Lists.newArrayList(inputSource.getInputEntities(new JsonInputFormat(null, null, null, null, null)));
    Assert.assertEquals(OBJECTS.size(), entities.size());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testWithObjects</span><span class="hljs-params">()</span> </span>{

    CloudObjectInputSource inputSource = Mockito.mock(CloudObjectInputSource<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">useConstructor</span>(<span class="hljs-title">SCHEME</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">OBJECTS</span>, <span class="hljs-title">null</span>).<span class="hljs-title">defaultAnswer</span>(<span class="hljs-title">Mockito</span>.<span class="hljs-title">CALLS_REAL_METHODS</span>))</span>;

    Mockito.when(inputSource.getSplitWidget()).thenReturn(<span class="hljs-keyword">new</span> MockSplitWidget());

    Stream&lt;InputSplit&lt;List&lt;CloudObjectLocation&gt;&gt;&gt; splits = inputSource.createSplits(<span class="hljs-keyword">new</span> JsonInputFormat(JSONPathSpec.DEFAULT, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">new</span> MaxSizeSplitHintSpec(<span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>));

    List&lt;CloudObjectLocation&gt; returnedLocations = splits.map(InputSplit::get).collect(Collectors.toList()).get(<span class="hljs-number">0</span>);

    Assert.assertNull(inputSource.getObjectGlob());

    Assert.assertEquals(OBJECTS, returnedLocations);

    <span class="hljs-keyword">final</span> List&lt;InputEntity&gt; entities = Lists.newArrayList(inputSource.getInputEntities(<span class="hljs-keyword">new</span> JsonInputFormat(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>)));

    Assert.assertEquals(OBJECTS.size(), entities.size());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> CloudObjectInputSource <span class="hljs-title">createMockCloudObjectInputSource</span><span class="hljs-params">(String scheme, List&lt;URI&gt; uris, List&lt;CloudObjectLocation&gt; objects, List&lt;CloudObjectLocation&gt; objectsBeforeGlob, String objectGlob, MockSplitWidget splitWidget)</span> </span>{
    CloudObjectInputSource inputSource = Mockito.mock(
        CloudObjectInputSource<span class="hljs-class">.<span class="hljs-keyword">class</span>,
        <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>()
            .<span class="hljs-title">useConstructor</span>(<span class="hljs-title">scheme</span>, <span class="hljs-title">uris</span>, <span class="hljs-title">null</span>, <span class="hljs-title">objectsBeforeGlob</span>, <span class="hljs-title">objectGlob</span>)
            .<span class="hljs-title">defaultAnswer</span>(<span class="hljs-title">Mockito</span>.<span class="hljs-title">CALLS_REAL_METHODS</span>)
    )</span>;
    Mockito.when(inputSource.getSplitWidget()).thenReturn(splitWidget);
    <span class="hljs-keyword">return</span> inputSource;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci11">Mock Clone Instance #druid_MCI_11</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.data.input.impl.CloudObjectInputSource</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> CloudObjectInputSource inputSource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    inputSource = Mockito.mock(CloudObjectInputSource<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">useConstructor</span>(<span class="hljs-title">SCHEME</span>, <span class="hljs-title">URIS</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>).<span class="hljs-title">defaultAnswer</span>(<span class="hljs-title">Mockito</span>.<span class="hljs-title">CALLS_REAL_METHODS</span>))</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
inputSource;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest111">Test Case ID #druid_Test_11_1</h4>
<h4 id="test-case-name-testgeturisfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruiddatainputimplcloudobjectinputsourcetestjava">Test Case Name: <code>testGetUris</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\data\input\impl\CloudObjectInputSourceTest.java</code>)</h4>
<h4 id="mock-object-variable-name-inputsource">Mock Object Variable Name: <code>inputSource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testGetUris() {
<span class="hljs-deletion">-    CloudObjectInputSource inputSource = Mockito.mock(CloudObjectInputSource.class, Mockito.withSettings().useConstructor(SCHEME, URIS, null, null, null).defaultAnswer(Mockito.CALLS_REAL_METHODS));</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `inputSource`</span>
     Assert.assertEquals(URIS, inputSource.getUris());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetUris</span><span class="hljs-params">()</span> </span>{

    CloudObjectInputSource inputSource = Mockito.mock(CloudObjectInputSource<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">useConstructor</span>(<span class="hljs-title">SCHEME</span>, <span class="hljs-title">URIS</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>).<span class="hljs-title">defaultAnswer</span>(<span class="hljs-title">Mockito</span>.<span class="hljs-title">CALLS_REAL_METHODS</span>))</span>;

    Assert.assertEquals(URIS, inputSource.getUris());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> CloudObjectInputSource inputSource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    inputSource = Mockito.mock(CloudObjectInputSource<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">useConstructor</span>(<span class="hljs-title">SCHEME</span>, <span class="hljs-title">URIS</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>).<span class="hljs-title">defaultAnswer</span>(<span class="hljs-title">Mockito</span>.<span class="hljs-title">CALLS_REAL_METHODS</span>))</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
inputSource;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest112">Test Case ID #druid_Test_11_2</h4>
<h4 id="test-case-name-testgetprefixesfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruiddatainputimplcloudobjectinputsourcetestjava">Test Case Name: <code>testGetPrefixes</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\data\input\impl\CloudObjectInputSourceTest.java</code>)</h4>
<h4 id="mock-object-variable-name-inputsource">Mock Object Variable Name: <code>inputSource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testGetPrefixes() {
<span class="hljs-deletion">-    CloudObjectInputSource inputSource = Mockito.mock(CloudObjectInputSource.class, Mockito.withSettings().useConstructor(SCHEME, null, PREFIXES, null, null).defaultAnswer(Mockito.CALLS_REAL_METHODS));</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `inputSource`</span>
     Assert.assertEquals(PREFIXES, inputSource.getPrefixes());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetPrefixes</span><span class="hljs-params">()</span> </span>{

    CloudObjectInputSource inputSource = Mockito.mock(CloudObjectInputSource<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">useConstructor</span>(<span class="hljs-title">SCHEME</span>, <span class="hljs-title">null</span>, <span class="hljs-title">PREFIXES</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>).<span class="hljs-title">defaultAnswer</span>(<span class="hljs-title">Mockito</span>.<span class="hljs-title">CALLS_REAL_METHODS</span>))</span>;

    Assert.assertEquals(PREFIXES, inputSource.getPrefixes());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> CloudObjectInputSource inputSource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    inputSource = Mockito.mock(CloudObjectInputSource<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">useConstructor</span>(<span class="hljs-title">SCHEME</span>, <span class="hljs-title">URIS</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>).<span class="hljs-title">defaultAnswer</span>(<span class="hljs-title">Mockito</span>.<span class="hljs-title">CALLS_REAL_METHODS</span>))</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
inputSource;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest113">Test Case ID #druid_Test_11_3</h4>
<h4 id="test-case-name-testgetobjectglobfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruiddatainputimplcloudobjectinputsourcetestjava">Test Case Name: <code>testGetObjectGlob</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\data\input\impl\CloudObjectInputSourceTest.java</code>)</h4>
<h4 id="mock-object-variable-name-inputsource">Mock Object Variable Name: <code>inputSource</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testGetObjectGlob() {
<span class="hljs-deletion">-    CloudObjectInputSource inputSource = Mockito.mock(CloudObjectInputSource.class, Mockito.withSettings().useConstructor(SCHEME, URIS, null, null, "**.parquet").defaultAnswer(Mockito.CALLS_REAL_METHODS));</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `inputSource`</span>
     Assert.assertEquals("**.parquet", inputSource.getObjectGlob());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetObjectGlob</span><span class="hljs-params">()</span> </span>{

    CloudObjectInputSource inputSource = Mockito.mock(CloudObjectInputSource<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">useConstructor</span>(<span class="hljs-title">SCHEME</span>, <span class="hljs-title">URIS</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, "**.<span class="hljs-title">parquet</span>").<span class="hljs-title">defaultAnswer</span>(<span class="hljs-title">Mockito</span>.<span class="hljs-title">CALLS_REAL_METHODS</span>))</span>;

    Assert.assertEquals(<span class="hljs-string">"**.parquet"</span>, inputSource.getObjectGlob());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> CloudObjectInputSource inputSource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    inputSource = Mockito.mock(CloudObjectInputSource<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">useConstructor</span>(<span class="hljs-title">SCHEME</span>, <span class="hljs-title">URIS</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>).<span class="hljs-title">defaultAnswer</span>(<span class="hljs-title">Mockito</span>.<span class="hljs-title">CALLS_REAL_METHODS</span>))</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
inputSource;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest114">Test Case ID #druid_Test_11_4</h4>
<h4 id="test-case-name-testinequalityfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruiddatainputimplcloudobjectinputsourcetestjava">Test Case Name: <code>testInequality</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\data\input\impl\CloudObjectInputSourceTest.java</code>)</h4>
<h4 id="mock-object-variable-name-inputsource1">Mock Object Variable Name: <code>inputSource1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testInequality() {
<span class="hljs-deletion">-    CloudObjectInputSource inputSource1 = Mockito.mock(CloudObjectInputSource.class, Mockito.withSettings().useConstructor(SCHEME, URIS, null, null, "**.parquet").defaultAnswer(Mockito.CALLS_REAL_METHODS));</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `inputSource`</span>
     CloudObjectInputSource inputSource2 = Mockito.mock(CloudObjectInputSource.class, Mockito.withSettings().useConstructor(SCHEME, URIS, null, null, "**.csv").defaultAnswer(Mockito.CALLS_REAL_METHODS));
@@
<span class="hljs-deletion">-    Assert.assertEquals("**.parquet", inputSource1.getObjectGlob());</span>
<span class="hljs-addition">+    Assert.assertEquals("**.parquet", inputSource.getObjectGlob());</span>
     Assert.assertEquals("**.csv", inputSource2.getObjectGlob());
<span class="hljs-deletion">-    Assert.assertFalse(inputSource2.equals(inputSource1));</span>
<span class="hljs-addition">+    Assert.assertFalse(inputSource2.equals(inputSource));</span>
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testInequality</span><span class="hljs-params">()</span> </span>{

    CloudObjectInputSource inputSource1 = Mockito.mock(CloudObjectInputSource<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">useConstructor</span>(<span class="hljs-title">SCHEME</span>, <span class="hljs-title">URIS</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, "**.<span class="hljs-title">parquet</span>").<span class="hljs-title">defaultAnswer</span>(<span class="hljs-title">Mockito</span>.<span class="hljs-title">CALLS_REAL_METHODS</span>))</span>;

    CloudObjectInputSource inputSource2 = Mockito.mock(CloudObjectInputSource<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">useConstructor</span>(<span class="hljs-title">SCHEME</span>, <span class="hljs-title">URIS</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, "**.<span class="hljs-title">csv</span>").<span class="hljs-title">defaultAnswer</span>(<span class="hljs-title">Mockito</span>.<span class="hljs-title">CALLS_REAL_METHODS</span>))</span>;

    Assert.assertEquals(<span class="hljs-string">"**.parquet"</span>, inputSource1.getObjectGlob());

    Assert.assertEquals(<span class="hljs-string">"**.csv"</span>, inputSource2.getObjectGlob());

    Assert.assertFalse(inputSource2.equals(inputSource1));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> CloudObjectInputSource inputSource;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    inputSource = Mockito.mock(CloudObjectInputSource<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">withSettings</span>().<span class="hljs-title">useConstructor</span>(<span class="hljs-title">SCHEME</span>, <span class="hljs-title">URIS</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>, <span class="hljs-title">null</span>).<span class="hljs-title">defaultAnswer</span>(<span class="hljs-title">Mockito</span>.<span class="hljs-title">CALLS_REAL_METHODS</span>))</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
inputSource;

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci12">Mock Clone Instance #druid_MCI_12</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.query.lookup.namespace.ExtractionNamespace</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ExtractionNamespace en1, en2;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    en1 = mock(ExtractionNamespace<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
en2 = mock(ExtractionNamespace<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
en1, en2

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest121">Test Case ID #druid_Test_12_1</h4>
<h4 id="test-case-name-testreplacesfile-cjavaprojectsapachedruidextensions-corelookups-cached-globalsrctestjavaorgapachedruidquerylookupnamespacelookupextractorfactorytestjava">Test Case Name: <code>testReplaces</code>(File: <code>C:\Java_projects\Apache\druid\extensions-core\lookups-cached-global\src\test\java\org\apache\druid\query\lookup\NamespaceLookupExtractorFactoryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-en1">Mock Object Variable Name: <code>en1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testReplaces() {
<span class="hljs-addition">+    // Cannot refactor mock `en1`: declared together with `en2` in a single line; split required before refactoring</span>
     final ExtractionNamespace en1 = mock(ExtractionNamespace.class), en2 = mock(ExtractionNamespace.class);
     final NamespaceLookupExtractorFactory f1 = new NamespaceLookupExtractorFactory(en1, scheduler);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testReplaces</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> ExtractionNamespace en1 = mock(ExtractionNamespace<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">en2</span> </span>= mock(ExtractionNamespace<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> NamespaceLookupExtractorFactory f1 = <span class="hljs-keyword">new</span> NamespaceLookupExtractorFactory(en1, scheduler);

    <span class="hljs-keyword">final</span> NamespaceLookupExtractorFactory f2 = <span class="hljs-keyword">new</span> NamespaceLookupExtractorFactory(en2, scheduler);

    <span class="hljs-keyword">final</span> NamespaceLookupExtractorFactory f1b = <span class="hljs-keyword">new</span> NamespaceLookupExtractorFactory(en1, scheduler);

    Assert.assertTrue(f1.replaces(f2));

    Assert.assertTrue(f2.replaces(f1));

    Assert.assertFalse(f1.replaces(f1b));

    Assert.assertFalse(f1b.replaces(f1));

    Assert.assertFalse(f1.replaces(f1));

    Assert.assertTrue(f1.replaces(mock(LookupExtractorFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)))</span>;

    verifyNoInteractions(en1, en2);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ExtractionNamespace en1, en2;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    en1 = mock(ExtractionNamespace<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
en2 = mock(ExtractionNamespace<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
en1, en2

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest122">Test Case ID #druid_Test_12_2</h4>
<h4 id="test-case-name-testexceptionalintrospectionhandlerfile-cjavaprojectsapachedruidextensions-corelookups-cached-globalsrctestjavaorgapachedruidquerylookupnamespacelookupextractorfactorytestjava">Test Case Name: <code>testExceptionalIntrospectionHandler</code>(File: <code>C:\Java_projects\Apache\druid\extensions-core\lookups-cached-global\src\test\java\org\apache\druid\query\lookup\NamespaceLookupExtractorFactoryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-extractionnamespace">Mock Object Variable Name: <code>extractionNamespace</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
<span class="hljs-addition">+    // Cannot refactor mock `extractionNamespace`: ambiguous mapping to multiple global mocks ('en1, en2')</span>
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testExceptionalIntrospectionHandler</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-keyword">final</span> ExtractionNamespace extractionNamespace = mock(ExtractionNamespace<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(scheduler.scheduleAndWait(eq(extractionNamespace), anyLong())).thenReturn(entry);

    <span class="hljs-keyword">final</span> LookupExtractorFactory lookupExtractorFactory = <span class="hljs-keyword">new</span> NamespaceLookupExtractorFactory(extractionNamespace, scheduler);

    Assert.assertTrue(lookupExtractorFactory.start());

    <span class="hljs-keyword">final</span> LookupIntrospectHandler handler = lookupExtractorFactory.getIntrospectHandler();

    Assert.assertNotNull(handler);

    <span class="hljs-keyword">final</span> Class&lt;? extends LookupIntrospectHandler&gt; clazz = handler.getClass();

    verify(scheduler).scheduleAndWait(eq(extractionNamespace), anyLong());

    verifyNoMoreInteractions(scheduler, entry, versionedCache);

    reset(scheduler, entry, versionedCache);

    when(entry.getCacheState()).thenReturn(CacheScheduler.NoCache.CACHE_NOT_INITIALIZED);

    <span class="hljs-keyword">final</span> Response response = (Response) clazz.getMethod(<span class="hljs-string">"getVersion"</span>).invoke(handler);

    Assert.assertEquals(<span class="hljs-number">404</span>, response.getStatus());

    verify(entry).getCacheState();

    validateNotFound(<span class="hljs-string">"getKeys"</span>, handler, clazz);

    validateNotFound(<span class="hljs-string">"getValues"</span>, handler, clazz);

    validateNotFound(<span class="hljs-string">"getMap"</span>, handler, clazz);

    verifyNoMoreInteractions(scheduler, entry, versionedCache);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ExtractionNamespace en1, en2;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    en1 = mock(ExtractionNamespace<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
en2 = mock(ExtractionNamespace<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
en1, en2

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci13">Mock Clone Instance #druid_MCI_13</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.indexing.common.task.TaskResource</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TaskResource <span class="hljs-title">createMockTaskResource</span><span class="hljs-params">(<span class="hljs-keyword">int</span> requiredCapacity)</span> </span>{
    TaskResource taskResource = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(taskResource.getRequiredCapacity()).thenReturn(requiredCapacity);
    <span class="hljs-keyword">return</span> taskResource;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest131">Test Case ID #druid_Test_13_1</h4>
<h4 id="test-case-name-testcanruntaskfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingoverlordimmutableworkerinfotestjava">Test Case Name: <code>test_canRunTask</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\overlord\ImmutableWorkerInfoTest.java</code>)</h4>
<h4 id="mock-object-variable-name-taskresource0">Mock Object Variable Name: <code>taskResource0</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
     ImmutableWorkerInfo workerInfo = new ImmutableWorkerInfo(new Worker("http", "testWorker2", "192.0.0.1", 10, "v1", WorkerConfig.DEFAULT_CATEGORY), 6, 0, ImmutableSet.of("grp1", "grp2"), ImmutableSet.of("task1", "task2"), DateTimes.of("2015-01-01T01:01:02Z"));
     // Parallel index task
<span class="hljs-deletion">-    TaskResource taskResource0 = mock(TaskResource.class);</span>
<span class="hljs-deletion">-    when(taskResource0.getRequiredCapacity()).thenReturn(3);</span>
<span class="hljs-addition">+    TaskResource taskResource0 = createMockTaskResource(3);</span>
     Task parallelIndexTask = mock(ParallelIndexSupervisorTask.class);
     when(parallelIndexTask.getType()).thenReturn(ParallelIndexSupervisorTask.TYPE);
     when(parallelIndexTask.getTaskResource()).thenReturn(taskResource0);
     // Since task satisifies parallel and total slot constraints, can run
     Assert.assertTrue(workerInfo.canRunTask(parallelIndexTask, 0.5));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test_canRunTask</span><span class="hljs-params">()</span> </span>{

    ImmutableWorkerInfo workerInfo = <span class="hljs-keyword">new</span> ImmutableWorkerInfo(<span class="hljs-keyword">new</span> Worker(<span class="hljs-string">"http"</span>, <span class="hljs-string">"testWorker2"</span>, <span class="hljs-string">"192.0.0.1"</span>, <span class="hljs-number">10</span>, <span class="hljs-string">"v1"</span>, WorkerConfig.DEFAULT_CATEGORY), <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, ImmutableSet.of(<span class="hljs-string">"grp1"</span>, <span class="hljs-string">"grp2"</span>), ImmutableSet.of(<span class="hljs-string">"task1"</span>, <span class="hljs-string">"task2"</span>), DateTimes.of(<span class="hljs-string">"2015-01-01T01:01:02Z"</span>));

    <span class="hljs-comment">// Parallel index task</span>

    TaskResource taskResource0 = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskResource0.getRequiredCapacity()).thenReturn(<span class="hljs-number">3</span>);

    Task parallelIndexTask = mock(ParallelIndexSupervisorTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(parallelIndexTask.getType()).thenReturn(ParallelIndexSupervisorTask.TYPE);

    when(parallelIndexTask.getTaskResource()).thenReturn(taskResource0);

    <span class="hljs-comment">// Since task satisifies parallel and total slot constraints, can run</span>

    Assert.assertTrue(workerInfo.canRunTask(parallelIndexTask, <span class="hljs-number">0.5</span>));

    <span class="hljs-comment">// Since task fails the parallel slot constraint, it cannot run (3 &gt; 1)</span>

    Assert.assertFalse(workerInfo.canRunTask(parallelIndexTask, <span class="hljs-number">0.1</span>));

    <span class="hljs-comment">// Some other indexing task</span>

    TaskResource taskResource1 = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskResource1.getRequiredCapacity()).thenReturn(<span class="hljs-number">5</span>);

    Task anyOtherTask = mock(IndexTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(anyOtherTask.getType()).thenReturn(<span class="hljs-string">"index"</span>);

    when(anyOtherTask.getTaskResource()).thenReturn(taskResource1);

    <span class="hljs-comment">// Not a parallel index task -&gt;  satisfies parallel index constraint</span>

    <span class="hljs-comment">// But does not satisfy the total slot constraint and cannot run (11 &gt; 10)</span>

    Assert.assertFalse(workerInfo.canRunTask(anyOtherTask, <span class="hljs-number">0.5</span>));

    <span class="hljs-comment">// Task has an availability conflict ("grp1")</span>

    TaskResource taskResource2 = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskResource2.getRequiredCapacity()).thenReturn(<span class="hljs-number">1</span>);

    when(taskResource2.getAvailabilityGroup()).thenReturn(<span class="hljs-string">"grp1"</span>);

    Task grp1Task = mock(IndexTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(grp1Task.getType()).thenReturn(<span class="hljs-string">"blah"</span>);

    when(grp1Task.getTaskResource()).thenReturn(taskResource2);

    <span class="hljs-comment">// Satisifies parallel index and total index slot constraints but cannot run due availability</span>

    Assert.assertFalse(workerInfo.canRunTask(grp1Task, <span class="hljs-number">0.3</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TaskResource <span class="hljs-title">createMockTaskResource</span><span class="hljs-params">(<span class="hljs-keyword">int</span> requiredCapacity)</span> </span>{
    TaskResource taskResource = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(taskResource.getRequiredCapacity()).thenReturn(requiredCapacity);
    <span class="hljs-keyword">return</span> taskResource;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest132">Test Case ID #druid_Test_13_2</h4>
<h4 id="test-case-name-testcanruntaskfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingoverlordimmutableworkerinfotestjava">Test Case Name: <code>test_canRunTask</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\overlord\ImmutableWorkerInfoTest.java</code>)</h4>
<h4 id="mock-object-variable-name-taskresource1">Mock Object Variable Name: <code>taskResource1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    // Since task fails the parallel slot constraint, it cannot run (3 &gt; 1)
    Assert.assertFalse(workerInfo.canRunTask(parallelIndexTask, 0.1));
    // Some other indexing task
<span class="hljs-deletion">-    TaskResource taskResource1 = mock(TaskResource.class);</span>
<span class="hljs-deletion">-    when(taskResource1.getRequiredCapacity()).thenReturn(5);</span>
<span class="hljs-addition">+    TaskResource taskResource1 = createMockTaskResource(5);</span>
    Task anyOtherTask = mock(IndexTask.class);
    when(anyOtherTask.getType()).thenReturn("index");
    when(anyOtherTask.getTaskResource()).thenReturn(taskResource1);
    // Not a parallel index task -&gt;  satisfies parallel index constraint
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test_canRunTask</span><span class="hljs-params">()</span> </span>{

    ImmutableWorkerInfo workerInfo = <span class="hljs-keyword">new</span> ImmutableWorkerInfo(<span class="hljs-keyword">new</span> Worker(<span class="hljs-string">"http"</span>, <span class="hljs-string">"testWorker2"</span>, <span class="hljs-string">"192.0.0.1"</span>, <span class="hljs-number">10</span>, <span class="hljs-string">"v1"</span>, WorkerConfig.DEFAULT_CATEGORY), <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, ImmutableSet.of(<span class="hljs-string">"grp1"</span>, <span class="hljs-string">"grp2"</span>), ImmutableSet.of(<span class="hljs-string">"task1"</span>, <span class="hljs-string">"task2"</span>), DateTimes.of(<span class="hljs-string">"2015-01-01T01:01:02Z"</span>));

    <span class="hljs-comment">// Parallel index task</span>

    TaskResource taskResource0 = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskResource0.getRequiredCapacity()).thenReturn(<span class="hljs-number">3</span>);

    Task parallelIndexTask = mock(ParallelIndexSupervisorTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(parallelIndexTask.getType()).thenReturn(ParallelIndexSupervisorTask.TYPE);

    when(parallelIndexTask.getTaskResource()).thenReturn(taskResource0);

    <span class="hljs-comment">// Since task satisifies parallel and total slot constraints, can run</span>

    Assert.assertTrue(workerInfo.canRunTask(parallelIndexTask, <span class="hljs-number">0.5</span>));

    <span class="hljs-comment">// Since task fails the parallel slot constraint, it cannot run (3 &gt; 1)</span>

    Assert.assertFalse(workerInfo.canRunTask(parallelIndexTask, <span class="hljs-number">0.1</span>));

    <span class="hljs-comment">// Some other indexing task</span>

    TaskResource taskResource1 = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskResource1.getRequiredCapacity()).thenReturn(<span class="hljs-number">5</span>);

    Task anyOtherTask = mock(IndexTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(anyOtherTask.getType()).thenReturn(<span class="hljs-string">"index"</span>);

    when(anyOtherTask.getTaskResource()).thenReturn(taskResource1);

    <span class="hljs-comment">// Not a parallel index task -&gt;  satisfies parallel index constraint</span>

    <span class="hljs-comment">// But does not satisfy the total slot constraint and cannot run (11 &gt; 10)</span>

    Assert.assertFalse(workerInfo.canRunTask(anyOtherTask, <span class="hljs-number">0.5</span>));

    <span class="hljs-comment">// Task has an availability conflict ("grp1")</span>

    TaskResource taskResource2 = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskResource2.getRequiredCapacity()).thenReturn(<span class="hljs-number">1</span>);

    when(taskResource2.getAvailabilityGroup()).thenReturn(<span class="hljs-string">"grp1"</span>);

    Task grp1Task = mock(IndexTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(grp1Task.getType()).thenReturn(<span class="hljs-string">"blah"</span>);

    when(grp1Task.getTaskResource()).thenReturn(taskResource2);

    <span class="hljs-comment">// Satisifies parallel index and total index slot constraints but cannot run due availability</span>

    Assert.assertFalse(workerInfo.canRunTask(grp1Task, <span class="hljs-number">0.3</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TaskResource <span class="hljs-title">createMockTaskResource</span><span class="hljs-params">(<span class="hljs-keyword">int</span> requiredCapacity)</span> </span>{
    TaskResource taskResource = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(taskResource.getRequiredCapacity()).thenReturn(requiredCapacity);
    <span class="hljs-keyword">return</span> taskResource;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest133">Test Case ID #druid_Test_13_3</h4>
<h4 id="test-case-name-testcanruntaskfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingoverlordimmutableworkerinfotestjava">Test Case Name: <code>test_canRunTask</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\overlord\ImmutableWorkerInfoTest.java</code>)</h4>
<h4 id="mock-object-variable-name-taskresource2">Mock Object Variable Name: <code>taskResource2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     // Task has an availability conflict ("grp1")
<span class="hljs-deletion">-    TaskResource taskResource2 = mock(TaskResource.class);</span>
<span class="hljs-deletion">-    when(taskResource2.getRequiredCapacity()).thenReturn(1);</span>
<span class="hljs-addition">+    TaskResource taskResource2 = createMockTaskResource(1);</span>
     when(taskResource2.getAvailabilityGroup()).thenReturn("grp1");
     Task grp1Task = mock(IndexTask.class);
     when(grp1Task.getType()).thenReturn("blah");
     when(grp1Task.getTaskResource()).thenReturn(taskResource2);
     // Satisifies parallel index and total index slot constraints but cannot run due availability
     Assert.assertFalse(workerInfo.canRunTask(grp1Task, 0.3));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test_canRunTask</span><span class="hljs-params">()</span> </span>{

    ImmutableWorkerInfo workerInfo = <span class="hljs-keyword">new</span> ImmutableWorkerInfo(<span class="hljs-keyword">new</span> Worker(<span class="hljs-string">"http"</span>, <span class="hljs-string">"testWorker2"</span>, <span class="hljs-string">"192.0.0.1"</span>, <span class="hljs-number">10</span>, <span class="hljs-string">"v1"</span>, WorkerConfig.DEFAULT_CATEGORY), <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, ImmutableSet.of(<span class="hljs-string">"grp1"</span>, <span class="hljs-string">"grp2"</span>), ImmutableSet.of(<span class="hljs-string">"task1"</span>, <span class="hljs-string">"task2"</span>), DateTimes.of(<span class="hljs-string">"2015-01-01T01:01:02Z"</span>));

    <span class="hljs-comment">// Parallel index task</span>

    TaskResource taskResource0 = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskResource0.getRequiredCapacity()).thenReturn(<span class="hljs-number">3</span>);

    Task parallelIndexTask = mock(ParallelIndexSupervisorTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(parallelIndexTask.getType()).thenReturn(ParallelIndexSupervisorTask.TYPE);

    when(parallelIndexTask.getTaskResource()).thenReturn(taskResource0);

    <span class="hljs-comment">// Since task satisifies parallel and total slot constraints, can run</span>

    Assert.assertTrue(workerInfo.canRunTask(parallelIndexTask, <span class="hljs-number">0.5</span>));

    <span class="hljs-comment">// Since task fails the parallel slot constraint, it cannot run (3 &gt; 1)</span>

    Assert.assertFalse(workerInfo.canRunTask(parallelIndexTask, <span class="hljs-number">0.1</span>));

    <span class="hljs-comment">// Some other indexing task</span>

    TaskResource taskResource1 = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskResource1.getRequiredCapacity()).thenReturn(<span class="hljs-number">5</span>);

    Task anyOtherTask = mock(IndexTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(anyOtherTask.getType()).thenReturn(<span class="hljs-string">"index"</span>);

    when(anyOtherTask.getTaskResource()).thenReturn(taskResource1);

    <span class="hljs-comment">// Not a parallel index task -&gt;  satisfies parallel index constraint</span>

    <span class="hljs-comment">// But does not satisfy the total slot constraint and cannot run (11 &gt; 10)</span>

    Assert.assertFalse(workerInfo.canRunTask(anyOtherTask, <span class="hljs-number">0.5</span>));

    <span class="hljs-comment">// Task has an availability conflict ("grp1")</span>

    TaskResource taskResource2 = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskResource2.getRequiredCapacity()).thenReturn(<span class="hljs-number">1</span>);

    when(taskResource2.getAvailabilityGroup()).thenReturn(<span class="hljs-string">"grp1"</span>);

    Task grp1Task = mock(IndexTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(grp1Task.getType()).thenReturn(<span class="hljs-string">"blah"</span>);

    when(grp1Task.getTaskResource()).thenReturn(taskResource2);

    <span class="hljs-comment">// Satisifies parallel index and total index slot constraints but cannot run due availability</span>

    Assert.assertFalse(workerInfo.canRunTask(grp1Task, <span class="hljs-number">0.3</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TaskResource <span class="hljs-title">createMockTaskResource</span><span class="hljs-params">(<span class="hljs-keyword">int</span> requiredCapacity)</span> </span>{
    TaskResource taskResource = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(taskResource.getRequiredCapacity()).thenReturn(requiredCapacity);
    <span class="hljs-keyword">return</span> taskResource;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci14">Mock Clone Instance #druid_MCI_14</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.indexing.common.actions.TaskActionToolbox</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockTaskActionToolbox</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TaskActionToolbox <span class="hljs-title">createMockTaskActionToolbox</span><span class="hljs-params">(TaskRunner runner)</span> </span>{
    TaskActionToolbox toolbox = mock(TaskActionToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(toolbox.getTaskRunner()).thenReturn(Optional.of(runner));
    <span class="hljs-keyword">return</span> toolbox;
  }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest141">Test Case ID #druid_Test_14_1</h4>
<h4 id="test-case-name-testflowfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommonactionsupdatelocationactiontestjava">Test Case Name: <code>testFlow</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\actions\UpdateLocationActionTest.java</code>)</h4>
<h4 id="mock-object-variable-name-toolbox">Mock Object Variable Name: <code>toolbox</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Task task = NoopTask.create();
<span class="hljs-deletion">-    TaskActionToolbox toolbox = mock(TaskActionToolbox.class);</span>
    TaskRunner runner = mock(TaskRunner.class);
<span class="hljs-deletion">-    when(toolbox.getTaskRunner()).thenReturn(Optional.of(runner));</span>
<span class="hljs-addition">+    TaskActionToolbox toolbox = MockTaskActionToolbox.createMockTaskActionToolbox(runner);</span>
    action.perform(task, toolbox);
    verify(runner, times(1)).updateLocation(eq(task), eq(myLocation));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFlow</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> UnknownHostException </span>{

    <span class="hljs-comment">// get my task location</span>

    InetAddress hostName = InetAddress.getLocalHost();

    TaskLocation myLocation = TaskLocation.create(hostName.getHostAddress(), <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);

    UpdateLocationAction action = <span class="hljs-keyword">new</span> UpdateLocationAction(myLocation);

    Task task = NoopTask.create();

    TaskActionToolbox toolbox = mock(TaskActionToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TaskRunner runner = mock(TaskRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskRunner()).thenReturn(Optional.of(runner));

    action.perform(task, toolbox);

    verify(runner, times(<span class="hljs-number">1</span>)).updateLocation(eq(task), eq(myLocation));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockTaskActionToolbox</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TaskActionToolbox <span class="hljs-title">createMockTaskActionToolbox</span><span class="hljs-params">(TaskRunner runner)</span> </span>{
    TaskActionToolbox toolbox = mock(TaskActionToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(toolbox.getTaskRunner()).thenReturn(Optional.of(runner));
    <span class="hljs-keyword">return</span> toolbox;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest142">Test Case ID #druid_Test_14_2</h4>
<h4 id="test-case-name-testactioncallstaskrunnerfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommonactionsupdatestatusactiontestjava">Test Case Name: <code>testActionCallsTaskRunner</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\actions\UpdateStatusActionTest.java</code>)</h4>
<h4 id="mock-object-variable-name-toolbox">Mock Object Variable Name: <code>toolbox</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    UpdateStatusAction action = new UpdateStatusAction("successful");
    Task task = NoopTask.create();
<span class="hljs-deletion">-    TaskActionToolbox toolbox = mock(TaskActionToolbox.class);</span>
    TaskRunner runner = mock(TaskRunner.class);
<span class="hljs-deletion">-    when(toolbox.getTaskRunner()).thenReturn(Optional.of(runner));</span>
<span class="hljs-addition">+    TaskActionToolbox toolbox = MockTaskActionToolbox.createMockTaskActionToolbox(runner);</span>
    action.perform(task, toolbox);
    verify(runner, times(1)).updateStatus(eq(task), eq(TaskStatus.success(task.getId())));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testActionCallsTaskRunner</span><span class="hljs-params">()</span> </span>{

    UpdateStatusAction action = <span class="hljs-keyword">new</span> UpdateStatusAction(<span class="hljs-string">"successful"</span>);

    Task task = NoopTask.create();

    TaskActionToolbox toolbox = mock(TaskActionToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TaskRunner runner = mock(TaskRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskRunner()).thenReturn(Optional.of(runner));

    action.perform(task, toolbox);

    verify(runner, times(<span class="hljs-number">1</span>)).updateStatus(eq(task), eq(TaskStatus.success(task.getId())));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockTaskActionToolbox</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TaskActionToolbox <span class="hljs-title">createMockTaskActionToolbox</span><span class="hljs-params">(TaskRunner runner)</span> </span>{
    TaskActionToolbox toolbox = mock(TaskActionToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(toolbox.getTaskRunner()).thenReturn(Optional.of(runner));
    <span class="hljs-keyword">return</span> toolbox;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest143">Test Case ID #druid_Test_14_3</h4>
<h4 id="test-case-name-testfailurescenariofile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommonactionsupdatestatusactiontestjava">Test Case Name: <code>testFailureScenario</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\actions\UpdateStatusActionTest.java</code>)</h4>
<h4 id="mock-object-variable-name-toolbox">Mock Object Variable Name: <code>toolbox</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    UpdateStatusAction action = new UpdateStatusAction("failure");
    Task task = NoopTask.create();
<span class="hljs-deletion">-    TaskActionToolbox toolbox = mock(TaskActionToolbox.class);</span>
    TaskRunner runner = mock(TaskRunner.class);
<span class="hljs-deletion">-    when(toolbox.getTaskRunner()).thenReturn(Optional.of(runner));</span>
<span class="hljs-addition">+    TaskActionToolbox toolbox = MockTaskActionToolbox.createMockTaskActionToolbox(runner);</span>
    action.perform(task, toolbox);
    verify(runner, times(1)).updateStatus(eq(task), eq(TaskStatus.failure(task.getId(), "Error with task")));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFailureScenario</span><span class="hljs-params">()</span> </span>{

    UpdateStatusAction action = <span class="hljs-keyword">new</span> UpdateStatusAction(<span class="hljs-string">"failure"</span>);

    Task task = NoopTask.create();

    TaskActionToolbox toolbox = mock(TaskActionToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TaskRunner runner = mock(TaskRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskRunner()).thenReturn(Optional.of(runner));

    action.perform(task, toolbox);

    verify(runner, times(<span class="hljs-number">1</span>)).updateStatus(eq(task), eq(TaskStatus.failure(task.getId(), <span class="hljs-string">"Error with task"</span>)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockTaskActionToolbox</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TaskActionToolbox <span class="hljs-title">createMockTaskActionToolbox</span><span class="hljs-params">(TaskRunner runner)</span> </span>{
    TaskActionToolbox toolbox = mock(TaskActionToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(toolbox.getTaskRunner()).thenReturn(Optional.of(runner));
    <span class="hljs-keyword">return</span> toolbox;
  }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci15">Mock Clone Instance #druid_MCI_15</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.indexing.common.actions.TaskActionToolbox</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockTaskActionToolbox</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TaskActionToolbox <span class="hljs-title">createMockTaskActionToolbox</span><span class="hljs-params">(com.google.common.base.Optional&lt;?&gt; taskRunnerReturn)</span> </span>{
    TaskActionToolbox toolbox = mock(TaskActionToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(toolbox.getTaskRunner()).thenReturn(taskRunnerReturn);
    <span class="hljs-keyword">return</span> toolbox;
  }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest151">Test Case ID #druid_Test_15_1</h4>
<h4 id="test-case-name-testwithnotaskrunnerfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommonactionsupdatelocationactiontestjava">Test Case Name: <code>testWithNoTaskRunner</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\actions\UpdateLocationActionTest.java</code>)</h4>
<h4 id="mock-object-variable-name-toolbox">Mock Object Variable Name: <code>toolbox</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    UpdateLocationAction action = new UpdateLocationAction(myLocation);
    Task task = NoopTask.create();
<span class="hljs-deletion">-    TaskActionToolbox toolbox = mock(TaskActionToolbox.class);</span>
<span class="hljs-deletion">-    TaskRunner runner = mock(TaskRunner.class);</span>
<span class="hljs-deletion">-    when(toolbox.getTaskRunner()).thenReturn(Optional.absent());</span>
<span class="hljs-addition">+    TaskActionToolbox toolbox = MockTaskActionToolbox.createMockTaskActionToolbox(Optional.absent());</span>
<span class="hljs-addition">+    TaskRunner runner = mock(TaskRunner.class);</span>
    action.perform(task, toolbox);
    verify(runner, never()).updateStatus(any(), any());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testWithNoTaskRunner</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> UnknownHostException </span>{

    <span class="hljs-comment">// get my task location</span>

    InetAddress hostName = InetAddress.getLocalHost();

    TaskLocation myLocation = TaskLocation.create(hostName.getHostAddress(), <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);

    UpdateLocationAction action = <span class="hljs-keyword">new</span> UpdateLocationAction(myLocation);

    Task task = NoopTask.create();

    TaskActionToolbox toolbox = mock(TaskActionToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TaskRunner runner = mock(TaskRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskRunner()).thenReturn(Optional.absent());

    action.perform(task, toolbox);

    verify(runner, never()).updateStatus(any(), any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockTaskActionToolbox</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TaskActionToolbox <span class="hljs-title">createMockTaskActionToolbox</span><span class="hljs-params">(com.google.common.base.Optional&lt;?&gt; taskRunnerReturn)</span> </span>{
    TaskActionToolbox toolbox = mock(TaskActionToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(toolbox.getTaskRunner()).thenReturn(taskRunnerReturn);
    <span class="hljs-keyword">return</span> toolbox;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest152">Test Case ID #druid_Test_15_2</h4>
<h4 id="test-case-name-testnotaskrunnerfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommonactionsupdatestatusactiontestjava">Test Case Name: <code>testNoTaskRunner</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\actions\UpdateStatusActionTest.java</code>)</h4>
<h4 id="mock-object-variable-name-toolbox">Mock Object Variable Name: <code>toolbox</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     UpdateStatusAction action = new UpdateStatusAction("successful");
     Task task = NoopTask.create();
<span class="hljs-deletion">-    TaskActionToolbox toolbox = mock(TaskActionToolbox.class);</span>
<span class="hljs-deletion">-    TaskRunner runner = mock(TaskRunner.class);</span>
<span class="hljs-deletion">-    when(toolbox.getTaskRunner()).thenReturn(Optional.absent());</span>
<span class="hljs-addition">+    TaskActionToolbox toolbox = MockTaskActionToolbox.createMockTaskActionToolbox(Optional.absent());</span>
<span class="hljs-addition">+    TaskRunner runner = mock(TaskRunner.class);</span>
     action.perform(task, toolbox);
     verify(runner, never()).updateStatus(any(), any());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNoTaskRunner</span><span class="hljs-params">()</span> </span>{

    UpdateStatusAction action = <span class="hljs-keyword">new</span> UpdateStatusAction(<span class="hljs-string">"successful"</span>);

    Task task = NoopTask.create();

    TaskActionToolbox toolbox = mock(TaskActionToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TaskRunner runner = mock(TaskRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskRunner()).thenReturn(Optional.absent());

    action.perform(task, toolbox);

    verify(runner, never()).updateStatus(any(), any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockTaskActionToolbox</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TaskActionToolbox <span class="hljs-title">createMockTaskActionToolbox</span><span class="hljs-params">(com.google.common.base.Optional&lt;?&gt; taskRunnerReturn)</span> </span>{
    TaskActionToolbox toolbox = mock(TaskActionToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(toolbox.getTaskRunner()).thenReturn(taskRunnerReturn);
    <span class="hljs-keyword">return</span> toolbox;
  }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci16">Mock Clone Instance #druid_MCI_16</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.indexing.overlord.autoscaling.ProvisioningSchedulerConfig</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProvisioningSchedulerConfig <span class="hljs-title">createMockProvisioningSchedulerConfig</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> doAutoscaleReturn)</span> </span>{
    ProvisioningSchedulerConfig provisioningSchedulerConfig = Mockito.mock(ProvisioningSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(provisioningSchedulerConfig.isDoAutoscale()).thenReturn(doAutoscaleReturn);
    <span class="hljs-keyword">return</span> provisioningSchedulerConfig;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest161">Test Case ID #druid_Test_16_1</h4>
<h4 id="test-case-name-testbuildwithautoscalefile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingoverlordremotetaskrunnerfactorytestjava">Test Case Name: <code>testBuildWithAutoScale</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\overlord\RemoteTaskRunnerFactoryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-provisioningschedulerconfig">Mock Object Variable Name: <code>provisioningSchedulerConfig</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testBuildWithAutoScale() {
<span class="hljs-deletion">-    ProvisioningSchedulerConfig provisioningSchedulerConfig = Mockito.mock(ProvisioningSchedulerConfig.class);</span>
<span class="hljs-deletion">-    Mockito.when(provisioningSchedulerConfig.isDoAutoscale()).thenReturn(true);</span>
<span class="hljs-addition">+    ProvisioningSchedulerConfig provisioningSchedulerConfig = createMockProvisioningSchedulerConfig(true);</span>
     RemoteTaskRunnerFactory remoteTaskRunnerFactory = getTestRemoteTaskRunnerFactory(provisioningSchedulerConfig);
     Assert.assertNull(remoteTaskRunnerFactory.build().getProvisioningStrategy());
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testBuildWithAutoScale</span><span class="hljs-params">()</span> </span>{

    ProvisioningSchedulerConfig provisioningSchedulerConfig = Mockito.mock(ProvisioningSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(provisioningSchedulerConfig.isDoAutoscale()).thenReturn(<span class="hljs-keyword">true</span>);

    RemoteTaskRunnerFactory remoteTaskRunnerFactory = getTestRemoteTaskRunnerFactory(provisioningSchedulerConfig);

    Assert.assertNull(remoteTaskRunnerFactory.build().getProvisioningStrategy());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProvisioningSchedulerConfig <span class="hljs-title">createMockProvisioningSchedulerConfig</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> doAutoscaleReturn)</span> </span>{
    ProvisioningSchedulerConfig provisioningSchedulerConfig = Mockito.mock(ProvisioningSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(provisioningSchedulerConfig.isDoAutoscale()).thenReturn(doAutoscaleReturn);
    <span class="hljs-keyword">return</span> provisioningSchedulerConfig;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest162">Test Case ID #druid_Test_16_2</h4>
<h4 id="test-case-name-testbuildwithoutautoscalefile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingoverlordremotetaskrunnerfactorytestjava">Test Case Name: <code>testBuildWithoutAutoScale</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\overlord\RemoteTaskRunnerFactoryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-provisioningschedulerconfig">Mock Object Variable Name: <code>provisioningSchedulerConfig</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testBuildWithoutAutoScale() {
<span class="hljs-deletion">-    ProvisioningSchedulerConfig provisioningSchedulerConfig = Mockito.mock(ProvisioningSchedulerConfig.class);</span>
<span class="hljs-deletion">-    Mockito.when(provisioningSchedulerConfig.isDoAutoscale()).thenReturn(false);</span>
<span class="hljs-addition">+    ProvisioningSchedulerConfig provisioningSchedulerConfig = createMockProvisioningSchedulerConfig(false);</span>
     RemoteTaskRunnerFactory remoteTaskRunnerFactory = getTestRemoteTaskRunnerFactory(provisioningSchedulerConfig);
     Assert.assertTrue(remoteTaskRunnerFactory.build().getProvisioningStrategy() instanceof NoopProvisioningStrategy);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testBuildWithoutAutoScale</span><span class="hljs-params">()</span> </span>{

    ProvisioningSchedulerConfig provisioningSchedulerConfig = Mockito.mock(ProvisioningSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(provisioningSchedulerConfig.isDoAutoscale()).thenReturn(<span class="hljs-keyword">false</span>);

    RemoteTaskRunnerFactory remoteTaskRunnerFactory = getTestRemoteTaskRunnerFactory(provisioningSchedulerConfig);

    Assert.assertTrue(remoteTaskRunnerFactory.build().getProvisioningStrategy() <span class="hljs-keyword">instanceof</span> NoopProvisioningStrategy);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProvisioningSchedulerConfig <span class="hljs-title">createMockProvisioningSchedulerConfig</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> doAutoscaleReturn)</span> </span>{
    ProvisioningSchedulerConfig provisioningSchedulerConfig = Mockito.mock(ProvisioningSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(provisioningSchedulerConfig.isDoAutoscale()).thenReturn(doAutoscaleReturn);
    <span class="hljs-keyword">return</span> provisioningSchedulerConfig;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci17">Mock Clone Instance #druid_MCI_17</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.mockito.MockedStatic&lt;org.apache.druid.utils.ConnectionUriUtils&gt;</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MockedStatic&lt;ConnectionUriUtils&gt; utils;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    utils = Mockito.mockStatic(ConnectionUriUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
utils

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest171">Test Case ID #druid_Test_17_1</h4>
<h4 id="test-case-name-testmysqlfallbackmysqlmaria2xfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidutilsconnectionuriutilstestjava">Test Case Name: <code>testMySqlFallbackMySqlMaria2x</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\utils\ConnectionUriUtilsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-utils">Mock Object Variable Name: <code>utils</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testMySqlFallbackMySqlMaria2x() {
<span class="hljs-deletion">-    MockedStatic&lt;ConnectionUriUtils&gt; utils = Mockito.mockStatic(ConnectionUriUtils.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `utils`</span>
     utils.when(() -&gt; ConnectionUriUtils.tryParseJdbcUriParameters(MYSQL_URI, false)).thenCallRealMethod();
     utils.when(() -&gt; ConnectionUriUtils.tryParseMySqlConnectionUri(MYSQL_URI)).thenThrow(ClassNotFoundException.class);
     utils.when(() -&gt; ConnectionUriUtils.tryParseMariaDb2xConnectionUri(MYSQL_URI)).thenCallRealMethod();
     Set&lt;String&gt; props = ConnectionUriUtils.tryParseJdbcUriParameters(MYSQL_URI, false);
     // this would be 9 if didn't fall back to mariadb
     Assert.assertEquals(4, props.size());
     utils.close();
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMySqlFallbackMySqlMaria2x</span><span class="hljs-params">()</span> </span>{

    MockedStatic&lt;ConnectionUriUtils&gt; utils = Mockito.mockStatic(ConnectionUriUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    utils.when(() -&gt; ConnectionUriUtils.tryParseJdbcUriParameters(MYSQL_URI, <span class="hljs-keyword">false</span>)).thenCallRealMethod();

    utils.when(() -&gt; ConnectionUriUtils.tryParseMySqlConnectionUri(MYSQL_URI)).thenThrow(ClassNotFoundException<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    utils.when(() -&gt; ConnectionUriUtils.tryParseMariaDb2xConnectionUri(MYSQL_URI)).thenCallRealMethod();

    Set&lt;String&gt; props = ConnectionUriUtils.tryParseJdbcUriParameters(MYSQL_URI, <span class="hljs-keyword">false</span>);

    <span class="hljs-comment">// this would be 9 if didn't fall back to mariadb</span>

    Assert.assertEquals(<span class="hljs-number">4</span>, props.size());

    utils.close();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MockedStatic&lt;ConnectionUriUtils&gt; utils;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    utils = Mockito.mockStatic(ConnectionUriUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
utils

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest172">Test Case ID #druid_Test_17_2</h4>
<h4 id="test-case-name-testmariafallbackmaria3xfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidutilsconnectionuriutilstestjava">Test Case Name: <code>testMariaFallbackMaria3x</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\utils\ConnectionUriUtilsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-utils">Mock Object Variable Name: <code>utils</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testMariaFallbackMaria3x() {
<span class="hljs-deletion">-    MockedStatic&lt;ConnectionUriUtils&gt; utils = Mockito.mockStatic(ConnectionUriUtils.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `utils`</span>
     utils.when(() -&gt; ConnectionUriUtils.tryParseJdbcUriParameters(MARIA_URI, false)).thenCallRealMethod();
     utils.when(() -&gt; ConnectionUriUtils.tryParseMariaDb2xConnectionUri(MARIA_URI)).thenThrow(ClassNotFoundException.class);
     utils.when(() -&gt; ConnectionUriUtils.tryParseMariaDb3xConnectionUri(MARIA_URI)).thenCallRealMethod();
     try {
         Set&lt;String&gt; props = ConnectionUriUtils.tryParseJdbcUriParameters(MARIA_URI, false);
         // this would be 4 if didn't fall back to mariadb 3x
         Assert.assertEquals(8, props.size());
     } catch (RuntimeException e) {
         Assert.assertTrue(e.getMessage().contains("Failed to find MariaDB driver class"));
     }
     utils.close();
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMariaFallbackMaria3x</span><span class="hljs-params">()</span> </span>{

    MockedStatic&lt;ConnectionUriUtils&gt; utils = Mockito.mockStatic(ConnectionUriUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    utils.when(() -&gt; ConnectionUriUtils.tryParseJdbcUriParameters(MARIA_URI, <span class="hljs-keyword">false</span>)).thenCallRealMethod();

    utils.when(() -&gt; ConnectionUriUtils.tryParseMariaDb2xConnectionUri(MARIA_URI)).thenThrow(ClassNotFoundException<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    utils.when(() -&gt; ConnectionUriUtils.tryParseMariaDb3xConnectionUri(MARIA_URI)).thenCallRealMethod();

    <span class="hljs-keyword">try</span> {

        Set&lt;String&gt; props = ConnectionUriUtils.tryParseJdbcUriParameters(MARIA_URI, <span class="hljs-keyword">false</span>);

        <span class="hljs-comment">// this would be 4 if didn't fall back to mariadb 3x</span>

        Assert.assertEquals(<span class="hljs-number">8</span>, props.size());

    } <span class="hljs-keyword">catch</span> (RuntimeException e) {

        Assert.assertTrue(e.getMessage().contains(<span class="hljs-string">"Failed to find MariaDB driver class"</span>));

    }

    utils.close();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MockedStatic&lt;ConnectionUriUtils&gt; utils;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    utils = Mockito.mockStatic(ConnectionUriUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
utils

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest173">Test Case ID #druid_Test_17_3</h4>
<h4 id="test-case-name-testmysqlfallbackmysqlnodriversfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidutilsconnectionuriutilstestjava">Test Case Name: <code>testMySqlFallbackMySqlNoDrivers</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\utils\ConnectionUriUtilsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-utils">Mock Object Variable Name: <code>utils</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testMySqlFallbackMySqlNoDrivers() {
<span class="hljs-deletion">-    MockedStatic&lt;ConnectionUriUtils&gt; utils = Mockito.mockStatic(ConnectionUriUtils.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `utils`</span>
     utils.when(() -&gt; ConnectionUriUtils.tryParseJdbcUriParameters(MYSQL_URI, false)).thenCallRealMethod();
     utils.when(() -&gt; ConnectionUriUtils.tryParseMySqlConnectionUri(MYSQL_URI)).thenThrow(ClassNotFoundException.class);
     utils.when(() -&gt; ConnectionUriUtils.tryParseMariaDb2xConnectionUri(MYSQL_URI)).thenThrow(ClassNotFoundException.class);
     try {
         ConnectionUriUtils.tryParseJdbcUriParameters(MYSQL_URI, false);
     } catch (RuntimeException e) {
         Assert.assertTrue(e.getMessage().contains("Failed to find MySQL driver class"));
     }
     utils.close();
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMySqlFallbackMySqlNoDrivers</span><span class="hljs-params">()</span> </span>{

    MockedStatic&lt;ConnectionUriUtils&gt; utils = Mockito.mockStatic(ConnectionUriUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    utils.when(() -&gt; ConnectionUriUtils.tryParseJdbcUriParameters(MYSQL_URI, <span class="hljs-keyword">false</span>)).thenCallRealMethod();

    utils.when(() -&gt; ConnectionUriUtils.tryParseMySqlConnectionUri(MYSQL_URI)).thenThrow(ClassNotFoundException<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    utils.when(() -&gt; ConnectionUriUtils.tryParseMariaDb2xConnectionUri(MYSQL_URI)).thenThrow(ClassNotFoundException<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">try</span> {

        ConnectionUriUtils.tryParseJdbcUriParameters(MYSQL_URI, <span class="hljs-keyword">false</span>);

    } <span class="hljs-keyword">catch</span> (RuntimeException e) {

        Assert.assertTrue(e.getMessage().contains(<span class="hljs-string">"Failed to find MySQL driver class"</span>));

    }

    utils.close();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> MockedStatic&lt;ConnectionUriUtils&gt; utils;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    utils = Mockito.mockStatic(ConnectionUriUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
utils

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci18">Mock Clone Instance #druid_MCI_18</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>javax.servlet.http.HttpServletRequest</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> HttpServletRequest request;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    request = Mockito.mock(HttpServletRequest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
request;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest181">Test Case ID #druid_Test_18_1</h4>
<h4 id="test-case-name-testhandlequeryparseexceptionwithfilterdisabledfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleQueryParseExceptionWithFilterDisabled</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-request">Mock Object Variable Name: <code>request</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testHandleQueryParseExceptionWithFilterDisabled() throws Exception {
     String errorMessage = "test exception message";
     ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);
<span class="hljs-deletion">-    HttpServletRequest request = Mockito.mock(HttpServletRequest.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `request`</span>
     HttpServletResponse response = Mockito.mock(HttpServletResponse.class);
     ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);
     Mockito.when(response.getOutputStream()).thenReturn(outputStream);
     final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig());
     IOException testException = new IOException(errorMessage);
     servlet.handleQueryParseException(request, response, mockMapper, testException, false);
     ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception.class);
     Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());
     Assert.assertTrue(captor.getValue() instanceof QueryException);
     Assert.assertEquals("Unknown exception", ((QueryException) captor.getValue()).getErrorCode());
     Assert.assertEquals(errorMessage, captor.getValue().getMessage());
     Assert.assertEquals(IOException.class.getName(), ((QueryException) captor.getValue()).getErrorClass());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleQueryParseExceptionWithFilterDisabled</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletRequest request = Mockito.mock(HttpServletRequest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig());

    IOException testException = <span class="hljs-keyword">new</span> IOException(errorMessage);

    servlet.handleQueryParseException(request, response, mockMapper, testException, <span class="hljs-keyword">false</span>);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertEquals(errorMessage, captor.getValue().getMessage());

    Assert.assertEquals(IOException<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), ((<span class="hljs-title">QueryException</span>) <span class="hljs-title">captor</span>.<span class="hljs-title">getValue</span>()).<span class="hljs-title">getErrorClass</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> HttpServletRequest request;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    request = Mockito.mock(HttpServletRequest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
request;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest182">Test Case ID #druid_Test_18_2</h4>
<h4 id="test-case-name-testhandlequeryparseexceptionwithfilterenabledfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleQueryParseExceptionWithFilterEnabled</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-request">Mock Object Variable Name: <code>request</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testHandleQueryParseExceptionWithFilterEnabled() throws Exception {
     String errorMessage = "test exception message";
     ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);
<span class="hljs-deletion">-    HttpServletRequest request = Mockito.mock(HttpServletRequest.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `request`</span>
     HttpServletResponse response = Mockito.mock(HttpServletResponse.class);
     ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);
     Mockito.when(response.getOutputStream()).thenReturn(outputStream);
     final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig() {

         @Override
         public boolean isShowDetailedJettyErrors() {
             return true;
         }

         @Override
         public ErrorResponseTransformStrategy getErrorResponseTransformStrategy() {
             return new AllowedRegexErrorResponseTransformStrategy(ImmutableList.of());
         }
     });
     IOException testException = new IOException(errorMessage);
     servlet.handleQueryParseException(request, response, mockMapper, testException, false);
     ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception.class);
     Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());
     Assert.assertTrue(captor.getValue() instanceof QueryException);
     Assert.assertEquals("Unknown exception", ((QueryException) captor.getValue()).getErrorCode());
     Assert.assertNull(captor.getValue().getMessage());
     Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());
     Assert.assertNull(((QueryException) captor.getValue()).getHost());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleQueryParseExceptionWithFilterEnabled</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletRequest request = Mockito.mock(HttpServletRequest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isShowDetailedJettyErrors</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> ErrorResponseTransformStrategy <span class="hljs-title">getErrorResponseTransformStrategy</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AllowedRegexErrorResponseTransformStrategy(ImmutableList.of());

        }

    });

    IOException testException = <span class="hljs-keyword">new</span> IOException(errorMessage);

    servlet.handleQueryParseException(request, response, mockMapper, testException, <span class="hljs-keyword">false</span>);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertNull(captor.getValue().getMessage());

    Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());

    Assert.assertNull(((QueryException) captor.getValue()).getHost());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> HttpServletRequest request;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    request = Mockito.mock(HttpServletRequest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
request;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest183">Test Case ID #druid_Test_18_3</h4>
<h4 id="test-case-name-testhandlequeryparseexceptionwithfilterenabledbutmessagematchallowedregexfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleQueryParseExceptionWithFilterEnabledButMessageMatchAllowedRegex</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-request">Mock Object Variable Name: <code>request</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testHandleQueryParseExceptionWithFilterEnabledButMessageMatchAllowedRegex() throws Exception {
     String errorMessage = "test exception message";
     ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);
<span class="hljs-deletion">-    HttpServletRequest request = Mockito.mock(HttpServletRequest.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `request`</span>
     HttpServletResponse response = Mockito.mock(HttpServletResponse.class);
     ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);
     Mockito.when(response.getOutputStream()).thenReturn(outputStream);
     final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig() {

         @Override
         public boolean isShowDetailedJettyErrors() {
             return true;
         }

         @Override
         public ErrorResponseTransformStrategy getErrorResponseTransformStrategy() {
             return new AllowedRegexErrorResponseTransformStrategy(ImmutableList.of("test .*"));
         }
     });
     IOException testException = new IOException(errorMessage);
<span class="hljs-deletion">-    servlet.handleQueryParseException(request, response, mockMapper, testException, false);</span>
<span class="hljs-addition">+    servlet.handleQueryParseException(request, response, mockMapper, testException, false);</span>
     ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception.class);
     Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());
     Assert.assertTrue(captor.getValue() instanceof QueryException);
     Assert.assertEquals("Unknown exception", ((QueryException) captor.getValue()).getErrorCode());
     Assert.assertEquals(errorMessage, captor.getValue().getMessage());
     Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());
     Assert.assertNull(((QueryException) captor.getValue()).getHost());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleQueryParseExceptionWithFilterEnabledButMessageMatchAllowedRegex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletRequest request = Mockito.mock(HttpServletRequest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isShowDetailedJettyErrors</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> ErrorResponseTransformStrategy <span class="hljs-title">getErrorResponseTransformStrategy</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AllowedRegexErrorResponseTransformStrategy(ImmutableList.of(<span class="hljs-string">"test .*"</span>));

        }

    });

    IOException testException = <span class="hljs-keyword">new</span> IOException(errorMessage);

    servlet.handleQueryParseException(request, response, mockMapper, testException, <span class="hljs-keyword">false</span>);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertEquals(errorMessage, captor.getValue().getMessage());

    Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());

    Assert.assertNull(((QueryException) captor.getValue()).getHost());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> HttpServletRequest request;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    request = Mockito.mock(HttpServletRequest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
request;

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci19">Mock Clone Instance #druid_MCI_19</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.indexing.common.actions.TaskActionClient</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TaskActionClient <span class="hljs-title">createMockTaskActionClient</span><span class="hljs-params">()</span> </span>{
    TaskActionClient taskActionClient = mock(TaskActionClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(taskActionClient.submit(any())).thenReturn(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> taskActionClient;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest191">Test Case ID #druid_Test_19_1</h4>
<h4 id="test-case-name-testsetupandcleanupiscalledwtihparameterfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommontaskabstracttasktestjava">Test Case Name: <code>testSetupAndCleanupIsCalledWtihParameter</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\task\AbstractTaskTest.java</code>)</h4>
<h4 id="mock-object-variable-name-taskactionclient">Mock Object Variable Name: <code>taskActionClient</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(toolbox.getJsonMapper()).thenReturn(objectMapper);
<span class="hljs-deletion">-    TaskActionClient taskActionClient = mock(TaskActionClient.class);</span>
<span class="hljs-deletion">-    when(taskActionClient.submit(any())).thenReturn(TaskConfig.class);</span>
<span class="hljs-addition">+    TaskActionClient taskActionClient = createMockTaskActionClient();</span>
    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);
    AbstractTask task = new NoopTask("myID", null, null, 1, 0, null) {

</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSetupAndCleanupIsCalledWtihParameter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-comment">// These tests apparently use Mockito.  Mockito is bad as we've seen it rewrite byte code and effectively cause</span>

    <span class="hljs-comment">// impact to other totally unrelated tests.  Mockito needs to be completely erradicated from the codebase.  This</span>

    <span class="hljs-comment">// comment is here to either cause me to do it in this commit or just for posterity so that it is clear that it</span>

    <span class="hljs-comment">// should happen in the future.</span>

    TaskToolbox toolbox = mock(TaskToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getAttemptId()).thenReturn(<span class="hljs-string">"1"</span>);

    DruidNode node = <span class="hljs-keyword">new</span> DruidNode(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>);

    when(toolbox.getTaskExecutorNode()).thenReturn(node);

    TaskLogPusher pusher = mock(TaskLogPusher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskLogPusher()).thenReturn(pusher);

    TaskConfig config = mock(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(config.isEncapsulatedTask()).thenReturn(<span class="hljs-keyword">true</span>);

    File folder = temporaryFolder.newFolder();

    when(config.getTaskDir(eq(<span class="hljs-string">"myID"</span>))).thenReturn(folder);

    when(toolbox.getConfig()).thenReturn(config);

    when(toolbox.getJsonMapper()).thenReturn(objectMapper);

    TaskActionClient taskActionClient = mock(TaskActionClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskActionClient.submit(any())).thenReturn(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);

    AbstractTask task = <span class="hljs-keyword">new</span> NoopTask(<span class="hljs-string">"myID"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>) {



        <span class="hljs-meta">@Nullable</span>

        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">setup</span><span class="hljs-params">(TaskToolbox toolbox)</span> <span class="hljs-keyword">throws</span> Exception </span>{

            <span class="hljs-comment">// create a reports file to test the taskLogPusher pushes task reports</span>

            String result = <span class="hljs-keyword">super</span>.setup(toolbox);

            File attemptDir = Paths.get(folder.getAbsolutePath(), <span class="hljs-string">"attempt"</span>, toolbox.getAttemptId()).toFile();

            File reportsDir = <span class="hljs-keyword">new</span> File(attemptDir, <span class="hljs-string">"report.json"</span>);

            File statusDir = <span class="hljs-keyword">new</span> File(attemptDir, <span class="hljs-string">"status.json"</span>);

            FileUtils.write(reportsDir, <span class="hljs-string">"foo"</span>, StandardCharsets.UTF_8);

            FileUtils.write(statusDir, <span class="hljs-string">"{}"</span>, StandardCharsets.UTF_8);

            <span class="hljs-keyword">return</span> result;

        }

    };

    task.run(toolbox);

    <span class="hljs-comment">// call it 3 times, once to update location in setup, then one for status and location in cleanup</span>

    Mockito.verify(taskActionClient, times(<span class="hljs-number">3</span>)).submit(any());

    verify(pusher, times(<span class="hljs-number">1</span>)).pushTaskReports(eq(<span class="hljs-string">"myID"</span>), any());

    verify(pusher, times(<span class="hljs-number">1</span>)).pushTaskStatus(eq(<span class="hljs-string">"myID"</span>), any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TaskActionClient <span class="hljs-title">createMockTaskActionClient</span><span class="hljs-params">()</span> </span>{
    TaskActionClient taskActionClient = mock(TaskActionClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(taskActionClient.submit(any())).thenReturn(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> taskActionClient;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest192">Test Case ID #druid_Test_19_2</h4>
<h4 id="test-case-name-testwithnoencapsulatedtaskfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommontaskabstracttasktestjava">Test Case Name: <code>testWithNoEncapsulatedTask</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\task\AbstractTaskTest.java</code>)</h4>
<h4 id="mock-object-variable-name-taskactionclient">Mock Object Variable Name: <code>taskActionClient</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(toolbox.getJsonMapper()).thenReturn(objectMapper);
<span class="hljs-deletion">-    TaskActionClient taskActionClient = mock(TaskActionClient.class);</span>
<span class="hljs-deletion">-    when(taskActionClient.submit(any())).thenReturn(TaskConfig.class);</span>
<span class="hljs-addition">+    TaskActionClient taskActionClient = createMockTaskActionClient();</span>
    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);
    AbstractTask task = new NoopTask("myID", null, null, 1, 0, null) {
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testWithNoEncapsulatedTask</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TaskToolbox toolbox = mock(TaskToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getAttemptId()).thenReturn(<span class="hljs-string">"1"</span>);

    DruidNode node = <span class="hljs-keyword">new</span> DruidNode(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>);

    when(toolbox.getTaskExecutorNode()).thenReturn(node);

    TaskLogPusher pusher = mock(TaskLogPusher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskLogPusher()).thenReturn(pusher);

    TaskConfig config = mock(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(config.isEncapsulatedTask()).thenReturn(<span class="hljs-keyword">false</span>);

    File folder = temporaryFolder.newFolder();

    when(config.getTaskDir(eq(<span class="hljs-string">"myID"</span>))).thenReturn(folder);

    when(toolbox.getConfig()).thenReturn(config);

    when(toolbox.getJsonMapper()).thenReturn(objectMapper);

    TaskActionClient taskActionClient = mock(TaskActionClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskActionClient.submit(any())).thenReturn(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);

    AbstractTask task = <span class="hljs-keyword">new</span> NoopTask(<span class="hljs-string">"myID"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>) {



        <span class="hljs-meta">@Nullable</span>

        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">setup</span><span class="hljs-params">(TaskToolbox toolbox)</span> <span class="hljs-keyword">throws</span> Exception </span>{

            <span class="hljs-comment">// create a reports file to test the taskLogPusher pushes task reports</span>

            String result = <span class="hljs-keyword">super</span>.setup(toolbox);

            File attemptDir = Paths.get(folder.getAbsolutePath(), <span class="hljs-string">"attempt"</span>, toolbox.getAttemptId()).toFile();

            File reportsDir = <span class="hljs-keyword">new</span> File(attemptDir, <span class="hljs-string">"report.json"</span>);

            FileUtils.write(reportsDir, <span class="hljs-string">"foo"</span>, StandardCharsets.UTF_8);

            <span class="hljs-keyword">return</span> result;

        }

    };

    task.run(toolbox);

    <span class="hljs-comment">// encapsulated task is set to false, should never get called</span>

    Mockito.verify(taskActionClient, never()).submit(any());

    verify(pusher, never()).pushTaskReports(eq(<span class="hljs-string">"myID"</span>), any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TaskActionClient <span class="hljs-title">createMockTaskActionClient</span><span class="hljs-params">()</span> </span>{
    TaskActionClient taskActionClient = mock(TaskActionClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(taskActionClient.submit(any())).thenReturn(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> taskActionClient;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest193">Test Case ID #druid_Test_19_3</h4>
<h4 id="test-case-name-testtaskfailurewithoutexceptiongetsreportedcorrectlyfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommontaskabstracttasktestjava">Test Case Name: <code>testTaskFailureWithoutExceptionGetsReportedCorrectly</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\task\AbstractTaskTest.java</code>)</h4>
<h4 id="mock-object-variable-name-taskactionclient">Mock Object Variable Name: <code>taskActionClient</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    when(toolbox.getJsonMapper()).thenReturn(objectMapper);
<span class="hljs-deletion">-    TaskActionClient taskActionClient = mock(TaskActionClient.class);</span>
<span class="hljs-deletion">-    when(taskActionClient.submit(any())).thenReturn(TaskConfig.class);</span>
<span class="hljs-addition">+    TaskActionClient taskActionClient = createMockTaskActionClient();</span>
    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);
    AbstractTask task = new NoopTask("myID", null, null, 1, 0, null) {

        @Override
        public TaskStatus runTask(TaskToolbox toolbox) {
            return TaskStatus.failure("myId", "failed");
        }
    };
    task.run(toolbox);
    UpdateStatusAction action = new UpdateStatusAction("failure");
    verify(taskActionClient).submit(eq(action));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testTaskFailureWithoutExceptionGetsReportedCorrectly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TaskToolbox toolbox = mock(TaskToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getAttemptId()).thenReturn(<span class="hljs-string">"1"</span>);

    DruidNode node = <span class="hljs-keyword">new</span> DruidNode(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>);

    when(toolbox.getTaskExecutorNode()).thenReturn(node);

    TaskLogPusher pusher = mock(TaskLogPusher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskLogPusher()).thenReturn(pusher);

    TaskConfig config = mock(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(config.isEncapsulatedTask()).thenReturn(<span class="hljs-keyword">true</span>);

    File folder = temporaryFolder.newFolder();

    when(config.getTaskDir(eq(<span class="hljs-string">"myID"</span>))).thenReturn(folder);

    when(toolbox.getConfig()).thenReturn(config);

    when(toolbox.getJsonMapper()).thenReturn(objectMapper);

    TaskActionClient taskActionClient = mock(TaskActionClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskActionClient.submit(any())).thenReturn(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);

    AbstractTask task = <span class="hljs-keyword">new</span> NoopTask(<span class="hljs-string">"myID"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>) {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> TaskStatus <span class="hljs-title">runTask</span><span class="hljs-params">(TaskToolbox toolbox)</span> </span>{

            <span class="hljs-keyword">return</span> TaskStatus.failure(<span class="hljs-string">"myId"</span>, <span class="hljs-string">"failed"</span>);

        }

    };

    task.run(toolbox);

    UpdateStatusAction action = <span class="hljs-keyword">new</span> UpdateStatusAction(<span class="hljs-string">"failure"</span>);

    verify(taskActionClient).submit(eq(action));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TaskActionClient <span class="hljs-title">createMockTaskActionClient</span><span class="hljs-params">()</span> </span>{
    TaskActionClient taskActionClient = mock(TaskActionClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(taskActionClient.submit(any())).thenReturn(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-keyword">return</span> taskActionClient;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci20">Mock Clone Instance #druid_MCI_20</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.rpc.indexing.OverlordClient</code></li>
<li><strong>Test Case Count</strong>: 14</li>
<li><strong>MO Count</strong>: 14</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> OverlordClient mockClient;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockClient

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest201">Test Case ID #druid_Test_20_1</h4>
<h4 id="test-case-name-testcompactwithoutgranularityspecfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservercoordinatordutycompactsegmentstestjava">Test Case Name: <code>testCompactWithoutGranularitySpec</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\coordinator\duty\CompactSegmentsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockclient">Mock Object Variable Name: <code>mockClient</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testCompactWithoutGranularitySpec() {
<span class="hljs-deletion">-    final OverlordClient mockClient = Mockito.mock(OverlordClient.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockClient`</span>
     final ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);
     final CompactSegments compactSegments = new CompactSegments(SEARCH_POLICY, mockClient);
     final List&lt;DataSourceCompactionConfig&gt; compactionConfigs = new ArrayList&lt;&gt;();
     final String dataSource = DATA_SOURCE_PREFIX + 0;
     compactionConfigs.add(new DataSourceCompactionConfig(dataSource, 0, 500L, null, // smaller than segment interval
     new Period("PT0H"), new UserCompactionTaskQueryTuningConfig(null, null, null, null, null, partitionsSpec, null, null, null, null, null, 3, null, null, null, null, null, null, null), null, null, null, null, null, null));
     doCompactSegments(compactSegments, compactionConfigs);
     ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();
     Assert.assertEquals(Intervals.of("2017-01-09T12:00:00.000Z/2017-01-10T00:00:00.000Z"), taskPayload.getIoConfig().getInputSpec().getInterval());
     Assert.assertNull(taskPayload.getGranularitySpec().getSegmentGranularity());
     Assert.assertNull(taskPayload.getGranularitySpec().getQueryGranularity());
     Assert.assertNull(taskPayload.getGranularitySpec().isRollup());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCompactWithoutGranularitySpec</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> OverlordClient mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);

    <span class="hljs-keyword">final</span> CompactSegments compactSegments = <span class="hljs-keyword">new</span> CompactSegments(SEARCH_POLICY, mockClient);

    <span class="hljs-keyword">final</span> List&lt;DataSourceCompactionConfig&gt; compactionConfigs = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-keyword">final</span> String dataSource = DATA_SOURCE_PREFIX + <span class="hljs-number">0</span>;

    compactionConfigs.add(<span class="hljs-keyword">new</span> DataSourceCompactionConfig(dataSource, <span class="hljs-number">0</span>, <span class="hljs-number">500L</span>, <span class="hljs-keyword">null</span>, <span class="hljs-comment">// smaller than segment interval</span>

    <span class="hljs-keyword">new</span> Period(<span class="hljs-string">"PT0H"</span>), <span class="hljs-keyword">new</span> UserCompactionTaskQueryTuningConfig(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, partitionsSpec, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">3</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>));

    doCompactSegments(compactSegments, compactionConfigs);

    ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();

    Assert.assertEquals(Intervals.of(<span class="hljs-string">"2017-01-09T12:00:00.000Z/2017-01-10T00:00:00.000Z"</span>), taskPayload.getIoConfig().getInputSpec().getInterval());

    Assert.assertNull(taskPayload.getGranularitySpec().getSegmentGranularity());

    Assert.assertNull(taskPayload.getGranularitySpec().getQueryGranularity());

    Assert.assertNull(taskPayload.getGranularitySpec().isRollup());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> OverlordClient mockClient;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockClient

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest202">Test Case ID #druid_Test_20_2</h4>
<h4 id="test-case-name-testcompactwithnotnullioconfigfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservercoordinatordutycompactsegmentstestjava">Test Case Name: <code>testCompactWithNotNullIOConfig</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\coordinator\duty\CompactSegmentsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockclient">Mock Object Variable Name: <code>mockClient</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
@Test
public void testCompactWithNotNullIOConfig() {
<span class="hljs-deletion">-    final OverlordClient mockClient = Mockito.mock(OverlordClient.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockClient`</span>
    final ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);
    final CompactSegments compactSegments = new CompactSegments(SEARCH_POLICY, mockClient);
    final List&lt;DataSourceCompactionConfig&gt; compactionConfigs = new ArrayList&lt;&gt;();
    final String dataSource = DATA_SOURCE_PREFIX + 0;
    compactionConfigs.add(new DataSourceCompactionConfig(dataSource, 0, 500L, null, // smaller than segment interval
    new Period("PT0H"), new UserCompactionTaskQueryTuningConfig(null, null, null, null, null, partitionsSpec, null, null, null, null, null, 3, null, null, null, null, null, null, null), null, null, null, null, new UserCompactionTaskIOConfig(true), null));
    doCompactSegments(compactSegments, compactionConfigs);
    ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();
    Assert.assertTrue(taskPayload.getIoConfig().isDropExisting());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCompactWithNotNullIOConfig</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> OverlordClient mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);

    <span class="hljs-keyword">final</span> CompactSegments compactSegments = <span class="hljs-keyword">new</span> CompactSegments(SEARCH_POLICY, mockClient);

    <span class="hljs-keyword">final</span> List&lt;DataSourceCompactionConfig&gt; compactionConfigs = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-keyword">final</span> String dataSource = DATA_SOURCE_PREFIX + <span class="hljs-number">0</span>;

    compactionConfigs.add(<span class="hljs-keyword">new</span> DataSourceCompactionConfig(dataSource, <span class="hljs-number">0</span>, <span class="hljs-number">500L</span>, <span class="hljs-keyword">null</span>, <span class="hljs-comment">// smaller than segment interval</span>

    <span class="hljs-keyword">new</span> Period(<span class="hljs-string">"PT0H"</span>), <span class="hljs-keyword">new</span> UserCompactionTaskQueryTuningConfig(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, partitionsSpec, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">3</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> UserCompactionTaskIOConfig(<span class="hljs-keyword">true</span>), <span class="hljs-keyword">null</span>));

    doCompactSegments(compactSegments, compactionConfigs);

    ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();

    Assert.assertTrue(taskPayload.getIoConfig().isDropExisting());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> OverlordClient mockClient;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockClient

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest203">Test Case ID #druid_Test_20_3</h4>
<h4 id="test-case-name-testcompactwithnullioconfigfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservercoordinatordutycompactsegmentstestjava">Test Case Name: <code>testCompactWithNullIOConfig</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\coordinator\duty\CompactSegmentsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockclient">Mock Object Variable Name: <code>mockClient</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
@Test
public void testCompactWithNullIOConfig() {
<span class="hljs-deletion">-    final OverlordClient mockClient = Mockito.mock(OverlordClient.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockClient`</span>
    final ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);
    final CompactSegments compactSegments = new CompactSegments(SEARCH_POLICY, mockClient);
    final List&lt;DataSourceCompactionConfig&gt; compactionConfigs = new ArrayList&lt;&gt;();
    final String dataSource = DATA_SOURCE_PREFIX + 0;
    compactionConfigs.add(new DataSourceCompactionConfig(dataSource, 0, 500L, null, // smaller than segment interval
    new Period("PT0H"), new UserCompactionTaskQueryTuningConfig(null, null, null, null, null, partitionsSpec, null, null, null, null, null, 3, null, null, null, null, null, null, null), null, null, null, null, null, null));
    doCompactSegments(compactSegments, compactionConfigs);
    ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();
    Assert.assertEquals(BatchIOConfig.DEFAULT_DROP_EXISTING, taskPayload.getIoConfig().isDropExisting());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCompactWithNullIOConfig</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> OverlordClient mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);

    <span class="hljs-keyword">final</span> CompactSegments compactSegments = <span class="hljs-keyword">new</span> CompactSegments(SEARCH_POLICY, mockClient);

    <span class="hljs-keyword">final</span> List&lt;DataSourceCompactionConfig&gt; compactionConfigs = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-keyword">final</span> String dataSource = DATA_SOURCE_PREFIX + <span class="hljs-number">0</span>;

    compactionConfigs.add(<span class="hljs-keyword">new</span> DataSourceCompactionConfig(dataSource, <span class="hljs-number">0</span>, <span class="hljs-number">500L</span>, <span class="hljs-keyword">null</span>, <span class="hljs-comment">// smaller than segment interval</span>

    <span class="hljs-keyword">new</span> Period(<span class="hljs-string">"PT0H"</span>), <span class="hljs-keyword">new</span> UserCompactionTaskQueryTuningConfig(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, partitionsSpec, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">3</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>));

    doCompactSegments(compactSegments, compactionConfigs);

    ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();

    Assert.assertEquals(BatchIOConfig.DEFAULT_DROP_EXISTING, taskPayload.getIoConfig().isDropExisting());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> OverlordClient mockClient;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockClient

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest204">Test Case ID #druid_Test_20_4</h4>
<h4 id="test-case-name-testcompactwithgranularityspecfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservercoordinatordutycompactsegmentstestjava">Test Case Name: <code>testCompactWithGranularitySpec</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\coordinator\duty\CompactSegmentsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockclient">Mock Object Variable Name: <code>mockClient</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
@Test
public void testCompactWithGranularitySpec() {
<span class="hljs-deletion">-    final OverlordClient mockClient = Mockito.mock(OverlordClient.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockClient`</span>
    final ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);
    final CompactSegments compactSegments = new CompactSegments(SEARCH_POLICY, mockClient);
    final List&lt;DataSourceCompactionConfig&gt; compactionConfigs = new ArrayList&lt;&gt;();
    final String dataSource = DATA_SOURCE_PREFIX + 0;
    compactionConfigs.add(new DataSourceCompactionConfig(dataSource, 0, 500L, null, // smaller than segment interval
    new Period("PT0H"), new UserCompactionTaskQueryTuningConfig(null, null, null, null, null, partitionsSpec, null, null, null, null, null, 3, null, null, null, null, null, null, null), new UserCompactionTaskGranularityConfig(Granularities.YEAR, null, null), null, null, null, null, null));
    doCompactSegments(compactSegments, compactionConfigs);
    ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();
    // All segments is compact at the same time since we changed the segment granularity to YEAR and all segment
    // are within the same year
    Assert.assertEquals(ClientCompactionIntervalSpec.fromSegments(datasourceToSegments.get(dataSource), Granularities.YEAR), taskPayload.getIoConfig().getInputSpec());
    ClientCompactionTaskGranularitySpec expectedGranularitySpec = new ClientCompactionTaskGranularitySpec(Granularities.YEAR, null, null);
    Assert.assertEquals(expectedGranularitySpec, taskPayload.getGranularitySpec());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCompactWithGranularitySpec</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> OverlordClient mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);

    <span class="hljs-keyword">final</span> CompactSegments compactSegments = <span class="hljs-keyword">new</span> CompactSegments(SEARCH_POLICY, mockClient);

    <span class="hljs-keyword">final</span> List&lt;DataSourceCompactionConfig&gt; compactionConfigs = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-keyword">final</span> String dataSource = DATA_SOURCE_PREFIX + <span class="hljs-number">0</span>;

    compactionConfigs.add(<span class="hljs-keyword">new</span> DataSourceCompactionConfig(dataSource, <span class="hljs-number">0</span>, <span class="hljs-number">500L</span>, <span class="hljs-keyword">null</span>, <span class="hljs-comment">// smaller than segment interval</span>

    <span class="hljs-keyword">new</span> Period(<span class="hljs-string">"PT0H"</span>), <span class="hljs-keyword">new</span> UserCompactionTaskQueryTuningConfig(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, partitionsSpec, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">3</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">new</span> UserCompactionTaskGranularityConfig(Granularities.YEAR, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>));

    doCompactSegments(compactSegments, compactionConfigs);

    ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();

    <span class="hljs-comment">// All segments is compact at the same time since we changed the segment granularity to YEAR and all segment</span>

    <span class="hljs-comment">// are within the same year</span>

    Assert.assertEquals(ClientCompactionIntervalSpec.fromSegments(datasourceToSegments.get(dataSource), Granularities.YEAR), taskPayload.getIoConfig().getInputSpec());

    ClientCompactionTaskGranularitySpec expectedGranularitySpec = <span class="hljs-keyword">new</span> ClientCompactionTaskGranularitySpec(Granularities.YEAR, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

    Assert.assertEquals(expectedGranularitySpec, taskPayload.getGranularitySpec());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> OverlordClient mockClient;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockClient

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest205">Test Case ID #druid_Test_20_5</h4>
<h4 id="test-case-name-testcompactwithdimensionspecfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservercoordinatordutycompactsegmentstestjava">Test Case Name: <code>testCompactWithDimensionSpec</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\coordinator\duty\CompactSegmentsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockclient">Mock Object Variable Name: <code>mockClient</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testCompactWithDimensionSpec() {
<span class="hljs-deletion">-    final OverlordClient mockClient = Mockito.mock(OverlordClient.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockClient`</span>
     final ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);
     final CompactSegments compactSegments = new CompactSegments(SEARCH_POLICY, mockClient);
     final List&lt;DataSourceCompactionConfig&gt; compactionConfigs = new ArrayList&lt;&gt;();
     final String dataSource = DATA_SOURCE_PREFIX + 0;
     compactionConfigs.add(new DataSourceCompactionConfig(dataSource, 0, 500L, null, // smaller than segment interval
     new Period("PT0H"), new UserCompactionTaskQueryTuningConfig(null, null, null, null, null, partitionsSpec, null, null, null, null, null, 3, null, null, null, null, null, null, null), null, new UserCompactionTaskDimensionsConfig(DimensionsSpec.getDefaultSchemas(ImmutableList.of("bar", "foo"))), null, null, null, null));
     doCompactSegments(compactSegments, compactionConfigs);
     ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();
     Assert.assertEquals(DimensionsSpec.getDefaultSchemas(ImmutableList.of("bar", "foo")), taskPayload.getDimensionsSpec().getDimensions());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCompactWithDimensionSpec</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> OverlordClient mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);

    <span class="hljs-keyword">final</span> CompactSegments compactSegments = <span class="hljs-keyword">new</span> CompactSegments(SEARCH_POLICY, mockClient);

    <span class="hljs-keyword">final</span> List&lt;DataSourceCompactionConfig&gt; compactionConfigs = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-keyword">final</span> String dataSource = DATA_SOURCE_PREFIX + <span class="hljs-number">0</span>;

    compactionConfigs.add(<span class="hljs-keyword">new</span> DataSourceCompactionConfig(dataSource, <span class="hljs-number">0</span>, <span class="hljs-number">500L</span>, <span class="hljs-keyword">null</span>, <span class="hljs-comment">// smaller than segment interval</span>

    <span class="hljs-keyword">new</span> Period(<span class="hljs-string">"PT0H"</span>), <span class="hljs-keyword">new</span> UserCompactionTaskQueryTuningConfig(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, partitionsSpec, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">3</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> UserCompactionTaskDimensionsConfig(DimensionsSpec.getDefaultSchemas(ImmutableList.of(<span class="hljs-string">"bar"</span>, <span class="hljs-string">"foo"</span>))), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>));

    doCompactSegments(compactSegments, compactionConfigs);

    ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();

    Assert.assertEquals(DimensionsSpec.getDefaultSchemas(ImmutableList.of(<span class="hljs-string">"bar"</span>, <span class="hljs-string">"foo"</span>)), taskPayload.getDimensionsSpec().getDimensions());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> OverlordClient mockClient;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockClient

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest206">Test Case ID #druid_Test_20_6</h4>
<h4 id="test-case-name-testcompactwithoutdimensionspecfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservercoordinatordutycompactsegmentstestjava">Test Case Name: <code>testCompactWithoutDimensionSpec</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\coordinator\duty\CompactSegmentsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockclient">Mock Object Variable Name: <code>mockClient</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testCompactWithoutDimensionSpec() {
<span class="hljs-deletion">-    final OverlordClient mockClient = Mockito.mock(OverlordClient.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockClient`</span>
     final ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);
     final CompactSegments compactSegments = new CompactSegments(SEARCH_POLICY, mockClient);
     final List&lt;DataSourceCompactionConfig&gt; compactionConfigs = new ArrayList&lt;&gt;();
     final String dataSource = DATA_SOURCE_PREFIX + 0;
     compactionConfigs.add(new DataSourceCompactionConfig(dataSource, 0, 500L, null, // smaller than segment interval
     new Period("PT0H"), new UserCompactionTaskQueryTuningConfig(null, null, null, null, null, partitionsSpec, null, null, null, null, null, 3, null, null, null, null, null, null, null), null, null, null, null, null, null));
     doCompactSegments(compactSegments, compactionConfigs);
     ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();
     Assert.assertNull(taskPayload.getDimensionsSpec());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCompactWithoutDimensionSpec</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> OverlordClient mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);

    <span class="hljs-keyword">final</span> CompactSegments compactSegments = <span class="hljs-keyword">new</span> CompactSegments(SEARCH_POLICY, mockClient);

    <span class="hljs-keyword">final</span> List&lt;DataSourceCompactionConfig&gt; compactionConfigs = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-keyword">final</span> String dataSource = DATA_SOURCE_PREFIX + <span class="hljs-number">0</span>;

    compactionConfigs.add(<span class="hljs-keyword">new</span> DataSourceCompactionConfig(dataSource, <span class="hljs-number">0</span>, <span class="hljs-number">500L</span>, <span class="hljs-keyword">null</span>, <span class="hljs-comment">// smaller than segment interval</span>

    <span class="hljs-keyword">new</span> Period(<span class="hljs-string">"PT0H"</span>), <span class="hljs-keyword">new</span> UserCompactionTaskQueryTuningConfig(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, partitionsSpec, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">3</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>));

    doCompactSegments(compactSegments, compactionConfigs);

    ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();

    Assert.assertNull(taskPayload.getDimensionsSpec());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> OverlordClient mockClient;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockClient

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest207">Test Case ID #druid_Test_20_7</h4>
<h4 id="test-case-name-testcompactwithrollupingranularityspecfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservercoordinatordutycompactsegmentstestjava">Test Case Name: <code>testCompactWithRollupInGranularitySpec</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\coordinator\duty\CompactSegmentsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockclient">Mock Object Variable Name: <code>mockClient</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
@Test
public void testCompactWithRollupInGranularitySpec() {
<span class="hljs-deletion">-    final OverlordClient mockClient = Mockito.mock(OverlordClient.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockClient`</span>
    final ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);
    final CompactSegments compactSegments = new CompactSegments(SEARCH_POLICY, mockClient);
    final List&lt;DataSourceCompactionConfig&gt; compactionConfigs = new ArrayList&lt;&gt;();
    final String dataSource = DATA_SOURCE_PREFIX + 0;
    compactionConfigs.add(new DataSourceCompactionConfig(dataSource, 0, 500L, null, // smaller than segment interval
    new Period("PT0H"), new UserCompactionTaskQueryTuningConfig(null, null, null, null, null, partitionsSpec, null, null, null, null, null, 3, null, null, null, null, null, null, null), new UserCompactionTaskGranularityConfig(Granularities.YEAR, null, true), null, null, null, null, null));
    doCompactSegments(compactSegments, compactionConfigs);
    ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();
    // All segments is compact at the same time since we changed the segment granularity to YEAR and all segment
    // are within the same year
    Assert.assertEquals(ClientCompactionIntervalSpec.fromSegments(datasourceToSegments.get(dataSource), Granularities.YEAR), taskPayload.getIoConfig().getInputSpec());
    ClientCompactionTaskGranularitySpec expectedGranularitySpec = new ClientCompactionTaskGranularitySpec(Granularities.YEAR, null, true);
    Assert.assertEquals(expectedGranularitySpec, taskPayload.getGranularitySpec());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCompactWithRollupInGranularitySpec</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> OverlordClient mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);

    <span class="hljs-keyword">final</span> CompactSegments compactSegments = <span class="hljs-keyword">new</span> CompactSegments(SEARCH_POLICY, mockClient);

    <span class="hljs-keyword">final</span> List&lt;DataSourceCompactionConfig&gt; compactionConfigs = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-keyword">final</span> String dataSource = DATA_SOURCE_PREFIX + <span class="hljs-number">0</span>;

    compactionConfigs.add(<span class="hljs-keyword">new</span> DataSourceCompactionConfig(dataSource, <span class="hljs-number">0</span>, <span class="hljs-number">500L</span>, <span class="hljs-keyword">null</span>, <span class="hljs-comment">// smaller than segment interval</span>

    <span class="hljs-keyword">new</span> Period(<span class="hljs-string">"PT0H"</span>), <span class="hljs-keyword">new</span> UserCompactionTaskQueryTuningConfig(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, partitionsSpec, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">3</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">new</span> UserCompactionTaskGranularityConfig(Granularities.YEAR, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">true</span>), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>));

    doCompactSegments(compactSegments, compactionConfigs);

    ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();

    <span class="hljs-comment">// All segments is compact at the same time since we changed the segment granularity to YEAR and all segment</span>

    <span class="hljs-comment">// are within the same year</span>

    Assert.assertEquals(ClientCompactionIntervalSpec.fromSegments(datasourceToSegments.get(dataSource), Granularities.YEAR), taskPayload.getIoConfig().getInputSpec());

    ClientCompactionTaskGranularitySpec expectedGranularitySpec = <span class="hljs-keyword">new</span> ClientCompactionTaskGranularitySpec(Granularities.YEAR, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">true</span>);

    Assert.assertEquals(expectedGranularitySpec, taskPayload.getGranularitySpec());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> OverlordClient mockClient;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockClient

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest208">Test Case ID #druid_Test_20_8</h4>
<h4 id="test-case-name-testcompactwithtransformspecfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservercoordinatordutycompactsegmentstestjava">Test Case Name: <code>testCompactWithTransformSpec</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\coordinator\duty\CompactSegmentsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockclient">Mock Object Variable Name: <code>mockClient</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testCompactWithTransformSpec() {
     NullHandling.initializeForTests();
<span class="hljs-deletion">-    final OverlordClient mockClient = Mockito.mock(OverlordClient.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockClient`</span>
     final ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);
     final CompactSegments compactSegments = new CompactSegments(SEARCH_POLICY, mockClient);
     final List&lt;DataSourceCompactionConfig&gt; compactionConfigs = new ArrayList&lt;&gt;();
     final String dataSource = DATA_SOURCE_PREFIX + 0;
     compactionConfigs.add(new DataSourceCompactionConfig(dataSource, 0, 500L, null, // smaller than segment interval
     new Period("PT0H"), new UserCompactionTaskQueryTuningConfig(null, null, null, null, null, partitionsSpec, null, null, null, null, null, 3, null, null, null, null, null, null, null), null, null, null, new UserCompactionTaskTransformConfig(new SelectorDimFilter("dim1", "foo", null)), null, null));
     doCompactSegments(compactSegments, compactionConfigs);
     ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();
     Assert.assertNotNull(taskPayload.getTransformSpec());
     Assert.assertEquals(new SelectorDimFilter("dim1", "foo", null), taskPayload.getTransformSpec().getFilter());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCompactWithTransformSpec</span><span class="hljs-params">()</span> </span>{

    NullHandling.initializeForTests();

    <span class="hljs-keyword">final</span> OverlordClient mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);

    <span class="hljs-keyword">final</span> CompactSegments compactSegments = <span class="hljs-keyword">new</span> CompactSegments(SEARCH_POLICY, mockClient);

    <span class="hljs-keyword">final</span> List&lt;DataSourceCompactionConfig&gt; compactionConfigs = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-keyword">final</span> String dataSource = DATA_SOURCE_PREFIX + <span class="hljs-number">0</span>;

    compactionConfigs.add(<span class="hljs-keyword">new</span> DataSourceCompactionConfig(dataSource, <span class="hljs-number">0</span>, <span class="hljs-number">500L</span>, <span class="hljs-keyword">null</span>, <span class="hljs-comment">// smaller than segment interval</span>

    <span class="hljs-keyword">new</span> Period(<span class="hljs-string">"PT0H"</span>), <span class="hljs-keyword">new</span> UserCompactionTaskQueryTuningConfig(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, partitionsSpec, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">3</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> UserCompactionTaskTransformConfig(<span class="hljs-keyword">new</span> SelectorDimFilter(<span class="hljs-string">"dim1"</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">null</span>)), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>));

    doCompactSegments(compactSegments, compactionConfigs);

    ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();

    Assert.assertNotNull(taskPayload.getTransformSpec());

    Assert.assertEquals(<span class="hljs-keyword">new</span> SelectorDimFilter(<span class="hljs-string">"dim1"</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">null</span>), taskPayload.getTransformSpec().getFilter());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> OverlordClient mockClient;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockClient

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest209">Test Case ID #druid_Test_20_9</h4>
<h4 id="test-case-name-testcompactwithoutcustomspecsfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservercoordinatordutycompactsegmentstestjava">Test Case Name: <code>testCompactWithoutCustomSpecs</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\coordinator\duty\CompactSegmentsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockclient">Mock Object Variable Name: <code>mockClient</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
@Test
public void testCompactWithoutCustomSpecs() {
<span class="hljs-deletion">-    final OverlordClient mockClient = Mockito.mock(OverlordClient.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockClient`</span>
    final ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);
    final CompactSegments compactSegments = new CompactSegments(SEARCH_POLICY, mockClient);
    final List&lt;DataSourceCompactionConfig&gt; compactionConfigs = new ArrayList&lt;&gt;();
    final String dataSource = DATA_SOURCE_PREFIX + 0;
    compactionConfigs.add(new DataSourceCompactionConfig(dataSource, 0, 500L, null, // smaller than segment interval
    new Period("PT0H"), new UserCompactionTaskQueryTuningConfig(null, null, null, null, null, partitionsSpec, null, null, null, null, null, 3, null, null, null, null, null, null, null), null, null, null, null, null, null));
    doCompactSegments(compactSegments, compactionConfigs);
    ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();
    Assert.assertNull(taskPayload.getTransformSpec());
    Assert.assertNull(taskPayload.getMetricsSpec());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCompactWithoutCustomSpecs</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> OverlordClient mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);

    <span class="hljs-keyword">final</span> CompactSegments compactSegments = <span class="hljs-keyword">new</span> CompactSegments(SEARCH_POLICY, mockClient);

    <span class="hljs-keyword">final</span> List&lt;DataSourceCompactionConfig&gt; compactionConfigs = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-keyword">final</span> String dataSource = DATA_SOURCE_PREFIX + <span class="hljs-number">0</span>;

    compactionConfigs.add(<span class="hljs-keyword">new</span> DataSourceCompactionConfig(dataSource, <span class="hljs-number">0</span>, <span class="hljs-number">500L</span>, <span class="hljs-keyword">null</span>, <span class="hljs-comment">// smaller than segment interval</span>

    <span class="hljs-keyword">new</span> Period(<span class="hljs-string">"PT0H"</span>), <span class="hljs-keyword">new</span> UserCompactionTaskQueryTuningConfig(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, partitionsSpec, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">3</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>));

    doCompactSegments(compactSegments, compactionConfigs);

    ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();

    Assert.assertNull(taskPayload.getTransformSpec());

    Assert.assertNull(taskPayload.getMetricsSpec());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> OverlordClient mockClient;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockClient

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest2010">Test Case ID #druid_Test_20_10</h4>
<h4 id="test-case-name-testcompactwithmetricsspecfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservercoordinatordutycompactsegmentstestjava">Test Case Name: <code>testCompactWithMetricsSpec</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\coordinator\duty\CompactSegmentsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockclient">Mock Object Variable Name: <code>mockClient</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testCompactWithMetricsSpec() {
     NullHandling.initializeForTests();
     AggregatorFactory[] aggregatorFactories = new AggregatorFactory[] { new CountAggregatorFactory("cnt") };
<span class="hljs-deletion">-    final OverlordClient mockClient = Mockito.mock(OverlordClient.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockClient`</span>
     final ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);
     final CompactSegments compactSegments = new CompactSegments(SEARCH_POLICY, mockClient);
     final List&lt;DataSourceCompactionConfig&gt; compactionConfigs = new ArrayList&lt;&gt;();
     final String dataSource = DATA_SOURCE_PREFIX + 0;
     compactionConfigs.add(new DataSourceCompactionConfig(dataSource, 0, 500L, null, // smaller than segment interval
     new Period("PT0H"), new UserCompactionTaskQueryTuningConfig(null, null, null, null, null, partitionsSpec, null, null, null, null, null, 3, null, null, null, null, null, null, null), null, null, aggregatorFactories, null, null, null));
     doCompactSegments(compactSegments, compactionConfigs);
     ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();
     AggregatorFactory[] actual = taskPayload.getMetricsSpec();
     Assert.assertNotNull(actual);
     Assert.assertArrayEquals(aggregatorFactories, actual);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCompactWithMetricsSpec</span><span class="hljs-params">()</span> </span>{

    NullHandling.initializeForTests();

    AggregatorFactory[] aggregatorFactories = <span class="hljs-keyword">new</span> AggregatorFactory[] { <span class="hljs-keyword">new</span> CountAggregatorFactory(<span class="hljs-string">"cnt"</span>) };

    <span class="hljs-keyword">final</span> OverlordClient mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);

    <span class="hljs-keyword">final</span> CompactSegments compactSegments = <span class="hljs-keyword">new</span> CompactSegments(SEARCH_POLICY, mockClient);

    <span class="hljs-keyword">final</span> List&lt;DataSourceCompactionConfig&gt; compactionConfigs = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-keyword">final</span> String dataSource = DATA_SOURCE_PREFIX + <span class="hljs-number">0</span>;

    compactionConfigs.add(<span class="hljs-keyword">new</span> DataSourceCompactionConfig(dataSource, <span class="hljs-number">0</span>, <span class="hljs-number">500L</span>, <span class="hljs-keyword">null</span>, <span class="hljs-comment">// smaller than segment interval</span>

    <span class="hljs-keyword">new</span> Period(<span class="hljs-string">"PT0H"</span>), <span class="hljs-keyword">new</span> UserCompactionTaskQueryTuningConfig(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, partitionsSpec, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">3</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, aggregatorFactories, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>));

    doCompactSegments(compactSegments, compactionConfigs);

    ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();

    AggregatorFactory[] actual = taskPayload.getMetricsSpec();

    Assert.assertNotNull(actual);

    Assert.assertArrayEquals(aggregatorFactories, actual);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> OverlordClient mockClient;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockClient

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest2011">Test Case ID #druid_Test_20_11</h4>
<h4 id="test-case-name-testdeterminesegmentgranularityfromsegmentstocompactfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservercoordinatordutycompactsegmentstestjava">Test Case Name: <code>testDetermineSegmentGranularityFromSegmentsToCompact</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\coordinator\duty\CompactSegmentsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockclient">Mock Object Variable Name: <code>mockClient</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     dataSources = DataSourcesSnapshot.fromUsedSegments(segments, ImmutableMap.of());
<span class="hljs-deletion">-    final OverlordClient mockClient = Mockito.mock(OverlordClient.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockClient`</span>
     final ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);
     final CompactSegments compactSegments = new CompactSegments(SEARCH_POLICY, mockClient);
     final List&lt;DataSourceCompactionConfig&gt; compactionConfigs = new ArrayList&lt;&gt;();
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDetermineSegmentGranularityFromSegmentsToCompact</span><span class="hljs-params">()</span> </span>{

    String dataSourceName = DATA_SOURCE_PREFIX + <span class="hljs-number">1</span>;

    List&lt;DataSegment&gt; segments = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    segments.add(<span class="hljs-keyword">new</span> DataSegment(dataSourceName, Intervals.of(<span class="hljs-string">"2017-01-01T00:00:00/2017-01-02T00:00:00"</span>), <span class="hljs-string">"1"</span>, <span class="hljs-keyword">null</span>, ImmutableList.of(), ImmutableList.of(), shardSpecFactory.apply(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>), <span class="hljs-number">0</span>, <span class="hljs-number">10L</span>));

    segments.add(<span class="hljs-keyword">new</span> DataSegment(dataSourceName, Intervals.of(<span class="hljs-string">"2017-01-01T00:00:00/2017-01-02T00:00:00"</span>), <span class="hljs-string">"1"</span>, <span class="hljs-keyword">null</span>, ImmutableList.of(), ImmutableList.of(), shardSpecFactory.apply(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>), <span class="hljs-number">0</span>, <span class="hljs-number">10L</span>));

    dataSources = DataSourcesSnapshot.fromUsedSegments(segments, ImmutableMap.of());

    <span class="hljs-keyword">final</span> OverlordClient mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);

    <span class="hljs-keyword">final</span> CompactSegments compactSegments = <span class="hljs-keyword">new</span> CompactSegments(SEARCH_POLICY, mockClient);

    <span class="hljs-keyword">final</span> List&lt;DataSourceCompactionConfig&gt; compactionConfigs = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    compactionConfigs.add(<span class="hljs-keyword">new</span> DataSourceCompactionConfig(dataSourceName, <span class="hljs-number">0</span>, <span class="hljs-number">500L</span>, <span class="hljs-keyword">null</span>, <span class="hljs-comment">// smaller than segment interval</span>

    <span class="hljs-keyword">new</span> Period(<span class="hljs-string">"PT0H"</span>), <span class="hljs-keyword">new</span> UserCompactionTaskQueryTuningConfig(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, partitionsSpec, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">3</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>));

    doCompactSegments(compactSegments, compactionConfigs);

    ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();

    Assert.assertEquals(ClientCompactionIntervalSpec.fromSegments(segments, Granularities.DAY), taskPayload.getIoConfig().getInputSpec());

    ClientCompactionTaskGranularitySpec expectedGranularitySpec = <span class="hljs-keyword">new</span> ClientCompactionTaskGranularitySpec(Granularities.DAY, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

    Assert.assertEquals(expectedGranularitySpec, taskPayload.getGranularitySpec());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> OverlordClient mockClient;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockClient

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest2012">Test Case ID #druid_Test_20_12</h4>
<h4 id="test-case-name-testdeterminesegmentgranularityfromsegmentgranularityincompactionconfigfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservercoordinatordutycompactsegmentstestjava">Test Case Name: <code>testDetermineSegmentGranularityFromSegmentGranularityInCompactionConfig</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\coordinator\duty\CompactSegmentsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockclient">Mock Object Variable Name: <code>mockClient</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     dataSources = DataSourcesSnapshot.fromUsedSegments(segments, ImmutableMap.of());
<span class="hljs-deletion">-    final OverlordClient mockClient = Mockito.mock(OverlordClient.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockClient`</span>
     final ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);
     final CompactSegments compactSegments = new CompactSegments(SEARCH_POLICY, mockClient);
     final List&lt;DataSourceCompactionConfig&gt; compactionConfigs = new ArrayList&lt;&gt;();
     compactionConfigs.add(new DataSourceCompactionConfig(dataSourceName, 0, 500L, null, // smaller than segment interval
     new Period("PT0H"), new UserCompactionTaskQueryTuningConfig(null, null, null, null, null, partitionsSpec, null, null, null, null, null, 3, null, null, null, null, null, null, null), new UserCompactionTaskGranularityConfig(Granularities.YEAR, null, null), null, null, null, null, null));
     doCompactSegments(compactSegments, compactionConfigs);
     ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();
     Assert.assertEquals(ClientCompactionIntervalSpec.fromSegments(segments, Granularities.YEAR), taskPayload.getIoConfig().getInputSpec());
     ClientCompactionTaskGranularitySpec expectedGranularitySpec = new ClientCompactionTaskGranularitySpec(Granularities.YEAR, null, null);
     Assert.assertEquals(expectedGranularitySpec, taskPayload.getGranularitySpec());
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDetermineSegmentGranularityFromSegmentGranularityInCompactionConfig</span><span class="hljs-params">()</span> </span>{

    String dataSourceName = DATA_SOURCE_PREFIX + <span class="hljs-number">1</span>;

    List&lt;DataSegment&gt; segments = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    segments.add(<span class="hljs-keyword">new</span> DataSegment(dataSourceName, Intervals.of(<span class="hljs-string">"2017-01-01T00:00:00/2017-01-02T00:00:00"</span>), <span class="hljs-string">"1"</span>, <span class="hljs-keyword">null</span>, ImmutableList.of(), ImmutableList.of(), shardSpecFactory.apply(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>), <span class="hljs-number">0</span>, <span class="hljs-number">10L</span>));

    segments.add(<span class="hljs-keyword">new</span> DataSegment(dataSourceName, Intervals.of(<span class="hljs-string">"2017-01-01T00:00:00/2017-01-02T00:00:00"</span>), <span class="hljs-string">"1"</span>, <span class="hljs-keyword">null</span>, ImmutableList.of(), ImmutableList.of(), shardSpecFactory.apply(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>), <span class="hljs-number">0</span>, <span class="hljs-number">10L</span>));

    dataSources = DataSourcesSnapshot.fromUsedSegments(segments, ImmutableMap.of());

    <span class="hljs-keyword">final</span> OverlordClient mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);

    <span class="hljs-keyword">final</span> CompactSegments compactSegments = <span class="hljs-keyword">new</span> CompactSegments(SEARCH_POLICY, mockClient);

    <span class="hljs-keyword">final</span> List&lt;DataSourceCompactionConfig&gt; compactionConfigs = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    compactionConfigs.add(<span class="hljs-keyword">new</span> DataSourceCompactionConfig(dataSourceName, <span class="hljs-number">0</span>, <span class="hljs-number">500L</span>, <span class="hljs-keyword">null</span>, <span class="hljs-comment">// smaller than segment interval</span>

    <span class="hljs-keyword">new</span> Period(<span class="hljs-string">"PT0H"</span>), <span class="hljs-keyword">new</span> UserCompactionTaskQueryTuningConfig(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, partitionsSpec, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">3</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">new</span> UserCompactionTaskGranularityConfig(Granularities.YEAR, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>));

    doCompactSegments(compactSegments, compactionConfigs);

    ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();

    Assert.assertEquals(ClientCompactionIntervalSpec.fromSegments(segments, Granularities.YEAR), taskPayload.getIoConfig().getInputSpec());

    ClientCompactionTaskGranularitySpec expectedGranularitySpec = <span class="hljs-keyword">new</span> ClientCompactionTaskGranularitySpec(Granularities.YEAR, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

    Assert.assertEquals(expectedGranularitySpec, taskPayload.getGranularitySpec());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> OverlordClient mockClient;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockClient

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest2013">Test Case ID #druid_Test_20_13</h4>
<h4 id="test-case-name-testcompactwithmetricsspecshouldsetpreserveexistingmetricstruefile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservercoordinatordutycompactsegmentstestjava">Test Case Name: <code>testCompactWithMetricsSpecShouldSetPreserveExistingMetricsTrue</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\coordinator\duty\CompactSegmentsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockclient">Mock Object Variable Name: <code>mockClient</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testCompactWithMetricsSpecShouldSetPreserveExistingMetricsTrue() {
<span class="hljs-deletion">-    final OverlordClient mockClient = Mockito.mock(OverlordClient.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockClient`</span>
     final ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);
     final CompactSegments compactSegments = new CompactSegments(SEARCH_POLICY, mockClient);
     final List&lt;DataSourceCompactionConfig&gt; compactionConfigs = new ArrayList&lt;&gt;();
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCompactWithMetricsSpecShouldSetPreserveExistingMetricsTrue</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> OverlordClient mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);

    <span class="hljs-keyword">final</span> CompactSegments compactSegments = <span class="hljs-keyword">new</span> CompactSegments(SEARCH_POLICY, mockClient);

    <span class="hljs-keyword">final</span> List&lt;DataSourceCompactionConfig&gt; compactionConfigs = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-keyword">final</span> String dataSource = DATA_SOURCE_PREFIX + <span class="hljs-number">0</span>;

    compactionConfigs.add(<span class="hljs-keyword">new</span> DataSourceCompactionConfig(dataSource, <span class="hljs-number">0</span>, <span class="hljs-number">500L</span>, <span class="hljs-keyword">null</span>, <span class="hljs-comment">// smaller than segment interval</span>

    <span class="hljs-keyword">new</span> Period(<span class="hljs-string">"PT0H"</span>), <span class="hljs-keyword">new</span> UserCompactionTaskQueryTuningConfig(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, partitionsSpec, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">3</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> AggregatorFactory[] { <span class="hljs-keyword">new</span> CountAggregatorFactory(<span class="hljs-string">"cnt"</span>) }, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>));

    doCompactSegments(compactSegments, compactionConfigs);

    ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();

    Assert.assertNotNull(taskPayload.getTuningConfig());

    Assert.assertNotNull(taskPayload.getTuningConfig().getAppendableIndexSpec());

    Assert.assertTrue(((OnheapIncrementalIndex.Spec) taskPayload.getTuningConfig().getAppendableIndexSpec()).isPreserveExistingMetrics());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> OverlordClient mockClient;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockClient

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest2014">Test Case ID #druid_Test_20_14</h4>
<h4 id="test-case-name-testcompactwithoutmetricsspecshouldsetpreserveexistingmetricsfalsefile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservercoordinatordutycompactsegmentstestjava">Test Case Name: <code>testCompactWithoutMetricsSpecShouldSetPreserveExistingMetricsFalse</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\coordinator\duty\CompactSegmentsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockclient">Mock Object Variable Name: <code>mockClient</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testCompactWithoutMetricsSpecShouldSetPreserveExistingMetricsFalse() {
<span class="hljs-deletion">-    final OverlordClient mockClient = Mockito.mock(OverlordClient.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockClient`</span>
     final ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);
     final CompactSegments compactSegments = new CompactSegments(SEARCH_POLICY, mockClient);
     final List&lt;DataSourceCompactionConfig&gt; compactionConfigs = new ArrayList&lt;&gt;();
     final String dataSource = DATA_SOURCE_PREFIX + 0;
     compactionConfigs.add(new DataSourceCompactionConfig(dataSource, 0, 500L, null, // smaller than segment interval
     new Period("PT0H"), new UserCompactionTaskQueryTuningConfig(null, null, null, null, null, partitionsSpec, null, null, null, null, null, 3, null, null, null, null, null, null, null), null, null, null, null, null, null));
     doCompactSegments(compactSegments, compactionConfigs);
     ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();
     Assert.assertNotNull(taskPayload.getTuningConfig());
     Assert.assertNotNull(taskPayload.getTuningConfig().getAppendableIndexSpec());
     Assert.assertFalse(((OnheapIncrementalIndex.Spec) taskPayload.getTuningConfig().getAppendableIndexSpec()).isPreserveExistingMetrics());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCompactWithoutMetricsSpecShouldSetPreserveExistingMetricsFalse</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> OverlordClient mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ArgumentCaptor&lt;Object&gt; payloadCaptor = setUpMockClient(mockClient);

    <span class="hljs-keyword">final</span> CompactSegments compactSegments = <span class="hljs-keyword">new</span> CompactSegments(SEARCH_POLICY, mockClient);

    <span class="hljs-keyword">final</span> List&lt;DataSourceCompactionConfig&gt; compactionConfigs = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-keyword">final</span> String dataSource = DATA_SOURCE_PREFIX + <span class="hljs-number">0</span>;

    compactionConfigs.add(<span class="hljs-keyword">new</span> DataSourceCompactionConfig(dataSource, <span class="hljs-number">0</span>, <span class="hljs-number">500L</span>, <span class="hljs-keyword">null</span>, <span class="hljs-comment">// smaller than segment interval</span>

    <span class="hljs-keyword">new</span> Period(<span class="hljs-string">"PT0H"</span>), <span class="hljs-keyword">new</span> UserCompactionTaskQueryTuningConfig(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, partitionsSpec, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">3</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>));

    doCompactSegments(compactSegments, compactionConfigs);

    ClientCompactionTaskQuery taskPayload = (ClientCompactionTaskQuery) payloadCaptor.getValue();

    Assert.assertNotNull(taskPayload.getTuningConfig());

    Assert.assertNotNull(taskPayload.getTuningConfig().getAppendableIndexSpec());

    Assert.assertFalse(((OnheapIncrementalIndex.Spec) taskPayload.getTuningConfig().getAppendableIndexSpec()).isPreserveExistingMetrics());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> OverlordClient mockClient;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockClient = Mockito.mock(OverlordClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockClient

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci21">Mock Clone Instance #druid_MCI_21</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.datasketches.hll.Union</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Union <span class="hljs-title">createMockUnion</span><span class="hljs-params">(<span class="hljs-keyword">double</span> estimateReturn)</span> </span>{
    Union union = mock(Union<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(union.getEstimate()).thenReturn(estimateReturn);
    <span class="hljs-keyword">return</span> union;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest211">Test Case ID #druid_Test_21_1</h4>
<h4 id="test-case-name-testsupervisordeterminenegativenumshardsfromcardinalityreportfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommontaskbatchparalleldimensioncardinalityreporttestjava">Test Case Name: <code>testSupervisorDetermineNegativeNumShardsFromCardinalityReport</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\task\batch\parallel\DimensionCardinalityReportTest.java</code>)</h4>
<h4 id="mock-object-variable-name-negativeunion">Mock Object Variable Name: <code>negativeUnion</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    logger.clearLogEvents();
<span class="hljs-deletion">-    Union negativeUnion = mock(Union.class);</span>
<span class="hljs-deletion">-    Mockito.when(negativeUnion.getEstimate()).thenReturn(-1.0);</span>
<span class="hljs-addition">+    Union negativeUnion = createMockUnion(-1.0);</span>
    Interval interval = Intervals.of("2001-01-01/P1D");
    Map&lt;Interval, Union&gt; intervalToUnion = ImmutableMap.of(interval, negativeUnion);
    Map&lt;Interval, Integer&gt; intervalToNumShards = ParallelIndexSupervisorTask.computeIntervalToNumShards(10, intervalToUnion);
    Assert.assertEquals(new Integer(7), intervalToNumShards.get(interval));
    List&lt;LogEvent&gt; loggingEvents = logger.getLogEvents();
    String expectedLogMessage = "Estimated cardinality for union of estimates is zero or less: -1.00, setting num shards to 7";
    Assert.assertTrue("Logging events: " + loggingEvents, loggingEvents.stream().anyMatch(l -&gt; l.getLevel().equals(Level.WARN) &amp;&amp; l.getMessage().getFormattedMessage().equals(expectedLogMessage)));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSupervisorDetermineNegativeNumShardsFromCardinalityReport</span><span class="hljs-params">()</span> </span>{

    logger.clearLogEvents();

    Union negativeUnion = mock(Union<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(negativeUnion.getEstimate()).thenReturn(-<span class="hljs-number">1.0</span>);

    Interval interval = Intervals.of(<span class="hljs-string">"2001-01-01/P1D"</span>);

    Map&lt;Interval, Union&gt; intervalToUnion = ImmutableMap.of(interval, negativeUnion);

    Map&lt;Interval, Integer&gt; intervalToNumShards = ParallelIndexSupervisorTask.computeIntervalToNumShards(<span class="hljs-number">10</span>, intervalToUnion);

    Assert.assertEquals(<span class="hljs-keyword">new</span> Integer(<span class="hljs-number">7</span>), intervalToNumShards.get(interval));

    List&lt;LogEvent&gt; loggingEvents = logger.getLogEvents();

    String expectedLogMessage = <span class="hljs-string">"Estimated cardinality for union of estimates is zero or less: -1.00, setting num shards to 7"</span>;

    Assert.assertTrue(<span class="hljs-string">"Logging events: "</span> + loggingEvents, loggingEvents.stream().anyMatch(l -&gt; l.getLevel().equals(Level.WARN) &amp;&amp; l.getMessage().getFormattedMessage().equals(expectedLogMessage)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Union <span class="hljs-title">createMockUnion</span><span class="hljs-params">(<span class="hljs-keyword">double</span> estimateReturn)</span> </span>{
    Union union = mock(Union<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(union.getEstimate()).thenReturn(estimateReturn);
    <span class="hljs-keyword">return</span> union;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest212">Test Case ID #druid_Test_21_2</h4>
<h4 id="test-case-name-testsupervisordeterminepositivenumshardsfromcardinalityreportfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommontaskbatchparalleldimensioncardinalityreporttestjava">Test Case Name: <code>testSupervisorDeterminePositiveNumShardsFromCardinalityReport</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\task\batch\parallel\DimensionCardinalityReportTest.java</code>)</h4>
<h4 id="mock-object-variable-name-union">Mock Object Variable Name: <code>union</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testSupervisorDeterminePositiveNumShardsFromCardinalityReport() {
<span class="hljs-deletion">-    Union union = mock(Union.class);</span>
<span class="hljs-deletion">-    Mockito.when(union.getEstimate()).thenReturn(24.0);</span>
<span class="hljs-addition">+    Union union = createMockUnion(24.0);</span>
    Interval interval = Intervals.of("2001-01-01/P1D");
    Map&lt;Interval, Union&gt; intervalToUnion = ImmutableMap.of(interval, union);
    Map&lt;Interval, Integer&gt; intervalToNumShards = ParallelIndexSupervisorTask.computeIntervalToNumShards(6, intervalToUnion);
    Assert.assertEquals(new Integer(4), intervalToNumShards.get(interval));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSupervisorDeterminePositiveNumShardsFromCardinalityReport</span><span class="hljs-params">()</span> </span>{

    Union union = mock(Union<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(union.getEstimate()).thenReturn(<span class="hljs-number">24.0</span>);

    Interval interval = Intervals.of(<span class="hljs-string">"2001-01-01/P1D"</span>);

    Map&lt;Interval, Union&gt; intervalToUnion = ImmutableMap.of(interval, union);

    Map&lt;Interval, Integer&gt; intervalToNumShards = ParallelIndexSupervisorTask.computeIntervalToNumShards(<span class="hljs-number">6</span>, intervalToUnion);

    Assert.assertEquals(<span class="hljs-keyword">new</span> Integer(<span class="hljs-number">4</span>), intervalToNumShards.get(interval));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Union <span class="hljs-title">createMockUnion</span><span class="hljs-params">(<span class="hljs-keyword">double</span> estimateReturn)</span> </span>{
    Union union = mock(Union<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(union.getEstimate()).thenReturn(estimateReturn);
    <span class="hljs-keyword">return</span> union;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest213">Test Case ID #druid_Test_21_3</h4>
<h4 id="test-case-name-testsupervisordeterminepositiveoneshardfromcardinalityreportfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommontaskbatchparalleldimensioncardinalityreporttestjava">Test Case Name: <code>testSupervisorDeterminePositiveOneShardFromCardinalityReport</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\task\batch\parallel\DimensionCardinalityReportTest.java</code>)</h4>
<h4 id="mock-object-variable-name-union">Mock Object Variable Name: <code>union</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
     logger.clearLogEvents();
<span class="hljs-deletion">-    Union union = mock(Union.class);</span>
<span class="hljs-deletion">-    Mockito.when(union.getEstimate()).thenReturn(24.0);</span>
<span class="hljs-addition">+    Union union = createMockUnion(24.0);</span>
     Interval interval = Intervals.of("2001-01-01/P1D");
     Map&lt;Interval, Union&gt; intervalToUnion = ImmutableMap.of(interval, union);
     Map&lt;Interval, Integer&gt; intervalToNumShards = ParallelIndexSupervisorTask.computeIntervalToNumShards(24, intervalToUnion);
     Assert.assertEquals(new Integer(1), intervalToNumShards.get(interval));
     List&lt;LogEvent&gt; loggingEvents = logger.getLogEvents();
     String expectedLogMessage = "estimatedNumShards is ONE (1) given estimated cardinality 24.00 and maxRowsPerSegment 24";
     Assert.assertTrue("Logging events: " + loggingEvents, loggingEvents.stream().anyMatch(l -&gt; l.getLevel().equals(Level.INFO) &amp;&amp; l.getMessage().getFormattedMessage().equals(expectedLogMessage)));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSupervisorDeterminePositiveOneShardFromCardinalityReport</span><span class="hljs-params">()</span> </span>{

    logger.clearLogEvents();

    Union union = mock(Union<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(union.getEstimate()).thenReturn(<span class="hljs-number">24.0</span>);

    Interval interval = Intervals.of(<span class="hljs-string">"2001-01-01/P1D"</span>);

    Map&lt;Interval, Union&gt; intervalToUnion = ImmutableMap.of(interval, union);

    Map&lt;Interval, Integer&gt; intervalToNumShards = ParallelIndexSupervisorTask.computeIntervalToNumShards(<span class="hljs-number">24</span>, intervalToUnion);

    Assert.assertEquals(<span class="hljs-keyword">new</span> Integer(<span class="hljs-number">1</span>), intervalToNumShards.get(interval));

    List&lt;LogEvent&gt; loggingEvents = logger.getLogEvents();

    String expectedLogMessage = <span class="hljs-string">"estimatedNumShards is ONE (1) given estimated cardinality 24.00 and maxRowsPerSegment 24"</span>;

    Assert.assertTrue(<span class="hljs-string">"Logging events: "</span> + loggingEvents, loggingEvents.stream().anyMatch(l -&gt; l.getLevel().equals(Level.INFO) &amp;&amp; l.getMessage().getFormattedMessage().equals(expectedLogMessage)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Union <span class="hljs-title">createMockUnion</span><span class="hljs-params">(<span class="hljs-keyword">double</span> estimateReturn)</span> </span>{
    Union union = mock(Union<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(union.getEstimate()).thenReturn(estimateReturn);
    <span class="hljs-keyword">return</span> union;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci22">Mock Clone Instance #druid_MCI_22</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>javax.servlet.ServletOutputStream</code></li>
<li><strong>Test Case Count</strong>: 6</li>
<li><strong>MO Count</strong>: 6</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ServletOutputStream outputStream;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
outputStream

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest221">Test Case ID #druid_Test_22_1</h4>
<h4 id="test-case-name-testhandleexceptionwithfilterdisabledfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleExceptionWithFilterDisabled</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-outputstream">Mock Object Variable Name: <code>outputStream</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testHandleExceptionWithFilterDisabled() throws Exception {
     String errorMessage = "test exception message";
     ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);
     HttpServletResponse response = Mockito.mock(HttpServletResponse.class);
<span class="hljs-deletion">-    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `outputStream`</span>
     Mockito.when(response.getOutputStream()).thenReturn(outputStream);
     final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig());
     Exception testException = new IllegalStateException(errorMessage);
     servlet.handleException(response, mockMapper, testException);
     ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception.class);
<span class="hljs-deletion">-    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
<span class="hljs-addition">+    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
     Assert.assertTrue(captor.getValue() instanceof QueryException);
     Assert.assertEquals("Unknown exception", ((QueryException) captor.getValue()).getErrorCode());
     Assert.assertEquals(errorMessage, captor.getValue().getMessage());
     Assert.assertEquals(IllegalStateException.class.getName(), ((QueryException) captor.getValue()).getErrorClass());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleExceptionWithFilterDisabled</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig());

    Exception testException = <span class="hljs-keyword">new</span> IllegalStateException(errorMessage);

    servlet.handleException(response, mockMapper, testException);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertEquals(errorMessage, captor.getValue().getMessage());

    Assert.assertEquals(IllegalStateException<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), ((<span class="hljs-title">QueryException</span>) <span class="hljs-title">captor</span>.<span class="hljs-title">getValue</span>()).<span class="hljs-title">getErrorClass</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ServletOutputStream outputStream;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
outputStream

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest222">Test Case ID #druid_Test_22_2</h4>
<h4 id="test-case-name-testhandleexceptionwithfilterenabledfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleExceptionWithFilterEnabled</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-outputstream">Mock Object Variable Name: <code>outputStream</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);
    HttpServletResponse response = Mockito.mock(HttpServletResponse.class);
<span class="hljs-deletion">-    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `outputStream`</span>
    Mockito.when(response.getOutputStream()).thenReturn(outputStream);
    final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig() {
@@
    servlet.handleException(response, mockMapper, testException);
    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception.class);
<span class="hljs-deletion">-    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
<span class="hljs-addition">+    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
    Assert.assertTrue(captor.getValue() instanceof QueryException);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleExceptionWithFilterEnabled</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isShowDetailedJettyErrors</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> ErrorResponseTransformStrategy <span class="hljs-title">getErrorResponseTransformStrategy</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AllowedRegexErrorResponseTransformStrategy(ImmutableList.of());

        }

    });

    Exception testException = <span class="hljs-keyword">new</span> IllegalStateException(errorMessage);

    servlet.handleException(response, mockMapper, testException);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertNull(captor.getValue().getMessage());

    Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());

    Assert.assertNull(((QueryException) captor.getValue()).getHost());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ServletOutputStream outputStream;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
outputStream

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest223">Test Case ID #druid_Test_22_3</h4>
<h4 id="test-case-name-testhandleexceptionwithfilterenabledbutmessagematchallowedregexfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleExceptionWithFilterEnabledButMessageMatchAllowedRegex</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-outputstream">Mock Object Variable Name: <code>outputStream</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testHandleExceptionWithFilterEnabledButMessageMatchAllowedRegex() throws Exception {
     String errorMessage = "test exception message";
     ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);
     HttpServletResponse response = Mockito.mock(HttpServletResponse.class);
<span class="hljs-deletion">-    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `outputStream`</span>
     Mockito.when(response.getOutputStream()).thenReturn(outputStream);
     final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig() {

         @Override
         public boolean isShowDetailedJettyErrors() {
             return true;
         }

         @Override
         public ErrorResponseTransformStrategy getErrorResponseTransformStrategy() {
             return new AllowedRegexErrorResponseTransformStrategy(ImmutableList.of("test .*"));
         }
     });
     Exception testException = new IllegalStateException(errorMessage);
     servlet.handleException(response, mockMapper, testException);
     ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception.class);
<span class="hljs-deletion">-    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
<span class="hljs-addition">+    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
     Assert.assertTrue(captor.getValue() instanceof QueryException);
     Assert.assertEquals("Unknown exception", ((QueryException) captor.getValue()).getErrorCode());
     Assert.assertEquals(errorMessage, captor.getValue().getMessage());
     Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());
     Assert.assertNull(((QueryException) captor.getValue()).getHost());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleExceptionWithFilterEnabledButMessageMatchAllowedRegex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isShowDetailedJettyErrors</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> ErrorResponseTransformStrategy <span class="hljs-title">getErrorResponseTransformStrategy</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AllowedRegexErrorResponseTransformStrategy(ImmutableList.of(<span class="hljs-string">"test .*"</span>));

        }

    });

    Exception testException = <span class="hljs-keyword">new</span> IllegalStateException(errorMessage);

    servlet.handleException(response, mockMapper, testException);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertEquals(errorMessage, captor.getValue().getMessage());

    Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());

    Assert.assertNull(((QueryException) captor.getValue()).getHost());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ServletOutputStream outputStream;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
outputStream

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest224">Test Case ID #druid_Test_22_4</h4>
<h4 id="test-case-name-testhandlequeryparseexceptionwithfilterdisabledfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleQueryParseExceptionWithFilterDisabled</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-outputstream">Mock Object Variable Name: <code>outputStream</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testHandleQueryParseExceptionWithFilterDisabled() throws Exception {
     String errorMessage = "test exception message";
     ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);
     HttpServletRequest request = Mockito.mock(HttpServletRequest.class);
     HttpServletResponse response = Mockito.mock(HttpServletResponse.class);
<span class="hljs-deletion">-    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `outputStream`</span>
     Mockito.when(response.getOutputStream()).thenReturn(outputStream);
     final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig());
     IOException testException = new IOException(errorMessage);
     servlet.handleQueryParseException(request, response, mockMapper, testException, false);
     ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception.class);
     Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());
     Assert.assertTrue(captor.getValue() instanceof QueryException);
     Assert.assertEquals("Unknown exception", ((QueryException) captor.getValue()).getErrorCode());
     Assert.assertEquals(errorMessage, captor.getValue().getMessage());
     Assert.assertEquals(IOException.class.getName(), ((QueryException) captor.getValue()).getErrorClass());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleQueryParseExceptionWithFilterDisabled</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletRequest request = Mockito.mock(HttpServletRequest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig());

    IOException testException = <span class="hljs-keyword">new</span> IOException(errorMessage);

    servlet.handleQueryParseException(request, response, mockMapper, testException, <span class="hljs-keyword">false</span>);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertEquals(errorMessage, captor.getValue().getMessage());

    Assert.assertEquals(IOException<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), ((<span class="hljs-title">QueryException</span>) <span class="hljs-title">captor</span>.<span class="hljs-title">getValue</span>()).<span class="hljs-title">getErrorClass</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ServletOutputStream outputStream;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
outputStream

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest225">Test Case ID #druid_Test_22_5</h4>
<h4 id="test-case-name-testhandlequeryparseexceptionwithfilterenabledfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleQueryParseExceptionWithFilterEnabled</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-outputstream">Mock Object Variable Name: <code>outputStream</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testHandleQueryParseExceptionWithFilterEnabled() throws Exception {
     String errorMessage = "test exception message";
     ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);
     HttpServletRequest request = Mockito.mock(HttpServletRequest.class);
     HttpServletResponse response = Mockito.mock(HttpServletResponse.class);
<span class="hljs-deletion">-    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `outputStream`</span>
     Mockito.when(response.getOutputStream()).thenReturn(outputStream);
     final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig() {

         @Override
         public boolean isShowDetailedJettyErrors() {
             return true;
         }

         @Override
         public ErrorResponseTransformStrategy getErrorResponseTransformStrategy() {
             return new AllowedRegexErrorResponseTransformStrategy(ImmutableList.of());
         }
     });
     IOException testException = new IOException(errorMessage);
     servlet.handleQueryParseException(request, response, mockMapper, testException, false);
     ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception.class);
<span class="hljs-deletion">-    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
<span class="hljs-addition">+    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
     Assert.assertTrue(captor.getValue() instanceof QueryException);
     Assert.assertEquals("Unknown exception", ((QueryException) captor.getValue()).getErrorCode());
     Assert.assertNull(captor.getValue().getMessage());
     Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());
     Assert.assertNull(((QueryException) captor.getValue()).getHost());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleQueryParseExceptionWithFilterEnabled</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletRequest request = Mockito.mock(HttpServletRequest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isShowDetailedJettyErrors</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> ErrorResponseTransformStrategy <span class="hljs-title">getErrorResponseTransformStrategy</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AllowedRegexErrorResponseTransformStrategy(ImmutableList.of());

        }

    });

    IOException testException = <span class="hljs-keyword">new</span> IOException(errorMessage);

    servlet.handleQueryParseException(request, response, mockMapper, testException, <span class="hljs-keyword">false</span>);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertNull(captor.getValue().getMessage());

    Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());

    Assert.assertNull(((QueryException) captor.getValue()).getHost());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ServletOutputStream outputStream;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
outputStream

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest226">Test Case ID #druid_Test_22_6</h4>
<h4 id="test-case-name-testhandlequeryparseexceptionwithfilterenabledbutmessagematchallowedregexfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleQueryParseExceptionWithFilterEnabledButMessageMatchAllowedRegex</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-outputstream">Mock Object Variable Name: <code>outputStream</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    HttpServletRequest request = Mockito.mock(HttpServletRequest.class);
    HttpServletResponse response = Mockito.mock(HttpServletResponse.class);
<span class="hljs-deletion">-    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `outputStream`</span>
    Mockito.when(response.getOutputStream()).thenReturn(outputStream);
    final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig() {
@@
    servlet.handleQueryParseException(request, response, mockMapper, testException, false);
    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception.class);
<span class="hljs-deletion">-    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
<span class="hljs-addition">+    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
    Assert.assertTrue(captor.getValue() instanceof QueryException);
    Assert.assertEquals("Unknown exception", ((QueryException) captor.getValue()).getErrorCode());
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleQueryParseExceptionWithFilterEnabledButMessageMatchAllowedRegex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletRequest request = Mockito.mock(HttpServletRequest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isShowDetailedJettyErrors</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> ErrorResponseTransformStrategy <span class="hljs-title">getErrorResponseTransformStrategy</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AllowedRegexErrorResponseTransformStrategy(ImmutableList.of(<span class="hljs-string">"test .*"</span>));

        }

    });

    IOException testException = <span class="hljs-keyword">new</span> IOException(errorMessage);

    servlet.handleQueryParseException(request, response, mockMapper, testException, <span class="hljs-keyword">false</span>);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertEquals(errorMessage, captor.getValue().getMessage());

    Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());

    Assert.assertNull(((QueryException) captor.getValue()).getHost());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ServletOutputStream outputStream;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
outputStream

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci23">Mock Clone Instance #druid_MCI_23</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.indexing.common.task.Task</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Task <span class="hljs-title">createMockTask</span><span class="hljs-params">(TaskResource taskResource, String type)</span> </span>{
    Task mockTask = mock(Task<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(mockTask.getTaskResource()).thenReturn(taskResource);
    when(mockTask.getType()).thenReturn(type);
    <span class="hljs-keyword">return</span> mockTask;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest231">Test Case ID #druid_Test_23_1</h4>
<h4 id="test-case-name-testcanruntaskfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingoverlordimmutableworkerinfotestjava">Test Case Name: <code>test_canRunTask</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\overlord\ImmutableWorkerInfoTest.java</code>)</h4>
<h4 id="mock-object-variable-name-parallelindextask">Mock Object Variable Name: <code>parallelIndexTask</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    TaskResource taskResource0 = mock(TaskResource.class);
    when(taskResource0.getRequiredCapacity()).thenReturn(3);
<span class="hljs-deletion">-    Task parallelIndexTask = mock(ParallelIndexSupervisorTask.class);</span>
<span class="hljs-deletion">-    when(parallelIndexTask.getType()).thenReturn(ParallelIndexSupervisorTask.TYPE);</span>
<span class="hljs-deletion">-    when(parallelIndexTask.getTaskResource()).thenReturn(taskResource0);</span>
<span class="hljs-addition">+    Task parallelIndexTask = createMockTask(taskResource0, ParallelIndexSupervisorTask.TYPE);</span>
    // Since task satisifies parallel and total slot constraints, can run
    Assert.assertTrue(workerInfo.canRunTask(parallelIndexTask, 0.5));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test_canRunTask</span><span class="hljs-params">()</span> </span>{

    ImmutableWorkerInfo workerInfo = <span class="hljs-keyword">new</span> ImmutableWorkerInfo(<span class="hljs-keyword">new</span> Worker(<span class="hljs-string">"http"</span>, <span class="hljs-string">"testWorker2"</span>, <span class="hljs-string">"192.0.0.1"</span>, <span class="hljs-number">10</span>, <span class="hljs-string">"v1"</span>, WorkerConfig.DEFAULT_CATEGORY), <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, ImmutableSet.of(<span class="hljs-string">"grp1"</span>, <span class="hljs-string">"grp2"</span>), ImmutableSet.of(<span class="hljs-string">"task1"</span>, <span class="hljs-string">"task2"</span>), DateTimes.of(<span class="hljs-string">"2015-01-01T01:01:02Z"</span>));

    <span class="hljs-comment">// Parallel index task</span>

    TaskResource taskResource0 = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskResource0.getRequiredCapacity()).thenReturn(<span class="hljs-number">3</span>);

    Task parallelIndexTask = mock(ParallelIndexSupervisorTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(parallelIndexTask.getType()).thenReturn(ParallelIndexSupervisorTask.TYPE);

    when(parallelIndexTask.getTaskResource()).thenReturn(taskResource0);

    <span class="hljs-comment">// Since task satisifies parallel and total slot constraints, can run</span>

    Assert.assertTrue(workerInfo.canRunTask(parallelIndexTask, <span class="hljs-number">0.5</span>));

    <span class="hljs-comment">// Since task fails the parallel slot constraint, it cannot run (3 &gt; 1)</span>

    Assert.assertFalse(workerInfo.canRunTask(parallelIndexTask, <span class="hljs-number">0.1</span>));

    <span class="hljs-comment">// Some other indexing task</span>

    TaskResource taskResource1 = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskResource1.getRequiredCapacity()).thenReturn(<span class="hljs-number">5</span>);

    Task anyOtherTask = mock(IndexTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(anyOtherTask.getType()).thenReturn(<span class="hljs-string">"index"</span>);

    when(anyOtherTask.getTaskResource()).thenReturn(taskResource1);

    <span class="hljs-comment">// Not a parallel index task -&gt;  satisfies parallel index constraint</span>

    <span class="hljs-comment">// But does not satisfy the total slot constraint and cannot run (11 &gt; 10)</span>

    Assert.assertFalse(workerInfo.canRunTask(anyOtherTask, <span class="hljs-number">0.5</span>));

    <span class="hljs-comment">// Task has an availability conflict ("grp1")</span>

    TaskResource taskResource2 = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskResource2.getRequiredCapacity()).thenReturn(<span class="hljs-number">1</span>);

    when(taskResource2.getAvailabilityGroup()).thenReturn(<span class="hljs-string">"grp1"</span>);

    Task grp1Task = mock(IndexTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(grp1Task.getType()).thenReturn(<span class="hljs-string">"blah"</span>);

    when(grp1Task.getTaskResource()).thenReturn(taskResource2);

    <span class="hljs-comment">// Satisifies parallel index and total index slot constraints but cannot run due availability</span>

    Assert.assertFalse(workerInfo.canRunTask(grp1Task, <span class="hljs-number">0.3</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Task <span class="hljs-title">createMockTask</span><span class="hljs-params">(TaskResource taskResource, String type)</span> </span>{
    Task mockTask = mock(Task<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(mockTask.getTaskResource()).thenReturn(taskResource);
    when(mockTask.getType()).thenReturn(type);
    <span class="hljs-keyword">return</span> mockTask;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest232">Test Case ID #druid_Test_23_2</h4>
<h4 id="test-case-name-testcanruntaskfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingoverlordimmutableworkerinfotestjava">Test Case Name: <code>test_canRunTask</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\overlord\ImmutableWorkerInfoTest.java</code>)</h4>
<h4 id="mock-object-variable-name-anyothertask">Mock Object Variable Name: <code>anyOtherTask</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     TaskResource taskResource1 = mock(TaskResource.class);
     when(taskResource1.getRequiredCapacity()).thenReturn(5);
<span class="hljs-deletion">-    Task anyOtherTask = mock(IndexTask.class);</span>
<span class="hljs-deletion">-    when(anyOtherTask.getType()).thenReturn("index");</span>
<span class="hljs-deletion">-    when(anyOtherTask.getTaskResource()).thenReturn(taskResource1);</span>
<span class="hljs-addition">+    Task anyOtherTask = createMockTask(taskResource1, "index");</span>
     // Not a parallel index task -&gt;  satisfies parallel index constraint
     // But does not satisfy the total slot constraint and cannot run (11 &gt; 10)
     Assert.assertFalse(workerInfo.canRunTask(anyOtherTask, 0.5));
     // Task has an availability conflict ("grp1")
     TaskResource taskResource2 = mock(TaskResource.class);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test_canRunTask</span><span class="hljs-params">()</span> </span>{

    ImmutableWorkerInfo workerInfo = <span class="hljs-keyword">new</span> ImmutableWorkerInfo(<span class="hljs-keyword">new</span> Worker(<span class="hljs-string">"http"</span>, <span class="hljs-string">"testWorker2"</span>, <span class="hljs-string">"192.0.0.1"</span>, <span class="hljs-number">10</span>, <span class="hljs-string">"v1"</span>, WorkerConfig.DEFAULT_CATEGORY), <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, ImmutableSet.of(<span class="hljs-string">"grp1"</span>, <span class="hljs-string">"grp2"</span>), ImmutableSet.of(<span class="hljs-string">"task1"</span>, <span class="hljs-string">"task2"</span>), DateTimes.of(<span class="hljs-string">"2015-01-01T01:01:02Z"</span>));

    <span class="hljs-comment">// Parallel index task</span>

    TaskResource taskResource0 = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskResource0.getRequiredCapacity()).thenReturn(<span class="hljs-number">3</span>);

    Task parallelIndexTask = mock(ParallelIndexSupervisorTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(parallelIndexTask.getType()).thenReturn(ParallelIndexSupervisorTask.TYPE);

    when(parallelIndexTask.getTaskResource()).thenReturn(taskResource0);

    <span class="hljs-comment">// Since task satisifies parallel and total slot constraints, can run</span>

    Assert.assertTrue(workerInfo.canRunTask(parallelIndexTask, <span class="hljs-number">0.5</span>));

    <span class="hljs-comment">// Since task fails the parallel slot constraint, it cannot run (3 &gt; 1)</span>

    Assert.assertFalse(workerInfo.canRunTask(parallelIndexTask, <span class="hljs-number">0.1</span>));

    <span class="hljs-comment">// Some other indexing task</span>

    TaskResource taskResource1 = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskResource1.getRequiredCapacity()).thenReturn(<span class="hljs-number">5</span>);

    Task anyOtherTask = mock(IndexTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(anyOtherTask.getType()).thenReturn(<span class="hljs-string">"index"</span>);

    when(anyOtherTask.getTaskResource()).thenReturn(taskResource1);

    <span class="hljs-comment">// Not a parallel index task -&gt;  satisfies parallel index constraint</span>

    <span class="hljs-comment">// But does not satisfy the total slot constraint and cannot run (11 &gt; 10)</span>

    Assert.assertFalse(workerInfo.canRunTask(anyOtherTask, <span class="hljs-number">0.5</span>));

    <span class="hljs-comment">// Task has an availability conflict ("grp1")</span>

    TaskResource taskResource2 = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskResource2.getRequiredCapacity()).thenReturn(<span class="hljs-number">1</span>);

    when(taskResource2.getAvailabilityGroup()).thenReturn(<span class="hljs-string">"grp1"</span>);

    Task grp1Task = mock(IndexTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(grp1Task.getType()).thenReturn(<span class="hljs-string">"blah"</span>);

    when(grp1Task.getTaskResource()).thenReturn(taskResource2);

    <span class="hljs-comment">// Satisifies parallel index and total index slot constraints but cannot run due availability</span>

    Assert.assertFalse(workerInfo.canRunTask(grp1Task, <span class="hljs-number">0.3</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Task <span class="hljs-title">createMockTask</span><span class="hljs-params">(TaskResource taskResource, String type)</span> </span>{
    Task mockTask = mock(Task<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(mockTask.getTaskResource()).thenReturn(taskResource);
    when(mockTask.getType()).thenReturn(type);
    <span class="hljs-keyword">return</span> mockTask;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest233">Test Case ID #druid_Test_23_3</h4>
<h4 id="test-case-name-testcanruntaskfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingoverlordimmutableworkerinfotestjava">Test Case Name: <code>test_canRunTask</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\overlord\ImmutableWorkerInfoTest.java</code>)</h4>
<h4 id="mock-object-variable-name-grp1task">Mock Object Variable Name: <code>grp1Task</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     when(taskResource2.getRequiredCapacity()).thenReturn(1);
     when(taskResource2.getAvailabilityGroup()).thenReturn("grp1");
<span class="hljs-deletion">-    Task grp1Task = mock(IndexTask.class);</span>
<span class="hljs-deletion">-    when(grp1Task.getType()).thenReturn("blah");</span>
<span class="hljs-deletion">-    when(grp1Task.getTaskResource()).thenReturn(taskResource2);</span>
<span class="hljs-addition">+    Task grp1Task = createMockTask(taskResource2, "blah");</span>
     // Satisifies parallel index and total index slot constraints but cannot run due availability
     Assert.assertFalse(workerInfo.canRunTask(grp1Task, 0.3));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test_canRunTask</span><span class="hljs-params">()</span> </span>{

    ImmutableWorkerInfo workerInfo = <span class="hljs-keyword">new</span> ImmutableWorkerInfo(<span class="hljs-keyword">new</span> Worker(<span class="hljs-string">"http"</span>, <span class="hljs-string">"testWorker2"</span>, <span class="hljs-string">"192.0.0.1"</span>, <span class="hljs-number">10</span>, <span class="hljs-string">"v1"</span>, WorkerConfig.DEFAULT_CATEGORY), <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, ImmutableSet.of(<span class="hljs-string">"grp1"</span>, <span class="hljs-string">"grp2"</span>), ImmutableSet.of(<span class="hljs-string">"task1"</span>, <span class="hljs-string">"task2"</span>), DateTimes.of(<span class="hljs-string">"2015-01-01T01:01:02Z"</span>));

    <span class="hljs-comment">// Parallel index task</span>

    TaskResource taskResource0 = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskResource0.getRequiredCapacity()).thenReturn(<span class="hljs-number">3</span>);

    Task parallelIndexTask = mock(ParallelIndexSupervisorTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(parallelIndexTask.getType()).thenReturn(ParallelIndexSupervisorTask.TYPE);

    when(parallelIndexTask.getTaskResource()).thenReturn(taskResource0);

    <span class="hljs-comment">// Since task satisifies parallel and total slot constraints, can run</span>

    Assert.assertTrue(workerInfo.canRunTask(parallelIndexTask, <span class="hljs-number">0.5</span>));

    <span class="hljs-comment">// Since task fails the parallel slot constraint, it cannot run (3 &gt; 1)</span>

    Assert.assertFalse(workerInfo.canRunTask(parallelIndexTask, <span class="hljs-number">0.1</span>));

    <span class="hljs-comment">// Some other indexing task</span>

    TaskResource taskResource1 = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskResource1.getRequiredCapacity()).thenReturn(<span class="hljs-number">5</span>);

    Task anyOtherTask = mock(IndexTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(anyOtherTask.getType()).thenReturn(<span class="hljs-string">"index"</span>);

    when(anyOtherTask.getTaskResource()).thenReturn(taskResource1);

    <span class="hljs-comment">// Not a parallel index task -&gt;  satisfies parallel index constraint</span>

    <span class="hljs-comment">// But does not satisfy the total slot constraint and cannot run (11 &gt; 10)</span>

    Assert.assertFalse(workerInfo.canRunTask(anyOtherTask, <span class="hljs-number">0.5</span>));

    <span class="hljs-comment">// Task has an availability conflict ("grp1")</span>

    TaskResource taskResource2 = mock(TaskResource<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskResource2.getRequiredCapacity()).thenReturn(<span class="hljs-number">1</span>);

    when(taskResource2.getAvailabilityGroup()).thenReturn(<span class="hljs-string">"grp1"</span>);

    Task grp1Task = mock(IndexTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(grp1Task.getType()).thenReturn(<span class="hljs-string">"blah"</span>);

    when(grp1Task.getTaskResource()).thenReturn(taskResource2);

    <span class="hljs-comment">// Satisifies parallel index and total index slot constraints but cannot run due availability</span>

    Assert.assertFalse(workerInfo.canRunTask(grp1Task, <span class="hljs-number">0.3</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Task <span class="hljs-title">createMockTask</span><span class="hljs-params">(TaskResource taskResource, String type)</span> </span>{
    Task mockTask = mock(Task<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(mockTask.getTaskResource()).thenReturn(taskResource);
    when(mockTask.getType()).thenReturn(type);
    <span class="hljs-keyword">return</span> mockTask;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci24">Mock Clone Instance #druid_MCI_24</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.indexing.overlord.TaskRunner</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> TaskRunner runner;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    runner = mock(TaskRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
runner;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest241">Test Case ID #druid_Test_24_1</h4>
<h4 id="test-case-name-testactioncallstaskrunnerfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommonactionsupdatestatusactiontestjava">Test Case Name: <code>testActionCallsTaskRunner</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\actions\UpdateStatusActionTest.java</code>)</h4>
<h4 id="mock-object-variable-name-runner">Mock Object Variable Name: <code>runner</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testActionCallsTaskRunner() {
     UpdateStatusAction action = new UpdateStatusAction("successful");
     Task task = NoopTask.create();
     TaskActionToolbox toolbox = mock(TaskActionToolbox.class);
<span class="hljs-deletion">-    TaskRunner runner = mock(TaskRunner.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `runner`</span>
     when(toolbox.getTaskRunner()).thenReturn(Optional.of(runner));
     action.perform(task, toolbox);
     verify(runner, times(1)).updateStatus(eq(task), eq(TaskStatus.success(task.getId())));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testActionCallsTaskRunner</span><span class="hljs-params">()</span> </span>{

    UpdateStatusAction action = <span class="hljs-keyword">new</span> UpdateStatusAction(<span class="hljs-string">"successful"</span>);

    Task task = NoopTask.create();

    TaskActionToolbox toolbox = mock(TaskActionToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TaskRunner runner = mock(TaskRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskRunner()).thenReturn(Optional.of(runner));

    action.perform(task, toolbox);

    verify(runner, times(<span class="hljs-number">1</span>)).updateStatus(eq(task), eq(TaskStatus.success(task.getId())));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> TaskRunner runner;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    runner = mock(TaskRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
runner;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest242">Test Case ID #druid_Test_24_2</h4>
<h4 id="test-case-name-testfailurescenariofile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommonactionsupdatestatusactiontestjava">Test Case Name: <code>testFailureScenario</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\actions\UpdateStatusActionTest.java</code>)</h4>
<h4 id="mock-object-variable-name-runner">Mock Object Variable Name: <code>runner</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testFailureScenario() {
     UpdateStatusAction action = new UpdateStatusAction("failure");
     Task task = NoopTask.create();
     TaskActionToolbox toolbox = mock(TaskActionToolbox.class);
<span class="hljs-deletion">-    TaskRunner runner = mock(TaskRunner.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `runner`</span>
     when(toolbox.getTaskRunner()).thenReturn(Optional.of(runner));
     action.perform(task, toolbox);
     verify(runner, times(1)).updateStatus(eq(task), eq(TaskStatus.failure(task.getId(), "Error with task")));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFailureScenario</span><span class="hljs-params">()</span> </span>{

    UpdateStatusAction action = <span class="hljs-keyword">new</span> UpdateStatusAction(<span class="hljs-string">"failure"</span>);

    Task task = NoopTask.create();

    TaskActionToolbox toolbox = mock(TaskActionToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TaskRunner runner = mock(TaskRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskRunner()).thenReturn(Optional.of(runner));

    action.perform(task, toolbox);

    verify(runner, times(<span class="hljs-number">1</span>)).updateStatus(eq(task), eq(TaskStatus.failure(task.getId(), <span class="hljs-string">"Error with task"</span>)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> TaskRunner runner;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    runner = mock(TaskRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
runner;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest243">Test Case ID #druid_Test_24_3</h4>
<h4 id="test-case-name-testnotaskrunnerfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommonactionsupdatestatusactiontestjava">Test Case Name: <code>testNoTaskRunner</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\actions\UpdateStatusActionTest.java</code>)</h4>
<h4 id="mock-object-variable-name-runner">Mock Object Variable Name: <code>runner</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testNoTaskRunner() {
     UpdateStatusAction action = new UpdateStatusAction("successful");
     Task task = NoopTask.create();
     TaskActionToolbox toolbox = mock(TaskActionToolbox.class);
<span class="hljs-deletion">-    TaskRunner runner = mock(TaskRunner.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `runner`</span>
     when(toolbox.getTaskRunner()).thenReturn(Optional.absent());
     action.perform(task, toolbox);
<span class="hljs-deletion">-    verify(runner, never()).updateStatus(any(), any());</span>
<span class="hljs-addition">+    verify(runner, never()).updateStatus(any(), any());</span>
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testNoTaskRunner</span><span class="hljs-params">()</span> </span>{

    UpdateStatusAction action = <span class="hljs-keyword">new</span> UpdateStatusAction(<span class="hljs-string">"successful"</span>);

    Task task = NoopTask.create();

    TaskActionToolbox toolbox = mock(TaskActionToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TaskRunner runner = mock(TaskRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskRunner()).thenReturn(Optional.absent());

    action.perform(task, toolbox);

    verify(runner, never()).updateStatus(any(), any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> TaskRunner runner;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    runner = mock(TaskRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
runner;

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci25">Mock Clone Instance #druid_MCI_25</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>java.util.concurrent.ExecutorService</code></li>
<li><strong>Test Case Count</strong>: 5</li>
<li><strong>MO Count</strong>: 5</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ExecutorService executor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
executor;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest251">Test Case ID #druid_Test_25_1</h4>
<h4 id="test-case-name-testfindmonitorfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidjavautilmetricsclockdriftsafemonitorschedulertestjava">Test Case Name: <code>testFindMonitor</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\java\util\metrics\ClockDriftSafeMonitorSchedulerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-executor">Mock Object Variable Name: <code>executor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testFindMonitor() {
     class Monitor1 extends NoopMonitor {
     }
     class Monitor2 extends NoopMonitor {
     }
     class Monitor3 extends NoopMonitor {
     }
     final Monitor1 monitor1 = new Monitor1();
     final Monitor2 monitor2 = new Monitor2();
<span class="hljs-deletion">-    ExecutorService executor = Mockito.mock(ExecutorService.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `executor`</span>
     final MonitorScheduler scheduler = new ClockDriftSafeMonitorScheduler(Mockito.mock(DruidMonitorSchedulerConfig.class), Mockito.mock(ServiceEmitter.class), ImmutableList.of(monitor1, monitor2), CronScheduler.newBuilder(Duration.ofSeconds(1L)).setThreadName("monitor-scheduler-test").build(), executor);
     final Optional&lt;Monitor1&gt; maybeFound1 = scheduler.findMonitor(Monitor1.class);
     final Optional&lt;Monitor2&gt; maybeFound2 = scheduler.findMonitor(Monitor2.class);
     Assert.assertTrue(maybeFound1.isPresent());
     Assert.assertTrue(maybeFound2.isPresent());
     Assert.assertSame(monitor1, maybeFound1.get());
     Assert.assertSame(monitor2, maybeFound2.get());
     Assert.assertFalse(scheduler.findMonitor(Monitor3.class).isPresent());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFindMonitor</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Monitor1</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">NoopMonitor</span> </span>{

    }

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Monitor2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">NoopMonitor</span> </span>{

    }

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Monitor3</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">NoopMonitor</span> </span>{

    }

    <span class="hljs-keyword">final</span> Monitor1 monitor1 = <span class="hljs-keyword">new</span> Monitor1();

    <span class="hljs-keyword">final</span> Monitor2 monitor2 = <span class="hljs-keyword">new</span> Monitor2();

    ExecutorService executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> MonitorScheduler scheduler = <span class="hljs-keyword">new</span> ClockDriftSafeMonitorScheduler(Mockito.mock(DruidMonitorSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">Mockito</span>.<span class="hljs-title">mock</span>(<span class="hljs-title">ServiceEmitter</span>.<span class="hljs-title">class</span>), <span class="hljs-title">ImmutableList</span>.<span class="hljs-title">of</span>(<span class="hljs-title">monitor1</span>, <span class="hljs-title">monitor2</span>), <span class="hljs-title">CronScheduler</span>.<span class="hljs-title">newBuilder</span>(<span class="hljs-title">Duration</span>.<span class="hljs-title">ofSeconds</span>(1<span class="hljs-title">L</span>)).<span class="hljs-title">setThreadName</span>("<span class="hljs-title">monitor</span>-<span class="hljs-title">scheduler</span>-<span class="hljs-title">test</span>").<span class="hljs-title">build</span>(), <span class="hljs-title">executor</span>)</span>;

    <span class="hljs-keyword">final</span> Optional&lt;Monitor1&gt; maybeFound1 = scheduler.findMonitor(Monitor1<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Optional&lt;Monitor2&gt; maybeFound2 = scheduler.findMonitor(Monitor2<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Assert.assertTrue(maybeFound1.isPresent());

    Assert.assertTrue(maybeFound2.isPresent());

    Assert.assertSame(monitor1, maybeFound1.get());

    Assert.assertSame(monitor2, maybeFound2.get());

    Assert.assertFalse(scheduler.findMonitor(Monitor3<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">isPresent</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ExecutorService executor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
executor;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest252">Test Case ID #druid_Test_25_2</h4>
<h4 id="test-case-name-teststartrepeatschedulingfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidjavautilmetricsclockdriftsafemonitorschedulertestjava">Test Case Name: <code>testStart_RepeatScheduling</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\java\util\metrics\ClockDriftSafeMonitorSchedulerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-executor">Mock Object Variable Name: <code>executor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testStart_RepeatScheduling() throws InterruptedException {
<span class="hljs-deletion">-    ExecutorService executor = Mockito.mock(ExecutorService.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `executor`</span>
     CountDownLatch latch = new CountDownLatch(1);
     Mockito.doAnswer(new Answer&lt;Future&lt;?&gt;&gt;() {

         private int scheduleCount = 0;

         @SuppressWarnings("unchecked")
         @Override
         public Future&lt;?&gt; answer(InvocationOnMock invocation) {
             final Object originalArgument = (invocation.getArguments())[3];
             CronTask task = ((CronTask) originalArgument);
             Mockito.doAnswer(new Answer&lt;Future&lt;?&gt;&gt;() {

                 @Override
                 public Future&lt;Boolean&gt; answer(InvocationOnMock invocation) throws Exception {
                     final Object originalArgument = (invocation.getArguments())[0];
                     ((Callable&lt;Boolean&gt;) originalArgument).call();
                     return CompletableFuture.completedFuture(Boolean.TRUE);
                 }
             }).when(executor).submit(ArgumentMatchers.any(Callable.class));
             cronTaskRunner.submit(() -&gt; {
                 while (scheduleCount &lt; 2) {
                     scheduleCount++;
                     task.run(123L);
                 }
                 latch.countDown();
                 return null;
             });
             return createDummyFuture();
         }
     }).when(cronScheduler).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask.class));
     Monitor monitor = Mockito.mock(Monitor.class);
     DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig.class);
     Mockito.when(config.getEmissionDuration()).thenReturn(new org.joda.time.Duration(1000L));
     final MonitorScheduler scheduler = new ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter.class), ImmutableList.of(monitor), cronScheduler, executor);
     scheduler.start();
     latch.await(5, TimeUnit.SECONDS);
     Mockito.verify(monitor, Mockito.times(1)).start();
     Mockito.verify(cronScheduler, Mockito.times(1)).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask.class));
<span class="hljs-deletion">-    Mockito.verify(executor, Mockito.times(2)).submit(ArgumentMatchers.any(Callable.class));</span>
<span class="hljs-addition">+    Mockito.verify(executor, Mockito.times(2)).submit(ArgumentMatchers.any(Callable.class));</span>
     Mockito.verify(monitor, Mockito.times(2)).monitor(ArgumentMatchers.any());
     scheduler.stop();
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStart_RepeatScheduling</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    ExecutorService executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    Mockito.doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Future&lt;?&gt;&gt;() {



        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> scheduleCount = <span class="hljs-number">0</span>;



        <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> Future&lt;?&gt; answer(InvocationOnMock invocation) {

            <span class="hljs-keyword">final</span> Object originalArgument = (invocation.getArguments())[<span class="hljs-number">3</span>];

            CronTask task = ((CronTask) originalArgument);

            Mockito.doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Future&lt;?&gt;&gt;() {



                <span class="hljs-meta">@Override</span>

                <span class="hljs-function"><span class="hljs-keyword">public</span> Future&lt;Boolean&gt; <span class="hljs-title">answer</span><span class="hljs-params">(InvocationOnMock invocation)</span> <span class="hljs-keyword">throws</span> Exception </span>{

                    <span class="hljs-keyword">final</span> Object originalArgument = (invocation.getArguments())[<span class="hljs-number">0</span>];

                    ((Callable&lt;Boolean&gt;) originalArgument).call();

                    <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(Boolean.TRUE);

                }

            }).when(executor).submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

            cronTaskRunner.submit(() -&gt; {

                <span class="hljs-keyword">while</span> (scheduleCount &lt; <span class="hljs-number">2</span>) {

                    scheduleCount++;

                    task.run(<span class="hljs-number">123L</span>);

                }

                latch.countDown();

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

            });

            <span class="hljs-keyword">return</span> createDummyFuture();

        }

    }).when(cronScheduler).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Monitor monitor = Mockito.mock(Monitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(config.getEmissionDuration()).thenReturn(<span class="hljs-keyword">new</span> org.joda.time.Duration(<span class="hljs-number">1000L</span>));

    <span class="hljs-keyword">final</span> MonitorScheduler scheduler = <span class="hljs-keyword">new</span> ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">ImmutableList</span>.<span class="hljs-title">of</span>(<span class="hljs-title">monitor</span>), <span class="hljs-title">cronScheduler</span>, <span class="hljs-title">executor</span>)</span>;

    scheduler.start();

    latch.await(<span class="hljs-number">5</span>, TimeUnit.SECONDS);

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">1</span>)).start();

    Mockito.verify(cronScheduler, Mockito.times(<span class="hljs-number">1</span>)).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.verify(executor, Mockito.times(<span class="hljs-number">2</span>)).submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">2</span>)).monitor(ArgumentMatchers.any());

    scheduler.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ExecutorService executor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
executor;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest253">Test Case ID #druid_Test_25_3</h4>
<h4 id="test-case-name-teststartrepeatandstopschedulingfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidjavautilmetricsclockdriftsafemonitorschedulertestjava">Test Case Name: <code>testStart_RepeatAndStopScheduling</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\java\util\metrics\ClockDriftSafeMonitorSchedulerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-executor">Mock Object Variable Name: <code>executor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testStart_RepeatAndStopScheduling() throws InterruptedException {
<span class="hljs-deletion">-    ExecutorService executor = Mockito.mock(ExecutorService.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `executor`</span>
     CountDownLatch latch = new CountDownLatch(1);
     Mockito.doAnswer(new Answer&lt;Future&lt;?&gt;&gt;() {

         private int scheduleCount = 0;

         @SuppressWarnings("unchecked")
         @Override
         public Future&lt;?&gt; answer(InvocationOnMock invocation) {
             final Object originalArgument = (invocation.getArguments())[3];
             CronTask task = ((CronTask) originalArgument);
             Mockito.doAnswer(new Answer&lt;Future&lt;?&gt;&gt;() {

                 @Override
                 public Future&lt;Boolean&gt; answer(InvocationOnMock invocation) throws Exception {
                     final Object originalArgument = (invocation.getArguments())[0];
                     ((Callable&lt;Boolean&gt;) originalArgument).call();
                     return CompletableFuture.completedFuture(Boolean.FALSE);
                 }
             }).when(executor).submit(ArgumentMatchers.any(Callable.class));
             cronTaskRunner.submit(() -&gt; {
                 while (scheduleCount &lt; 2) {
                     scheduleCount++;
                     task.run(123L);
                 }
                 latch.countDown();
                 return null;
             });
             return createDummyFuture();
         }
     }).when(cronScheduler).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask.class));
     Monitor monitor = Mockito.mock(Monitor.class);
     DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig.class);
     Mockito.when(config.getEmissionDuration()).thenReturn(new org.joda.time.Duration(1000L));
     final MonitorScheduler scheduler = new ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter.class), ImmutableList.of(monitor), cronScheduler, executor);
     scheduler.start();
     latch.await(5, TimeUnit.SECONDS);
     Mockito.verify(monitor, Mockito.times(1)).start();
     Mockito.verify(cronScheduler, Mockito.times(1)).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask.class));
<span class="hljs-deletion">-    Mockito.verify(executor, Mockito.times(1)).submit(ArgumentMatchers.any(Callable.class));</span>
<span class="hljs-addition">+    Mockito.verify(executor, Mockito.times(1)).submit(ArgumentMatchers.any(Callable.class));</span>
     Mockito.verify(monitor, Mockito.times(2)).monitor(ArgumentMatchers.any());
     Mockito.verify(monitor, Mockito.times(1)).stop();
     scheduler.stop();
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStart_RepeatAndStopScheduling</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    ExecutorService executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    Mockito.doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Future&lt;?&gt;&gt;() {



        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> scheduleCount = <span class="hljs-number">0</span>;



        <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> Future&lt;?&gt; answer(InvocationOnMock invocation) {

            <span class="hljs-keyword">final</span> Object originalArgument = (invocation.getArguments())[<span class="hljs-number">3</span>];

            CronTask task = ((CronTask) originalArgument);

            Mockito.doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Future&lt;?&gt;&gt;() {



                <span class="hljs-meta">@Override</span>

                <span class="hljs-function"><span class="hljs-keyword">public</span> Future&lt;Boolean&gt; <span class="hljs-title">answer</span><span class="hljs-params">(InvocationOnMock invocation)</span> <span class="hljs-keyword">throws</span> Exception </span>{

                    <span class="hljs-keyword">final</span> Object originalArgument = (invocation.getArguments())[<span class="hljs-number">0</span>];

                    ((Callable&lt;Boolean&gt;) originalArgument).call();

                    <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(Boolean.FALSE);

                }

            }).when(executor).submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

            cronTaskRunner.submit(() -&gt; {

                <span class="hljs-keyword">while</span> (scheduleCount &lt; <span class="hljs-number">2</span>) {

                    scheduleCount++;

                    task.run(<span class="hljs-number">123L</span>);

                }

                latch.countDown();

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

            });

            <span class="hljs-keyword">return</span> createDummyFuture();

        }

    }).when(cronScheduler).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Monitor monitor = Mockito.mock(Monitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(config.getEmissionDuration()).thenReturn(<span class="hljs-keyword">new</span> org.joda.time.Duration(<span class="hljs-number">1000L</span>));

    <span class="hljs-keyword">final</span> MonitorScheduler scheduler = <span class="hljs-keyword">new</span> ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">ImmutableList</span>.<span class="hljs-title">of</span>(<span class="hljs-title">monitor</span>), <span class="hljs-title">cronScheduler</span>, <span class="hljs-title">executor</span>)</span>;

    scheduler.start();

    latch.await(<span class="hljs-number">5</span>, TimeUnit.SECONDS);

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">1</span>)).start();

    Mockito.verify(cronScheduler, Mockito.times(<span class="hljs-number">1</span>)).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.verify(executor, Mockito.times(<span class="hljs-number">1</span>)).submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">2</span>)).monitor(ArgumentMatchers.any());

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">1</span>)).stop();

    scheduler.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ExecutorService executor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
executor;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest254">Test Case ID #druid_Test_25_4</h4>
<h4 id="test-case-name-teststartunexpectedexceptionwhilemonitoringfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidjavautilmetricsclockdriftsafemonitorschedulertestjava">Test Case Name: <code>testStart_UnexpectedExceptionWhileMonitoring</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\java\util\metrics\ClockDriftSafeMonitorSchedulerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-executor">Mock Object Variable Name: <code>executor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testStart_UnexpectedExceptionWhileMonitoring() throws InterruptedException {
<span class="hljs-deletion">-    ExecutorService executor = Mockito.mock(ExecutorService.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `executor`</span>
     Monitor monitor = Mockito.mock(Monitor.class);
     Mockito.when(monitor.monitor(ArgumentMatchers.any(ServiceEmitter.class))).thenThrow(new RuntimeException("Test throwing exception while monitoring"));
     DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig.class);
     Mockito.when(config.getEmissionDuration()).thenReturn(new org.joda.time.Duration(1000L));
     CountDownLatch latch = new CountDownLatch(1);
     AtomicBoolean monitorResultHolder = new AtomicBoolean(false);
     Mockito.doAnswer(new Answer&lt;Future&lt;?&gt;&gt;() {

         @SuppressWarnings("unchecked")
         @Override
         public Future&lt;?&gt; answer(InvocationOnMock invocation) {
             final Object originalArgument = (invocation.getArguments())[3];
             CronTask task = ((CronTask) originalArgument);
             Mockito.doAnswer(new Answer&lt;Future&lt;?&gt;&gt;() {

                 @Override
                 public Future&lt;Boolean&gt; answer(InvocationOnMock invocation) throws Exception {
                     final Object originalArgument = (invocation.getArguments())[0];
                     final boolean continueMonitor = ((Callable&lt;Boolean&gt;) originalArgument).call();
                     monitorResultHolder.set(continueMonitor);
                     return CompletableFuture.completedFuture(continueMonitor);
                 }
             }).when(executor).submit(ArgumentMatchers.any(Callable.class));
             cronTaskRunner.submit(() -&gt; {
                 task.run(123L);
                 latch.countDown();
                 return null;
             });
             return createDummyFuture();
         }
     }).when(cronScheduler).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask.class));
     final MonitorScheduler scheduler = new ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter.class), ImmutableList.of(monitor), cronScheduler, executor);
     scheduler.start();
     latch.await(5, TimeUnit.SECONDS);
     Mockito.verify(monitor, Mockito.times(1)).start();
     Mockito.verify(cronScheduler, Mockito.times(1)).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask.class));
<span class="hljs-deletion">-    Mockito.verify(executor, Mockito.times(1)).submit(ArgumentMatchers.any(Callable.class));</span>
<span class="hljs-addition">+    Mockito.verify(executor, Mockito.times(1)).submit(ArgumentMatchers.any(Callable.class));</span>
     Mockito.verify(monitor, Mockito.times(1)).monitor(ArgumentMatchers.any());
     Assert.assertTrue(monitorResultHolder.get());
     scheduler.stop();
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStart_UnexpectedExceptionWhileMonitoring</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    ExecutorService executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Monitor monitor = Mockito.mock(Monitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(monitor.monitor(ArgumentMatchers.any(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenThrow</span>(<span class="hljs-title">new</span> <span class="hljs-title">RuntimeException</span>("<span class="hljs-title">Test</span> <span class="hljs-title">throwing</span> <span class="hljs-title">exception</span> <span class="hljs-title">while</span> <span class="hljs-title">monitoring</span>"))</span>;

    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(config.getEmissionDuration()).thenReturn(<span class="hljs-keyword">new</span> org.joda.time.Duration(<span class="hljs-number">1000L</span>));

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    AtomicBoolean monitorResultHolder = <span class="hljs-keyword">new</span> AtomicBoolean(<span class="hljs-keyword">false</span>);

    Mockito.doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Future&lt;?&gt;&gt;() {



        <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> Future&lt;?&gt; answer(InvocationOnMock invocation) {

            <span class="hljs-keyword">final</span> Object originalArgument = (invocation.getArguments())[<span class="hljs-number">3</span>];

            CronTask task = ((CronTask) originalArgument);

            Mockito.doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Future&lt;?&gt;&gt;() {



                <span class="hljs-meta">@Override</span>

                <span class="hljs-function"><span class="hljs-keyword">public</span> Future&lt;Boolean&gt; <span class="hljs-title">answer</span><span class="hljs-params">(InvocationOnMock invocation)</span> <span class="hljs-keyword">throws</span> Exception </span>{

                    <span class="hljs-keyword">final</span> Object originalArgument = (invocation.getArguments())[<span class="hljs-number">0</span>];

                    <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> continueMonitor = ((Callable&lt;Boolean&gt;) originalArgument).call();

                    monitorResultHolder.set(continueMonitor);

                    <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(continueMonitor);

                }

            }).when(executor).submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

            cronTaskRunner.submit(() -&gt; {

                task.run(<span class="hljs-number">123L</span>);

                latch.countDown();

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

            });

            <span class="hljs-keyword">return</span> createDummyFuture();

        }

    }).when(cronScheduler).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">final</span> MonitorScheduler scheduler = <span class="hljs-keyword">new</span> ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">ImmutableList</span>.<span class="hljs-title">of</span>(<span class="hljs-title">monitor</span>), <span class="hljs-title">cronScheduler</span>, <span class="hljs-title">executor</span>)</span>;

    scheduler.start();

    latch.await(<span class="hljs-number">5</span>, TimeUnit.SECONDS);

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">1</span>)).start();

    Mockito.verify(cronScheduler, Mockito.times(<span class="hljs-number">1</span>)).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.verify(executor, Mockito.times(<span class="hljs-number">1</span>)).submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">1</span>)).monitor(ArgumentMatchers.any());

    Assert.assertTrue(monitorResultHolder.get());

    scheduler.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ExecutorService executor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
executor;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest255">Test Case ID #druid_Test_25_5</h4>
<h4 id="test-case-name-teststartunexpectedexceptionwhileschedulingfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidjavautilmetricsclockdriftsafemonitorschedulertestjava">Test Case Name: <code>testStart_UnexpectedExceptionWhileScheduling</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\java\util\metrics\ClockDriftSafeMonitorSchedulerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-executor">Mock Object Variable Name: <code>executor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testStart_UnexpectedExceptionWhileScheduling() throws InterruptedException {
<span class="hljs-deletion">-    ExecutorService executor = Mockito.mock(ExecutorService.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `executor`</span>
     Monitor monitor = Mockito.mock(Monitor.class);
     DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig.class);
     Mockito.when(config.getEmissionDuration()).thenReturn(new org.joda.time.Duration(1000L));
     CountDownLatch latch = new CountDownLatch(1);
     Mockito.doAnswer(new Answer&lt;Future&lt;?&gt;&gt;() {

         @SuppressWarnings("unchecked")
         @Override
         public Future&lt;?&gt; answer(InvocationOnMock invocation) {
             final Object originalArgument = (invocation.getArguments())[3];
             CronTask task = ((CronTask) originalArgument);
<span class="hljs-deletion">-            Mockito.when(executor.submit(ArgumentMatchers.any(Callable.class))).thenThrow(new RuntimeException("Test throwing exception while scheduling"));</span>
<span class="hljs-addition">+            Mockito.when(executor.submit(ArgumentMatchers.any(Callable.class))).thenThrow(new RuntimeException("Test throwing exception while scheduling"));</span>
             cronTaskRunner.submit(() -&gt; {
                 task.run(123L);
                 latch.countDown();
                 return null;
             });
             return createDummyFuture();
         }
     }).when(cronScheduler).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask.class));
     final MonitorScheduler scheduler = new ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter.class), ImmutableList.of(monitor), cronScheduler, executor);
     scheduler.start();
     latch.await(5, TimeUnit.SECONDS);
     Mockito.verify(monitor, Mockito.times(1)).start();
     Mockito.verify(cronScheduler, Mockito.times(1)).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask.class));
<span class="hljs-deletion">-    Mockito.verify(executor, Mockito.times(1)).submit(ArgumentMatchers.any(Callable.class));</span>
<span class="hljs-addition">+    Mockito.verify(executor, Mockito.times(1)).submit(ArgumentMatchers.any(Callable.class));</span>
     scheduler.stop();
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStart_UnexpectedExceptionWhileScheduling</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    ExecutorService executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Monitor monitor = Mockito.mock(Monitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(config.getEmissionDuration()).thenReturn(<span class="hljs-keyword">new</span> org.joda.time.Duration(<span class="hljs-number">1000L</span>));

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    Mockito.doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Future&lt;?&gt;&gt;() {



        <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> Future&lt;?&gt; answer(InvocationOnMock invocation) {

            <span class="hljs-keyword">final</span> Object originalArgument = (invocation.getArguments())[<span class="hljs-number">3</span>];

            CronTask task = ((CronTask) originalArgument);

            Mockito.when(executor.submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenThrow</span>(<span class="hljs-title">new</span> <span class="hljs-title">RuntimeException</span>("<span class="hljs-title">Test</span> <span class="hljs-title">throwing</span> <span class="hljs-title">exception</span> <span class="hljs-title">while</span> <span class="hljs-title">scheduling</span>"))</span>;

            cronTaskRunner.submit(() -&gt; {

                task.run(<span class="hljs-number">123L</span>);

                latch.countDown();

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

            });

            <span class="hljs-keyword">return</span> createDummyFuture();

        }

    }).when(cronScheduler).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">final</span> MonitorScheduler scheduler = <span class="hljs-keyword">new</span> ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">ImmutableList</span>.<span class="hljs-title">of</span>(<span class="hljs-title">monitor</span>), <span class="hljs-title">cronScheduler</span>, <span class="hljs-title">executor</span>)</span>;

    scheduler.start();

    latch.await(<span class="hljs-number">5</span>, TimeUnit.SECONDS);

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">1</span>)).start();

    Mockito.verify(cronScheduler, Mockito.times(<span class="hljs-number">1</span>)).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.verify(executor, Mockito.times(<span class="hljs-number">1</span>)).submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    scheduler.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ExecutorService executor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
executor;

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci26">Mock Clone Instance #druid_MCI_26</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.indexer.HadoopDruidIndexerConfig</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HadoopDruidIndexerConfig <span class="hljs-title">createMockHadoopDruidIndexerConfig</span><span class="hljs-params">(Set&lt;Interval&gt; segmentGranularIntervals)</span> </span>{
    HadoopDruidIndexerConfig config = Mockito.mock(HadoopDruidIndexerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.doNothing().when(config).setShardSpecs(Mockito.anyMap());
    Mockito.when(config.getSegmentGranularIntervals()).thenReturn(segmentGranularIntervals);
    Mockito.when(config.isDeterminingPartitions()).thenReturn(<span class="hljs-keyword">false</span>);
    <span class="hljs-keyword">return</span> config;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest261">Test Case ID #druid_Test_26_1</h4>
<h4 id="test-case-name-testrunwithhashedpartitionsspeccreatehashbasednumberedshardspecwithhashpartitionfunctionfile-cjavaprojectsapachedruidindexing-hadoopsrctestjavaorgapachedruidindexerhadoopdruiddetermineconfigurationjobtestjava">Test Case Name: <code>testRunWithHashedPartitionsSpecCreateHashBasedNumberedShardSpecWithHashPartitionFunction</code>(File: <code>C:\Java_projects\Apache\druid\indexing-hadoop\src\test\java\org\apache\druid\indexer\HadoopDruidDetermineConfigurationJobTest.java</code>)</h4>
<h4 id="mock-object-variable-name-config">Mock Object Variable Name: <code>config</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final Set&lt;Interval&gt; intervals = ImmutableSet.of(Intervals.of("2020-01-01/P1D"), Intervals.of("2020-01-02/P1D"), Intervals.of("2020-01-03/P1D"));
    final HashedPartitionsSpec partitionsSpec = new HashedPartitionsSpec(null, 2, null, HashPartitionFunction.MURMUR3_32_ABS, null, null);
<span class="hljs-deletion">-    final HadoopDruidIndexerConfig config = Mockito.mock(HadoopDruidIndexerConfig.class);</span>
<span class="hljs-deletion">-    Mockito.when(config.isDeterminingPartitions()).thenReturn(false);</span>
<span class="hljs-deletion">-    Mockito.when(config.getPartitionsSpec()).thenReturn(partitionsSpec);</span>
<span class="hljs-deletion">-    Mockito.when(config.getSegmentGranularIntervals()).thenReturn(intervals);</span>
    final ArgumentCaptor&lt;Map&lt;Long, List&lt;HadoopyShardSpec&gt;&gt;&gt; resultCaptor = ArgumentCaptor.forClass(Map.class);
<span class="hljs-deletion">-    Mockito.doNothing().when(config).setShardSpecs(resultCaptor.capture());</span>
<span class="hljs-addition">+    final HadoopDruidIndexerConfig config = createMockHadoopDruidIndexerConfig(intervals);</span>
<span class="hljs-addition">+    Mockito.when(config.getPartitionsSpec()).thenReturn(partitionsSpec);</span>
<span class="hljs-addition">+    Mockito.doNothing().when(config).setShardSpecs(resultCaptor.capture());</span>
    final HadoopDruidDetermineConfigurationJob job = new HadoopDruidDetermineConfigurationJob(config);
    Assert.assertTrue(job.run());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRunWithHashedPartitionsSpecCreateHashBasedNumberedShardSpecWithHashPartitionFunction</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> Set&lt;Interval&gt; intervals = ImmutableSet.of(Intervals.of(<span class="hljs-string">"2020-01-01/P1D"</span>), Intervals.of(<span class="hljs-string">"2020-01-02/P1D"</span>), Intervals.of(<span class="hljs-string">"2020-01-03/P1D"</span>));

    <span class="hljs-keyword">final</span> HashedPartitionsSpec partitionsSpec = <span class="hljs-keyword">new</span> HashedPartitionsSpec(<span class="hljs-keyword">null</span>, <span class="hljs-number">2</span>, <span class="hljs-keyword">null</span>, HashPartitionFunction.MURMUR3_32_ABS, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);

    <span class="hljs-keyword">final</span> HadoopDruidIndexerConfig config = Mockito.mock(HadoopDruidIndexerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(config.isDeterminingPartitions()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(config.getPartitionsSpec()).thenReturn(partitionsSpec);

    Mockito.when(config.getSegmentGranularIntervals()).thenReturn(intervals);

    <span class="hljs-keyword">final</span> ArgumentCaptor&lt;Map&lt;Long, List&lt;HadoopyShardSpec&gt;&gt;&gt; resultCaptor = ArgumentCaptor.forClass(Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.doNothing().when(config).setShardSpecs(resultCaptor.capture());

    <span class="hljs-keyword">final</span> HadoopDruidDetermineConfigurationJob job = <span class="hljs-keyword">new</span> HadoopDruidDetermineConfigurationJob(config);

    Assert.assertTrue(job.run());

    <span class="hljs-keyword">final</span> Map&lt;Long, List&lt;HadoopyShardSpec&gt;&gt; shardSpecs = resultCaptor.getValue();

    Assert.assertEquals(<span class="hljs-number">3</span>, shardSpecs.size());

    <span class="hljs-keyword">for</span> (Interval interval : intervals) {

        <span class="hljs-keyword">final</span> List&lt;HadoopyShardSpec&gt; shardSpecsPerInterval = shardSpecs.get(interval.getStartMillis());

        Assert.assertEquals(<span class="hljs-number">2</span>, shardSpecsPerInterval.size());

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; shardSpecsPerInterval.size(); i++) {

            Assert.assertEquals(<span class="hljs-keyword">new</span> HashBasedNumberedShardSpec(i, shardSpecsPerInterval.size(), i, shardSpecsPerInterval.size(), <span class="hljs-keyword">null</span>, HashPartitionFunction.MURMUR3_32_ABS, <span class="hljs-keyword">new</span> ObjectMapper()), shardSpecsPerInterval.get(i).getActualSpec());

        }

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HadoopDruidIndexerConfig <span class="hljs-title">createMockHadoopDruidIndexerConfig</span><span class="hljs-params">(Set&lt;Interval&gt; segmentGranularIntervals)</span> </span>{
    HadoopDruidIndexerConfig config = Mockito.mock(HadoopDruidIndexerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.doNothing().when(config).setShardSpecs(Mockito.anyMap());
    Mockito.when(config.getSegmentGranularIntervals()).thenReturn(segmentGranularIntervals);
    Mockito.when(config.isDeterminingPartitions()).thenReturn(<span class="hljs-keyword">false</span>);
    <span class="hljs-keyword">return</span> config;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest262">Test Case ID #druid_Test_26_2</h4>
<h4 id="test-case-name-testrunwithsingledimensionpartitionsspeccreatehashbasednumberedshardspecwithouthashpartitionfunctionfile-cjavaprojectsapachedruidindexing-hadoopsrctestjavaorgapachedruidindexerhadoopdruiddetermineconfigurationjobtestjava">Test Case Name: <code>testRunWithSingleDimensionPartitionsSpecCreateHashBasedNumberedShardSpecWithoutHashPartitionFunction</code>(File: <code>C:\Java_projects\Apache\druid\indexing-hadoop\src\test\java\org\apache\druid\indexer\HadoopDruidDetermineConfigurationJobTest.java</code>)</h4>
<h4 id="mock-object-variable-name-config">Mock Object Variable Name: <code>config</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final Set&lt;Interval&gt; intervals = ImmutableSet.of(Intervals.of("2020-01-01/P1D"), Intervals.of("2020-01-02/P1D"), Intervals.of("2020-01-03/P1D"));
    final SingleDimensionPartitionsSpec partitionsSpec = new SingleDimensionPartitionsSpec(1000, null, "dim", false);
<span class="hljs-deletion">-    final HadoopDruidIndexerConfig config = Mockito.mock(HadoopDruidIndexerConfig.class);</span>
<span class="hljs-deletion">-    Mockito.when(config.isDeterminingPartitions()).thenReturn(false);</span>
<span class="hljs-deletion">-    Mockito.when(config.getPartitionsSpec()).thenReturn(partitionsSpec);</span>
<span class="hljs-deletion">-    Mockito.when(config.getSegmentGranularIntervals()).thenReturn(intervals);</span>
<span class="hljs-addition">+    final HadoopDruidIndexerConfig config = createMockHadoopDruidIndexerConfig(intervals);</span>
<span class="hljs-addition">+    Mockito.when(config.getPartitionsSpec()).thenReturn(partitionsSpec);</span>
    final ArgumentCaptor&lt;Map&lt;Long, List&lt;HadoopyShardSpec&gt;&gt;&gt; resultCaptor = ArgumentCaptor.forClass(Map.class);
<span class="hljs-deletion">-    Mockito.doNothing().when(config).setShardSpecs(resultCaptor.capture());</span>
<span class="hljs-addition">+    Mockito.doNothing().when(config).setShardSpecs(resultCaptor.capture());</span>
    final HadoopDruidDetermineConfigurationJob job = new HadoopDruidDetermineConfigurationJob(config);
    Assert.assertTrue(job.run());
    final Map&lt;Long, List&lt;HadoopyShardSpec&gt;&gt; shardSpecs = resultCaptor.getValue();
    Assert.assertEquals(3, shardSpecs.size());
    for (Interval interval : intervals) {
        final List&lt;HadoopyShardSpec&gt; shardSpecsPerInterval = shardSpecs.get(interval.getStartMillis());
        Assert.assertEquals(1, shardSpecsPerInterval.size());
        Assert.assertEquals(new HashBasedNumberedShardSpec(0, shardSpecsPerInterval.size(), 0, shardSpecsPerInterval.size(), ImmutableList.of("dim"), null, new ObjectMapper()), shardSpecsPerInterval.get(0).getActualSpec());
    }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRunWithSingleDimensionPartitionsSpecCreateHashBasedNumberedShardSpecWithoutHashPartitionFunction</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> Set&lt;Interval&gt; intervals = ImmutableSet.of(Intervals.of(<span class="hljs-string">"2020-01-01/P1D"</span>), Intervals.of(<span class="hljs-string">"2020-01-02/P1D"</span>), Intervals.of(<span class="hljs-string">"2020-01-03/P1D"</span>));

    <span class="hljs-keyword">final</span> SingleDimensionPartitionsSpec partitionsSpec = <span class="hljs-keyword">new</span> SingleDimensionPartitionsSpec(<span class="hljs-number">1000</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"dim"</span>, <span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">final</span> HadoopDruidIndexerConfig config = Mockito.mock(HadoopDruidIndexerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(config.isDeterminingPartitions()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(config.getPartitionsSpec()).thenReturn(partitionsSpec);

    Mockito.when(config.getSegmentGranularIntervals()).thenReturn(intervals);

    <span class="hljs-keyword">final</span> ArgumentCaptor&lt;Map&lt;Long, List&lt;HadoopyShardSpec&gt;&gt;&gt; resultCaptor = ArgumentCaptor.forClass(Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.doNothing().when(config).setShardSpecs(resultCaptor.capture());

    <span class="hljs-keyword">final</span> HadoopDruidDetermineConfigurationJob job = <span class="hljs-keyword">new</span> HadoopDruidDetermineConfigurationJob(config);

    Assert.assertTrue(job.run());

    <span class="hljs-keyword">final</span> Map&lt;Long, List&lt;HadoopyShardSpec&gt;&gt; shardSpecs = resultCaptor.getValue();

    Assert.assertEquals(<span class="hljs-number">3</span>, shardSpecs.size());

    <span class="hljs-keyword">for</span> (Interval interval : intervals) {

        <span class="hljs-keyword">final</span> List&lt;HadoopyShardSpec&gt; shardSpecsPerInterval = shardSpecs.get(interval.getStartMillis());

        Assert.assertEquals(<span class="hljs-number">1</span>, shardSpecsPerInterval.size());

        Assert.assertEquals(<span class="hljs-keyword">new</span> HashBasedNumberedShardSpec(<span class="hljs-number">0</span>, shardSpecsPerInterval.size(), <span class="hljs-number">0</span>, shardSpecsPerInterval.size(), ImmutableList.of(<span class="hljs-string">"dim"</span>), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> ObjectMapper()), shardSpecsPerInterval.get(<span class="hljs-number">0</span>).getActualSpec());

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HadoopDruidIndexerConfig <span class="hljs-title">createMockHadoopDruidIndexerConfig</span><span class="hljs-params">(Set&lt;Interval&gt; segmentGranularIntervals)</span> </span>{
    HadoopDruidIndexerConfig config = Mockito.mock(HadoopDruidIndexerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.doNothing().when(config).setShardSpecs(Mockito.anyMap());
    Mockito.when(config.getSegmentGranularIntervals()).thenReturn(segmentGranularIntervals);
    Mockito.when(config.isDeterminingPartitions()).thenReturn(<span class="hljs-keyword">false</span>);
    <span class="hljs-keyword">return</span> config;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci27">Mock Clone Instance #druid_MCI_27</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.server.initialization.ServerConfig</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ServerConfig <span class="hljs-title">createMockServerConfig</span><span class="hljs-params">(AllowedRegexErrorResponseTransformStrategy errorResponseTransformStrategy)</span> </span>{
    ServerConfig serverConfig = Mockito.mock(ServerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(serverConfig.getErrorResponseTransformStrategy()).thenReturn(errorResponseTransformStrategy);
    <span class="hljs-keyword">return</span> serverConfig;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest271">Test Case ID #druid_Test_27_1</h4>
<h4 id="test-case-name-testerrorhandlersanitizeserrorasexpectedfile-cjavaprojectsapachedruidsqlsrctestjavaorgapachedruidsqlavaticaerrorhandlertestjava">Test Case Name: <code>testErrorHandlerSanitizesErrorAsExpected</code>(File: <code>C:\Java_projects\Apache\druid\sql\src\test\java\org\apache\druid\sql\avatica\ErrorHandlerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-serverconfig">Mock Object Variable Name: <code>serverConfig</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testErrorHandlerSanitizesErrorAsExpected() {
<span class="hljs-deletion">-    ServerConfig serverConfig = Mockito.mock(ServerConfig.class);</span>
    AllowedRegexErrorResponseTransformStrategy emptyAllowedRegexErrorResponseTransformStrategy = new AllowedRegexErrorResponseTransformStrategy(ImmutableList.of());
<span class="hljs-deletion">-    Mockito.when(serverConfig.getErrorResponseTransformStrategy()).thenReturn(emptyAllowedRegexErrorResponseTransformStrategy);</span>
<span class="hljs-addition">+    ServerConfig serverConfig = createMockServerConfig(emptyAllowedRegexErrorResponseTransformStrategy);</span>
    ErrorHandler errorHandler = new ErrorHandler(serverConfig);
    QueryException input = new QueryException("error", "error message", "error class", "host");
    RuntimeException output = errorHandler.sanitize(input);
    Assert.assertNull(output.getMessage());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testErrorHandlerSanitizesErrorAsExpected</span><span class="hljs-params">()</span> </span>{

    ServerConfig serverConfig = Mockito.mock(ServerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AllowedRegexErrorResponseTransformStrategy emptyAllowedRegexErrorResponseTransformStrategy = <span class="hljs-keyword">new</span> AllowedRegexErrorResponseTransformStrategy(ImmutableList.of());

    Mockito.when(serverConfig.getErrorResponseTransformStrategy()).thenReturn(emptyAllowedRegexErrorResponseTransformStrategy);

    ErrorHandler errorHandler = <span class="hljs-keyword">new</span> ErrorHandler(serverConfig);

    QueryException input = <span class="hljs-keyword">new</span> QueryException(<span class="hljs-string">"error"</span>, <span class="hljs-string">"error message"</span>, <span class="hljs-string">"error class"</span>, <span class="hljs-string">"host"</span>);

    RuntimeException output = errorHandler.sanitize(input);

    Assert.assertNull(output.getMessage());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ServerConfig <span class="hljs-title">createMockServerConfig</span><span class="hljs-params">(AllowedRegexErrorResponseTransformStrategy errorResponseTransformStrategy)</span> </span>{
    ServerConfig serverConfig = Mockito.mock(ServerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(serverConfig.getErrorResponseTransformStrategy()).thenReturn(errorResponseTransformStrategy);
    <span class="hljs-keyword">return</span> serverConfig;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest272">Test Case ID #druid_Test_27_2</h4>
<h4 id="test-case-name-testerrorhandlerhasaffectingerrorresponsetransformstrategyreturnstruewhennotusingnoerrorresponsetransformstrategyfile-cjavaprojectsapachedruidsqlsrctestjavaorgapachedruidsqlavaticaerrorhandlertestjava">Test Case Name: <code>testErrorHandlerHasAffectingErrorResponseTransformStrategyReturnsTrueWhenNotUsingNoErrorResponseTransformStrategy</code>(File: <code>C:\Java_projects\Apache\druid\sql\src\test\java\org\apache\druid\sql\avatica\ErrorHandlerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-serverconfig">Mock Object Variable Name: <code>serverConfig</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testErrorHandlerHasAffectingErrorResponseTransformStrategyReturnsTrueWhenNotUsingNoErrorResponseTransformStrategy() {
<span class="hljs-deletion">-    ServerConfig serverConfig = Mockito.mock(ServerConfig.class);</span>
     AllowedRegexErrorResponseTransformStrategy emptyAllowedRegexErrorResponseTransformStrategy = new AllowedRegexErrorResponseTransformStrategy(ImmutableList.of());
<span class="hljs-deletion">-    Mockito.when(serverConfig.getErrorResponseTransformStrategy()).thenReturn(emptyAllowedRegexErrorResponseTransformStrategy);</span>
<span class="hljs-addition">+    ServerConfig serverConfig = createMockServerConfig(emptyAllowedRegexErrorResponseTransformStrategy);</span>
     ErrorHandler errorHandler = new ErrorHandler(serverConfig);
     Assert.assertTrue(errorHandler.hasAffectingErrorResponseTransformStrategy());
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testErrorHandlerHasAffectingErrorResponseTransformStrategyReturnsTrueWhenNotUsingNoErrorResponseTransformStrategy</span><span class="hljs-params">()</span> </span>{

    ServerConfig serverConfig = Mockito.mock(ServerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AllowedRegexErrorResponseTransformStrategy emptyAllowedRegexErrorResponseTransformStrategy = <span class="hljs-keyword">new</span> AllowedRegexErrorResponseTransformStrategy(ImmutableList.of());

    Mockito.when(serverConfig.getErrorResponseTransformStrategy()).thenReturn(emptyAllowedRegexErrorResponseTransformStrategy);

    ErrorHandler errorHandler = <span class="hljs-keyword">new</span> ErrorHandler(serverConfig);

    Assert.assertTrue(errorHandler.hasAffectingErrorResponseTransformStrategy());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ServerConfig <span class="hljs-title">createMockServerConfig</span><span class="hljs-params">(AllowedRegexErrorResponseTransformStrategy errorResponseTransformStrategy)</span> </span>{
    ServerConfig serverConfig = Mockito.mock(ServerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(serverConfig.getErrorResponseTransformStrategy()).thenReturn(errorResponseTransformStrategy);
    <span class="hljs-keyword">return</span> serverConfig;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest273">Test Case ID #druid_Test_27_3</h4>
<h4 id="test-case-name-testerrorhandlerhandlesnonsanitizableexceptioncorrectlyfile-cjavaprojectsapachedruidsqlsrctestjavaorgapachedruidsqlavaticaerrorhandlertestjava">Test Case Name: <code>testErrorHandlerHandlesNonSanitizableExceptionCorrectly</code>(File: <code>C:\Java_projects\Apache\druid\sql\src\test\java\org\apache\druid\sql\avatica\ErrorHandlerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-serverconfig">Mock Object Variable Name: <code>serverConfig</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testErrorHandlerHandlesNonSanitizableExceptionCorrectly() {
<span class="hljs-deletion">-    ServerConfig serverConfig = Mockito.mock(ServerConfig.class);</span>
     AllowedRegexErrorResponseTransformStrategy emptyAllowedRegexErrorResponseTransformStrategy = new AllowedRegexErrorResponseTransformStrategy(ImmutableList.of());
<span class="hljs-deletion">-    Mockito.when(serverConfig.getErrorResponseTransformStrategy()).thenReturn(emptyAllowedRegexErrorResponseTransformStrategy);</span>
<span class="hljs-addition">+    ServerConfig serverConfig = createMockServerConfig(emptyAllowedRegexErrorResponseTransformStrategy);</span>
     ErrorHandler errorHandler = new ErrorHandler(serverConfig);
     Exception input = new Exception("message");
     RuntimeException output = errorHandler.sanitize(input);
     Assert.assertEquals(null, output.getMessage());
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testErrorHandlerHandlesNonSanitizableExceptionCorrectly</span><span class="hljs-params">()</span> </span>{

    ServerConfig serverConfig = Mockito.mock(ServerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AllowedRegexErrorResponseTransformStrategy emptyAllowedRegexErrorResponseTransformStrategy = <span class="hljs-keyword">new</span> AllowedRegexErrorResponseTransformStrategy(ImmutableList.of());

    Mockito.when(serverConfig.getErrorResponseTransformStrategy()).thenReturn(emptyAllowedRegexErrorResponseTransformStrategy);

    ErrorHandler errorHandler = <span class="hljs-keyword">new</span> ErrorHandler(serverConfig);

    Exception input = <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"message"</span>);

    RuntimeException output = errorHandler.sanitize(input);

    Assert.assertEquals(<span class="hljs-keyword">null</span>, output.getMessage());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ServerConfig <span class="hljs-title">createMockServerConfig</span><span class="hljs-params">(AllowedRegexErrorResponseTransformStrategy errorResponseTransformStrategy)</span> </span>{
    ServerConfig serverConfig = Mockito.mock(ServerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(serverConfig.getErrorResponseTransformStrategy()).thenReturn(errorResponseTransformStrategy);
    <span class="hljs-keyword">return</span> serverConfig;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci28">Mock Clone Instance #druid_MCI_28</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.sql.calcite.planner.DruidOperatorTable</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DruidOperatorTable <span class="hljs-title">createMockDruidOperatorTable</span><span class="hljs-params">(List&lt;SqlOperator&gt; operatorList)</span> </span>{
    DruidOperatorTable mockOperatorTable = Mockito.mock(DruidOperatorTable<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(mockOperatorTable.getOperatorList()).thenReturn(operatorList);
    <span class="hljs-keyword">return</span> mockOperatorTable;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest281">Test Case ID #druid_Test_28_1</h4>
<h4 id="test-case-name-testscanroutinestablewithcustomoperatorsfile-cjavaprojectsapachedruidsqlsrctestjavaorgapachedruidsqlcalciteschemainformationschematestjava">Test Case Name: <code>testScanRoutinesTableWithCustomOperators</code>(File: <code>C:\Java_projects\Apache\druid\sql\src\test\java\org\apache\druid\sql\calcite\schema\InformationSchemaTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockoperatortable">Mock Object Variable Name: <code>mockOperatorTable</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final List&lt;SqlOperator&gt; sqlOperators = sqlOperatorConversions.stream().map(SqlOperatorConversion::calciteOperator).collect(Collectors.toList());
<span class="hljs-deletion">-    DruidOperatorTable mockOperatorTable = Mockito.mock(DruidOperatorTable.class);</span>
<span class="hljs-deletion">-    Mockito.when(mockOperatorTable.getOperatorList()).thenReturn(sqlOperators);</span>
<span class="hljs-addition">+    DruidOperatorTable mockOperatorTable = createMockDruidOperatorTable(sqlOperators);</span>
    InformationSchema.RoutinesTable routinesTable = new InformationSchema.RoutinesTable(mockOperatorTable);
    DataContext dataContext = createDataContext();
    List&lt;Object[]&gt; rows = routinesTable.scan(dataContext).toList();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testScanRoutinesTableWithCustomOperators</span><span class="hljs-params">()</span> </span>{

    Set&lt;SqlOperatorConversion&gt; sqlOperatorConversions = customOperatorsToOperatorConversions();

    <span class="hljs-keyword">final</span> List&lt;SqlOperator&gt; sqlOperators = sqlOperatorConversions.stream().map(SqlOperatorConversion::calciteOperator).collect(Collectors.toList());

    DruidOperatorTable mockOperatorTable = Mockito.mock(DruidOperatorTable<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(mockOperatorTable.getOperatorList()).thenReturn(sqlOperators);

    InformationSchema.RoutinesTable routinesTable = <span class="hljs-keyword">new</span> InformationSchema.RoutinesTable(mockOperatorTable);

    DataContext dataContext = createDataContext();

    List&lt;Object[]&gt; rows = routinesTable.scan(dataContext).toList();

    Assert.assertNotNull(rows);

    Assert.assertEquals(<span class="hljs-string">"There should be exactly 2 rows; any non-function syntax operator should get filtered out"</span>, <span class="hljs-number">2</span>, rows.size());

    Object[] expectedRow1 = { <span class="hljs-string">"druid"</span>, <span class="hljs-string">"INFORMATION_SCHEMA"</span>, <span class="hljs-string">"FOO"</span>, <span class="hljs-string">"FUNCTION"</span>, <span class="hljs-string">"NO"</span>, <span class="hljs-string">"'FOO([&lt;ANY&gt;])'"</span> };

    Assert.assertTrue(rows.stream().anyMatch(row -&gt; Arrays.equals(row, expectedRow1)));

    Object[] expectedRow2 = { <span class="hljs-string">"druid"</span>, <span class="hljs-string">"INFORMATION_SCHEMA"</span>, <span class="hljs-string">"BAR"</span>, <span class="hljs-string">"FUNCTION"</span>, <span class="hljs-string">"NO"</span>, <span class="hljs-string">"'BAR(&lt;INTEGER&gt;, &lt;INTEGER&gt;)'"</span> };

    Assert.assertTrue(rows.stream().anyMatch(row -&gt; Arrays.equals(row, expectedRow2)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DruidOperatorTable <span class="hljs-title">createMockDruidOperatorTable</span><span class="hljs-params">(List&lt;SqlOperator&gt; operatorList)</span> </span>{
    DruidOperatorTable mockOperatorTable = Mockito.mock(DruidOperatorTable<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(mockOperatorTable.getOperatorList()).thenReturn(operatorList);
    <span class="hljs-keyword">return</span> mockOperatorTable;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest282">Test Case ID #druid_Test_28_2</h4>
<h4 id="test-case-name-testscanroutinestablewithanemptyoperatortablefile-cjavaprojectsapachedruidsqlsrctestjavaorgapachedruidsqlcalciteschemainformationschematestjava">Test Case Name: <code>testScanRoutinesTableWithAnEmptyOperatorTable</code>(File: <code>C:\Java_projects\Apache\druid\sql\src\test\java\org\apache\druid\sql\calcite\schema\InformationSchemaTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockoperatortable">Mock Object Variable Name: <code>mockOperatorTable</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testScanRoutinesTableWithAnEmptyOperatorTable() {
<span class="hljs-deletion">-    DruidOperatorTable mockOperatorTable = Mockito.mock(DruidOperatorTable.class);</span>
     // This should never happen. Adding a test case, so we don't hit a NPE and instead return gracefully.
     List&lt;SqlOperator&gt; emptyOperatorList = new ArrayList&lt;&gt;();
<span class="hljs-deletion">-    Mockito.when(mockOperatorTable.getOperatorList()).thenReturn(emptyOperatorList);</span>
<span class="hljs-addition">+    DruidOperatorTable mockOperatorTable = createMockDruidOperatorTable(emptyOperatorList);</span>
     InformationSchema.RoutinesTable routinesTable = new InformationSchema.RoutinesTable(mockOperatorTable);
     DataContext dataContext = createDataContext();
     List&lt;Object[]&gt; rows = routinesTable.scan(dataContext).toList();
     Assert.assertNotNull(rows);
     Assert.assertEquals(0, rows.size());
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testScanRoutinesTableWithAnEmptyOperatorTable</span><span class="hljs-params">()</span> </span>{

    DruidOperatorTable mockOperatorTable = Mockito.mock(DruidOperatorTable<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// This should never happen. Adding a test case, so we don't hit a NPE and instead return gracefully.</span>

    List&lt;SqlOperator&gt; emptyOperatorList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    Mockito.when(mockOperatorTable.getOperatorList()).thenReturn(emptyOperatorList);

    InformationSchema.RoutinesTable routinesTable = <span class="hljs-keyword">new</span> InformationSchema.RoutinesTable(mockOperatorTable);

    DataContext dataContext = createDataContext();

    List&lt;Object[]&gt; rows = routinesTable.scan(dataContext).toList();

    Assert.assertNotNull(rows);

    Assert.assertEquals(<span class="hljs-number">0</span>, rows.size());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DruidOperatorTable <span class="hljs-title">createMockDruidOperatorTable</span><span class="hljs-params">(List&lt;SqlOperator&gt; operatorList)</span> </span>{
    DruidOperatorTable mockOperatorTable = Mockito.mock(DruidOperatorTable<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(mockOperatorTable.getOperatorList()).thenReturn(operatorList);
    <span class="hljs-keyword">return</span> mockOperatorTable;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci29">Mock Clone Instance #druid_MCI_29</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.fasterxml.jackson.databind.ObjectMapper</code></li>
<li><strong>Test Case Count</strong>: 6</li>
<li><strong>MO Count</strong>: 6</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ObjectMapper mockMapper;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockMapper

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest291">Test Case ID #druid_Test_29_1</h4>
<h4 id="test-case-name-testhandleexceptionwithfilterdisabledfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleExceptionWithFilterDisabled</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockmapper">Mock Object Variable Name: <code>mockMapper</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testHandleExceptionWithFilterDisabled() throws Exception {
     String errorMessage = "test exception message";
<span class="hljs-deletion">-    ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockMapper`</span>
     HttpServletResponse response = Mockito.mock(HttpServletResponse.class);
     ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);
     Mockito.when(response.getOutputStream()).thenReturn(outputStream);
     final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig());
     Exception testException = new IllegalStateException(errorMessage);
<span class="hljs-deletion">-    servlet.handleException(response, mockMapper, testException);</span>
<span class="hljs-addition">+    servlet.handleException(response, mockMapper, testException);</span>
     ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception.class);
<span class="hljs-deletion">-    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
<span class="hljs-addition">+    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
     Assert.assertTrue(captor.getValue() instanceof QueryException);
     Assert.assertEquals("Unknown exception", ((QueryException) captor.getValue()).getErrorCode());
     Assert.assertEquals(errorMessage, captor.getValue().getMessage());
     Assert.assertEquals(IllegalStateException.class.getName(), ((QueryException) captor.getValue()).getErrorClass());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleExceptionWithFilterDisabled</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig());

    Exception testException = <span class="hljs-keyword">new</span> IllegalStateException(errorMessage);

    servlet.handleException(response, mockMapper, testException);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertEquals(errorMessage, captor.getValue().getMessage());

    Assert.assertEquals(IllegalStateException<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), ((<span class="hljs-title">QueryException</span>) <span class="hljs-title">captor</span>.<span class="hljs-title">getValue</span>()).<span class="hljs-title">getErrorClass</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ObjectMapper mockMapper;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockMapper

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest292">Test Case ID #druid_Test_29_2</h4>
<h4 id="test-case-name-testhandleexceptionwithfilterenabledfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleExceptionWithFilterEnabled</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockmapper">Mock Object Variable Name: <code>mockMapper</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testHandleExceptionWithFilterEnabled() throws Exception {
     String errorMessage = "test exception message";
<span class="hljs-deletion">-    ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockMapper`</span>
     HttpServletResponse response = Mockito.mock(HttpServletResponse.class);
     ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);
     Mockito.when(response.getOutputStream()).thenReturn(outputStream);
     final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig() {

         @Override
         public boolean isShowDetailedJettyErrors() {
             return true;
         }

         @Override
         public ErrorResponseTransformStrategy getErrorResponseTransformStrategy() {
             return new AllowedRegexErrorResponseTransformStrategy(ImmutableList.of());
         }
     });
     Exception testException = new IllegalStateException(errorMessage);
     servlet.handleException(response, mockMapper, testException);
     ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception.class);
<span class="hljs-deletion">-    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
<span class="hljs-addition">+    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
     Assert.assertTrue(captor.getValue() instanceof QueryException);
     Assert.assertEquals("Unknown exception", ((QueryException) captor.getValue()).getErrorCode());
     Assert.assertNull(captor.getValue().getMessage());
     Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());
     Assert.assertNull(((QueryException) captor.getValue()).getHost());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleExceptionWithFilterEnabled</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isShowDetailedJettyErrors</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> ErrorResponseTransformStrategy <span class="hljs-title">getErrorResponseTransformStrategy</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AllowedRegexErrorResponseTransformStrategy(ImmutableList.of());

        }

    });

    Exception testException = <span class="hljs-keyword">new</span> IllegalStateException(errorMessage);

    servlet.handleException(response, mockMapper, testException);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertNull(captor.getValue().getMessage());

    Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());

    Assert.assertNull(((QueryException) captor.getValue()).getHost());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ObjectMapper mockMapper;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockMapper

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest293">Test Case ID #druid_Test_29_3</h4>
<h4 id="test-case-name-testhandleexceptionwithfilterenabledbutmessagematchallowedregexfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleExceptionWithFilterEnabledButMessageMatchAllowedRegex</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockmapper">Mock Object Variable Name: <code>mockMapper</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testHandleExceptionWithFilterEnabledButMessageMatchAllowedRegex() throws Exception {
     String errorMessage = "test exception message";
<span class="hljs-deletion">-    ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockMapper`</span>
     HttpServletResponse response = Mockito.mock(HttpServletResponse.class);
     ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);
     Mockito.when(response.getOutputStream()).thenReturn(outputStream);
     final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig() {

         @Override
         public boolean isShowDetailedJettyErrors() {
             return true;
         }

         @Override
         public ErrorResponseTransformStrategy getErrorResponseTransformStrategy() {
             return new AllowedRegexErrorResponseTransformStrategy(ImmutableList.of("test .*"));
         }
     });
     Exception testException = new IllegalStateException(errorMessage);
     servlet.handleException(response, mockMapper, testException);
     ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception.class);
<span class="hljs-deletion">-    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
<span class="hljs-addition">+    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
     Assert.assertTrue(captor.getValue() instanceof QueryException);
     Assert.assertEquals("Unknown exception", ((QueryException) captor.getValue()).getErrorCode());
     Assert.assertEquals(errorMessage, captor.getValue().getMessage());
     Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());
     Assert.assertNull(((QueryException) captor.getValue()).getHost());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleExceptionWithFilterEnabledButMessageMatchAllowedRegex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isShowDetailedJettyErrors</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> ErrorResponseTransformStrategy <span class="hljs-title">getErrorResponseTransformStrategy</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AllowedRegexErrorResponseTransformStrategy(ImmutableList.of(<span class="hljs-string">"test .*"</span>));

        }

    });

    Exception testException = <span class="hljs-keyword">new</span> IllegalStateException(errorMessage);

    servlet.handleException(response, mockMapper, testException);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertEquals(errorMessage, captor.getValue().getMessage());

    Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());

    Assert.assertNull(((QueryException) captor.getValue()).getHost());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ObjectMapper mockMapper;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockMapper

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest294">Test Case ID #druid_Test_29_4</h4>
<h4 id="test-case-name-testhandlequeryparseexceptionwithfilterdisabledfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleQueryParseExceptionWithFilterDisabled</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockmapper">Mock Object Variable Name: <code>mockMapper</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testHandleQueryParseExceptionWithFilterDisabled() throws Exception {
     String errorMessage = "test exception message";
<span class="hljs-deletion">-    ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockMapper`</span>
     HttpServletRequest request = Mockito.mock(HttpServletRequest.class);
     HttpServletResponse response = Mockito.mock(HttpServletResponse.class);
     ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);
     Mockito.when(response.getOutputStream()).thenReturn(outputStream);
     final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig());
     IOException testException = new IOException(errorMessage);
     servlet.handleQueryParseException(request, response, mockMapper, testException, false);
     ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception.class);
<span class="hljs-deletion">-    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
<span class="hljs-addition">+    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
     Assert.assertTrue(captor.getValue() instanceof QueryException);
     Assert.assertEquals("Unknown exception", ((QueryException) captor.getValue()).getErrorCode());
     Assert.assertEquals(errorMessage, captor.getValue().getMessage());
     Assert.assertEquals(IOException.class.getName(), ((QueryException) captor.getValue()).getErrorClass());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleQueryParseExceptionWithFilterDisabled</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletRequest request = Mockito.mock(HttpServletRequest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig());

    IOException testException = <span class="hljs-keyword">new</span> IOException(errorMessage);

    servlet.handleQueryParseException(request, response, mockMapper, testException, <span class="hljs-keyword">false</span>);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertEquals(errorMessage, captor.getValue().getMessage());

    Assert.assertEquals(IOException<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), ((<span class="hljs-title">QueryException</span>) <span class="hljs-title">captor</span>.<span class="hljs-title">getValue</span>()).<span class="hljs-title">getErrorClass</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ObjectMapper mockMapper;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockMapper

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest295">Test Case ID #druid_Test_29_5</h4>
<h4 id="test-case-name-testhandlequeryparseexceptionwithfilterenabledfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleQueryParseExceptionWithFilterEnabled</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockmapper">Mock Object Variable Name: <code>mockMapper</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testHandleQueryParseExceptionWithFilterEnabled() throws Exception {
     String errorMessage = "test exception message";
<span class="hljs-deletion">-    ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockMapper`</span>
     HttpServletRequest request = Mockito.mock(HttpServletRequest.class);
     HttpServletResponse response = Mockito.mock(HttpServletResponse.class);
     ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);
     Mockito.when(response.getOutputStream()).thenReturn(outputStream);
     final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig() {

         @Override
         public boolean isShowDetailedJettyErrors() {
             return true;
         }

         @Override
         public ErrorResponseTransformStrategy getErrorResponseTransformStrategy() {
             return new AllowedRegexErrorResponseTransformStrategy(ImmutableList.of());
         }
     });
     IOException testException = new IOException(errorMessage);
     servlet.handleQueryParseException(request, response, mockMapper, testException, false);
     ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception.class);
<span class="hljs-deletion">-    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
<span class="hljs-addition">+    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
     Assert.assertTrue(captor.getValue() instanceof QueryException);
     Assert.assertEquals("Unknown exception", ((QueryException) captor.getValue()).getErrorCode());
     Assert.assertNull(captor.getValue().getMessage());
     Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());
     Assert.assertNull(((QueryException) captor.getValue()).getHost());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleQueryParseExceptionWithFilterEnabled</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletRequest request = Mockito.mock(HttpServletRequest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isShowDetailedJettyErrors</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> ErrorResponseTransformStrategy <span class="hljs-title">getErrorResponseTransformStrategy</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AllowedRegexErrorResponseTransformStrategy(ImmutableList.of());

        }

    });

    IOException testException = <span class="hljs-keyword">new</span> IOException(errorMessage);

    servlet.handleQueryParseException(request, response, mockMapper, testException, <span class="hljs-keyword">false</span>);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertNull(captor.getValue().getMessage());

    Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());

    Assert.assertNull(((QueryException) captor.getValue()).getHost());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ObjectMapper mockMapper;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockMapper

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest296">Test Case ID #druid_Test_29_6</h4>
<h4 id="test-case-name-testhandlequeryparseexceptionwithfilterenabledbutmessagematchallowedregexfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleQueryParseExceptionWithFilterEnabledButMessageMatchAllowedRegex</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockmapper">Mock Object Variable Name: <code>mockMapper</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testHandleQueryParseExceptionWithFilterEnabledButMessageMatchAllowedRegex() throws Exception {
     String errorMessage = "test exception message";
<span class="hljs-deletion">-    ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `mockMapper`</span>
     HttpServletRequest request = Mockito.mock(HttpServletRequest.class);
     HttpServletResponse response = Mockito.mock(HttpServletResponse.class);
     ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);
     Mockito.when(response.getOutputStream()).thenReturn(outputStream);
     final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig() {

         @Override
         public boolean isShowDetailedJettyErrors() {
             return true;
         }

         @Override
         public ErrorResponseTransformStrategy getErrorResponseTransformStrategy() {
             return new AllowedRegexErrorResponseTransformStrategy(ImmutableList.of("test .*"));
         }
     });
     IOException testException = new IOException(errorMessage);
     servlet.handleQueryParseException(request, response, mockMapper, testException, false);
     ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception.class);
<span class="hljs-deletion">-    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
<span class="hljs-addition">+    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());</span>
     Assert.assertTrue(captor.getValue() instanceof QueryException);
     Assert.assertEquals("Unknown exception", ((QueryException) captor.getValue()).getErrorCode());
     Assert.assertEquals(errorMessage, captor.getValue().getMessage());
     Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());
     Assert.assertNull(((QueryException) captor.getValue()).getHost());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleQueryParseExceptionWithFilterEnabledButMessageMatchAllowedRegex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletRequest request = Mockito.mock(HttpServletRequest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isShowDetailedJettyErrors</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> ErrorResponseTransformStrategy <span class="hljs-title">getErrorResponseTransformStrategy</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AllowedRegexErrorResponseTransformStrategy(ImmutableList.of(<span class="hljs-string">"test .*"</span>));

        }

    });

    IOException testException = <span class="hljs-keyword">new</span> IOException(errorMessage);

    servlet.handleQueryParseException(request, response, mockMapper, testException, <span class="hljs-keyword">false</span>);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertEquals(errorMessage, captor.getValue().getMessage());

    Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());

    Assert.assertNull(((QueryException) captor.getValue()).getHost());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ObjectMapper mockMapper;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
mockMapper

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci30">Mock Clone Instance #druid_MCI_30</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.client.indexing.ClientCompactionTaskQueryTuningConfig</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ClientCompactionTaskQueryTuningConfig <span class="hljs-title">createMockClientCompactionTaskQueryTuningConfig</span><span class="hljs-params">(Integer maxNumConcurrentSubTasks, PartitionsSpec partitionsSpec)</span> </span>{
    ClientCompactionTaskQueryTuningConfig tuningConfig = Mockito.mock(ClientCompactionTaskQueryTuningConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(tuningConfig.getMaxNumConcurrentSubTasks()).thenReturn(maxNumConcurrentSubTasks);
    Mockito.when(tuningConfig.getPartitionsSpec()).thenReturn(partitionsSpec);
    <span class="hljs-keyword">return</span> tuningConfig;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest301">Test Case ID #druid_Test_30_1</h4>
<h4 id="test-case-name-testisparallelmodenonrangepartitionvaryingmaxnumconcurrentsubtasksfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservercoordinatordutycompactsegmentstestjava">Test Case Name: <code>testIsParallelModeNonRangePartitionVaryingMaxNumConcurrentSubTasks</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\coordinator\duty\CompactSegmentsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-tuningconfig">Mock Object Variable Name: <code>tuningConfig</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testIsParallelModeNonRangePartitionVaryingMaxNumConcurrentSubTasks() {
<span class="hljs-deletion">-    ClientCompactionTaskQueryTuningConfig tuningConfig = Mockito.mock(ClientCompactionTaskQueryTuningConfig.class);</span>
<span class="hljs-deletion">-    Mockito.when(tuningConfig.getPartitionsSpec()).thenReturn(Mockito.mock(PartitionsSpec.class));</span>
<span class="hljs-addition">+    PartitionsSpec partitionsSpec = Mockito.mock(PartitionsSpec.class);</span>
<span class="hljs-addition">+    ClientCompactionTaskQueryTuningConfig tuningConfig = createMockClientCompactionTaskQueryTuningConfig(null, partitionsSpec);</span>
    Mockito.when(tuningConfig.getMaxNumConcurrentSubTasks()).thenReturn(null);
    Assert.assertFalse(CompactSegments.isParallelMode(tuningConfig));
    Mockito.when(tuningConfig.getMaxNumConcurrentSubTasks()).thenReturn(1);
    Assert.assertFalse(CompactSegments.isParallelMode(tuningConfig));
    Mockito.when(tuningConfig.getMaxNumConcurrentSubTasks()).thenReturn(2);
    Assert.assertTrue(CompactSegments.isParallelMode(tuningConfig));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testIsParallelModeNonRangePartitionVaryingMaxNumConcurrentSubTasks</span><span class="hljs-params">()</span> </span>{

    ClientCompactionTaskQueryTuningConfig tuningConfig = Mockito.mock(ClientCompactionTaskQueryTuningConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(tuningConfig.getPartitionsSpec()).thenReturn(Mockito.mock(PartitionsSpec<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(tuningConfig.getMaxNumConcurrentSubTasks()).thenReturn(<span class="hljs-keyword">null</span>);

    Assert.assertFalse(CompactSegments.isParallelMode(tuningConfig));

    Mockito.when(tuningConfig.getMaxNumConcurrentSubTasks()).thenReturn(<span class="hljs-number">1</span>);

    Assert.assertFalse(CompactSegments.isParallelMode(tuningConfig));

    Mockito.when(tuningConfig.getMaxNumConcurrentSubTasks()).thenReturn(<span class="hljs-number">2</span>);

    Assert.assertTrue(CompactSegments.isParallelMode(tuningConfig));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ClientCompactionTaskQueryTuningConfig <span class="hljs-title">createMockClientCompactionTaskQueryTuningConfig</span><span class="hljs-params">(Integer maxNumConcurrentSubTasks, PartitionsSpec partitionsSpec)</span> </span>{
    ClientCompactionTaskQueryTuningConfig tuningConfig = Mockito.mock(ClientCompactionTaskQueryTuningConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(tuningConfig.getMaxNumConcurrentSubTasks()).thenReturn(maxNumConcurrentSubTasks);
    Mockito.when(tuningConfig.getPartitionsSpec()).thenReturn(partitionsSpec);
    <span class="hljs-keyword">return</span> tuningConfig;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest302">Test Case ID #druid_Test_30_2</h4>
<h4 id="test-case-name-testfindmaxnumtaskslotsusedbyonecompactiontaskwhenisparallelmodefile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservercoordinatordutycompactsegmentstestjava">Test Case Name: <code>testFindMaxNumTaskSlotsUsedByOneCompactionTaskWhenIsParallelMode</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\coordinator\duty\CompactSegmentsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-tuningconfig">Mock Object Variable Name: <code>tuningConfig</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testFindMaxNumTaskSlotsUsedByOneCompactionTaskWhenIsParallelMode() {
<span class="hljs-deletion">-    ClientCompactionTaskQueryTuningConfig tuningConfig = Mockito.mock(ClientCompactionTaskQueryTuningConfig.class);</span>
<span class="hljs-deletion">-    Mockito.when(tuningConfig.getPartitionsSpec()).thenReturn(Mockito.mock(PartitionsSpec.class));</span>
<span class="hljs-deletion">-    Mockito.when(tuningConfig.getMaxNumConcurrentSubTasks()).thenReturn(2);</span>
<span class="hljs-addition">+    PartitionsSpec partitionsSpec = Mockito.mock(PartitionsSpec.class);</span>
<span class="hljs-addition">+    ClientCompactionTaskQueryTuningConfig tuningConfig = createMockClientCompactionTaskQueryTuningConfig(2, partitionsSpec);</span>
     Assert.assertEquals(3, CompactSegments.findMaxNumTaskSlotsUsedByOneCompactionTask(tuningConfig));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFindMaxNumTaskSlotsUsedByOneCompactionTaskWhenIsParallelMode</span><span class="hljs-params">()</span> </span>{

    ClientCompactionTaskQueryTuningConfig tuningConfig = Mockito.mock(ClientCompactionTaskQueryTuningConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(tuningConfig.getPartitionsSpec()).thenReturn(Mockito.mock(PartitionsSpec<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(tuningConfig.getMaxNumConcurrentSubTasks()).thenReturn(<span class="hljs-number">2</span>);

    Assert.assertEquals(<span class="hljs-number">3</span>, CompactSegments.findMaxNumTaskSlotsUsedByOneCompactionTask(tuningConfig));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ClientCompactionTaskQueryTuningConfig <span class="hljs-title">createMockClientCompactionTaskQueryTuningConfig</span><span class="hljs-params">(Integer maxNumConcurrentSubTasks, PartitionsSpec partitionsSpec)</span> </span>{
    ClientCompactionTaskQueryTuningConfig tuningConfig = Mockito.mock(ClientCompactionTaskQueryTuningConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(tuningConfig.getMaxNumConcurrentSubTasks()).thenReturn(maxNumConcurrentSubTasks);
    Mockito.when(tuningConfig.getPartitionsSpec()).thenReturn(partitionsSpec);
    <span class="hljs-keyword">return</span> tuningConfig;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest303">Test Case ID #druid_Test_30_3</h4>
<h4 id="test-case-name-testfindmaxnumtaskslotsusedbyonecompactiontaskwhenissequentialmodefile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservercoordinatordutycompactsegmentstestjava">Test Case Name: <code>testFindMaxNumTaskSlotsUsedByOneCompactionTaskWhenIsSequentialMode</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\coordinator\duty\CompactSegmentsTest.java</code>)</h4>
<h4 id="mock-object-variable-name-tuningconfig">Mock Object Variable Name: <code>tuningConfig</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testFindMaxNumTaskSlotsUsedByOneCompactionTaskWhenIsSequentialMode() {
<span class="hljs-deletion">-    ClientCompactionTaskQueryTuningConfig tuningConfig = Mockito.mock(ClientCompactionTaskQueryTuningConfig.class);</span>
<span class="hljs-deletion">-    Mockito.when(tuningConfig.getPartitionsSpec()).thenReturn(Mockito.mock(PartitionsSpec.class));</span>
<span class="hljs-deletion">-    Mockito.when(tuningConfig.getMaxNumConcurrentSubTasks()).thenReturn(1);</span>
<span class="hljs-addition">+    PartitionsSpec partitionsSpec = Mockito.mock(PartitionsSpec.class);</span>
<span class="hljs-addition">+    ClientCompactionTaskQueryTuningConfig tuningConfig = createMockClientCompactionTaskQueryTuningConfig(1, partitionsSpec);</span>
     Assert.assertEquals(1, CompactSegments.findMaxNumTaskSlotsUsedByOneCompactionTask(tuningConfig));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFindMaxNumTaskSlotsUsedByOneCompactionTaskWhenIsSequentialMode</span><span class="hljs-params">()</span> </span>{

    ClientCompactionTaskQueryTuningConfig tuningConfig = Mockito.mock(ClientCompactionTaskQueryTuningConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(tuningConfig.getPartitionsSpec()).thenReturn(Mockito.mock(PartitionsSpec<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(tuningConfig.getMaxNumConcurrentSubTasks()).thenReturn(<span class="hljs-number">1</span>);

    Assert.assertEquals(<span class="hljs-number">1</span>, CompactSegments.findMaxNumTaskSlotsUsedByOneCompactionTask(tuningConfig));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ClientCompactionTaskQueryTuningConfig <span class="hljs-title">createMockClientCompactionTaskQueryTuningConfig</span><span class="hljs-params">(Integer maxNumConcurrentSubTasks, PartitionsSpec partitionsSpec)</span> </span>{
    ClientCompactionTaskQueryTuningConfig tuningConfig = Mockito.mock(ClientCompactionTaskQueryTuningConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(tuningConfig.getMaxNumConcurrentSubTasks()).thenReturn(maxNumConcurrentSubTasks);
    Mockito.when(tuningConfig.getPartitionsSpec()).thenReturn(partitionsSpec);
    <span class="hljs-keyword">return</span> tuningConfig;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci31">Mock Clone Instance #druid_MCI_31</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.indexing.overlord.duty.OverlordDuty</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> OverlordDuty <span class="hljs-title">createMockOverlordDuty</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isEnabledReturn)</span> </span>{
    OverlordDuty mockDuty = Mockito.mock(OverlordDuty<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(mockDuty.isEnabled()).thenReturn(isEnabledReturn);
    <span class="hljs-keyword">return</span> mockDuty;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest311">Test Case ID #druid_Test_31_1</h4>
<h4 id="test-case-name-teststartandstopfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingoverlorddutyoverlorddutyexecutortestjava">Test Case Name: <code>testStartAndStop</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\overlord\duty\OverlordDutyExecutorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-testduty1">Mock Object Variable Name: <code>testDuty1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testStartAndStop() {
<span class="hljs-deletion">-    OverlordDuty testDuty1 = Mockito.mock(OverlordDuty.class);</span>
<span class="hljs-deletion">-    Mockito.when(testDuty1.isEnabled()).thenReturn(true);</span>
<span class="hljs-deletion">-    Mockito.when(testDuty1.getSchedule()).thenReturn(new DutySchedule(0, 0));</span>
<span class="hljs-addition">+    OverlordDuty testDuty1 = createMockOverlordDuty(true);</span>
<span class="hljs-addition">+    Mockito.when(testDuty1.getSchedule()).thenReturn(new DutySchedule(0, 0));</span>
    OverlordDuty testDuty2 = Mockito.mock(OverlordDuty.class);
    Mockito.when(testDuty2.isEnabled()).thenReturn(true);
    Mockito.when(testDuty2.getSchedule()).thenReturn(new DutySchedule(0, 0));
    ScheduledExecutorFactory executorFactory = Mockito.mock(ScheduledExecutorFactory.class);
    ScheduledExecutorService executorService = Mockito.mock(ScheduledExecutorService.class);
    Mockito.when(executorFactory.create(ArgumentMatchers.eq(1), ArgumentMatchers.anyString())).thenReturn(executorService);
    OverlordDutyExecutor dutyExecutor = new OverlordDutyExecutor(executorFactory, ImmutableSet.of(testDuty1, testDuty2));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStartAndStop</span><span class="hljs-params">()</span> </span>{

    OverlordDuty testDuty1 = Mockito.mock(OverlordDuty<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(testDuty1.isEnabled()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(testDuty1.getSchedule()).thenReturn(<span class="hljs-keyword">new</span> DutySchedule(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>));

    OverlordDuty testDuty2 = Mockito.mock(OverlordDuty<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(testDuty2.isEnabled()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(testDuty2.getSchedule()).thenReturn(<span class="hljs-keyword">new</span> DutySchedule(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>));

    ScheduledExecutorFactory executorFactory = Mockito.mock(ScheduledExecutorFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ScheduledExecutorService executorService = Mockito.mock(ScheduledExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(executorFactory.create(ArgumentMatchers.eq(<span class="hljs-number">1</span>), ArgumentMatchers.anyString())).thenReturn(executorService);

    OverlordDutyExecutor dutyExecutor = <span class="hljs-keyword">new</span> OverlordDutyExecutor(executorFactory, ImmutableSet.of(testDuty1, testDuty2));

    <span class="hljs-comment">// Invoke start multiple times</span>

    dutyExecutor.start();

    dutyExecutor.start();

    dutyExecutor.start();

    <span class="hljs-comment">// Verify that executor is initialized and each duty is scheduled</span>

    Mockito.verify(executorFactory, Mockito.times(<span class="hljs-number">1</span>)).create(ArgumentMatchers.eq(<span class="hljs-number">1</span>), ArgumentMatchers.anyString());

    Mockito.verify(executorService, Mockito.times(<span class="hljs-number">2</span>)).schedule(ArgumentMatchers.any(Runnable<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">ArgumentMatchers</span>.<span class="hljs-title">anyLong</span>(), <span class="hljs-title">ArgumentMatchers</span>.<span class="hljs-title">any</span>())</span>;

    <span class="hljs-comment">// Invoke stop multiple times</span>

    dutyExecutor.stop();

    dutyExecutor.stop();

    dutyExecutor.stop();

    <span class="hljs-comment">// Verify that the executor shutdown is invoked just once</span>

    Mockito.verify(executorService, Mockito.times(<span class="hljs-number">1</span>)).shutdownNow();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> OverlordDuty <span class="hljs-title">createMockOverlordDuty</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isEnabledReturn)</span> </span>{
    OverlordDuty mockDuty = Mockito.mock(OverlordDuty<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(mockDuty.isEnabled()).thenReturn(isEnabledReturn);
    <span class="hljs-keyword">return</span> mockDuty;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest312">Test Case ID #druid_Test_31_2</h4>
<h4 id="test-case-name-teststartandstopfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingoverlorddutyoverlorddutyexecutortestjava">Test Case Name: <code>testStartAndStop</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\overlord\duty\OverlordDutyExecutorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-testduty2">Mock Object Variable Name: <code>testDuty2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    OverlordDuty testDuty1 = Mockito.mock(OverlordDuty.class);
    Mockito.when(testDuty1.isEnabled()).thenReturn(true);
    Mockito.when(testDuty1.getSchedule()).thenReturn(new DutySchedule(0, 0));
<span class="hljs-deletion">-    OverlordDuty testDuty2 = Mockito.mock(OverlordDuty.class);</span>
<span class="hljs-deletion">-    Mockito.when(testDuty2.isEnabled()).thenReturn(true);</span>
<span class="hljs-deletion">-    Mockito.when(testDuty2.getSchedule()).thenReturn(new DutySchedule(0, 0));</span>
<span class="hljs-addition">+    OverlordDuty testDuty2 = createMockOverlordDuty(true);</span>
<span class="hljs-addition">+    Mockito.when(testDuty2.getSchedule()).thenReturn(new DutySchedule(0, 0));</span>
    ScheduledExecutorFactory executorFactory = Mockito.mock(ScheduledExecutorFactory.class);
    ScheduledExecutorService executorService = Mockito.mock(ScheduledExecutorService.class);
    Mockito.when(executorFactory.create(ArgumentMatchers.eq(1), ArgumentMatchers.anyString())).thenReturn(executorService);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStartAndStop</span><span class="hljs-params">()</span> </span>{

    OverlordDuty testDuty1 = Mockito.mock(OverlordDuty<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(testDuty1.isEnabled()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(testDuty1.getSchedule()).thenReturn(<span class="hljs-keyword">new</span> DutySchedule(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>));

    OverlordDuty testDuty2 = Mockito.mock(OverlordDuty<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(testDuty2.isEnabled()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(testDuty2.getSchedule()).thenReturn(<span class="hljs-keyword">new</span> DutySchedule(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>));

    ScheduledExecutorFactory executorFactory = Mockito.mock(ScheduledExecutorFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ScheduledExecutorService executorService = Mockito.mock(ScheduledExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(executorFactory.create(ArgumentMatchers.eq(<span class="hljs-number">1</span>), ArgumentMatchers.anyString())).thenReturn(executorService);

    OverlordDutyExecutor dutyExecutor = <span class="hljs-keyword">new</span> OverlordDutyExecutor(executorFactory, ImmutableSet.of(testDuty1, testDuty2));

    <span class="hljs-comment">// Invoke start multiple times</span>

    dutyExecutor.start();

    dutyExecutor.start();

    dutyExecutor.start();

    <span class="hljs-comment">// Verify that executor is initialized and each duty is scheduled</span>

    Mockito.verify(executorFactory, Mockito.times(<span class="hljs-number">1</span>)).create(ArgumentMatchers.eq(<span class="hljs-number">1</span>), ArgumentMatchers.anyString());

    Mockito.verify(executorService, Mockito.times(<span class="hljs-number">2</span>)).schedule(ArgumentMatchers.any(Runnable<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">ArgumentMatchers</span>.<span class="hljs-title">anyLong</span>(), <span class="hljs-title">ArgumentMatchers</span>.<span class="hljs-title">any</span>())</span>;

    <span class="hljs-comment">// Invoke stop multiple times</span>

    dutyExecutor.stop();

    dutyExecutor.stop();

    dutyExecutor.stop();

    <span class="hljs-comment">// Verify that the executor shutdown is invoked just once</span>

    Mockito.verify(executorService, Mockito.times(<span class="hljs-number">1</span>)).shutdownNow();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> OverlordDuty <span class="hljs-title">createMockOverlordDuty</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isEnabledReturn)</span> </span>{
    OverlordDuty mockDuty = Mockito.mock(OverlordDuty<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(mockDuty.isEnabled()).thenReturn(isEnabledReturn);
    <span class="hljs-keyword">return</span> mockDuty;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest313">Test Case ID #druid_Test_31_3</h4>
<h4 id="test-case-name-teststartwithnoenableddutyfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingoverlorddutyoverlorddutyexecutortestjava">Test Case Name: <code>testStartWithNoEnabledDuty</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\overlord\duty\OverlordDutyExecutorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-testduty">Mock Object Variable Name: <code>testDuty</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testStartWithNoEnabledDuty() {
<span class="hljs-deletion">-    OverlordDuty testDuty = Mockito.mock(OverlordDuty.class);</span>
<span class="hljs-deletion">-    Mockito.when(testDuty.isEnabled()).thenReturn(false);</span>
<span class="hljs-addition">+    OverlordDuty testDuty = createMockOverlordDuty(false);</span>
     ScheduledExecutorFactory executorFactory = Mockito.mock(ScheduledExecutorFactory.class);
     OverlordDutyExecutor dutyExecutor = new OverlordDutyExecutor(executorFactory, Collections.singleton(testDuty));
     dutyExecutor.start();
     // Verify that executor is not initialized as there is no enabled duty
     Mockito.verify(executorFactory, Mockito.never()).create(ArgumentMatchers.eq(1), ArgumentMatchers.anyString());
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStartWithNoEnabledDuty</span><span class="hljs-params">()</span> </span>{

    OverlordDuty testDuty = Mockito.mock(OverlordDuty<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(testDuty.isEnabled()).thenReturn(<span class="hljs-keyword">false</span>);

    ScheduledExecutorFactory executorFactory = Mockito.mock(ScheduledExecutorFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    OverlordDutyExecutor dutyExecutor = <span class="hljs-keyword">new</span> OverlordDutyExecutor(executorFactory, Collections.singleton(testDuty));

    dutyExecutor.start();

    <span class="hljs-comment">// Verify that executor is not initialized as there is no enabled duty</span>

    Mockito.verify(executorFactory, Mockito.never()).create(ArgumentMatchers.eq(<span class="hljs-number">1</span>), ArgumentMatchers.anyString());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> OverlordDuty <span class="hljs-title">createMockOverlordDuty</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isEnabledReturn)</span> </span>{
    OverlordDuty mockDuty = Mockito.mock(OverlordDuty<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(mockDuty.isEnabled()).thenReturn(isEnabledReturn);
    <span class="hljs-keyword">return</span> mockDuty;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci32">Mock Clone Instance #druid_MCI_32</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>javax.servlet.http.HttpServletResponse</code></li>
<li><strong>Test Case Count</strong>: 6</li>
<li><strong>MO Count</strong>: 6</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HttpServletResponse <span class="hljs-title">createMockHttpServletResponse</span><span class="hljs-params">(ServletOutputStream outputStream)</span> </span>{
    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(response.getOutputStream()).thenReturn(outputStream);
    <span class="hljs-keyword">return</span> response;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest321">Test Case ID #druid_Test_32_1</h4>
<h4 id="test-case-name-testhandleexceptionwithfilterdisabledfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleExceptionWithFilterDisabled</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-response">Mock Object Variable Name: <code>response</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);
<span class="hljs-deletion">-    HttpServletResponse response = Mockito.mock(HttpServletResponse.class);</span>
    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);
<span class="hljs-deletion">-    Mockito.when(response.getOutputStream()).thenReturn(outputStream);</span>
<span class="hljs-addition">+    HttpServletResponse response = createMockHttpServletResponse(outputStream);</span>
    final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig());
    Exception testException = new IllegalStateException(errorMessage);
    servlet.handleException(response, mockMapper, testException);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleExceptionWithFilterDisabled</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig());

    Exception testException = <span class="hljs-keyword">new</span> IllegalStateException(errorMessage);

    servlet.handleException(response, mockMapper, testException);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertEquals(errorMessage, captor.getValue().getMessage());

    Assert.assertEquals(IllegalStateException<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), ((<span class="hljs-title">QueryException</span>) <span class="hljs-title">captor</span>.<span class="hljs-title">getValue</span>()).<span class="hljs-title">getErrorClass</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HttpServletResponse <span class="hljs-title">createMockHttpServletResponse</span><span class="hljs-params">(ServletOutputStream outputStream)</span> </span>{
    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(response.getOutputStream()).thenReturn(outputStream);
    <span class="hljs-keyword">return</span> response;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest322">Test Case ID #druid_Test_32_2</h4>
<h4 id="test-case-name-testhandleexceptionwithfilterenabledfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleExceptionWithFilterEnabled</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-response">Mock Object Variable Name: <code>response</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);
<span class="hljs-deletion">-    HttpServletResponse response = Mockito.mock(HttpServletResponse.class);</span>
    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);
<span class="hljs-deletion">-    Mockito.when(response.getOutputStream()).thenReturn(outputStream);</span>
<span class="hljs-addition">+    HttpServletResponse response = createMockHttpServletResponse(outputStream);</span>
    final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig() {

</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleExceptionWithFilterEnabled</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isShowDetailedJettyErrors</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> ErrorResponseTransformStrategy <span class="hljs-title">getErrorResponseTransformStrategy</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AllowedRegexErrorResponseTransformStrategy(ImmutableList.of());

        }

    });

    Exception testException = <span class="hljs-keyword">new</span> IllegalStateException(errorMessage);

    servlet.handleException(response, mockMapper, testException);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertNull(captor.getValue().getMessage());

    Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());

    Assert.assertNull(((QueryException) captor.getValue()).getHost());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HttpServletResponse <span class="hljs-title">createMockHttpServletResponse</span><span class="hljs-params">(ServletOutputStream outputStream)</span> </span>{
    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(response.getOutputStream()).thenReturn(outputStream);
    <span class="hljs-keyword">return</span> response;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest323">Test Case ID #druid_Test_32_3</h4>
<h4 id="test-case-name-testhandleexceptionwithfilterenabledbutmessagematchallowedregexfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleExceptionWithFilterEnabledButMessageMatchAllowedRegex</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-response">Mock Object Variable Name: <code>response</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);
<span class="hljs-deletion">-    HttpServletResponse response = Mockito.mock(HttpServletResponse.class);</span>
    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);
<span class="hljs-deletion">-    Mockito.when(response.getOutputStream()).thenReturn(outputStream);</span>
<span class="hljs-addition">+    HttpServletResponse response = createMockHttpServletResponse(outputStream);</span>
    final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig() {

</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleExceptionWithFilterEnabledButMessageMatchAllowedRegex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isShowDetailedJettyErrors</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> ErrorResponseTransformStrategy <span class="hljs-title">getErrorResponseTransformStrategy</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AllowedRegexErrorResponseTransformStrategy(ImmutableList.of(<span class="hljs-string">"test .*"</span>));

        }

    });

    Exception testException = <span class="hljs-keyword">new</span> IllegalStateException(errorMessage);

    servlet.handleException(response, mockMapper, testException);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertEquals(errorMessage, captor.getValue().getMessage());

    Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());

    Assert.assertNull(((QueryException) captor.getValue()).getHost());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HttpServletResponse <span class="hljs-title">createMockHttpServletResponse</span><span class="hljs-params">(ServletOutputStream outputStream)</span> </span>{
    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(response.getOutputStream()).thenReturn(outputStream);
    <span class="hljs-keyword">return</span> response;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest324">Test Case ID #druid_Test_32_4</h4>
<h4 id="test-case-name-testhandlequeryparseexceptionwithfilterdisabledfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleQueryParseExceptionWithFilterDisabled</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-response">Mock Object Variable Name: <code>response</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);
    HttpServletRequest request = Mockito.mock(HttpServletRequest.class);
<span class="hljs-deletion">-    HttpServletResponse response = Mockito.mock(HttpServletResponse.class);</span>
<span class="hljs-deletion">-    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);</span>
<span class="hljs-deletion">-    Mockito.when(response.getOutputStream()).thenReturn(outputStream);</span>
<span class="hljs-addition">+    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);</span>
<span class="hljs-addition">+    HttpServletResponse response = createMockHttpServletResponse(outputStream);</span>
    final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig());
    IOException testException = new IOException(errorMessage);
    servlet.handleQueryParseException(request, response, mockMapper, testException, false);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleQueryParseExceptionWithFilterDisabled</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletRequest request = Mockito.mock(HttpServletRequest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig());

    IOException testException = <span class="hljs-keyword">new</span> IOException(errorMessage);

    servlet.handleQueryParseException(request, response, mockMapper, testException, <span class="hljs-keyword">false</span>);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertEquals(errorMessage, captor.getValue().getMessage());

    Assert.assertEquals(IOException<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), ((<span class="hljs-title">QueryException</span>) <span class="hljs-title">captor</span>.<span class="hljs-title">getValue</span>()).<span class="hljs-title">getErrorClass</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HttpServletResponse <span class="hljs-title">createMockHttpServletResponse</span><span class="hljs-params">(ServletOutputStream outputStream)</span> </span>{
    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(response.getOutputStream()).thenReturn(outputStream);
    <span class="hljs-keyword">return</span> response;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest325">Test Case ID #druid_Test_32_5</h4>
<h4 id="test-case-name-testhandlequeryparseexceptionwithfilterenabledfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleQueryParseExceptionWithFilterEnabled</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-response">Mock Object Variable Name: <code>response</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);
    HttpServletRequest request = Mockito.mock(HttpServletRequest.class);
<span class="hljs-deletion">-    HttpServletResponse response = Mockito.mock(HttpServletResponse.class);</span>
<span class="hljs-deletion">-    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);</span>
<span class="hljs-deletion">-    Mockito.when(response.getOutputStream()).thenReturn(outputStream);</span>
<span class="hljs-addition">+    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);</span>
<span class="hljs-addition">+    HttpServletResponse response = createMockHttpServletResponse(outputStream);</span>
    final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig() {
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleQueryParseExceptionWithFilterEnabled</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletRequest request = Mockito.mock(HttpServletRequest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isShowDetailedJettyErrors</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> ErrorResponseTransformStrategy <span class="hljs-title">getErrorResponseTransformStrategy</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AllowedRegexErrorResponseTransformStrategy(ImmutableList.of());

        }

    });

    IOException testException = <span class="hljs-keyword">new</span> IOException(errorMessage);

    servlet.handleQueryParseException(request, response, mockMapper, testException, <span class="hljs-keyword">false</span>);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertNull(captor.getValue().getMessage());

    Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());

    Assert.assertNull(((QueryException) captor.getValue()).getHost());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HttpServletResponse <span class="hljs-title">createMockHttpServletResponse</span><span class="hljs-params">(ServletOutputStream outputStream)</span> </span>{
    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(response.getOutputStream()).thenReturn(outputStream);
    <span class="hljs-keyword">return</span> response;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest326">Test Case ID #druid_Test_32_6</h4>
<h4 id="test-case-name-testhandlequeryparseexceptionwithfilterenabledbutmessagematchallowedregexfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidserverasyncqueryforwardingservlettestjava">Test Case Name: <code>testHandleQueryParseExceptionWithFilterEnabledButMessageMatchAllowedRegex</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\server\AsyncQueryForwardingServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-response">Mock Object Variable Name: <code>response</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ObjectMapper mockMapper = Mockito.mock(ObjectMapper.class);
    HttpServletRequest request = Mockito.mock(HttpServletRequest.class);
<span class="hljs-deletion">-    HttpServletResponse response = Mockito.mock(HttpServletResponse.class);</span>
    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream.class);
<span class="hljs-deletion">-    Mockito.when(response.getOutputStream()).thenReturn(outputStream);</span>
<span class="hljs-addition">+    HttpServletResponse response = createMockHttpServletResponse(outputStream);</span>
    final AsyncQueryForwardingServlet servlet = new AsyncQueryForwardingServlet(new MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), null, null, null, new NoopServiceEmitter(), new NoopRequestLogger(), new DefaultGenericQueryMetricsFactory(), new AuthenticatorMapper(ImmutableMap.of()), new Properties(), new ServerConfig() {

        @Override
        public boolean isShowDetailedJettyErrors() {
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHandleQueryParseExceptionWithFilterEnabledButMessageMatchAllowedRegex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String errorMessage = <span class="hljs-string">"test exception message"</span>;

    ObjectMapper mockMapper = Mockito.mock(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletRequest request = Mockito.mock(HttpServletRequest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ServletOutputStream outputStream = Mockito.mock(ServletOutputStream<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(response.getOutputStream()).thenReturn(outputStream);

    <span class="hljs-keyword">final</span> AsyncQueryForwardingServlet servlet = <span class="hljs-keyword">new</span> AsyncQueryForwardingServlet(<span class="hljs-keyword">new</span> MapQueryToolChestWarehouse(ImmutableMap.of()), mockMapper, TestHelper.makeSmileMapper(), <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> NoopServiceEmitter(), <span class="hljs-keyword">new</span> NoopRequestLogger(), <span class="hljs-keyword">new</span> DefaultGenericQueryMetricsFactory(), <span class="hljs-keyword">new</span> AuthenticatorMapper(ImmutableMap.of()), <span class="hljs-keyword">new</span> Properties(), <span class="hljs-keyword">new</span> ServerConfig() {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isShowDetailedJettyErrors</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;

        }



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> ErrorResponseTransformStrategy <span class="hljs-title">getErrorResponseTransformStrategy</span><span class="hljs-params">()</span> </span>{

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AllowedRegexErrorResponseTransformStrategy(ImmutableList.of(<span class="hljs-string">"test .*"</span>));

        }

    });

    IOException testException = <span class="hljs-keyword">new</span> IOException(errorMessage);

    servlet.handleQueryParseException(request, response, mockMapper, testException, <span class="hljs-keyword">false</span>);

    ArgumentCaptor&lt;Exception&gt; captor = ArgumentCaptor.forClass(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.verify(mockMapper).writeValue(ArgumentMatchers.eq(outputStream), captor.capture());

    Assert.assertTrue(captor.getValue() <span class="hljs-keyword">instanceof</span> QueryException);

    Assert.assertEquals(<span class="hljs-string">"Unknown exception"</span>, ((QueryException) captor.getValue()).getErrorCode());

    Assert.assertEquals(errorMessage, captor.getValue().getMessage());

    Assert.assertNull(((QueryException) captor.getValue()).getErrorClass());

    Assert.assertNull(((QueryException) captor.getValue()).getHost());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HttpServletResponse <span class="hljs-title">createMockHttpServletResponse</span><span class="hljs-params">(ServletOutputStream outputStream)</span> </span>{
    HttpServletResponse response = Mockito.mock(HttpServletResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(response.getOutputStream()).thenReturn(outputStream);
    <span class="hljs-keyword">return</span> response;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci33">Mock Clone Instance #druid_MCI_33</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.segment.vector.VectorColumnSelectorFactory</code></li>
<li><strong>Test Case Count</strong>: 6</li>
<li><strong>MO Count</strong>: 6</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockVectorColumnSelectorFactory</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> VectorColumnSelectorFactory <span class="hljs-title">createMockVectorColumnSelectorFactory</span><span class="hljs-params">(
      String fieldName,
      ColumnCapabilities columnCapabilities,
      VectorValueSelector valueSelector
  )</span> </span>{
    VectorColumnSelectorFactory selectorFactory = Mockito.mock(VectorColumnSelectorFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Answers</span>.<span class="hljs-title">RETURNS_DEEP_STUBS</span>)</span>;
    Mockito.doReturn(<span class="hljs-keyword">null</span>).when(selectorFactory).getColumnCapabilities(fieldName);
    Mockito.doReturn(valueSelector).when(selectorFactory).makeValueSelector(fieldName);
    <span class="hljs-keyword">if</span> (columnCapabilities != <span class="hljs-keyword">null</span>) {
      Mockito.doReturn(columnCapabilities).when(selectorFactory).getColumnCapabilities(fieldName);
    }
    <span class="hljs-keyword">return</span> selectorFactory;
  }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest331">Test Case ID #druid_Test_33_1</h4>
<h4 id="test-case-name-factorizevectorfornumerictypeshouldreturndoublevectoraggregatorfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidqueryaggregationanydoubleanyaggregatorfactorytestjava">Test Case Name: <code>factorizeVectorForNumericTypeShouldReturnDoubleVectorAggregator</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\aggregation\any\DoubleAnyAggregatorFactoryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-selectorfactory">Mock Object Variable Name: <code>selectorFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original.java</span>
<span class="hljs-comment">+++ refactored.java</span>
@@
    Mockito.doReturn(null).when(selectorFactory).getColumnCapabilities(FIELD_NAME);
    Mockito.doReturn(valueSelector).when(selectorFactory).makeValueSelector(FIELD_NAME);
    target = new DoubleAnyAggregatorFactory(NAME, FIELD_NAME);
}

@Test
public void factorizeVectorForNumericTypeShouldReturnDoubleVectorAggregator() {
<span class="hljs-deletion">-    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);</span>
<span class="hljs-addition">+    selectorFactory = MockVectorColumnSelectorFactory.createMockVectorColumnSelectorFactory(FIELD_NAME, capabilities, valueSelector);</span>
    Mockito.doReturn(true).when(capabilities).isNumeric();
    VectorAggregator aggregator = target.factorizeVector(selectorFactory);
    Assert.assertNotNull(aggregator);
    Assert.assertEquals(DoubleAnyVectorAggregator.class, aggregator.getClass());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{

    Mockito.doReturn(<span class="hljs-keyword">null</span>).when(selectorFactory).getColumnCapabilities(FIELD_NAME);

    Mockito.doReturn(valueSelector).when(selectorFactory).makeValueSelector(FIELD_NAME);

    target = <span class="hljs-keyword">new</span> DoubleAnyAggregatorFactory(NAME, FIELD_NAME);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">factorizeVectorForNumericTypeShouldReturnDoubleVectorAggregator</span><span class="hljs-params">()</span> </span>{

    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);

    Mockito.doReturn(<span class="hljs-keyword">true</span>).when(capabilities).isNumeric();

    VectorAggregator aggregator = target.factorizeVector(selectorFactory);

    Assert.assertNotNull(aggregator);

    Assert.assertEquals(DoubleAnyVectorAggregator<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">aggregator</span>.<span class="hljs-title">getClass</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockVectorColumnSelectorFactory</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> VectorColumnSelectorFactory <span class="hljs-title">createMockVectorColumnSelectorFactory</span><span class="hljs-params">(
      String fieldName,
      ColumnCapabilities columnCapabilities,
      VectorValueSelector valueSelector
  )</span> </span>{
    VectorColumnSelectorFactory selectorFactory = Mockito.mock(VectorColumnSelectorFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Answers</span>.<span class="hljs-title">RETURNS_DEEP_STUBS</span>)</span>;
    Mockito.doReturn(<span class="hljs-keyword">null</span>).when(selectorFactory).getColumnCapabilities(fieldName);
    Mockito.doReturn(valueSelector).when(selectorFactory).makeValueSelector(fieldName);
    <span class="hljs-keyword">if</span> (columnCapabilities != <span class="hljs-keyword">null</span>) {
      Mockito.doReturn(columnCapabilities).when(selectorFactory).getColumnCapabilities(fieldName);
    }
    <span class="hljs-keyword">return</span> selectorFactory;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest332">Test Case ID #druid_Test_33_2</h4>
<h4 id="test-case-name-factorizevectorforstringtypeshouldreturndoublevectoraggregatorwithnilselectorfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidqueryaggregationanydoubleanyaggregatorfactorytestjava">Test Case Name: <code>factorizeVectorForStringTypeShouldReturnDoubleVectorAggregatorWithNilSelector</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\aggregation\any\DoubleAnyAggregatorFactoryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-selectorfactory">Mock Object Variable Name: <code>selectorFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- Original.java</span>
<span class="hljs-comment">+++ Refactored.java</span>
@@
    @Before
    public void setUp() {
<span class="hljs-deletion">-    Mockito.doReturn(null).when(selectorFactory).getColumnCapabilities(FIELD_NAME);</span>
<span class="hljs-deletion">-    Mockito.doReturn(valueSelector).when(selectorFactory).makeValueSelector(FIELD_NAME);</span>
        target = new DoubleAnyAggregatorFactory(NAME, FIELD_NAME);
    }

    @Test
    public void factorizeVectorForStringTypeShouldReturnDoubleVectorAggregatorWithNilSelector() {
<span class="hljs-deletion">-    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);</span>
<span class="hljs-addition">+    selectorFactory = MockVectorColumnSelectorFactory.createMockVectorColumnSelectorFactory(FIELD_NAME, capabilities, valueSelector);</span>
        VectorAggregator aggregator = target.factorizeVector(selectorFactory);
        Assert.assertNotNull(aggregator);
        Assert.assertEquals(NullHandling.defaultDoubleValue(), aggregator.get(BUFFER, POSITION));
    }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{

    Mockito.doReturn(<span class="hljs-keyword">null</span>).when(selectorFactory).getColumnCapabilities(FIELD_NAME);

    Mockito.doReturn(valueSelector).when(selectorFactory).makeValueSelector(FIELD_NAME);

    target = <span class="hljs-keyword">new</span> DoubleAnyAggregatorFactory(NAME, FIELD_NAME);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">factorizeVectorForStringTypeShouldReturnDoubleVectorAggregatorWithNilSelector</span><span class="hljs-params">()</span> </span>{

    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);

    Mockito.doReturn(<span class="hljs-keyword">false</span>).when(capabilities).isNumeric();

    VectorAggregator aggregator = target.factorizeVector(selectorFactory);

    Assert.assertNotNull(aggregator);

    Assert.assertEquals(NullHandling.defaultDoubleValue(), aggregator.get(BUFFER, POSITION));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockVectorColumnSelectorFactory</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> VectorColumnSelectorFactory <span class="hljs-title">createMockVectorColumnSelectorFactory</span><span class="hljs-params">(
      String fieldName,
      ColumnCapabilities columnCapabilities,
      VectorValueSelector valueSelector
  )</span> </span>{
    VectorColumnSelectorFactory selectorFactory = Mockito.mock(VectorColumnSelectorFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Answers</span>.<span class="hljs-title">RETURNS_DEEP_STUBS</span>)</span>;
    Mockito.doReturn(<span class="hljs-keyword">null</span>).when(selectorFactory).getColumnCapabilities(fieldName);
    Mockito.doReturn(valueSelector).when(selectorFactory).makeValueSelector(fieldName);
    <span class="hljs-keyword">if</span> (columnCapabilities != <span class="hljs-keyword">null</span>) {
      Mockito.doReturn(columnCapabilities).when(selectorFactory).getColumnCapabilities(fieldName);
    }
    <span class="hljs-keyword">return</span> selectorFactory;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest333">Test Case ID #druid_Test_33_3</h4>
<h4 id="test-case-name-factorizevectorfornumerictypeshouldreturnfloatvectoraggregatorfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidqueryaggregationanyfloatanyaggregatorfactorytestjava">Test Case Name: <code>factorizeVectorForNumericTypeShouldReturnFloatVectorAggregator</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\aggregation\any\FloatAnyAggregatorFactoryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-selectorfactory">Mock Object Variable Name: <code>selectorFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- Original.java</span>
<span class="hljs-comment">+++ Refactored.java</span>
@@
    @Before
    public void setUp() {
<span class="hljs-deletion">-    Mockito.doReturn(null).when(selectorFactory).getColumnCapabilities(FIELD_NAME);</span>
<span class="hljs-deletion">-    Mockito.doReturn(valueSelector).when(selectorFactory).makeValueSelector(FIELD_NAME);</span>
        target = new FloatAnyAggregatorFactory(NAME, FIELD_NAME);
    }

    @Test
    public void factorizeVectorForNumericTypeShouldReturnFloatVectorAggregator() {
<span class="hljs-deletion">-    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);</span>
<span class="hljs-addition">+    selectorFactory = MockVectorColumnSelectorFactory.createMockVectorColumnSelectorFactory(FIELD_NAME, capabilities, valueSelector);</span>
        Mockito.doReturn(true).when(capabilities).isNumeric();
        VectorAggregator aggregator = target.factorizeVector(selectorFactory);
        Assert.assertNotNull(aggregator);
        Assert.assertEquals(FloatAnyVectorAggregator.class, aggregator.getClass());
    }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">factorizeVectorForNumericTypeShouldReturnFloatVectorAggregator</span><span class="hljs-params">()</span> </span>{

    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);

    Mockito.doReturn(<span class="hljs-keyword">true</span>).when(capabilities).isNumeric();

    VectorAggregator aggregator = target.factorizeVector(selectorFactory);

    Assert.assertNotNull(aggregator);

    Assert.assertEquals(FloatAnyVectorAggregator<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">aggregator</span>.<span class="hljs-title">getClass</span>())</span>;

}
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{

    Mockito.doReturn(<span class="hljs-keyword">null</span>).when(selectorFactory).getColumnCapabilities(FIELD_NAME);

    Mockito.doReturn(valueSelector).when(selectorFactory).makeValueSelector(FIELD_NAME);

    target = <span class="hljs-keyword">new</span> FloatAnyAggregatorFactory(NAME, FIELD_NAME);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockVectorColumnSelectorFactory</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> VectorColumnSelectorFactory <span class="hljs-title">createMockVectorColumnSelectorFactory</span><span class="hljs-params">(
      String fieldName,
      ColumnCapabilities columnCapabilities,
      VectorValueSelector valueSelector
  )</span> </span>{
    VectorColumnSelectorFactory selectorFactory = Mockito.mock(VectorColumnSelectorFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Answers</span>.<span class="hljs-title">RETURNS_DEEP_STUBS</span>)</span>;
    Mockito.doReturn(<span class="hljs-keyword">null</span>).when(selectorFactory).getColumnCapabilities(fieldName);
    Mockito.doReturn(valueSelector).when(selectorFactory).makeValueSelector(fieldName);
    <span class="hljs-keyword">if</span> (columnCapabilities != <span class="hljs-keyword">null</span>) {
      Mockito.doReturn(columnCapabilities).when(selectorFactory).getColumnCapabilities(fieldName);
    }
    <span class="hljs-keyword">return</span> selectorFactory;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest334">Test Case ID #druid_Test_33_4</h4>
<h4 id="test-case-name-factorizevectorforstringtypeshouldreturnfloatvectoraggregatorwithnilselectorfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidqueryaggregationanyfloatanyaggregatorfactorytestjava">Test Case Name: <code>factorizeVectorForStringTypeShouldReturnFloatVectorAggregatorWithNilSelector</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\aggregation\any\FloatAnyAggregatorFactoryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-selectorfactory">Mock Object Variable Name: <code>selectorFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void factorizeVectorForStringTypeShouldReturnFloatVectorAggregatorWithNilSelector() {
<span class="hljs-deletion">-    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);</span>
<span class="hljs-addition">+    selectorFactory = MockVectorColumnSelectorFactory.createMockVectorColumnSelectorFactory(FIELD_NAME, capabilities, valueSelector);</span>
     Mockito.doReturn(false).when(capabilities).isNumeric();
     VectorAggregator aggregator = target.factorizeVector(selectorFactory);
     Assert.assertNotNull(aggregator);
     Assert.assertEquals(NullHandling.defaultFloatValue(), aggregator.get(BUFFER, POSITION));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">factorizeVectorForStringTypeShouldReturnFloatVectorAggregatorWithNilSelector</span><span class="hljs-params">()</span> </span>{

    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);

    Mockito.doReturn(<span class="hljs-keyword">false</span>).when(capabilities).isNumeric();

    VectorAggregator aggregator = target.factorizeVector(selectorFactory);

    Assert.assertNotNull(aggregator);

    Assert.assertEquals(NullHandling.defaultFloatValue(), aggregator.get(BUFFER, POSITION));

}
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{

    Mockito.doReturn(<span class="hljs-keyword">null</span>).when(selectorFactory).getColumnCapabilities(FIELD_NAME);

    Mockito.doReturn(valueSelector).when(selectorFactory).makeValueSelector(FIELD_NAME);

    target = <span class="hljs-keyword">new</span> FloatAnyAggregatorFactory(NAME, FIELD_NAME);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockVectorColumnSelectorFactory</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> VectorColumnSelectorFactory <span class="hljs-title">createMockVectorColumnSelectorFactory</span><span class="hljs-params">(
      String fieldName,
      ColumnCapabilities columnCapabilities,
      VectorValueSelector valueSelector
  )</span> </span>{
    VectorColumnSelectorFactory selectorFactory = Mockito.mock(VectorColumnSelectorFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Answers</span>.<span class="hljs-title">RETURNS_DEEP_STUBS</span>)</span>;
    Mockito.doReturn(<span class="hljs-keyword">null</span>).when(selectorFactory).getColumnCapabilities(fieldName);
    Mockito.doReturn(valueSelector).when(selectorFactory).makeValueSelector(fieldName);
    <span class="hljs-keyword">if</span> (columnCapabilities != <span class="hljs-keyword">null</span>) {
      Mockito.doReturn(columnCapabilities).when(selectorFactory).getColumnCapabilities(fieldName);
    }
    <span class="hljs-keyword">return</span> selectorFactory;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest335">Test Case ID #druid_Test_33_5</h4>
<h4 id="test-case-name-factorizevectorwithnumericcolumnshouldreturnlongvectoraggregatorfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidqueryaggregationanylonganyaggregatorfactorytestjava">Test Case Name: <code>factorizeVectorWithNumericColumnShouldReturnLongVectorAggregator</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\aggregation\any\LongAnyAggregatorFactoryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-selectorfactory">Mock Object Variable Name: <code>selectorFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original.java</span>
<span class="hljs-comment">+++ refactored.java</span>
@@
    Mockito.doReturn(valueSelector).when(selectorFactory).makeValueSelector(FIELD_NAME);
    target = new LongAnyAggregatorFactory(NAME, FIELD_NAME);
}

@Test
public void factorizeVectorWithNumericColumnShouldReturnLongVectorAggregator() {
<span class="hljs-deletion">-    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);</span>
<span class="hljs-addition">+    selectorFactory = MockVectorColumnSelectorFactory.createMockVectorColumnSelectorFactory(FIELD_NAME, capabilities, valueSelector);</span>
    Mockito.doReturn(true).when(capabilities).isNumeric();
    VectorAggregator aggregator = target.factorizeVector(selectorFactory);
    Assert.assertNotNull(aggregator);
    Assert.assertEquals(LongAnyVectorAggregator.class, aggregator.getClass());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">factorizeVectorWithNumericColumnShouldReturnLongVectorAggregator</span><span class="hljs-params">()</span> </span>{

    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);

    Mockito.doReturn(<span class="hljs-keyword">true</span>).when(capabilities).isNumeric();

    VectorAggregator aggregator = target.factorizeVector(selectorFactory);

    Assert.assertNotNull(aggregator);

    Assert.assertEquals(LongAnyVectorAggregator<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">aggregator</span>.<span class="hljs-title">getClass</span>())</span>;

}
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{

    Mockito.doReturn(<span class="hljs-keyword">null</span>).when(selectorFactory).getColumnCapabilities(FIELD_NAME);

    Mockito.doReturn(valueSelector).when(selectorFactory).makeValueSelector(FIELD_NAME);

    target = <span class="hljs-keyword">new</span> LongAnyAggregatorFactory(NAME, FIELD_NAME);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockVectorColumnSelectorFactory</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> VectorColumnSelectorFactory <span class="hljs-title">createMockVectorColumnSelectorFactory</span><span class="hljs-params">(
      String fieldName,
      ColumnCapabilities columnCapabilities,
      VectorValueSelector valueSelector
  )</span> </span>{
    VectorColumnSelectorFactory selectorFactory = Mockito.mock(VectorColumnSelectorFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Answers</span>.<span class="hljs-title">RETURNS_DEEP_STUBS</span>)</span>;
    Mockito.doReturn(<span class="hljs-keyword">null</span>).when(selectorFactory).getColumnCapabilities(fieldName);
    Mockito.doReturn(valueSelector).when(selectorFactory).makeValueSelector(fieldName);
    <span class="hljs-keyword">if</span> (columnCapabilities != <span class="hljs-keyword">null</span>) {
      Mockito.doReturn(columnCapabilities).when(selectorFactory).getColumnCapabilities(fieldName);
    }
    <span class="hljs-keyword">return</span> selectorFactory;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest336">Test Case ID #druid_Test_33_6</h4>
<h4 id="test-case-name-factorizevectorforstringtypeshouldreturnlongvectoraggregatorwithnilselectorfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidqueryaggregationanylonganyaggregatorfactorytestjava">Test Case Name: <code>factorizeVectorForStringTypeShouldReturnLongVectorAggregatorWithNilSelector</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\aggregation\any\LongAnyAggregatorFactoryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-selectorfactory">Mock Object Variable Name: <code>selectorFactory</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void factorizeVectorForStringTypeShouldReturnLongVectorAggregatorWithNilSelector() {
<span class="hljs-deletion">-    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);</span>
<span class="hljs-addition">+    selectorFactory = MockVectorColumnSelectorFactory.createMockVectorColumnSelectorFactory(FIELD_NAME, capabilities, valueSelector);</span>
     Mockito.doReturn(false).when(capabilities).isNumeric();
     VectorAggregator aggregator = target.factorizeVector(selectorFactory);
     Assert.assertNotNull(aggregator);
     Assert.assertEquals(NullHandling.defaultLongValue(), aggregator.get(BUFFER, POSITION));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">factorizeVectorForStringTypeShouldReturnLongVectorAggregatorWithNilSelector</span><span class="hljs-params">()</span> </span>{

    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);

    Mockito.doReturn(<span class="hljs-keyword">false</span>).when(capabilities).isNumeric();

    VectorAggregator aggregator = target.factorizeVector(selectorFactory);

    Assert.assertNotNull(aggregator);

    Assert.assertEquals(NullHandling.defaultLongValue(), aggregator.get(BUFFER, POSITION));

}
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{

    Mockito.doReturn(<span class="hljs-keyword">null</span>).when(selectorFactory).getColumnCapabilities(FIELD_NAME);

    Mockito.doReturn(valueSelector).when(selectorFactory).makeValueSelector(FIELD_NAME);

    target = <span class="hljs-keyword">new</span> LongAnyAggregatorFactory(NAME, FIELD_NAME);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockVectorColumnSelectorFactory</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> VectorColumnSelectorFactory <span class="hljs-title">createMockVectorColumnSelectorFactory</span><span class="hljs-params">(
      String fieldName,
      ColumnCapabilities columnCapabilities,
      VectorValueSelector valueSelector
  )</span> </span>{
    VectorColumnSelectorFactory selectorFactory = Mockito.mock(VectorColumnSelectorFactory<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Answers</span>.<span class="hljs-title">RETURNS_DEEP_STUBS</span>)</span>;
    Mockito.doReturn(<span class="hljs-keyword">null</span>).when(selectorFactory).getColumnCapabilities(fieldName);
    Mockito.doReturn(valueSelector).when(selectorFactory).makeValueSelector(fieldName);
    <span class="hljs-keyword">if</span> (columnCapabilities != <span class="hljs-keyword">null</span>) {
      Mockito.doReturn(columnCapabilities).when(selectorFactory).getColumnCapabilities(fieldName);
    }
    <span class="hljs-keyword">return</span> selectorFactory;
  }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci34">Mock Clone Instance #druid_MCI_34</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>oshi.software.os.OSFileStore</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> OSFileStore <span class="hljs-title">createMockOSFileStore</span><span class="hljs-params">(<span class="hljs-keyword">long</span> totalSpace, <span class="hljs-keyword">long</span> usableSpace, <span class="hljs-keyword">long</span> totalInodes, <span class="hljs-keyword">long</span> freeInodes, String volume, String mount)</span> </span>{
    OSFileStore mock = Mockito.mock(OSFileStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(mock.getTotalSpace()).thenReturn(totalSpace);
    Mockito.when(mock.getUsableSpace()).thenReturn(usableSpace);
    Mockito.when(mock.getTotalInodes()).thenReturn(totalInodes);
    Mockito.when(mock.getFreeInodes()).thenReturn(freeInodes);
    Mockito.when(mock.getVolume()).thenReturn(volume);
    Mockito.when(mock.getMount()).thenReturn(mount);
    <span class="hljs-keyword">return</span> mock;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest341">Test Case ID #druid_Test_34_1</h4>
<h4 id="test-case-name-testfsstatsfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidjavautilmetricsoshisysmonitortestjava">Test Case Name: <code>testFsStats</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\java\util\metrics\OshiSysMonitorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-fs1">Mock Object Variable Name: <code>fs1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    FileSystem fileSystem = Mockito.mock(FileSystem.class);
<span class="hljs-deletion">-    OSFileStore fs1 = Mockito.mock(OSFileStore.class);</span>
<span class="hljs-addition">+    OSFileStore fs1 = createMockOSFileStore(300L, 200L, 1000L, 700L, "/dev/disk1", "/System/Volumes/boot1");</span>
    OSFileStore fs2 = Mockito.mock(OSFileStore.class);
<span class="hljs-deletion">-    Mockito.when(fs1.getTotalSpace()).thenReturn(300L);</span>
<span class="hljs-deletion">-    Mockito.when(fs1.getUsableSpace()).thenReturn(200L);</span>
<span class="hljs-deletion">-    Mockito.when(fs1.getTotalInodes()).thenReturn(1000L);</span>
<span class="hljs-deletion">-    Mockito.when(fs1.getFreeInodes()).thenReturn(700L);</span>
<span class="hljs-deletion">-    Mockito.when(fs1.getVolume()).thenReturn("/dev/disk1");</span>
<span class="hljs-deletion">-    Mockito.when(fs1.getMount()).thenReturn("/System/Volumes/boot1");</span>
    Mockito.when(fs2.getTotalSpace()).thenReturn(400L);
    Mockito.when(fs2.getUsableSpace()).thenReturn(320L);
    Mockito.when(fs2.getTotalInodes()).thenReturn(800L);
    Mockito.when(fs2.getFreeInodes()).thenReturn(600L);
    Mockito.when(fs2.getVolume()).thenReturn("/dev/disk2");
    Mockito.when(fs2.getMount()).thenReturn("/System/Volumes/boot2");
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFsStats</span><span class="hljs-params">()</span> </span>{

    StubServiceEmitter emitter = <span class="hljs-keyword">new</span> StubServiceEmitter(<span class="hljs-string">"dev/monitor-test"</span>, <span class="hljs-string">"localhost:0000"</span>);

    FileSystem fileSystem = Mockito.mock(FileSystem<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    OSFileStore fs1 = Mockito.mock(OSFileStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    OSFileStore fs2 = Mockito.mock(OSFileStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(fs1.getTotalSpace()).thenReturn(<span class="hljs-number">300L</span>);

    Mockito.when(fs1.getUsableSpace()).thenReturn(<span class="hljs-number">200L</span>);

    Mockito.when(fs1.getTotalInodes()).thenReturn(<span class="hljs-number">1000L</span>);

    Mockito.when(fs1.getFreeInodes()).thenReturn(<span class="hljs-number">700L</span>);

    Mockito.when(fs1.getVolume()).thenReturn(<span class="hljs-string">"/dev/disk1"</span>);

    Mockito.when(fs1.getMount()).thenReturn(<span class="hljs-string">"/System/Volumes/boot1"</span>);

    Mockito.when(fs2.getTotalSpace()).thenReturn(<span class="hljs-number">400L</span>);

    Mockito.when(fs2.getUsableSpace()).thenReturn(<span class="hljs-number">320L</span>);

    Mockito.when(fs2.getTotalInodes()).thenReturn(<span class="hljs-number">800L</span>);

    Mockito.when(fs2.getFreeInodes()).thenReturn(<span class="hljs-number">600L</span>);

    Mockito.when(fs2.getVolume()).thenReturn(<span class="hljs-string">"/dev/disk2"</span>);

    Mockito.when(fs2.getMount()).thenReturn(<span class="hljs-string">"/System/Volumes/boot2"</span>);

    List&lt;OSFileStore&gt; osFileStores = ImmutableList.of(fs1, fs2);

    Mockito.when(fileSystem.getFileStores(<span class="hljs-keyword">true</span>)).thenReturn(osFileStores);

    Mockito.when(os.getFileSystem()).thenReturn(fileSystem);

    OshiSysMonitor m = <span class="hljs-keyword">new</span> OshiSysMonitor(si);

    m.start();

    m.monitorFsStats(emitter);

    Assert.assertEquals(<span class="hljs-number">8</span>, emitter.getEvents().size());

    emitter.verifyEmitted(<span class="hljs-string">"sys/fs/max"</span>, <span class="hljs-number">2</span>);

    emitter.verifyEmitted(<span class="hljs-string">"sys/fs/used"</span>, <span class="hljs-number">2</span>);

    emitter.verifyEmitted(<span class="hljs-string">"sys/fs/files/count"</span>, <span class="hljs-number">2</span>);

    emitter.verifyEmitted(<span class="hljs-string">"sys/fs/files/free"</span>, <span class="hljs-number">2</span>);

    Map&lt;String, Object&gt; userDims1 = ImmutableMap.of(<span class="hljs-string">"fsDevName"</span>, <span class="hljs-string">"/dev/disk1"</span>, <span class="hljs-string">"fsDirName"</span>, <span class="hljs-string">"/System/Volumes/boot1"</span>);

    List&lt;Number&gt; metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/fs/max"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">300L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/fs/used"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">100L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/fs/files/count"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">1000L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/fs/files/free"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">700L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    Map&lt;String, Object&gt; userDims2 = ImmutableMap.of(<span class="hljs-string">"fsDevName"</span>, <span class="hljs-string">"/dev/disk2"</span>, <span class="hljs-string">"fsDirName"</span>, <span class="hljs-string">"/System/Volumes/boot2"</span>);

    List&lt;Number&gt; metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/fs/max"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">400L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/fs/used"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">80L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/fs/files/count"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">800L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/fs/files/free"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">600L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    m.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> OSFileStore <span class="hljs-title">createMockOSFileStore</span><span class="hljs-params">(<span class="hljs-keyword">long</span> totalSpace, <span class="hljs-keyword">long</span> usableSpace, <span class="hljs-keyword">long</span> totalInodes, <span class="hljs-keyword">long</span> freeInodes, String volume, String mount)</span> </span>{
    OSFileStore mock = Mockito.mock(OSFileStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(mock.getTotalSpace()).thenReturn(totalSpace);
    Mockito.when(mock.getUsableSpace()).thenReturn(usableSpace);
    Mockito.when(mock.getTotalInodes()).thenReturn(totalInodes);
    Mockito.when(mock.getFreeInodes()).thenReturn(freeInodes);
    Mockito.when(mock.getVolume()).thenReturn(volume);
    Mockito.when(mock.getMount()).thenReturn(mount);
    <span class="hljs-keyword">return</span> mock;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest342">Test Case ID #druid_Test_34_2</h4>
<h4 id="test-case-name-testfsstatsfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidjavautilmetricsoshisysmonitortestjava">Test Case Name: <code>testFsStats</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\java\util\metrics\OshiSysMonitorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-fs2">Mock Object Variable Name: <code>fs2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    FileSystem fileSystem = Mockito.mock(FileSystem.class);
    OSFileStore fs1 = Mockito.mock(OSFileStore.class);
<span class="hljs-deletion">-    OSFileStore fs2 = Mockito.mock(OSFileStore.class);</span>
<span class="hljs-deletion">-    Mockito.when(fs1.getTotalSpace()).thenReturn(300L);</span>
<span class="hljs-deletion">-    Mockito.when(fs1.getUsableSpace()).thenReturn(200L);</span>
<span class="hljs-deletion">-    Mockito.when(fs1.getTotalInodes()).thenReturn(1000L);</span>
<span class="hljs-deletion">-    Mockito.when(fs1.getFreeInodes()).thenReturn(700L);</span>
<span class="hljs-deletion">-    Mockito.when(fs1.getVolume()).thenReturn("/dev/disk1");</span>
<span class="hljs-deletion">-    Mockito.when(fs1.getMount()).thenReturn("/System/Volumes/boot1");</span>
<span class="hljs-deletion">-    Mockito.when(fs2.getTotalSpace()).thenReturn(400L);</span>
<span class="hljs-deletion">-    Mockito.when(fs2.getUsableSpace()).thenReturn(320L);</span>
<span class="hljs-deletion">-    Mockito.when(fs2.getTotalInodes()).thenReturn(800L);</span>
<span class="hljs-deletion">-    Mockito.when(fs2.getFreeInodes()).thenReturn(600L);</span>
<span class="hljs-deletion">-    Mockito.when(fs2.getVolume()).thenReturn("/dev/disk2");</span>
<span class="hljs-deletion">-    Mockito.when(fs2.getMount()).thenReturn("/System/Volumes/boot2");</span>
<span class="hljs-addition">+    OSFileStore fs2 = createMockOSFileStore(400L, 320L, 800L, 600L, "/dev/disk2", "/System/Volumes/boot2");</span>
<span class="hljs-addition">+    Mockito.when(fs1.getTotalSpace()).thenReturn(300L);</span>
<span class="hljs-addition">+    Mockito.when(fs1.getUsableSpace()).thenReturn(200L);</span>
<span class="hljs-addition">+    Mockito.when(fs1.getTotalInodes()).thenReturn(1000L);</span>
<span class="hljs-addition">+    Mockito.when(fs1.getFreeInodes()).thenReturn(700L);</span>
<span class="hljs-addition">+    Mockito.when(fs1.getVolume()).thenReturn("/dev/disk1");</span>
<span class="hljs-addition">+    Mockito.when(fs1.getMount()).thenReturn("/System/Volumes/boot1");</span>
    List&lt;OSFileStore&gt; osFileStores = ImmutableList.of(fs1, fs2);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFsStats</span><span class="hljs-params">()</span> </span>{

    StubServiceEmitter emitter = <span class="hljs-keyword">new</span> StubServiceEmitter(<span class="hljs-string">"dev/monitor-test"</span>, <span class="hljs-string">"localhost:0000"</span>);

    FileSystem fileSystem = Mockito.mock(FileSystem<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    OSFileStore fs1 = Mockito.mock(OSFileStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    OSFileStore fs2 = Mockito.mock(OSFileStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(fs1.getTotalSpace()).thenReturn(<span class="hljs-number">300L</span>);

    Mockito.when(fs1.getUsableSpace()).thenReturn(<span class="hljs-number">200L</span>);

    Mockito.when(fs1.getTotalInodes()).thenReturn(<span class="hljs-number">1000L</span>);

    Mockito.when(fs1.getFreeInodes()).thenReturn(<span class="hljs-number">700L</span>);

    Mockito.when(fs1.getVolume()).thenReturn(<span class="hljs-string">"/dev/disk1"</span>);

    Mockito.when(fs1.getMount()).thenReturn(<span class="hljs-string">"/System/Volumes/boot1"</span>);

    Mockito.when(fs2.getTotalSpace()).thenReturn(<span class="hljs-number">400L</span>);

    Mockito.when(fs2.getUsableSpace()).thenReturn(<span class="hljs-number">320L</span>);

    Mockito.when(fs2.getTotalInodes()).thenReturn(<span class="hljs-number">800L</span>);

    Mockito.when(fs2.getFreeInodes()).thenReturn(<span class="hljs-number">600L</span>);

    Mockito.when(fs2.getVolume()).thenReturn(<span class="hljs-string">"/dev/disk2"</span>);

    Mockito.when(fs2.getMount()).thenReturn(<span class="hljs-string">"/System/Volumes/boot2"</span>);

    List&lt;OSFileStore&gt; osFileStores = ImmutableList.of(fs1, fs2);

    Mockito.when(fileSystem.getFileStores(<span class="hljs-keyword">true</span>)).thenReturn(osFileStores);

    Mockito.when(os.getFileSystem()).thenReturn(fileSystem);

    OshiSysMonitor m = <span class="hljs-keyword">new</span> OshiSysMonitor(si);

    m.start();

    m.monitorFsStats(emitter);

    Assert.assertEquals(<span class="hljs-number">8</span>, emitter.getEvents().size());

    emitter.verifyEmitted(<span class="hljs-string">"sys/fs/max"</span>, <span class="hljs-number">2</span>);

    emitter.verifyEmitted(<span class="hljs-string">"sys/fs/used"</span>, <span class="hljs-number">2</span>);

    emitter.verifyEmitted(<span class="hljs-string">"sys/fs/files/count"</span>, <span class="hljs-number">2</span>);

    emitter.verifyEmitted(<span class="hljs-string">"sys/fs/files/free"</span>, <span class="hljs-number">2</span>);

    Map&lt;String, Object&gt; userDims1 = ImmutableMap.of(<span class="hljs-string">"fsDevName"</span>, <span class="hljs-string">"/dev/disk1"</span>, <span class="hljs-string">"fsDirName"</span>, <span class="hljs-string">"/System/Volumes/boot1"</span>);

    List&lt;Number&gt; metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/fs/max"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">300L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/fs/used"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">100L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/fs/files/count"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">1000L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/fs/files/free"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">700L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    Map&lt;String, Object&gt; userDims2 = ImmutableMap.of(<span class="hljs-string">"fsDevName"</span>, <span class="hljs-string">"/dev/disk2"</span>, <span class="hljs-string">"fsDirName"</span>, <span class="hljs-string">"/System/Volumes/boot2"</span>);

    List&lt;Number&gt; metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/fs/max"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">400L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/fs/used"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">80L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/fs/files/count"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">800L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/fs/files/free"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">600L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    m.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> OSFileStore <span class="hljs-title">createMockOSFileStore</span><span class="hljs-params">(<span class="hljs-keyword">long</span> totalSpace, <span class="hljs-keyword">long</span> usableSpace, <span class="hljs-keyword">long</span> totalInodes, <span class="hljs-keyword">long</span> freeInodes, String volume, String mount)</span> </span>{
    OSFileStore mock = Mockito.mock(OSFileStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(mock.getTotalSpace()).thenReturn(totalSpace);
    Mockito.when(mock.getUsableSpace()).thenReturn(usableSpace);
    Mockito.when(mock.getTotalInodes()).thenReturn(totalInodes);
    Mockito.when(mock.getFreeInodes()).thenReturn(freeInodes);
    Mockito.when(mock.getVolume()).thenReturn(volume);
    Mockito.when(mock.getMount()).thenReturn(mount);
    <span class="hljs-keyword">return</span> mock;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci35">Mock Clone Instance #druid_MCI_35</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.query.aggregation.AggregatorAdapters</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AggregatorAdapters <span class="hljs-title">createMockAggregatorAdapters</span><span class="hljs-params">(<span class="hljs-keyword">int</span> spaceNeededReturn)</span> </span>{
    AggregatorAdapters aggregatorAdapters = Mockito.mock(AggregatorAdapters<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(aggregatorAdapters.spaceNeeded()).thenReturn(spaceNeededReturn);
    <span class="hljs-keyword">return</span> aggregatorAdapters;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest351">Test Case ID #druid_Test_35_1</h4>
<h4 id="test-case-name-testgrowoncefile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaehashvectorgroupertestjava">Test Case Name: <code>testGrowOnce</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\HashVectorGrouperTest.java</code>)</h4>
<h4 id="mock-object-variable-name-aggregatoradapters">Mock Object Variable Name: <code>aggregatorAdapters</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final int keySize = 4;
    final int aggSize = 8;
    final WritableMemory keySpace = WritableMemory.allocate(keySize * maxVectorSize);
<span class="hljs-deletion">-    final AggregatorAdapters aggregatorAdapters = Mockito.mock(AggregatorAdapters.class);</span>
<span class="hljs-deletion">-    Mockito.when(aggregatorAdapters.spaceNeeded()).thenReturn(aggSize);</span>
<span class="hljs-addition">+    final AggregatorAdapters aggregatorAdapters = createMockAggregatorAdapters(aggSize);</span>
    int startingNumBuckets = 4;
    int maxBuckets = 16;
    final int bufferSize = (keySize + aggSize) * maxBuckets;
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGrowOnce</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> maxVectorSize = <span class="hljs-number">512</span>;

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> keySize = <span class="hljs-number">4</span>;

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> aggSize = <span class="hljs-number">8</span>;

    <span class="hljs-keyword">final</span> WritableMemory keySpace = WritableMemory.allocate(keySize * maxVectorSize);

    <span class="hljs-keyword">final</span> AggregatorAdapters aggregatorAdapters = Mockito.mock(AggregatorAdapters<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(aggregatorAdapters.spaceNeeded()).thenReturn(aggSize);

    <span class="hljs-keyword">int</span> startingNumBuckets = <span class="hljs-number">4</span>;

    <span class="hljs-keyword">int</span> maxBuckets = <span class="hljs-number">16</span>;

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> bufferSize = (keySize + aggSize) * maxBuckets;

    <span class="hljs-keyword">final</span> ByteBuffer buffer = ByteBuffer.wrap(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[bufferSize]);

    <span class="hljs-keyword">final</span> HashVectorGrouper grouper = <span class="hljs-keyword">new</span> HashVectorGrouper(Suppliers.ofInstance(buffer), keySize, aggregatorAdapters, maxBuckets, <span class="hljs-number">0</span>.f, startingNumBuckets);

    grouper.initVectorized(maxVectorSize);

    <span class="hljs-keyword">int</span> tableStart = grouper.getTableStart();

    <span class="hljs-comment">// two keys should not cause buffer to grow</span>

    fillKeyspace(keySpace, maxVectorSize, <span class="hljs-number">2</span>);

    AggregateResult result = grouper.aggregateVector(keySpace, <span class="hljs-number">0</span>, maxVectorSize);

    Assert.assertTrue(result.isOk());

    Assert.assertEquals(tableStart, grouper.getTableStart());

    <span class="hljs-comment">// 3rd key should cause buffer to grow</span>

    <span class="hljs-comment">// buffer should grow to maximum size</span>

    fillKeyspace(keySpace, maxVectorSize, <span class="hljs-number">3</span>);

    result = grouper.aggregateVector(keySpace, <span class="hljs-number">0</span>, maxVectorSize);

    Assert.assertTrue(result.isOk());

    Assert.assertEquals(<span class="hljs-number">0</span>, grouper.getTableStart());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AggregatorAdapters <span class="hljs-title">createMockAggregatorAdapters</span><span class="hljs-params">(<span class="hljs-keyword">int</span> spaceNeededReturn)</span> </span>{
    AggregatorAdapters aggregatorAdapters = Mockito.mock(AggregatorAdapters<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(aggregatorAdapters.spaceNeeded()).thenReturn(spaceNeededReturn);
    <span class="hljs-keyword">return</span> aggregatorAdapters;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest352">Test Case ID #druid_Test_35_2</h4>
<h4 id="test-case-name-testgrowtwicefile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaehashvectorgroupertestjava">Test Case Name: <code>testGrowTwice</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\HashVectorGrouperTest.java</code>)</h4>
<h4 id="mock-object-variable-name-aggregatoradapters">Mock Object Variable Name: <code>aggregatorAdapters</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final int keySize = 4;
    final int aggSize = 8;
    final WritableMemory keySpace = WritableMemory.allocate(keySize * maxVectorSize);
<span class="hljs-deletion">-    final AggregatorAdapters aggregatorAdapters = Mockito.mock(AggregatorAdapters.class);</span>
<span class="hljs-deletion">-    Mockito.when(aggregatorAdapters.spaceNeeded()).thenReturn(aggSize);</span>
<span class="hljs-addition">+    final AggregatorAdapters aggregatorAdapters = createMockAggregatorAdapters(aggSize);</span>
    int startingNumBuckets = 4;
    int maxBuckets = 32;
    final int bufferSize = (keySize + aggSize) * maxBuckets;
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGrowTwice</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> maxVectorSize = <span class="hljs-number">512</span>;

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> keySize = <span class="hljs-number">4</span>;

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> aggSize = <span class="hljs-number">8</span>;

    <span class="hljs-keyword">final</span> WritableMemory keySpace = WritableMemory.allocate(keySize * maxVectorSize);

    <span class="hljs-keyword">final</span> AggregatorAdapters aggregatorAdapters = Mockito.mock(AggregatorAdapters<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(aggregatorAdapters.spaceNeeded()).thenReturn(aggSize);

    <span class="hljs-keyword">int</span> startingNumBuckets = <span class="hljs-number">4</span>;

    <span class="hljs-keyword">int</span> maxBuckets = <span class="hljs-number">32</span>;

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> bufferSize = (keySize + aggSize) * maxBuckets;

    <span class="hljs-keyword">final</span> ByteBuffer buffer = ByteBuffer.wrap(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[bufferSize]);

    <span class="hljs-keyword">final</span> HashVectorGrouper grouper = <span class="hljs-keyword">new</span> HashVectorGrouper(Suppliers.ofInstance(buffer), keySize, aggregatorAdapters, maxBuckets, <span class="hljs-number">0</span>.f, startingNumBuckets);

    grouper.initVectorized(maxVectorSize);

    <span class="hljs-keyword">int</span> tableStart = grouper.getTableStart();

    <span class="hljs-comment">// two keys should not cause buffer to grow</span>

    fillKeyspace(keySpace, maxVectorSize, <span class="hljs-number">2</span>);

    AggregateResult result = grouper.aggregateVector(keySpace, <span class="hljs-number">0</span>, maxVectorSize);

    Assert.assertTrue(result.isOk());

    Assert.assertEquals(tableStart, grouper.getTableStart());

    <span class="hljs-comment">// 3rd key should cause buffer to grow</span>

    <span class="hljs-comment">// buffer should grow to next size, but is not full</span>

    fillKeyspace(keySpace, maxVectorSize, <span class="hljs-number">3</span>);

    result = grouper.aggregateVector(keySpace, <span class="hljs-number">0</span>, maxVectorSize);

    Assert.assertTrue(result.isOk());

    Assert.assertTrue(grouper.getTableStart() &gt; tableStart);

    <span class="hljs-comment">// this time should be all the way</span>

    fillKeyspace(keySpace, maxVectorSize, <span class="hljs-number">6</span>);

    result = grouper.aggregateVector(keySpace, <span class="hljs-number">0</span>, maxVectorSize);

    Assert.assertTrue(result.isOk());

    Assert.assertEquals(<span class="hljs-number">0</span>, grouper.getTableStart());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AggregatorAdapters <span class="hljs-title">createMockAggregatorAdapters</span><span class="hljs-params">(<span class="hljs-keyword">int</span> spaceNeededReturn)</span> </span>{
    AggregatorAdapters aggregatorAdapters = Mockito.mock(AggregatorAdapters<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(aggregatorAdapters.spaceNeeded()).thenReturn(spaceNeededReturn);
    <span class="hljs-keyword">return</span> aggregatorAdapters;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest353">Test Case ID #druid_Test_35_3</h4>
<h4 id="test-case-name-testgrowthreetimesfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaehashvectorgroupertestjava">Test Case Name: <code>testGrowThreeTimes</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\HashVectorGrouperTest.java</code>)</h4>
<h4 id="mock-object-variable-name-aggregatoradapters">Mock Object Variable Name: <code>aggregatorAdapters</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final int keySize = 4;
    final int aggSize = 8;
    final WritableMemory keySpace = WritableMemory.allocate(keySize * maxVectorSize);
<span class="hljs-deletion">-    final AggregatorAdapters aggregatorAdapters = Mockito.mock(AggregatorAdapters.class);</span>
<span class="hljs-deletion">-    Mockito.when(aggregatorAdapters.spaceNeeded()).thenReturn(aggSize);</span>
<span class="hljs-addition">+    final AggregatorAdapters aggregatorAdapters = createMockAggregatorAdapters(aggSize);</span>
    int startingNumBuckets = 4;
    int maxBuckets = 64;
    final int bufferSize = (keySize + aggSize) * maxBuckets;
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGrowThreeTimes</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> maxVectorSize = <span class="hljs-number">512</span>;

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> keySize = <span class="hljs-number">4</span>;

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> aggSize = <span class="hljs-number">8</span>;

    <span class="hljs-keyword">final</span> WritableMemory keySpace = WritableMemory.allocate(keySize * maxVectorSize);

    <span class="hljs-keyword">final</span> AggregatorAdapters aggregatorAdapters = Mockito.mock(AggregatorAdapters<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(aggregatorAdapters.spaceNeeded()).thenReturn(aggSize);

    <span class="hljs-keyword">int</span> startingNumBuckets = <span class="hljs-number">4</span>;

    <span class="hljs-keyword">int</span> maxBuckets = <span class="hljs-number">64</span>;

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> bufferSize = (keySize + aggSize) * maxBuckets;

    <span class="hljs-keyword">final</span> ByteBuffer buffer = ByteBuffer.wrap(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[bufferSize]);

    <span class="hljs-keyword">final</span> HashVectorGrouper grouper = <span class="hljs-keyword">new</span> HashVectorGrouper(Suppliers.ofInstance(buffer), keySize, aggregatorAdapters, maxBuckets, <span class="hljs-number">0</span>.f, startingNumBuckets);

    grouper.initVectorized(maxVectorSize);

    <span class="hljs-keyword">int</span> tableStart = grouper.getTableStart();

    <span class="hljs-comment">// two keys should cause buffer to grow</span>

    fillKeyspace(keySpace, maxVectorSize, <span class="hljs-number">2</span>);

    AggregateResult result = grouper.aggregateVector(keySpace, <span class="hljs-number">0</span>, maxVectorSize);

    Assert.assertTrue(result.isOk());

    Assert.assertEquals(tableStart, grouper.getTableStart());

    <span class="hljs-comment">// 3rd key should cause buffer to grow</span>

    <span class="hljs-comment">// buffer should grow to next size, but is not full</span>

    fillKeyspace(keySpace, maxVectorSize, <span class="hljs-number">3</span>);

    result = grouper.aggregateVector(keySpace, <span class="hljs-number">0</span>, maxVectorSize);

    Assert.assertTrue(result.isOk());

    Assert.assertTrue(grouper.getTableStart() &gt; tableStart);

    tableStart = grouper.getTableStart();

    <span class="hljs-comment">// grow it again</span>

    fillKeyspace(keySpace, maxVectorSize, <span class="hljs-number">6</span>);

    result = grouper.aggregateVector(keySpace, <span class="hljs-number">0</span>, maxVectorSize);

    Assert.assertTrue(result.isOk());

    Assert.assertTrue(grouper.getTableStart() &gt; tableStart);

    <span class="hljs-comment">// this time should be all the way</span>

    fillKeyspace(keySpace, maxVectorSize, <span class="hljs-number">14</span>);

    result = grouper.aggregateVector(keySpace, <span class="hljs-number">0</span>, maxVectorSize);

    Assert.assertTrue(result.isOk());

    Assert.assertEquals(<span class="hljs-number">0</span>, grouper.getTableStart());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AggregatorAdapters <span class="hljs-title">createMockAggregatorAdapters</span><span class="hljs-params">(<span class="hljs-keyword">int</span> spaceNeededReturn)</span> </span>{
    AggregatorAdapters aggregatorAdapters = Mockito.mock(AggregatorAdapters<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(aggregatorAdapters.spaceNeeded()).thenReturn(spaceNeededReturn);
    <span class="hljs-keyword">return</span> aggregatorAdapters;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest354">Test Case ID #druid_Test_35_4</h4>
<h4 id="test-case-name-testgrowfourtimesfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaehashvectorgroupertestjava">Test Case Name: <code>testGrowFourTimes</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\HashVectorGrouperTest.java</code>)</h4>
<h4 id="mock-object-variable-name-aggregatoradapters">Mock Object Variable Name: <code>aggregatorAdapters</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final int keySize = 4;
    final int aggSize = 8;
    final WritableMemory keySpace = WritableMemory.allocate(keySize * maxVectorSize);
<span class="hljs-deletion">-    final AggregatorAdapters aggregatorAdapters = Mockito.mock(AggregatorAdapters.class);</span>
<span class="hljs-deletion">-    Mockito.when(aggregatorAdapters.spaceNeeded()).thenReturn(aggSize);</span>
<span class="hljs-addition">+    final AggregatorAdapters aggregatorAdapters = createMockAggregatorAdapters(aggSize);</span>
    int startingNumBuckets = 4;
    int maxBuckets = 128;
    final int bufferSize = (keySize + aggSize) * maxBuckets;
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGrowFourTimes</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> maxVectorSize = <span class="hljs-number">512</span>;

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> keySize = <span class="hljs-number">4</span>;

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> aggSize = <span class="hljs-number">8</span>;

    <span class="hljs-keyword">final</span> WritableMemory keySpace = WritableMemory.allocate(keySize * maxVectorSize);

    <span class="hljs-keyword">final</span> AggregatorAdapters aggregatorAdapters = Mockito.mock(AggregatorAdapters<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(aggregatorAdapters.spaceNeeded()).thenReturn(aggSize);

    <span class="hljs-keyword">int</span> startingNumBuckets = <span class="hljs-number">4</span>;

    <span class="hljs-keyword">int</span> maxBuckets = <span class="hljs-number">128</span>;

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> bufferSize = (keySize + aggSize) * maxBuckets;

    <span class="hljs-keyword">final</span> ByteBuffer buffer = ByteBuffer.wrap(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[bufferSize]);

    <span class="hljs-keyword">final</span> HashVectorGrouper grouper = <span class="hljs-keyword">new</span> HashVectorGrouper(Suppliers.ofInstance(buffer), keySize, aggregatorAdapters, maxBuckets, <span class="hljs-number">0</span>.f, startingNumBuckets);

    grouper.initVectorized(maxVectorSize);

    <span class="hljs-keyword">int</span> tableStart = grouper.getTableStart();

    <span class="hljs-comment">// two keys should cause buffer to grow</span>

    fillKeyspace(keySpace, maxVectorSize, <span class="hljs-number">2</span>);

    AggregateResult result = grouper.aggregateVector(keySpace, <span class="hljs-number">0</span>, maxVectorSize);

    Assert.assertTrue(result.isOk());

    Assert.assertEquals(tableStart, grouper.getTableStart());

    <span class="hljs-comment">// 3rd key should cause buffer to grow</span>

    <span class="hljs-comment">// buffer should grow to next size, but is not full</span>

    fillKeyspace(keySpace, maxVectorSize, <span class="hljs-number">3</span>);

    result = grouper.aggregateVector(keySpace, <span class="hljs-number">0</span>, maxVectorSize);

    Assert.assertTrue(result.isOk());

    Assert.assertTrue(grouper.getTableStart() &gt; tableStart);

    tableStart = grouper.getTableStart();

    <span class="hljs-comment">// grow it again</span>

    fillKeyspace(keySpace, maxVectorSize, <span class="hljs-number">6</span>);

    result = grouper.aggregateVector(keySpace, <span class="hljs-number">0</span>, maxVectorSize);

    Assert.assertTrue(result.isOk());

    Assert.assertTrue(grouper.getTableStart() &gt; tableStart);

    tableStart = grouper.getTableStart();

    <span class="hljs-comment">// more</span>

    fillKeyspace(keySpace, maxVectorSize, <span class="hljs-number">14</span>);

    result = grouper.aggregateVector(keySpace, <span class="hljs-number">0</span>, maxVectorSize);

    Assert.assertTrue(result.isOk());

    Assert.assertTrue(grouper.getTableStart() &gt; tableStart);

    <span class="hljs-comment">// this time should be all the way</span>

    fillKeyspace(keySpace, maxVectorSize, <span class="hljs-number">25</span>);

    result = grouper.aggregateVector(keySpace, <span class="hljs-number">0</span>, maxVectorSize);

    Assert.assertTrue(result.isOk());

    Assert.assertEquals(<span class="hljs-number">0</span>, grouper.getTableStart());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AggregatorAdapters <span class="hljs-title">createMockAggregatorAdapters</span><span class="hljs-params">(<span class="hljs-keyword">int</span> spaceNeededReturn)</span> </span>{
    AggregatorAdapters aggregatorAdapters = Mockito.mock(AggregatorAdapters<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(aggregatorAdapters.spaceNeeded()).thenReturn(spaceNeededReturn);
    <span class="hljs-keyword">return</span> aggregatorAdapters;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci36">Mock Clone Instance #druid_MCI_36</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.query.aggregation.AggregatorAdapters</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> AggregatorAdapters aggregatorAdapters;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    aggregatorAdapters = Mockito.mock(AggregatorAdapters<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
aggregatorAdapters;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest361">Test Case ID #druid_Test_36_1</h4>
<h4 id="test-case-name-testcloseaggregatoradaptorsshouldbeclosedfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaehashvectorgroupertestjava">Test Case Name: <code>testCloseAggregatorAdaptorsShouldBeClosed</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\HashVectorGrouperTest.java</code>)</h4>
<h4 id="mock-object-variable-name-aggregatoradapters">Mock Object Variable Name: <code>aggregatorAdapters</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testCloseAggregatorAdaptorsShouldBeClosed() {
     final ByteBuffer buffer = ByteBuffer.wrap(new byte[4096]);
<span class="hljs-deletion">-    final AggregatorAdapters aggregatorAdapters = Mockito.mock(AggregatorAdapters.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `aggregatorAdapters`</span>
     final HashVectorGrouper grouper = new HashVectorGrouper(Suppliers.ofInstance(buffer), 1024, aggregatorAdapters, Integer.MAX_VALUE, 0.f, 0);
     grouper.initVectorized(512);
     grouper.close();
<span class="hljs-deletion">-    Mockito.verify(aggregatorAdapters, Mockito.times(1)).close();</span>
<span class="hljs-addition">+    Mockito.verify(aggregatorAdapters, Mockito.times(1)).close();</span>
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCloseAggregatorAdaptorsShouldBeClosed</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> ByteBuffer buffer = ByteBuffer.wrap(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">4096</span>]);

    <span class="hljs-keyword">final</span> AggregatorAdapters aggregatorAdapters = Mockito.mock(AggregatorAdapters<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> HashVectorGrouper grouper = <span class="hljs-keyword">new</span> HashVectorGrouper(Suppliers.ofInstance(buffer), <span class="hljs-number">1024</span>, aggregatorAdapters, Integer.MAX_VALUE, <span class="hljs-number">0</span>.f, <span class="hljs-number">0</span>);

    grouper.initVectorized(<span class="hljs-number">512</span>);

    grouper.close();

    Mockito.verify(aggregatorAdapters, Mockito.times(<span class="hljs-number">1</span>)).close();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> AggregatorAdapters aggregatorAdapters;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    aggregatorAdapters = Mockito.mock(AggregatorAdapters<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
aggregatorAdapters;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest362">Test Case ID #druid_Test_36_2</h4>
<h4 id="test-case-name-testtablestartisnotmemorystartifnotmaxsizedfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaehashvectorgroupertestjava">Test Case Name: <code>testTableStartIsNotMemoryStartIfNotMaxSized</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\HashVectorGrouperTest.java</code>)</h4>
<h4 id="mock-object-variable-name-aggregatoradapters">Mock Object Variable Name: <code>aggregatorAdapters</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testTableStartIsNotMemoryStartIfNotMaxSized() {
     final int maxVectorSize = 512;
     final int keySize = 4;
     final int bufferSize = 100 * 1024;
     final WritableMemory keySpace = WritableMemory.allocate(keySize * maxVectorSize);
     final ByteBuffer buffer = ByteBuffer.wrap(new byte[bufferSize]);
<span class="hljs-deletion">-    final AggregatorAdapters aggregatorAdapters = Mockito.mock(AggregatorAdapters.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `aggregatorAdapters`</span>
     final HashVectorGrouper grouper = new HashVectorGrouper(Suppliers.ofInstance(buffer), keySize, aggregatorAdapters, 8, 0.f, 4);
     grouper.initVectorized(maxVectorSize);
     Assert.assertNotEquals(0, grouper.getTableStart());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testTableStartIsNotMemoryStartIfNotMaxSized</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> maxVectorSize = <span class="hljs-number">512</span>;

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> keySize = <span class="hljs-number">4</span>;

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> bufferSize = <span class="hljs-number">100</span> * <span class="hljs-number">1024</span>;

    <span class="hljs-keyword">final</span> WritableMemory keySpace = WritableMemory.allocate(keySize * maxVectorSize);

    <span class="hljs-keyword">final</span> ByteBuffer buffer = ByteBuffer.wrap(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[bufferSize]);

    <span class="hljs-keyword">final</span> AggregatorAdapters aggregatorAdapters = Mockito.mock(AggregatorAdapters<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> HashVectorGrouper grouper = <span class="hljs-keyword">new</span> HashVectorGrouper(Suppliers.ofInstance(buffer), keySize, aggregatorAdapters, <span class="hljs-number">8</span>, <span class="hljs-number">0</span>.f, <span class="hljs-number">4</span>);

    grouper.initVectorized(maxVectorSize);

    Assert.assertNotEquals(<span class="hljs-number">0</span>, grouper.getTableStart());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> AggregatorAdapters aggregatorAdapters;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    aggregatorAdapters = Mockito.mock(AggregatorAdapters<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
aggregatorAdapters;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest363">Test Case ID #druid_Test_36_3</h4>
<h4 id="test-case-name-testtablestartisnotmemorystartifismaxsizedfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaehashvectorgroupertestjava">Test Case Name: <code>testTableStartIsNotMemoryStartIfIsMaxSized</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\HashVectorGrouperTest.java</code>)</h4>
<h4 id="mock-object-variable-name-aggregatoradapters">Mock Object Variable Name: <code>aggregatorAdapters</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testTableStartIsNotMemoryStartIfIsMaxSized() {
     final int maxVectorSize = 512;
     final int keySize = 10000;
     final int bufferSize = 100 * 1024;
     final ByteBuffer buffer = ByteBuffer.wrap(new byte[bufferSize]);
<span class="hljs-deletion">-    final AggregatorAdapters aggregatorAdapters = Mockito.mock(AggregatorAdapters.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `aggregatorAdapters`</span>
     final HashVectorGrouper grouper = new HashVectorGrouper(Suppliers.ofInstance(buffer), keySize, aggregatorAdapters, 4, 0.f, 4);
     grouper.initVectorized(maxVectorSize);
     Assert.assertEquals(0, grouper.getTableStart());
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testTableStartIsNotMemoryStartIfIsMaxSized</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> maxVectorSize = <span class="hljs-number">512</span>;

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> keySize = <span class="hljs-number">10000</span>;

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> bufferSize = <span class="hljs-number">100</span> * <span class="hljs-number">1024</span>;

    <span class="hljs-keyword">final</span> ByteBuffer buffer = ByteBuffer.wrap(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[bufferSize]);

    <span class="hljs-keyword">final</span> AggregatorAdapters aggregatorAdapters = Mockito.mock(AggregatorAdapters<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> HashVectorGrouper grouper = <span class="hljs-keyword">new</span> HashVectorGrouper(Suppliers.ofInstance(buffer), keySize, aggregatorAdapters, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>.f, <span class="hljs-number">4</span>);

    grouper.initVectorized(maxVectorSize);

    Assert.assertEquals(<span class="hljs-number">0</span>, grouper.getTableStart());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> AggregatorAdapters aggregatorAdapters;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    aggregatorAdapters = Mockito.mock(AggregatorAdapters<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
aggregatorAdapters;

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci37">Mock Clone Instance #druid_MCI_37</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.java.util.metrics.DruidMonitorSchedulerConfig</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DruidMonitorSchedulerConfig <span class="hljs-title">createMockDruidMonitorSchedulerConfig</span><span class="hljs-params">(org.joda.time.Duration emissionDuration)</span> </span>{
    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(config.getEmissionDuration()).thenReturn(emissionDuration);
    <span class="hljs-keyword">return</span> config;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest371">Test Case ID #druid_Test_37_1</h4>
<h4 id="test-case-name-teststartrepeatschedulingfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidjavautilmetricsclockdriftsafemonitorschedulertestjava">Test Case Name: <code>testStart_RepeatScheduling</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\java\util\metrics\ClockDriftSafeMonitorSchedulerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-config">Mock Object Variable Name: <code>config</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Monitor monitor = Mockito.mock(Monitor.class);
<span class="hljs-deletion">-    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig.class);</span>
<span class="hljs-deletion">-    Mockito.when(config.getEmissionDuration()).thenReturn(new org.joda.time.Duration(1000L));</span>
<span class="hljs-addition">+    DruidMonitorSchedulerConfig config = createMockDruidMonitorSchedulerConfig(new org.joda.time.Duration(1000L));</span>
    final MonitorScheduler scheduler = new ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter.class), ImmutableList.of(monitor), cronScheduler, executor);
    scheduler.start();
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStart_RepeatScheduling</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    ExecutorService executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    Mockito.doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Future&lt;?&gt;&gt;() {



        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> scheduleCount = <span class="hljs-number">0</span>;



        <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> Future&lt;?&gt; answer(InvocationOnMock invocation) {

            <span class="hljs-keyword">final</span> Object originalArgument = (invocation.getArguments())[<span class="hljs-number">3</span>];

            CronTask task = ((CronTask) originalArgument);

            Mockito.doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Future&lt;?&gt;&gt;() {



                <span class="hljs-meta">@Override</span>

                <span class="hljs-function"><span class="hljs-keyword">public</span> Future&lt;Boolean&gt; <span class="hljs-title">answer</span><span class="hljs-params">(InvocationOnMock invocation)</span> <span class="hljs-keyword">throws</span> Exception </span>{

                    <span class="hljs-keyword">final</span> Object originalArgument = (invocation.getArguments())[<span class="hljs-number">0</span>];

                    ((Callable&lt;Boolean&gt;) originalArgument).call();

                    <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(Boolean.TRUE);

                }

            }).when(executor).submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

            cronTaskRunner.submit(() -&gt; {

                <span class="hljs-keyword">while</span> (scheduleCount &lt; <span class="hljs-number">2</span>) {

                    scheduleCount++;

                    task.run(<span class="hljs-number">123L</span>);

                }

                latch.countDown();

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

            });

            <span class="hljs-keyword">return</span> createDummyFuture();

        }

    }).when(cronScheduler).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Monitor monitor = Mockito.mock(Monitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(config.getEmissionDuration()).thenReturn(<span class="hljs-keyword">new</span> org.joda.time.Duration(<span class="hljs-number">1000L</span>));

    <span class="hljs-keyword">final</span> MonitorScheduler scheduler = <span class="hljs-keyword">new</span> ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">ImmutableList</span>.<span class="hljs-title">of</span>(<span class="hljs-title">monitor</span>), <span class="hljs-title">cronScheduler</span>, <span class="hljs-title">executor</span>)</span>;

    scheduler.start();

    latch.await(<span class="hljs-number">5</span>, TimeUnit.SECONDS);

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">1</span>)).start();

    Mockito.verify(cronScheduler, Mockito.times(<span class="hljs-number">1</span>)).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.verify(executor, Mockito.times(<span class="hljs-number">2</span>)).submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">2</span>)).monitor(ArgumentMatchers.any());

    scheduler.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DruidMonitorSchedulerConfig <span class="hljs-title">createMockDruidMonitorSchedulerConfig</span><span class="hljs-params">(org.joda.time.Duration emissionDuration)</span> </span>{
    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(config.getEmissionDuration()).thenReturn(emissionDuration);
    <span class="hljs-keyword">return</span> config;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest372">Test Case ID #druid_Test_37_2</h4>
<h4 id="test-case-name-teststartrepeatandstopschedulingfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidjavautilmetricsclockdriftsafemonitorschedulertestjava">Test Case Name: <code>testStart_RepeatAndStopScheduling</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\java\util\metrics\ClockDriftSafeMonitorSchedulerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-config">Mock Object Variable Name: <code>config</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Monitor monitor = Mockito.mock(Monitor.class);
<span class="hljs-deletion">-    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig.class);</span>
<span class="hljs-deletion">-    Mockito.when(config.getEmissionDuration()).thenReturn(new org.joda.time.Duration(1000L));</span>
<span class="hljs-addition">+    DruidMonitorSchedulerConfig config = createMockDruidMonitorSchedulerConfig(new org.joda.time.Duration(1000L));</span>
    final MonitorScheduler scheduler = new ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter.class), ImmutableList.of(monitor), cronScheduler, executor);
    scheduler.start();
    latch.await(5, TimeUnit.SECONDS);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStart_RepeatAndStopScheduling</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    ExecutorService executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    Mockito.doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Future&lt;?&gt;&gt;() {



        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> scheduleCount = <span class="hljs-number">0</span>;



        <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> Future&lt;?&gt; answer(InvocationOnMock invocation) {

            <span class="hljs-keyword">final</span> Object originalArgument = (invocation.getArguments())[<span class="hljs-number">3</span>];

            CronTask task = ((CronTask) originalArgument);

            Mockito.doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Future&lt;?&gt;&gt;() {



                <span class="hljs-meta">@Override</span>

                <span class="hljs-function"><span class="hljs-keyword">public</span> Future&lt;Boolean&gt; <span class="hljs-title">answer</span><span class="hljs-params">(InvocationOnMock invocation)</span> <span class="hljs-keyword">throws</span> Exception </span>{

                    <span class="hljs-keyword">final</span> Object originalArgument = (invocation.getArguments())[<span class="hljs-number">0</span>];

                    ((Callable&lt;Boolean&gt;) originalArgument).call();

                    <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(Boolean.FALSE);

                }

            }).when(executor).submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

            cronTaskRunner.submit(() -&gt; {

                <span class="hljs-keyword">while</span> (scheduleCount &lt; <span class="hljs-number">2</span>) {

                    scheduleCount++;

                    task.run(<span class="hljs-number">123L</span>);

                }

                latch.countDown();

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

            });

            <span class="hljs-keyword">return</span> createDummyFuture();

        }

    }).when(cronScheduler).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Monitor monitor = Mockito.mock(Monitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(config.getEmissionDuration()).thenReturn(<span class="hljs-keyword">new</span> org.joda.time.Duration(<span class="hljs-number">1000L</span>));

    <span class="hljs-keyword">final</span> MonitorScheduler scheduler = <span class="hljs-keyword">new</span> ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">ImmutableList</span>.<span class="hljs-title">of</span>(<span class="hljs-title">monitor</span>), <span class="hljs-title">cronScheduler</span>, <span class="hljs-title">executor</span>)</span>;

    scheduler.start();

    latch.await(<span class="hljs-number">5</span>, TimeUnit.SECONDS);

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">1</span>)).start();

    Mockito.verify(cronScheduler, Mockito.times(<span class="hljs-number">1</span>)).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.verify(executor, Mockito.times(<span class="hljs-number">1</span>)).submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">2</span>)).monitor(ArgumentMatchers.any());

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">1</span>)).stop();

    scheduler.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DruidMonitorSchedulerConfig <span class="hljs-title">createMockDruidMonitorSchedulerConfig</span><span class="hljs-params">(org.joda.time.Duration emissionDuration)</span> </span>{
    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(config.getEmissionDuration()).thenReturn(emissionDuration);
    <span class="hljs-keyword">return</span> config;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest373">Test Case ID #druid_Test_37_3</h4>
<h4 id="test-case-name-teststartunexpectedexceptionwhilemonitoringfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidjavautilmetricsclockdriftsafemonitorschedulertestjava">Test Case Name: <code>testStart_UnexpectedExceptionWhileMonitoring</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\java\util\metrics\ClockDriftSafeMonitorSchedulerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-config">Mock Object Variable Name: <code>config</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Monitor monitor = Mockito.mock(Monitor.class);
    Mockito.when(monitor.monitor(ArgumentMatchers.any(ServiceEmitter.class))).thenThrow(new RuntimeException("Test throwing exception while monitoring"));
<span class="hljs-deletion">-    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig.class);</span>
<span class="hljs-deletion">-    Mockito.when(config.getEmissionDuration()).thenReturn(new org.joda.time.Duration(1000L));</span>
<span class="hljs-addition">+    DruidMonitorSchedulerConfig config = createMockDruidMonitorSchedulerConfig(new org.joda.time.Duration(1000L));</span>
    CountDownLatch latch = new CountDownLatch(1);
    AtomicBoolean monitorResultHolder = new AtomicBoolean(false);
    Mockito.doAnswer(new Answer&lt;Future&lt;?&gt;&gt;() {
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStart_UnexpectedExceptionWhileMonitoring</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    ExecutorService executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Monitor monitor = Mockito.mock(Monitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(monitor.monitor(ArgumentMatchers.any(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenThrow</span>(<span class="hljs-title">new</span> <span class="hljs-title">RuntimeException</span>("<span class="hljs-title">Test</span> <span class="hljs-title">throwing</span> <span class="hljs-title">exception</span> <span class="hljs-title">while</span> <span class="hljs-title">monitoring</span>"))</span>;

    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(config.getEmissionDuration()).thenReturn(<span class="hljs-keyword">new</span> org.joda.time.Duration(<span class="hljs-number">1000L</span>));

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    AtomicBoolean monitorResultHolder = <span class="hljs-keyword">new</span> AtomicBoolean(<span class="hljs-keyword">false</span>);

    Mockito.doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Future&lt;?&gt;&gt;() {



        <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> Future&lt;?&gt; answer(InvocationOnMock invocation) {

            <span class="hljs-keyword">final</span> Object originalArgument = (invocation.getArguments())[<span class="hljs-number">3</span>];

            CronTask task = ((CronTask) originalArgument);

            Mockito.doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Future&lt;?&gt;&gt;() {



                <span class="hljs-meta">@Override</span>

                <span class="hljs-function"><span class="hljs-keyword">public</span> Future&lt;Boolean&gt; <span class="hljs-title">answer</span><span class="hljs-params">(InvocationOnMock invocation)</span> <span class="hljs-keyword">throws</span> Exception </span>{

                    <span class="hljs-keyword">final</span> Object originalArgument = (invocation.getArguments())[<span class="hljs-number">0</span>];

                    <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> continueMonitor = ((Callable&lt;Boolean&gt;) originalArgument).call();

                    monitorResultHolder.set(continueMonitor);

                    <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(continueMonitor);

                }

            }).when(executor).submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

            cronTaskRunner.submit(() -&gt; {

                task.run(<span class="hljs-number">123L</span>);

                latch.countDown();

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

            });

            <span class="hljs-keyword">return</span> createDummyFuture();

        }

    }).when(cronScheduler).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">final</span> MonitorScheduler scheduler = <span class="hljs-keyword">new</span> ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">ImmutableList</span>.<span class="hljs-title">of</span>(<span class="hljs-title">monitor</span>), <span class="hljs-title">cronScheduler</span>, <span class="hljs-title">executor</span>)</span>;

    scheduler.start();

    latch.await(<span class="hljs-number">5</span>, TimeUnit.SECONDS);

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">1</span>)).start();

    Mockito.verify(cronScheduler, Mockito.times(<span class="hljs-number">1</span>)).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.verify(executor, Mockito.times(<span class="hljs-number">1</span>)).submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">1</span>)).monitor(ArgumentMatchers.any());

    Assert.assertTrue(monitorResultHolder.get());

    scheduler.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DruidMonitorSchedulerConfig <span class="hljs-title">createMockDruidMonitorSchedulerConfig</span><span class="hljs-params">(org.joda.time.Duration emissionDuration)</span> </span>{
    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(config.getEmissionDuration()).thenReturn(emissionDuration);
    <span class="hljs-keyword">return</span> config;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest374">Test Case ID #druid_Test_37_4</h4>
<h4 id="test-case-name-teststartunexpectedexceptionwhileschedulingfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidjavautilmetricsclockdriftsafemonitorschedulertestjava">Test Case Name: <code>testStart_UnexpectedExceptionWhileScheduling</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\java\util\metrics\ClockDriftSafeMonitorSchedulerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-config">Mock Object Variable Name: <code>config</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    ExecutorService executor = Mockito.mock(ExecutorService.class);
    Monitor monitor = Mockito.mock(Monitor.class);
<span class="hljs-deletion">-    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig.class);</span>
<span class="hljs-deletion">-    Mockito.when(config.getEmissionDuration()).thenReturn(new org.joda.time.Duration(1000L));</span>
<span class="hljs-addition">+    DruidMonitorSchedulerConfig config = createMockDruidMonitorSchedulerConfig(new org.joda.time.Duration(1000L));</span>
    CountDownLatch latch = new CountDownLatch(1);
    Mockito.doAnswer(new Answer&lt;Future&lt;?&gt;&gt;() {

</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStart_UnexpectedExceptionWhileScheduling</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    ExecutorService executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Monitor monitor = Mockito.mock(Monitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(config.getEmissionDuration()).thenReturn(<span class="hljs-keyword">new</span> org.joda.time.Duration(<span class="hljs-number">1000L</span>));

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    Mockito.doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Future&lt;?&gt;&gt;() {



        <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> Future&lt;?&gt; answer(InvocationOnMock invocation) {

            <span class="hljs-keyword">final</span> Object originalArgument = (invocation.getArguments())[<span class="hljs-number">3</span>];

            CronTask task = ((CronTask) originalArgument);

            Mockito.when(executor.submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenThrow</span>(<span class="hljs-title">new</span> <span class="hljs-title">RuntimeException</span>("<span class="hljs-title">Test</span> <span class="hljs-title">throwing</span> <span class="hljs-title">exception</span> <span class="hljs-title">while</span> <span class="hljs-title">scheduling</span>"))</span>;

            cronTaskRunner.submit(() -&gt; {

                task.run(<span class="hljs-number">123L</span>);

                latch.countDown();

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

            });

            <span class="hljs-keyword">return</span> createDummyFuture();

        }

    }).when(cronScheduler).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">final</span> MonitorScheduler scheduler = <span class="hljs-keyword">new</span> ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">ImmutableList</span>.<span class="hljs-title">of</span>(<span class="hljs-title">monitor</span>), <span class="hljs-title">cronScheduler</span>, <span class="hljs-title">executor</span>)</span>;

    scheduler.start();

    latch.await(<span class="hljs-number">5</span>, TimeUnit.SECONDS);

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">1</span>)).start();

    Mockito.verify(cronScheduler, Mockito.times(<span class="hljs-number">1</span>)).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.verify(executor, Mockito.times(<span class="hljs-number">1</span>)).submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    scheduler.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DruidMonitorSchedulerConfig <span class="hljs-title">createMockDruidMonitorSchedulerConfig</span><span class="hljs-params">(org.joda.time.Duration emissionDuration)</span> </span>{
    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(config.getEmissionDuration()).thenReturn(emissionDuration);
    <span class="hljs-keyword">return</span> config;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci38">Mock Clone Instance #druid_MCI_38</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.google.inject.Injector</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Injector <span class="hljs-title">createMockInjector</span><span class="hljs-params">(ObjectMapper objectMapper, Key&lt;ObjectMapper&gt; objectMapperKey)</span> </span>{
    Injector injector = Mockito.mock(Injector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(injector.getInstance(objectMapperKey)).thenReturn(objectMapper);
    <span class="hljs-keyword">return</span> injector;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest381">Test Case ID #druid_Test_38_1</h4>
<h4 id="test-case-name-testdumpbitmapfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidclidumpsegmenttestjava">Test Case Name: <code>testDumpBitmap</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\cli\DumpSegmentTest.java</code>)</h4>
<h4 id="mock-object-variable-name-injector">Mock Object Variable Name: <code>injector</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testDumpBitmap() throws IOException {
<span class="hljs-deletion">-    Injector injector = Mockito.mock(Injector.class);</span>
     QueryableIndex queryableIndex = Mockito.mock(QueryableIndex.class);
     ObjectMapper mapper = new DefaultObjectMapper();
     BitmapFactory bitmapFactory = new RoaringBitmapFactory();
     ColumnHolder xHolder = Mockito.mock(ColumnHolder.class);
     ColumnHolder yHolder = Mockito.mock(ColumnHolder.class);
     ColumnIndexSupplier indexSupplier = Mockito.mock(ColumnIndexSupplier.class);
     DictionaryEncodedStringValueIndex valueIndex = Mockito.mock(DictionaryEncodedStringValueIndex.class);
     ImmutableBitmap bitmap = bitmapFactory.complement(bitmapFactory.makeEmptyImmutableBitmap(), 10);
<span class="hljs-addition">+    Injector injector = createMockInjector(mapper, Key.get(ObjectMapper.class, Json.class));</span>
     Mockito.when(queryableIndex.getBitmapFactoryForDimensions()).thenReturn(bitmapFactory);
     Mockito.when(queryableIndex.getColumnHolder("x")).thenReturn(xHolder);
     Mockito.when(queryableIndex.getColumnHolder("y")).thenReturn(yHolder);
     Mockito.when(xHolder.getIndexSupplier()).thenReturn(indexSupplier);
     Mockito.when(indexSupplier.as(DictionaryEncodedStringValueIndex.class)).thenReturn(valueIndex);
     Mockito.when(valueIndex.getCardinality()).thenReturn(1);
     Mockito.when(valueIndex.getBitmap(0)).thenReturn(bitmap);
     Mockito.when(valueIndex.getValue(0)).thenReturn("val");
     DumpSegment.runBitmaps(injector, tempFolder.newFile().getPath(), queryableIndex, ImmutableList.of("x", "y"), false);
     Assert.assertTrue(true);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDumpBitmap</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{

    Injector injector = Mockito.mock(Injector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    QueryableIndex queryableIndex = Mockito.mock(QueryableIndex<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ObjectMapper mapper = <span class="hljs-keyword">new</span> DefaultObjectMapper();

    BitmapFactory bitmapFactory = <span class="hljs-keyword">new</span> RoaringBitmapFactory();

    ColumnHolder xHolder = Mockito.mock(ColumnHolder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ColumnHolder yHolder = Mockito.mock(ColumnHolder<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ColumnIndexSupplier indexSupplier = Mockito.mock(ColumnIndexSupplier<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DictionaryEncodedStringValueIndex valueIndex = Mockito.mock(DictionaryEncodedStringValueIndex<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ImmutableBitmap bitmap = bitmapFactory.complement(bitmapFactory.makeEmptyImmutableBitmap(), <span class="hljs-number">10</span>);

    Mockito.when(injector.getInstance(Key.get(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Json</span>.<span class="hljs-title">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">mapper</span>)</span>;

    Mockito.when(queryableIndex.getBitmapFactoryForDimensions()).thenReturn(bitmapFactory);

    Mockito.when(queryableIndex.getColumnHolder(<span class="hljs-string">"x"</span>)).thenReturn(xHolder);

    Mockito.when(queryableIndex.getColumnHolder(<span class="hljs-string">"y"</span>)).thenReturn(yHolder);

    Mockito.when(xHolder.getIndexSupplier()).thenReturn(indexSupplier);

    Mockito.when(indexSupplier.as(DictionaryEncodedStringValueIndex<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">valueIndex</span>)</span>;

    Mockito.when(valueIndex.getCardinality()).thenReturn(<span class="hljs-number">1</span>);

    Mockito.when(valueIndex.getBitmap(<span class="hljs-number">0</span>)).thenReturn(bitmap);

    Mockito.when(valueIndex.getValue(<span class="hljs-number">0</span>)).thenReturn(<span class="hljs-string">"val"</span>);

    DumpSegment.runBitmaps(injector, tempFolder.newFile().getPath(), queryableIndex, ImmutableList.of(<span class="hljs-string">"x"</span>, <span class="hljs-string">"y"</span>), <span class="hljs-keyword">false</span>);

    Assert.assertTrue(<span class="hljs-keyword">true</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Injector <span class="hljs-title">createMockInjector</span><span class="hljs-params">(ObjectMapper objectMapper, Key&lt;ObjectMapper&gt; objectMapperKey)</span> </span>{
    Injector injector = Mockito.mock(Injector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(injector.getInstance(objectMapperKey)).thenReturn(objectMapper);
    <span class="hljs-keyword">return</span> injector;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest382">Test Case ID #druid_Test_38_2</h4>
<h4 id="test-case-name-testdumpnestedcolumnfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidclidumpsegmenttestjava">Test Case Name: <code>testDumpNestedColumn</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\cli\DumpSegmentTest.java</code>)</h4>
<h4 id="mock-object-variable-name-injector">Mock Object Variable Name: <code>injector</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testDumpNestedColumn() throws Exception {
<span class="hljs-deletion">-    Injector injector = Mockito.mock(Injector.class);</span>
     ObjectMapper mapper = TestHelper.makeJsonMapper();
     mapper.registerModules(NestedDataModule.getJacksonModulesList());
     mapper.setInjectableValues(new InjectableValues.Std().addValue(ExprMacroTable.class.getName(), TestExprMacroTable.INSTANCE).addValue(ObjectMapper.class.getName(), mapper).addValue(DefaultColumnFormatConfig.class, new DefaultColumnFormatConfig(null)));
<span class="hljs-addition">+    Key&lt;ObjectMapper&gt; objectMapperKey = Key.get(ObjectMapper.class, Json.class);</span>
<span class="hljs-addition">+    Injector injector = createMockInjector(mapper, objectMapperKey);</span>
     Mockito.when(injector.getInstance(DefaultColumnFormatConfig.class)).thenReturn(new DefaultColumnFormatConfig(null));
     List&lt;Segment&gt; segments = createSegments(tempFolder, closer);
     QueryableIndex queryableIndex = segments.get(0).asQueryableIndex();
     File outputFile = tempFolder.newFile();
     DumpSegment.runDumpNestedColumn(injector, outputFile.getPath(), queryableIndex, "nest");
     final byte[] fileBytes = Files.readAllBytes(outputFile.toPath());
     final String output = StringUtils.fromUtf8(fileBytes);
     if (NullHandling.sqlCompatible()) {
         Assert.assertEquals("{\"nest\":{\"fields\":[{\"path\":\"$.x\",\"types\":[\"LONG\"]},{\"path\":\"$.y\",\"types\":[\"DOUBLE\"]},{\"path\":\"$.z\",\"types\":[\"STRING\"]}],\"dictionaries\":{\"strings\":[{\"globalId\":0,\"value\":null},{\"globalId\":1,\"value\":\"a\"},{\"globalId\":2,\"value\":\"b\"}],\"longs\":[{\"globalId\":3,\"value\":100},{\"globalId\":4,\"value\":200},{\"globalId\":5,\"value\":400}],\"doubles\":[{\"globalId\":6,\"value\":1.1},{\"globalId\":7,\"value\":2.2},{\"globalId\":8,\"value\":3.3}],\"nullRows\":[]}}}", output);
     } else {
         Assert.assertEquals("{\"nest\":{\"fields\":[{\"path\":\"$.x\",\"types\":[\"LONG\"]},{\"path\":\"$.y\",\"types\":[\"DOUBLE\"]},{\"path\":\"$.z\",\"types\":[\"STRING\"]}],\"dictionaries\":{\"strings\":[{\"globalId\":0,\"value\":null},{\"globalId\":1,\"value\":\"a\"},{\"globalId\":2,\"value\":\"b\"}],\"longs\":[{\"globalId\":3,\"value\":0},{\"globalId\":4,\"value\":100},{\"globalId\":5,\"value\":200},{\"globalId\":6,\"value\":400}],\"doubles\":[{\"globalId\":7,\"value\":0.0},{\"globalId\":8,\"value\":1.1},{\"globalId\":9,\"value\":2.2},{\"globalId\":10,\"value\":3.3}],\"nullRows\":[]}}}", output);
     }
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDumpNestedColumn</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Injector injector = Mockito.mock(Injector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ObjectMapper mapper = TestHelper.makeJsonMapper();

    mapper.registerModules(NestedDataModule.getJacksonModulesList());

    mapper.setInjectableValues(<span class="hljs-keyword">new</span> InjectableValues.Std().addValue(ExprMacroTable<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), <span class="hljs-title">TestExprMacroTable</span>.<span class="hljs-title">INSTANCE</span>).<span class="hljs-title">addValue</span>(<span class="hljs-title">ObjectMapper</span>.<span class="hljs-title">class</span>.<span class="hljs-title">getName</span>(), <span class="hljs-title">mapper</span>).<span class="hljs-title">addValue</span>(<span class="hljs-title">DefaultColumnFormatConfig</span>.<span class="hljs-title">class</span>, <span class="hljs-title">new</span> <span class="hljs-title">DefaultColumnFormatConfig</span>(<span class="hljs-title">null</span>)))</span>;

    Mockito.when(injector.getInstance(Key.get(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Json</span>.<span class="hljs-title">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">mapper</span>)</span>;

    Mockito.when(injector.getInstance(DefaultColumnFormatConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">DefaultColumnFormatConfig</span>(<span class="hljs-title">null</span>))</span>;

    List&lt;Segment&gt; segments = createSegments(tempFolder, closer);

    QueryableIndex queryableIndex = segments.get(<span class="hljs-number">0</span>).asQueryableIndex();

    File outputFile = tempFolder.newFile();

    DumpSegment.runDumpNestedColumn(injector, outputFile.getPath(), queryableIndex, <span class="hljs-string">"nest"</span>);

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] fileBytes = Files.readAllBytes(outputFile.toPath());

    <span class="hljs-keyword">final</span> String output = StringUtils.fromUtf8(fileBytes);

    <span class="hljs-keyword">if</span> (NullHandling.sqlCompatible()) {

        Assert.assertEquals(<span class="hljs-string">"{\"nest\":{\"fields\":[{\"path\":\"$.x\",\"types\":[\"LONG\"]},{\"path\":\"$.y\",\"types\":[\"DOUBLE\"]},{\"path\":\"$.z\",\"types\":[\"STRING\"]}],\"dictionaries\":{\"strings\":[{\"globalId\":0,\"value\":null},{\"globalId\":1,\"value\":\"a\"},{\"globalId\":2,\"value\":\"b\"}],\"longs\":[{\"globalId\":3,\"value\":100},{\"globalId\":4,\"value\":200},{\"globalId\":5,\"value\":400}],\"doubles\":[{\"globalId\":6,\"value\":1.1},{\"globalId\":7,\"value\":2.2},{\"globalId\":8,\"value\":3.3}],\"nullRows\":[]}}}"</span>, output);

    } <span class="hljs-keyword">else</span> {

        Assert.assertEquals(<span class="hljs-string">"{\"nest\":{\"fields\":[{\"path\":\"$.x\",\"types\":[\"LONG\"]},{\"path\":\"$.y\",\"types\":[\"DOUBLE\"]},{\"path\":\"$.z\",\"types\":[\"STRING\"]}],\"dictionaries\":{\"strings\":[{\"globalId\":0,\"value\":null},{\"globalId\":1,\"value\":\"a\"},{\"globalId\":2,\"value\":\"b\"}],\"longs\":[{\"globalId\":3,\"value\":0},{\"globalId\":4,\"value\":100},{\"globalId\":5,\"value\":200},{\"globalId\":6,\"value\":400}],\"doubles\":[{\"globalId\":7,\"value\":0.0},{\"globalId\":8,\"value\":1.1},{\"globalId\":9,\"value\":2.2},{\"globalId\":10,\"value\":3.3}],\"nullRows\":[]}}}"</span>, output);

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Injector <span class="hljs-title">createMockInjector</span><span class="hljs-params">(ObjectMapper objectMapper, Key&lt;ObjectMapper&gt; objectMapperKey)</span> </span>{
    Injector injector = Mockito.mock(Injector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(injector.getInstance(objectMapperKey)).thenReturn(objectMapper);
    <span class="hljs-keyword">return</span> injector;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest383">Test Case ID #druid_Test_38_3</h4>
<h4 id="test-case-name-testdumpnestedcolumnpathfile-cjavaprojectsapachedruidservicessrctestjavaorgapachedruidclidumpsegmenttestjava">Test Case Name: <code>testDumpNestedColumnPath</code>(File: <code>C:\Java_projects\Apache\druid\services\src\test\java\org\apache\druid\cli\DumpSegmentTest.java</code>)</h4>
<h4 id="mock-object-variable-name-injector">Mock Object Variable Name: <code>injector</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testDumpNestedColumnPath() throws Exception {
<span class="hljs-deletion">-    Injector injector = Mockito.mock(Injector.class);</span>
     ObjectMapper mapper = TestHelper.makeJsonMapper();
     mapper.registerModules(NestedDataModule.getJacksonModulesList());
     mapper.setInjectableValues(new InjectableValues.Std().addValue(ExprMacroTable.class.getName(), TestExprMacroTable.INSTANCE).addValue(ObjectMapper.class.getName(), mapper).addValue(DefaultColumnFormatConfig.class, new DefaultColumnFormatConfig(null)));
<span class="hljs-addition">+    Injector injector = createMockInjector(mapper, Key.get(ObjectMapper.class, Json.class));</span>
     Mockito.when(injector.getInstance(DefaultColumnFormatConfig.class)).thenReturn(new DefaultColumnFormatConfig(null));
     List&lt;Segment&gt; segments = createSegments(tempFolder, closer);
     QueryableIndex queryableIndex = segments.get(0).asQueryableIndex();
     File outputFile = tempFolder.newFile();
     DumpSegment.runDumpNestedColumnPath(injector, outputFile.getPath(), queryableIndex, "nest", "$.x");
     final byte[] fileBytes = Files.readAllBytes(outputFile.toPath());
     final String output = StringUtils.fromUtf8(fileBytes);
     if (NullHandling.sqlCompatible()) {
         Assert.assertEquals("{\"bitmapSerdeFactory\":{\"type\":\"roaring\"},\"nest\":{\"$.x\":{\"types\":[\"LONG\"],\"dictionary\":[{\"localId\":0,\"globalId\":0,\"value\":null,\"rows\":[4]},{\"localId\":1,\"globalId\":3,\"value\":\"100\",\"rows\":[3]},{\"localId\":2,\"globalId\":4,\"value\":\"200\",\"rows\":[0,2]},{\"localId\":3,\"globalId\":5,\"value\":\"400\",\"rows\":[1]}],\"column\":[{\"row\":0,\"raw\":{\"x\":200,\"y\":2.2},\"fieldId\":2,\"fieldValue\":\"200\"},{\"row\":1,\"raw\":{\"x\":400,\"y\":1.1,\"z\":\"a\"},\"fieldId\":3,\"fieldValue\":\"400\"},{\"row\":2,\"raw\":{\"x\":200,\"z\":\"b\"},\"fieldId\":2,\"fieldValue\":\"200\"},{\"row\":3,\"raw\":{\"x\":100,\"y\":1.1,\"z\":\"a\"},\"fieldId\":1,\"fieldValue\":\"100\"},{\"row\":4,\"raw\":{\"y\":3.3,\"z\":\"b\"},\"fieldId\":0,\"fieldValue\":null}]}}}", output);
     } else {
         Assert.assertEquals("{\"bitmapSerdeFactory\":{\"type\":\"roaring\"},\"nest\":{\"$.x\":{\"types\":[\"LONG\"],\"dictionary\":[{\"localId\":0,\"globalId\":0,\"value\":null,\"rows\":[4]},{\"localId\":1,\"globalId\":4,\"value\":\"100\",\"rows\":[3]},{\"localId\":2,\"globalId\":5,\"value\":\"200\",\"rows\":[0,2]},{\"localId\":3,\"globalId\":6,\"value\":\"400\",\"rows\":[1]}],\"column\":[{\"row\":0,\"raw\":{\"x\":200,\"y\":2.2},\"fieldId\":2,\"fieldValue\":\"200\"},{\"row\":1,\"raw\":{\"x\":400,\"y\":1.1,\"z\":\"a\"},\"fieldId\":3,\"fieldValue\":\"400\"},{\"row\":2,\"raw\":{\"x\":200,\"z\":\"b\"},\"fieldId\":2,\"fieldValue\":\"200\"},{\"row\":3,\"raw\":{\"x\":100,\"y\":1.1,\"z\":\"a\"},\"fieldId\":1,\"fieldValue\":\"100\"},{\"row\":4,\"raw\":{\"y\":3.3,\"z\":\"b\"},\"fieldId\":0,\"fieldValue\":null}]}}}", output);
     }
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDumpNestedColumnPath</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    Injector injector = Mockito.mock(Injector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ObjectMapper mapper = TestHelper.makeJsonMapper();

    mapper.registerModules(NestedDataModule.getJacksonModulesList());

    mapper.setInjectableValues(<span class="hljs-keyword">new</span> InjectableValues.Std().addValue(ExprMacroTable<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getName</span>(), <span class="hljs-title">TestExprMacroTable</span>.<span class="hljs-title">INSTANCE</span>).<span class="hljs-title">addValue</span>(<span class="hljs-title">ObjectMapper</span>.<span class="hljs-title">class</span>.<span class="hljs-title">getName</span>(), <span class="hljs-title">mapper</span>).<span class="hljs-title">addValue</span>(<span class="hljs-title">DefaultColumnFormatConfig</span>.<span class="hljs-title">class</span>, <span class="hljs-title">new</span> <span class="hljs-title">DefaultColumnFormatConfig</span>(<span class="hljs-title">null</span>)))</span>;

    Mockito.when(injector.getInstance(Key.get(ObjectMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Json</span>.<span class="hljs-title">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">mapper</span>)</span>;

    Mockito.when(injector.getInstance(DefaultColumnFormatConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">DefaultColumnFormatConfig</span>(<span class="hljs-title">null</span>))</span>;

    List&lt;Segment&gt; segments = createSegments(tempFolder, closer);

    QueryableIndex queryableIndex = segments.get(<span class="hljs-number">0</span>).asQueryableIndex();

    File outputFile = tempFolder.newFile();

    DumpSegment.runDumpNestedColumnPath(injector, outputFile.getPath(), queryableIndex, <span class="hljs-string">"nest"</span>, <span class="hljs-string">"$.x"</span>);

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">byte</span>[] fileBytes = Files.readAllBytes(outputFile.toPath());

    <span class="hljs-keyword">final</span> String output = StringUtils.fromUtf8(fileBytes);

    <span class="hljs-keyword">if</span> (NullHandling.sqlCompatible()) {

        Assert.assertEquals(<span class="hljs-string">"{\"bitmapSerdeFactory\":{\"type\":\"roaring\"},\"nest\":{\"$.x\":{\"types\":[\"LONG\"],\"dictionary\":[{\"localId\":0,\"globalId\":0,\"value\":null,\"rows\":[4]},{\"localId\":1,\"globalId\":3,\"value\":\"100\",\"rows\":[3]},{\"localId\":2,\"globalId\":4,\"value\":\"200\",\"rows\":[0,2]},{\"localId\":3,\"globalId\":5,\"value\":\"400\",\"rows\":[1]}],\"column\":[{\"row\":0,\"raw\":{\"x\":200,\"y\":2.2},\"fieldId\":2,\"fieldValue\":\"200\"},{\"row\":1,\"raw\":{\"x\":400,\"y\":1.1,\"z\":\"a\"},\"fieldId\":3,\"fieldValue\":\"400\"},{\"row\":2,\"raw\":{\"x\":200,\"z\":\"b\"},\"fieldId\":2,\"fieldValue\":\"200\"},{\"row\":3,\"raw\":{\"x\":100,\"y\":1.1,\"z\":\"a\"},\"fieldId\":1,\"fieldValue\":\"100\"},{\"row\":4,\"raw\":{\"y\":3.3,\"z\":\"b\"},\"fieldId\":0,\"fieldValue\":null}]}}}"</span>, output);

    } <span class="hljs-keyword">else</span> {

        Assert.assertEquals(<span class="hljs-string">"{\"bitmapSerdeFactory\":{\"type\":\"roaring\"},\"nest\":{\"$.x\":{\"types\":[\"LONG\"],\"dictionary\":[{\"localId\":0,\"globalId\":0,\"value\":null,\"rows\":[4]},{\"localId\":1,\"globalId\":4,\"value\":\"100\",\"rows\":[3]},{\"localId\":2,\"globalId\":5,\"value\":\"200\",\"rows\":[0,2]},{\"localId\":3,\"globalId\":6,\"value\":\"400\",\"rows\":[1]}],\"column\":[{\"row\":0,\"raw\":{\"x\":200,\"y\":2.2},\"fieldId\":2,\"fieldValue\":\"200\"},{\"row\":1,\"raw\":{\"x\":400,\"y\":1.1,\"z\":\"a\"},\"fieldId\":3,\"fieldValue\":\"400\"},{\"row\":2,\"raw\":{\"x\":200,\"z\":\"b\"},\"fieldId\":2,\"fieldValue\":\"200\"},{\"row\":3,\"raw\":{\"x\":100,\"y\":1.1,\"z\":\"a\"},\"fieldId\":1,\"fieldValue\":\"100\"},{\"row\":4,\"raw\":{\"y\":3.3,\"z\":\"b\"},\"fieldId\":0,\"fieldValue\":null}]}}}"</span>, output);

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Injector <span class="hljs-title">createMockInjector</span><span class="hljs-params">(ObjectMapper objectMapper, Key&lt;ObjectMapper&gt; objectMapperKey)</span> </span>{
    Injector injector = Mockito.mock(Injector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(injector.getInstance(objectMapperKey)).thenReturn(objectMapper);
    <span class="hljs-keyword">return</span> injector;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci39">Mock Clone Instance #druid_MCI_39</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.segment.column.ColumnIndexSupplier</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockColumnIndexSupplier</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ColumnIndexSupplier <span class="hljs-title">createMockColumnIndexSupplier</span><span class="hljs-params">(StringValueSetIndexes valueIndex)</span> </span>{
    ColumnIndexSupplier indexSupplier = Mockito.mock(ColumnIndexSupplier<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(indexSupplier.as(StringValueSetIndexes<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">valueIndex</span>)</span>;
    <span class="hljs-keyword">return</span> indexSupplier;
  }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest391">Test Case ID #druid_Test_39_1</h4>
<h4 id="test-case-name-testusesstringsetindexfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidqueryfilterindimfiltertestjava">Test Case Name: <code>testUsesStringSetIndex</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\filter\InDimFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-indexsupplier">Mock Object Variable Name: <code>indexSupplier</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final Filter inFilter = new InDimFilter("dim0", ImmutableSet.of("v1", "v2")).toFilter();
    final ColumnIndexSelector indexSelector = Mockito.mock(ColumnIndexSelector.class);
<span class="hljs-deletion">-    final ColumnIndexSupplier indexSupplier = Mockito.mock(ColumnIndexSupplier.class);</span>
    final StringValueSetIndexes valueIndex = Mockito.mock(StringValueSetIndexes.class);
    final BitmapColumnIndex bitmapColumnIndex = Mockito.mock(BitmapColumnIndex.class);
    final InDimFilter.ValuesSet expectedValuesSet = new InDimFilter.ValuesSet();
    expectedValuesSet.addAll(Arrays.asList("v1", "v2"));
<span class="hljs-addition">+    final ColumnIndexSupplier indexSupplier = MockColumnIndexSupplier.createMockColumnIndexSupplier(valueIndex);</span>
    Mockito.when(indexSelector.getIndexSupplier("dim0")).thenReturn(indexSupplier);
<span class="hljs-deletion">-    // Will check for UTF-8 first.</span>
<span class="hljs-deletion">-    Mockito.when(indexSupplier.as(Utf8ValueSetIndexes.class)).thenReturn(null);</span>
    Mockito.when(valueIndex.forSortedValues(expectedValuesSet)).thenReturn(bitmapColumnIndex);
    final BitmapColumnIndex retVal = inFilter.getBitmapColumnIndex(indexSelector);
    Assert.assertSame("inFilter returns the intended bitmapColumnIndex", bitmapColumnIndex, retVal);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testUsesStringSetIndex</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// An implementation test.</span>

    <span class="hljs-comment">// This test confirms that "in" filters use non-utf8 string index lookups when utf8 indexes are not available.</span>

    <span class="hljs-keyword">final</span> Filter inFilter = <span class="hljs-keyword">new</span> InDimFilter(<span class="hljs-string">"dim0"</span>, ImmutableSet.of(<span class="hljs-string">"v1"</span>, <span class="hljs-string">"v2"</span>)).toFilter();

    <span class="hljs-keyword">final</span> ColumnIndexSelector indexSelector = Mockito.mock(ColumnIndexSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ColumnIndexSupplier indexSupplier = Mockito.mock(ColumnIndexSupplier<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> StringValueSetIndexes valueIndex = Mockito.mock(StringValueSetIndexes<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> BitmapColumnIndex bitmapColumnIndex = Mockito.mock(BitmapColumnIndex<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> InDimFilter.ValuesSet expectedValuesSet = <span class="hljs-keyword">new</span> InDimFilter.ValuesSet();

    expectedValuesSet.addAll(Arrays.asList(<span class="hljs-string">"v1"</span>, <span class="hljs-string">"v2"</span>));

    Mockito.when(indexSelector.getIndexSupplier(<span class="hljs-string">"dim0"</span>)).thenReturn(indexSupplier);

    <span class="hljs-comment">// Will check for UTF-8 first.</span>

    Mockito.when(indexSupplier.as(Utf8ValueSetIndexes<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">null</span>)</span>;

    Mockito.when(indexSupplier.as(StringValueSetIndexes<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">valueIndex</span>)</span>;

    Mockito.when(valueIndex.forSortedValues(expectedValuesSet)).thenReturn(bitmapColumnIndex);

    <span class="hljs-keyword">final</span> BitmapColumnIndex retVal = inFilter.getBitmapColumnIndex(indexSelector);

    Assert.assertSame(<span class="hljs-string">"inFilter returns the intended bitmapColumnIndex"</span>, bitmapColumnIndex, retVal);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockColumnIndexSupplier</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ColumnIndexSupplier <span class="hljs-title">createMockColumnIndexSupplier</span><span class="hljs-params">(StringValueSetIndexes valueIndex)</span> </span>{
    ColumnIndexSupplier indexSupplier = Mockito.mock(ColumnIndexSupplier<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(indexSupplier.as(StringValueSetIndexes<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">valueIndex</span>)</span>;
    <span class="hljs-keyword">return</span> indexSupplier;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest392">Test Case ID #druid_Test_39_2</h4>
<h4 id="test-case-name-testexactmatchusesvalueindexfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidqueryfilterlikedimfiltertestjava">Test Case Name: <code>testExactMatchUsesValueIndex</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\filter\LikeDimFilterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-indexsupplier">Mock Object Variable Name: <code>indexSupplier</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final Filter likeFilter = new LikeDimFilter("dim0", "f", null, null, null).toFilter();
    final ColumnIndexSelector indexSelector = Mockito.mock(ColumnIndexSelector.class);
<span class="hljs-deletion">-    final ColumnIndexSupplier indexSupplier = Mockito.mock(ColumnIndexSupplier.class);</span>
    final StringValueSetIndexes valueIndex = Mockito.mock(StringValueSetIndexes.class);
    final BitmapColumnIndex bitmapColumnIndex = Mockito.mock(BitmapColumnIndex.class);
<span class="hljs-addition">+    final ColumnIndexSupplier indexSupplier = MockColumnIndexSupplier.createMockColumnIndexSupplier(valueIndex);</span>
    Mockito.when(indexSelector.getIndexSupplier("dim0")).thenReturn(indexSupplier);
<span class="hljs-deletion">-    Mockito.when(indexSupplier.as(StringValueSetIndexes.class)).thenReturn(valueIndex);</span>
    Mockito.when(valueIndex.forValue("f")).thenReturn(bitmapColumnIndex);
    final BitmapColumnIndex retVal = likeFilter.getBitmapColumnIndex(indexSelector);
    Assert.assertSame("likeFilter returns the intended bitmapColumnIndex", bitmapColumnIndex, retVal);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testExactMatchUsesValueIndex</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// An implementation test.</span>

    <span class="hljs-comment">// This test confirms that "like" filters with exact matchers use index lookups.</span>

    <span class="hljs-keyword">final</span> Filter likeFilter = <span class="hljs-keyword">new</span> LikeDimFilter(<span class="hljs-string">"dim0"</span>, <span class="hljs-string">"f"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>).toFilter();

    <span class="hljs-keyword">final</span> ColumnIndexSelector indexSelector = Mockito.mock(ColumnIndexSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ColumnIndexSupplier indexSupplier = Mockito.mock(ColumnIndexSupplier<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> StringValueSetIndexes valueIndex = Mockito.mock(StringValueSetIndexes<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> BitmapColumnIndex bitmapColumnIndex = Mockito.mock(BitmapColumnIndex<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(indexSelector.getIndexSupplier(<span class="hljs-string">"dim0"</span>)).thenReturn(indexSupplier);

    Mockito.when(indexSupplier.as(StringValueSetIndexes<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">valueIndex</span>)</span>;

    Mockito.when(valueIndex.forValue(<span class="hljs-string">"f"</span>)).thenReturn(bitmapColumnIndex);

    <span class="hljs-keyword">final</span> BitmapColumnIndex retVal = likeFilter.getBitmapColumnIndex(indexSelector);

    Assert.assertSame(<span class="hljs-string">"likeFilter returns the intended bitmapColumnIndex"</span>, bitmapColumnIndex, retVal);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockColumnIndexSupplier</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ColumnIndexSupplier <span class="hljs-title">createMockColumnIndexSupplier</span><span class="hljs-params">(StringValueSetIndexes valueIndex)</span> </span>{
    ColumnIndexSupplier indexSupplier = Mockito.mock(ColumnIndexSupplier<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(indexSupplier.as(StringValueSetIndexes<span class="hljs-class">.<span class="hljs-keyword">class</span>)).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">valueIndex</span>)</span>;
    <span class="hljs-keyword">return</span> indexSupplier;
  }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci40">Mock Clone Instance #druid_MCI_40</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.java.util.metrics.Monitor</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Monitor monitor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    monitor = Mockito.mock(Monitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
monitor;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest401">Test Case ID #druid_Test_40_1</h4>
<h4 id="test-case-name-teststartrepeatschedulingfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidjavautilmetricsclockdriftsafemonitorschedulertestjava">Test Case Name: <code>testStart_RepeatScheduling</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\java\util\metrics\ClockDriftSafeMonitorSchedulerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-monitor">Mock Object Variable Name: <code>monitor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     Mockito.doAnswer(new Answer&lt;Future&lt;?&gt;&gt;() {
 
         private int scheduleCount = 0;
 
         @SuppressWarnings("unchecked")
         @Override
         public Future&lt;?&gt; answer(InvocationOnMock invocation) {
             final Object originalArgument = (invocation.getArguments())[3];
             CronTask task = ((CronTask) originalArgument);
             Mockito.doAnswer(new Answer&lt;Future&lt;?&gt;&gt;() {
 
                 @Override
                 public Future&lt;Boolean&gt; answer(InvocationOnMock invocation) throws Exception {
                     final Object originalArgument = (invocation.getArguments())[0];
                     ((Callable&lt;Boolean&gt;) originalArgument).call();
                     return CompletableFuture.completedFuture(Boolean.TRUE);
                 }
             }).when(executor).submit(ArgumentMatchers.any(Callable.class));
             cronTaskRunner.submit(() -&gt; {
                 while (scheduleCount &lt; 2) {
                     scheduleCount++;
                     task.run(123L);
                 }
                 latch.countDown();
                 return null;
             });
             return createDummyFuture();
         }
     }).when(cronScheduler).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask.class));
<span class="hljs-deletion">-    Monitor monitor = Mockito.mock(Monitor.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `monitor`</span>
     DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig.class);
     Mockito.when(config.getEmissionDuration()).thenReturn(new org.joda.time.Duration(1000L));
     final MonitorScheduler scheduler = new ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter.class), ImmutableList.of(monitor), cronScheduler, executor);
     scheduler.start();
     latch.await(5, TimeUnit.SECONDS);
@@
<span class="hljs-deletion">-    Mockito.verify(monitor, Mockito.times(1)).start();</span>
<span class="hljs-addition">+    Mockito.verify(monitor, Mockito.times(1)).start();</span>
     Mockito.verify(cronScheduler, Mockito.times(1)).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask.class));
     Mockito.verify(executor, Mockito.times(2)).submit(ArgumentMatchers.any(Callable.class));
<span class="hljs-deletion">-    Mockito.verify(monitor, Mockito.times(2)).monitor(ArgumentMatchers.any());</span>
<span class="hljs-addition">+    Mockito.verify(monitor, Mockito.times(2)).monitor(ArgumentMatchers.any());</span>
     scheduler.stop();
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStart_RepeatScheduling</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    ExecutorService executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    Mockito.doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Future&lt;?&gt;&gt;() {



        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> scheduleCount = <span class="hljs-number">0</span>;



        <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> Future&lt;?&gt; answer(InvocationOnMock invocation) {

            <span class="hljs-keyword">final</span> Object originalArgument = (invocation.getArguments())[<span class="hljs-number">3</span>];

            CronTask task = ((CronTask) originalArgument);

            Mockito.doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Future&lt;?&gt;&gt;() {



                <span class="hljs-meta">@Override</span>

                <span class="hljs-function"><span class="hljs-keyword">public</span> Future&lt;Boolean&gt; <span class="hljs-title">answer</span><span class="hljs-params">(InvocationOnMock invocation)</span> <span class="hljs-keyword">throws</span> Exception </span>{

                    <span class="hljs-keyword">final</span> Object originalArgument = (invocation.getArguments())[<span class="hljs-number">0</span>];

                    ((Callable&lt;Boolean&gt;) originalArgument).call();

                    <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(Boolean.TRUE);

                }

            }).when(executor).submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

            cronTaskRunner.submit(() -&gt; {

                <span class="hljs-keyword">while</span> (scheduleCount &lt; <span class="hljs-number">2</span>) {

                    scheduleCount++;

                    task.run(<span class="hljs-number">123L</span>);

                }

                latch.countDown();

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

            });

            <span class="hljs-keyword">return</span> createDummyFuture();

        }

    }).when(cronScheduler).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Monitor monitor = Mockito.mock(Monitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(config.getEmissionDuration()).thenReturn(<span class="hljs-keyword">new</span> org.joda.time.Duration(<span class="hljs-number">1000L</span>));

    <span class="hljs-keyword">final</span> MonitorScheduler scheduler = <span class="hljs-keyword">new</span> ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">ImmutableList</span>.<span class="hljs-title">of</span>(<span class="hljs-title">monitor</span>), <span class="hljs-title">cronScheduler</span>, <span class="hljs-title">executor</span>)</span>;

    scheduler.start();

    latch.await(<span class="hljs-number">5</span>, TimeUnit.SECONDS);

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">1</span>)).start();

    Mockito.verify(cronScheduler, Mockito.times(<span class="hljs-number">1</span>)).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.verify(executor, Mockito.times(<span class="hljs-number">2</span>)).submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">2</span>)).monitor(ArgumentMatchers.any());

    scheduler.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Monitor monitor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    monitor = Mockito.mock(Monitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
monitor;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest402">Test Case ID #druid_Test_40_2</h4>
<h4 id="test-case-name-teststartrepeatandstopschedulingfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidjavautilmetricsclockdriftsafemonitorschedulertestjava">Test Case Name: <code>testStart_RepeatAndStopScheduling</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\java\util\metrics\ClockDriftSafeMonitorSchedulerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-monitor">Mock Object Variable Name: <code>monitor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     Mockito.doAnswer(new Answer&lt;Future&lt;?&gt;&gt;() {
         public Future&lt;?&gt; answer(InvocationOnMock invocation) {
             final Object originalArgument = (invocation.getArguments())[3];
             CronTask task = ((CronTask) originalArgument);
             Mockito.doAnswer(new Answer&lt;Future&lt;?&gt;&gt;() {
                 public Future&lt;Boolean&gt; answer(InvocationOnMock invocation) throws Exception {
                     final Object originalArgument = (invocation.getArguments())[0];
                     ((Callable&lt;Boolean&gt;) originalArgument).call();
                     return CompletableFuture.completedFuture(Boolean.FALSE);
                 }
             }).when(executor).submit(ArgumentMatchers.any(Callable.class));
             cronTaskRunner.submit(() -&gt; {
                 while (scheduleCount &lt; 2) {
                     scheduleCount++;
                     task.run(123L);
                 }
                 latch.countDown();
                 return null;
             });
             return createDummyFuture();
         }
     }).when(cronScheduler).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask.class));
<span class="hljs-deletion">-    Monitor monitor = Mockito.mock(Monitor.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `monitor`</span>
     DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig.class);
     Mockito.when(config.getEmissionDuration()).thenReturn(new org.joda.time.Duration(1000L));
     final MonitorScheduler scheduler = new ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter.class), ImmutableList.of(monitor), cronScheduler, executor);
     scheduler.start();
     latch.await(5, TimeUnit.SECONDS);
@@
<span class="hljs-deletion">-    Mockito.verify(monitor, Mockito.times(1)).start();</span>
<span class="hljs-addition">+    Mockito.verify(monitor, Mockito.times(1)).start();</span>
     Mockito.verify(cronScheduler, Mockito.times(1)).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask.class));
     Mockito.verify(executor, Mockito.times(1)).submit(ArgumentMatchers.any(Callable.class));
@@
<span class="hljs-deletion">-    Mockito.verify(monitor, Mockito.times(2)).monitor(ArgumentMatchers.any());</span>
<span class="hljs-addition">+    Mockito.verify(monitor, Mockito.times(2)).monitor(ArgumentMatchers.any());</span>
<span class="hljs-deletion">-    Mockito.verify(monitor, Mockito.times(1)).stop();</span>
<span class="hljs-addition">+    Mockito.verify(monitor, Mockito.times(1)).stop();</span>
     scheduler.stop();
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStart_RepeatAndStopScheduling</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    ExecutorService executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    Mockito.doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Future&lt;?&gt;&gt;() {



        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> scheduleCount = <span class="hljs-number">0</span>;



        <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> Future&lt;?&gt; answer(InvocationOnMock invocation) {

            <span class="hljs-keyword">final</span> Object originalArgument = (invocation.getArguments())[<span class="hljs-number">3</span>];

            CronTask task = ((CronTask) originalArgument);

            Mockito.doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Future&lt;?&gt;&gt;() {



                <span class="hljs-meta">@Override</span>

                <span class="hljs-function"><span class="hljs-keyword">public</span> Future&lt;Boolean&gt; <span class="hljs-title">answer</span><span class="hljs-params">(InvocationOnMock invocation)</span> <span class="hljs-keyword">throws</span> Exception </span>{

                    <span class="hljs-keyword">final</span> Object originalArgument = (invocation.getArguments())[<span class="hljs-number">0</span>];

                    ((Callable&lt;Boolean&gt;) originalArgument).call();

                    <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(Boolean.FALSE);

                }

            }).when(executor).submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

            cronTaskRunner.submit(() -&gt; {

                <span class="hljs-keyword">while</span> (scheduleCount &lt; <span class="hljs-number">2</span>) {

                    scheduleCount++;

                    task.run(<span class="hljs-number">123L</span>);

                }

                latch.countDown();

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

            });

            <span class="hljs-keyword">return</span> createDummyFuture();

        }

    }).when(cronScheduler).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Monitor monitor = Mockito.mock(Monitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(config.getEmissionDuration()).thenReturn(<span class="hljs-keyword">new</span> org.joda.time.Duration(<span class="hljs-number">1000L</span>));

    <span class="hljs-keyword">final</span> MonitorScheduler scheduler = <span class="hljs-keyword">new</span> ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">ImmutableList</span>.<span class="hljs-title">of</span>(<span class="hljs-title">monitor</span>), <span class="hljs-title">cronScheduler</span>, <span class="hljs-title">executor</span>)</span>;

    scheduler.start();

    latch.await(<span class="hljs-number">5</span>, TimeUnit.SECONDS);

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">1</span>)).start();

    Mockito.verify(cronScheduler, Mockito.times(<span class="hljs-number">1</span>)).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.verify(executor, Mockito.times(<span class="hljs-number">1</span>)).submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">2</span>)).monitor(ArgumentMatchers.any());

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">1</span>)).stop();

    scheduler.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Monitor monitor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    monitor = Mockito.mock(Monitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
monitor;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest403">Test Case ID #druid_Test_40_3</h4>
<h4 id="test-case-name-teststartunexpectedexceptionwhileschedulingfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidjavautilmetricsclockdriftsafemonitorschedulertestjava">Test Case Name: <code>testStart_UnexpectedExceptionWhileScheduling</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\java\util\metrics\ClockDriftSafeMonitorSchedulerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-monitor">Mock Object Variable Name: <code>monitor</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testStart_UnexpectedExceptionWhileScheduling() throws InterruptedException {
     ExecutorService executor = Mockito.mock(ExecutorService.class);
<span class="hljs-deletion">-    Monitor monitor = Mockito.mock(Monitor.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `monitor`</span>
     DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig.class);
     Mockito.when(config.getEmissionDuration()).thenReturn(new org.joda.time.Duration(1000L));
     CountDownLatch latch = new CountDownLatch(1);
     Mockito.doAnswer(new Answer&lt;Future&lt;?&gt;&gt;() {

         @SuppressWarnings("unchecked")
         @Override
         public Future&lt;?&gt; answer(InvocationOnMock invocation) {
             final Object originalArgument = (invocation.getArguments())[3];
             CronTask task = ((CronTask) originalArgument);
             Mockito.when(executor.submit(ArgumentMatchers.any(Callable.class))).thenThrow(new RuntimeException("Test throwing exception while scheduling"));
             cronTaskRunner.submit(() -&gt; {
                 task.run(123L);
                 latch.countDown();
                 return null;
             });
             return createDummyFuture();
         }
     }).when(cronScheduler).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask.class));
     final MonitorScheduler scheduler = new ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter.class), ImmutableList.of(monitor), cronScheduler, executor);
     scheduler.start();
     latch.await(5, TimeUnit.SECONDS);
<span class="hljs-deletion">-    Mockito.verify(monitor, Mockito.times(1)).start();</span>
<span class="hljs-addition">+    Mockito.verify(monitor, Mockito.times(1)).start();</span>
     Mockito.verify(cronScheduler, Mockito.times(1)).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask.class));
     Mockito.verify(executor, Mockito.times(1)).submit(ArgumentMatchers.any(Callable.class));
     scheduler.stop();
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStart_UnexpectedExceptionWhileScheduling</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{

    ExecutorService executor = Mockito.mock(ExecutorService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Monitor monitor = Mockito.mock(Monitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DruidMonitorSchedulerConfig config = Mockito.mock(DruidMonitorSchedulerConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(config.getEmissionDuration()).thenReturn(<span class="hljs-keyword">new</span> org.joda.time.Duration(<span class="hljs-number">1000L</span>));

    CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">1</span>);

    Mockito.doAnswer(<span class="hljs-keyword">new</span> Answer&lt;Future&lt;?&gt;&gt;() {



        <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)

        <span class="hljs-meta">@Override</span>

        <span class="hljs-keyword">public</span> Future&lt;?&gt; answer(InvocationOnMock invocation) {

            <span class="hljs-keyword">final</span> Object originalArgument = (invocation.getArguments())[<span class="hljs-number">3</span>];

            CronTask task = ((CronTask) originalArgument);

            Mockito.when(executor.submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenThrow</span>(<span class="hljs-title">new</span> <span class="hljs-title">RuntimeException</span>("<span class="hljs-title">Test</span> <span class="hljs-title">throwing</span> <span class="hljs-title">exception</span> <span class="hljs-title">while</span> <span class="hljs-title">scheduling</span>"))</span>;

            cronTaskRunner.submit(() -&gt; {

                task.run(<span class="hljs-number">123L</span>);

                latch.countDown();

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;

            });

            <span class="hljs-keyword">return</span> createDummyFuture();

        }

    }).when(cronScheduler).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    <span class="hljs-keyword">final</span> MonitorScheduler scheduler = <span class="hljs-keyword">new</span> ClockDriftSafeMonitorScheduler(config, Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">ImmutableList</span>.<span class="hljs-title">of</span>(<span class="hljs-title">monitor</span>), <span class="hljs-title">cronScheduler</span>, <span class="hljs-title">executor</span>)</span>;

    scheduler.start();

    latch.await(<span class="hljs-number">5</span>, TimeUnit.SECONDS);

    Mockito.verify(monitor, Mockito.times(<span class="hljs-number">1</span>)).start();

    Mockito.verify(cronScheduler, Mockito.times(<span class="hljs-number">1</span>)).scheduleAtFixedRate(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.any(), ArgumentMatchers.any(CronTask<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.verify(executor, Mockito.times(<span class="hljs-number">1</span>)).submit(ArgumentMatchers.any(Callable<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    scheduler.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> Monitor monitor;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    monitor = Mockito.mock(Monitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
monitor;

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci41">Mock Clone Instance #druid_MCI_41</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.tasklogs.TaskLogs</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockTaskLogs</span> </span>{
  <span class="hljs-comment">/**
   * Creates a mock TaskLogs with stubbed streamTaskPayload behavior.
   *
   * <span class="hljs-doctag">@param</span> id The id argument to match in streamTaskPayload.
   * <span class="hljs-doctag">@param</span> payloadStream The ByteArrayInputStream to wrap in Optional and return.
   * <span class="hljs-doctag">@return</span> Configured mock TaskLogs instance.
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TaskLogs <span class="hljs-title">createMockTaskLogs</span><span class="hljs-params">(String id, ByteArrayInputStream payloadStream)</span> </span>{
    TaskLogs mockTaskLogs = Mockito.mock(TaskLogs<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(mockTaskLogs.streamTaskPayload(id))
           .thenReturn(com.google.common.base.Optional.of(payloadStream));
    <span class="hljs-keyword">return</span> mockTaskLogs;
  }
}

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest411">Test Case ID #druid_Test_41_1</h4>
<h4 id="test-case-name-totaskusetaskpayloadmanagerfile-cjavaprojectsapachedruidextensions-contribkubernetes-overlord-extensionssrctestjavaorgapachedruidk8soverlordtaskadapterk8staskadaptertestjava">Test Case Name: <code>toTask_useTaskPayloadManager</code>(File: <code>C:\Java_projects\Apache\druid\extensions-contrib\kubernetes-overlord-extensions\src\test\java\org\apache\druid\k8s\overlord\taskadapter\K8sTaskAdapterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mocktestlogs">Mock Object Variable Name: <code>mockTestLogs</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    Task taskInTaskPayloadManager = K8sTestUtils.getTask();
<span class="hljs-deletion">-    TaskLogs mockTestLogs = Mockito.mock(TaskLogs.class);</span>
<span class="hljs-deletion">-    Mockito.when(mockTestLogs.streamTaskPayload("ID")).thenReturn(com.google.common.base.Optional.of(new ByteArrayInputStream(jsonMapper.writeValueAsString(taskInTaskPayloadManager).getBytes(Charset.defaultCharset()))));</span>
<span class="hljs-addition">+    TaskLogs mockTestLogs = MockTaskLogs.createMockTaskLogs(</span>
<span class="hljs-addition">+        "ID",</span>
<span class="hljs-addition">+        new ByteArrayInputStream(jsonMapper.writeValueAsString(taskInTaskPayloadManager).getBytes(Charset.defaultCharset()))</span>
<span class="hljs-addition">+    );</span>
    K8sTaskAdapter adapter = new SingleContainerTaskAdapter(testClient, config, taskConfig, startupLoggingConfig, node, jsonMapper, mockTestLogs);
    Job job = new JobBuilder().editMetadata().withName("job").endMetadata().editSpec().editTemplate().editMetadata().addToAnnotations(DruidK8sConstants.TASK_ID, "ID").endMetadata().editSpec().addToContainers(new ContainerBuilder().withName("main").build()).endSpec().endTemplate().endSpec().build();
    Task taskFromJob = adapter.toTask(job);
    assertEquals(taskInTaskPayloadManager, taskFromJob);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">toTask_useTaskPayloadManager</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{

    TestKubernetesClient testClient = <span class="hljs-keyword">new</span> TestKubernetesClient(client);

    KubernetesTaskRunnerConfig config = KubernetesTaskRunnerConfig.builder().withNamespace(<span class="hljs-string">"test"</span>).build();

    Task taskInTaskPayloadManager = K8sTestUtils.getTask();

    TaskLogs mockTestLogs = Mockito.mock(TaskLogs<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(mockTestLogs.streamTaskPayload(<span class="hljs-string">"ID"</span>)).thenReturn(com.google.common.base.Optional.of(<span class="hljs-keyword">new</span> ByteArrayInputStream(jsonMapper.writeValueAsString(taskInTaskPayloadManager).getBytes(Charset.defaultCharset()))));

    K8sTaskAdapter adapter = <span class="hljs-keyword">new</span> SingleContainerTaskAdapter(testClient, config, taskConfig, startupLoggingConfig, node, jsonMapper, mockTestLogs);

    Job job = <span class="hljs-keyword">new</span> JobBuilder().editMetadata().withName(<span class="hljs-string">"job"</span>).endMetadata().editSpec().editTemplate().editMetadata().addToAnnotations(DruidK8sConstants.TASK_ID, <span class="hljs-string">"ID"</span>).endMetadata().editSpec().addToContainers(<span class="hljs-keyword">new</span> ContainerBuilder().withName(<span class="hljs-string">"main"</span>).build()).endSpec().endTemplate().endSpec().build();

    Task taskFromJob = adapter.toTask(job);

    assertEquals(taskInTaskPayloadManager, taskFromJob);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockTaskLogs</span> </span>{
  <span class="hljs-comment">/**
   * Creates a mock TaskLogs with stubbed streamTaskPayload behavior.
   *
   * <span class="hljs-doctag">@param</span> id The id argument to match in streamTaskPayload.
   * <span class="hljs-doctag">@param</span> payloadStream The ByteArrayInputStream to wrap in Optional and return.
   * <span class="hljs-doctag">@return</span> Configured mock TaskLogs instance.
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TaskLogs <span class="hljs-title">createMockTaskLogs</span><span class="hljs-params">(String id, ByteArrayInputStream payloadStream)</span> </span>{
    TaskLogs mockTaskLogs = Mockito.mock(TaskLogs<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(mockTaskLogs.streamTaskPayload(id))
           .thenReturn(com.google.common.base.Optional.of(payloadStream));
    <span class="hljs-keyword">return</span> mockTaskLogs;
  }
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest412">Test Case ID #druid_Test_41_2</h4>
<h4 id="test-case-name-testtotaskusetaskpayloadmanagerfile-cjavaprojectsapachedruidextensions-contribkubernetes-overlord-extensionssrctestjavaorgapachedruidk8soverlordtaskadapterpodtemplatetaskadaptertestjava">Test Case Name: <code>test_toTask_useTaskPayloadManager</code>(File: <code>C:\Java_projects\Apache\druid\extensions-contrib\kubernetes-overlord-extensions\src\test\java\org\apache\druid\k8s\overlord\taskadapter\PodTemplateTaskAdapterTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mocktestlogs">Mock Object Variable Name: <code>mockTestLogs</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Task expected = new NoopTask("id", null, "datasource", 0, 0, ImmutableMap.of());
<span class="hljs-deletion">-    TaskLogs mockTestLogs = Mockito.mock(TaskLogs.class);</span>
<span class="hljs-deletion">-    Mockito.when(mockTestLogs.streamTaskPayload("id")).thenReturn(Optional.of(new ByteArrayInputStream(mapper.writeValueAsString(expected).getBytes(Charset.defaultCharset()))));</span>
<span class="hljs-addition">+    TaskLogs mockTestLogs = MockTaskLogs.createMockTaskLogs(</span>
<span class="hljs-addition">+        "id",</span>
<span class="hljs-addition">+        new ByteArrayInputStream(mapper.writeValueAsString(expected).getBytes(Charset.defaultCharset()))</span>
<span class="hljs-addition">+    );</span>
    PodTemplateTaskAdapter adapter = new PodTemplateTaskAdapter(taskRunnerConfig, taskConfig, node, mapper, props, mockTestLogs);
    Job job = K8sTestUtils.fileToResource("expectedNoopJob.yaml", Job.class);
    Task actual = adapter.toTask(job);
    Assertions.assertEquals(expected, actual);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test_toTask_useTaskPayloadManager</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{

    Path templatePath = Files.createFile(tempDir.resolve(<span class="hljs-string">"base.yaml"</span>));

    mapper.writeValue(templatePath.toFile(), podTemplateSpec);

    Properties props = <span class="hljs-keyword">new</span> Properties();

    props.put(<span class="hljs-string">"druid.indexer.runner.k8s.podTemplate.base"</span>, templatePath.toString());

    Task expected = <span class="hljs-keyword">new</span> NoopTask(<span class="hljs-string">"id"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">"datasource"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ImmutableMap.of());

    TaskLogs mockTestLogs = Mockito.mock(TaskLogs<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(mockTestLogs.streamTaskPayload(<span class="hljs-string">"id"</span>)).thenReturn(Optional.of(<span class="hljs-keyword">new</span> ByteArrayInputStream(mapper.writeValueAsString(expected).getBytes(Charset.defaultCharset()))));

    PodTemplateTaskAdapter adapter = <span class="hljs-keyword">new</span> PodTemplateTaskAdapter(taskRunnerConfig, taskConfig, node, mapper, props, mockTestLogs);

    Job job = K8sTestUtils.fileToResource(<span class="hljs-string">"expectedNoopJob.yaml"</span>, Job<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Task actual = adapter.toTask(job);

    Assertions.assertEquals(expected, actual);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockTaskLogs</span> </span>{
  <span class="hljs-comment">/**
   * Creates a mock TaskLogs with stubbed streamTaskPayload behavior.
   *
   * <span class="hljs-doctag">@param</span> id The id argument to match in streamTaskPayload.
   * <span class="hljs-doctag">@param</span> payloadStream The ByteArrayInputStream to wrap in Optional and return.
   * <span class="hljs-doctag">@return</span> Configured mock TaskLogs instance.
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TaskLogs <span class="hljs-title">createMockTaskLogs</span><span class="hljs-params">(String id, ByteArrayInputStream payloadStream)</span> </span>{
    TaskLogs mockTaskLogs = Mockito.mock(TaskLogs<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(mockTaskLogs.streamTaskPayload(id))
           .thenReturn(com.google.common.base.Optional.of(payloadStream));
    <span class="hljs-keyword">return</span> mockTaskLogs;
  }
}

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci42">Mock Clone Instance #druid_MCI_42</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.tasklogs.TaskLogPusher</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> TaskLogPusher pusher;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    pusher = mock(TaskLogPusher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
pusher

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest421">Test Case ID #druid_Test_42_1</h4>
<h4 id="test-case-name-testsetupandcleanupiscalledwtihparameterfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommontaskabstracttasktestjava">Test Case Name: <code>testSetupAndCleanupIsCalledWtihParameter</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\task\AbstractTaskTest.java</code>)</h4>
<h4 id="mock-object-variable-name-pusher">Mock Object Variable Name: <code>pusher</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     when(toolbox.getTaskExecutorNode()).thenReturn(node);
<span class="hljs-deletion">-    TaskLogPusher pusher = mock(TaskLogPusher.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `pusher`</span>
     when(toolbox.getTaskLogPusher()).thenReturn(pusher);
     TaskConfig config = mock(TaskConfig.class);
@@
     Mockito.verify(taskActionClient, times(3)).submit(any());
<span class="hljs-deletion">-    verify(pusher, times(1)).pushTaskReports(eq("myID"), any());</span>
<span class="hljs-addition">+    verify(pusher, times(1)).pushTaskReports(eq("myID"), any());</span>
<span class="hljs-deletion">-    verify(pusher, times(1)).pushTaskStatus(eq("myID"), any());</span>
<span class="hljs-addition">+    verify(pusher, times(1)).pushTaskStatus(eq("myID"), any());</span>
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSetupAndCleanupIsCalledWtihParameter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    <span class="hljs-comment">// These tests apparently use Mockito.  Mockito is bad as we've seen it rewrite byte code and effectively cause</span>

    <span class="hljs-comment">// impact to other totally unrelated tests.  Mockito needs to be completely erradicated from the codebase.  This</span>

    <span class="hljs-comment">// comment is here to either cause me to do it in this commit or just for posterity so that it is clear that it</span>

    <span class="hljs-comment">// should happen in the future.</span>

    TaskToolbox toolbox = mock(TaskToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getAttemptId()).thenReturn(<span class="hljs-string">"1"</span>);

    DruidNode node = <span class="hljs-keyword">new</span> DruidNode(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>);

    when(toolbox.getTaskExecutorNode()).thenReturn(node);

    TaskLogPusher pusher = mock(TaskLogPusher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskLogPusher()).thenReturn(pusher);

    TaskConfig config = mock(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(config.isEncapsulatedTask()).thenReturn(<span class="hljs-keyword">true</span>);

    File folder = temporaryFolder.newFolder();

    when(config.getTaskDir(eq(<span class="hljs-string">"myID"</span>))).thenReturn(folder);

    when(toolbox.getConfig()).thenReturn(config);

    when(toolbox.getJsonMapper()).thenReturn(objectMapper);

    TaskActionClient taskActionClient = mock(TaskActionClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskActionClient.submit(any())).thenReturn(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);

    AbstractTask task = <span class="hljs-keyword">new</span> NoopTask(<span class="hljs-string">"myID"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>) {



        <span class="hljs-meta">@Nullable</span>

        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">setup</span><span class="hljs-params">(TaskToolbox toolbox)</span> <span class="hljs-keyword">throws</span> Exception </span>{

            <span class="hljs-comment">// create a reports file to test the taskLogPusher pushes task reports</span>

            String result = <span class="hljs-keyword">super</span>.setup(toolbox);

            File attemptDir = Paths.get(folder.getAbsolutePath(), <span class="hljs-string">"attempt"</span>, toolbox.getAttemptId()).toFile();

            File reportsDir = <span class="hljs-keyword">new</span> File(attemptDir, <span class="hljs-string">"report.json"</span>);

            File statusDir = <span class="hljs-keyword">new</span> File(attemptDir, <span class="hljs-string">"status.json"</span>);

            FileUtils.write(reportsDir, <span class="hljs-string">"foo"</span>, StandardCharsets.UTF_8);

            FileUtils.write(statusDir, <span class="hljs-string">"{}"</span>, StandardCharsets.UTF_8);

            <span class="hljs-keyword">return</span> result;

        }

    };

    task.run(toolbox);

    <span class="hljs-comment">// call it 3 times, once to update location in setup, then one for status and location in cleanup</span>

    Mockito.verify(taskActionClient, times(<span class="hljs-number">3</span>)).submit(any());

    verify(pusher, times(<span class="hljs-number">1</span>)).pushTaskReports(eq(<span class="hljs-string">"myID"</span>), any());

    verify(pusher, times(<span class="hljs-number">1</span>)).pushTaskStatus(eq(<span class="hljs-string">"myID"</span>), any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> TaskLogPusher pusher;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    pusher = mock(TaskLogPusher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
pusher

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest422">Test Case ID #druid_Test_42_2</h4>
<h4 id="test-case-name-testwithnoencapsulatedtaskfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommontaskabstracttasktestjava">Test Case Name: <code>testWithNoEncapsulatedTask</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\task\AbstractTaskTest.java</code>)</h4>
<h4 id="mock-object-variable-name-pusher">Mock Object Variable Name: <code>pusher</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     DruidNode node = new DruidNode("foo", "foo", false, 1, 2, true, true);
     when(toolbox.getTaskExecutorNode()).thenReturn(node);
<span class="hljs-deletion">-    TaskLogPusher pusher = mock(TaskLogPusher.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `pusher`</span>
     when(toolbox.getTaskLogPusher()).thenReturn(pusher);
     TaskConfig config = mock(TaskConfig.class);
@@
     Mockito.verify(taskActionClient, never()).submit(any());
<span class="hljs-deletion">-    verify(pusher, never()).pushTaskReports(eq("myID"), any());</span>
<span class="hljs-addition">+    verify(pusher, never()).pushTaskReports(eq("myID"), any());</span>
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testWithNoEncapsulatedTask</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TaskToolbox toolbox = mock(TaskToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getAttemptId()).thenReturn(<span class="hljs-string">"1"</span>);

    DruidNode node = <span class="hljs-keyword">new</span> DruidNode(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>);

    when(toolbox.getTaskExecutorNode()).thenReturn(node);

    TaskLogPusher pusher = mock(TaskLogPusher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskLogPusher()).thenReturn(pusher);

    TaskConfig config = mock(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(config.isEncapsulatedTask()).thenReturn(<span class="hljs-keyword">false</span>);

    File folder = temporaryFolder.newFolder();

    when(config.getTaskDir(eq(<span class="hljs-string">"myID"</span>))).thenReturn(folder);

    when(toolbox.getConfig()).thenReturn(config);

    when(toolbox.getJsonMapper()).thenReturn(objectMapper);

    TaskActionClient taskActionClient = mock(TaskActionClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskActionClient.submit(any())).thenReturn(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);

    AbstractTask task = <span class="hljs-keyword">new</span> NoopTask(<span class="hljs-string">"myID"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>) {



        <span class="hljs-meta">@Nullable</span>

        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">setup</span><span class="hljs-params">(TaskToolbox toolbox)</span> <span class="hljs-keyword">throws</span> Exception </span>{

            <span class="hljs-comment">// create a reports file to test the taskLogPusher pushes task reports</span>

            String result = <span class="hljs-keyword">super</span>.setup(toolbox);

            File attemptDir = Paths.get(folder.getAbsolutePath(), <span class="hljs-string">"attempt"</span>, toolbox.getAttemptId()).toFile();

            File reportsDir = <span class="hljs-keyword">new</span> File(attemptDir, <span class="hljs-string">"report.json"</span>);

            FileUtils.write(reportsDir, <span class="hljs-string">"foo"</span>, StandardCharsets.UTF_8);

            <span class="hljs-keyword">return</span> result;

        }

    };

    task.run(toolbox);

    <span class="hljs-comment">// encapsulated task is set to false, should never get called</span>

    Mockito.verify(taskActionClient, never()).submit(any());

    verify(pusher, never()).pushTaskReports(eq(<span class="hljs-string">"myID"</span>), any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> TaskLogPusher pusher;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    pusher = mock(TaskLogPusher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
pusher

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest423">Test Case ID #druid_Test_42_3</h4>
<h4 id="test-case-name-testtaskfailurewithoutexceptiongetsreportedcorrectlyfile-cjavaprojectsapachedruidindexing-servicesrctestjavaorgapachedruidindexingcommontaskabstracttasktestjava">Test Case Name: <code>testTaskFailureWithoutExceptionGetsReportedCorrectly</code>(File: <code>C:\Java_projects\Apache\druid\indexing-service\src\test\java\org\apache\druid\indexing\common\task\AbstractTaskTest.java</code>)</h4>
<h4 id="mock-object-variable-name-pusher">Mock Object Variable Name: <code>pusher</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     when(toolbox.getTaskExecutorNode()).thenReturn(node);
<span class="hljs-deletion">-    TaskLogPusher pusher = mock(TaskLogPusher.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `pusher`</span>
     when(toolbox.getTaskLogPusher()).thenReturn(pusher);
     TaskConfig config = mock(TaskConfig.class);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testTaskFailureWithoutExceptionGetsReportedCorrectly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    TaskToolbox toolbox = mock(TaskToolbox<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getAttemptId()).thenReturn(<span class="hljs-string">"1"</span>);

    DruidNode node = <span class="hljs-keyword">new</span> DruidNode(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"foo"</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>);

    when(toolbox.getTaskExecutorNode()).thenReturn(node);

    TaskLogPusher pusher = mock(TaskLogPusher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskLogPusher()).thenReturn(pusher);

    TaskConfig config = mock(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(config.isEncapsulatedTask()).thenReturn(<span class="hljs-keyword">true</span>);

    File folder = temporaryFolder.newFolder();

    when(config.getTaskDir(eq(<span class="hljs-string">"myID"</span>))).thenReturn(folder);

    when(toolbox.getConfig()).thenReturn(config);

    when(toolbox.getJsonMapper()).thenReturn(objectMapper);

    TaskActionClient taskActionClient = mock(TaskActionClient<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(taskActionClient.submit(any())).thenReturn(TaskConfig<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(toolbox.getTaskActionClient()).thenReturn(taskActionClient);

    AbstractTask task = <span class="hljs-keyword">new</span> NoopTask(<span class="hljs-string">"myID"</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>) {



        <span class="hljs-meta">@Override</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> TaskStatus <span class="hljs-title">runTask</span><span class="hljs-params">(TaskToolbox toolbox)</span> </span>{

            <span class="hljs-keyword">return</span> TaskStatus.failure(<span class="hljs-string">"myId"</span>, <span class="hljs-string">"failed"</span>);

        }

    };

    task.run(toolbox);

    UpdateStatusAction action = <span class="hljs-keyword">new</span> UpdateStatusAction(<span class="hljs-string">"failure"</span>);

    verify(taskActionClient).submit(eq(action));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> TaskLogPusher pusher;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    pusher = mock(TaskLogPusher<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
pusher

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci43">Mock Clone Instance #druid_MCI_43</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.query.groupby.epinephelinae.column.GroupByColumnSelectorPlus</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 9</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockGroupByColumnSelectorPlus</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> GroupByColumnSelectorPlus <span class="hljs-title">createMockGroupByColumnSelectorPlus</span><span class="hljs-params">()</span> </span>{
    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> groupByColumnSelectorPlus;
  }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest431">Test Case ID #druid_Test_43_1</h4>
<h4 id="test-case-name-testsanityfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaecolumnarraydoublegroupbycolumnselectorstrategytestjava">Test Case Name: <code>testSanity</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\column\ArrayDoubleGroupByColumnSelectorStrategyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-groupbycolumnselectorplus">Mock Object Variable Name: <code>groupByColumnSelectorPlus</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Assert.assertEquals(0, strategy.computeDictionaryId(columnValueSelector));
<span class="hljs-deletion">-    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus.class);</span>
<span class="hljs-deletion">-    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(0);</span>
<span class="hljs-addition">+    GroupByColumnSelectorPlus groupByColumnSelectorPlus = MockGroupByColumnSelectorPlus.createMockGroupByColumnSelectorPlus();</span>
    ResultRow row = ResultRow.create(1);
    buffer1.putInt(0);
    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, 0);
    Assert.assertEquals(new ComparableList&lt;&gt;(ImmutableList.of(1.0, 2.0)), row.get(0));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSanity</span><span class="hljs-params">()</span> </span>{

    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.of(<span class="hljs-number">1.0</span>, <span class="hljs-number">2.0</span>));

    Assert.assertEquals(<span class="hljs-number">0</span>, strategy.computeDictionaryId(columnValueSelector));

    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);

    ResultRow row = ResultRow.create(<span class="hljs-number">1</span>);

    buffer1.putInt(<span class="hljs-number">0</span>);

    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, <span class="hljs-number">0</span>);

    Assert.assertEquals(<span class="hljs-keyword">new</span> ComparableList&lt;&gt;(ImmutableList.of(<span class="hljs-number">1.0</span>, <span class="hljs-number">2.0</span>)), row.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockGroupByColumnSelectorPlus</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> GroupByColumnSelectorPlus <span class="hljs-title">createMockGroupByColumnSelectorPlus</span><span class="hljs-params">()</span> </span>{
    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> groupByColumnSelectorPlus;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest432">Test Case ID #druid_Test_43_2</h4>
<h4 id="test-case-name-testaddingindictionaryfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaecolumnarraydoublegroupbycolumnselectorstrategytestjava">Test Case Name: <code>testAddingInDictionary</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\column\ArrayDoubleGroupByColumnSelectorStrategyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-groupbycolumnselectorplus">Mock Object Variable Name: <code>groupByColumnSelectorPlus</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Assert.assertEquals(3, strategy.computeDictionaryId(columnValueSelector));
<span class="hljs-deletion">-    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus.class);</span>
<span class="hljs-deletion">-    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(0);</span>
<span class="hljs-addition">+    GroupByColumnSelectorPlus groupByColumnSelectorPlus = MockGroupByColumnSelectorPlus.createMockGroupByColumnSelectorPlus();</span>
    ResultRow row = ResultRow.create(1);
    buffer1.putInt(3);
    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, 0);
    Assert.assertEquals(new ComparableList&lt;&gt;(ImmutableList.of(4.0, 2.0)), row.get(0));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAddingInDictionary</span><span class="hljs-params">()</span> </span>{

    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.of(<span class="hljs-number">4.0</span>, <span class="hljs-number">2.0</span>));

    Assert.assertEquals(<span class="hljs-number">3</span>, strategy.computeDictionaryId(columnValueSelector));

    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);

    ResultRow row = ResultRow.create(<span class="hljs-number">1</span>);

    buffer1.putInt(<span class="hljs-number">3</span>);

    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, <span class="hljs-number">0</span>);

    Assert.assertEquals(<span class="hljs-keyword">new</span> ComparableList&lt;&gt;(ImmutableList.of(<span class="hljs-number">4.0</span>, <span class="hljs-number">2.0</span>)), row.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockGroupByColumnSelectorPlus</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> GroupByColumnSelectorPlus <span class="hljs-title">createMockGroupByColumnSelectorPlus</span><span class="hljs-params">()</span> </span>{
    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> groupByColumnSelectorPlus;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest433">Test Case ID #druid_Test_43_3</h4>
<h4 id="test-case-name-testaddingindictionarywithobjectsfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaecolumnarraydoublegroupbycolumnselectorstrategytestjava">Test Case Name: <code>testAddingInDictionaryWithObjects</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\column\ArrayDoubleGroupByColumnSelectorStrategyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-groupbycolumnselectorplus">Mock Object Variable Name: <code>groupByColumnSelectorPlus</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
    Assert.assertEquals(3, strategy.computeDictionaryId(columnValueSelector));
<span class="hljs-deletion">-    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus.class);</span>
<span class="hljs-deletion">-    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(0);</span>
<span class="hljs-addition">+    GroupByColumnSelectorPlus groupByColumnSelectorPlus = MockGroupByColumnSelectorPlus.createMockGroupByColumnSelectorPlus();</span>
    ResultRow row = ResultRow.create(1);
    buffer1.putInt(3);
    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, 0);
    Assert.assertEquals(new ComparableList&lt;&gt;(ImmutableList.of(4.0, 2.0)), row.get(0));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAddingInDictionaryWithObjects</span><span class="hljs-params">()</span> </span>{

    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(columnValueSelector.getObject()).thenReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-number">4.0</span>D, <span class="hljs-number">2.0</span>D });

    Assert.assertEquals(<span class="hljs-number">3</span>, strategy.computeDictionaryId(columnValueSelector));

    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);

    ResultRow row = ResultRow.create(<span class="hljs-number">1</span>);

    buffer1.putInt(<span class="hljs-number">3</span>);

    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, <span class="hljs-number">0</span>);

    Assert.assertEquals(<span class="hljs-keyword">new</span> ComparableList&lt;&gt;(ImmutableList.of(<span class="hljs-number">4.0</span>, <span class="hljs-number">2.0</span>)), row.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockGroupByColumnSelectorPlus</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> GroupByColumnSelectorPlus <span class="hljs-title">createMockGroupByColumnSelectorPlus</span><span class="hljs-params">()</span> </span>{
    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> groupByColumnSelectorPlus;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest434">Test Case ID #druid_Test_43_4</h4>
<h4 id="test-case-name-testsanityfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaecolumnarraylonggroupbycolumnselectorstrategytestjava">Test Case Name: <code>testSanity</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\column\ArrayLongGroupByColumnSelectorStrategyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-groupbycolumnselectorplus">Mock Object Variable Name: <code>groupByColumnSelectorPlus</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Assert.assertEquals(0, strategy.computeDictionaryId(columnValueSelector));
<span class="hljs-deletion">-    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus.class);</span>
<span class="hljs-deletion">-    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(0);</span>
<span class="hljs-addition">+    GroupByColumnSelectorPlus groupByColumnSelectorPlus = MockGroupByColumnSelectorPlus.createMockGroupByColumnSelectorPlus();</span>
    ResultRow row = ResultRow.create(1);
    buffer1.putInt(0);
    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, 0);
    Assert.assertEquals(new ComparableList&lt;&gt;(ImmutableList.of(1L, 2L)), row.get(0));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSanity</span><span class="hljs-params">()</span> </span>{

    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.of(<span class="hljs-number">1L</span>, <span class="hljs-number">2L</span>));

    Assert.assertEquals(<span class="hljs-number">0</span>, strategy.computeDictionaryId(columnValueSelector));

    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);

    ResultRow row = ResultRow.create(<span class="hljs-number">1</span>);

    buffer1.putInt(<span class="hljs-number">0</span>);

    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, <span class="hljs-number">0</span>);

    Assert.assertEquals(<span class="hljs-keyword">new</span> ComparableList&lt;&gt;(ImmutableList.of(<span class="hljs-number">1L</span>, <span class="hljs-number">2L</span>)), row.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockGroupByColumnSelectorPlus</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> GroupByColumnSelectorPlus <span class="hljs-title">createMockGroupByColumnSelectorPlus</span><span class="hljs-params">()</span> </span>{
    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> groupByColumnSelectorPlus;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest435">Test Case ID #druid_Test_43_5</h4>
<h4 id="test-case-name-testaddingindictionaryfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaecolumnarraylonggroupbycolumnselectorstrategytestjava">Test Case Name: <code>testAddingInDictionary</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\column\ArrayLongGroupByColumnSelectorStrategyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-groupbycolumnselectorplus">Mock Object Variable Name: <code>groupByColumnSelectorPlus</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Assert.assertEquals(3, strategy.computeDictionaryId(columnValueSelector));
<span class="hljs-deletion">-    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus.class);</span>
<span class="hljs-deletion">-    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(0);</span>
<span class="hljs-addition">+    GroupByColumnSelectorPlus groupByColumnSelectorPlus = MockGroupByColumnSelectorPlus.createMockGroupByColumnSelectorPlus();</span>
    ResultRow row = ResultRow.create(1);
    buffer1.putInt(3);
    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, 0);
    Assert.assertEquals(new ComparableList&lt;&gt;(ImmutableList.of(4L, 2L)), row.get(0));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAddingInDictionary</span><span class="hljs-params">()</span> </span>{

    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.of(<span class="hljs-number">4L</span>, <span class="hljs-number">2L</span>));

    Assert.assertEquals(<span class="hljs-number">3</span>, strategy.computeDictionaryId(columnValueSelector));

    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);

    ResultRow row = ResultRow.create(<span class="hljs-number">1</span>);

    buffer1.putInt(<span class="hljs-number">3</span>);

    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, <span class="hljs-number">0</span>);

    Assert.assertEquals(<span class="hljs-keyword">new</span> ComparableList&lt;&gt;(ImmutableList.of(<span class="hljs-number">4L</span>, <span class="hljs-number">2L</span>)), row.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockGroupByColumnSelectorPlus</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> GroupByColumnSelectorPlus <span class="hljs-title">createMockGroupByColumnSelectorPlus</span><span class="hljs-params">()</span> </span>{
    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> groupByColumnSelectorPlus;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest436">Test Case ID #druid_Test_43_6</h4>
<h4 id="test-case-name-testaddingindictionarywithobjectsfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaecolumnarraylonggroupbycolumnselectorstrategytestjava">Test Case Name: <code>testAddingInDictionaryWithObjects</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\column\ArrayLongGroupByColumnSelectorStrategyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-groupbycolumnselectorplus">Mock Object Variable Name: <code>groupByColumnSelectorPlus</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Assert.assertEquals(3, strategy.computeDictionaryId(columnValueSelector));
<span class="hljs-deletion">-    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus.class);</span>
<span class="hljs-deletion">-    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(0);</span>
<span class="hljs-addition">+    GroupByColumnSelectorPlus groupByColumnSelectorPlus = MockGroupByColumnSelectorPlus.createMockGroupByColumnSelectorPlus();</span>
    ResultRow row = ResultRow.create(1);
    buffer1.putInt(3);
    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, 0);
    Assert.assertEquals(new ComparableList&lt;&gt;(ImmutableList.of(4L, 2L)), row.get(0));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAddingInDictionaryWithObjects</span><span class="hljs-params">()</span> </span>{

    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(columnValueSelector.getObject()).thenReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-number">4L</span>, <span class="hljs-number">2L</span> });

    Assert.assertEquals(<span class="hljs-number">3</span>, strategy.computeDictionaryId(columnValueSelector));

    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);

    ResultRow row = ResultRow.create(<span class="hljs-number">1</span>);

    buffer1.putInt(<span class="hljs-number">3</span>);

    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, <span class="hljs-number">0</span>);

    Assert.assertEquals(<span class="hljs-keyword">new</span> ComparableList&lt;&gt;(ImmutableList.of(<span class="hljs-number">4L</span>, <span class="hljs-number">2L</span>)), row.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockGroupByColumnSelectorPlus</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> GroupByColumnSelectorPlus <span class="hljs-title">createMockGroupByColumnSelectorPlus</span><span class="hljs-params">()</span> </span>{
    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> groupByColumnSelectorPlus;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest437">Test Case ID #druid_Test_43_7</h4>
<h4 id="test-case-name-testsanityfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaecolumnarraystringgroupbycolumnselectorstrategytestjava">Test Case Name: <code>testSanity</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\column\ArrayStringGroupByColumnSelectorStrategyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-groupbycolumnselectorplus">Mock Object Variable Name: <code>groupByColumnSelectorPlus</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Assert.assertEquals(0, strategy.computeDictionaryId(columnValueSelector));
<span class="hljs-deletion">-    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus.class);</span>
<span class="hljs-deletion">-    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(0);</span>
<span class="hljs-addition">+    GroupByColumnSelectorPlus groupByColumnSelectorPlus = MockGroupByColumnSelectorPlus.createMockGroupByColumnSelectorPlus();</span>
    ResultRow row = ResultRow.create(1);
    buffer1.putInt(0);
    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, 0);
    Assert.assertEquals(ComparableStringArray.of("a", "b"), row.get(0));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSanity</span><span class="hljs-params">()</span> </span>{

    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.of(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>));

    Assert.assertEquals(<span class="hljs-number">0</span>, strategy.computeDictionaryId(columnValueSelector));

    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);

    ResultRow row = ResultRow.create(<span class="hljs-number">1</span>);

    buffer1.putInt(<span class="hljs-number">0</span>);

    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, <span class="hljs-number">0</span>);

    Assert.assertEquals(ComparableStringArray.of(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>), row.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockGroupByColumnSelectorPlus</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> GroupByColumnSelectorPlus <span class="hljs-title">createMockGroupByColumnSelectorPlus</span><span class="hljs-params">()</span> </span>{
    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> groupByColumnSelectorPlus;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest438">Test Case ID #druid_Test_43_8</h4>
<h4 id="test-case-name-testaddingindictionaryfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaecolumnarraystringgroupbycolumnselectorstrategytestjava">Test Case Name: <code>testAddingInDictionary</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\column\ArrayStringGroupByColumnSelectorStrategyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-groupbycolumnselectorplus">Mock Object Variable Name: <code>groupByColumnSelectorPlus</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    Assert.assertEquals(3, strategy.computeDictionaryId(columnValueSelector));
<span class="hljs-deletion">-    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus.class);</span>
<span class="hljs-deletion">-    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(0);</span>
<span class="hljs-addition">+    GroupByColumnSelectorPlus groupByColumnSelectorPlus = MockGroupByColumnSelectorPlus.createMockGroupByColumnSelectorPlus();</span>
    ResultRow row = ResultRow.create(1);
    buffer1.putInt(3);
    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, 0);
    Assert.assertEquals(ComparableStringArray.of("f", "a"), row.get(0));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAddingInDictionary</span><span class="hljs-params">()</span> </span>{

    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(columnValueSelector.getObject()).thenReturn(ImmutableList.of(<span class="hljs-string">"f"</span>, <span class="hljs-string">"a"</span>));

    Assert.assertEquals(<span class="hljs-number">3</span>, strategy.computeDictionaryId(columnValueSelector));

    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);

    ResultRow row = ResultRow.create(<span class="hljs-number">1</span>);

    buffer1.putInt(<span class="hljs-number">3</span>);

    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, <span class="hljs-number">0</span>);

    Assert.assertEquals(ComparableStringArray.of(<span class="hljs-string">"f"</span>, <span class="hljs-string">"a"</span>), row.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockGroupByColumnSelectorPlus</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> GroupByColumnSelectorPlus <span class="hljs-title">createMockGroupByColumnSelectorPlus</span><span class="hljs-params">()</span> </span>{
    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> groupByColumnSelectorPlus;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest439">Test Case ID #druid_Test_43_9</h4>
<h4 id="test-case-name-testaddingindictionarywithobjectsfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidquerygroupbyepinephelinaecolumnarraystringgroupbycolumnselectorstrategytestjava">Test Case Name: <code>testAddingInDictionaryWithObjects</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\groupby\epinephelinae\column\ArrayStringGroupByColumnSelectorStrategyTest.java</code>)</h4>
<h4 id="mock-object-variable-name-groupbycolumnselectorplus">Mock Object Variable Name: <code>groupByColumnSelectorPlus</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     Assert.assertEquals(3, strategy.computeDictionaryId(columnValueSelector));
<span class="hljs-deletion">-    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus.class);</span>
<span class="hljs-deletion">-    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(0);</span>
<span class="hljs-addition">+    GroupByColumnSelectorPlus groupByColumnSelectorPlus = MockGroupByColumnSelectorPlus.createMockGroupByColumnSelectorPlus();</span>
     ResultRow row = ResultRow.create(1);
     buffer1.putInt(3);
     strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, 0);
     Assert.assertEquals(ComparableStringArray.of("f", "a"), row.get(0));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testAddingInDictionaryWithObjects</span><span class="hljs-params">()</span> </span>{

    ColumnValueSelector columnValueSelector = Mockito.mock(ColumnValueSelector<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(columnValueSelector.getObject()).thenReturn(<span class="hljs-keyword">new</span> Object[] { <span class="hljs-string">"f"</span>, <span class="hljs-string">"a"</span> });

    Assert.assertEquals(<span class="hljs-number">3</span>, strategy.computeDictionaryId(columnValueSelector));

    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);

    ResultRow row = ResultRow.create(<span class="hljs-number">1</span>);

    buffer1.putInt(<span class="hljs-number">3</span>);

    strategy.processValueFromGroupingKey(groupByColumnSelectorPlus, buffer1, row, <span class="hljs-number">0</span>);

    Assert.assertEquals(ComparableStringArray.of(<span class="hljs-string">"f"</span>, <span class="hljs-string">"a"</span>), row.get(<span class="hljs-number">0</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockGroupByColumnSelectorPlus</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> GroupByColumnSelectorPlus <span class="hljs-title">createMockGroupByColumnSelectorPlus</span><span class="hljs-params">()</span> </span>{
    GroupByColumnSelectorPlus groupByColumnSelectorPlus = Mockito.mock(GroupByColumnSelectorPlus<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(groupByColumnSelectorPlus.getResultRowPosition()).thenReturn(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> groupByColumnSelectorPlus;
  }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci44">Mock Clone Instance #druid_MCI_44</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>oshi.hardware.HWDiskStore</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HWDiskStore <span class="hljs-title">createMockHWDiskStore</span><span class="hljs-params">(<span class="hljs-keyword">long</span> readBytes, <span class="hljs-keyword">long</span> reads, <span class="hljs-keyword">long</span> writeBytes, <span class="hljs-keyword">long</span> writes, <span class="hljs-keyword">long</span> currentQueueLength, <span class="hljs-keyword">long</span> transferTime, String name)</span> </span>{
    HWDiskStore disk = Mockito.mock(HWDiskStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(disk.getReadBytes()).thenReturn(readBytes);
    Mockito.when(disk.getReads()).thenReturn(reads);
    Mockito.when(disk.getWriteBytes()).thenReturn(writeBytes);
    Mockito.when(disk.getWrites()).thenReturn(writes);
    Mockito.when(disk.getCurrentQueueLength()).thenReturn(currentQueueLength);
    Mockito.when(disk.getTransferTime()).thenReturn(transferTime);
    Mockito.when(disk.getName()).thenReturn(name);
    <span class="hljs-keyword">return</span> disk;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest441">Test Case ID #druid_Test_44_1</h4>
<h4 id="test-case-name-testdiskstatsfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidjavautilmetricsoshisysmonitortestjava">Test Case Name: <code>testDiskStats</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\java\util\metrics\OshiSysMonitorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-disk1">Mock Object Variable Name: <code>disk1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    StubServiceEmitter emitter = new StubServiceEmitter("dev/monitor-test", "localhost:0000");
<span class="hljs-deletion">-    HWDiskStore disk1 = Mockito.mock(HWDiskStore.class);</span>
<span class="hljs-addition">+    HWDiskStore disk1 = createMockHWDiskStore(300L, 200L, 400L, 500L, 100L, 150L, "disk1");</span>
    HWDiskStore disk2 = Mockito.mock(HWDiskStore.class);
<span class="hljs-deletion">-    Mockito.when(disk1.getReadBytes()).thenReturn(300L);</span>
<span class="hljs-deletion">-    Mockito.when(disk1.getReads()).thenReturn(200L);</span>
<span class="hljs-deletion">-    Mockito.when(disk1.getWriteBytes()).thenReturn(400L);</span>
<span class="hljs-deletion">-    Mockito.when(disk1.getWrites()).thenReturn(500L);</span>
<span class="hljs-deletion">-    Mockito.when(disk1.getCurrentQueueLength()).thenReturn(100L);</span>
<span class="hljs-deletion">-    Mockito.when(disk1.getTransferTime()).thenReturn(150L);</span>
<span class="hljs-deletion">-    Mockito.when(disk1.getName()).thenReturn("disk1");</span>
    Mockito.when(disk2.getReadBytes()).thenReturn(2000L);
    Mockito.when(disk2.getReads()).thenReturn(3000L);
    Mockito.when(disk2.getWriteBytes()).thenReturn(1000L);
    Mockito.when(disk2.getWrites()).thenReturn(4000L);
    Mockito.when(disk2.getCurrentQueueLength()).thenReturn(750L);
    Mockito.when(disk2.getTransferTime()).thenReturn(800L);
    Mockito.when(disk2.getName()).thenReturn("disk2");
    List&lt;HWDiskStore&gt; hwDiskStores = ImmutableList.of(disk1, disk2);
    Mockito.when(hal.getDiskStores()).thenReturn(hwDiskStores);
    OshiSysMonitor m = new OshiSysMonitor(si);
    m.start();
    m.monitorDiskStats(emitter);
    Assert.assertEquals(0, emitter.getEvents().size());
<span class="hljs-addition">+    Mockito.when(disk1.getReadBytes()).thenReturn(400L);</span>
<span class="hljs-addition">+    Mockito.when(disk1.getReads()).thenReturn(220L);</span>
<span class="hljs-addition">+    Mockito.when(disk1.getWriteBytes()).thenReturn(600L);</span>
<span class="hljs-addition">+    Mockito.when(disk1.getWrites()).thenReturn(580L);</span>
<span class="hljs-addition">+    Mockito.when(disk1.getCurrentQueueLength()).thenReturn(300L);</span>
<span class="hljs-addition">+    Mockito.when(disk1.getTransferTime()).thenReturn(250L);</span>
    Mockito.when(disk2.getReadBytes()).thenReturn(4500L);
    Mockito.when(disk2.getReads()).thenReturn(3500L);
    Mockito.when(disk2.getWriteBytes()).thenReturn(2300L);
    Mockito.when(disk2.getWrites()).thenReturn(5000L);
    Mockito.when(disk2.getCurrentQueueLength()).thenReturn(900L);
    Mockito.when(disk2.getTransferTime()).thenReturn(1100L);
    m.monitorDiskStats(emitter);
    Assert.assertEquals(12, emitter.getEvents().size());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDiskStats</span><span class="hljs-params">()</span> </span>{

    StubServiceEmitter emitter = <span class="hljs-keyword">new</span> StubServiceEmitter(<span class="hljs-string">"dev/monitor-test"</span>, <span class="hljs-string">"localhost:0000"</span>);

    HWDiskStore disk1 = Mockito.mock(HWDiskStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HWDiskStore disk2 = Mockito.mock(HWDiskStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(disk1.getReadBytes()).thenReturn(<span class="hljs-number">300L</span>);

    Mockito.when(disk1.getReads()).thenReturn(<span class="hljs-number">200L</span>);

    Mockito.when(disk1.getWriteBytes()).thenReturn(<span class="hljs-number">400L</span>);

    Mockito.when(disk1.getWrites()).thenReturn(<span class="hljs-number">500L</span>);

    Mockito.when(disk1.getCurrentQueueLength()).thenReturn(<span class="hljs-number">100L</span>);

    Mockito.when(disk1.getTransferTime()).thenReturn(<span class="hljs-number">150L</span>);

    Mockito.when(disk1.getName()).thenReturn(<span class="hljs-string">"disk1"</span>);

    Mockito.when(disk2.getReadBytes()).thenReturn(<span class="hljs-number">2000L</span>);

    Mockito.when(disk2.getReads()).thenReturn(<span class="hljs-number">3000L</span>);

    Mockito.when(disk2.getWriteBytes()).thenReturn(<span class="hljs-number">1000L</span>);

    Mockito.when(disk2.getWrites()).thenReturn(<span class="hljs-number">4000L</span>);

    Mockito.when(disk2.getCurrentQueueLength()).thenReturn(<span class="hljs-number">750L</span>);

    Mockito.when(disk2.getTransferTime()).thenReturn(<span class="hljs-number">800L</span>);

    Mockito.when(disk2.getName()).thenReturn(<span class="hljs-string">"disk2"</span>);

    List&lt;HWDiskStore&gt; hwDiskStores = ImmutableList.of(disk1, disk2);

    Mockito.when(hal.getDiskStores()).thenReturn(hwDiskStores);

    OshiSysMonitor m = <span class="hljs-keyword">new</span> OshiSysMonitor(si);

    m.start();

    m.monitorDiskStats(emitter);

    Assert.assertEquals(<span class="hljs-number">0</span>, emitter.getEvents().size());

    Mockito.when(disk1.getReadBytes()).thenReturn(<span class="hljs-number">400L</span>);

    Mockito.when(disk1.getReads()).thenReturn(<span class="hljs-number">220L</span>);

    Mockito.when(disk1.getWriteBytes()).thenReturn(<span class="hljs-number">600L</span>);

    Mockito.when(disk1.getWrites()).thenReturn(<span class="hljs-number">580L</span>);

    Mockito.when(disk1.getCurrentQueueLength()).thenReturn(<span class="hljs-number">300L</span>);

    Mockito.when(disk1.getTransferTime()).thenReturn(<span class="hljs-number">250L</span>);

    Mockito.when(disk2.getReadBytes()).thenReturn(<span class="hljs-number">4500L</span>);

    Mockito.when(disk2.getReads()).thenReturn(<span class="hljs-number">3500L</span>);

    Mockito.when(disk2.getWriteBytes()).thenReturn(<span class="hljs-number">2300L</span>);

    Mockito.when(disk2.getWrites()).thenReturn(<span class="hljs-number">5000L</span>);

    Mockito.when(disk2.getCurrentQueueLength()).thenReturn(<span class="hljs-number">900L</span>);

    Mockito.when(disk2.getTransferTime()).thenReturn(<span class="hljs-number">1100L</span>);

    m.monitorDiskStats(emitter);

    Assert.assertEquals(<span class="hljs-number">12</span>, emitter.getEvents().size());

    Map&lt;String, Object&gt; userDims1 = ImmutableMap.of(<span class="hljs-string">"diskName"</span>, <span class="hljs-string">"disk1"</span>);

    List&lt;Number&gt; metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/read/size"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">100L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/read/count"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">20L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/write/size"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">200L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/write/count"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">80L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/queue"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">200L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/transferTime"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">100L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    Map&lt;String, Object&gt; userDims2 = ImmutableMap.of(<span class="hljs-string">"diskName"</span>, <span class="hljs-string">"disk2"</span>);

    List&lt;Number&gt; metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/read/size"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">2500L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/read/count"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">500L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/write/size"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">1300L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/write/count"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">1000L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/queue"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">150L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/transferTime"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">300L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    m.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HWDiskStore <span class="hljs-title">createMockHWDiskStore</span><span class="hljs-params">(<span class="hljs-keyword">long</span> readBytes, <span class="hljs-keyword">long</span> reads, <span class="hljs-keyword">long</span> writeBytes, <span class="hljs-keyword">long</span> writes, <span class="hljs-keyword">long</span> currentQueueLength, <span class="hljs-keyword">long</span> transferTime, String name)</span> </span>{
    HWDiskStore disk = Mockito.mock(HWDiskStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(disk.getReadBytes()).thenReturn(readBytes);
    Mockito.when(disk.getReads()).thenReturn(reads);
    Mockito.when(disk.getWriteBytes()).thenReturn(writeBytes);
    Mockito.when(disk.getWrites()).thenReturn(writes);
    Mockito.when(disk.getCurrentQueueLength()).thenReturn(currentQueueLength);
    Mockito.when(disk.getTransferTime()).thenReturn(transferTime);
    Mockito.when(disk.getName()).thenReturn(name);
    <span class="hljs-keyword">return</span> disk;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest442">Test Case ID #druid_Test_44_2</h4>
<h4 id="test-case-name-testdiskstatsfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidjavautilmetricsoshisysmonitortestjava">Test Case Name: <code>testDiskStats</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\java\util\metrics\OshiSysMonitorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-disk2">Mock Object Variable Name: <code>disk2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    StubServiceEmitter emitter = new StubServiceEmitter("dev/monitor-test", "localhost:0000");
    HWDiskStore disk1 = Mockito.mock(HWDiskStore.class);
<span class="hljs-deletion">-    HWDiskStore disk2 = Mockito.mock(HWDiskStore.class);</span>
<span class="hljs-deletion">-    Mockito.when(disk1.getReadBytes()).thenReturn(300L);</span>
<span class="hljs-deletion">-    Mockito.when(disk1.getReads()).thenReturn(200L);</span>
<span class="hljs-deletion">-    Mockito.when(disk1.getWriteBytes()).thenReturn(400L);</span>
<span class="hljs-deletion">-    Mockito.when(disk1.getWrites()).thenReturn(500L);</span>
<span class="hljs-deletion">-    Mockito.when(disk1.getCurrentQueueLength()).thenReturn(100L);</span>
<span class="hljs-deletion">-    Mockito.when(disk1.getTransferTime()).thenReturn(150L);</span>
<span class="hljs-deletion">-    Mockito.when(disk1.getName()).thenReturn("disk1");</span>
<span class="hljs-deletion">-    Mockito.when(disk2.getReadBytes()).thenReturn(2000L);</span>
<span class="hljs-deletion">-    Mockito.when(disk2.getReads()).thenReturn(3000L);</span>
<span class="hljs-deletion">-    Mockito.when(disk2.getWriteBytes()).thenReturn(1000L);</span>
<span class="hljs-deletion">-    Mockito.when(disk2.getWrites()).thenReturn(4000L);</span>
<span class="hljs-deletion">-    Mockito.when(disk2.getCurrentQueueLength()).thenReturn(750L);</span>
<span class="hljs-deletion">-    Mockito.when(disk2.getTransferTime()).thenReturn(800L);</span>
<span class="hljs-deletion">-    Mockito.when(disk2.getName()).thenReturn("disk2");</span>
<span class="hljs-addition">+    HWDiskStore disk2 = createMockHWDiskStore(2000L, 3000L, 1000L, 4000L, 750L, 800L, "disk2");</span>
    List&lt;HWDiskStore&gt; hwDiskStores = ImmutableList.of(disk1, disk2);
    Mockito.when(hal.getDiskStores()).thenReturn(hwDiskStores);
    OshiSysMonitor m = new OshiSysMonitor(si);
    m.start();
    m.monitorDiskStats(emitter);
    Assert.assertEquals(0, emitter.getEvents().size());
    Mockito.when(disk1.getReadBytes()).thenReturn(400L);
    Mockito.when(disk1.getReads()).thenReturn(220L);
    Mockito.when(disk1.getWriteBytes()).thenReturn(600L);
    Mockito.when(disk1.getWrites()).thenReturn(580L);
    Mockito.when(disk1.getCurrentQueueLength()).thenReturn(300L);
    Mockito.when(disk1.getTransferTime()).thenReturn(250L);
<span class="hljs-deletion">-    Mockito.when(disk2.getReadBytes()).thenReturn(4500L);</span>
<span class="hljs-deletion">-    Mockito.when(disk2.getReads()).thenReturn(3500L);</span>
<span class="hljs-deletion">-    Mockito.when(disk2.getWriteBytes()).thenReturn(2300L);</span>
<span class="hljs-deletion">-    Mockito.when(disk2.getWrites()).thenReturn(5000L);</span>
<span class="hljs-deletion">-    Mockito.when(disk2.getCurrentQueueLength()).thenReturn(900L);</span>
<span class="hljs-deletion">-    Mockito.when(disk2.getTransferTime()).thenReturn(1100L);</span>
<span class="hljs-addition">+    Mockito.when(disk2.getReadBytes()).thenReturn(4500L);</span>
<span class="hljs-addition">+    Mockito.when(disk2.getReads()).thenReturn(3500L);</span>
<span class="hljs-addition">+    Mockito.when(disk2.getWriteBytes()).thenReturn(2300L);</span>
<span class="hljs-addition">+    Mockito.when(disk2.getWrites()).thenReturn(5000L);</span>
<span class="hljs-addition">+    Mockito.when(disk2.getCurrentQueueLength()).thenReturn(900L);</span>
<span class="hljs-addition">+    Mockito.when(disk2.getTransferTime()).thenReturn(1100L);</span>
    m.monitorDiskStats(emitter);
    Assert.assertEquals(12, emitter.getEvents().size());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDiskStats</span><span class="hljs-params">()</span> </span>{

    StubServiceEmitter emitter = <span class="hljs-keyword">new</span> StubServiceEmitter(<span class="hljs-string">"dev/monitor-test"</span>, <span class="hljs-string">"localhost:0000"</span>);

    HWDiskStore disk1 = Mockito.mock(HWDiskStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HWDiskStore disk2 = Mockito.mock(HWDiskStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(disk1.getReadBytes()).thenReturn(<span class="hljs-number">300L</span>);

    Mockito.when(disk1.getReads()).thenReturn(<span class="hljs-number">200L</span>);

    Mockito.when(disk1.getWriteBytes()).thenReturn(<span class="hljs-number">400L</span>);

    Mockito.when(disk1.getWrites()).thenReturn(<span class="hljs-number">500L</span>);

    Mockito.when(disk1.getCurrentQueueLength()).thenReturn(<span class="hljs-number">100L</span>);

    Mockito.when(disk1.getTransferTime()).thenReturn(<span class="hljs-number">150L</span>);

    Mockito.when(disk1.getName()).thenReturn(<span class="hljs-string">"disk1"</span>);

    Mockito.when(disk2.getReadBytes()).thenReturn(<span class="hljs-number">2000L</span>);

    Mockito.when(disk2.getReads()).thenReturn(<span class="hljs-number">3000L</span>);

    Mockito.when(disk2.getWriteBytes()).thenReturn(<span class="hljs-number">1000L</span>);

    Mockito.when(disk2.getWrites()).thenReturn(<span class="hljs-number">4000L</span>);

    Mockito.when(disk2.getCurrentQueueLength()).thenReturn(<span class="hljs-number">750L</span>);

    Mockito.when(disk2.getTransferTime()).thenReturn(<span class="hljs-number">800L</span>);

    Mockito.when(disk2.getName()).thenReturn(<span class="hljs-string">"disk2"</span>);

    List&lt;HWDiskStore&gt; hwDiskStores = ImmutableList.of(disk1, disk2);

    Mockito.when(hal.getDiskStores()).thenReturn(hwDiskStores);

    OshiSysMonitor m = <span class="hljs-keyword">new</span> OshiSysMonitor(si);

    m.start();

    m.monitorDiskStats(emitter);

    Assert.assertEquals(<span class="hljs-number">0</span>, emitter.getEvents().size());

    Mockito.when(disk1.getReadBytes()).thenReturn(<span class="hljs-number">400L</span>);

    Mockito.when(disk1.getReads()).thenReturn(<span class="hljs-number">220L</span>);

    Mockito.when(disk1.getWriteBytes()).thenReturn(<span class="hljs-number">600L</span>);

    Mockito.when(disk1.getWrites()).thenReturn(<span class="hljs-number">580L</span>);

    Mockito.when(disk1.getCurrentQueueLength()).thenReturn(<span class="hljs-number">300L</span>);

    Mockito.when(disk1.getTransferTime()).thenReturn(<span class="hljs-number">250L</span>);

    Mockito.when(disk2.getReadBytes()).thenReturn(<span class="hljs-number">4500L</span>);

    Mockito.when(disk2.getReads()).thenReturn(<span class="hljs-number">3500L</span>);

    Mockito.when(disk2.getWriteBytes()).thenReturn(<span class="hljs-number">2300L</span>);

    Mockito.when(disk2.getWrites()).thenReturn(<span class="hljs-number">5000L</span>);

    Mockito.when(disk2.getCurrentQueueLength()).thenReturn(<span class="hljs-number">900L</span>);

    Mockito.when(disk2.getTransferTime()).thenReturn(<span class="hljs-number">1100L</span>);

    m.monitorDiskStats(emitter);

    Assert.assertEquals(<span class="hljs-number">12</span>, emitter.getEvents().size());

    Map&lt;String, Object&gt; userDims1 = ImmutableMap.of(<span class="hljs-string">"diskName"</span>, <span class="hljs-string">"disk1"</span>);

    List&lt;Number&gt; metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/read/size"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">100L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/read/count"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">20L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/write/size"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">200L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/write/count"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">80L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/queue"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">200L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    metricValues1 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/transferTime"</span>, userDims1);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues1.size());

    Assert.assertEquals(<span class="hljs-number">100L</span>, metricValues1.get(<span class="hljs-number">0</span>));

    Map&lt;String, Object&gt; userDims2 = ImmutableMap.of(<span class="hljs-string">"diskName"</span>, <span class="hljs-string">"disk2"</span>);

    List&lt;Number&gt; metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/read/size"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">2500L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/read/count"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">500L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/write/size"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">1300L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/write/count"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">1000L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/queue"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">150L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    metricValues2 = emitter.getMetricValues(<span class="hljs-string">"sys/disk/transferTime"</span>, userDims2);

    Assert.assertEquals(<span class="hljs-number">1</span>, metricValues2.size());

    Assert.assertEquals(<span class="hljs-number">300L</span>, metricValues2.get(<span class="hljs-number">0</span>));

    m.stop();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HWDiskStore <span class="hljs-title">createMockHWDiskStore</span><span class="hljs-params">(<span class="hljs-keyword">long</span> readBytes, <span class="hljs-keyword">long</span> reads, <span class="hljs-keyword">long</span> writeBytes, <span class="hljs-keyword">long</span> writes, <span class="hljs-keyword">long</span> currentQueueLength, <span class="hljs-keyword">long</span> transferTime, String name)</span> </span>{
    HWDiskStore disk = Mockito.mock(HWDiskStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(disk.getReadBytes()).thenReturn(readBytes);
    Mockito.when(disk.getReads()).thenReturn(reads);
    Mockito.when(disk.getWriteBytes()).thenReturn(writeBytes);
    Mockito.when(disk.getWrites()).thenReturn(writes);
    Mockito.when(disk.getCurrentQueueLength()).thenReturn(currentQueueLength);
    Mockito.when(disk.getTransferTime()).thenReturn(transferTime);
    Mockito.when(disk.getName()).thenReturn(name);
    <span class="hljs-keyword">return</span> disk;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci45">Mock Clone Instance #druid_MCI_45</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.java.util.emitter.service.ServiceEmitter</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ServiceEmitter emitter;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    emitter = Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
emitter;

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest451">Test Case ID #druid_Test_45_1</h4>
<h4 id="test-case-name-testgetsysmonitorviainjectorfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservermetricsmetricsmoduletestjava">Test Case Name: <code>testGetSysMonitorViaInjector</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\metrics\MetricsModuleTest.java</code>)</h4>
<h4 id="mock-object-variable-name-emitter">Mock Object Variable Name: <code>emitter</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testGetSysMonitorViaInjector() {
     // Do not run the tests on ARM64. Sigar library has no binaries for ARM64
     Assume.assumeFalse("aarch64".equals(CPU_ARCH));
     final Injector injector = createInjector(new Properties(), ImmutableSet.of(NodeRole.PEON));
     final SysMonitor sysMonitor = injector.getInstance(SysMonitor.class);
<span class="hljs-deletion">-    final ServiceEmitter emitter = Mockito.mock(ServiceEmitter.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `emitter`</span>
     sysMonitor.doMonitor(emitter);
     Assert.assertTrue(sysMonitor instanceof NoopSysMonitor);
     Mockito.verify(emitter, Mockito.never()).emit(ArgumentMatchers.any(ServiceEventBuilder.class));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetSysMonitorViaInjector</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// Do not run the tests on ARM64. Sigar library has no binaries for ARM64</span>

    Assume.assumeFalse(<span class="hljs-string">"aarch64"</span>.equals(CPU_ARCH));

    <span class="hljs-keyword">final</span> Injector injector = createInjector(<span class="hljs-keyword">new</span> Properties(), ImmutableSet.of(NodeRole.PEON));

    <span class="hljs-keyword">final</span> SysMonitor sysMonitor = injector.getInstance(SysMonitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ServiceEmitter emitter = Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    sysMonitor.doMonitor(emitter);

    Assert.assertTrue(sysMonitor <span class="hljs-keyword">instanceof</span> NoopSysMonitor);

    Mockito.verify(emitter, Mockito.never()).emit(ArgumentMatchers.any(ServiceEventBuilder<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ServiceEmitter emitter;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    emitter = Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
emitter;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest452">Test Case ID #druid_Test_45_2</h4>
<h4 id="test-case-name-testgetsysmonitorwhennullfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservermetricsmetricsmoduletestjava">Test Case Name: <code>testGetSysMonitorWhenNull</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\metrics\MetricsModuleTest.java</code>)</h4>
<h4 id="mock-object-variable-name-emitter">Mock Object Variable Name: <code>emitter</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testGetSysMonitorWhenNull() {
     // Do not run the tests on ARM64. Sigar library has no binaries for ARM64
     Assume.assumeFalse("aarch64".equals(CPU_ARCH));
     Injector injector = createInjector(new Properties(), ImmutableSet.of());
     final SysMonitor sysMonitor = injector.getInstance(SysMonitor.class);
<span class="hljs-deletion">-    final ServiceEmitter emitter = Mockito.mock(ServiceEmitter.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `emitter`</span>
     sysMonitor.doMonitor(emitter);
     Assert.assertFalse(sysMonitor instanceof NoopSysMonitor);
     Mockito.verify(emitter, Mockito.atLeastOnce()).emit(ArgumentMatchers.any(ServiceEventBuilder.class));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetSysMonitorWhenNull</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// Do not run the tests on ARM64. Sigar library has no binaries for ARM64</span>

    Assume.assumeFalse(<span class="hljs-string">"aarch64"</span>.equals(CPU_ARCH));

    Injector injector = createInjector(<span class="hljs-keyword">new</span> Properties(), ImmutableSet.of());

    <span class="hljs-keyword">final</span> SysMonitor sysMonitor = injector.getInstance(SysMonitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ServiceEmitter emitter = Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    sysMonitor.doMonitor(emitter);

    Assert.assertFalse(sysMonitor <span class="hljs-keyword">instanceof</span> NoopSysMonitor);

    Mockito.verify(emitter, Mockito.atLeastOnce()).emit(ArgumentMatchers.any(ServiceEventBuilder<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ServiceEmitter emitter;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    emitter = Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
emitter;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest453">Test Case ID #druid_Test_45_3</h4>
<h4 id="test-case-name-testgetoshisysmonitorviainjectorfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservermetricsmetricsmoduletestjava">Test Case Name: <code>testGetOshiSysMonitorViaInjector</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\metrics\MetricsModuleTest.java</code>)</h4>
<h4 id="mock-object-variable-name-emitter">Mock Object Variable Name: <code>emitter</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testGetOshiSysMonitorViaInjector() {
     final Injector injector = createInjector(new Properties(), ImmutableSet.of(NodeRole.PEON));
     final OshiSysMonitor sysMonitor = injector.getInstance(OshiSysMonitor.class);
<span class="hljs-deletion">-    final ServiceEmitter emitter = Mockito.mock(ServiceEmitter.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `emitter`</span>
     sysMonitor.doMonitor(emitter);
     Assert.assertTrue(sysMonitor instanceof NoopOshiSysMonitor);
     Mockito.verify(emitter, Mockito.never()).emit(ArgumentMatchers.any(ServiceEventBuilder.class));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetOshiSysMonitorViaInjector</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> Injector injector = createInjector(<span class="hljs-keyword">new</span> Properties(), ImmutableSet.of(NodeRole.PEON));

    <span class="hljs-keyword">final</span> OshiSysMonitor sysMonitor = injector.getInstance(OshiSysMonitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ServiceEmitter emitter = Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    sysMonitor.doMonitor(emitter);

    Assert.assertTrue(sysMonitor <span class="hljs-keyword">instanceof</span> NoopOshiSysMonitor);

    Mockito.verify(emitter, Mockito.never()).emit(ArgumentMatchers.any(ServiceEventBuilder<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ServiceEmitter emitter;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    emitter = Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
emitter;

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest454">Test Case ID #druid_Test_45_4</h4>
<h4 id="test-case-name-testgetoshisysmonitorwhennullfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidservermetricsmetricsmoduletestjava">Test Case Name: <code>testGetOshiSysMonitorWhenNull</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\server\metrics\MetricsModuleTest.java</code>)</h4>
<h4 id="mock-object-variable-name-emitter">Mock Object Variable Name: <code>emitter</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void testGetOshiSysMonitorWhenNull() {
     Injector injector = createInjector(new Properties(), ImmutableSet.of());
     final OshiSysMonitor sysMonitor = injector.getInstance(OshiSysMonitor.class);
<span class="hljs-deletion">-    final ServiceEmitter emitter = Mockito.mock(ServiceEmitter.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `emitter`</span>
     sysMonitor.doMonitor(emitter);
     Assert.assertFalse(sysMonitor instanceof NoopOshiSysMonitor);
     Mockito.verify(emitter, Mockito.atLeastOnce()).emit(ArgumentMatchers.any(ServiceEventBuilder.class));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetOshiSysMonitorWhenNull</span><span class="hljs-params">()</span> </span>{

    Injector injector = createInjector(<span class="hljs-keyword">new</span> Properties(), ImmutableSet.of());

    <span class="hljs-keyword">final</span> OshiSysMonitor sysMonitor = injector.getInstance(OshiSysMonitor<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ServiceEmitter emitter = Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    sysMonitor.doMonitor(emitter);

    Assert.assertFalse(sysMonitor <span class="hljs-keyword">instanceof</span> NoopOshiSysMonitor);

    Mockito.verify(emitter, Mockito.atLeastOnce()).emit(ArgumentMatchers.any(ServiceEventBuilder<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">// === Declare in class scope ===</span>
<span class="hljs-keyword">private</span> ServiceEmitter emitter;

<span class="hljs-comment">// === Add to @BeforeEach method ===</span>
<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    emitter = Mockito.mock(ServiceEmitter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// === Replace local variable in test with ===</span>
emitter;

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci46">Mock Clone Instance #druid_MCI_46</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.data.input.HandlingInputRowIterator.InputRowHandler</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 6</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HandlingInputRowIterator.<span class="hljs-function">InputRowHandler <span class="hljs-title">createMockInputRowHandler</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> handleReturnValue)</span> </span>{
    HandlingInputRowIterator.InputRowHandler handler = mock(HandlingInputRowIterator.InputRowHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(handler.handle(any(InputRow<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">handleReturnValue</span>)</span>;
    <span class="hljs-keyword">return</span> handler;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest461">Test Case ID #druid_Test_46_1</h4>
<h4 id="test-case-name-yieldsnullifhandledbyfirstfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruiddatainputhandlinginputrowiteratortestjava">Test Case Name: <code>yieldsNullIfHandledByFirst</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\data\input\HandlingInputRowIteratorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-successfulhandler">Mock Object Variable Name: <code>successfulHandler</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Before
<span class="hljs-deletion">-public void setup() {</span>
<span class="hljs-deletion">-    // Construct mock object</span>
<span class="hljs-deletion">-    successfulHandler = mock(HandlingInputRowIterator.InputRowHandler.class);</span>
<span class="hljs-deletion">-    // Method Stubs</span>
<span class="hljs-deletion">-    when(successfulHandler.handle(any(InputRow.class))).thenReturn(true);</span>
<span class="hljs-deletion">-    // Construct mock object</span>
<span class="hljs-deletion">-    unsuccessfulHandler = mock(HandlingInputRowIterator.InputRowHandler.class);</span>
<span class="hljs-deletion">-    // Method Stubs</span>
<span class="hljs-deletion">-    when(unsuccessfulHandler.handle(any(InputRow.class))).thenReturn(false);</span>
<span class="hljs-deletion">-}</span>
<span class="hljs-addition">+public void setup() {</span>
<span class="hljs-addition">+    successfulHandler = createMockInputRowHandler(true);</span>
<span class="hljs-addition">+    unsuccessfulHandler = mock(HandlingInputRowIterator.InputRowHandler.class);</span>
<span class="hljs-addition">+    when(unsuccessfulHandler.handle(any(InputRow.class))).thenReturn(false);</span>
<span class="hljs-addition">+}</span>
 
 @Test
 public void yieldsNullIfHandledByFirst() {
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">yieldsNullIfHandledByFirst</span><span class="hljs-params">()</span> </span>{

    HandlingInputRowIterator target = createInputRowIterator(successfulHandler, unsuccessfulHandler);

    Assert.assertNull(target.next());

    Mockito.verify(successfulHandler, Mockito.times(<span class="hljs-number">1</span>)).handle(INPUT_ROW1);

    Mockito.verify(unsuccessfulHandler, Mockito.never()).handle(INPUT_ROW1);

}
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// Construct mock object</span>

    successfulHandler = mock(HandlingInputRowIterator.InputRowHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// Method Stubs</span>

    when(successfulHandler.handle(any(InputRow<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    <span class="hljs-comment">// Construct mock object</span>

    unsuccessfulHandler = mock(HandlingInputRowIterator.InputRowHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// Method Stubs</span>

    when(unsuccessfulHandler.handle(any(InputRow<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">false</span>)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HandlingInputRowIterator.<span class="hljs-function">InputRowHandler <span class="hljs-title">createMockInputRowHandler</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> handleReturnValue)</span> </span>{
    HandlingInputRowIterator.InputRowHandler handler = mock(HandlingInputRowIterator.InputRowHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(handler.handle(any(InputRow<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">handleReturnValue</span>)</span>;
    <span class="hljs-keyword">return</span> handler;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest462">Test Case ID #druid_Test_46_2</h4>
<h4 id="test-case-name-yieldsnullifhandledbysecondfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruiddatainputhandlinginputrowiteratortestjava">Test Case Name: <code>yieldsNullIfHandledBySecond</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\data\input\HandlingInputRowIteratorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-successfulhandler">Mock Object Variable Name: <code>successfulHandler</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Before
<span class="hljs-deletion">-public void setup() {</span>
<span class="hljs-deletion">-    // Construct mock object</span>
<span class="hljs-deletion">-    successfulHandler = mock(HandlingInputRowIterator.InputRowHandler.class);</span>
<span class="hljs-deletion">-    // Method Stubs</span>
<span class="hljs-deletion">-    when(successfulHandler.handle(any(InputRow.class))).thenReturn(true);</span>
<span class="hljs-deletion">-    // Construct mock object</span>
<span class="hljs-deletion">-    unsuccessfulHandler = mock(HandlingInputRowIterator.InputRowHandler.class);</span>
<span class="hljs-deletion">-    // Method Stubs</span>
<span class="hljs-deletion">-    when(unsuccessfulHandler.handle(any(InputRow.class))).thenReturn(false);</span>
<span class="hljs-deletion">-}</span>
<span class="hljs-addition">+public void setup() {</span>
<span class="hljs-addition">+    successfulHandler = createMockInputRowHandler(true);</span>
<span class="hljs-addition">+    unsuccessfulHandler = createMockInputRowHandler(false);</span>
<span class="hljs-addition">+}</span>
 
 @Test
 public void yieldsNullIfHandledBySecond() {
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">yieldsNullIfHandledBySecond</span><span class="hljs-params">()</span> </span>{

    HandlingInputRowIterator target = createInputRowIterator(unsuccessfulHandler, successfulHandler);

    Assert.assertNull(target.next());

    Mockito.verify(unsuccessfulHandler, Mockito.times(<span class="hljs-number">1</span>)).handle(INPUT_ROW1);

    Mockito.verify(successfulHandler, Mockito.times(<span class="hljs-number">1</span>)).handle(INPUT_ROW1);

}
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// Construct mock object</span>

    successfulHandler = mock(HandlingInputRowIterator.InputRowHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// Method Stubs</span>

    when(successfulHandler.handle(any(InputRow<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    <span class="hljs-comment">// Construct mock object</span>

    unsuccessfulHandler = mock(HandlingInputRowIterator.InputRowHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// Method Stubs</span>

    when(unsuccessfulHandler.handle(any(InputRow<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">false</span>)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HandlingInputRowIterator.<span class="hljs-function">InputRowHandler <span class="hljs-title">createMockInputRowHandler</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> handleReturnValue)</span> </span>{
    HandlingInputRowIterator.InputRowHandler handler = mock(HandlingInputRowIterator.InputRowHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(handler.handle(any(InputRow<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">handleReturnValue</span>)</span>;
    <span class="hljs-keyword">return</span> handler;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest463">Test Case ID #druid_Test_46_3</h4>
<h4 id="test-case-name-hasnextfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruiddatainputhandlinginputrowiteratortestjava">Test Case Name: <code>hasNext</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\data\input\HandlingInputRowIteratorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-unsuccessfulhandler">Mock Object Variable Name: <code>unsuccessfulHandler</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    // Construct mock object
<span class="hljs-deletion">-    unsuccessfulHandler = mock(HandlingInputRowIterator.InputRowHandler.class);</span>
    // Method Stubs
<span class="hljs-deletion">-    when(unsuccessfulHandler.handle(any(InputRow.class))).thenReturn(false);</span>
<span class="hljs-addition">+    unsuccessfulHandler = createMockInputRowHandler(false);</span>
}
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">hasNext</span><span class="hljs-params">()</span> </span>{

    HandlingInputRowIterator target = createInputRowIterator(unsuccessfulHandler, unsuccessfulHandler);

    Assert.assertTrue(target.hasNext());

    Mockito.verify(unsuccessfulHandler, Mockito.never()).handle(INPUT_ROW1);

}
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// Construct mock object</span>

    successfulHandler = mock(HandlingInputRowIterator.InputRowHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// Method Stubs</span>

    when(successfulHandler.handle(any(InputRow<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    <span class="hljs-comment">// Construct mock object</span>

    unsuccessfulHandler = mock(HandlingInputRowIterator.InputRowHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// Method Stubs</span>

    when(unsuccessfulHandler.handle(any(InputRow<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">false</span>)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HandlingInputRowIterator.<span class="hljs-function">InputRowHandler <span class="hljs-title">createMockInputRowHandler</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> handleReturnValue)</span> </span>{
    HandlingInputRowIterator.InputRowHandler handler = mock(HandlingInputRowIterator.InputRowHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(handler.handle(any(InputRow<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">handleReturnValue</span>)</span>;
    <span class="hljs-keyword">return</span> handler;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest464">Test Case ID #druid_Test_46_4</h4>
<h4 id="test-case-name-yieldsnextifunhandledfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruiddatainputhandlinginputrowiteratortestjava">Test Case Name: <code>yieldsNextIfUnhandled</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\data\input\HandlingInputRowIteratorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-unsuccessfulhandler">Mock Object Variable Name: <code>unsuccessfulHandler</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- Original.java</span>
<span class="hljs-comment">+++ Refactored.java</span>
@@
 @Before
 public void setup() {
     // Construct mock object
     successfulHandler = mock(HandlingInputRowIterator.InputRowHandler.class);
     // Method Stubs
     when(successfulHandler.handle(any(InputRow.class))).thenReturn(true);
<span class="hljs-deletion">-    // Construct mock object</span>
<span class="hljs-deletion">-    unsuccessfulHandler = mock(HandlingInputRowIterator.InputRowHandler.class);</span>
<span class="hljs-deletion">-    // Method Stubs</span>
<span class="hljs-deletion">-    when(unsuccessfulHandler.handle(any(InputRow.class))).thenReturn(false);</span>
<span class="hljs-addition">+    // Construct mock object and method stubs for unsuccessfulHandler</span>
<span class="hljs-addition">+    unsuccessfulHandler = createMockInputRowHandler(false);</span>
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// Construct mock object</span>

    successfulHandler = mock(HandlingInputRowIterator.InputRowHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// Method Stubs</span>

    when(successfulHandler.handle(any(InputRow<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    <span class="hljs-comment">// Construct mock object</span>

    unsuccessfulHandler = mock(HandlingInputRowIterator.InputRowHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// Method Stubs</span>

    when(unsuccessfulHandler.handle(any(InputRow<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">false</span>)</span>;

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">yieldsNextIfUnhandled</span><span class="hljs-params">()</span> </span>{

    HandlingInputRowIterator target = createInputRowIterator(unsuccessfulHandler, unsuccessfulHandler);

    Assert.assertEquals(INPUT_ROW1, target.next());

    Mockito.verify(unsuccessfulHandler, Mockito.times(<span class="hljs-number">2</span>)).handle(INPUT_ROW1);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HandlingInputRowIterator.<span class="hljs-function">InputRowHandler <span class="hljs-title">createMockInputRowHandler</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> handleReturnValue)</span> </span>{
    HandlingInputRowIterator.InputRowHandler handler = mock(HandlingInputRowIterator.InputRowHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(handler.handle(any(InputRow<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">handleReturnValue</span>)</span>;
    <span class="hljs-keyword">return</span> handler;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest465">Test Case ID #druid_Test_46_5</h4>
<h4 id="test-case-name-yieldsnullifhandledbyfirstfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruiddatainputhandlinginputrowiteratortestjava">Test Case Name: <code>yieldsNullIfHandledByFirst</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\data\input\HandlingInputRowIteratorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-unsuccessfulhandler">Mock Object Variable Name: <code>unsuccessfulHandler</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- OriginalTest.java</span>
<span class="hljs-comment">+++ RefactoredTest.java</span>
@@
 @Before
 public void setup() {
     // Construct mock object
     successfulHandler = mock(HandlingInputRowIterator.InputRowHandler.class);
     // Method Stubs
     when(successfulHandler.handle(any(InputRow.class))).thenReturn(true);
<span class="hljs-deletion">-    // Construct mock object</span>
<span class="hljs-deletion">-    unsuccessfulHandler = mock(HandlingInputRowIterator.InputRowHandler.class);</span>
<span class="hljs-deletion">-    // Method Stubs</span>
<span class="hljs-deletion">-    when(unsuccessfulHandler.handle(any(InputRow.class))).thenReturn(false);</span>
<span class="hljs-addition">+    // Construct mock object</span>
<span class="hljs-addition">+    unsuccessfulHandler = createMockInputRowHandler(false);</span>
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">yieldsNullIfHandledByFirst</span><span class="hljs-params">()</span> </span>{

    HandlingInputRowIterator target = createInputRowIterator(successfulHandler, unsuccessfulHandler);

    Assert.assertNull(target.next());

    Mockito.verify(successfulHandler, Mockito.times(<span class="hljs-number">1</span>)).handle(INPUT_ROW1);

    Mockito.verify(unsuccessfulHandler, Mockito.never()).handle(INPUT_ROW1);

}
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// Construct mock object</span>

    successfulHandler = mock(HandlingInputRowIterator.InputRowHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// Method Stubs</span>

    when(successfulHandler.handle(any(InputRow<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    <span class="hljs-comment">// Construct mock object</span>

    unsuccessfulHandler = mock(HandlingInputRowIterator.InputRowHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// Method Stubs</span>

    when(unsuccessfulHandler.handle(any(InputRow<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">false</span>)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HandlingInputRowIterator.<span class="hljs-function">InputRowHandler <span class="hljs-title">createMockInputRowHandler</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> handleReturnValue)</span> </span>{
    HandlingInputRowIterator.InputRowHandler handler = mock(HandlingInputRowIterator.InputRowHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(handler.handle(any(InputRow<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">handleReturnValue</span>)</span>;
    <span class="hljs-keyword">return</span> handler;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest466">Test Case ID #druid_Test_46_6</h4>
<h4 id="test-case-name-yieldsnullifhandledbysecondfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruiddatainputhandlinginputrowiteratortestjava">Test Case Name: <code>yieldsNullIfHandledBySecond</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\data\input\HandlingInputRowIteratorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-unsuccessfulhandler">Mock Object Variable Name: <code>unsuccessfulHandler</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- OriginalTest.java</span>
<span class="hljs-comment">+++ RefactoredTest.java</span>
@@
    // Construct mock object
<span class="hljs-deletion">-    unsuccessfulHandler = mock(HandlingInputRowIterator.InputRowHandler.class);</span>
    // Method Stubs
<span class="hljs-deletion">-    when(unsuccessfulHandler.handle(any(InputRow.class))).thenReturn(false);</span>
<span class="hljs-addition">+    unsuccessfulHandler = createMockInputRowHandler(false);</span>
 }

</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">yieldsNullIfHandledBySecond</span><span class="hljs-params">()</span> </span>{

    HandlingInputRowIterator target = createInputRowIterator(unsuccessfulHandler, successfulHandler);

    Assert.assertNull(target.next());

    Mockito.verify(unsuccessfulHandler, Mockito.times(<span class="hljs-number">1</span>)).handle(INPUT_ROW1);

    Mockito.verify(successfulHandler, Mockito.times(<span class="hljs-number">1</span>)).handle(INPUT_ROW1);

}
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-comment">// Construct mock object</span>

    successfulHandler = mock(HandlingInputRowIterator.InputRowHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// Method Stubs</span>

    when(successfulHandler.handle(any(InputRow<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    <span class="hljs-comment">// Construct mock object</span>

    unsuccessfulHandler = mock(HandlingInputRowIterator.InputRowHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// Method Stubs</span>

    when(unsuccessfulHandler.handle(any(InputRow<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">false</span>)</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HandlingInputRowIterator.<span class="hljs-function">InputRowHandler <span class="hljs-title">createMockInputRowHandler</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> handleReturnValue)</span> </span>{
    HandlingInputRowIterator.InputRowHandler handler = mock(HandlingInputRowIterator.InputRowHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(handler.handle(any(InputRow<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">handleReturnValue</span>)</span>;
    <span class="hljs-keyword">return</span> handler;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci47">Mock Clone Instance #druid_MCI_47</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.timeline.DataSegment</code></li>
<li><strong>Test Case Count</strong>: 10</li>
<li><strong>MO Count</strong>: 12</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDataSegment</span> </span>{
  <span class="hljs-comment">/**
   * Creates a mock DataSegment with configurable loadSpec map.
   *
   * <span class="hljs-doctag">@param</span> typeValue the value for the "type" key in the loadSpec map
   * <span class="hljs-doctag">@return</span> a Mockito mock of DataSegment with getLoadSpec() stubbed
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSegment <span class="hljs-title">createMockDataSegment</span><span class="hljs-params">(String typeValue)</span> </span>{
    DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, typeValue));
    <span class="hljs-keyword">return</span> segment;
  }
}

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest471">Test Case ID #druid_Test_47_1</h4>
<h4 id="test-case-name-testarchivesegmentwithtypefile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidsegmentloadingomnidatasegmentarchivertestjava">Test Case Name: <code>testArchiveSegmentWithType</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\segment\loading\OmniDataSegmentArchiverTest.java</code>)</h4>
<h4 id="mock-object-variable-name-segment">Mock Object Variable Name: <code>segment</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final DataSegmentArchiver archiver = Mockito.mock(DataSegmentArchiver.class);
<span class="hljs-deletion">-    final DataSegment segment = Mockito.mock(DataSegment.class);</span>
<span class="hljs-deletion">-    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of("type", "sane"));</span>
<span class="hljs-addition">+    final DataSegment segment = MockDataSegment.createMockDataSegment("sane");</span>
    final Injector injector = createInjector(archiver);
    final DataSegmentArchiver segmentArchiver = injector.getInstance(OmniDataSegmentArchiver.class);
    segmentArchiver.archive(segment);
    Mockito.verify(archiver, Mockito.times(1)).archive(segment);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testArchiveSegmentWithType</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SegmentLoadingException </span>{

    <span class="hljs-keyword">final</span> DataSegmentArchiver archiver = Mockito.mock(DataSegmentArchiver<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"sane"</span>));

    <span class="hljs-keyword">final</span> Injector injector = createInjector(archiver);

    <span class="hljs-keyword">final</span> DataSegmentArchiver segmentArchiver = injector.getInstance(OmniDataSegmentArchiver<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    segmentArchiver.archive(segment);

    Mockito.verify(archiver, Mockito.times(<span class="hljs-number">1</span>)).archive(segment);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDataSegment</span> </span>{
  <span class="hljs-comment">/**
   * Creates a mock DataSegment with configurable loadSpec map.
   *
   * <span class="hljs-doctag">@param</span> typeValue the value for the "type" key in the loadSpec map
   * <span class="hljs-doctag">@return</span> a Mockito mock of DataSegment with getLoadSpec() stubbed
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSegment <span class="hljs-title">createMockDataSegment</span><span class="hljs-params">(String typeValue)</span> </span>{
    DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, typeValue));
    <span class="hljs-keyword">return</span> segment;
  }
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest472">Test Case ID #druid_Test_47_2</h4>
<h4 id="test-case-name-testarchivesegmentunknowtypefile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidsegmentloadingomnidatasegmentarchivertestjava">Test Case Name: <code>testArchiveSegmentUnknowType</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\segment\loading\OmniDataSegmentArchiverTest.java</code>)</h4>
<h4 id="mock-object-variable-name-segment">Mock Object Variable Name: <code>segment</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testArchiveSegmentUnknowType() {
<span class="hljs-deletion">-    final DataSegment segment = Mockito.mock(DataSegment.class);</span>
<span class="hljs-deletion">-    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of("type", "unknown-type"));</span>
<span class="hljs-addition">+    final DataSegment segment = MockDataSegment.createMockDataSegment("unknown-type");</span>
     final Injector injector = createInjector(null);
     final OmniDataSegmentArchiver segmentArchiver = injector.getInstance(OmniDataSegmentArchiver.class);
     Assert.assertThrows("Unknown loader type[unknown-type]. Known types are [explode]", SegmentLoadingException.class, () -&gt; segmentArchiver.archive(segment));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testArchiveSegmentUnknowType</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"unknown-type"</span>));

    <span class="hljs-keyword">final</span> Injector injector = createInjector(<span class="hljs-keyword">null</span>);

    <span class="hljs-keyword">final</span> OmniDataSegmentArchiver segmentArchiver = injector.getInstance(OmniDataSegmentArchiver<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Assert.assertThrows(<span class="hljs-string">"Unknown loader type[unknown-type]. Known types are [explode]"</span>, SegmentLoadingException<span class="hljs-class">.<span class="hljs-keyword">class</span>, () -&gt; <span class="hljs-title">segmentArchiver</span>.<span class="hljs-title">archive</span>(<span class="hljs-title">segment</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDataSegment</span> </span>{
  <span class="hljs-comment">/**
   * Creates a mock DataSegment with configurable loadSpec map.
   *
   * <span class="hljs-doctag">@param</span> typeValue the value for the "type" key in the loadSpec map
   * <span class="hljs-doctag">@return</span> a Mockito mock of DataSegment with getLoadSpec() stubbed
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSegment <span class="hljs-title">createMockDataSegment</span><span class="hljs-params">(String typeValue)</span> </span>{
    DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, typeValue));
    <span class="hljs-keyword">return</span> segment;
  }
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest473">Test Case ID #druid_Test_47_3</h4>
<h4 id="test-case-name-testbadsegmentarchiveraccessexceptionfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidsegmentloadingomnidatasegmentarchivertestjava">Test Case Name: <code>testBadSegmentArchiverAccessException</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\segment\loading\OmniDataSegmentArchiverTest.java</code>)</h4>
<h4 id="mock-object-variable-name-segment">Mock Object Variable Name: <code>segment</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void testBadSegmentArchiverAccessException() {
<span class="hljs-deletion">-    final DataSegment segment = Mockito.mock(DataSegment.class);</span>
<span class="hljs-deletion">-    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of("type", "bad"));</span>
<span class="hljs-addition">+    final DataSegment segment = MockDataSegment.createMockDataSegment("bad");</span>
     final Injector injector = createInjector(null);
     final OmniDataSegmentArchiver segmentArchiver = injector.getInstance(OmniDataSegmentArchiver.class);
     Assert.assertThrows("BadSegmentArchiver must not have been initialized", RuntimeException.class, () -&gt; segmentArchiver.archive(segment));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testBadSegmentArchiverAccessException</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"bad"</span>));

    <span class="hljs-keyword">final</span> Injector injector = createInjector(<span class="hljs-keyword">null</span>);

    <span class="hljs-keyword">final</span> OmniDataSegmentArchiver segmentArchiver = injector.getInstance(OmniDataSegmentArchiver<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Assert.assertThrows(<span class="hljs-string">"BadSegmentArchiver must not have been initialized"</span>, RuntimeException<span class="hljs-class">.<span class="hljs-keyword">class</span>, () -&gt; <span class="hljs-title">segmentArchiver</span>.<span class="hljs-title">archive</span>(<span class="hljs-title">segment</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDataSegment</span> </span>{
  <span class="hljs-comment">/**
   * Creates a mock DataSegment with configurable loadSpec map.
   *
   * <span class="hljs-doctag">@param</span> typeValue the value for the "type" key in the loadSpec map
   * <span class="hljs-doctag">@return</span> a Mockito mock of DataSegment with getLoadSpec() stubbed
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSegment <span class="hljs-title">createMockDataSegment</span><span class="hljs-params">(String typeValue)</span> </span>{
    DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, typeValue));
    <span class="hljs-keyword">return</span> segment;
  }
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest474">Test Case ID #druid_Test_47_4</h4>
<h4 id="test-case-name-testkillsegmentwithtypefile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidsegmentloadingomnidatasegmentkillertestjava">Test Case Name: <code>testKillSegmentWithType</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\segment\loading\OmniDataSegmentKillerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-segment">Mock Object Variable Name: <code>segment</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final DataSegmentKiller killer = Mockito.mock(DataSegmentKiller.class);
<span class="hljs-deletion">-    final DataSegment segment = Mockito.mock(DataSegment.class);</span>
<span class="hljs-deletion">-    Mockito.when(segment.isTombstone()).thenReturn(false);</span>
<span class="hljs-deletion">-    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of("type", "sane"));</span>
<span class="hljs-addition">+    final DataSegment segment = MockDataSegment.createMockDataSegment("sane");</span>
<span class="hljs-addition">+    Mockito.when(segment.isTombstone()).thenReturn(false);</span>
    final Injector injector = createInjector(killer);
    final OmniDataSegmentKiller segmentKiller = injector.getInstance(OmniDataSegmentKiller.class);
    segmentKiller.kill(segment);
    Mockito.verify(killer, Mockito.times(1)).kill(segment);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testKillSegmentWithType</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SegmentLoadingException </span>{

    <span class="hljs-keyword">final</span> DataSegmentKiller killer = Mockito.mock(DataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(segment.isTombstone()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"sane"</span>));

    <span class="hljs-keyword">final</span> Injector injector = createInjector(killer);

    <span class="hljs-keyword">final</span> OmniDataSegmentKiller segmentKiller = injector.getInstance(OmniDataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    segmentKiller.kill(segment);

    Mockito.verify(killer, Mockito.times(<span class="hljs-number">1</span>)).kill(segment);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDataSegment</span> </span>{
  <span class="hljs-comment">/**
   * Creates a mock DataSegment with configurable loadSpec map.
   *
   * <span class="hljs-doctag">@param</span> typeValue the value for the "type" key in the loadSpec map
   * <span class="hljs-doctag">@return</span> a Mockito mock of DataSegment with getLoadSpec() stubbed
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSegment <span class="hljs-title">createMockDataSegment</span><span class="hljs-params">(String typeValue)</span> </span>{
    DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, typeValue));
    <span class="hljs-keyword">return</span> segment;
  }
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest475">Test Case ID #druid_Test_47_5</h4>
<h4 id="test-case-name-testkillsegmentunknowtypefile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidsegmentloadingomnidatasegmentkillertestjava">Test Case Name: <code>testKillSegmentUnknowType</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\segment\loading\OmniDataSegmentKillerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-segment">Mock Object Variable Name: <code>segment</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testKillSegmentUnknowType() {
<span class="hljs-deletion">-    final DataSegment segment = Mockito.mock(DataSegment.class);</span>
<span class="hljs-deletion">-    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of("type", "unknown-type"));</span>
<span class="hljs-addition">+    final DataSegment segment = MockDataSegment.createMockDataSegment("unknown-type");</span>
    final Injector injector = createInjector(null);
    final OmniDataSegmentKiller segmentKiller = injector.getInstance(OmniDataSegmentKiller.class);
    Assert.assertThrows("Unknown loader type[unknown-type]. Known types are [explode]", SegmentLoadingException.class, () -&gt; segmentKiller.kill(segment));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testKillSegmentUnknowType</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"unknown-type"</span>));

    <span class="hljs-keyword">final</span> Injector injector = createInjector(<span class="hljs-keyword">null</span>);

    <span class="hljs-keyword">final</span> OmniDataSegmentKiller segmentKiller = injector.getInstance(OmniDataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Assert.assertThrows(<span class="hljs-string">"Unknown loader type[unknown-type]. Known types are [explode]"</span>, SegmentLoadingException<span class="hljs-class">.<span class="hljs-keyword">class</span>, () -&gt; <span class="hljs-title">segmentKiller</span>.<span class="hljs-title">kill</span>(<span class="hljs-title">segment</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDataSegment</span> </span>{
  <span class="hljs-comment">/**
   * Creates a mock DataSegment with configurable loadSpec map.
   *
   * <span class="hljs-doctag">@param</span> typeValue the value for the "type" key in the loadSpec map
   * <span class="hljs-doctag">@return</span> a Mockito mock of DataSegment with getLoadSpec() stubbed
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSegment <span class="hljs-title">createMockDataSegment</span><span class="hljs-params">(String typeValue)</span> </span>{
    DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, typeValue));
    <span class="hljs-keyword">return</span> segment;
  }
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest476">Test Case ID #druid_Test_47_6</h4>
<h4 id="test-case-name-testbadsegmentkilleraccessexceptionfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidsegmentloadingomnidatasegmentkillertestjava">Test Case Name: <code>testBadSegmentKillerAccessException</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\segment\loading\OmniDataSegmentKillerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-segment">Mock Object Variable Name: <code>segment</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     final DataSegment segment = Mockito.mock(DataSegment.class);
<span class="hljs-deletion">-    final DataSegment segment = Mockito.mock(DataSegment.class);</span>
<span class="hljs-deletion">-    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of("type", "bad"));</span>
<span class="hljs-addition">+    final DataSegment segment = MockDataSegment.createMockDataSegment("bad");</span>
     final Injector injector = createInjector(null);
     final OmniDataSegmentKiller segmentKiller = injector.getInstance(OmniDataSegmentKiller.class);
     Assert.assertThrows("BadSegmentKiller must not have been initialized", RuntimeException.class, () -&gt; segmentKiller.kill(segment));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testBadSegmentKillerAccessException</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"bad"</span>));

    <span class="hljs-keyword">final</span> Injector injector = createInjector(<span class="hljs-keyword">null</span>);

    <span class="hljs-keyword">final</span> OmniDataSegmentKiller segmentKiller = injector.getInstance(OmniDataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Assert.assertThrows(<span class="hljs-string">"BadSegmentKiller must not have been initialized"</span>, RuntimeException<span class="hljs-class">.<span class="hljs-keyword">class</span>, () -&gt; <span class="hljs-title">segmentKiller</span>.<span class="hljs-title">kill</span>(<span class="hljs-title">segment</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDataSegment</span> </span>{
  <span class="hljs-comment">/**
   * Creates a mock DataSegment with configurable loadSpec map.
   *
   * <span class="hljs-doctag">@param</span> typeValue the value for the "type" key in the loadSpec map
   * <span class="hljs-doctag">@return</span> a Mockito mock of DataSegment with getLoadSpec() stubbed
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSegment <span class="hljs-title">createMockDataSegment</span><span class="hljs-params">(String typeValue)</span> </span>{
    DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, typeValue));
    <span class="hljs-keyword">return</span> segment;
  }
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest477">Test Case ID #druid_Test_47_7</h4>
<h4 id="test-case-name-testkillmultiplesegmentswithtypefile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidsegmentloadingomnidatasegmentkillertestjava">Test Case Name: <code>testKillMultipleSegmentsWithType</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\segment\loading\OmniDataSegmentKillerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-segment1">Mock Object Variable Name: <code>segment1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
     final DataSegmentKiller killerSane = Mockito.mock(DataSegmentKiller.class);
     final DataSegmentKiller killerSaneTwo = Mockito.mock(DataSegmentKiller.class);
<span class="hljs-deletion">-    final DataSegment segment1 = Mockito.mock(DataSegment.class);</span>
<span class="hljs-addition">+    final DataSegment segment1 = MockDataSegment.createMockDataSegment("sane");</span>
     final DataSegment segment2 = Mockito.mock(DataSegment.class);
     final DataSegment segment3 = Mockito.mock(DataSegment.class);
<span class="hljs-addition">+    Mockito.when(segment1.isTombstone()).thenReturn(false);</span>
     Mockito.when(segment2.isTombstone()).thenReturn(false);
     Mockito.when(segment2.getLoadSpec()).thenReturn(ImmutableMap.of("type", "sane"));
     Mockito.when(segment3.isTombstone()).thenReturn(false);
     Mockito.when(segment3.getLoadSpec()).thenReturn(ImmutableMap.of("type", "sane_2"));
     final Injector injector = createInjectorFromMap(ImmutableMap.of("sane", killerSane, "sane_2", killerSaneTwo));
     final OmniDataSegmentKiller segmentKiller = injector.getInstance(OmniDataSegmentKiller.class);
     segmentKiller.kill(ImmutableList.of(segment1, segment2, segment3));
     Mockito.verify(killerSane, Mockito.times(1)).kill((List&lt;DataSegment&gt;) argThat(containsInAnyOrder(segment1, segment2)));
     Mockito.verify(killerSaneTwo, Mockito.times(1)).kill((List&lt;DataSegment&gt;) argThat(containsInAnyOrder(segment3)));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testKillMultipleSegmentsWithType</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SegmentLoadingException </span>{

    <span class="hljs-keyword">final</span> DataSegmentKiller killerSane = Mockito.mock(DataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegmentKiller killerSaneTwo = Mockito.mock(DataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegment segment1 = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegment segment2 = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegment segment3 = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(segment1.isTombstone()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(segment1.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"sane"</span>));

    Mockito.when(segment2.isTombstone()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(segment2.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"sane"</span>));

    Mockito.when(segment3.isTombstone()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(segment3.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"sane_2"</span>));

    <span class="hljs-keyword">final</span> Injector injector = createInjectorFromMap(ImmutableMap.of(<span class="hljs-string">"sane"</span>, killerSane, <span class="hljs-string">"sane_2"</span>, killerSaneTwo));

    <span class="hljs-keyword">final</span> OmniDataSegmentKiller segmentKiller = injector.getInstance(OmniDataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    segmentKiller.kill(ImmutableList.of(segment1, segment2, segment3));

    Mockito.verify(killerSane, Mockito.times(<span class="hljs-number">1</span>)).kill((List&lt;DataSegment&gt;) argThat(containsInAnyOrder(segment1, segment2)));

    Mockito.verify(killerSaneTwo, Mockito.times(<span class="hljs-number">1</span>)).kill((List&lt;DataSegment&gt;) argThat(containsInAnyOrder(segment3)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDataSegment</span> </span>{
  <span class="hljs-comment">/**
   * Creates a mock DataSegment with configurable loadSpec map.
   *
   * <span class="hljs-doctag">@param</span> typeValue the value for the "type" key in the loadSpec map
   * <span class="hljs-doctag">@return</span> a Mockito mock of DataSegment with getLoadSpec() stubbed
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSegment <span class="hljs-title">createMockDataSegment</span><span class="hljs-params">(String typeValue)</span> </span>{
    DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, typeValue));
    <span class="hljs-keyword">return</span> segment;
  }
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest478">Test Case ID #druid_Test_47_8</h4>
<h4 id="test-case-name-testkillmultiplesegmentswithtypefile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidsegmentloadingomnidatasegmentkillertestjava">Test Case Name: <code>testKillMultipleSegmentsWithType</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\segment\loading\OmniDataSegmentKillerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-segment2">Mock Object Variable Name: <code>segment2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final DataSegmentKiller killerSane = Mockito.mock(DataSegmentKiller.class);
    final DataSegmentKiller killerSaneTwo = Mockito.mock(DataSegmentKiller.class);
    final DataSegment segment1 = Mockito.mock(DataSegment.class);
<span class="hljs-deletion">-    final DataSegment segment2 = Mockito.mock(DataSegment.class);</span>
    final DataSegment segment3 = Mockito.mock(DataSegment.class);
    Mockito.when(segment1.isTombstone()).thenReturn(false);
    Mockito.when(segment1.getLoadSpec()).thenReturn(ImmutableMap.of("type", "sane"));
<span class="hljs-addition">+    final DataSegment segment2 = MockDataSegment.createMockDataSegment("sane");</span>
    Mockito.when(segment2.isTombstone()).thenReturn(false);
<span class="hljs-deletion">-    Mockito.when(segment2.getLoadSpec()).thenReturn(ImmutableMap.of("type", "sane"));</span>
    Mockito.when(segment3.isTombstone()).thenReturn(false);
    Mockito.when(segment3.getLoadSpec()).thenReturn(ImmutableMap.of("type", "sane_2"));
    final Injector injector = createInjectorFromMap(ImmutableMap.of("sane", killerSane, "sane_2", killerSaneTwo));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testKillMultipleSegmentsWithType</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SegmentLoadingException </span>{

    <span class="hljs-keyword">final</span> DataSegmentKiller killerSane = Mockito.mock(DataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegmentKiller killerSaneTwo = Mockito.mock(DataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegment segment1 = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegment segment2 = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegment segment3 = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(segment1.isTombstone()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(segment1.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"sane"</span>));

    Mockito.when(segment2.isTombstone()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(segment2.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"sane"</span>));

    Mockito.when(segment3.isTombstone()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(segment3.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"sane_2"</span>));

    <span class="hljs-keyword">final</span> Injector injector = createInjectorFromMap(ImmutableMap.of(<span class="hljs-string">"sane"</span>, killerSane, <span class="hljs-string">"sane_2"</span>, killerSaneTwo));

    <span class="hljs-keyword">final</span> OmniDataSegmentKiller segmentKiller = injector.getInstance(OmniDataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    segmentKiller.kill(ImmutableList.of(segment1, segment2, segment3));

    Mockito.verify(killerSane, Mockito.times(<span class="hljs-number">1</span>)).kill((List&lt;DataSegment&gt;) argThat(containsInAnyOrder(segment1, segment2)));

    Mockito.verify(killerSaneTwo, Mockito.times(<span class="hljs-number">1</span>)).kill((List&lt;DataSegment&gt;) argThat(containsInAnyOrder(segment3)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDataSegment</span> </span>{
  <span class="hljs-comment">/**
   * Creates a mock DataSegment with configurable loadSpec map.
   *
   * <span class="hljs-doctag">@param</span> typeValue the value for the "type" key in the loadSpec map
   * <span class="hljs-doctag">@return</span> a Mockito mock of DataSegment with getLoadSpec() stubbed
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSegment <span class="hljs-title">createMockDataSegment</span><span class="hljs-params">(String typeValue)</span> </span>{
    DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, typeValue));
    <span class="hljs-keyword">return</span> segment;
  }
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest479">Test Case ID #druid_Test_47_9</h4>
<h4 id="test-case-name-testkillmultiplesegmentswithtypefile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidsegmentloadingomnidatasegmentkillertestjava">Test Case Name: <code>testKillMultipleSegmentsWithType</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\segment\loading\OmniDataSegmentKillerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-segment3">Mock Object Variable Name: <code>segment3</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final DataSegment segment2 = Mockito.mock(DataSegment.class);
<span class="hljs-deletion">-    final DataSegment segment3 = Mockito.mock(DataSegment.class);</span>
<span class="hljs-addition">+    final DataSegment segment3 = MockDataSegment.createMockDataSegment("sane_2");</span>
    Mockito.when(segment1.isTombstone()).thenReturn(false);
    Mockito.when(segment1.getLoadSpec()).thenReturn(ImmutableMap.of("type", "sane"));
    Mockito.when(segment2.isTombstone()).thenReturn(false);
    Mockito.when(segment2.getLoadSpec()).thenReturn(ImmutableMap.of("type", "sane"));
<span class="hljs-deletion">-    Mockito.when(segment3.isTombstone()).thenReturn(false);</span>
<span class="hljs-deletion">-    Mockito.when(segment3.getLoadSpec()).thenReturn(ImmutableMap.of("type", "sane_2"));</span>
<span class="hljs-addition">+    Mockito.when(segment3.isTombstone()).thenReturn(false);</span>
    final Injector injector = createInjectorFromMap(ImmutableMap.of("sane", killerSane, "sane_2", killerSaneTwo));
    final OmniDataSegmentKiller segmentKiller = injector.getInstance(OmniDataSegmentKiller.class);
    segmentKiller.kill(ImmutableList.of(segment1, segment2, segment3));
    Mockito.verify(killerSane, Mockito.times(1)).kill((List&lt;DataSegment&gt;) argThat(containsInAnyOrder(segment1, segment2)));
    Mockito.verify(killerSaneTwo, Mockito.times(1)).kill((List&lt;DataSegment&gt;) argThat(containsInAnyOrder(segment3)));
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testKillMultipleSegmentsWithType</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SegmentLoadingException </span>{

    <span class="hljs-keyword">final</span> DataSegmentKiller killerSane = Mockito.mock(DataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegmentKiller killerSaneTwo = Mockito.mock(DataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegment segment1 = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegment segment2 = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegment segment3 = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(segment1.isTombstone()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(segment1.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"sane"</span>));

    Mockito.when(segment2.isTombstone()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(segment2.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"sane"</span>));

    Mockito.when(segment3.isTombstone()).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(segment3.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"sane_2"</span>));

    <span class="hljs-keyword">final</span> Injector injector = createInjectorFromMap(ImmutableMap.of(<span class="hljs-string">"sane"</span>, killerSane, <span class="hljs-string">"sane_2"</span>, killerSaneTwo));

    <span class="hljs-keyword">final</span> OmniDataSegmentKiller segmentKiller = injector.getInstance(OmniDataSegmentKiller<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    segmentKiller.kill(ImmutableList.of(segment1, segment2, segment3));

    Mockito.verify(killerSane, Mockito.times(<span class="hljs-number">1</span>)).kill((List&lt;DataSegment&gt;) argThat(containsInAnyOrder(segment1, segment2)));

    Mockito.verify(killerSaneTwo, Mockito.times(<span class="hljs-number">1</span>)).kill((List&lt;DataSegment&gt;) argThat(containsInAnyOrder(segment3)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDataSegment</span> </span>{
  <span class="hljs-comment">/**
   * Creates a mock DataSegment with configurable loadSpec map.
   *
   * <span class="hljs-doctag">@param</span> typeValue the value for the "type" key in the loadSpec map
   * <span class="hljs-doctag">@return</span> a Mockito mock of DataSegment with getLoadSpec() stubbed
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSegment <span class="hljs-title">createMockDataSegment</span><span class="hljs-params">(String typeValue)</span> </span>{
    DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, typeValue));
    <span class="hljs-keyword">return</span> segment;
  }
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest4710">Test Case ID #druid_Test_47_10</h4>
<h4 id="test-case-name-testmovesegmentwithtypefile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidsegmentloadingomnidatasegmentmovertestjava">Test Case Name: <code>testMoveSegmentWithType</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\segment\loading\OmniDataSegmentMoverTest.java</code>)</h4>
<h4 id="mock-object-variable-name-segment">Mock Object Variable Name: <code>segment</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
    final DataSegmentMover mover = Mockito.mock(DataSegmentMover.class);
<span class="hljs-deletion">-    final DataSegment segment = Mockito.mock(DataSegment.class);</span>
<span class="hljs-deletion">-    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of("type", "sane"));</span>
<span class="hljs-addition">+    final DataSegment segment = MockDataSegment.createMockDataSegment("sane");</span>
    final Injector injector = createInjector(mover);
    final OmniDataSegmentMover segmentMover = injector.getInstance(OmniDataSegmentMover.class);
    segmentMover.move(segment, ImmutableMap.of());
    Mockito.verify(mover, Mockito.times(1)).move(segment, ImmutableMap.of());
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMoveSegmentWithType</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SegmentLoadingException </span>{

    <span class="hljs-keyword">final</span> DataSegmentMover mover = Mockito.mock(DataSegmentMover<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"sane"</span>));

    <span class="hljs-keyword">final</span> Injector injector = createInjector(mover);

    <span class="hljs-keyword">final</span> OmniDataSegmentMover segmentMover = injector.getInstance(OmniDataSegmentMover<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    segmentMover.move(segment, ImmutableMap.of());

    Mockito.verify(mover, Mockito.times(<span class="hljs-number">1</span>)).move(segment, ImmutableMap.of());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDataSegment</span> </span>{
  <span class="hljs-comment">/**
   * Creates a mock DataSegment with configurable loadSpec map.
   *
   * <span class="hljs-doctag">@param</span> typeValue the value for the "type" key in the loadSpec map
   * <span class="hljs-doctag">@return</span> a Mockito mock of DataSegment with getLoadSpec() stubbed
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSegment <span class="hljs-title">createMockDataSegment</span><span class="hljs-params">(String typeValue)</span> </span>{
    DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, typeValue));
    <span class="hljs-keyword">return</span> segment;
  }
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest4711">Test Case ID #druid_Test_47_11</h4>
<h4 id="test-case-name-testmovesegmentunknowntypefile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidsegmentloadingomnidatasegmentmovertestjava">Test Case Name: <code>testMoveSegmentUnknownType</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\segment\loading\OmniDataSegmentMoverTest.java</code>)</h4>
<h4 id="mock-object-variable-name-segment">Mock Object Variable Name: <code>segment</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testMoveSegmentUnknownType() {
<span class="hljs-deletion">-    final DataSegment segment = Mockito.mock(DataSegment.class);</span>
<span class="hljs-deletion">-    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of("type", "unknown-type"));</span>
<span class="hljs-addition">+    final DataSegment segment = MockDataSegment.createMockDataSegment("unknown-type");</span>
    final Injector injector = createInjector(null);
    final OmniDataSegmentMover segmentMover = injector.getInstance(OmniDataSegmentMover.class);
    Assert.assertThrows("Unknown loader type[unknown-type]. Known types are [explode]", SegmentLoadingException.class, () -&gt; segmentMover.move(segment, ImmutableMap.of()));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMoveSegmentUnknownType</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"unknown-type"</span>));

    <span class="hljs-keyword">final</span> Injector injector = createInjector(<span class="hljs-keyword">null</span>);

    <span class="hljs-keyword">final</span> OmniDataSegmentMover segmentMover = injector.getInstance(OmniDataSegmentMover<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Assert.assertThrows(<span class="hljs-string">"Unknown loader type[unknown-type]. Known types are [explode]"</span>, SegmentLoadingException<span class="hljs-class">.<span class="hljs-keyword">class</span>, () -&gt; <span class="hljs-title">segmentMover</span>.<span class="hljs-title">move</span>(<span class="hljs-title">segment</span>, <span class="hljs-title">ImmutableMap</span>.<span class="hljs-title">of</span>()))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDataSegment</span> </span>{
  <span class="hljs-comment">/**
   * Creates a mock DataSegment with configurable loadSpec map.
   *
   * <span class="hljs-doctag">@param</span> typeValue the value for the "type" key in the loadSpec map
   * <span class="hljs-doctag">@return</span> a Mockito mock of DataSegment with getLoadSpec() stubbed
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSegment <span class="hljs-title">createMockDataSegment</span><span class="hljs-params">(String typeValue)</span> </span>{
    DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, typeValue));
    <span class="hljs-keyword">return</span> segment;
  }
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest4712">Test Case ID #druid_Test_47_12</h4>
<h4 id="test-case-name-testbadsegmentmoveraccessexceptionfile-cjavaprojectsapachedruidserversrctestjavaorgapachedruidsegmentloadingomnidatasegmentmovertestjava">Test Case Name: <code>testBadSegmentMoverAccessException</code>(File: <code>C:\Java_projects\Apache\druid\server\src\test\java\org\apache\druid\segment\loading\OmniDataSegmentMoverTest.java</code>)</h4>
<h4 id="mock-object-variable-name-segment">Mock Object Variable Name: <code>segment</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
public void testBadSegmentMoverAccessException() {
<span class="hljs-deletion">-    final DataSegment segment = Mockito.mock(DataSegment.class);</span>
<span class="hljs-deletion">-    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of("type", "bad"));</span>
<span class="hljs-addition">+    final DataSegment segment = MockDataSegment.createMockDataSegment("bad");</span>
    final Injector injector = createInjector(null);
    final OmniDataSegmentMover segmentMover = injector.getInstance(OmniDataSegmentMover.class);
    Assert.assertThrows("BadSegmentMover must not have been initialized", RuntimeException.class, () -&gt; segmentMover.move(segment, null));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testBadSegmentMoverAccessException</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, <span class="hljs-string">"bad"</span>));

    <span class="hljs-keyword">final</span> Injector injector = createInjector(<span class="hljs-keyword">null</span>);

    <span class="hljs-keyword">final</span> OmniDataSegmentMover segmentMover = injector.getInstance(OmniDataSegmentMover<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Assert.assertThrows(<span class="hljs-string">"BadSegmentMover must not have been initialized"</span>, RuntimeException<span class="hljs-class">.<span class="hljs-keyword">class</span>, () -&gt; <span class="hljs-title">segmentMover</span>.<span class="hljs-title">move</span>(<span class="hljs-title">segment</span>, <span class="hljs-title">null</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockDataSegment</span> </span>{
  <span class="hljs-comment">/**
   * Creates a mock DataSegment with configurable loadSpec map.
   *
   * <span class="hljs-doctag">@param</span> typeValue the value for the "type" key in the loadSpec map
   * <span class="hljs-doctag">@return</span> a Mockito mock of DataSegment with getLoadSpec() stubbed
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DataSegment <span class="hljs-title">createMockDataSegment</span><span class="hljs-params">(String typeValue)</span> </span>{
    DataSegment segment = Mockito.mock(DataSegment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(segment.getLoadSpec()).thenReturn(ImmutableMap.of(<span class="hljs-string">"type"</span>, typeValue));
    <span class="hljs-keyword">return</span> segment;
  }
}

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-druidmci48">Mock Clone Instance #druid_MCI_48</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.druid.segment.column.ColumnCapabilities</code></li>
<li><strong>Test Case Count</strong>: 6</li>
<li><strong>MO Count</strong>: 6</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockColumnCapabilities</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ColumnCapabilities <span class="hljs-title">createMockColumnCapabilities</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isNumericReturn)</span> </span>{
    ColumnCapabilities capabilities = Mockito.mock(ColumnCapabilities<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.doReturn(isNumericReturn).when(capabilities).isNumeric();
    <span class="hljs-keyword">return</span> capabilities;
  }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-druidtest481">Test Case ID #druid_Test_48_1</h4>
<h4 id="test-case-name-factorizevectorfornumerictypeshouldreturndoublevectoraggregatorfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidqueryaggregationanydoubleanyaggregatorfactorytestjava">Test Case Name: <code>factorizeVectorForNumericTypeShouldReturnDoubleVectorAggregator</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\aggregation\any\DoubleAnyAggregatorFactoryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-capabilities">Mock Object Variable Name: <code>capabilities</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void factorizeVectorForNumericTypeShouldReturnDoubleVectorAggregator() {
<span class="hljs-deletion">-    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);</span>
<span class="hljs-deletion">-    Mockito.doReturn(true).when(capabilities).isNumeric();</span>
<span class="hljs-addition">+    capabilities = MockColumnCapabilities.createMockColumnCapabilities(true);</span>
<span class="hljs-addition">+    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);</span>
     VectorAggregator aggregator = target.factorizeVector(selectorFactory);
     Assert.assertNotNull(aggregator);
     Assert.assertEquals(DoubleAnyVectorAggregator.class, aggregator.getClass());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">factorizeVectorForNumericTypeShouldReturnDoubleVectorAggregator</span><span class="hljs-params">()</span> </span>{

    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);

    Mockito.doReturn(<span class="hljs-keyword">true</span>).when(capabilities).isNumeric();

    VectorAggregator aggregator = target.factorizeVector(selectorFactory);

    Assert.assertNotNull(aggregator);

    Assert.assertEquals(DoubleAnyVectorAggregator<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">aggregator</span>.<span class="hljs-title">getClass</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockColumnCapabilities</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ColumnCapabilities <span class="hljs-title">createMockColumnCapabilities</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isNumericReturn)</span> </span>{
    ColumnCapabilities capabilities = Mockito.mock(ColumnCapabilities<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.doReturn(isNumericReturn).when(capabilities).isNumeric();
    <span class="hljs-keyword">return</span> capabilities;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest482">Test Case ID #druid_Test_48_2</h4>
<h4 id="test-case-name-factorizevectorforstringtypeshouldreturndoublevectoraggregatorwithnilselectorfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidqueryaggregationanydoubleanyaggregatorfactorytestjava">Test Case Name: <code>factorizeVectorForStringTypeShouldReturnDoubleVectorAggregatorWithNilSelector</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\aggregation\any\DoubleAnyAggregatorFactoryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-capabilities">Mock Object Variable Name: <code>capabilities</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
     Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);
<span class="hljs-deletion">-    Mockito.doReturn(false).when(capabilities).isNumeric();</span>
<span class="hljs-addition">+    capabilities = MockColumnCapabilities.createMockColumnCapabilities(false);</span>
     VectorAggregator aggregator = target.factorizeVector(selectorFactory);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">factorizeVectorForStringTypeShouldReturnDoubleVectorAggregatorWithNilSelector</span><span class="hljs-params">()</span> </span>{

    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);

    Mockito.doReturn(<span class="hljs-keyword">false</span>).when(capabilities).isNumeric();

    VectorAggregator aggregator = target.factorizeVector(selectorFactory);

    Assert.assertNotNull(aggregator);

    Assert.assertEquals(NullHandling.defaultDoubleValue(), aggregator.get(BUFFER, POSITION));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockColumnCapabilities</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ColumnCapabilities <span class="hljs-title">createMockColumnCapabilities</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isNumericReturn)</span> </span>{
    ColumnCapabilities capabilities = Mockito.mock(ColumnCapabilities<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.doReturn(isNumericReturn).when(capabilities).isNumeric();
    <span class="hljs-keyword">return</span> capabilities;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest483">Test Case ID #druid_Test_48_3</h4>
<h4 id="test-case-name-factorizevectorfornumerictypeshouldreturnfloatvectoraggregatorfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidqueryaggregationanyfloatanyaggregatorfactorytestjava">Test Case Name: <code>factorizeVectorForNumericTypeShouldReturnFloatVectorAggregator</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\aggregation\any\FloatAnyAggregatorFactoryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-capabilities">Mock Object Variable Name: <code>capabilities</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void factorizeVectorForNumericTypeShouldReturnFloatVectorAggregator() {
<span class="hljs-deletion">-    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);</span>
<span class="hljs-deletion">-    Mockito.doReturn(true).when(capabilities).isNumeric();</span>
<span class="hljs-addition">+    capabilities = MockColumnCapabilities.createMockColumnCapabilities(true);</span>
<span class="hljs-addition">+    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);</span>
     VectorAggregator aggregator = target.factorizeVector(selectorFactory);
     Assert.assertNotNull(aggregator);
     Assert.assertEquals(FloatAnyVectorAggregator.class, aggregator.getClass());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">factorizeVectorForNumericTypeShouldReturnFloatVectorAggregator</span><span class="hljs-params">()</span> </span>{

    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);

    Mockito.doReturn(<span class="hljs-keyword">true</span>).when(capabilities).isNumeric();

    VectorAggregator aggregator = target.factorizeVector(selectorFactory);

    Assert.assertNotNull(aggregator);

    Assert.assertEquals(FloatAnyVectorAggregator<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">aggregator</span>.<span class="hljs-title">getClass</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockColumnCapabilities</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ColumnCapabilities <span class="hljs-title">createMockColumnCapabilities</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isNumericReturn)</span> </span>{
    ColumnCapabilities capabilities = Mockito.mock(ColumnCapabilities<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.doReturn(isNumericReturn).when(capabilities).isNumeric();
    <span class="hljs-keyword">return</span> capabilities;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest484">Test Case ID #druid_Test_48_4</h4>
<h4 id="test-case-name-factorizevectorforstringtypeshouldreturnfloatvectoraggregatorwithnilselectorfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidqueryaggregationanyfloatanyaggregatorfactorytestjava">Test Case Name: <code>factorizeVectorForStringTypeShouldReturnFloatVectorAggregatorWithNilSelector</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\aggregation\any\FloatAnyAggregatorFactoryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-capabilities">Mock Object Variable Name: <code>capabilities</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div><span class="hljs-comment">--- original</span>
<span class="hljs-comment">+++ refactored</span>
@@
 @Test
 public void factorizeVectorForStringTypeShouldReturnFloatVectorAggregatorWithNilSelector() {
<span class="hljs-deletion">-    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);</span>
<span class="hljs-deletion">-    Mockito.doReturn(false).when(capabilities).isNumeric();</span>
<span class="hljs-addition">+    capabilities = MockColumnCapabilities.createMockColumnCapabilities(false);</span>
<span class="hljs-addition">+    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);</span>
     VectorAggregator aggregator = target.factorizeVector(selectorFactory);
     Assert.assertNotNull(aggregator);
     Assert.assertEquals(NullHandling.defaultFloatValue(), aggregator.get(BUFFER, POSITION));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">factorizeVectorForStringTypeShouldReturnFloatVectorAggregatorWithNilSelector</span><span class="hljs-params">()</span> </span>{

    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);

    Mockito.doReturn(<span class="hljs-keyword">false</span>).when(capabilities).isNumeric();

    VectorAggregator aggregator = target.factorizeVector(selectorFactory);

    Assert.assertNotNull(aggregator);

    Assert.assertEquals(NullHandling.defaultFloatValue(), aggregator.get(BUFFER, POSITION));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockColumnCapabilities</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ColumnCapabilities <span class="hljs-title">createMockColumnCapabilities</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isNumericReturn)</span> </span>{
    ColumnCapabilities capabilities = Mockito.mock(ColumnCapabilities<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.doReturn(isNumericReturn).when(capabilities).isNumeric();
    <span class="hljs-keyword">return</span> capabilities;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest485">Test Case ID #druid_Test_48_5</h4>
<h4 id="test-case-name-factorizevectorwithnumericcolumnshouldreturnlongvectoraggregatorfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidqueryaggregationanylonganyaggregatorfactorytestjava">Test Case Name: <code>factorizeVectorWithNumericColumnShouldReturnLongVectorAggregator</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\aggregation\any\LongAnyAggregatorFactoryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-capabilities">Mock Object Variable Name: <code>capabilities</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void factorizeVectorWithNumericColumnShouldReturnLongVectorAggregator() {
<span class="hljs-deletion">-    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);</span>
<span class="hljs-deletion">-    Mockito.doReturn(true).when(capabilities).isNumeric();</span>
<span class="hljs-addition">+    capabilities = MockColumnCapabilities.createMockColumnCapabilities(true);</span>
<span class="hljs-addition">+    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);</span>
     VectorAggregator aggregator = target.factorizeVector(selectorFactory);
     Assert.assertNotNull(aggregator);
     Assert.assertEquals(LongAnyVectorAggregator.class, aggregator.getClass());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">factorizeVectorWithNumericColumnShouldReturnLongVectorAggregator</span><span class="hljs-params">()</span> </span>{

    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);

    Mockito.doReturn(<span class="hljs-keyword">true</span>).when(capabilities).isNumeric();

    VectorAggregator aggregator = target.factorizeVector(selectorFactory);

    Assert.assertNotNull(aggregator);

    Assert.assertEquals(LongAnyVectorAggregator<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">aggregator</span>.<span class="hljs-title">getClass</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockColumnCapabilities</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ColumnCapabilities <span class="hljs-title">createMockColumnCapabilities</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isNumericReturn)</span> </span>{
    ColumnCapabilities capabilities = Mockito.mock(ColumnCapabilities<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.doReturn(isNumericReturn).when(capabilities).isNumeric();
    <span class="hljs-keyword">return</span> capabilities;
  }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-druidtest486">Test Case ID #druid_Test_48_6</h4>
<h4 id="test-case-name-factorizevectorforstringtypeshouldreturnlongvectoraggregatorwithnilselectorfile-cjavaprojectsapachedruidprocessingsrctestjavaorgapachedruidqueryaggregationanylonganyaggregatorfactorytestjava">Test Case Name: <code>factorizeVectorForStringTypeShouldReturnLongVectorAggregatorWithNilSelector</code>(File: <code>C:\Java_projects\Apache\druid\processing\src\test\java\org\apache\druid\query\aggregation\any\LongAnyAggregatorFactoryTest.java</code>)</h4>
<h4 id="mock-object-variable-name-capabilities">Mock Object Variable Name: <code>capabilities</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Test
 public void factorizeVectorForStringTypeShouldReturnLongVectorAggregatorWithNilSelector() {
<span class="hljs-deletion">-    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);</span>
<span class="hljs-deletion">-    Mockito.doReturn(false).when(capabilities).isNumeric();</span>
<span class="hljs-addition">+    capabilities = MockColumnCapabilities.createMockColumnCapabilities(false);</span>
<span class="hljs-addition">+    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);</span>
     VectorAggregator aggregator = target.factorizeVector(selectorFactory);
     Assert.assertNotNull(aggregator);
     Assert.assertEquals(NullHandling.defaultLongValue(), aggregator.get(BUFFER, POSITION));
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">factorizeVectorForStringTypeShouldReturnLongVectorAggregatorWithNilSelector</span><span class="hljs-params">()</span> </span>{

    Mockito.doReturn(capabilities).when(selectorFactory).getColumnCapabilities(FIELD_NAME);

    Mockito.doReturn(<span class="hljs-keyword">false</span>).when(capabilities).isNumeric();

    VectorAggregator aggregator = target.factorizeVector(selectorFactory);

    Assert.assertNotNull(aggregator);

    Assert.assertEquals(NullHandling.defaultLongValue(), aggregator.get(BUFFER, POSITION));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockColumnCapabilities</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ColumnCapabilities <span class="hljs-title">createMockColumnCapabilities</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isNumericReturn)</span> </span>{
    ColumnCapabilities capabilities = Mockito.mock(ColumnCapabilities<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.doReturn(isNumericReturn).when(capabilities).isNumeric();
    <span class="hljs-keyword">return</span> capabilities;
  }
}
</div></code></pre>
</details>
<hr>

</body>
</html>
