<!DOCTYPE html>
<html>
<head>
<title>cloudstack-Ablation 2-guide.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="ablation-2-a-guide-to-refactoring-mock-clones-in-cloudstack">Ablation 2: A guide to Refactoring mock clones in cloudstack</h1>
<h2 id="mock-clone-instance-cloudstackmci1">Mock Clone Instance #cloudstack_MCI_1</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.cloud.user.AccountService</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AccountService <span class="hljs-title">createMockAccountService</span><span class="hljs-params">(Account account)</span> </span>{
    AccountService accountService = Mockito.mock(AccountService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(accountService.getAccount(nullable(Long<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">account</span>)</span>;
    <span class="hljs-keyword">return</span> accountService;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest11">Test Case ID #cloudstack_Test_1_1</h4>
<h4 id="test-case-name-testcreatesuccessfile-cjavaprojectsapachecloudstackapisrctestjavaorgapachecloudstackapicommandtestaddvpnusercmdtestjava">Test Case Name: <code>testCreateSuccess</code>(File: <code>C:\Java_projects\Apache\cloudstack\api\src\test\java\org\apache\cloudstack\api\command\test\AddVpnUserCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-accountservice">Mock Object Variable Name: <code>accountService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testCreateSuccess() {
<span class="hljs-deletion">-    AccountService accountService = Mockito.mock(AccountService.class);</span>
     Account account = Mockito.mock(Account.class);
<span class="hljs-deletion">-    Mockito.when(accountService.getAccount(nullable(Long.class))).thenReturn(account);</span>
     addVpnUserCmd._accountService = accountService;
     RemoteAccessVpnService ravService = Mockito.mock(RemoteAccessVpnService.class);
     VpnUser vpnUser = Mockito.mock(VpnUser.class);
     Mockito.when(ravService.addVpnUser(anyLong(), isNull(), isNull())).thenReturn(vpnUser);
     addVpnUserCmd._ravService = ravService;
     addVpnUserCmd.create();
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCreateSuccess</span><span class="hljs-params">()</span> </span>{

    AccountService accountService = Mockito.mock(AccountService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Account account = Mockito.mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(accountService.getAccount(nullable(Long<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">account</span>)</span>;

    addVpnUserCmd._accountService = accountService;

    RemoteAccessVpnService ravService = Mockito.mock(RemoteAccessVpnService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    VpnUser vpnUser = Mockito.mock(VpnUser<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(ravService.addVpnUser(anyLong(), isNull(), isNull())).thenReturn(vpnUser);

    addVpnUserCmd._ravService = ravService;

    addVpnUserCmd.create();

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AccountService <span class="hljs-title">createMockAccountService</span><span class="hljs-params">(Account account)</span> </span>{
    AccountService accountService = Mockito.mock(AccountService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(accountService.getAccount(nullable(Long<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">account</span>)</span>;
    <span class="hljs-keyword">return</span> accountService;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest12">Test Case ID #cloudstack_Test_1_2</h4>
<h4 id="test-case-name-testcreatefailurefile-cjavaprojectsapachecloudstackapisrctestjavaorgapachecloudstackapicommandtestaddvpnusercmdtestjava">Test Case Name: <code>testCreateFailure</code>(File: <code>C:\Java_projects\Apache\cloudstack\api\src\test\java\org\apache\cloudstack\api\command\test\AddVpnUserCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-accountservice">Mock Object Variable Name: <code>accountService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testCreateFailure() {
<span class="hljs-deletion">-    AccountService accountService = Mockito.mock(AccountService.class);</span>
     Account account = Mockito.mock(Account.class);
<span class="hljs-deletion">-    Mockito.when(accountService.getAccount(nullable(Long.class))).thenReturn(account);</span>
     addVpnUserCmd._accountService = accountService;
     RemoteAccessVpnService ravService = Mockito.mock(RemoteAccessVpnService.class);
     Mockito.when(ravService.addVpnUser(anyLong(), isNull(), isNull())).thenReturn(null);
     addVpnUserCmd._ravService = ravService;
     try {
         addVpnUserCmd.create();
     } catch (ServerApiException exception) {
         Assert.assertEquals("Failed to add vpn user", exception.getDescription());
     }
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCreateFailure</span><span class="hljs-params">()</span> </span>{

    AccountService accountService = Mockito.mock(AccountService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Account account = Mockito.mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(accountService.getAccount(nullable(Long<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">account</span>)</span>;

    addVpnUserCmd._accountService = accountService;

    RemoteAccessVpnService ravService = Mockito.mock(RemoteAccessVpnService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(ravService.addVpnUser(anyLong(), isNull(), isNull())).thenReturn(<span class="hljs-keyword">null</span>);

    addVpnUserCmd._ravService = ravService;

    <span class="hljs-keyword">try</span> {

        addVpnUserCmd.create();

    } <span class="hljs-keyword">catch</span> (ServerApiException exception) {

        Assert.assertEquals(<span class="hljs-string">"Failed to add vpn user"</span>, exception.getDescription());

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AccountService <span class="hljs-title">createMockAccountService</span><span class="hljs-params">(Account account)</span> </span>{
    AccountService accountService = Mockito.mock(AccountService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(accountService.getAccount(nullable(Long<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">account</span>)</span>;
    <span class="hljs-keyword">return</span> accountService;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci2">Mock Clone Instance #cloudstack_MCI_2</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.cloud.user.AccountService</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div>
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest21">Test Case ID #cloudstack_Test_2_1</h4>
<h4 id="test-case-name-testcreatesuccessfile-cjavaprojectsapachecloudstackapisrctestjavaorgapachecloudstackapicommandtestcreatesnapshotcmdtestjava">Test Case Name: <code>testCreateSuccess</code>(File: <code>C:\Java_projects\Apache\cloudstack\api\src\test\java\org\apache\cloudstack\api\command\test\CreateSnapshotCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-accountservice">Mock Object Variable Name: <code>accountService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testCreateSuccess() {
<span class="hljs-deletion">-    AccountService accountService = Mockito.mock(AccountService.class);</span>
     Account account = Mockito.mock(Account.class);
<span class="hljs-deletion">-    Mockito.when(accountService.getAccount(anyLong())).thenReturn(account);</span>
<span class="hljs-addition">+    AccountService accountService = mockAccountServiceWithGetAccount(account);</span>
     VolumeApiService volumeApiService = Mockito.mock(VolumeApiService.class);
     Snapshot snapshot = Mockito.mock(Snapshot.class);
     try {
         Mockito.when(volumeApiService.takeSnapshot(nullable(Long.class), nullable(Long.class), isNull(), nullable(Account.class), nullable(Boolean.class), nullable(Snapshot.LocationType.class), nullable(Boolean.class), nullable(Map.class))).thenReturn(snapshot);
     } catch (Exception e) {
         Assert.fail("Received exception when success expected " + e.getMessage());
     }
     responseGenerator = Mockito.mock(ResponseGenerator.class);
     SnapshotResponse snapshotResponse = Mockito.mock(SnapshotResponse.class);
     Mockito.when(responseGenerator.createSnapshotResponse(snapshot)).thenReturn(snapshotResponse);
     Mockito.doNothing().when(snapshotResponse).setAccountName(anyString());
     createSnapshotCmd._accountService = accountService;
     createSnapshotCmd._responseGenerator = responseGenerator;
     createSnapshotCmd._volumeService = volumeApiService;
     try {
         createSnapshotCmd.execute();
     } catch (Exception e) {
         Assert.fail("Received exception when success expected " + e.getMessage());
     }
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCreateSuccess</span><span class="hljs-params">()</span> </span>{

    AccountService accountService = Mockito.mock(AccountService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Account account = Mockito.mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(accountService.getAccount(anyLong())).thenReturn(account);

    VolumeApiService volumeApiService = Mockito.mock(VolumeApiService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Snapshot snapshot = Mockito.mock(Snapshot<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">try</span> {

        Mockito.when(volumeApiService.takeSnapshot(nullable(Long<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">nullable</span>(<span class="hljs-title">Long</span>.<span class="hljs-title">class</span>), <span class="hljs-title">isNull</span>(), <span class="hljs-title">nullable</span>(<span class="hljs-title">Account</span>.<span class="hljs-title">class</span>), <span class="hljs-title">nullable</span>(<span class="hljs-title">Boolean</span>.<span class="hljs-title">class</span>), <span class="hljs-title">nullable</span>(<span class="hljs-title">Snapshot</span>.<span class="hljs-title">LocationType</span>.<span class="hljs-title">class</span>), <span class="hljs-title">nullable</span>(<span class="hljs-title">Boolean</span>.<span class="hljs-title">class</span>), <span class="hljs-title">nullable</span>(<span class="hljs-title">Map</span>.<span class="hljs-title">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">snapshot</span>)</span>;

    } <span class="hljs-keyword">catch</span> (Exception e) {

        Assert.fail(<span class="hljs-string">"Received exception when success expected "</span> + e.getMessage());

    }

    responseGenerator = Mockito.mock(ResponseGenerator<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SnapshotResponse snapshotResponse = Mockito.mock(SnapshotResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(responseGenerator.createSnapshotResponse(snapshot)).thenReturn(snapshotResponse);

    Mockito.doNothing().when(snapshotResponse).setAccountName(anyString());

    createSnapshotCmd._accountService = accountService;

    createSnapshotCmd._responseGenerator = responseGenerator;

    createSnapshotCmd._volumeService = volumeApiService;

    <span class="hljs-keyword">try</span> {

        createSnapshotCmd.execute();

    } <span class="hljs-keyword">catch</span> (Exception e) {

        Assert.fail(<span class="hljs-string">"Received exception when success expected "</span> + e.getMessage());

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest22">Test Case ID #cloudstack_Test_2_2</h4>
<h4 id="test-case-name-testcreatefailurefile-cjavaprojectsapachecloudstackapisrctestjavaorgapachecloudstackapicommandtestcreatesnapshotcmdtestjava">Test Case Name: <code>testCreateFailure</code>(File: <code>C:\Java_projects\Apache\cloudstack\api\src\test\java\org\apache\cloudstack\api\command\test\CreateSnapshotCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-accountservice">Mock Object Variable Name: <code>accountService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testCreateFailure() {
<span class="hljs-deletion">-    AccountService accountService = Mockito.mock(AccountService.class);</span>
     Account account = Mockito.mock(Account.class);
<span class="hljs-deletion">-    Mockito.when(accountService.getAccount(anyLong())).thenReturn(account);</span>
<span class="hljs-addition">+    AccountService accountService = mockAccountServiceWithGetAccount(account);</span>
     VolumeApiService volumeApiService = Mockito.mock(VolumeApiService.class);
     try {
         Mockito.when(volumeApiService.takeSnapshot(nullable(Long.class), nullable(Long.class), nullable(Long.class), nullable(Account.class), nullable(Boolean.class), nullable(Snapshot.LocationType.class), nullable(Boolean.class), anyObject())).thenReturn(null);
     } catch (Exception e) {
         Assert.fail("Received exception when success expected " + e.getMessage());
     }
     createSnapshotCmd._accountService = accountService;
     createSnapshotCmd._volumeService = volumeApiService;
     try {
         createSnapshotCmd.execute();
     } catch (ServerApiException exception) {
         Assert.assertEquals("Failed to create snapshot due to an internal error creating snapshot for volume 123", exception.getDescription());
     }
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCreateFailure</span><span class="hljs-params">()</span> </span>{

    AccountService accountService = Mockito.mock(AccountService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Account account = Mockito.mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(accountService.getAccount(anyLong())).thenReturn(account);

    VolumeApiService volumeApiService = Mockito.mock(VolumeApiService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">try</span> {

        Mockito.when(volumeApiService.takeSnapshot(nullable(Long<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">nullable</span>(<span class="hljs-title">Long</span>.<span class="hljs-title">class</span>), <span class="hljs-title">nullable</span>(<span class="hljs-title">Long</span>.<span class="hljs-title">class</span>), <span class="hljs-title">nullable</span>(<span class="hljs-title">Account</span>.<span class="hljs-title">class</span>), <span class="hljs-title">nullable</span>(<span class="hljs-title">Boolean</span>.<span class="hljs-title">class</span>), <span class="hljs-title">nullable</span>(<span class="hljs-title">Snapshot</span>.<span class="hljs-title">LocationType</span>.<span class="hljs-title">class</span>), <span class="hljs-title">nullable</span>(<span class="hljs-title">Boolean</span>.<span class="hljs-title">class</span>), <span class="hljs-title">anyObject</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">null</span>)</span>;

    } <span class="hljs-keyword">catch</span> (Exception e) {

        Assert.fail(<span class="hljs-string">"Received exception when success expected "</span> + e.getMessage());

    }

    createSnapshotCmd._accountService = accountService;

    createSnapshotCmd._volumeService = volumeApiService;

    <span class="hljs-keyword">try</span> {

        createSnapshotCmd.execute();

    } <span class="hljs-keyword">catch</span> (ServerApiException exception) {

        Assert.assertEquals(<span class="hljs-string">"Failed to create snapshot due to an internal error creating snapshot for volume 123"</span>, exception.getDescription());

    }

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci23">Mock Clone Instance #cloudstack_MCI_23</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.cloud.vm.ReservationContext</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> ReservationContext context;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    context = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
<span class="hljs-comment">// Replace all local 'ReservationContext context = mock(ReservationContext.class);' with just 'context' in test methods.</span>
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest231">Test Case ID #cloudstack_Test_23_1</h4>
<h4 id="test-case-name-testfinalizestartwhencmdsanswerisnullfile-cjavaprojectsapachecloudstackpluginsnetwork-elementselastic-loadbalancersrctestjavacomcloudnetworklbelasticloadbalancermanagerimpltestjava">Test Case Name: <code>testFinalizeStartWhenCmdsAnswerIsNull</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\elastic-loadbalancer\src\test\java\com\cloud\network\lb\ElasticLoadBalancerManagerImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-context">Mock Object Variable Name: <code>context</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     VirtualMachineProfile profileMock = mock(VirtualMachineProfile.class);
     long hostId = 1L;
     Commands cmds = mock(Commands.class);
     when(cmds.getAnswer("checkSsh")).thenReturn(null);
<span class="hljs-deletion">-    ReservationContext context = mock(ReservationContext.class);</span>
<span class="hljs-addition">+    ReservationContext context = mock(ReservationContext.class); // No reusable helper available for ReservationContext mock</span>
     boolean expected = false;
     boolean actual = elasticLoadBalancerManagerImpl.finalizeStart(profileMock, hostId, cmds, context);
     assertEquals(expected, actual);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFinalizeStartWhenCmdsAnswerIsNull</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    VirtualMachineProfile profileMock = mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">long</span> hostId = <span class="hljs-number">1L</span>;

    Commands cmds = mock(Commands<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(cmds.getAnswer(<span class="hljs-string">"checkSsh"</span>)).thenReturn(<span class="hljs-keyword">null</span>);

    ReservationContext context = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">boolean</span> expected = <span class="hljs-keyword">false</span>;

    <span class="hljs-keyword">boolean</span> actual = elasticLoadBalancerManagerImpl.finalizeStart(profileMock, hostId, cmds, context);

    assertEquals(expected, actual);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> ReservationContext context;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    context = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
<span class="hljs-comment">// Replace all local 'ReservationContext context = mock(ReservationContext.class);' with just 'context' in test methods.</span>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest232">Test Case ID #cloudstack_Test_23_2</h4>
<h4 id="test-case-name-testfinalizestartwhencmdsanswerisnotnullbutanswerresultisfalsefile-cjavaprojectsapachecloudstackpluginsnetwork-elementselastic-loadbalancersrctestjavacomcloudnetworklbelasticloadbalancermanagerimpltestjava">Test Case Name: <code>testFinalizeStartWhenCmdsAnswerIsNotNullButAnswerResultIsFalse</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\elastic-loadbalancer\src\test\java\com\cloud\network\lb\ElasticLoadBalancerManagerImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-context">Mock Object Variable Name: <code>context</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     when(cmds.getAnswer("checkSsh")).thenReturn(answerMock);
<span class="hljs-deletion">-    ReservationContext context = mock(ReservationContext.class);</span>
<span class="hljs-addition">+    ReservationContext context = mock(ReservationContext.class); // No reusable helper available for ReservationContext mock</span>
     boolean expected = false;
     boolean actual = elasticLoadBalancerManagerImpl.finalizeStart(profileMock, hostId, cmds, context);
     assertEquals(expected, actual);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFinalizeStartWhenCmdsAnswerIsNotNullButAnswerResultIsFalse</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    CheckSshAnswer answerMock = mock(CheckSshAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(answerMock.getResult()).thenReturn(<span class="hljs-keyword">false</span>);

    VirtualMachineProfile profileMock = mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">long</span> hostId = <span class="hljs-number">1L</span>;

    Commands cmds = mock(Commands<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(cmds.getAnswer(<span class="hljs-string">"checkSsh"</span>)).thenReturn(answerMock);

    ReservationContext context = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">boolean</span> expected = <span class="hljs-keyword">false</span>;

    <span class="hljs-keyword">boolean</span> actual = elasticLoadBalancerManagerImpl.finalizeStart(profileMock, hostId, cmds, context);

    assertEquals(expected, actual);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> ReservationContext context;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    context = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
<span class="hljs-comment">// Replace all local 'ReservationContext context = mock(ReservationContext.class);' with just 'context' in test methods.</span>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest233">Test Case ID #cloudstack_Test_23_3</h4>
<h4 id="test-case-name-testfinalizestartwhencmdsanswerisnotnullandanswerresultistruefile-cjavaprojectsapachecloudstackpluginsnetwork-elementselastic-loadbalancersrctestjavacomcloudnetworklbelasticloadbalancermanagerimpltestjava">Test Case Name: <code>testFinalizeStartWhenCmdsAnswerIsNotNullAndAnswerResultIsTrue</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\elastic-loadbalancer\src\test\java\com\cloud\network\lb\ElasticLoadBalancerManagerImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-context">Mock Object Variable Name: <code>context</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     when(cmds.getAnswer("checkSsh")).thenReturn(answerMock);
<span class="hljs-deletion">-    ReservationContext context = mock(ReservationContext.class);</span>
<span class="hljs-addition">+    ReservationContext context = mock(ReservationContext.class); // No reusable helper available for ReservationContext mock</span>
     boolean expected = true;
     boolean actual = elasticLoadBalancerManagerImpl.finalizeStart(profileMock, hostId, cmds, context);
     assertEquals(expected, actual);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFinalizeStartWhenCmdsAnswerIsNotNullAndAnswerResultIsTrue</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    CheckSshAnswer answerMock = mock(CheckSshAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(answerMock.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    VirtualMachineProfile profileMock = mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">long</span> hostId = <span class="hljs-number">1L</span>;

    Commands cmds = mock(Commands<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(cmds.getAnswer(<span class="hljs-string">"checkSsh"</span>)).thenReturn(answerMock);

    ReservationContext context = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">boolean</span> expected = <span class="hljs-keyword">true</span>;

    <span class="hljs-keyword">boolean</span> actual = elasticLoadBalancerManagerImpl.finalizeStart(profileMock, hostId, cmds, context);

    assertEquals(expected, actual);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> ReservationContext context;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    context = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
<span class="hljs-comment">// Replace all local 'ReservationContext context = mock(ReservationContext.class);' with just 'context' in test methods.</span>
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci25">Mock Clone Instance #cloudstack_MCI_25</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.cloud.vm.ReservationContext</code></li>
<li><strong>Test Case Count</strong>: 7</li>
<li><strong>MO Count</strong>: 7</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> ReservationContext reservationContext;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    reservationContext = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest251">Test Case ID #cloudstack_Test_25_1</h4>
<h4 id="test-case-name-testimplementguestnetworkfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenservicetungstenguestnetworkgurutestjava">Test Case Name: <code>testImplementGuestNetwork</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\service\TungstenGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-reservationcontext">Mock Object Variable Name: <code>reservationContext</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testImplementGuestNetwork() {
     final Network network = mock(Network.class);
     final DeployDestination deployDestination = mock(DeployDestination.class);
<span class="hljs-deletion">-    final ReservationContext reservationContext = mock(ReservationContext.class);</span>
     final IPAddressVO ipAddressVO = mock(IPAddressVO.class);
     when(network.getTrafficType()).thenReturn(Networks.TrafficType.Guest);
     when(network.getMode()).thenReturn(Networks.Mode.Dhcp);
     when(network.getGateway()).thenReturn("192.168.1.1");
     when(network.getCidr()).thenReturn("192.168.1.0/24");
     when(network.getBroadcastDomainType()).thenReturn(Networks.BroadcastDomainType.TUNGSTEN);
     when(network.getNetworkOfferingId()).thenReturn(1L);
     when(network.getState()).thenReturn(Network.State.Implementing);
     when(network.getDataCenterId()).thenReturn(2L);
     when(network.getPhysicalNetworkId()).thenReturn(3L);
     when(offering.isRedundantRouter()).thenReturn(false);
     when(offering.getGuestType()).thenReturn(Network.GuestType.Isolated);
     when(tungstenService.getTungstenProjectFqn(network)).thenReturn("default-domain:default-project");
     when(networkModel.getSystemNetworkByZoneAndTrafficType(anyLong(), any())).thenReturn(new NetworkVO());
     when(tungstenFabricUtils.sendTungstenCommand(any(CreateTungstenNetworkCommand.class), anyLong())).thenReturn(new TungstenAnswer(new TungstenCommand(), true, ""));
     when(tungstenFabricUtils.sendTungstenCommand(any(CreateTungstenLogicalRouterCommand.class), anyLong())).thenReturn(new TungstenAnswer(new TungstenCommand(), new LogicalRouter(), true, ""));
     when(tungstenFabricUtils.sendTungstenCommand(any(GetTungstenNatIpCommand.class), anyLong())).thenReturn(new TungstenAnswer(new TungstenCommand(), true, "192.168.1.100"));
     when(ipAddressDao.findByIpAndDcId(anyLong(), anyString())).thenReturn(ipAddressVO);
     when(tungstenService.allocateDnsIpAddress(any(Network.class), any(), anyString())).thenReturn(true);
<span class="hljs-deletion">-    final Network implemented = guru.implement(network, offering, deployDestination, reservationContext);</span>
<span class="hljs-addition">+    final Network implemented = guru.implement(network, offering, deployDestination, reservationContext);</span>
     assertEquals(Networks.BroadcastDomainType.TUNGSTEN.toUri("tf"), implemented.getBroadcastUri());
     assertEquals("192.168.1.1", implemented.getGateway());
     assertEquals("192.168.1.0/24", implemented.getCidr());
     assertEquals(Networks.Mode.Dhcp, implemented.getMode());
     assertEquals(Networks.BroadcastDomainType.TUNGSTEN, implemented.getBroadcastDomainType());
     assertEquals(1L, implemented.getNetworkOfferingId());
     assertEquals(Network.State.Implemented, implemented.getState());
     assertEquals(2L, implemented.getDataCenterId());
     assertEquals(3L, implemented.getPhysicalNetworkId().longValue());
     assertFalse(implemented.isRedundant());
     verify(tungstenFabricUtils, times(1)).sendTungstenCommand(any(CreateTungstenNetworkCommand.class), anyLong());
     verify(tungstenFabricUtils, times(1)).sendTungstenCommand(any(CreateTungstenLogicalRouterCommand.class), anyLong());
     verify(tungstenFabricUtils, times(1)).sendTungstenCommand(any(GetTungstenNatIpCommand.class), anyLong());
     verify(tungstenFabricUtils, times(1)).sendTungstenCommand(any(SetTungstenNetworkGatewayCommand.class), anyLong());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testImplementGuestNetwork</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DeployDestination deployDestination = mock(DeployDestination<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ReservationContext reservationContext = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> IPAddressVO ipAddressVO = mock(IPAddressVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(network.getTrafficType()).thenReturn(Networks.TrafficType.Guest);

    when(network.getMode()).thenReturn(Networks.Mode.Dhcp);

    when(network.getGateway()).thenReturn(<span class="hljs-string">"192.168.1.1"</span>);

    when(network.getCidr()).thenReturn(<span class="hljs-string">"192.168.1.0/24"</span>);

    when(network.getBroadcastDomainType()).thenReturn(Networks.BroadcastDomainType.TUNGSTEN);

    when(network.getNetworkOfferingId()).thenReturn(<span class="hljs-number">1L</span>);

    when(network.getState()).thenReturn(Network.State.Implementing);

    when(network.getDataCenterId()).thenReturn(<span class="hljs-number">2L</span>);

    when(network.getPhysicalNetworkId()).thenReturn(<span class="hljs-number">3L</span>);

    when(offering.isRedundantRouter()).thenReturn(<span class="hljs-keyword">false</span>);

    when(offering.getGuestType()).thenReturn(Network.GuestType.Isolated);

    when(tungstenService.getTungstenProjectFqn(network)).thenReturn(<span class="hljs-string">"default-domain:default-project"</span>);

    when(networkModel.getSystemNetworkByZoneAndTrafficType(anyLong(), any())).thenReturn(<span class="hljs-keyword">new</span> NetworkVO());

    when(tungstenFabricUtils.sendTungstenCommand(any(CreateTungstenNetworkCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">TungstenAnswer</span>(<span class="hljs-title">new</span> <span class="hljs-title">TungstenCommand</span>(), <span class="hljs-title">true</span>, ""))</span>;

    when(tungstenFabricUtils.sendTungstenCommand(any(CreateTungstenLogicalRouterCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">TungstenAnswer</span>(<span class="hljs-title">new</span> <span class="hljs-title">TungstenCommand</span>(), <span class="hljs-title">new</span> <span class="hljs-title">LogicalRouter</span>(), <span class="hljs-title">true</span>, ""))</span>;

    when(tungstenFabricUtils.sendTungstenCommand(any(GetTungstenNatIpCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">TungstenAnswer</span>(<span class="hljs-title">new</span> <span class="hljs-title">TungstenCommand</span>(), <span class="hljs-title">true</span>, "192.168.1.100"))</span>;

    when(ipAddressDao.findByIpAndDcId(anyLong(), anyString())).thenReturn(ipAddressVO);

    when(tungstenService.allocateDnsIpAddress(any(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(), <span class="hljs-title">anyString</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    <span class="hljs-keyword">final</span> Network implemented = guru.implement(network, offering, deployDestination, reservationContext);

    assertEquals(Networks.BroadcastDomainType.TUNGSTEN.toUri(<span class="hljs-string">"tf"</span>), implemented.getBroadcastUri());

    assertEquals(<span class="hljs-string">"192.168.1.1"</span>, implemented.getGateway());

    assertEquals(<span class="hljs-string">"192.168.1.0/24"</span>, implemented.getCidr());

    assertEquals(Networks.Mode.Dhcp, implemented.getMode());

    assertEquals(Networks.BroadcastDomainType.TUNGSTEN, implemented.getBroadcastDomainType());

    assertEquals(<span class="hljs-number">1L</span>, implemented.getNetworkOfferingId());

    assertEquals(Network.State.Implemented, implemented.getState());

    assertEquals(<span class="hljs-number">2L</span>, implemented.getDataCenterId());

    assertEquals(<span class="hljs-number">3L</span>, implemented.getPhysicalNetworkId().longValue());

    assertFalse(implemented.isRedundant());

    verify(tungstenFabricUtils, times(<span class="hljs-number">1</span>)).sendTungstenCommand(any(CreateTungstenNetworkCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())</span>;

    verify(tungstenFabricUtils, times(<span class="hljs-number">1</span>)).sendTungstenCommand(any(CreateTungstenLogicalRouterCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())</span>;

    verify(tungstenFabricUtils, times(<span class="hljs-number">1</span>)).sendTungstenCommand(any(GetTungstenNatIpCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())</span>;

    verify(tungstenFabricUtils, times(<span class="hljs-number">1</span>)).sendTungstenCommand(any(SetTungstenNetworkGatewayCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> ReservationContext reservationContext;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    reservationContext = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest252">Test Case ID #cloudstack_Test_25_2</h4>
<h4 id="test-case-name-testimplementsharednetworkfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenservicetungstenguestnetworkgurutestjava">Test Case Name: <code>testImplementSharedNetwork</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\service\TungstenGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-reservationcontext">Mock Object Variable Name: <code>reservationContext</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testImplementSharedNetwork() {
     final Network network = mock(Network.class);
     final DeployDestination deployDestination = mock(DeployDestination.class);
<span class="hljs-deletion">-    final ReservationContext reservationContext = mock(ReservationContext.class);</span>
     when(network.getTrafficType()).thenReturn(Networks.TrafficType.Guest);
     when(network.getMode()).thenReturn(Networks.Mode.Dhcp);
     when(network.getGateway()).thenReturn("192.168.1.1");
     when(network.getCidr()).thenReturn("192.168.1.0/24");
     when(network.getBroadcastDomainType()).thenReturn(Networks.BroadcastDomainType.TUNGSTEN);
     when(network.getNetworkOfferingId()).thenReturn(1L);
     when(network.getState()).thenReturn(Network.State.Implementing);
     when(network.getDataCenterId()).thenReturn(2L);
     when(network.getPhysicalNetworkId()).thenReturn(3L);
     when(offering.isRedundantRouter()).thenReturn(false);
     when(offering.getGuestType()).thenReturn(Network.GuestType.Shared);
     when(vlanDao.listVlansByNetworkId(anyLong())).thenReturn(List.of(new VlanVO()));
     when(tungstenService.createSharedNetwork(any(Network.class), any(VlanVO.class))).thenReturn(true);
<span class="hljs-deletion">-    final Network implemented = guru.implement(network, offering, deployDestination, reservationContext);</span>
<span class="hljs-addition">+    final Network implemented = guru.implement(network, offering, deployDestination, reservationContext);</span>
     assertEquals(Networks.BroadcastDomainType.TUNGSTEN.toUri("tf"), implemented.getBroadcastUri());
     assertEquals("192.168.1.1", implemented.getGateway());
     assertEquals("192.168.1.0/24", implemented.getCidr());
     assertEquals(Networks.Mode.Dhcp, implemented.getMode());
     assertEquals(Networks.BroadcastDomainType.TUNGSTEN, implemented.getBroadcastDomainType());
     assertEquals(1L, implemented.getNetworkOfferingId());
     assertEquals(Network.State.Implemented, implemented.getState());
     assertEquals(2L, implemented.getDataCenterId());
     assertEquals(3L, implemented.getPhysicalNetworkId().longValue());
     assertFalse(implemented.isRedundant());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testImplementSharedNetwork</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DeployDestination deployDestination = mock(DeployDestination<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ReservationContext reservationContext = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(network.getTrafficType()).thenReturn(Networks.TrafficType.Guest);

    when(network.getMode()).thenReturn(Networks.Mode.Dhcp);

    when(network.getGateway()).thenReturn(<span class="hljs-string">"192.168.1.1"</span>);

    when(network.getCidr()).thenReturn(<span class="hljs-string">"192.168.1.0/24"</span>);

    when(network.getBroadcastDomainType()).thenReturn(Networks.BroadcastDomainType.TUNGSTEN);

    when(network.getNetworkOfferingId()).thenReturn(<span class="hljs-number">1L</span>);

    when(network.getState()).thenReturn(Network.State.Implementing);

    when(network.getDataCenterId()).thenReturn(<span class="hljs-number">2L</span>);

    when(network.getPhysicalNetworkId()).thenReturn(<span class="hljs-number">3L</span>);

    when(offering.isRedundantRouter()).thenReturn(<span class="hljs-keyword">false</span>);

    when(offering.getGuestType()).thenReturn(Network.GuestType.Shared);

    when(vlanDao.listVlansByNetworkId(anyLong())).thenReturn(List.of(<span class="hljs-keyword">new</span> VlanVO()));

    when(tungstenService.createSharedNetwork(any(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">any</span>(<span class="hljs-title">VlanVO</span>.<span class="hljs-title">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">true</span>)</span>;

    <span class="hljs-keyword">final</span> Network implemented = guru.implement(network, offering, deployDestination, reservationContext);

    assertEquals(Networks.BroadcastDomainType.TUNGSTEN.toUri(<span class="hljs-string">"tf"</span>), implemented.getBroadcastUri());

    assertEquals(<span class="hljs-string">"192.168.1.1"</span>, implemented.getGateway());

    assertEquals(<span class="hljs-string">"192.168.1.0/24"</span>, implemented.getCidr());

    assertEquals(Networks.Mode.Dhcp, implemented.getMode());

    assertEquals(Networks.BroadcastDomainType.TUNGSTEN, implemented.getBroadcastDomainType());

    assertEquals(<span class="hljs-number">1L</span>, implemented.getNetworkOfferingId());

    assertEquals(Network.State.Implemented, implemented.getState());

    assertEquals(<span class="hljs-number">2L</span>, implemented.getDataCenterId());

    assertEquals(<span class="hljs-number">3L</span>, implemented.getPhysicalNetworkId().longValue());

    assertFalse(implemented.isRedundant());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> ReservationContext reservationContext;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    reservationContext = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest253">Test Case ID #cloudstack_Test_25_3</h4>
<h4 id="test-case-name-testimplementwithexceptionfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenservicetungstenguestnetworkgurutestjava">Test Case Name: <code>testImplementWithException</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\service\TungstenGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-reservationcontext">Mock Object Variable Name: <code>reservationContext</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test(expected = CloudRuntimeException.class)
 public void testImplementWithException() {
     final Network network = mock(Network.class);
     final DeployDestination deployDestination = mock(DeployDestination.class);
<span class="hljs-deletion">-    final ReservationContext reservationContext = mock(ReservationContext.class);</span>
     when(network.getTrafficType()).thenReturn(Networks.TrafficType.Guest);
     when(network.getMode()).thenReturn(Networks.Mode.Dhcp);
     when(network.getGateway()).thenReturn("192.168.1.1");
     when(network.getCidr()).thenReturn("192.168.1.0/24");
     when(network.getBroadcastDomainType()).thenReturn(Networks.BroadcastDomainType.TUNGSTEN);
     when(network.getState()).thenReturn(Network.State.Implementing);
     when(offering.isRedundantRouter()).thenReturn(false);
     when(offering.getGuestType()).thenReturn(Network.GuestType.Isolated);
     when(tungstenService.getTungstenProjectFqn(any(Network.class))).thenReturn("default-domain:default-project");
     when(networkModel.getSystemNetworkByZoneAndTrafficType(anyLong(), any())).thenReturn(new NetworkVO());
     when(tungstenFabricUtils.sendTungstenCommand(any(CreateTungstenNetworkCommand.class), anyLong())).thenReturn(new TungstenAnswer(new TungstenCommand(), new IOException()));
<span class="hljs-deletion">-    guru.implement(network, offering, deployDestination, reservationContext);</span>
<span class="hljs-addition">+    guru.implement(network, offering, deployDestination, reservationContext);</span>
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>(expected = CloudRuntimeException<span class="hljs-class">.<span class="hljs-keyword">class</span>)

<span class="hljs-title">public</span> <span class="hljs-title">void</span> <span class="hljs-title">testImplementWithException</span>() </span>{

    <span class="hljs-keyword">final</span> Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DeployDestination deployDestination = mock(DeployDestination<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ReservationContext reservationContext = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(network.getTrafficType()).thenReturn(Networks.TrafficType.Guest);

    when(network.getMode()).thenReturn(Networks.Mode.Dhcp);

    when(network.getGateway()).thenReturn(<span class="hljs-string">"192.168.1.1"</span>);

    when(network.getCidr()).thenReturn(<span class="hljs-string">"192.168.1.0/24"</span>);

    when(network.getBroadcastDomainType()).thenReturn(Networks.BroadcastDomainType.TUNGSTEN);

    when(network.getState()).thenReturn(Network.State.Implementing);

    when(offering.isRedundantRouter()).thenReturn(<span class="hljs-keyword">false</span>);

    when(offering.getGuestType()).thenReturn(Network.GuestType.Isolated);

    when(tungstenService.getTungstenProjectFqn(any(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>("<span class="hljs-title">default</span>-<span class="hljs-title">domain</span>:<span class="hljs-title">default</span>-<span class="hljs-title">project</span>")</span>;

    when(networkModel.getSystemNetworkByZoneAndTrafficType(anyLong(), any())).thenReturn(<span class="hljs-keyword">new</span> NetworkVO());

    when(tungstenFabricUtils.sendTungstenCommand(any(CreateTungstenNetworkCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">TungstenAnswer</span>(<span class="hljs-title">new</span> <span class="hljs-title">TungstenCommand</span>(), <span class="hljs-title">new</span> <span class="hljs-title">IOException</span>()))</span>;

    guru.implement(network, offering, deployDestination, reservationContext);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> ReservationContext reservationContext;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    reservationContext = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest254">Test Case ID #cloudstack_Test_25_4</h4>
<h4 id="test-case-name-testreservefile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenservicetungstenguestnetworkgurutestjava">Test Case Name: <code>testReserve</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\service\TungstenGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-context">Mock Object Variable Name: <code>context</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testReserve() throws InsufficientVirtualNetworkCapacityException, InsufficientAddressCapacityException {
     final NicProfile nic = mock(NicProfile.class);
     final Network network = mock(Network.class);
     final VirtualMachineProfile vm = mock(VirtualMachineProfile.class);
     final DeployDestination dest = mock(DeployDestination.class);
<span class="hljs-deletion">-    final ReservationContext context = mock(ReservationContext.class);</span>
     final VMInstanceVO vmInstanceVO = mock(VMInstanceVO.class);
     final HostVO host = mock(HostVO.class);
     when(nic.getReservationStrategy()).thenReturn(Nic.ReservationStrategy.Start);
     when(vm.getType()).thenReturn(VirtualMachine.Type.User);
     when(network.getTrafficType()).thenReturn(Networks.TrafficType.Guest);
     when(vmInstanceDao.findById(anyLong())).thenReturn(vmInstanceVO);
     when(hostDao.findById(anyLong())).thenReturn(host);
<span class="hljs-deletion">-    guru.reserve(nic, network, vm, dest, context);</span>
<span class="hljs-addition">+    guru.reserve(nic, network, vm, dest, reservationContext);</span>
     verify(tungstenFabricUtils, times(1)).sendTungstenCommand(any(CreateTungstenVirtualMachineCommand.class), anyLong());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testReserve</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InsufficientVirtualNetworkCapacityException, InsufficientAddressCapacityException </span>{

    <span class="hljs-keyword">final</span> NicProfile nic = mock(NicProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> VirtualMachineProfile vm = mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DeployDestination dest = mock(DeployDestination<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ReservationContext context = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> VMInstanceVO vmInstanceVO = mock(VMInstanceVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> HostVO host = mock(HostVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(nic.getReservationStrategy()).thenReturn(Nic.ReservationStrategy.Start);

    when(vm.getType()).thenReturn(VirtualMachine.Type.User);

    when(network.getTrafficType()).thenReturn(Networks.TrafficType.Guest);

    when(vmInstanceDao.findById(anyLong())).thenReturn(vmInstanceVO);

    when(hostDao.findById(anyLong())).thenReturn(host);

    guru.reserve(nic, network, vm, dest, context);

    verify(tungstenFabricUtils, times(<span class="hljs-number">1</span>)).sendTungstenCommand(any(CreateTungstenVirtualMachineCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> ReservationContext reservationContext;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    reservationContext = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest255">Test Case ID #cloudstack_Test_25_5</h4>
<h4 id="test-case-name-testpreparemigrationfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenservicetungstenguestnetworkgurutestjava">Test Case Name: <code>testPrepareMigration</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\service\TungstenGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-context">Mock Object Variable Name: <code>context</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testPrepareMigration() {
     final NicProfile nic = mock(NicProfile.class);
     final Network network = mock(Network.class);
     final VirtualMachineProfile vm = mock(VirtualMachineProfile.class);
     final DeployDestination dest = mock(DeployDestination.class);
<span class="hljs-deletion">-    final ReservationContext context = mock(ReservationContext.class);</span>
     final VMInstanceVO vmInstanceVO = mock(VMInstanceVO.class);
     final HostVO hostVO = mock(HostVO.class);
     when(vm.getType()).thenReturn(VirtualMachine.Type.User);
     when(network.getTrafficType()).thenReturn(Networks.TrafficType.Guest);
     when(vmInstanceDao.findById(anyLong())).thenReturn(vmInstanceVO);
     when(hostDao.findById(anyLong())).thenReturn(hostVO);
     when(tungstenFabricUtils.sendTungstenCommand(any(CreateTungstenVirtualMachineCommand.class), anyLong())).thenReturn(new TungstenAnswer(new TungstenCommand(), true, ""));
<span class="hljs-deletion">-    guru.prepareMigration(nic, network, vm, dest, context);</span>
<span class="hljs-addition">+    guru.prepareMigration(nic, network, vm, dest, reservationContext);</span>
     verify(tungstenFabricUtils, times(1)).sendTungstenCommand(any(CreateTungstenVirtualMachineCommand.class), anyLong());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testPrepareMigration</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> NicProfile nic = mock(NicProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> VirtualMachineProfile vm = mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DeployDestination dest = mock(DeployDestination<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ReservationContext context = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> VMInstanceVO vmInstanceVO = mock(VMInstanceVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> HostVO hostVO = mock(HostVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vm.getType()).thenReturn(VirtualMachine.Type.User);

    when(network.getTrafficType()).thenReturn(Networks.TrafficType.Guest);

    when(vmInstanceDao.findById(anyLong())).thenReturn(vmInstanceVO);

    when(hostDao.findById(anyLong())).thenReturn(hostVO);

    when(tungstenFabricUtils.sendTungstenCommand(any(CreateTungstenVirtualMachineCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">TungstenAnswer</span>(<span class="hljs-title">new</span> <span class="hljs-title">TungstenCommand</span>(), <span class="hljs-title">true</span>, ""))</span>;

    guru.prepareMigration(nic, network, vm, dest, context);

    verify(tungstenFabricUtils, times(<span class="hljs-number">1</span>)).sendTungstenCommand(any(CreateTungstenVirtualMachineCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> ReservationContext reservationContext;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    reservationContext = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest256">Test Case ID #cloudstack_Test_25_6</h4>
<h4 id="test-case-name-testrollbackmigrationfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenservicetungstenguestnetworkgurutestjava">Test Case Name: <code>testRollbackMigration</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\service\TungstenGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-context">Mock Object Variable Name: <code>context</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testRollbackMigration() {
     final NicProfile nic = mock(NicProfile.class);
     final Network network = mock(Network.class);
     final VirtualMachineProfile vmProfile = mock(VirtualMachineProfile.class);
<span class="hljs-deletion">-    final ReservationContext context = mock(ReservationContext.class);</span>
     final VirtualMachine vm = mock(VirtualMachine.class);
     final HostVO hostVO = mock(HostVO.class);
     when(vmProfile.getType()).thenReturn(VirtualMachine.Type.User);
     when(vmProfile.getVirtualMachine()).thenReturn(vm);
     when(hostDao.findById(anyLong())).thenReturn(hostVO);
<span class="hljs-deletion">-    guru.rollbackMigration(nic, network, vmProfile, context, context);</span>
<span class="hljs-addition">+    guru.rollbackMigration(nic, network, vmProfile, reservationContext, reservationContext);</span>
     verify(tungstenFabricUtils, times(1)).sendTungstenCommand(any(DeleteTungstenVRouterPortCommand.class), anyLong());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRollbackMigration</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> NicProfile nic = mock(NicProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> VirtualMachineProfile vmProfile = mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ReservationContext context = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> VirtualMachine vm = mock(VirtualMachine<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> HostVO hostVO = mock(HostVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vmProfile.getType()).thenReturn(VirtualMachine.Type.User);

    when(vmProfile.getVirtualMachine()).thenReturn(vm);

    when(hostDao.findById(anyLong())).thenReturn(hostVO);

    guru.rollbackMigration(nic, network, vmProfile, context, context);

    verify(tungstenFabricUtils, times(<span class="hljs-number">1</span>)).sendTungstenCommand(any(DeleteTungstenVRouterPortCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> ReservationContext reservationContext;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    reservationContext = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest257">Test Case ID #cloudstack_Test_25_7</h4>
<h4 id="test-case-name-testcommitmigrationfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenservicetungstenguestnetworkgurutestjava">Test Case Name: <code>testCommitMigration</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\service\TungstenGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-context">Mock Object Variable Name: <code>context</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testCommitMigration() {
     final NicProfile nic = mock(NicProfile.class);
     final Network network = mock(Network.class);
     final VirtualMachineProfile vmProfile = mock(VirtualMachineProfile.class);
<span class="hljs-deletion">-    final ReservationContext context = mock(ReservationContext.class);</span>
     final VirtualMachine vm = mock(VirtualMachine.class);
     final HostVO hostVO = mock(HostVO.class);
     when(vmProfile.getType()).thenReturn(VirtualMachine.Type.User);
     when(vmProfile.getVirtualMachine()).thenReturn(vm);
     when(hostDao.findById(anyLong())).thenReturn(hostVO);
<span class="hljs-deletion">-    guru.commitMigration(nic, network, vmProfile, context, context);</span>
<span class="hljs-addition">+    guru.commitMigration(nic, network, vmProfile, reservationContext, reservationContext);</span>
     verify(tungstenFabricUtils, times(1)).sendTungstenCommand(any(DeleteTungstenVRouterPortCommand.class), anyLong());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCommitMigration</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> NicProfile nic = mock(NicProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> VirtualMachineProfile vmProfile = mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ReservationContext context = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> VirtualMachine vm = mock(VirtualMachine<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> HostVO hostVO = mock(HostVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vmProfile.getType()).thenReturn(VirtualMachine.Type.User);

    when(vmProfile.getVirtualMachine()).thenReturn(vm);

    when(hostDao.findById(anyLong())).thenReturn(hostVO);

    guru.commitMigration(nic, network, vmProfile, context, context);

    verify(tungstenFabricUtils, times(<span class="hljs-number">1</span>)).sendTungstenCommand(any(DeleteTungstenVRouterPortCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> ReservationContext reservationContext;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    reservationContext = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci26">Mock Clone Instance #cloudstack_MCI_26</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>StoragePoolVO</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div>
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest261">Test Case ID #cloudstack_Test_26_1</h4>
<h4 id="test-case-name-testverifylivemigrationmapforkvmmixedmanagedunmagedstoragefile-cjavaprojectsapachecloudstackenginestoragedatamotionsrctestjavaorgapachecloudstackstoragemotionkvmnonmanagedstoragesystemdatamotiontestjava">Test Case Name: <code>testVerifyLiveMigrationMapForKVMMixedManagedUnmagedStorage</code>(File: <code>C:\Java_projects\Apache\cloudstack\engine\storage\datamotion\src\test\java\org\apache\cloudstack\storage\motion\KvmNonManagedStorageSystemDataMotionTest.java</code>)</h4>
<h4 id="mock-object-variable-name-pool1">Mock Object Variable Name: <code>pool1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>LLM is not available for this Test Case
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{

    migrationMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    migrationMap.put(volumeInfo1, dataStore2);

    migrationMap.put(volumeInfo2, dataStore2);

    when(volumeInfo1.getPoolId()).thenReturn(POOL_1_ID);

    when(primaryDataStoreDao.findById(POOL_1_ID)).thenReturn(pool1);

    when(pool1.isManaged()).thenReturn(<span class="hljs-keyword">false</span>);

    when(dataStore2.getId()).thenReturn(POOL_2_ID);

    when(primaryDataStoreDao.findById(POOL_2_ID)).thenReturn(pool2);

    when(pool2.isManaged()).thenReturn(<span class="hljs-keyword">true</span>);

    when(volumeInfo1.getDataStore()).thenReturn(dataStore1);

    when(volumeInfo2.getPoolId()).thenReturn(POOL_1_ID);

    lenient().when(volumeInfo2.getDataStore()).thenReturn(dataStore1);

    lenient().when(dataStore1.getId()).thenReturn(POOL_1_ID);

    when(pool1.getPoolType()).thenReturn(Storage.StoragePoolType.NetworkFilesystem);

    when(pool2.getPoolType()).thenReturn(Storage.StoragePoolType.NetworkFilesystem);

    when(pool2.getScope()).thenReturn(ScopeType.CLUSTER);

    lenient().when(dataStore3.getId()).thenReturn(POOL_3_ID);

    lenient().when(primaryDataStoreDao.findById(POOL_3_ID)).thenReturn(pool3);

    lenient().when(pool3.getPoolType()).thenReturn(Storage.StoragePoolType.NetworkFilesystem);

    lenient().when(pool3.getScope()).thenReturn(ScopeType.CLUSTER);

    when(host1.getId()).thenReturn(HOST_1_ID);

    when(host1.getClusterId()).thenReturn(CLUSTER_ID);

    lenient().when(host1.getHypervisorType()).thenReturn(Hypervisor.HypervisorType.KVM);

    when(host2.getId()).thenReturn(HOST_2_ID);

    when(host2.getClusterId()).thenReturn(CLUSTER_ID);

    lenient().when(host2.getHypervisorType()).thenReturn(Hypervisor.HypervisorType.KVM);

}
<span class="hljs-meta">@Test</span>(expected = CloudRuntimeException<span class="hljs-class">.<span class="hljs-keyword">class</span>)

<span class="hljs-title">public</span> <span class="hljs-title">void</span> <span class="hljs-title">testVerifyLiveMigrationMapForKVMMixedManagedUnmagedStorage</span>() </span>{

    when(pool1.isManaged()).thenReturn(<span class="hljs-keyword">true</span>);

    when(pool1.getId()).thenReturn(POOL_1_ID);

    when(pool2.getId()).thenReturn(POOL_2_ID);

    lenient().when(pool2.isManaged()).thenReturn(<span class="hljs-keyword">false</span>);

    kvmNonManagedStorageDataMotionStrategy.verifyLiveMigrationForKVM(migrationMap, host2);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest262">Test Case ID #cloudstack_Test_26_2</h4>
<h4 id="test-case-name-testcanhandlelivemigrationunmanagedstoragefile-cjavaprojectsapachecloudstackenginestoragedatamotionsrctestjavaorgapachecloudstackstoragemotionkvmnonmanagedstoragesystemdatamotiontestjava">Test Case Name: <code>testCanHandleLiveMigrationUnmanagedStorage</code>(File: <code>C:\Java_projects\Apache\cloudstack\engine\storage\datamotion\src\test\java\org\apache\cloudstack\storage\motion\KvmNonManagedStorageSystemDataMotionTest.java</code>)</h4>
<h4 id="mock-object-variable-name-pool2">Mock Object Variable Name: <code>pool2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>LLM is not available for this Test Case
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCanHandleLiveMigrationUnmanagedStorage</span><span class="hljs-params">()</span> </span>{

    lenient().when(pool2.isManaged()).thenReturn(<span class="hljs-keyword">false</span>);

    StrategyPriority priority = kvmNonManagedStorageDataMotionStrategy.canHandleKVMNonManagedLiveNFSStorageMigration(migrationMap, host1, host2);

    assertEquals(StrategyPriority.HYPERVISOR, priority);

}
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{

    migrationMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    migrationMap.put(volumeInfo1, dataStore2);

    migrationMap.put(volumeInfo2, dataStore2);

    when(volumeInfo1.getPoolId()).thenReturn(POOL_1_ID);

    when(primaryDataStoreDao.findById(POOL_1_ID)).thenReturn(pool1);

    when(pool1.isManaged()).thenReturn(<span class="hljs-keyword">false</span>);

    when(dataStore2.getId()).thenReturn(POOL_2_ID);

    when(primaryDataStoreDao.findById(POOL_2_ID)).thenReturn(pool2);

    when(pool2.isManaged()).thenReturn(<span class="hljs-keyword">true</span>);

    when(volumeInfo1.getDataStore()).thenReturn(dataStore1);

    when(volumeInfo2.getPoolId()).thenReturn(POOL_1_ID);

    lenient().when(volumeInfo2.getDataStore()).thenReturn(dataStore1);

    lenient().when(dataStore1.getId()).thenReturn(POOL_1_ID);

    when(pool1.getPoolType()).thenReturn(Storage.StoragePoolType.NetworkFilesystem);

    when(pool2.getPoolType()).thenReturn(Storage.StoragePoolType.NetworkFilesystem);

    when(pool2.getScope()).thenReturn(ScopeType.CLUSTER);

    lenient().when(dataStore3.getId()).thenReturn(POOL_3_ID);

    lenient().when(primaryDataStoreDao.findById(POOL_3_ID)).thenReturn(pool3);

    lenient().when(pool3.getPoolType()).thenReturn(Storage.StoragePoolType.NetworkFilesystem);

    lenient().when(pool3.getScope()).thenReturn(ScopeType.CLUSTER);

    when(host1.getId()).thenReturn(HOST_1_ID);

    when(host1.getClusterId()).thenReturn(CLUSTER_ID);

    lenient().when(host1.getHypervisorType()).thenReturn(Hypervisor.HypervisorType.KVM);

    when(host2.getId()).thenReturn(HOST_2_ID);

    when(host2.getClusterId()).thenReturn(CLUSTER_ID);

    lenient().when(host2.getHypervisorType()).thenReturn(Hypervisor.HypervisorType.KVM);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest263">Test Case ID #cloudstack_Test_26_3</h4>
<h4 id="test-case-name-testverifylivemigrationmapforkvmmixedmanagedunmagedstoragefile-cjavaprojectsapachecloudstackenginestoragedatamotionsrctestjavaorgapachecloudstackstoragemotionkvmnonmanagedstoragesystemdatamotiontestjava">Test Case Name: <code>testVerifyLiveMigrationMapForKVMMixedManagedUnmagedStorage</code>(File: <code>C:\Java_projects\Apache\cloudstack\engine\storage\datamotion\src\test\java\org\apache\cloudstack\storage\motion\KvmNonManagedStorageSystemDataMotionTest.java</code>)</h4>
<h4 id="mock-object-variable-name-pool2">Mock Object Variable Name: <code>pool2</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>LLM is not available for this Test Case
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{

    migrationMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    migrationMap.put(volumeInfo1, dataStore2);

    migrationMap.put(volumeInfo2, dataStore2);

    when(volumeInfo1.getPoolId()).thenReturn(POOL_1_ID);

    when(primaryDataStoreDao.findById(POOL_1_ID)).thenReturn(pool1);

    when(pool1.isManaged()).thenReturn(<span class="hljs-keyword">false</span>);

    when(dataStore2.getId()).thenReturn(POOL_2_ID);

    when(primaryDataStoreDao.findById(POOL_2_ID)).thenReturn(pool2);

    when(pool2.isManaged()).thenReturn(<span class="hljs-keyword">true</span>);

    when(volumeInfo1.getDataStore()).thenReturn(dataStore1);

    when(volumeInfo2.getPoolId()).thenReturn(POOL_1_ID);

    lenient().when(volumeInfo2.getDataStore()).thenReturn(dataStore1);

    lenient().when(dataStore1.getId()).thenReturn(POOL_1_ID);

    when(pool1.getPoolType()).thenReturn(Storage.StoragePoolType.NetworkFilesystem);

    when(pool2.getPoolType()).thenReturn(Storage.StoragePoolType.NetworkFilesystem);

    when(pool2.getScope()).thenReturn(ScopeType.CLUSTER);

    lenient().when(dataStore3.getId()).thenReturn(POOL_3_ID);

    lenient().when(primaryDataStoreDao.findById(POOL_3_ID)).thenReturn(pool3);

    lenient().when(pool3.getPoolType()).thenReturn(Storage.StoragePoolType.NetworkFilesystem);

    lenient().when(pool3.getScope()).thenReturn(ScopeType.CLUSTER);

    when(host1.getId()).thenReturn(HOST_1_ID);

    when(host1.getClusterId()).thenReturn(CLUSTER_ID);

    lenient().when(host1.getHypervisorType()).thenReturn(Hypervisor.HypervisorType.KVM);

    when(host2.getId()).thenReturn(HOST_2_ID);

    when(host2.getClusterId()).thenReturn(CLUSTER_ID);

    lenient().when(host2.getHypervisorType()).thenReturn(Hypervisor.HypervisorType.KVM);

}
<span class="hljs-meta">@Test</span>(expected = CloudRuntimeException<span class="hljs-class">.<span class="hljs-keyword">class</span>)

<span class="hljs-title">public</span> <span class="hljs-title">void</span> <span class="hljs-title">testVerifyLiveMigrationMapForKVMMixedManagedUnmagedStorage</span>() </span>{

    when(pool1.isManaged()).thenReturn(<span class="hljs-keyword">true</span>);

    when(pool1.getId()).thenReturn(POOL_1_ID);

    when(pool2.getId()).thenReturn(POOL_2_ID);

    lenient().when(pool2.isManaged()).thenReturn(<span class="hljs-keyword">false</span>);

    kvmNonManagedStorageDataMotionStrategy.verifyLiveMigrationForKVM(migrationMap, host2);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci27">Mock Clone Instance #cloudstack_MCI_27</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.cloud.network.router.VirtualRouter</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div>
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest271">Test Case ID #cloudstack_Test_27_1</h4>
<h4 id="test-case-name-testsendcommandstorouterfile-cjavaprojectsapachecloudstackserversrctestjavacomcloudnetworkrouternetworkhelperimpltestjava">Test Case Name: <code>testSendCommandsToRouter</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\network\router\NetworkHelperImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-vr">Mock Object Variable Name: <code>vr</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testSendCommandsToRouter() throws AgentUnavailableException, OperationTimedoutException, ResourceUnavailableException {
     // Prepare
     NetworkHelperImpl nwHelperUT = spy(this.nwHelper);
<span class="hljs-deletion">-    VirtualRouter vr = mock(VirtualRouter.class);</span>
<span class="hljs-deletion">-    when(vr.getHostId()).thenReturn(HOST_ID);</span>
<span class="hljs-addition">+    VirtualRouter vr = createMockVirtualRouterWithHostId(HOST_ID);</span>
     doReturn(true).when(nwHelperUT).checkRouterVersion(vr);
     Commands commands = mock(Commands.class);
     when(commands.size()).thenReturn(3);
     Answer answer1 = mock(Answer.class);
     Answer answer2 = mock(Answer.class);
     Answer answer3 = mock(Answer.class);
     // In the second iteration it should match and return, without invoking the third
     Answer[] answers = { answer1, answer2, answer3 };
     when(answer1.getResult()).thenReturn(true);
     when(answer2.getResult()).thenReturn(false);
     lenient().when(answer3.getResult()).thenReturn(false);
     when(this.agentManager.send(HOST_ID, commands)).thenReturn(answers);
     // Execute
     final boolean result = nwHelperUT.sendCommandsToRouter(vr, commands);
     // Assert
     verify(this.agentManager, times(1)).send(HOST_ID, commands);
     verify(answer1, times(1)).getResult();
     verify(answer2, times(1)).getResult();
     verify(answer3, times(0)).getResult();
     assertFalse(result);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSendCommandsToRouter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> AgentUnavailableException, OperationTimedoutException, ResourceUnavailableException </span>{

    <span class="hljs-comment">// Prepare</span>

    NetworkHelperImpl nwHelperUT = spy(<span class="hljs-keyword">this</span>.nwHelper);

    VirtualRouter vr = mock(VirtualRouter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vr.getHostId()).thenReturn(HOST_ID);

    doReturn(<span class="hljs-keyword">true</span>).when(nwHelperUT).checkRouterVersion(vr);

    Commands commands = mock(Commands<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(commands.size()).thenReturn(<span class="hljs-number">3</span>);

    Answer answer1 = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Answer answer2 = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Answer answer3 = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// In the second iteration it should match and return, without invoking the third</span>

    Answer[] answers = { answer1, answer2, answer3 };

    when(answer1.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(answer2.getResult()).thenReturn(<span class="hljs-keyword">false</span>);

    lenient().when(answer3.getResult()).thenReturn(<span class="hljs-keyword">false</span>);

    when(<span class="hljs-keyword">this</span>.agentManager.send(HOST_ID, commands)).thenReturn(answers);

    <span class="hljs-comment">// Execute</span>

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> result = nwHelperUT.sendCommandsToRouter(vr, commands);

    <span class="hljs-comment">// Assert</span>

    verify(<span class="hljs-keyword">this</span>.agentManager, times(<span class="hljs-number">1</span>)).send(HOST_ID, commands);

    verify(answer1, times(<span class="hljs-number">1</span>)).getResult();

    verify(answer2, times(<span class="hljs-number">1</span>)).getResult();

    verify(answer3, times(<span class="hljs-number">0</span>)).getResult();

    assertFalse(result);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest272">Test Case ID #cloudstack_Test_27_2</h4>
<h4 id="test-case-name-testsendcommandstorouterwithtrueresultfile-cjavaprojectsapachecloudstackserversrctestjavacomcloudnetworkrouternetworkhelperimpltestjava">Test Case Name: <code>testSendCommandsToRouterWithTrueResult</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\network\router\NetworkHelperImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-vr">Mock Object Variable Name: <code>vr</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testSendCommandsToRouterWithTrueResult() throws AgentUnavailableException, OperationTimedoutException, ResourceUnavailableException {
     // Prepare
     NetworkHelperImpl nwHelperUT = spy(this.nwHelper);
<span class="hljs-deletion">-    VirtualRouter vr = mock(VirtualRouter.class);</span>
<span class="hljs-deletion">-    when(vr.getHostId()).thenReturn(HOST_ID);</span>
<span class="hljs-addition">+    VirtualRouter vr = createMockVirtualRouterWithHostId(HOST_ID);</span>
     doReturn(true).when(nwHelperUT).checkRouterVersion(vr);
     Commands commands = mock(Commands.class);
     when(commands.size()).thenReturn(3);
     Answer answer1 = mock(Answer.class);
     Answer answer2 = mock(Answer.class);
     Answer answer3 = mock(Answer.class);
     // In the second iteration it should match and return, without invoking the third
     Answer[] answers = { answer1, answer2, answer3 };
     when(answer1.getResult()).thenReturn(true);
     when(answer2.getResult()).thenReturn(true);
     when(answer3.getResult()).thenReturn(true);
     when(this.agentManager.send(HOST_ID, commands)).thenReturn(answers);
     // Execute
     final boolean result = nwHelperUT.sendCommandsToRouter(vr, commands);
     // Assert
     verify(this.agentManager, times(1)).send(HOST_ID, commands);
     verify(answer1, times(1)).getResult();
     verify(answer2, times(1)).getResult();
     verify(answer3, times(1)).getResult();
     assertTrue(result);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * The only way result can be true is if each and every command receive a true result

 *

 * <span class="hljs-doctag">@throws</span> AgentUnavailableException

 * <span class="hljs-doctag">@throws</span> OperationTimedoutException

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSendCommandsToRouterWithTrueResult</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> AgentUnavailableException, OperationTimedoutException, ResourceUnavailableException </span>{

    <span class="hljs-comment">// Prepare</span>

    NetworkHelperImpl nwHelperUT = spy(<span class="hljs-keyword">this</span>.nwHelper);

    VirtualRouter vr = mock(VirtualRouter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vr.getHostId()).thenReturn(HOST_ID);

    doReturn(<span class="hljs-keyword">true</span>).when(nwHelperUT).checkRouterVersion(vr);

    Commands commands = mock(Commands<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(commands.size()).thenReturn(<span class="hljs-number">3</span>);

    Answer answer1 = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Answer answer2 = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Answer answer3 = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// In the second iteration it should match and return, without invoking the third</span>

    Answer[] answers = { answer1, answer2, answer3 };

    when(answer1.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(answer2.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(answer3.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(<span class="hljs-keyword">this</span>.agentManager.send(HOST_ID, commands)).thenReturn(answers);

    <span class="hljs-comment">// Execute</span>

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> result = nwHelperUT.sendCommandsToRouter(vr, commands);

    <span class="hljs-comment">// Assert</span>

    verify(<span class="hljs-keyword">this</span>.agentManager, times(<span class="hljs-number">1</span>)).send(HOST_ID, commands);

    verify(answer1, times(<span class="hljs-number">1</span>)).getResult();

    verify(answer2, times(<span class="hljs-number">1</span>)).getResult();

    verify(answer3, times(<span class="hljs-number">1</span>)).getResult();

    assertTrue(result);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest273">Test Case ID #cloudstack_Test_27_3</h4>
<h4 id="test-case-name-testsendcommandstorouterwithnoanswersfile-cjavaprojectsapachecloudstackserversrctestjavacomcloudnetworkrouternetworkhelperimpltestjava">Test Case Name: <code>testSendCommandsToRouterWithNoAnswers</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\network\router\NetworkHelperImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-vr">Mock Object Variable Name: <code>vr</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testSendCommandsToRouterWithNoAnswers() throws AgentUnavailableException, OperationTimedoutException, ResourceUnavailableException {
     // Prepare
     NetworkHelperImpl nwHelperUT = spy(this.nwHelper);
<span class="hljs-deletion">-    VirtualRouter vr = mock(VirtualRouter.class);</span>
<span class="hljs-deletion">-    when(vr.getHostId()).thenReturn(HOST_ID);</span>
<span class="hljs-addition">+    VirtualRouter vr = createMockVirtualRouterWithHostId(HOST_ID);</span>
     doReturn(true).when(nwHelperUT).checkRouterVersion(vr);
     Commands commands = mock(Commands.class);
     when(commands.size()).thenReturn(3);
     Answer answer1 = mock(Answer.class);
     Answer answer2 = mock(Answer.class);
     // In the second iteration it should match and return, without invoking the third
     Answer[] answers = { answer1, answer2 };
     when(this.agentManager.send(HOST_ID, commands)).thenReturn(answers);
     // Execute
     final boolean result = nwHelperUT.sendCommandsToRouter(vr, commands);
     // Assert
     verify(this.agentManager, times(1)).send(HOST_ID, commands);
     verify(answer1, times(0)).getResult();
     assertFalse(result);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * If the number of answers is different to the number of commands the result is false

 *

 * <span class="hljs-doctag">@throws</span> AgentUnavailableException

 * <span class="hljs-doctag">@throws</span> OperationTimedoutException

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSendCommandsToRouterWithNoAnswers</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> AgentUnavailableException, OperationTimedoutException, ResourceUnavailableException </span>{

    <span class="hljs-comment">// Prepare</span>

    NetworkHelperImpl nwHelperUT = spy(<span class="hljs-keyword">this</span>.nwHelper);

    VirtualRouter vr = mock(VirtualRouter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vr.getHostId()).thenReturn(HOST_ID);

    doReturn(<span class="hljs-keyword">true</span>).when(nwHelperUT).checkRouterVersion(vr);

    Commands commands = mock(Commands<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(commands.size()).thenReturn(<span class="hljs-number">3</span>);

    Answer answer1 = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Answer answer2 = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// In the second iteration it should match and return, without invoking the third</span>

    Answer[] answers = { answer1, answer2 };

    when(<span class="hljs-keyword">this</span>.agentManager.send(HOST_ID, commands)).thenReturn(answers);

    <span class="hljs-comment">// Execute</span>

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> result = nwHelperUT.sendCommandsToRouter(vr, commands);

    <span class="hljs-comment">// Assert</span>

    verify(<span class="hljs-keyword">this</span>.agentManager, times(<span class="hljs-number">1</span>)).send(HOST_ID, commands);

    verify(answer1, times(<span class="hljs-number">0</span>)).getResult();

    assertFalse(result);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci28">Mock Clone Instance #cloudstack_MCI_28</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.cloudstack.framework.config.ConfigKey&lt;java.lang.Boolean&gt;</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div>
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest281">Test Case ID #cloudstack_Test_28_1</h4>
<h4 id="test-case-name-testdonotskip2facheckforuserwhen2famandatedfile-cjavaprojectsapachecloudstackserversrctestjavacomcloudapiapiservlettestjava">Test Case Name: <code>testDoNotSkip2FAcheckForUserWhen2FAMandated</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\api\ApiServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mandateusertwofactorauthentication">Mock Object Variable Name: <code>mandateUserTwoFactorAuthentication</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     Mockito.when(userAccount.isUser2faEnabled()).thenReturn(false);
<span class="hljs-deletion">-    ConfigKey&lt;Boolean&gt; mandateUserTwoFactorAuthentication = Mockito.mock(ConfigKey.class);</span>
<span class="hljs-deletion">-    AccountManagerImpl.mandateUserTwoFactorAuthentication = mandateUserTwoFactorAuthentication;</span>
<span class="hljs-deletion">-    Mockito.when(mandateUserTwoFactorAuthentication.valueIn(1L)).thenReturn(false);</span>
<span class="hljs-addition">+    ConfigKey&lt;Boolean&gt; mandateUserTwoFactorAuthentication = createMockConfigKeyValueIn(1L, false);</span>
<span class="hljs-addition">+    AccountManagerImpl.mandateUserTwoFactorAuthentication = mandateUserTwoFactorAuthentication;</span>
     boolean result = servlet.skip2FAcheckForUser(cuurentSession);
     Assert.assertEquals(true, result);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDoNotSkip2FAcheckForUserWhen2FAMandated</span><span class="hljs-params">()</span> </span>{

    servlet.accountMgr = accountMgr;

    HttpSession cuurentSession = Mockito.mock(HttpSession<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(cuurentSession.getAttribute(<span class="hljs-string">"userid"</span>)).thenReturn(<span class="hljs-number">1L</span>);

    Mockito.when(cuurentSession.getAttribute(ApiConstants.IS_2FA_VERIFIED)).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(accountMgr.getUserAccountById(<span class="hljs-number">1L</span>)).thenReturn(userAccount);

    Mockito.when(userAccount.getDomainId()).thenReturn(<span class="hljs-number">1L</span>);

    Mockito.when(userAccount.isUser2faEnabled()).thenReturn(<span class="hljs-keyword">false</span>);

    ConfigKey&lt;Boolean&gt; mandateUserTwoFactorAuthentication = Mockito.mock(ConfigKey<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AccountManagerImpl.mandateUserTwoFactorAuthentication = mandateUserTwoFactorAuthentication;

    Mockito.when(mandateUserTwoFactorAuthentication.valueIn(<span class="hljs-number">1L</span>)).thenReturn(<span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">boolean</span> result = servlet.skip2FAcheckForUser(cuurentSession);

    Assert.assertEquals(<span class="hljs-keyword">true</span>, result);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest282">Test Case ID #cloudstack_Test_28_2</h4>
<h4 id="test-case-name-testskip2facheckforuserwhen2faisnotenabledandnotmandatedfile-cjavaprojectsapachecloudstackserversrctestjavacomcloudapiapiservlettestjava">Test Case Name: <code>testSkip2FAcheckForUserWhen2FAisNotEnabledAndNotMandated</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\api\ApiServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-enableusertwofactorauthentication">Mock Object Variable Name: <code>enableUserTwoFactorAuthentication</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     Mockito.when(userAccount.isUser2faEnabled()).thenReturn(false);
<span class="hljs-deletion">-    ConfigKey&lt;Boolean&gt; enableUserTwoFactorAuthentication = Mockito.mock(ConfigKey.class);</span>
<span class="hljs-deletion">-    AccountManagerImpl.enableUserTwoFactorAuthentication = enableUserTwoFactorAuthentication;</span>
<span class="hljs-deletion">-    Mockito.when(enableUserTwoFactorAuthentication.valueIn(1L)).thenReturn(true);</span>
<span class="hljs-addition">+    ConfigKey&lt;Boolean&gt; enableUserTwoFactorAuthentication = createMockConfigKeyValueIn(1L, true);</span>
<span class="hljs-addition">+    AccountManagerImpl.enableUserTwoFactorAuthentication = enableUserTwoFactorAuthentication;</span>
     ConfigKey&lt;Boolean&gt; mandateUserTwoFactorAuthentication = Mockito.mock(ConfigKey.class);
     AccountManagerImpl.mandateUserTwoFactorAuthentication = mandateUserTwoFactorAuthentication;
     Mockito.when(mandateUserTwoFactorAuthentication.valueIn(1L)).thenReturn(true);
     boolean result = servlet.skip2FAcheckForUser(cuurentSession);
     Assert.assertEquals(false, result);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSkip2FAcheckForUserWhen2FAisNotEnabledAndNotMandated</span><span class="hljs-params">()</span> </span>{

    servlet.accountMgr = accountMgr;

    HttpSession cuurentSession = Mockito.mock(HttpSession<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(cuurentSession.getAttribute(<span class="hljs-string">"userid"</span>)).thenReturn(<span class="hljs-number">1L</span>);

    Mockito.when(cuurentSession.getAttribute(ApiConstants.IS_2FA_VERIFIED)).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(accountMgr.getUserAccountById(<span class="hljs-number">1L</span>)).thenReturn(userAccount);

    Mockito.when(userAccount.getDomainId()).thenReturn(<span class="hljs-number">1L</span>);

    Mockito.when(userAccount.isUser2faEnabled()).thenReturn(<span class="hljs-keyword">false</span>);

    ConfigKey&lt;Boolean&gt; enableUserTwoFactorAuthentication = Mockito.mock(ConfigKey<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AccountManagerImpl.enableUserTwoFactorAuthentication = enableUserTwoFactorAuthentication;

    Mockito.when(enableUserTwoFactorAuthentication.valueIn(<span class="hljs-number">1L</span>)).thenReturn(<span class="hljs-keyword">true</span>);

    ConfigKey&lt;Boolean&gt; mandateUserTwoFactorAuthentication = Mockito.mock(ConfigKey<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AccountManagerImpl.mandateUserTwoFactorAuthentication = mandateUserTwoFactorAuthentication;

    Mockito.when(mandateUserTwoFactorAuthentication.valueIn(<span class="hljs-number">1L</span>)).thenReturn(<span class="hljs-keyword">true</span>);

    <span class="hljs-keyword">boolean</span> result = servlet.skip2FAcheckForUser(cuurentSession);

    Assert.assertEquals(<span class="hljs-keyword">false</span>, result);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest283">Test Case ID #cloudstack_Test_28_3</h4>
<h4 id="test-case-name-testskip2facheckforuserwhen2faisnotenabledandnotmandatedfile-cjavaprojectsapachecloudstackserversrctestjavacomcloudapiapiservlettestjava">Test Case Name: <code>testSkip2FAcheckForUserWhen2FAisNotEnabledAndNotMandated</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\api\ApiServletTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mandateusertwofactorauthentication">Mock Object Variable Name: <code>mandateUserTwoFactorAuthentication</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     Mockito.when(userAccount.isUser2faEnabled()).thenReturn(false);
<span class="hljs-deletion">-    ConfigKey&lt;Boolean&gt; enableUserTwoFactorAuthentication = Mockito.mock(ConfigKey.class);</span>
<span class="hljs-deletion">-    AccountManagerImpl.enableUserTwoFactorAuthentication = enableUserTwoFactorAuthentication;</span>
<span class="hljs-deletion">-    Mockito.when(enableUserTwoFactorAuthentication.valueIn(1L)).thenReturn(true);</span>
<span class="hljs-addition">+    ConfigKey&lt;Boolean&gt; enableUserTwoFactorAuthentication = createMockConfigKeyValueIn(1L, true);</span>
<span class="hljs-addition">+    AccountManagerImpl.enableUserTwoFactorAuthentication = enableUserTwoFactorAuthentication;</span>
     ConfigKey&lt;Boolean&gt; mandateUserTwoFactorAuthentication = Mockito.mock(ConfigKey.class);
     AccountManagerImpl.mandateUserTwoFactorAuthentication = mandateUserTwoFactorAuthentication;
     Mockito.when(mandateUserTwoFactorAuthentication.valueIn(1L)).thenReturn(true);
     boolean result = servlet.skip2FAcheckForUser(cuurentSession);
     Assert.assertEquals(false, result);
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSkip2FAcheckForUserWhen2FAisNotEnabledAndNotMandated</span><span class="hljs-params">()</span> </span>{

    servlet.accountMgr = accountMgr;

    HttpSession cuurentSession = Mockito.mock(HttpSession<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(cuurentSession.getAttribute(<span class="hljs-string">"userid"</span>)).thenReturn(<span class="hljs-number">1L</span>);

    Mockito.when(cuurentSession.getAttribute(ApiConstants.IS_2FA_VERIFIED)).thenReturn(<span class="hljs-keyword">false</span>);

    Mockito.when(accountMgr.getUserAccountById(<span class="hljs-number">1L</span>)).thenReturn(userAccount);

    Mockito.when(userAccount.getDomainId()).thenReturn(<span class="hljs-number">1L</span>);

    Mockito.when(userAccount.isUser2faEnabled()).thenReturn(<span class="hljs-keyword">false</span>);

    ConfigKey&lt;Boolean&gt; enableUserTwoFactorAuthentication = Mockito.mock(ConfigKey<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AccountManagerImpl.enableUserTwoFactorAuthentication = enableUserTwoFactorAuthentication;

    Mockito.when(enableUserTwoFactorAuthentication.valueIn(<span class="hljs-number">1L</span>)).thenReturn(<span class="hljs-keyword">true</span>);

    ConfigKey&lt;Boolean&gt; mandateUserTwoFactorAuthentication = Mockito.mock(ConfigKey<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AccountManagerImpl.mandateUserTwoFactorAuthentication = mandateUserTwoFactorAuthentication;

    Mockito.when(mandateUserTwoFactorAuthentication.valueIn(<span class="hljs-number">1L</span>)).thenReturn(<span class="hljs-keyword">true</span>);

    <span class="hljs-keyword">boolean</span> result = servlet.skip2FAcheckForUser(cuurentSession);

    Assert.assertEquals(<span class="hljs-keyword">false</span>, result);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci36">Mock Clone Instance #cloudstack_MCI_36</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.cloud.agent.api.to.DataTO</code></li>
<li><strong>Test Case Count</strong>: 5</li>
<li><strong>MO Count</strong>: 7</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div>
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest361">Test Case ID #cloudstack_Test_36_1</h4>
<h4 id="test-case-name-beforetestfile-cjavaprojectsapachecloudstackpluginshypervisorsxenserversrctestjavacomcloudhypervisorxenservergurutestjava">Test Case Name: <code>beforeTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\hypervisors\xenserver\src\test\java\com\cloud\hypervisor\XenServerGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-sourcedatamock">Mock Object Variable Name: <code>sourceDataMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Before
 public void beforeTest() {
<span class="hljs-deletion">-    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);</span>
     Mockito.when(copyCommandMock.getSrcTO()).thenReturn(sourceDataMock);
     Mockito.when(copyCommandMock.getDestTO()).thenReturn(destinationDataMock);
     Mockito.when(changedHost.getId()).thenReturn(changedHostId);
     Mockito.lenient().when(defaultHost.getId()).thenReturn(defaultHostId);
     Mockito.when(defaultHost.getDataCenterId()).thenReturn(zoneId);
     Mockito.when(hostDaoMock.findById(defaultHostId)).thenReturn(defaultHost);
     Mockito.lenient().when(hostDaoMock.findById(changedHostId)).thenReturn(changedHost);
@@
@@
 @Before
 public void beforeTest() {
<span class="hljs-deletion">-    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);</span>
     Mockito.when(copyCommandMock.getSrcTO()).thenReturn(sourceDataMock);
     Mockito.when(copyCommandMock.getDestTO()).thenReturn(destinationDataMock);
     Mockito.when(changedHost.getId()).thenReturn(changedHostId);
     Mockito.lenient().when(defaultHost.getId()).thenReturn(defaultHostId);
     Mockito.when(defaultHost.getDataCenterId()).thenReturn(zoneId);
     Mockito.when(hostDaoMock.findById(defaultHostId)).thenReturn(defaultHost);
     Mockito.lenient().when(hostDaoMock.findById(changedHostId)).thenReturn(changedHost);
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureSourceHypervisorAsXenServerAndSourceTypeAsSnapshotAndDestinationTypeAsTemplate</span><span class="hljs-params">()</span> </span>{

    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);

    Mockito.when(sourceDataMock.getObjectType()).thenReturn(DataObjectType.SNAPSHOT);

    Mockito.when(destinationDataMock.getObjectType()).thenReturn(DataObjectType.TEMPLATE);

}
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureSourceAndDestinationDataMockDataStoreAsNfsToType</span><span class="hljs-params">()</span> </span>{

    Mockito.when(sourceDataMock.getDataStore()).thenReturn(Mockito.mock(NfsTO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(destinationDataMock.getDataStore()).thenReturn(Mockito.mock(NfsTO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

}
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeTest</span><span class="hljs-params">()</span> </span>{

    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);

    Mockito.when(copyCommandMock.getSrcTO()).thenReturn(sourceDataMock);

    Mockito.when(copyCommandMock.getDestTO()).thenReturn(destinationDataMock);

    Mockito.when(changedHost.getId()).thenReturn(changedHostId);

    Mockito.lenient().when(defaultHost.getId()).thenReturn(defaultHostId);

    Mockito.when(defaultHost.getDataCenterId()).thenReturn(zoneId);

    Mockito.when(hostDaoMock.findById(defaultHostId)).thenReturn(defaultHost);

    Mockito.lenient().when(hostDaoMock.findById(changedHostId)).thenReturn(changedHost);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest362">Test Case ID #cloudstack_Test_36_2</h4>
<h4 id="test-case-name-getcommandhostdelegationtestcommandiscopycommandbutsourcedatahypervisorisnotxenserverfile-cjavaprojectsapachecloudstackpluginshypervisorsxenserversrctestjavacomcloudhypervisorxenservergurutestjava">Test Case Name: <code>getCommandHostDelegationTestCommandIsCopyCommandButSourceDataHypervisorIsNotXenServer</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\hypervisors\xenserver\src\test\java\com\cloud\hypervisor\XenServerGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-sourcedatamock">Mock Object Variable Name: <code>sourceDataMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Before
 public void beforeTest() {
<span class="hljs-deletion">-    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);</span>
     Mockito.when(copyCommandMock.getSrcTO()).thenReturn(sourceDataMock);
     Mockito.when(copyCommandMock.getDestTO()).thenReturn(destinationDataMock);
     Mockito.when(changedHost.getId()).thenReturn(changedHostId);
     Mockito.lenient().when(defaultHost.getId()).thenReturn(defaultHostId);
     Mockito.when(defaultHost.getDataCenterId()).thenReturn(zoneId);
     Mockito.when(hostDaoMock.findById(defaultHostId)).thenReturn(defaultHost);
     Mockito.lenient().when(hostDaoMock.findById(changedHostId)).thenReturn(changedHost);
@@
@@
 @Test
 public void getCommandHostDelegationTestCommandIsCopyCommandButSourceDataHypervisorIsNotXenServer() {
<span class="hljs-deletion">-    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.Any);</span>
<span class="hljs-addition">+    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.Any);</span>
     Pair&lt;Boolean, Long&gt; pairHostToExecuteCommand = xenServerGuru.getCommandHostDelegation(defaultHostId, copyCommandMock);
     assertPairOfHostToExecuteCommandIsTheDefaultHostId(pairHostToExecuteCommand);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureSourceHypervisorAsXenServerAndSourceTypeAsSnapshotAndDestinationTypeAsTemplate</span><span class="hljs-params">()</span> </span>{

    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);

    Mockito.when(sourceDataMock.getObjectType()).thenReturn(DataObjectType.SNAPSHOT);

    Mockito.when(destinationDataMock.getObjectType()).thenReturn(DataObjectType.TEMPLATE);

}
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureSourceAndDestinationDataMockDataStoreAsNfsToType</span><span class="hljs-params">()</span> </span>{

    Mockito.when(sourceDataMock.getDataStore()).thenReturn(Mockito.mock(NfsTO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(destinationDataMock.getDataStore()).thenReturn(Mockito.mock(NfsTO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getCommandHostDelegationTestCommandIsCopyCommandButSourceDataHypervisorIsNotXenServer</span><span class="hljs-params">()</span> </span>{

    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.Any);

    Pair&lt;Boolean, Long&gt; pairHostToExecuteCommand = xenServerGuru.getCommandHostDelegation(defaultHostId, copyCommandMock);

    assertPairOfHostToExecuteCommandIsTheDefaultHostId(pairHostToExecuteCommand);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest363">Test Case ID #cloudstack_Test_36_3</h4>
<h4 id="test-case-name-getcommandhostdelegationtestcommandiscopycommandandsourcedatahypervisorisxenserverbutsourceanddestinationarenotnfsobjectsfile-cjavaprojectsapachecloudstackpluginshypervisorsxenserversrctestjavacomcloudhypervisorxenservergurutestjava">Test Case Name: <code>getCommandHostDelegationTestCommandIsCopyCommandAndSourceDataHypervisorIsXenServerButSourceAndDestinationAreNotNfsObjects</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\hypervisors\xenserver\src\test\java\com\cloud\hypervisor\XenServerGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-sourcedatamock">Mock Object Variable Name: <code>sourceDataMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Before
 public void beforeTest() {
<span class="hljs-deletion">-    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);</span>
     Mockito.when(copyCommandMock.getSrcTO()).thenReturn(sourceDataMock);
     Mockito.when(copyCommandMock.getDestTO()).thenReturn(destinationDataMock);
     Mockito.when(changedHost.getId()).thenReturn(changedHostId);
     Mockito.lenient().when(defaultHost.getId()).thenReturn(defaultHostId);
     Mockito.when(defaultHost.getDataCenterId()).thenReturn(zoneId);
     Mockito.when(hostDaoMock.findById(defaultHostId)).thenReturn(defaultHost);
     Mockito.lenient().when(hostDaoMock.findById(changedHostId)).thenReturn(changedHost);
@@
@@
 @Test
 public void getCommandHostDelegationTestCommandIsCopyCommandAndSourceDataHypervisorIsXenServerButSourceAndDestinationAreNotNfsObjects() {
<span class="hljs-deletion">-    Mockito.when(sourceDataMock.getDataStore()).thenReturn(Mockito.mock(DataStoreTO.class));</span>
<span class="hljs-deletion">-    Mockito.when(destinationDataMock.getDataStore()).thenReturn(Mockito.mock(DataStoreTO.class));</span>
<span class="hljs-deletion">-    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);</span>
<span class="hljs-addition">+    configureDataTOMock(sourceDataMock, Mockito.mock(DataStoreTO.class), null);</span>
<span class="hljs-addition">+    Mockito.when(destinationDataMock.getDataStore()).thenReturn(Mockito.mock(DataStoreTO.class));</span>
<span class="hljs-addition">+    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);</span>
     Pair&lt;Boolean, Long&gt; pairHostToExecuteCommand = xenServerGuru.getCommandHostDelegation(defaultHostId, copyCommandMock);
     assertPairOfHostToExecuteCommandIsTheDefaultHostId(pairHostToExecuteCommand);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureSourceHypervisorAsXenServerAndSourceTypeAsSnapshotAndDestinationTypeAsTemplate</span><span class="hljs-params">()</span> </span>{

    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);

    Mockito.when(sourceDataMock.getObjectType()).thenReturn(DataObjectType.SNAPSHOT);

    Mockito.when(destinationDataMock.getObjectType()).thenReturn(DataObjectType.TEMPLATE);

}
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureSourceAndDestinationDataMockDataStoreAsNfsToType</span><span class="hljs-params">()</span> </span>{

    Mockito.when(sourceDataMock.getDataStore()).thenReturn(Mockito.mock(NfsTO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(destinationDataMock.getDataStore()).thenReturn(Mockito.mock(NfsTO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getCommandHostDelegationTestCommandIsCopyCommandAndSourceDataHypervisorIsXenServerButSourceAndDestinationAreNotNfsObjects</span><span class="hljs-params">()</span> </span>{

    Mockito.when(sourceDataMock.getDataStore()).thenReturn(Mockito.mock(DataStoreTO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(destinationDataMock.getDataStore()).thenReturn(Mockito.mock(DataStoreTO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);

    Pair&lt;Boolean, Long&gt; pairHostToExecuteCommand = xenServerGuru.getCommandHostDelegation(defaultHostId, copyCommandMock);

    assertPairOfHostToExecuteCommandIsTheDefaultHostId(pairHostToExecuteCommand);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest364">Test Case ID #cloudstack_Test_36_4</h4>
<h4 id="test-case-name-getcommandhostdelegationtestcommandiscopycommandandsourcedatahypervisorisxenserverandsourceanddestinationarenfsobjectsbutsourceisnotsnapshottypefile-cjavaprojectsapachecloudstackpluginshypervisorsxenserversrctestjavacomcloudhypervisorxenservergurutestjava">Test Case Name: <code>getCommandHostDelegationTestCommandIsCopyCommandAndSourceDataHypervisorIsXenServerAndSourceAndDestinationAreNfsObjectsButSourceIsNotSnapshotType</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\hypervisors\xenserver\src\test\java\com\cloud\hypervisor\XenServerGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-sourcedatamock">Mock Object Variable Name: <code>sourceDataMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Before
 public void beforeTest() {
<span class="hljs-deletion">-    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);</span>
     Mockito.when(copyCommandMock.getSrcTO()).thenReturn(sourceDataMock);
     Mockito.when(copyCommandMock.getDestTO()).thenReturn(destinationDataMock);
     Mockito.when(changedHost.getId()).thenReturn(changedHostId);
     Mockito.lenient().when(defaultHost.getId()).thenReturn(defaultHostId);
     Mockito.when(defaultHost.getDataCenterId()).thenReturn(zoneId);
     Mockito.when(hostDaoMock.findById(defaultHostId)).thenReturn(defaultHost);
     Mockito.lenient().when(hostDaoMock.findById(changedHostId)).thenReturn(changedHost);
@@
@@
 @Test
 public void getCommandHostDelegationTestCommandIsCopyCommandAndSourceDataHypervisorIsXenServerAndSourceAndDestinationAreNfsObjectsButSourceIsNotSnapshotType() {
     configureSourceAndDestinationDataMockDataStoreAsNfsToType();
<span class="hljs-deletion">-    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);</span>
<span class="hljs-deletion">-    Mockito.when(sourceDataMock.getObjectType()).thenReturn(DataObjectType.VOLUME);</span>
<span class="hljs-addition">+    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);</span>
<span class="hljs-addition">+    Mockito.when(sourceDataMock.getObjectType()).thenReturn(DataObjectType.VOLUME);</span>
     Pair&lt;Boolean, Long&gt; pairHostToExecuteCommand = xenServerGuru.getCommandHostDelegation(defaultHostId, copyCommandMock);
     assertPairOfHostToExecuteCommandIsTheDefaultHostId(pairHostToExecuteCommand);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureSourceHypervisorAsXenServerAndSourceTypeAsSnapshotAndDestinationTypeAsTemplate</span><span class="hljs-params">()</span> </span>{

    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);

    Mockito.when(sourceDataMock.getObjectType()).thenReturn(DataObjectType.SNAPSHOT);

    Mockito.when(destinationDataMock.getObjectType()).thenReturn(DataObjectType.TEMPLATE);

}
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureSourceAndDestinationDataMockDataStoreAsNfsToType</span><span class="hljs-params">()</span> </span>{

    Mockito.when(sourceDataMock.getDataStore()).thenReturn(Mockito.mock(NfsTO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(destinationDataMock.getDataStore()).thenReturn(Mockito.mock(NfsTO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getCommandHostDelegationTestCommandIsCopyCommandAndSourceDataHypervisorIsXenServerAndSourceAndDestinationAreNfsObjectsButSourceIsNotSnapshotType</span><span class="hljs-params">()</span> </span>{

    configureSourceAndDestinationDataMockDataStoreAsNfsToType();

    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);

    Mockito.when(sourceDataMock.getObjectType()).thenReturn(DataObjectType.VOLUME);

    Pair&lt;Boolean, Long&gt; pairHostToExecuteCommand = xenServerGuru.getCommandHostDelegation(defaultHostId, copyCommandMock);

    assertPairOfHostToExecuteCommandIsTheDefaultHostId(pairHostToExecuteCommand);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest365">Test Case ID #cloudstack_Test_36_5</h4>
<h4 id="test-case-name-getcommandhostdelegationtestcommandiscopycommandandsourcedatahypervisorisxenserverandsourceanddestinationarenfsobjectsandsourceissnapshottypebutdestinationisnottemplatetypefile-cjavaprojectsapachecloudstackpluginshypervisorsxenserversrctestjavacomcloudhypervisorxenservergurutestjava">Test Case Name: <code>getCommandHostDelegationTestCommandIsCopyCommandAndSourceDataHypervisorIsXenServerAndSourceAndDestinationAreNfsObjectsAndSourceIsSnapshotTypeButDestinationIsNotTemplateType</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\hypervisors\xenserver\src\test\java\com\cloud\hypervisor\XenServerGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-sourcedatamock">Mock Object Variable Name: <code>sourceDataMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Before
 public void beforeTest() {
<span class="hljs-deletion">-    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);</span>
     Mockito.when(copyCommandMock.getSrcTO()).thenReturn(sourceDataMock);
     Mockito.when(copyCommandMock.getDestTO()).thenReturn(destinationDataMock);
     Mockito.when(changedHost.getId()).thenReturn(changedHostId);
     Mockito.lenient().when(defaultHost.getId()).thenReturn(defaultHostId);
     Mockito.when(defaultHost.getDataCenterId()).thenReturn(zoneId);
     Mockito.when(hostDaoMock.findById(defaultHostId)).thenReturn(defaultHost);
     Mockito.lenient().when(hostDaoMock.findById(changedHostId)).thenReturn(changedHost);
@@
@@
 @Test
 public void getCommandHostDelegationTestCommandIsCopyCommandAndSourceDataHypervisorIsXenServerAndSourceAndDestinationAreNfsObjectsAndSourceIsSnapshotTypeButDestinationIsNotTemplateType() {
     configureSourceAndDestinationDataMockDataStoreAsNfsToType();
<span class="hljs-deletion">-    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);</span>
<span class="hljs-deletion">-    Mockito.when(sourceDataMock.getObjectType()).thenReturn(DataObjectType.SNAPSHOT);</span>
<span class="hljs-deletion">-    Mockito.when(destinationDataMock.getObjectType()).thenReturn(DataObjectType.VOLUME);</span>
<span class="hljs-addition">+    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);</span>
<span class="hljs-addition">+    Mockito.when(sourceDataMock.getObjectType()).thenReturn(DataObjectType.SNAPSHOT);</span>
<span class="hljs-addition">+    Mockito.when(destinationDataMock.getObjectType()).thenReturn(DataObjectType.VOLUME);</span>
     Pair&lt;Boolean, Long&gt; pairHostToExecuteCommand = xenServerGuru.getCommandHostDelegation(defaultHostId, copyCommandMock);
     assertPairOfHostToExecuteCommandIsTheDefaultHostId(pairHostToExecuteCommand);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureSourceHypervisorAsXenServerAndSourceTypeAsSnapshotAndDestinationTypeAsTemplate</span><span class="hljs-params">()</span> </span>{

    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);

    Mockito.when(sourceDataMock.getObjectType()).thenReturn(DataObjectType.SNAPSHOT);

    Mockito.when(destinationDataMock.getObjectType()).thenReturn(DataObjectType.TEMPLATE);

}
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureSourceAndDestinationDataMockDataStoreAsNfsToType</span><span class="hljs-params">()</span> </span>{

    Mockito.when(sourceDataMock.getDataStore()).thenReturn(Mockito.mock(NfsTO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(destinationDataMock.getDataStore()).thenReturn(Mockito.mock(NfsTO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getCommandHostDelegationTestCommandIsCopyCommandAndSourceDataHypervisorIsXenServerAndSourceAndDestinationAreNfsObjectsAndSourceIsSnapshotTypeButDestinationIsNotTemplateType</span><span class="hljs-params">()</span> </span>{

    configureSourceAndDestinationDataMockDataStoreAsNfsToType();

    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);

    Mockito.when(sourceDataMock.getObjectType()).thenReturn(DataObjectType.SNAPSHOT);

    Mockito.when(destinationDataMock.getObjectType()).thenReturn(DataObjectType.VOLUME);

    Pair&lt;Boolean, Long&gt; pairHostToExecuteCommand = xenServerGuru.getCommandHostDelegation(defaultHostId, copyCommandMock);

    assertPairOfHostToExecuteCommandIsTheDefaultHostId(pairHostToExecuteCommand);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest366">Test Case ID #cloudstack_Test_36_6</h4>
<h4 id="test-case-name-getcommandhostdelegationtestcommandiscopycommandandsourcedatahypervisorisxenserverbutsourceanddestinationarenotnfsobjectsfile-cjavaprojectsapachecloudstackpluginshypervisorsxenserversrctestjavacomcloudhypervisorxenservergurutestjava">Test Case Name: <code>getCommandHostDelegationTestCommandIsCopyCommandAndSourceDataHypervisorIsXenServerButSourceAndDestinationAreNotNfsObjects</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\hypervisors\xenserver\src\test\java\com\cloud\hypervisor\XenServerGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-destinationdatamock">Mock Object Variable Name: <code>destinationDataMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Before
 public void beforeTest() {
<span class="hljs-deletion">-    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);</span>
     Mockito.when(copyCommandMock.getSrcTO()).thenReturn(sourceDataMock);
     Mockito.when(copyCommandMock.getDestTO()).thenReturn(destinationDataMock);
     Mockito.when(changedHost.getId()).thenReturn(changedHostId);
     Mockito.lenient().when(defaultHost.getId()).thenReturn(defaultHostId);
     Mockito.when(defaultHost.getDataCenterId()).thenReturn(zoneId);
     Mockito.when(hostDaoMock.findById(defaultHostId)).thenReturn(defaultHost);
     Mockito.lenient().when(hostDaoMock.findById(changedHostId)).thenReturn(changedHost);
@@
@@
 @Test
 public void getCommandHostDelegationTestCommandIsCopyCommandAndSourceDataHypervisorIsXenServerButSourceAndDestinationAreNotNfsObjects() {
<span class="hljs-deletion">-    Mockito.when(sourceDataMock.getDataStore()).thenReturn(Mockito.mock(DataStoreTO.class));</span>
<span class="hljs-deletion">-    Mockito.when(destinationDataMock.getDataStore()).thenReturn(Mockito.mock(DataStoreTO.class));</span>
<span class="hljs-deletion">-    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);</span>
<span class="hljs-addition">+    configureDataTOMock(sourceDataMock, Mockito.mock(DataStoreTO.class), null);</span>
<span class="hljs-addition">+    Mockito.when(destinationDataMock.getDataStore()).thenReturn(Mockito.mock(DataStoreTO.class));</span>
<span class="hljs-addition">+    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);</span>
     Pair&lt;Boolean, Long&gt; pairHostToExecuteCommand = xenServerGuru.getCommandHostDelegation(defaultHostId, copyCommandMock);
     assertPairOfHostToExecuteCommandIsTheDefaultHostId(pairHostToExecuteCommand);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureSourceHypervisorAsXenServerAndSourceTypeAsSnapshotAndDestinationTypeAsTemplate</span><span class="hljs-params">()</span> </span>{

    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);

    Mockito.when(sourceDataMock.getObjectType()).thenReturn(DataObjectType.SNAPSHOT);

    Mockito.when(destinationDataMock.getObjectType()).thenReturn(DataObjectType.TEMPLATE);

}
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureSourceAndDestinationDataMockDataStoreAsNfsToType</span><span class="hljs-params">()</span> </span>{

    Mockito.when(sourceDataMock.getDataStore()).thenReturn(Mockito.mock(NfsTO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(destinationDataMock.getDataStore()).thenReturn(Mockito.mock(NfsTO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getCommandHostDelegationTestCommandIsCopyCommandAndSourceDataHypervisorIsXenServerButSourceAndDestinationAreNotNfsObjects</span><span class="hljs-params">()</span> </span>{

    Mockito.when(sourceDataMock.getDataStore()).thenReturn(Mockito.mock(DataStoreTO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(destinationDataMock.getDataStore()).thenReturn(Mockito.mock(DataStoreTO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);

    Pair&lt;Boolean, Long&gt; pairHostToExecuteCommand = xenServerGuru.getCommandHostDelegation(defaultHostId, copyCommandMock);

    assertPairOfHostToExecuteCommandIsTheDefaultHostId(pairHostToExecuteCommand);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest367">Test Case ID #cloudstack_Test_36_7</h4>
<h4 id="test-case-name-getcommandhostdelegationtestcommandiscopycommandandsourcedatahypervisorisxenserverandsourceanddestinationarenfsobjectsandsourceissnapshottypebutdestinationisnottemplatetypefile-cjavaprojectsapachecloudstackpluginshypervisorsxenserversrctestjavacomcloudhypervisorxenservergurutestjava">Test Case Name: <code>getCommandHostDelegationTestCommandIsCopyCommandAndSourceDataHypervisorIsXenServerAndSourceAndDestinationAreNfsObjectsAndSourceIsSnapshotTypeButDestinationIsNotTemplateType</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\hypervisors\xenserver\src\test\java\com\cloud\hypervisor\XenServerGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-destinationdatamock">Mock Object Variable Name: <code>destinationDataMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>@@
 @Before
 public void beforeTest() {
<span class="hljs-deletion">-    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);</span>
     Mockito.when(copyCommandMock.getSrcTO()).thenReturn(sourceDataMock);
     Mockito.when(copyCommandMock.getDestTO()).thenReturn(destinationDataMock);
     Mockito.when(changedHost.getId()).thenReturn(changedHostId);
     Mockito.lenient().when(defaultHost.getId()).thenReturn(defaultHostId);
     Mockito.when(defaultHost.getDataCenterId()).thenReturn(zoneId);
     Mockito.when(hostDaoMock.findById(defaultHostId)).thenReturn(defaultHost);
     Mockito.lenient().when(hostDaoMock.findById(changedHostId)).thenReturn(changedHost);
@@
@@
 @Test
 public void getCommandHostDelegationTestCommandIsCopyCommandAndSourceDataHypervisorIsXenServerAndSourceAndDestinationAreNfsObjectsAndSourceIsSnapshotTypeButDestinationIsNotTemplateType() {
     configureSourceAndDestinationDataMockDataStoreAsNfsToType();
<span class="hljs-deletion">-    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);</span>
<span class="hljs-deletion">-    Mockito.when(sourceDataMock.getObjectType()).thenReturn(DataObjectType.SNAPSHOT);</span>
<span class="hljs-deletion">-    Mockito.when(destinationDataMock.getObjectType()).thenReturn(DataObjectType.VOLUME);</span>
<span class="hljs-addition">+    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);</span>
<span class="hljs-addition">+    Mockito.when(sourceDataMock.getObjectType()).thenReturn(DataObjectType.SNAPSHOT);</span>
<span class="hljs-addition">+    Mockito.when(destinationDataMock.getObjectType()).thenReturn(DataObjectType.VOLUME);</span>
     Pair&lt;Boolean, Long&gt; pairHostToExecuteCommand = xenServerGuru.getCommandHostDelegation(defaultHostId, copyCommandMock);
     assertPairOfHostToExecuteCommandIsTheDefaultHostId(pairHostToExecuteCommand);
 }
@@
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureSourceHypervisorAsXenServerAndSourceTypeAsSnapshotAndDestinationTypeAsTemplate</span><span class="hljs-params">()</span> </span>{

    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);

    Mockito.when(sourceDataMock.getObjectType()).thenReturn(DataObjectType.SNAPSHOT);

    Mockito.when(destinationDataMock.getObjectType()).thenReturn(DataObjectType.TEMPLATE);

}
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureSourceAndDestinationDataMockDataStoreAsNfsToType</span><span class="hljs-params">()</span> </span>{

    Mockito.when(sourceDataMock.getDataStore()).thenReturn(Mockito.mock(NfsTO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    Mockito.when(destinationDataMock.getDataStore()).thenReturn(Mockito.mock(NfsTO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getCommandHostDelegationTestCommandIsCopyCommandAndSourceDataHypervisorIsXenServerAndSourceAndDestinationAreNfsObjectsAndSourceIsSnapshotTypeButDestinationIsNotTemplateType</span><span class="hljs-params">()</span> </span>{

    configureSourceAndDestinationDataMockDataStoreAsNfsToType();

    Mockito.when(sourceDataMock.getHypervisorType()).thenReturn(HypervisorType.XenServer);

    Mockito.when(sourceDataMock.getObjectType()).thenReturn(DataObjectType.SNAPSHOT);

    Mockito.when(destinationDataMock.getObjectType()).thenReturn(DataObjectType.VOLUME);

    Pair&lt;Boolean, Long&gt; pairHostToExecuteCommand = xenServerGuru.getCommandHostDelegation(defaultHostId, copyCommandMock);

    assertPairOfHostToExecuteCommandIsTheDefaultHostId(pairHostToExecuteCommand);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci37">Mock Clone Instance #cloudstack_MCI_37</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.cloud.agent.api.to.DataTO</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DataTO <span class="hljs-title">createMockDataTOWithHypervisorType</span><span class="hljs-params">(HypervisorType hypervisorType)</span> </span>{
    DataTO dataTO = Mockito.mock(DataTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(dataTO.getHypervisorType()).thenReturn(hypervisorType);
    <span class="hljs-keyword">return</span> dataTO;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest371">Test Case ID #cloudstack_Test_37_1</h4>
<h4 id="test-case-name-getcommandhostdelegationtestcommandisstoragesubsystemcommandfile-cjavaprojectsapachecloudstackpluginshypervisorsxenserversrctestjavacomcloudhypervisorxenservergurutestjava">Test Case Name: <code>getCommandHostDelegationTestCommandIsStorageSubSystemCommand</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\hypervisors\xenserver\src\test\java\com\cloud\hypervisor\XenServerGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-srcdata">Mock Object Variable Name: <code>srcData</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void getCommandHostDelegationTestCommandIsStorageSubSystemCommand() {
     CopyCommand copyCommand = Mockito.mock(CopyCommand.class);
<span class="hljs-deletion">-    DataTO srcData = Mockito.mock(DataTO.class);</span>
<span class="hljs-addition">+    DataTO srcData = mockSrcDataWithHypervisorType(HypervisorType.XenServer);</span>
     DataTO dstData = Mockito.mock(DataTO.class);
     Mockito.when(copyCommand.getSrcTO()).thenReturn(srcData);
     Mockito.when(copyCommand.getDestTO()).thenReturn(dstData);
<span class="hljs-deletion">-    Mockito.when(srcData.getHypervisorType()).thenReturn(HypervisorType.XenServer);</span>
     Pair&lt;Boolean, Long&gt; pairHostToExecuteCommand = xenServerGuru.getCommandHostDelegation(defaultHostId, copyCommand);
     assertPairOfHostToExecuteCommandIsTheDefaultHostId(pairHostToExecuteCommand);
     Mockito.verify(copyCommand).setExecuteInSequence(true);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getCommandHostDelegationTestCommandIsStorageSubSystemCommand</span><span class="hljs-params">()</span> </span>{

    CopyCommand copyCommand = Mockito.mock(CopyCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DataTO srcData = Mockito.mock(DataTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DataTO dstData = Mockito.mock(DataTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(copyCommand.getSrcTO()).thenReturn(srcData);

    Mockito.when(copyCommand.getDestTO()).thenReturn(dstData);

    Mockito.when(srcData.getHypervisorType()).thenReturn(HypervisorType.XenServer);

    Pair&lt;Boolean, Long&gt; pairHostToExecuteCommand = xenServerGuru.getCommandHostDelegation(defaultHostId, copyCommand);

    assertPairOfHostToExecuteCommandIsTheDefaultHostId(pairHostToExecuteCommand);

    Mockito.verify(copyCommand).setExecuteInSequence(<span class="hljs-keyword">true</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DataTO <span class="hljs-title">createMockDataTOWithHypervisorType</span><span class="hljs-params">(HypervisorType hypervisorType)</span> </span>{
    DataTO dataTO = Mockito.mock(DataTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(dataTO.getHypervisorType()).thenReturn(hypervisorType);
    <span class="hljs-keyword">return</span> dataTO;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest372">Test Case ID #cloudstack_Test_37_2</h4>
<h4 id="test-case-name-getcommandhostdelegationtestcommandisnotforxenhypervisorfile-cjavaprojectsapachecloudstackpluginshypervisorsxenserversrctestjavacomcloudhypervisorxenservergurutestjava">Test Case Name: <code>getCommandHostDelegationTestCommandIsNotForXenHypervisor</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\hypervisors\xenserver\src\test\java\com\cloud\hypervisor\XenServerGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-srcdata">Mock Object Variable Name: <code>srcData</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void getCommandHostDelegationTestCommandIsNotForXenHypervisor() {
     CopyCommand copyCommand = Mockito.mock(CopyCommand.class);
<span class="hljs-deletion">-    DataTO srcData = Mockito.mock(DataTO.class);</span>
<span class="hljs-addition">+    DataTO srcData = mockSrcDataWithHypervisorType(HypervisorType.Any);</span>
     Mockito.when(copyCommand.getSrcTO()).thenReturn(srcData);
<span class="hljs-deletion">-    Mockito.when(srcData.getHypervisorType()).thenReturn(HypervisorType.Any);</span>
     Pair&lt;Boolean, Long&gt; pairHostToExecuteCommand = xenServerGuru.getCommandHostDelegation(defaultHostId, copyCommand);
     assertPairOfHostToExecuteCommandIsTheDefaultHostId(pairHostToExecuteCommand);
     Mockito.verify(copyCommand, times(0)).setExecuteInSequence(true);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getCommandHostDelegationTestCommandIsNotForXenHypervisor</span><span class="hljs-params">()</span> </span>{

    CopyCommand copyCommand = Mockito.mock(CopyCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DataTO srcData = Mockito.mock(DataTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(copyCommand.getSrcTO()).thenReturn(srcData);

    Mockito.when(srcData.getHypervisorType()).thenReturn(HypervisorType.Any);

    Pair&lt;Boolean, Long&gt; pairHostToExecuteCommand = xenServerGuru.getCommandHostDelegation(defaultHostId, copyCommand);

    assertPairOfHostToExecuteCommandIsTheDefaultHostId(pairHostToExecuteCommand);

    Mockito.verify(copyCommand, times(<span class="hljs-number">0</span>)).setExecuteInSequence(<span class="hljs-keyword">true</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DataTO <span class="hljs-title">createMockDataTOWithHypervisorType</span><span class="hljs-params">(HypervisorType hypervisorType)</span> </span>{
    DataTO dataTO = Mockito.mock(DataTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(dataTO.getHypervisorType()).thenReturn(hypervisorType);
    <span class="hljs-keyword">return</span> dataTO;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci38">Mock Clone Instance #cloudstack_MCI_38</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.cloud.network.Network</code></li>
<li><strong>Test Case Count</strong>: 7</li>
<li><strong>MO Count</strong>: 7</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div>
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest381">Test Case ID #cloudstack_Test_38_1</h4>
<h4 id="test-case-name-validatecidrstestvalidcidrsfile-cjavaprojectsapachecloudstackapisrctestjavaorgapachecloudstackapicommanduserfirewallcreateegressfirewallrulecmdtestjava">Test Case Name: <code>validateCidrsTestValidCidrs</code>(File: <code>C:\Java_projects\Apache\cloudstack\api\src\test\java\org\apache\cloudstack\api\command\user\firewall\CreateEgressFirewallRuleCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-networkmock">Mock Object Variable Name: <code>networkMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     Mockito.doReturn(networkIdMock).when(cmdMock).getNetworkId();
<span class="hljs-deletion">-    Network networkMock = Mockito.mock(Network.class);</span>
<span class="hljs-deletion">-    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);</span>
<span class="hljs-deletion">-    Mockito.doReturn(cidrMock).when(networkMock).getCidr();</span>
<span class="hljs-addition">+    Network networkMock = Mockito.mock(Network.class);</span>
<span class="hljs-addition">+    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);</span>
<span class="hljs-addition">+    Mockito.doReturn(cidrMock).when(networkMock).getCidr();</span>
     PowerMockito.mockStatic(NetUtils.class);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">validateCidrsTestValidCidrs</span><span class="hljs-params">()</span> </span>{

    ArrayList&lt;String&gt; listMock = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    String cidrMock = <span class="hljs-string">"10.1.1.0/24"</span>;

    listMock.add(cidrMock);

    cmdMock.setSourceCidrList(listMock);

    cmdMock.setDestCidrList(listMock);

    <span class="hljs-keyword">long</span> networkIdMock = <span class="hljs-number">1234</span>;

    Mockito.doReturn(networkIdMock).when(cmdMock).getNetworkId();

    Network networkMock = Mockito.mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);

    Mockito.doReturn(cidrMock).when(networkMock).getCidr();

    PowerMockito.mockStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    PowerMockito.when(NetUtils.isValidIp4Cidr(cidrMock)).thenReturn(<span class="hljs-keyword">true</span>);

    PowerMockito.when(NetUtils.isValidIp6Cidr(cidrMock)).thenReturn(<span class="hljs-keyword">false</span>);

    PowerMockito.when(NetUtils.isNetworkAWithinNetworkB(cidrMock, cidrMock)).thenReturn(<span class="hljs-keyword">true</span>);

    cmdMock.validateCidrs();

    Mockito.verify(cmdMock, Mockito.atLeast(<span class="hljs-number">2</span>)).getSourceCidrList();

    Mockito.verify(cmdMock).getNetworkId();

    Mockito.verify(networkServiceMock).getNetwork(networkIdMock);

    Mockito.verify(networkMock).getCidr();

    PowerMockito.verifyStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">times</span>(2))</span>;

    NetUtils.isValidIp4Cidr(cidrMock);

    NetUtils.isValidIp6Cidr(cidrMock);

    PowerMockito.verifyStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    NetUtils.isNetworkAWithinNetworkB(cidrMock, cidrMock);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest382">Test Case ID #cloudstack_Test_38_2</h4>
<h4 id="test-case-name-validatecidrstestcidrsbeginningwithwhitespacefile-cjavaprojectsapachecloudstackapisrctestjavaorgapachecloudstackapicommanduserfirewallcreateegressfirewallrulecmdtestjava">Test Case Name: <code>validateCidrsTestCidrsBeginningWithWhiteSpace</code>(File: <code>C:\Java_projects\Apache\cloudstack\api\src\test\java\org\apache\cloudstack\api\command\user\firewall\CreateEgressFirewallRuleCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-networkmock">Mock Object Variable Name: <code>networkMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     Mockito.doReturn(networkIdMock).when(cmdMock).getNetworkId();
<span class="hljs-deletion">-    Network networkMock = Mockito.mock(Network.class);</span>
<span class="hljs-deletion">-    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);</span>
<span class="hljs-deletion">-    Mockito.doReturn("10.1.1.0/24").when(networkMock).getCidr();</span>
<span class="hljs-addition">+    Network networkMock = Mockito.mock(Network.class);</span>
<span class="hljs-addition">+    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);</span>
<span class="hljs-addition">+    Mockito.doReturn("10.1.1.0/24").when(networkMock).getCidr();</span>
     PowerMockito.mockStatic(NetUtils.class);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">validateCidrsTestCidrsBeginningWithWhiteSpace</span><span class="hljs-params">()</span> </span>{

    ArrayList&lt;String&gt; listMock = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    String cidrMock = <span class="hljs-string">"  10.1.1.0/24"</span>;

    listMock.add(cidrMock);

    cmdMock.setSourceCidrList(listMock);

    cmdMock.setDestCidrList(listMock);

    <span class="hljs-keyword">long</span> networkIdMock = <span class="hljs-number">1234</span>;

    Mockito.doReturn(networkIdMock).when(cmdMock).getNetworkId();

    Network networkMock = Mockito.mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);

    Mockito.doReturn(<span class="hljs-string">"10.1.1.0/24"</span>).when(networkMock).getCidr();

    PowerMockito.mockStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    PowerMockito.when(NetUtils.isValidIp4Cidr(Mockito.eq(<span class="hljs-string">"10.1.1.0/24"</span>))).thenReturn(<span class="hljs-keyword">true</span>);

    PowerMockito.when(NetUtils.isValidIp6Cidr(Mockito.eq(<span class="hljs-string">"10.1.1.0/24"</span>))).thenReturn(<span class="hljs-keyword">false</span>);

    PowerMockito.when(NetUtils.isNetworkAWithinNetworkB(Mockito.eq(<span class="hljs-string">"10.1.1.0/24"</span>), Mockito.eq(<span class="hljs-string">"10.1.1.0/24"</span>))).thenReturn(<span class="hljs-keyword">true</span>);

    cmdMock.validateCidrs();

    Mockito.verify(cmdMock, Mockito.atLeast(<span class="hljs-number">2</span>)).getSourceCidrList();

    Mockito.verify(cmdMock).getNetworkId();

    Mockito.verify(networkServiceMock).getNetwork(networkIdMock);

    Mockito.verify(networkMock).getCidr();

    PowerMockito.verifyStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">times</span>(2))</span>;

    NetUtils.isValidIp4Cidr(Mockito.eq(<span class="hljs-string">"10.1.1.0/24"</span>));

    NetUtils.isValidIp6Cidr(Mockito.eq(<span class="hljs-string">"10.1.1.0/24"</span>));

    PowerMockito.verifyStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    NetUtils.isNetworkAWithinNetworkB(Mockito.eq(<span class="hljs-string">"10.1.1.0/24"</span>), Mockito.eq(<span class="hljs-string">"10.1.1.0/24"</span>));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest383">Test Case ID #cloudstack_Test_38_3</h4>
<h4 id="test-case-name-validatecidrstestinvalidsourcecidrfile-cjavaprojectsapachecloudstackapisrctestjavaorgapachecloudstackapicommanduserfirewallcreateegressfirewallrulecmdtestjava">Test Case Name: <code>validateCidrsTestInvalidSourceCidr</code>(File: <code>C:\Java_projects\Apache\cloudstack\api\src\test\java\org\apache\cloudstack\api\command\user\firewall\CreateEgressFirewallRuleCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-networkmock">Mock Object Variable Name: <code>networkMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     Mockito.doReturn(networkIdMock).when(cmdMock).getNetworkId();
<span class="hljs-deletion">-    Network networkMock = Mockito.mock(Network.class);</span>
<span class="hljs-deletion">-    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);</span>
<span class="hljs-deletion">-    Mockito.doReturn("10.1.1.0/24").when(networkMock).getCidr();</span>
<span class="hljs-addition">+    Network networkMock = Mockito.mock(Network.class);</span>
<span class="hljs-addition">+    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);</span>
<span class="hljs-addition">+    Mockito.doReturn("10.1.1.0/24").when(networkMock).getCidr();</span>
     PowerMockito.mockStatic(NetUtils.class);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>(expected = ServerApiException<span class="hljs-class">.<span class="hljs-keyword">class</span>)

<span class="hljs-title">public</span> <span class="hljs-title">void</span> <span class="hljs-title">validateCidrsTestInvalidSourceCidr</span>() </span>{

    ArrayList&lt;String&gt; listMock = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    String sourceCidrMock = <span class="hljs-string">"aaaa"</span>;

    listMock.add(sourceCidrMock);

    cmdMock.setSourceCidrList(listMock);

    cmdMock.setDestCidrList(listMock);

    <span class="hljs-keyword">long</span> networkIdMock = <span class="hljs-number">1234</span>;

    Mockito.doReturn(networkIdMock).when(cmdMock).getNetworkId();

    Network networkMock = Mockito.mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);

    Mockito.doReturn(<span class="hljs-string">"10.1.1.0/24"</span>).when(networkMock).getCidr();

    PowerMockito.mockStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    PowerMockito.when(NetUtils.isValidIp4Cidr(sourceCidrMock)).thenReturn(<span class="hljs-keyword">false</span>);

    PowerMockito.when(NetUtils.isValidIp6Cidr(sourceCidrMock)).thenReturn(<span class="hljs-keyword">false</span>);

    cmdMock.validateCidrs();

    Mockito.verify(cmdMock, Mockito.atLeast(<span class="hljs-number">2</span>)).getSourceCidrList();

    Mockito.verify(cmdMock).getNetworkId();

    Mockito.verify(networkServiceMock).getNetwork(networkIdMock);

    Mockito.verify(networkMock).getCidr();

    PowerMockito.verifyStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">times</span>(1))</span>;

    NetUtils.isValidIp4Cidr(sourceCidrMock);

    NetUtils.isValidIp6Cidr(sourceCidrMock);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest384">Test Case ID #cloudstack_Test_38_4</h4>
<h4 id="test-case-name-validatecidrstestinvaliddestinationcidrfile-cjavaprojectsapachecloudstackapisrctestjavaorgapachecloudstackapicommanduserfirewallcreateegressfirewallrulecmdtestjava">Test Case Name: <code>validateCidrsTestInvalidDestinationCidr</code>(File: <code>C:\Java_projects\Apache\cloudstack\api\src\test\java\org\apache\cloudstack\api\command\user\firewall\CreateEgressFirewallRuleCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-networkmock">Mock Object Variable Name: <code>networkMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     Mockito.doReturn(networkIdMock).when(cmdMock).getNetworkId();
<span class="hljs-deletion">-    Network networkMock = Mockito.mock(Network.class);</span>
<span class="hljs-deletion">-    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);</span>
<span class="hljs-deletion">-    Mockito.doReturn(sourceCidrMock).when(networkMock).getCidr();</span>
<span class="hljs-addition">+    Network networkMock = Mockito.mock(Network.class);</span>
<span class="hljs-addition">+    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);</span>
<span class="hljs-addition">+    Mockito.doReturn(sourceCidrMock).when(networkMock).getCidr();</span>
     PowerMockito.mockStatic(NetUtils.class);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>(expected = ServerApiException<span class="hljs-class">.<span class="hljs-keyword">class</span>)

<span class="hljs-title">public</span> <span class="hljs-title">void</span> <span class="hljs-title">validateCidrsTestInvalidDestinationCidr</span>() </span>{

    ArrayList&lt;String&gt; listSourceMock = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    String sourceCidrMock = <span class="hljs-string">"10.1.1.0/24"</span>;

    listSourceMock.add(sourceCidrMock);

    cmdMock.setSourceCidrList(listSourceMock);

    ArrayList&lt;String&gt; listDestMock = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    String destCidrMock = <span class="hljs-string">"aaaa"</span>;

    listDestMock.add(destCidrMock);

    cmdMock.setDestCidrList(listDestMock);

    <span class="hljs-keyword">long</span> networkIdMock = <span class="hljs-number">1234</span>;

    Mockito.doReturn(networkIdMock).when(cmdMock).getNetworkId();

    Network networkMock = Mockito.mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);

    Mockito.doReturn(sourceCidrMock).when(networkMock).getCidr();

    PowerMockito.mockStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    PowerMockito.when(NetUtils.isValidIp4Cidr(Mockito.eq(sourceCidrMock))).thenReturn(<span class="hljs-keyword">true</span>);

    PowerMockito.when(NetUtils.isValidIp6Cidr(Mockito.eq(sourceCidrMock))).thenReturn(<span class="hljs-keyword">false</span>);

    PowerMockito.when(NetUtils.isNetworkAWithinNetworkB(sourceCidrMock, sourceCidrMock)).thenReturn(<span class="hljs-keyword">true</span>);

    PowerMockito.when(NetUtils.isValidIp4Cidr(Mockito.eq(destCidrMock))).thenReturn(<span class="hljs-keyword">false</span>);

    PowerMockito.when(NetUtils.isValidIp6Cidr(Mockito.eq(destCidrMock))).thenReturn(<span class="hljs-keyword">false</span>);

    cmdMock.validateCidrs();

    Mockito.verify(cmdMock, Mockito.atLeast(<span class="hljs-number">2</span>)).getSourceCidrList();

    Mockito.verify(cmdMock).getNetworkId();

    Mockito.verify(networkServiceMock).getNetwork(networkIdMock);

    Mockito.verify(networkMock).getCidr();

    PowerMockito.verifyStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    NetUtils.isValidIp4Cidr(sourceCidrMock);

    NetUtils.isValidIp6Cidr(sourceCidrMock);

    PowerMockito.verifyStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    NetUtils.isNetworkAWithinNetworkB(sourceCidrMock, sourceCidrMock);

    PowerMockito.verifyStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    NetUtils.isValidIp4Cidr(destCidrMock);

    NetUtils.isValidIp6Cidr(destCidrMock);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest385">Test Case ID #cloudstack_Test_38_5</h4>
<h4 id="test-case-name-validatecidrstestsourcecidrequalsallip4file-cjavaprojectsapachecloudstackapisrctestjavaorgapachecloudstackapicommanduserfirewallcreateegressfirewallrulecmdtestjava">Test Case Name: <code>validateCidrsTestSourceCidrEqualsAllIp4</code>(File: <code>C:\Java_projects\Apache\cloudstack\api\src\test\java\org\apache\cloudstack\api\command\user\firewall\CreateEgressFirewallRuleCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-networkmock">Mock Object Variable Name: <code>networkMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     Mockito.doReturn(networkIdMock).when(cmdMock).getNetworkId();
<span class="hljs-deletion">-    Network networkMock = Mockito.mock(Network.class);</span>
<span class="hljs-deletion">-    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);</span>
<span class="hljs-deletion">-    Mockito.doReturn(sourceCidrMock).when(networkMock).getCidr();</span>
<span class="hljs-addition">+    Network networkMock = Mockito.mock(Network.class);</span>
<span class="hljs-addition">+    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);</span>
<span class="hljs-addition">+    Mockito.doReturn(sourceCidrMock).when(networkMock).getCidr();</span>
     PowerMockito.mockStatic(NetUtils.class);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">validateCidrsTestSourceCidrEqualsAllIp4</span><span class="hljs-params">()</span> </span>{

    ArrayList&lt;String&gt; listSourceMock = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    String sourceCidrMock = <span class="hljs-string">"0.0.0.0/0"</span>;

    listSourceMock.add(sourceCidrMock);

    cmdMock.setSourceCidrList(listSourceMock);

    ArrayList&lt;String&gt; listDestMock = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    String destCidrMock = <span class="hljs-string">"10.1.1.0/24"</span>;

    listDestMock.add(destCidrMock);

    cmdMock.setDestCidrList(listDestMock);

    <span class="hljs-keyword">long</span> networkIdMock = <span class="hljs-number">1234</span>;

    Mockito.doReturn(networkIdMock).when(cmdMock).getNetworkId();

    Network networkMock = Mockito.mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);

    Mockito.doReturn(sourceCidrMock).when(networkMock).getCidr();

    PowerMockito.mockStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    PowerMockito.when(NetUtils.isValidIp4Cidr(Mockito.eq(sourceCidrMock))).thenReturn(<span class="hljs-keyword">true</span>);

    PowerMockito.when(NetUtils.isValidIp6Cidr(Mockito.eq(sourceCidrMock))).thenReturn(<span class="hljs-keyword">false</span>);

    PowerMockito.when(NetUtils.isValidIp4Cidr(Mockito.eq(destCidrMock))).thenReturn(<span class="hljs-keyword">true</span>);

    PowerMockito.when(NetUtils.isValidIp6Cidr(Mockito.eq(destCidrMock))).thenReturn(<span class="hljs-keyword">false</span>);

    cmdMock.validateCidrs();

    Mockito.verify(cmdMock, Mockito.atLeast(<span class="hljs-number">2</span>)).getSourceCidrList();

    Mockito.verify(cmdMock).getNetworkId();

    Mockito.verify(networkServiceMock).getNetwork(networkIdMock);

    Mockito.verify(networkMock).getCidr();

    PowerMockito.verifyStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    NetUtils.isValidIp4Cidr(sourceCidrMock);

    NetUtils.isValidIp6Cidr(sourceCidrMock);

    PowerMockito.verifyStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">never</span>())</span>;

    NetUtils.isNetworkAWithinNetworkB(sourceCidrMock, sourceCidrMock);

    PowerMockito.verifyStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    NetUtils.isValidIp4Cidr(destCidrMock);

    NetUtils.isValidIp6Cidr(destCidrMock);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest386">Test Case ID #cloudstack_Test_38_6</h4>
<h4 id="test-case-name-validatecidrstestsourcecidrnotwithinnetworkfile-cjavaprojectsapachecloudstackapisrctestjavaorgapachecloudstackapicommanduserfirewallcreateegressfirewallrulecmdtestjava">Test Case Name: <code>validateCidrsTestSourceCidrNotWithinNetwork</code>(File: <code>C:\Java_projects\Apache\cloudstack\api\src\test\java\org\apache\cloudstack\api\command\user\firewall\CreateEgressFirewallRuleCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-networkmock">Mock Object Variable Name: <code>networkMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     Mockito.doReturn(networkIdMock).when(cmdMock).getNetworkId();
<span class="hljs-deletion">-    Network networkMock = Mockito.mock(Network.class);</span>
<span class="hljs-deletion">-    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);</span>
<span class="hljs-deletion">-    Mockito.doReturn(cidrMock).when(networkMock).getCidr();</span>
<span class="hljs-addition">+    Network networkMock = Mockito.mock(Network.class);</span>
<span class="hljs-addition">+    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);</span>
<span class="hljs-addition">+    Mockito.doReturn(cidrMock).when(networkMock).getCidr();</span>
     PowerMockito.mockStatic(NetUtils.class);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>(expected = ServerApiException<span class="hljs-class">.<span class="hljs-keyword">class</span>)

<span class="hljs-title">public</span> <span class="hljs-title">void</span> <span class="hljs-title">validateCidrsTestSourceCidrNotWithinNetwork</span>() </span>{

    ArrayList&lt;String&gt; listMock = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    String cidrMock = <span class="hljs-string">"10.1.1.0/24"</span>;

    listMock.add(cidrMock);

    cmdMock.setSourceCidrList(listMock);

    cmdMock.setDestCidrList(listMock);

    <span class="hljs-keyword">long</span> networkIdMock = <span class="hljs-number">1234</span>;

    Mockito.doReturn(networkIdMock).when(cmdMock).getNetworkId();

    Network networkMock = Mockito.mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);

    Mockito.doReturn(cidrMock).when(networkMock).getCidr();

    PowerMockito.mockStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    PowerMockito.when(NetUtils.isValidIp4Cidr(cidrMock)).thenReturn(<span class="hljs-keyword">true</span>);

    PowerMockito.when(NetUtils.isValidIp6Cidr(cidrMock)).thenReturn(<span class="hljs-keyword">false</span>);

    PowerMockito.when(NetUtils.isNetworkAWithinNetworkB(cidrMock, cidrMock)).thenReturn(<span class="hljs-keyword">false</span>);

    cmdMock.validateCidrs();

    Mockito.verify(cmdMock, Mockito.atLeast(<span class="hljs-number">2</span>)).getSourceCidrList();

    Mockito.verify(cmdMock).getNetworkId();

    Mockito.verify(networkServiceMock).getNetwork(networkIdMock);

    Mockito.verify(networkMock).getCidr();

    PowerMockito.verifyStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">times</span>(1))</span>;

    NetUtils.isValidIp4Cidr(cidrMock);

    NetUtils.isValidIp6Cidr(cidrMock);

    PowerMockito.verifyStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    NetUtils.isNetworkAWithinNetworkB(cidrMock, cidrMock);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest387">Test Case ID #cloudstack_Test_38_7</h4>
<h4 id="test-case-name-validatecidrstestnulldestinationcidrfile-cjavaprojectsapachecloudstackapisrctestjavaorgapachecloudstackapicommanduserfirewallcreateegressfirewallrulecmdtestjava">Test Case Name: <code>validateCidrsTestNullDestinationCidr</code>(File: <code>C:\Java_projects\Apache\cloudstack\api\src\test\java\org\apache\cloudstack\api\command\user\firewall\CreateEgressFirewallRuleCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-networkmock">Mock Object Variable Name: <code>networkMock</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     Mockito.doReturn(networkIdMock).when(cmdMock).getNetworkId();
<span class="hljs-deletion">-    Network networkMock = Mockito.mock(Network.class);</span>
<span class="hljs-deletion">-    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);</span>
<span class="hljs-deletion">-    Mockito.doReturn(sourceCidrMock).when(networkMock).getCidr();</span>
<span class="hljs-addition">+    Network networkMock = Mockito.mock(Network.class);</span>
<span class="hljs-addition">+    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);</span>
<span class="hljs-addition">+    Mockito.doReturn(sourceCidrMock).when(networkMock).getCidr();</span>
     PowerMockito.mockStatic(NetUtils.class);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">validateCidrsTestNullDestinationCidr</span><span class="hljs-params">()</span> </span>{

    ArrayList&lt;String&gt; listSourceMock = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    String sourceCidrMock = <span class="hljs-string">"10.1.1.0/24"</span>;

    listSourceMock.add(sourceCidrMock);

    cmdMock.setSourceCidrList(listSourceMock);

    <span class="hljs-keyword">long</span> networkIdMock = <span class="hljs-number">1234</span>;

    Mockito.doReturn(networkIdMock).when(cmdMock).getNetworkId();

    Network networkMock = Mockito.mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.doReturn(networkMock).when(networkServiceMock).getNetwork(networkIdMock);

    Mockito.doReturn(sourceCidrMock).when(networkMock).getCidr();

    PowerMockito.mockStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    PowerMockito.when(NetUtils.isValidIp4Cidr(Mockito.eq(sourceCidrMock))).thenReturn(<span class="hljs-keyword">true</span>);

    PowerMockito.when(NetUtils.isValidIp6Cidr(Mockito.eq(sourceCidrMock))).thenReturn(<span class="hljs-keyword">false</span>);

    PowerMockito.when(NetUtils.isNetworkAWithinNetworkB(sourceCidrMock, sourceCidrMock)).thenReturn(<span class="hljs-keyword">true</span>);

    cmdMock.validateCidrs();

    Mockito.verify(cmdMock, Mockito.atLeast(<span class="hljs-number">2</span>)).getSourceCidrList();

    Mockito.verify(cmdMock).getNetworkId();

    Mockito.verify(networkServiceMock).getNetwork(networkIdMock);

    Mockito.verify(networkMock).getCidr();

    PowerMockito.verifyStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    NetUtils.isValidIp4Cidr(sourceCidrMock);

    NetUtils.isValidIp6Cidr(sourceCidrMock);

    PowerMockito.verifyStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    NetUtils.isNetworkAWithinNetworkB(sourceCidrMock, sourceCidrMock);

    PowerMockito.verifyStatic(NetUtils<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">Mockito</span>.<span class="hljs-title">never</span>())</span>;

    NetUtils.isValidIp4Cidr(<span class="hljs-keyword">null</span>);

    NetUtils.isValidIp6Cidr(<span class="hljs-keyword">null</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci81">Mock Clone Instance #cloudstack_MCI_81</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.cloud.vm.NicProfile</code></li>
<li><strong>Test Case Count</strong>: 6</li>
<li><strong>MO Count</strong>: 6</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> NicProfile nicProfile;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    nicProfile = mock(NicProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest811">Test Case ID #cloudstack_Test_81_1</h4>
<h4 id="test-case-name-testdeallocatefile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenservicetungstenguestnetworkgurutestjava">Test Case Name: <code>testDeallocate</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\service\TungstenGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-nicprofile">Mock Object Variable Name: <code>nicProfile</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testDeallocate() {
     final Network network = mock(Network.class);
<span class="hljs-deletion">-    final NicProfile nicProfile = mock(NicProfile.class);</span>
     final VirtualMachineProfile virtualMachineProfile = mock(VirtualMachineProfile.class);
     final NicVO nicVO = mock(NicVO.class);
     when(network.getDataCenterId()).thenReturn(1L);
     when(network.getTrafficType()).thenReturn(Networks.TrafficType.Guest);
     when(virtualMachineProfile.getType()).thenReturn(VirtualMachine.Type.User);
     when(nicDao.listByVmId(anyLong())).thenReturn(List.of(nicVO));
     guru.deallocate(network, nicProfile, virtualMachineProfile);
     verify(tungstenFabricUtils, times(1)).sendTungstenCommand(any(DeleteTungstenVmCommand.class), anyLong());
     verify(tungstenFabricUtils, times(1)).sendTungstenCommand(any(DeleteTungstenVmInterfaceCommand.class), anyLong());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDeallocate</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> NicProfile nicProfile = mock(NicProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> VirtualMachineProfile virtualMachineProfile = mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> NicVO nicVO = mock(NicVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(network.getDataCenterId()).thenReturn(<span class="hljs-number">1L</span>);

    when(network.getTrafficType()).thenReturn(Networks.TrafficType.Guest);

    when(virtualMachineProfile.getType()).thenReturn(VirtualMachine.Type.User);

    when(nicDao.listByVmId(anyLong())).thenReturn(List.of(nicVO));

    guru.deallocate(network, nicProfile, virtualMachineProfile);

    verify(tungstenFabricUtils, times(<span class="hljs-number">1</span>)).sendTungstenCommand(any(DeleteTungstenVmCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())</span>;

    verify(tungstenFabricUtils, times(<span class="hljs-number">1</span>)).sendTungstenCommand(any(DeleteTungstenVmInterfaceCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> NicProfile nicProfile;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    nicProfile = mock(NicProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest812">Test Case ID #cloudstack_Test_81_2</h4>
<h4 id="test-case-name-testdeallocatewithexceptionfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenservicetungstenguestnetworkgurutestjava">Test Case Name: <code>testDeallocateWithException</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\service\TungstenGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-nicprofile">Mock Object Variable Name: <code>nicProfile</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test(expected = CloudRuntimeException.class)
 public void testDeallocateWithException() {
     final Network network = mock(Network.class);
<span class="hljs-deletion">-    final NicProfile nicProfile = mock(NicProfile.class);</span>
     final VirtualMachineProfile virtualMachineProfile = mock(VirtualMachineProfile.class);
     final NicVO nicVO = mock(NicVO.class);
     when(tungstenFabricUtils.sendTungstenCommand(any(DeleteTungstenVmCommand.class), anyLong())).thenThrow(new IllegalArgumentException());
     when(nicDao.listByVmId(anyLong())).thenReturn(List.of(nicVO));
     when(network.getTrafficType()).thenReturn(Networks.TrafficType.Guest);
     when(virtualMachineProfile.getType()).thenReturn(VirtualMachine.Type.User);
     guru.deallocate(network, nicProfile, virtualMachineProfile);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>(expected = CloudRuntimeException<span class="hljs-class">.<span class="hljs-keyword">class</span>)

<span class="hljs-title">public</span> <span class="hljs-title">void</span> <span class="hljs-title">testDeallocateWithException</span>() </span>{

    <span class="hljs-keyword">final</span> Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> NicProfile nicProfile = mock(NicProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> VirtualMachineProfile virtualMachineProfile = mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> NicVO nicVO = mock(NicVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(tungstenFabricUtils.sendTungstenCommand(any(DeleteTungstenVmCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenThrow</span>(<span class="hljs-title">new</span> <span class="hljs-title">IllegalArgumentException</span>())</span>;

    when(nicDao.listByVmId(anyLong())).thenReturn(List.of(nicVO));

    when(network.getTrafficType()).thenReturn(Networks.TrafficType.Guest);

    when(virtualMachineProfile.getType()).thenReturn(VirtualMachine.Type.User);

    guru.deallocate(network, nicProfile, virtualMachineProfile);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> NicProfile nicProfile;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    nicProfile = mock(NicProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest813">Test Case ID #cloudstack_Test_81_3</h4>
<h4 id="test-case-name-testreleasefile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenservicetungstenguestnetworkgurutestjava">Test Case Name: <code>testRelease</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\service\TungstenGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-nic">Mock Object Variable Name: <code>nic</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testRelease() {
<span class="hljs-deletion">-    final NicProfile nic = mock(NicProfile.class);</span>
     final VirtualMachineProfile vm = mock(VirtualMachineProfile.class);
     final IPAddressVO ipAddressVO = mock(IPAddressVO.class);
     final VMInstanceVO vmInstanceVO = mock(VMInstanceVO.class);
     final HostVO host = mock(HostVO.class);
     when(vm.getType()).thenReturn(VirtualMachine.Type.User);
     when(hostDao.findById(anyLong())).thenReturn(host);
     when(ipAddressDao.findByAssociatedVmId(anyLong())).thenReturn(ipAddressVO);
     when(networkModel.getSystemNetworkByZoneAndTrafficType(anyLong(), any())).thenReturn(new NetworkVO());
     when(tungstenFabricUtils.sendTungstenCommand(any(ReleaseTungstenFloatingIpCommand.class), anyLong())).thenReturn(new TungstenAnswer(new TungstenCommand(), true, ""));
     when(tungstenFabricUtils.sendTungstenCommand(any(DeleteTungstenVRouterPortCommand.class), anyLong())).thenReturn(new TungstenAnswer(new TungstenCommand(), true, ""));
     when(vmInstanceDao.findById(anyLong())).thenReturn(vmInstanceVO);
<span class="hljs-deletion">-    guru.release(nic, vm, "test");</span>
<span class="hljs-addition">+    guru.release(nicProfile, vm, "test");</span>
     verify(tungstenFabricUtils, times(1)).sendTungstenCommand(any(DeleteTungstenVRouterPortCommand.class), anyLong());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRelease</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> NicProfile nic = mock(NicProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> VirtualMachineProfile vm = mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> IPAddressVO ipAddressVO = mock(IPAddressVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> VMInstanceVO vmInstanceVO = mock(VMInstanceVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> HostVO host = mock(HostVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vm.getType()).thenReturn(VirtualMachine.Type.User);

    when(hostDao.findById(anyLong())).thenReturn(host);

    when(ipAddressDao.findByAssociatedVmId(anyLong())).thenReturn(ipAddressVO);

    when(networkModel.getSystemNetworkByZoneAndTrafficType(anyLong(), any())).thenReturn(<span class="hljs-keyword">new</span> NetworkVO());

    when(tungstenFabricUtils.sendTungstenCommand(any(ReleaseTungstenFloatingIpCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">TungstenAnswer</span>(<span class="hljs-title">new</span> <span class="hljs-title">TungstenCommand</span>(), <span class="hljs-title">true</span>, ""))</span>;

    when(tungstenFabricUtils.sendTungstenCommand(any(DeleteTungstenVRouterPortCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">TungstenAnswer</span>(<span class="hljs-title">new</span> <span class="hljs-title">TungstenCommand</span>(), <span class="hljs-title">true</span>, ""))</span>;

    when(vmInstanceDao.findById(anyLong())).thenReturn(vmInstanceVO);

    guru.release(nic, vm, <span class="hljs-string">"test"</span>);

    verify(tungstenFabricUtils, times(<span class="hljs-number">1</span>)).sendTungstenCommand(any(DeleteTungstenVRouterPortCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> NicProfile nicProfile;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    nicProfile = mock(NicProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest814">Test Case ID #cloudstack_Test_81_4</h4>
<h4 id="test-case-name-testpreparemigrationfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenservicetungstenguestnetworkgurutestjava">Test Case Name: <code>testPrepareMigration</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\service\TungstenGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-nic">Mock Object Variable Name: <code>nic</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testPrepareMigration() {
<span class="hljs-deletion">-    final NicProfile nic = mock(NicProfile.class);</span>
     final Network network = mock(Network.class);
     final VirtualMachineProfile vm = mock(VirtualMachineProfile.class);
     final DeployDestination dest = mock(DeployDestination.class);
     final ReservationContext context = mock(ReservationContext.class);
     final VMInstanceVO vmInstanceVO = mock(VMInstanceVO.class);
     final HostVO hostVO = mock(HostVO.class);
     when(vm.getType()).thenReturn(VirtualMachine.Type.User);
     when(network.getTrafficType()).thenReturn(Networks.TrafficType.Guest);
     when(vmInstanceDao.findById(anyLong())).thenReturn(vmInstanceVO);
     when(hostDao.findById(anyLong())).thenReturn(hostVO);
     when(tungstenFabricUtils.sendTungstenCommand(any(CreateTungstenVirtualMachineCommand.class), anyLong())).thenReturn(new TungstenAnswer(new TungstenCommand(), true, ""));
<span class="hljs-deletion">-    guru.prepareMigration(nic, network, vm, dest, context);</span>
<span class="hljs-addition">+    guru.prepareMigration(nicProfile, network, vm, dest, context);</span>
     verify(tungstenFabricUtils, times(1)).sendTungstenCommand(any(CreateTungstenVirtualMachineCommand.class), anyLong());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testPrepareMigration</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> NicProfile nic = mock(NicProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> VirtualMachineProfile vm = mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DeployDestination dest = mock(DeployDestination<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ReservationContext context = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> VMInstanceVO vmInstanceVO = mock(VMInstanceVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> HostVO hostVO = mock(HostVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vm.getType()).thenReturn(VirtualMachine.Type.User);

    when(network.getTrafficType()).thenReturn(Networks.TrafficType.Guest);

    when(vmInstanceDao.findById(anyLong())).thenReturn(vmInstanceVO);

    when(hostDao.findById(anyLong())).thenReturn(hostVO);

    when(tungstenFabricUtils.sendTungstenCommand(any(CreateTungstenVirtualMachineCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">new</span> <span class="hljs-title">TungstenAnswer</span>(<span class="hljs-title">new</span> <span class="hljs-title">TungstenCommand</span>(), <span class="hljs-title">true</span>, ""))</span>;

    guru.prepareMigration(nic, network, vm, dest, context);

    verify(tungstenFabricUtils, times(<span class="hljs-number">1</span>)).sendTungstenCommand(any(CreateTungstenVirtualMachineCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> NicProfile nicProfile;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    nicProfile = mock(NicProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest815">Test Case ID #cloudstack_Test_81_5</h4>
<h4 id="test-case-name-testrollbackmigrationfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenservicetungstenguestnetworkgurutestjava">Test Case Name: <code>testRollbackMigration</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\service\TungstenGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-nic">Mock Object Variable Name: <code>nic</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testRollbackMigration() {
<span class="hljs-deletion">-    final NicProfile nic = mock(NicProfile.class);</span>
     final Network network = mock(Network.class);
     final VirtualMachineProfile vmProfile = mock(VirtualMachineProfile.class);
     final ReservationContext context = mock(ReservationContext.class);
     final VirtualMachine vm = mock(VirtualMachine.class);
     final HostVO hostVO = mock(HostVO.class);
     when(vmProfile.getType()).thenReturn(VirtualMachine.Type.User);
     when(vmProfile.getVirtualMachine()).thenReturn(vm);
     when(hostDao.findById(anyLong())).thenReturn(hostVO);
<span class="hljs-deletion">-    guru.rollbackMigration(nic, network, vmProfile, context, context);</span>
<span class="hljs-addition">+    guru.rollbackMigration(nicProfile, network, vmProfile, context, context);</span>
     verify(tungstenFabricUtils, times(1)).sendTungstenCommand(any(DeleteTungstenVRouterPortCommand.class), anyLong());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRollbackMigration</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> NicProfile nic = mock(NicProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> VirtualMachineProfile vmProfile = mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ReservationContext context = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> VirtualMachine vm = mock(VirtualMachine<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> HostVO hostVO = mock(HostVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vmProfile.getType()).thenReturn(VirtualMachine.Type.User);

    when(vmProfile.getVirtualMachine()).thenReturn(vm);

    when(hostDao.findById(anyLong())).thenReturn(hostVO);

    guru.rollbackMigration(nic, network, vmProfile, context, context);

    verify(tungstenFabricUtils, times(<span class="hljs-number">1</span>)).sendTungstenCommand(any(DeleteTungstenVRouterPortCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> NicProfile nicProfile;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    nicProfile = mock(NicProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest816">Test Case ID #cloudstack_Test_81_6</h4>
<h4 id="test-case-name-testcommitmigrationfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenservicetungstenguestnetworkgurutestjava">Test Case Name: <code>testCommitMigration</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\service\TungstenGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-nic">Mock Object Variable Name: <code>nic</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testCommitMigration() {
<span class="hljs-deletion">-    final NicProfile nic = mock(NicProfile.class);</span>
     final Network network = mock(Network.class);
     final VirtualMachineProfile vmProfile = mock(VirtualMachineProfile.class);
     final ReservationContext context = mock(ReservationContext.class);
     final VirtualMachine vm = mock(VirtualMachine.class);
     final HostVO hostVO = mock(HostVO.class);
     when(vmProfile.getType()).thenReturn(VirtualMachine.Type.User);
     when(vmProfile.getVirtualMachine()).thenReturn(vm);
     when(hostDao.findById(anyLong())).thenReturn(hostVO);
<span class="hljs-deletion">-    guru.commitMigration(nic, network, vmProfile, context, context);</span>
<span class="hljs-addition">+    guru.commitMigration(nicProfile, network, vmProfile, context, context);</span>
     verify(tungstenFabricUtils, times(1)).sendTungstenCommand(any(DeleteTungstenVRouterPortCommand.class), anyLong());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCommitMigration</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> NicProfile nic = mock(NicProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> VirtualMachineProfile vmProfile = mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> ReservationContext context = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> VirtualMachine vm = mock(VirtualMachine<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> HostVO hostVO = mock(HostVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vmProfile.getType()).thenReturn(VirtualMachine.Type.User);

    when(vmProfile.getVirtualMachine()).thenReturn(vm);

    when(hostDao.findById(anyLong())).thenReturn(hostVO);

    guru.commitMigration(nic, network, vmProfile, context, context);

    verify(tungstenFabricUtils, times(<span class="hljs-number">1</span>)).sendTungstenCommand(any(DeleteTungstenVRouterPortCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> NicProfile nicProfile;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    nicProfile = mock(NicProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci82">Mock Clone Instance #cloudstack_MCI_82</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>List&lt;BrocadeVcsDeviceVO&gt;</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div>
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest821">Test Case ID #cloudstack_Test_82_1</h4>
<h4 id="test-case-name-testimplementfailfile-cjavaprojectsapachecloudstackpluginsnetwork-elementsbrocade-vcssrctestjavacomcloudnetworkgurubrocadevcsguestnetworkgurutestjava">Test Case Name: <code>testImplementFail</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\brocade-vcs\src\test\java\com\cloud\network\guru\BrocadeVcsGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-devices">Mock Object Variable Name: <code>devices</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     final BrocadeVcsDeviceVO brocadeDevice = mock(BrocadeVcsDeviceVO.class);
     when(brocadeDevice.getHostId()).thenReturn(NETWORK_ID);
<span class="hljs-deletion">-    final List&lt;BrocadeVcsDeviceVO&gt; devices = mock(List.class);</span>
<span class="hljs-deletion">-    when(devices.isEmpty()).thenReturn(true);</span>
<span class="hljs-addition">+    final List&lt;BrocadeVcsDeviceVO&gt; devices = createMockDevicesListIsEmptyTrue();</span>
     when(vcsdao.listByPhysicalNetwork(anyLong())).thenReturn(devices);
     final Domain dom = mock(Domain.class);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testImplementFail</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InsufficientVirtualNetworkCapacityException, URISyntaxException </span>{

    <span class="hljs-keyword">final</span> PhysicalNetworkVO physnet = mock(PhysicalNetworkVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(physnetdao.findById((Long) any())).thenReturn(physnet);

    when(physnet.getIsolationMethods()).thenReturn(Arrays.asList(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"VCS"</span> }));

    when(physnet.getId()).thenReturn(NETWORK_ID);

    <span class="hljs-keyword">final</span> NetworkOffering offering = mock(NetworkOffering<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(offering.getId()).thenReturn(NETWORK_ID);

    when(offering.getTrafficType()).thenReturn(TrafficType.Guest);

    when(offering.getGuestType()).thenReturn(GuestType.Isolated);

    when(nosd.areServicesSupportedByNetworkOffering(NETWORK_ID, Service.Connectivity)).thenReturn(<span class="hljs-keyword">false</span>);

    mock(DeploymentPlan<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> NetworkVO network = mock(NetworkVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(network.getName()).thenReturn(<span class="hljs-string">"testnetwork"</span>);

    when(network.getState()).thenReturn(State.Implementing);

    when(network.getPhysicalNetworkId()).thenReturn(NETWORK_ID);

    when(network.getBroadcastUri()).thenReturn(<span class="hljs-keyword">new</span> URI(<span class="hljs-string">"vlan://14"</span>));

    <span class="hljs-keyword">final</span> DeployDestination dest = mock(DeployDestination<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataCenter dc = mock(DataCenter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(dest.getDataCenter()).thenReturn(dc);

    <span class="hljs-keyword">final</span> HostVO brocadeHost = mock(HostVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(hostdao.findById(anyLong())).thenReturn(brocadeHost);

    when(brocadeHost.getId()).thenReturn(NETWORK_ID);

    when(netmodel.findPhysicalNetworkId(anyLong(), (String) any(), (TrafficType) any())).thenReturn(NETWORK_ID);

    <span class="hljs-keyword">final</span> BrocadeVcsDeviceVO brocadeDevice = mock(BrocadeVcsDeviceVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(brocadeDevice.getHostId()).thenReturn(NETWORK_ID);

    <span class="hljs-keyword">final</span> List&lt;BrocadeVcsDeviceVO&gt; devices = mock(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(devices.isEmpty()).thenReturn(<span class="hljs-keyword">true</span>);

    when(vcsdao.listByPhysicalNetwork(anyLong())).thenReturn(devices);

    <span class="hljs-keyword">final</span> Domain dom = mock(Domain<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(dom.getName()).thenReturn(<span class="hljs-string">"domain"</span>);

    <span class="hljs-keyword">final</span> Account acc = mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(acc.getAccountName()).thenReturn(<span class="hljs-string">"accountname"</span>);

    <span class="hljs-keyword">final</span> ReservationContext res = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(res.getDomain()).thenReturn(dom);

    when(res.getAccount()).thenReturn(acc);

    when(guestGuru.implement(network, offering, dest, res)).thenReturn(network);

    <span class="hljs-keyword">final</span> CreateNetworkAnswer answer = mock(CreateNetworkAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(answer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(agentmgr.easySend(eq(NETWORK_ID), (Command) any())).thenReturn(answer);

    <span class="hljs-keyword">final</span> Network implementednetwork = guru.implement(network, offering, dest, res);

    assertTrue(implementednetwork == <span class="hljs-keyword">null</span>);

    verify(agentmgr, times(<span class="hljs-number">0</span>)).easySend(eq(NETWORK_ID), (Command) any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest822">Test Case ID #cloudstack_Test_82_2</h4>
<h4 id="test-case-name-testreservefailfile-cjavaprojectsapachecloudstackpluginsnetwork-elementsbrocade-vcssrctestjavacomcloudnetworkgurubrocadevcsguestnetworkgurutestjava">Test Case Name: <code>testReserveFail</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\brocade-vcs\src\test\java\com\cloud\network\guru\BrocadeVcsGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-devices">Mock Object Variable Name: <code>devices</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     final BrocadeVcsDeviceVO brocadeDevice = mock(BrocadeVcsDeviceVO.class);
     when(brocadeDevice.getHostId()).thenReturn(NETWORK_ID);
<span class="hljs-deletion">-    final List&lt;BrocadeVcsDeviceVO&gt; devices = mock(List.class);</span>
<span class="hljs-deletion">-    when(devices.isEmpty()).thenReturn(true);</span>
<span class="hljs-addition">+    final List&lt;BrocadeVcsDeviceVO&gt; devices = createMockDevicesListIsEmptyTrue();</span>
     when(vcsdao.listByPhysicalNetwork(anyLong())).thenReturn(devices);
     final Domain dom = mock(Domain.class);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testReserveFail</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InsufficientVirtualNetworkCapacityException, URISyntaxException, InsufficientAddressCapacityException </span>{

    <span class="hljs-keyword">final</span> NetworkVO network = mock(NetworkVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(network.getName()).thenReturn(<span class="hljs-string">"testnetwork"</span>);

    when(network.getState()).thenReturn(State.Implementing);

    when(network.getPhysicalNetworkId()).thenReturn(NETWORK_ID);

    when(network.getBroadcastUri()).thenReturn(<span class="hljs-keyword">new</span> URI(<span class="hljs-string">"vlan://14"</span>));

    when(network.getDataCenterId()).thenReturn(NETWORK_ID);

    <span class="hljs-keyword">final</span> NicProfile nic = mock(NicProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(nic.getMacAddress()).thenReturn(<span class="hljs-string">"macaddress"</span>);

    when(nic.getReservationStrategy()).thenReturn(ReservationStrategy.Start);

    <span class="hljs-keyword">final</span> VirtualMachineProfile vmProfile = mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DeployDestination dest = mock(DeployDestination<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> DataCenterVO dc = mock(DataCenterVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(dest.getDataCenter()).thenReturn(dc);

    when(dcdao.findById((<span class="hljs-keyword">long</span>) anyInt())).thenReturn(dc);

    <span class="hljs-keyword">final</span> HostVO brocadeHost = mock(HostVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(hostdao.findById(anyLong())).thenReturn(brocadeHost);

    when(brocadeHost.getId()).thenReturn(NETWORK_ID);

    when(netmodel.findPhysicalNetworkId(anyLong(), (String) any(), (TrafficType) any())).thenReturn(NETWORK_ID);

    <span class="hljs-keyword">final</span> BrocadeVcsDeviceVO brocadeDevice = mock(BrocadeVcsDeviceVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(brocadeDevice.getHostId()).thenReturn(NETWORK_ID);

    <span class="hljs-keyword">final</span> List&lt;BrocadeVcsDeviceVO&gt; devices = mock(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(devices.isEmpty()).thenReturn(<span class="hljs-keyword">true</span>);

    when(vcsdao.listByPhysicalNetwork(anyLong())).thenReturn(devices);

    <span class="hljs-keyword">final</span> Domain dom = mock(Domain<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(dom.getName()).thenReturn(<span class="hljs-string">"domain"</span>);

    <span class="hljs-keyword">final</span> Account acc = mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(acc.getAccountName()).thenReturn(<span class="hljs-string">"accountname"</span>);

    <span class="hljs-keyword">final</span> ReservationContext res = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(res.getDomain()).thenReturn(dom);

    when(res.getAccount()).thenReturn(acc);

    <span class="hljs-keyword">final</span> AssociateMacToNetworkAnswer answer = mock(AssociateMacToNetworkAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(answer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(agentmgr.easySend(eq(NETWORK_ID), (Command) any())).thenReturn(answer);

    guru.reserve(nic, network, vmProfile, dest, res);

    verify(agentmgr, times(<span class="hljs-number">0</span>)).easySend(eq(NETWORK_ID), (Command) any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest823">Test Case ID #cloudstack_Test_82_3</h4>
<h4 id="test-case-name-testdeallocatefailfile-cjavaprojectsapachecloudstackpluginsnetwork-elementsbrocade-vcssrctestjavacomcloudnetworkgurubrocadevcsguestnetworkgurutestjava">Test Case Name: <code>testDeallocateFail</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\brocade-vcs\src\test\java\com\cloud\network\guru\BrocadeVcsGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-devices">Mock Object Variable Name: <code>devices</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     final BrocadeVcsDeviceVO brocadeDevice = mock(BrocadeVcsDeviceVO.class);
     when(brocadeDevice.getHostId()).thenReturn(NETWORK_ID);
<span class="hljs-deletion">-    final List&lt;BrocadeVcsDeviceVO&gt; devices = mock(List.class);</span>
<span class="hljs-deletion">-    when(devices.isEmpty()).thenReturn(true);</span>
<span class="hljs-addition">+    final List&lt;BrocadeVcsDeviceVO&gt; devices = createMockDevicesListIsEmptyTrue();</span>
     when(vcsdao.listByPhysicalNetwork(anyLong())).thenReturn(devices);
     final DisassociateMacFromNetworkAnswer answer = mock(DisassociateMacFromNetworkAnswer.class);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDeallocateFail</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> NetworkVO network = mock(NetworkVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(network.getName()).thenReturn(<span class="hljs-string">"testnetwork"</span>);

    when(network.getState()).thenReturn(State.Implementing);

    when(network.getPhysicalNetworkId()).thenReturn(NETWORK_ID);

    when(network.getDataCenterId()).thenReturn(NETWORK_ID);

    <span class="hljs-keyword">final</span> NicProfile nic = mock(NicProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(nic.getMacAddress()).thenReturn(<span class="hljs-string">"macaddress"</span>);

    when(nic.getReservationStrategy()).thenReturn(ReservationStrategy.Start);

    <span class="hljs-keyword">final</span> VirtualMachineProfile vmProfile = mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> HostVO brocadeHost = mock(HostVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(hostdao.findById(anyLong())).thenReturn(brocadeHost);

    when(brocadeHost.getId()).thenReturn(NETWORK_ID);

    when(netmodel.findPhysicalNetworkId(anyLong(), (String) any(), (TrafficType) any())).thenReturn(NETWORK_ID);

    <span class="hljs-keyword">final</span> BrocadeVcsDeviceVO brocadeDevice = mock(BrocadeVcsDeviceVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(brocadeDevice.getHostId()).thenReturn(NETWORK_ID);

    <span class="hljs-keyword">final</span> List&lt;BrocadeVcsDeviceVO&gt; devices = mock(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(devices.isEmpty()).thenReturn(<span class="hljs-keyword">true</span>);

    when(vcsdao.listByPhysicalNetwork(anyLong())).thenReturn(devices);

    <span class="hljs-keyword">final</span> DisassociateMacFromNetworkAnswer answer = mock(DisassociateMacFromNetworkAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(answer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(agentmgr.easySend(eq(NETWORK_ID), (Command) any())).thenReturn(answer);

    guru.deallocate(network, nic, vmProfile);

    verify(agentmgr, times(<span class="hljs-number">0</span>)).easySend(eq(NETWORK_ID), (Command) any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest824">Test Case ID #cloudstack_Test_82_4</h4>
<h4 id="test-case-name-testtrashfailfile-cjavaprojectsapachecloudstackpluginsnetwork-elementsbrocade-vcssrctestjavacomcloudnetworkgurubrocadevcsguestnetworkgurutestjava">Test Case Name: <code>testTrashFail</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\brocade-vcs\src\test\java\com\cloud\network\guru\BrocadeVcsGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-devices">Mock Object Variable Name: <code>devices</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     final BrocadeVcsDeviceVO brocadeDevice = mock(BrocadeVcsDeviceVO.class);
     when(brocadeDevice.getHostId()).thenReturn(NETWORK_ID);
<span class="hljs-deletion">-    final List&lt;BrocadeVcsDeviceVO&gt; devices = mock(List.class);</span>
<span class="hljs-deletion">-    when(devices.isEmpty()).thenReturn(true);</span>
<span class="hljs-addition">+    final List&lt;BrocadeVcsDeviceVO&gt; devices = createMockDevicesListIsEmptyTrue();</span>
     when(vcsdao.listByPhysicalNetwork(anyLong())).thenReturn(devices);
     final boolean result = guru.trash(network, offering);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testTrashFail</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> NetworkVO network = mock(NetworkVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(network.getName()).thenReturn(<span class="hljs-string">"testnetwork"</span>);

    when(network.getState()).thenReturn(State.Implementing);

    when(network.getId()).thenReturn(NETWORK_ID);

    when(network.getDataCenterId()).thenReturn(NETWORK_ID);

    <span class="hljs-keyword">final</span> NetworkOffering offering = mock(NetworkOffering<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(offering.getId()).thenReturn(NETWORK_ID);

    when(offering.getTrafficType()).thenReturn(TrafficType.Guest);

    when(offering.getGuestType()).thenReturn(GuestType.Isolated);

    <span class="hljs-keyword">final</span> HostVO brocadeHost = mock(HostVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(hostdao.findById(anyLong())).thenReturn(brocadeHost);

    when(brocadeHost.getId()).thenReturn(NETWORK_ID);

    when(netmodel.findPhysicalNetworkId(anyLong(), (String) any(), (TrafficType) any())).thenReturn(NETWORK_ID);

    <span class="hljs-keyword">final</span> BrocadeVcsNetworkVlanMappingVO mapping = mock(BrocadeVcsNetworkVlanMappingVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(mapping.getVlanId()).thenReturn(<span class="hljs-number">14</span>);

    when(vcsmapdao.findByNetworkId(anyLong())).thenReturn(mapping);

    when(vcsmapdao.remove(anyLong())).thenReturn(<span class="hljs-keyword">true</span>);

    <span class="hljs-keyword">final</span> BrocadeVcsDeviceVO brocadeDevice = mock(BrocadeVcsDeviceVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(brocadeDevice.getHostId()).thenReturn(NETWORK_ID);

    <span class="hljs-keyword">final</span> List&lt;BrocadeVcsDeviceVO&gt; devices = mock(List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(devices.isEmpty()).thenReturn(<span class="hljs-keyword">true</span>);

    when(vcsdao.listByPhysicalNetwork(anyLong())).thenReturn(devices);

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> result = guru.trash(network, offering);

    assertTrue(result == <span class="hljs-keyword">false</span>);

    verify(agentmgr, times(<span class="hljs-number">0</span>)).easySend(eq(NETWORK_ID), (Command) any());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci83">Mock Clone Instance #cloudstack_MCI_83</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.cloudstack.engine.subsystem.api.storage.TemplateInfo</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div>
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest831">Test Case ID #cloudstack_Test_83_1</h4>
<h4 id="test-case-name-preparetestgettemplateuuidfile-cjavaprojectsapachecloudstackenginestoragedatamotionsrctestjavaorgapachecloudstackstoragemotionkvmnonmanagedstoragesystemdatamotiontestjava">Test Case Name: <code>prepareTestGetTemplateUuid</code>(File: <code>C:\Java_projects\Apache\cloudstack\engine\storage\datamotion\src\test\java\org\apache\cloudstack\storage\motion\KvmNonManagedStorageSystemDataMotionTest.java</code>)</h4>
<h4 id="mock-object-variable-name-templateimage">Mock Object Variable Name: <code>templateImage</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 private String prepareTestGetTemplateUuid() {
<span class="hljs-deletion">-    TemplateInfo templateImage = Mockito.mock(TemplateInfo.class);</span>
     String expectedTemplateUuid = "template uuid";
<span class="hljs-deletion">-    Mockito.when(templateImage.getUuid()).thenReturn(expectedTemplateUuid);</span>
<span class="hljs-addition">+    TemplateInfo templateImage = createMockTemplateInfoWithUuid(expectedTemplateUuid);</span>
     Mockito.doReturn(templateImage).when(templateDataFactory).getTemplate(0l, DataStoreRole.Image);
     return expectedTemplateUuid;
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">prepareTestGetTemplateUuid</span><span class="hljs-params">()</span> </span>{

    TemplateInfo templateImage = Mockito.mock(TemplateInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    String expectedTemplateUuid = <span class="hljs-string">"template uuid"</span>;

    Mockito.when(templateImage.getUuid()).thenReturn(expectedTemplateUuid);

    Mockito.doReturn(templateImage).when(templateDataFactory).getTemplate(<span class="hljs-number">0l</span>, DataStoreRole.Image);

    <span class="hljs-keyword">return</span> expectedTemplateUuid;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest832">Test Case ID #cloudstack_Test_83_2</h4>
<h4 id="test-case-name-configureandtestcopytemplatetotargetstorageifneededfile-cjavaprojectsapachecloudstackenginestoragedatamotionsrctestjavaorgapachecloudstackstoragemotionkvmnonmanagedstoragesystemdatamotiontestjava">Test Case Name: <code>configureAndTestcopyTemplateToTargetStorageIfNeeded</code>(File: <code>C:\Java_projects\Apache\cloudstack\engine\storage\datamotion\src\test\java\org\apache\cloudstack\storage\motion\KvmNonManagedStorageSystemDataMotionTest.java</code>)</h4>
<h4 id="mock-object-variable-name-sourcetemplateinfo">Mock Object Variable Name: <code>sourceTemplateInfo</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     DataStore sourceTemplateDataStore = Mockito.mock(DataStore.class);
     Mockito.lenient().when(sourceTemplateDataStore.getName()).thenReturn("sourceTemplateName");
<span class="hljs-deletion">-    TemplateInfo sourceTemplateInfo = Mockito.mock(TemplateInfo.class);</span>
<span class="hljs-deletion">-    Mockito.when(sourceTemplateInfo.getInstallPath()).thenReturn("installPath");</span>
<span class="hljs-deletion">-    Mockito.when(sourceTemplateInfo.getUuid()).thenReturn("uuid");</span>
<span class="hljs-deletion">-    Mockito.when(sourceTemplateInfo.getId()).thenReturn(0l);</span>
<span class="hljs-deletion">-    Mockito.when(sourceTemplateInfo.getUrl()).thenReturn("url");</span>
<span class="hljs-deletion">-    Mockito.when(sourceTemplateInfo.getDisplayText()).thenReturn("display text");</span>
<span class="hljs-deletion">-    Mockito.when(sourceTemplateInfo.getChecksum()).thenReturn("checksum");</span>
<span class="hljs-deletion">-    Mockito.when(sourceTemplateInfo.isRequiresHvm()).thenReturn(true);</span>
<span class="hljs-deletion">-    Mockito.when(sourceTemplateInfo.getAccountId()).thenReturn(0l);</span>
<span class="hljs-deletion">-    Mockito.when(sourceTemplateInfo.getUniqueName()).thenReturn("unique name");</span>
<span class="hljs-deletion">-    Mockito.when(sourceTemplateInfo.getFormat()).thenReturn(ImageFormat.QCOW2);</span>
<span class="hljs-deletion">-    Mockito.when(sourceTemplateInfo.getSize()).thenReturn(0l);</span>
<span class="hljs-deletion">-    Mockito.when(sourceTemplateInfo.getHypervisorType()).thenReturn(HypervisorType.KVM);</span>
<span class="hljs-addition">+    TemplateInfo sourceTemplateInfo = createMockTemplateInfoWithUuid("uuid");</span>
<span class="hljs-addition">+    Mockito.when(sourceTemplateInfo.getInstallPath()).thenReturn("installPath");</span>
<span class="hljs-addition">+    Mockito.when(sourceTemplateInfo.getId()).thenReturn(0l);</span>
<span class="hljs-addition">+    Mockito.when(sourceTemplateInfo.getUrl()).thenReturn("url");</span>
<span class="hljs-addition">+    Mockito.when(sourceTemplateInfo.getDisplayText()).thenReturn("display text");</span>
<span class="hljs-addition">+    Mockito.when(sourceTemplateInfo.getChecksum()).thenReturn("checksum");</span>
<span class="hljs-addition">+    Mockito.when(sourceTemplateInfo.isRequiresHvm()).thenReturn(true);</span>
<span class="hljs-addition">+    Mockito.when(sourceTemplateInfo.getAccountId()).thenReturn(0l);</span>
<span class="hljs-addition">+    Mockito.when(sourceTemplateInfo.getUniqueName()).thenReturn("unique name");</span>
<span class="hljs-addition">+    Mockito.when(sourceTemplateInfo.getFormat()).thenReturn(ImageFormat.QCOW2);</span>
<span class="hljs-addition">+    Mockito.when(sourceTemplateInfo.getSize()).thenReturn(0l);</span>
<span class="hljs-addition">+    Mockito.when(sourceTemplateInfo.getHypervisorType()).thenReturn(HypervisorType.KVM);</span>
     Mockito.when(vmTemplatePoolDao.findByPoolTemplate(Mockito.anyLong(), Mockito.anyLong(), nullable(String.class))).thenReturn(vmTemplateStoragePoolVO);
     Mockito.when(dataStoreManagerImpl.getRandomImageStore(Mockito.anyLong())).thenReturn(sourceTemplateDataStore);
     Mockito.when(templateDataFactory.getTemplate(Mockito.anyLong(), Mockito.eq(sourceTemplateDataStore))).thenReturn(sourceTemplateInfo);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureAndTestcopyTemplateToTargetStorageIfNeeded</span><span class="hljs-params">(VMTemplateStoragePoolVO vmTemplateStoragePoolVO, StoragePoolType storagePoolType, <span class="hljs-keyword">int</span> times)</span> </span>{

    DataStore destDataStore = Mockito.mock(DataStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Host destHost = Mockito.mock(Host<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    VolumeInfo srcVolumeInfo = Mockito.mock(VolumeInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(srcVolumeInfo.getTemplateId()).thenReturn(<span class="hljs-number">0l</span>);

    Mockito.when(srcVolumeInfo.getVolumeType()).thenReturn(Volume.Type.ROOT);

    StoragePool srcStoragePool = Mockito.mock(StoragePool<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    VolumeInfo destVolumeInfo = Mockito.mock(VolumeInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.lenient().when(volumeDataFactory.getVolume(Mockito.anyLong(), Mockito.any(DataStore<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">destVolumeInfo</span>)</span>;

    StoragePool destStoragePool = Mockito.mock(StoragePool<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(destStoragePool.getId()).thenReturn(<span class="hljs-number">0l</span>);

    Mockito.when(destStoragePool.getPoolType()).thenReturn(storagePoolType);

    DataStore sourceTemplateDataStore = Mockito.mock(DataStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.lenient().when(sourceTemplateDataStore.getName()).thenReturn(<span class="hljs-string">"sourceTemplateName"</span>);

    TemplateInfo sourceTemplateInfo = Mockito.mock(TemplateInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(sourceTemplateInfo.getInstallPath()).thenReturn(<span class="hljs-string">"installPath"</span>);

    Mockito.when(sourceTemplateInfo.getUuid()).thenReturn(<span class="hljs-string">"uuid"</span>);

    Mockito.when(sourceTemplateInfo.getId()).thenReturn(<span class="hljs-number">0l</span>);

    Mockito.when(sourceTemplateInfo.getUrl()).thenReturn(<span class="hljs-string">"url"</span>);

    Mockito.when(sourceTemplateInfo.getDisplayText()).thenReturn(<span class="hljs-string">"display text"</span>);

    Mockito.when(sourceTemplateInfo.getChecksum()).thenReturn(<span class="hljs-string">"checksum"</span>);

    Mockito.when(sourceTemplateInfo.isRequiresHvm()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(sourceTemplateInfo.getAccountId()).thenReturn(<span class="hljs-number">0l</span>);

    Mockito.when(sourceTemplateInfo.getUniqueName()).thenReturn(<span class="hljs-string">"unique name"</span>);

    Mockito.when(sourceTemplateInfo.getFormat()).thenReturn(ImageFormat.QCOW2);

    Mockito.when(sourceTemplateInfo.getSize()).thenReturn(<span class="hljs-number">0l</span>);

    Mockito.when(sourceTemplateInfo.getHypervisorType()).thenReturn(HypervisorType.KVM);

    Mockito.when(vmTemplatePoolDao.findByPoolTemplate(Mockito.anyLong(), Mockito.anyLong(), nullable(String<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">vmTemplateStoragePoolVO</span>)</span>;

    Mockito.when(dataStoreManagerImpl.getRandomImageStore(Mockito.anyLong())).thenReturn(sourceTemplateDataStore);

    Mockito.when(templateDataFactory.getTemplate(Mockito.anyLong(), Mockito.eq(sourceTemplateDataStore))).thenReturn(sourceTemplateInfo);

    Mockito.when(templateDataFactory.getTemplate(Mockito.anyLong(), Mockito.eq(destDataStore))).thenReturn(sourceTemplateInfo);

    kvmNonManagedStorageDataMotionStrategy.copyTemplateToTargetFilesystemStorageIfNeeded(srcVolumeInfo, srcStoragePool, destDataStore, destStoragePool, destHost);

    Mockito.lenient().doNothing().when(kvmNonManagedStorageDataMotionStrategy).updateTemplateReferenceIfSuccessfulCopy(Mockito.anyLong(), Mockito.anyString(), Mockito.anyLong(), Mockito.anyLong());

    InOrder verifyInOrder = Mockito.inOrder(vmTemplatePoolDao, dataStoreManagerImpl, templateDataFactory, kvmNonManagedStorageDataMotionStrategy);

    verifyInOrder.verify(vmTemplatePoolDao, Mockito.times(<span class="hljs-number">1</span>)).findByPoolTemplate(Mockito.anyLong(), Mockito.anyLong(), nullable(String<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    verifyInOrder.verify(dataStoreManagerImpl, Mockito.times(times)).getRandomImageStore(Mockito.anyLong());

    verifyInOrder.verify(templateDataFactory, Mockito.times(times)).getTemplate(Mockito.anyLong(), Mockito.eq(sourceTemplateDataStore));

    verifyInOrder.verify(templateDataFactory, Mockito.times(times)).getTemplate(Mockito.anyLong(), Mockito.eq(destDataStore));

    verifyInOrder.verify(kvmNonManagedStorageDataMotionStrategy, Mockito.times(times)).sendCopyCommand(Mockito.eq(destHost), Mockito.any(TemplateObjectTO<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">Mockito</span>.<span class="hljs-title">any</span>(<span class="hljs-title">TemplateObjectTO</span>.<span class="hljs-title">class</span>), <span class="hljs-title">Mockito</span>.<span class="hljs-title">eq</span>(<span class="hljs-title">destDataStore</span>))</span>;

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci84">Mock Clone Instance #cloudstack_MCI_84</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>TungstenService</code></li>
<li><strong>Test Case Count</strong>: 13</li>
<li><strong>MO Count</strong>: 13</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div>
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest841">Test Case ID #cloudstack_Test_84_1</h4>
<h4 id="test-case-name-executeallzonetestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenapicommandlisttungstenfabriclogicalroutercmdtestjava">Test Case Name: <code>executeAllZoneTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\api\command\ListTungstenFabricLogicalRouterCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-tungstenservice">Mock Object Variable Name: <code>tungstenService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void executeAllZoneTest() throws Exception {
     BaseResponse baseResponse = Mockito.mock(BaseResponse.class);
     List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);
     ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse.class);
     TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO.class);
     List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);
<span class="hljs-deletion">-    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);</span>
<span class="hljs-addition">+    // Use reusable mock helper for getTungstenProviders</span>
<span class="hljs-addition">+    tungstenService = MockTungstenService.createMockTungstenService(tungstenProviderVOList);</span>
     Mockito.when(tungstenService.listRoutingLogicalRouter(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);
     PowerMockito.whenNew(ListResponse.class).withAnyArguments().thenReturn(responseList);
     listTungstenFabricLogicalRouterCmd.execute();
     Assert.assertEquals(responseList, listTungstenFabricLogicalRouterCmd.getResponseObject());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeAllZoneTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    BaseResponse baseResponse = Mockito.mock(BaseResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);

    ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);

    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);

    Mockito.when(tungstenService.listRoutingLogicalRouter(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);

    PowerMockito.whenNew(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">withAnyArguments</span>().<span class="hljs-title">thenReturn</span>(<span class="hljs-title">responseList</span>)</span>;

    listTungstenFabricLogicalRouterCmd.execute();

    Assert.assertEquals(responseList, listTungstenFabricLogicalRouterCmd.getResponseObject());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest842">Test Case ID #cloudstack_Test_84_2</h4>
<h4 id="test-case-name-executeallzonetestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenapicommandlisttungstenfabricnetworkcmdtestjava">Test Case Name: <code>executeAllZoneTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\api\command\ListTungstenFabricNetworkCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-tungstenservice">Mock Object Variable Name: <code>tungstenService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void executeAllZoneTest() throws Exception {
     BaseResponse baseResponse = Mockito.mock(BaseResponse.class);
     List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);
     ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse.class);
     TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO.class);
     List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);
<span class="hljs-deletion">-    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);</span>
<span class="hljs-addition">+    // Use reusable mock helper for getTungstenProviders</span>
<span class="hljs-addition">+    tungstenService = MockTungstenService.createMockTungstenService(tungstenProviderVOList);</span>
     Mockito.when(tungstenService.listTungstenNetwork(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString(), ArgumentMatchers.anyBoolean())).thenReturn(baseResponseList);
     PowerMockito.whenNew(ListResponse.class).withAnyArguments().thenReturn(responseList);
     listTungstenFabricNetworkCmd.execute();
     Assert.assertEquals(responseList, listTungstenFabricNetworkCmd.getResponseObject());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeAllZoneTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    BaseResponse baseResponse = Mockito.mock(BaseResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);

    ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);

    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);

    Mockito.when(tungstenService.listTungstenNetwork(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString(), ArgumentMatchers.anyBoolean())).thenReturn(baseResponseList);

    PowerMockito.whenNew(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">withAnyArguments</span>().<span class="hljs-title">thenReturn</span>(<span class="hljs-title">responseList</span>)</span>;

    listTungstenFabricNetworkCmd.execute();

    Assert.assertEquals(responseList, listTungstenFabricNetworkCmd.getResponseObject());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest843">Test Case ID #cloudstack_Test_84_3</h4>
<h4 id="test-case-name-executeallzonetestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenapicommandlisttungstenfabricniccmdtestjava">Test Case Name: <code>executeAllZoneTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\api\command\ListTungstenFabricNicCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-tungstenservice">Mock Object Variable Name: <code>tungstenService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void executeAllZoneTest() throws Exception {
     BaseResponse baseResponse = Mockito.mock(BaseResponse.class);
     List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);
     ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse.class);
     TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO.class);
     List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);
<span class="hljs-deletion">-    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);</span>
<span class="hljs-addition">+    // Use reusable mock helper for getTungstenProviders</span>
<span class="hljs-addition">+    tungstenService = MockTungstenService.createMockTungstenService(tungstenProviderVOList);</span>
     Mockito.when(tungstenService.listTungstenNic(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);
     PowerMockito.whenNew(ListResponse.class).withAnyArguments().thenReturn(responseList);
     listTungstenFabricNicCmd.execute();
     Assert.assertEquals(responseList, listTungstenFabricNicCmd.getResponseObject());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeAllZoneTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    BaseResponse baseResponse = Mockito.mock(BaseResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);

    ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);

    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);

    Mockito.when(tungstenService.listTungstenNic(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);

    PowerMockito.whenNew(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">withAnyArguments</span>().<span class="hljs-title">thenReturn</span>(<span class="hljs-title">responseList</span>)</span>;

    listTungstenFabricNicCmd.execute();

    Assert.assertEquals(responseList, listTungstenFabricNicCmd.getResponseObject());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest844">Test Case ID #cloudstack_Test_84_4</h4>
<h4 id="test-case-name-executeallzonetestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenapicommandlisttungstenfabricpolicycmdtestjava">Test Case Name: <code>executeAllZoneTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\api\command\ListTungstenFabricPolicyCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-tungstenservice">Mock Object Variable Name: <code>tungstenService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void executeAllZoneTest() throws Exception {
     BaseResponse baseResponse = Mockito.mock(BaseResponse.class);
     List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);
     ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse.class);
     TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO.class);
     List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);
<span class="hljs-deletion">-    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);</span>
<span class="hljs-addition">+    // Use reusable mock helper for getTungstenProviders</span>
<span class="hljs-addition">+    tungstenService = MockTungstenService.createMockTungstenService(tungstenProviderVOList);</span>
     Mockito.when(tungstenService.listTungstenPolicy(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);
     PowerMockito.whenNew(ListResponse.class).withAnyArguments().thenReturn(responseList);
     listTungstenFabricPolicyCmd.execute();
     Assert.assertEquals(responseList, listTungstenFabricPolicyCmd.getResponseObject());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeAllZoneTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    BaseResponse baseResponse = Mockito.mock(BaseResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);

    ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);

    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);

    Mockito.when(tungstenService.listTungstenPolicy(ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.anyLong(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);

    PowerMockito.whenNew(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">withAnyArguments</span>().<span class="hljs-title">thenReturn</span>(<span class="hljs-title">responseList</span>)</span>;

    listTungstenFabricPolicyCmd.execute();

    Assert.assertEquals(responseList, listTungstenFabricPolicyCmd.getResponseObject());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest845">Test Case ID #cloudstack_Test_84_5</h4>
<h4 id="test-case-name-executeallzonetestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenapicommandlisttungstenfabricpolicyrulecmdtestjava">Test Case Name: <code>executeAllZoneTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\api\command\ListTungstenFabricPolicyRuleCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-tungstenservice">Mock Object Variable Name: <code>tungstenService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void executeAllZoneTest() throws Exception {
     BaseResponse baseResponse = Mockito.mock(BaseResponse.class);
     List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);
     ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse.class);
     TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO.class);
     List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);
<span class="hljs-deletion">-    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);</span>
<span class="hljs-addition">+    // Use reusable mock helper for getTungstenProviders</span>
<span class="hljs-addition">+    tungstenService = MockTungstenService.createMockTungstenService(tungstenProviderVOList);</span>
     Mockito.when(tungstenService.listTungstenPolicyRule(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);
     PowerMockito.whenNew(ListResponse.class).withAnyArguments().thenReturn(responseList);
     listTungstenFabricPolicyRuleCmd.execute();
     Assert.assertEquals(responseList, listTungstenFabricPolicyRuleCmd.getResponseObject());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeAllZoneTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    BaseResponse baseResponse = Mockito.mock(BaseResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);

    ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);

    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);

    Mockito.when(tungstenService.listTungstenPolicyRule(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);

    PowerMockito.whenNew(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">withAnyArguments</span>().<span class="hljs-title">thenReturn</span>(<span class="hljs-title">responseList</span>)</span>;

    listTungstenFabricPolicyRuleCmd.execute();

    Assert.assertEquals(responseList, listTungstenFabricPolicyRuleCmd.getResponseObject());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest846">Test Case ID #cloudstack_Test_84_6</h4>
<h4 id="test-case-name-executeallzonetestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenapicommandlisttungstenfabricservicegroupcmdtestjava">Test Case Name: <code>executeAllZoneTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\api\command\ListTungstenFabricServiceGroupCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-tungstenservice">Mock Object Variable Name: <code>tungstenService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void executeAllZoneTest() throws Exception {
     BaseResponse baseResponse = Mockito.mock(BaseResponse.class);
     List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);
     ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse.class);
     TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO.class);
     List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);
<span class="hljs-deletion">-    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);</span>
<span class="hljs-addition">+    // Use reusable mock helper for getTungstenProviders</span>
<span class="hljs-addition">+    tungstenService = MockTungstenService.createMockTungstenService(tungstenProviderVOList);</span>
     Mockito.when(tungstenService.listTungstenServiceGroup(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);
     PowerMockito.whenNew(ListResponse.class).withAnyArguments().thenReturn(responseList);
     listTungstenFabricServiceGroupCmd.execute();
     Assert.assertEquals(responseList, listTungstenFabricServiceGroupCmd.getResponseObject());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeAllZoneTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    BaseResponse baseResponse = Mockito.mock(BaseResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);

    ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);

    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);

    Mockito.when(tungstenService.listTungstenServiceGroup(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);

    PowerMockito.whenNew(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">withAnyArguments</span>().<span class="hljs-title">thenReturn</span>(<span class="hljs-title">responseList</span>)</span>;

    listTungstenFabricServiceGroupCmd.execute();

    Assert.assertEquals(responseList, listTungstenFabricServiceGroupCmd.getResponseObject());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest847">Test Case ID #cloudstack_Test_84_7</h4>
<h4 id="test-case-name-executeallzonetestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenapicommandlisttungstenfabrictagcmdtestjava">Test Case Name: <code>executeAllZoneTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\api\command\ListTungstenFabricTagCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-tungstenservice">Mock Object Variable Name: <code>tungstenService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void executeAllZoneTest() throws Exception {
     BaseResponse baseResponse = Mockito.mock(BaseResponse.class);
     List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);
     ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse.class);
     TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO.class);
     List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);
<span class="hljs-deletion">-    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);</span>
<span class="hljs-addition">+    // Use reusable mock helper for getTungstenProviders</span>
<span class="hljs-addition">+    tungstenService = MockTungstenService.createMockTungstenService(tungstenProviderVOList);</span>
     Mockito.when(tungstenService.listTungstenTags(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString(), ArgumentMatchers.anyString(), ArgumentMatchers.anyString(), ArgumentMatchers.anyString(), ArgumentMatchers.anyString(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);
     PowerMockito.whenNew(ListResponse.class).withAnyArguments().thenReturn(responseList);
     listTungstenFabricTagCmd.execute();
     Assert.assertEquals(responseList, listTungstenFabricTagCmd.getResponseObject());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeAllZoneTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    BaseResponse baseResponse = Mockito.mock(BaseResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);

    ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);

    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);

    Mockito.when(tungstenService.listTungstenTags(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString(), ArgumentMatchers.anyString(), ArgumentMatchers.anyString(), ArgumentMatchers.anyString(), ArgumentMatchers.anyString(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);

    PowerMockito.whenNew(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">withAnyArguments</span>().<span class="hljs-title">thenReturn</span>(<span class="hljs-title">responseList</span>)</span>;

    listTungstenFabricTagCmd.execute();

    Assert.assertEquals(responseList, listTungstenFabricTagCmd.getResponseObject());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest848">Test Case ID #cloudstack_Test_84_8</h4>
<h4 id="test-case-name-executeallzonetestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenapicommandlisttungstenfabrictagtypecmdtestjava">Test Case Name: <code>executeAllZoneTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\api\command\ListTungstenFabricTagTypeCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-tungstenservice">Mock Object Variable Name: <code>tungstenService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void executeAllZoneTest() throws Exception {
     BaseResponse baseResponse = Mockito.mock(BaseResponse.class);
     List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);
     ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse.class);
     TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO.class);
     List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);
<span class="hljs-deletion">-    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);</span>
<span class="hljs-addition">+    // Use reusable mock helper for getTungstenProviders</span>
<span class="hljs-addition">+    tungstenService = MockTungstenService.createMockTungstenService(tungstenProviderVOList);</span>
     Mockito.when(tungstenService.listTungstenTagTypes(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);
     PowerMockito.whenNew(ListResponse.class).withAnyArguments().thenReturn(responseList);
     listTungstenFabricTagTypeCmd.execute();
     Assert.assertEquals(responseList, listTungstenFabricTagTypeCmd.getResponseObject());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeAllZoneTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    BaseResponse baseResponse = Mockito.mock(BaseResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);

    ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);

    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);

    Mockito.when(tungstenService.listTungstenTagTypes(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);

    PowerMockito.whenNew(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">withAnyArguments</span>().<span class="hljs-title">thenReturn</span>(<span class="hljs-title">responseList</span>)</span>;

    listTungstenFabricTagTypeCmd.execute();

    Assert.assertEquals(responseList, listTungstenFabricTagTypeCmd.getResponseObject());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest849">Test Case ID #cloudstack_Test_84_9</h4>
<h4 id="test-case-name-executeallzonetestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenapicommandlisttungstenfabricvmcmdtestjava">Test Case Name: <code>executeAllZoneTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\api\command\ListTungstenFabricVmCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-tungstenservice">Mock Object Variable Name: <code>tungstenService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void executeAllZoneTest() throws Exception {
     BaseResponse baseResponse = Mockito.mock(BaseResponse.class);
     List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);
     ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse.class);
     TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO.class);
     List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);
<span class="hljs-deletion">-    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);</span>
<span class="hljs-addition">+    // Use reusable mock helper for getTungstenProviders</span>
<span class="hljs-addition">+    tungstenService = MockTungstenService.createMockTungstenService(tungstenProviderVOList);</span>
     Mockito.when(tungstenService.listTungstenVm(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);
     PowerMockito.whenNew(ListResponse.class).withAnyArguments().thenReturn(responseList);
     listTungstenFabricVmCmd.execute();
     Assert.assertEquals(responseList, listTungstenFabricVmCmd.getResponseObject());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeAllZoneTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    BaseResponse baseResponse = Mockito.mock(BaseResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);

    ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);

    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);

    Mockito.when(tungstenService.listTungstenVm(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);

    PowerMockito.whenNew(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">withAnyArguments</span>().<span class="hljs-title">thenReturn</span>(<span class="hljs-title">responseList</span>)</span>;

    listTungstenFabricVmCmd.execute();

    Assert.assertEquals(responseList, listTungstenFabricVmCmd.getResponseObject());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest8410">Test Case ID #cloudstack_Test_84_10</h4>
<h4 id="test-case-name-executeallzonetestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenapicommandlisttungstenfabricaddressgroupcmdtestjava">Test Case Name: <code>executeAllZoneTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\api\command\ListTungstenFabricAddressGroupCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-tungstenservice">Mock Object Variable Name: <code>tungstenService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void executeAllZoneTest() throws Exception {
     BaseResponse baseResponse = Mockito.mock(BaseResponse.class);
     List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);
     ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse.class);
     TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO.class);
     List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);
<span class="hljs-deletion">-    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);</span>
<span class="hljs-addition">+    // Use reusable mock helper for getTungstenProviders</span>
<span class="hljs-addition">+    tungstenService = MockTungstenService.createMockTungstenService(tungstenProviderVOList);</span>
     Mockito.when(tungstenService.listTungstenAddressGroup(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);
     PowerMockito.whenNew(ListResponse.class).withAnyArguments().thenReturn(responseList);
     listTungstenFabricAddressGroupCmd.execute();
     Assert.assertEquals(responseList, listTungstenFabricAddressGroupCmd.getResponseObject());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeAllZoneTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    BaseResponse baseResponse = Mockito.mock(BaseResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);

    ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);

    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);

    Mockito.when(tungstenService.listTungstenAddressGroup(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);

    PowerMockito.whenNew(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">withAnyArguments</span>().<span class="hljs-title">thenReturn</span>(<span class="hljs-title">responseList</span>)</span>;

    listTungstenFabricAddressGroupCmd.execute();

    Assert.assertEquals(responseList, listTungstenFabricAddressGroupCmd.getResponseObject());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest8411">Test Case ID #cloudstack_Test_84_11</h4>
<h4 id="test-case-name-executeallzonetestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenapicommandlisttungstenfabricapplictionpolicysetcmdtestjava">Test Case Name: <code>executeAllZoneTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\api\command\ListTungstenFabricApplictionPolicySetCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-tungstenservice">Mock Object Variable Name: <code>tungstenService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void executeAllZoneTest() throws Exception {
     BaseResponse baseResponse = Mockito.mock(BaseResponse.class);
     List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);
     ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse.class);
     TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO.class);
     List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);
<span class="hljs-deletion">-    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);</span>
<span class="hljs-addition">+    // Use reusable mock helper for getTungstenProviders</span>
<span class="hljs-addition">+    tungstenService = MockTungstenService.createMockTungstenService(tungstenProviderVOList);</span>
     Mockito.when(tungstenService.listTungstenApplicationPolicySet(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);
     PowerMockito.whenNew(ListResponse.class).withAnyArguments().thenReturn(responseList);
     listTungstenFabricApplictionPolicySetCmd.execute();
     Assert.assertEquals(responseList, listTungstenFabricApplictionPolicySetCmd.getResponseObject());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeAllZoneTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    BaseResponse baseResponse = Mockito.mock(BaseResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);

    ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);

    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);

    Mockito.when(tungstenService.listTungstenApplicationPolicySet(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);

    PowerMockito.whenNew(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">withAnyArguments</span>().<span class="hljs-title">thenReturn</span>(<span class="hljs-title">responseList</span>)</span>;

    listTungstenFabricApplictionPolicySetCmd.execute();

    Assert.assertEquals(responseList, listTungstenFabricApplictionPolicySetCmd.getResponseObject());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest8412">Test Case ID #cloudstack_Test_84_12</h4>
<h4 id="test-case-name-executeallzonetestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenapicommandlisttungstenfabricfirewallpolicycmdtestjava">Test Case Name: <code>executeAllZoneTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\api\command\ListTungstenFabricFirewallPolicyCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-tungstenservice">Mock Object Variable Name: <code>tungstenService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void executeAllZoneTest() throws Exception {
     BaseResponse baseResponse = Mockito.mock(BaseResponse.class);
     List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);
     ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse.class);
     TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO.class);
     List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);
<span class="hljs-deletion">-    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);</span>
<span class="hljs-addition">+    // Use reusable mock helper for getTungstenProviders</span>
<span class="hljs-addition">+    tungstenService = MockTungstenService.createMockTungstenService(tungstenProviderVOList);</span>
     Mockito.when(tungstenService.listTungstenFirewallPolicy(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);
     PowerMockito.whenNew(ListResponse.class).withAnyArguments().thenReturn(responseList);
     listTungstenFabricFirewallPolicyCmd.execute();
     Assert.assertEquals(responseList, listTungstenFabricFirewallPolicyCmd.getResponseObject());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeAllZoneTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    BaseResponse baseResponse = Mockito.mock(BaseResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);

    ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);

    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);

    Mockito.when(tungstenService.listTungstenFirewallPolicy(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);

    PowerMockito.whenNew(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">withAnyArguments</span>().<span class="hljs-title">thenReturn</span>(<span class="hljs-title">responseList</span>)</span>;

    listTungstenFabricFirewallPolicyCmd.execute();

    Assert.assertEquals(responseList, listTungstenFabricFirewallPolicyCmd.getResponseObject());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest8413">Test Case ID #cloudstack_Test_84_13</h4>
<h4 id="test-case-name-executeallzonetestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenapicommandlisttungstenfabricfirewallrulecmdtestjava">Test Case Name: <code>executeAllZoneTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\api\command\ListTungstenFabricFirewallRuleCmdTest.java</code>)</h4>
<h4 id="mock-object-variable-name-tungstenservice">Mock Object Variable Name: <code>tungstenService</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void executeAllZoneTest() throws Exception {
     BaseResponse baseResponse = Mockito.mock(BaseResponse.class);
     List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);
     ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse.class);
     TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO.class);
     List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);
<span class="hljs-deletion">-    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);</span>
<span class="hljs-addition">+    // Use reusable mock helper for getTungstenProviders</span>
<span class="hljs-addition">+    tungstenService = MockTungstenService.createMockTungstenService(tungstenProviderVOList);</span>
     Mockito.when(tungstenService.listTungstenFirewallRule(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);
     PowerMockito.whenNew(ListResponse.class).withAnyArguments().thenReturn(responseList);
     listTungstenFabricFirewallRuleCmd.execute();
     Assert.assertEquals(responseList, listTungstenFabricFirewallRuleCmd.getResponseObject());
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeAllZoneTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    BaseResponse baseResponse = Mockito.mock(BaseResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;BaseResponse&gt; baseResponseList = Arrays.asList(baseResponse);

    ListResponse&lt;BaseResponse&gt; responseList = Mockito.mock(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenProviderVO tungstenProviderVO = Mockito.mock(TungstenProviderVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;TungstenProviderVO&gt; tungstenProviderVOList = Arrays.asList(tungstenProviderVO);

    Mockito.when(tungstenService.getTungstenProviders()).thenReturn(tungstenProviderVOList);

    Mockito.when(tungstenService.listTungstenFirewallRule(ArgumentMatchers.anyLong(), ArgumentMatchers.anyString(), ArgumentMatchers.anyString())).thenReturn(baseResponseList);

    PowerMockito.whenNew(ListResponse<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">withAnyArguments</span>().<span class="hljs-title">thenReturn</span>(<span class="hljs-title">responseList</span>)</span>;

    listTungstenFabricFirewallRuleCmd.execute();

    Assert.assertEquals(responseList, listTungstenFabricFirewallRuleCmd.getResponseObject());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci97">Mock Clone Instance #cloudstack_MCI_97</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.cloud.network.lb.LoadBalancingRule</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div>
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest971">Test Case ID #cloudstack_Test_97_1</h4>
<h4 id="test-case-name-applylbrulesrevokerulefailtestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenservicetungstenelementtestjava">Test Case Name: <code>applyLBRulesRevokeRuleFailTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\service\TungstenElementTest.java</code>)</h4>
<h4 id="mock-object-variable-name-loadbalancingrule1">Mock Object Variable Name: <code>loadBalancingRule1</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     IPAddressVO ipAddressVO = mock(IPAddressVO.class);
<span class="hljs-deletion">-    LoadBalancingRule loadBalancingRule1 = mock(LoadBalancingRule.class);</span>
<span class="hljs-addition">+    LoadBalancingRule loadBalancingRule1 = createMockLoadBalancingRule(ip1, FirewallRule.State.Revoke);</span>
     LoadBalancerVO loadBalancerVO1 = mock(LoadBalancerVO.class);
     List&lt;LoadBalancingRule&gt; loadBalancingRuleList1 = List.of(loadBalancingRule1);
     List&lt;LoadBalancerVO&gt; loadBalancerVOList1 = List.of(loadBalancerVO1);
     TungstenGuestNetworkIpAddressVO tungstenGuestNetworkIpAddressVO = mock(TungstenGuestNetworkIpAddressVO.class);
     TungstenAnswer deleteTungstenLoadBalancerListenerAnswer = mock(TungstenAnswer.class);
     TungstenAnswer deleteTungstenLoadBalancerCommand = mock(TungstenAnswer.class);
     when(networkModel.getSystemNetworkByZoneAndTrafficType(anyLong(), any())).thenReturn(publicNetwork);
<span class="hljs-deletion">-    when(loadBalancingRule1.getSourceIp()).thenReturn(ip1);</span>
<span class="hljs-deletion">-    when(loadBalancingRule1.getState()).thenReturn(FirewallRule.State.Revoke);</span>
     when(ipAddressDao.findByIpAndDcId(anyLong(), anyString())).thenReturn(ipAddressVO);
     when(ipAddressVO.getAddress()).thenReturn(ip1);
     when(ip1.addr()).thenReturn("10.10.10.10");
     when(tungstenFabricUtils.sendTungstenCommand(any(DeleteTungstenLoadBalancerListenerCommand.class), anyLong())).thenReturn(deleteTungstenLoadBalancerListenerAnswer);
     when(tungstenFabricUtils.sendTungstenCommand(any(DeleteTungstenLoadBalancerCommand.class), anyLong())).thenReturn(deleteTungstenLoadBalancerCommand);
     when(deleteTungstenLoadBalancerListenerAnswer.getResult()).thenReturn(true);
     when(deleteTungstenLoadBalancerCommand.getResult()).thenReturn(true);
     when(tungstenService.updateLoadBalancerSsl(any(), any())).thenReturn(false);
     when(lbDao.listByIpAddress(anyLong())).thenReturn(loadBalancerVOList1);
     when(tungstenGuestNetworkIpAddressDao.findByNetworkIdAndPublicIp(anyLong(), anyString())).thenReturn(tungstenGuestNetworkIpAddressVO);
     when(tungstenGuestNetworkIpAddressDao.remove(anyLong())).thenReturn(false);
     assertFalse(tungstenElement.applyLBRules(network, loadBalancingRuleList1));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">applyLBRulesRevokeRuleFailTest</span><span class="hljs-params">()</span> </span>{

    Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Network publicNetwork = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Ip ip1 = mock(Ip<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    IPAddressVO ipAddressVO = mock(IPAddressVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    LoadBalancingRule loadBalancingRule1 = mock(LoadBalancingRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    LoadBalancerVO loadBalancerVO1 = mock(LoadBalancerVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;LoadBalancingRule&gt; loadBalancingRuleList1 = List.of(loadBalancingRule1);

    List&lt;LoadBalancerVO&gt; loadBalancerVOList1 = List.of(loadBalancerVO1);

    TungstenGuestNetworkIpAddressVO tungstenGuestNetworkIpAddressVO = mock(TungstenGuestNetworkIpAddressVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenAnswer deleteTungstenLoadBalancerListenerAnswer = mock(TungstenAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenAnswer deleteTungstenLoadBalancerCommand = mock(TungstenAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(networkModel.getSystemNetworkByZoneAndTrafficType(anyLong(), any())).thenReturn(publicNetwork);

    when(loadBalancingRule1.getSourceIp()).thenReturn(ip1);

    when(loadBalancingRule1.getState()).thenReturn(FirewallRule.State.Revoke);

    when(ipAddressDao.findByIpAndDcId(anyLong(), anyString())).thenReturn(ipAddressVO);

    when(ipAddressVO.getAddress()).thenReturn(ip1);

    when(ip1.addr()).thenReturn(<span class="hljs-string">"10.10.10.10"</span>);

    when(tungstenFabricUtils.sendTungstenCommand(any(DeleteTungstenLoadBalancerListenerCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">deleteTungstenLoadBalancerListenerAnswer</span>)</span>;

    when(tungstenFabricUtils.sendTungstenCommand(any(DeleteTungstenLoadBalancerCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">deleteTungstenLoadBalancerCommand</span>)</span>;

    when(deleteTungstenLoadBalancerListenerAnswer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(deleteTungstenLoadBalancerCommand.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(tungstenService.updateLoadBalancerSsl(any(), any())).thenReturn(<span class="hljs-keyword">false</span>);

    when(lbDao.listByIpAddress(anyLong())).thenReturn(loadBalancerVOList1);

    when(tungstenGuestNetworkIpAddressDao.findByNetworkIdAndPublicIp(anyLong(), anyString())).thenReturn(tungstenGuestNetworkIpAddressVO);

    when(tungstenGuestNetworkIpAddressDao.remove(anyLong())).thenReturn(<span class="hljs-keyword">false</span>);

    assertFalse(tungstenElement.applyLBRules(network, loadBalancingRuleList1));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest972">Test Case ID #cloudstack_Test_97_2</h4>
<h4 id="test-case-name-applylbrulesrevokerulesuccesstestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenservicetungstenelementtestjava">Test Case Name: <code>applyLBRulesRevokeRuleSuccessTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\service\TungstenElementTest.java</code>)</h4>
<h4 id="mock-object-variable-name-loadbalancingrule">Mock Object Variable Name: <code>loadBalancingRule</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     IPAddressVO ipAddressVO = mock(IPAddressVO.class);
<span class="hljs-deletion">-    LoadBalancingRule loadBalancingRule = mock(LoadBalancingRule.class);</span>
<span class="hljs-addition">+    LoadBalancingRule loadBalancingRule = createMockLoadBalancingRule(ip, FirewallRule.State.Revoke);</span>
     LoadBalancerVO loadBalancerVO1 = mock(LoadBalancerVO.class);
     LoadBalancerVO loadBalancerVO2 = mock(LoadBalancerVO.class);
     TungstenGuestNetworkIpAddressVO tungstenGuestNetworkIpAddressVO = mock(TungstenGuestNetworkIpAddressVO.class);
     TungstenAnswer deleteTungstenLoadBalancerListenerAnswer = mock(TungstenAnswer.class);
     TungstenAnswer deleteTungstenLoadBalancerCommand = mock(TungstenAnswer.class);
     List&lt;LoadBalancingRule&gt; loadBalancingRuleList = List.of(loadBalancingRule);
     List&lt;LoadBalancerVO&gt; loadBalancerVOList = Arrays.asList(loadBalancerVO1, loadBalancerVO2);
     when(networkModel.getSystemNetworkByZoneAndTrafficType(anyLong(), any())).thenReturn(publicNetwork);
<span class="hljs-deletion">-    when(loadBalancingRule.getSourceIp()).thenReturn(ip);</span>
<span class="hljs-deletion">-    when(loadBalancingRule.getState()).thenReturn(FirewallRule.State.Revoke);</span>
     when(ipAddressDao.findByIpAndDcId(anyLong(), anyString())).thenReturn(ipAddressVO);
     when(ipAddressVO.getAddress()).thenReturn(ip);
     when(ip.addr()).thenReturn("10.10.10.10");
     when(tungstenFabricUtils.sendTungstenCommand(any(DeleteTungstenLoadBalancerListenerCommand.class), anyLong())).thenReturn(deleteTungstenLoadBalancerListenerAnswer);
     when(tungstenFabricUtils.sendTungstenCommand(any(DeleteTungstenLoadBalancerCommand.class), anyLong())).thenReturn(deleteTungstenLoadBalancerCommand);
     when(deleteTungstenLoadBalancerListenerAnswer.getResult()).thenReturn(true);
     when(deleteTungstenLoadBalancerCommand.getResult()).thenReturn(true);
     when(tungstenService.updateLoadBalancer(any(), any())).thenReturn(true);
     when(lbDao.listByIpAddress(anyLong())).thenReturn(loadBalancerVOList);
     when(tungstenGuestNetworkIpAddressDao.findByNetworkIdAndPublicIp(anyLong(), anyString())).thenReturn(tungstenGuestNetworkIpAddressVO);
     assertTrue(tungstenElement.applyLBRules(network, loadBalancingRuleList));
}
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">applyLBRulesRevokeRuleSuccessTest</span><span class="hljs-params">()</span> </span>{

    Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Network publicNetwork = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Ip ip = mock(Ip<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    IPAddressVO ipAddressVO = mock(IPAddressVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    LoadBalancingRule loadBalancingRule = mock(LoadBalancingRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    LoadBalancerVO loadBalancerVO1 = mock(LoadBalancerVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    LoadBalancerVO loadBalancerVO2 = mock(LoadBalancerVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenGuestNetworkIpAddressVO tungstenGuestNetworkIpAddressVO = mock(TungstenGuestNetworkIpAddressVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenAnswer deleteTungstenLoadBalancerListenerAnswer = mock(TungstenAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenAnswer deleteTungstenLoadBalancerCommand = mock(TungstenAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;LoadBalancingRule&gt; loadBalancingRuleList = List.of(loadBalancingRule);

    List&lt;LoadBalancerVO&gt; loadBalancerVOList = Arrays.asList(loadBalancerVO1, loadBalancerVO2);

    when(networkModel.getSystemNetworkByZoneAndTrafficType(anyLong(), any())).thenReturn(publicNetwork);

    when(loadBalancingRule.getSourceIp()).thenReturn(ip);

    when(loadBalancingRule.getState()).thenReturn(FirewallRule.State.Revoke);

    when(ipAddressDao.findByIpAndDcId(anyLong(), anyString())).thenReturn(ipAddressVO);

    when(ipAddressVO.getAddress()).thenReturn(ip);

    when(ip.addr()).thenReturn(<span class="hljs-string">"10.10.10.10"</span>);

    when(tungstenFabricUtils.sendTungstenCommand(any(DeleteTungstenLoadBalancerListenerCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">deleteTungstenLoadBalancerListenerAnswer</span>)</span>;

    when(tungstenFabricUtils.sendTungstenCommand(any(DeleteTungstenLoadBalancerCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">deleteTungstenLoadBalancerCommand</span>)</span>;

    when(deleteTungstenLoadBalancerListenerAnswer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(deleteTungstenLoadBalancerCommand.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(tungstenService.updateLoadBalancer(any(), any())).thenReturn(<span class="hljs-keyword">true</span>);

    when(lbDao.listByIpAddress(anyLong())).thenReturn(loadBalancerVOList);

    when(tungstenGuestNetworkIpAddressDao.findByNetworkIdAndPublicIp(anyLong(), anyString())).thenReturn(tungstenGuestNetworkIpAddressVO);

    assertTrue(tungstenElement.applyLBRules(network, loadBalancingRuleList));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci119">Mock Clone Instance #cloudstack_MCI_119</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.cloud.deploy.DeploymentPlanner.ExcludeList</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> ExcludeList avoids;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    avoids = mock(ExcludeList<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// In each test method, replace:</span>
<span class="hljs-comment">//     ExcludeList avoids = mock(ExcludeList.class);</span>
<span class="hljs-comment">// with nothing (the field is initialized in setUp())</span>
<span class="hljs-comment">// and use the field 'avoids' directly.</span>
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest1191">Test Case ID #cloudstack_Test_119_1</h4>
<h4 id="test-case-name-checkclusterreorderingbasedonimplicithosttagsfile-cjavaprojectsapachecloudstackserversrctestjavacomcloudvmfirstfitplannertestjava">Test Case Name: <code>checkClusterReorderingBasedOnImplicitHostTags</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\vm\FirstFitPlannerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-avoids">Mock Object Variable Name: <code>avoids</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void checkClusterReorderingBasedOnImplicitHostTags() throws InsufficientServerCapacityException {
     VirtualMachineProfileImpl vmProfile = mock(VirtualMachineProfileImpl.class);
     DataCenterDeployment plan = mock(DataCenterDeployment.class);
<span class="hljs-deletion">-    ExcludeList avoids = mock(ExcludeList.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `avoids`</span>
     initializeForTest(vmProfile, plan, avoids);
     List&lt;Long&gt; clusterList = planner.orderClusters(vmProfile, plan, avoids);
     List&lt;Long&gt; reorderedClusterList = new ArrayList&lt;Long&gt;();
     reorderedClusterList.add(4L);
     reorderedClusterList.add(3L);
     reorderedClusterList.add(1L);
     reorderedClusterList.add(5L);
     reorderedClusterList.add(6L);
     reorderedClusterList.add(2L);
     assertTrue("Reordered cluster list is not honoring the implict host tags", (clusterList.equals(reorderedClusterList)));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">checkClusterReorderingBasedOnImplicitHostTags</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InsufficientServerCapacityException </span>{

    VirtualMachineProfileImpl vmProfile = mock(VirtualMachineProfileImpl<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DataCenterDeployment plan = mock(DataCenterDeployment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ExcludeList avoids = mock(ExcludeList<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    initializeForTest(vmProfile, plan, avoids);

    List&lt;Long&gt; clusterList = planner.orderClusters(vmProfile, plan, avoids);

    List&lt;Long&gt; reorderedClusterList = <span class="hljs-keyword">new</span> ArrayList&lt;Long&gt;();

    reorderedClusterList.add(<span class="hljs-number">4L</span>);

    reorderedClusterList.add(<span class="hljs-number">3L</span>);

    reorderedClusterList.add(<span class="hljs-number">1L</span>);

    reorderedClusterList.add(<span class="hljs-number">5L</span>);

    reorderedClusterList.add(<span class="hljs-number">6L</span>);

    reorderedClusterList.add(<span class="hljs-number">2L</span>);

    assertTrue(<span class="hljs-string">"Reordered cluster list is not honoring the implict host tags"</span>, (clusterList.equals(reorderedClusterList)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> ExcludeList avoids;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    avoids = mock(ExcludeList<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// In each test method, replace:</span>
<span class="hljs-comment">//     ExcludeList avoids = mock(ExcludeList.class);</span>
<span class="hljs-comment">// with nothing (the field is initialized in setUp())</span>
<span class="hljs-comment">// and use the field 'avoids' directly.</span>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1192">Test Case ID #cloudstack_Test_119_2</h4>
<h4 id="test-case-name-checkclusterreorderingfordeployvmwiththresholdcheckdisabledfile-cjavaprojectsapachecloudstackserversrctestjavacomcloudvmfirstfitplannertestjava">Test Case Name: <code>checkClusterReorderingForDeployVMWithThresholdCheckDisabled</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\vm\FirstFitPlannerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-avoids">Mock Object Variable Name: <code>avoids</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void checkClusterReorderingForDeployVMWithThresholdCheckDisabled() throws InsufficientServerCapacityException {
     VirtualMachineProfileImpl vmProfile = mock(VirtualMachineProfileImpl.class);
     DataCenterDeployment plan = mock(DataCenterDeployment.class);
<span class="hljs-deletion">-    ExcludeList avoids = mock(ExcludeList.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `avoids`</span>
     initializeForTest(vmProfile, plan, avoids);
     List&lt;Long&gt; clustersCrossingThreshold = initializeForClusterThresholdDisabled();
     Map&lt;String, String&gt; details = new HashMap&lt;String, String&gt;();
     details.put("deployvm", "true");
     when(vmDetailsDao.listDetailsKeyPairs(vmProfile.getVirtualMachine().getId())).thenReturn(details);
     List&lt;Long&gt; clusterList = planner.orderClusters(vmProfile, plan, avoids);
     assertTrue("Reordered cluster list have clusters exceeding threshold", (!clusterList.containsAll(clustersCrossingThreshold)));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">checkClusterReorderingForDeployVMWithThresholdCheckDisabled</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InsufficientServerCapacityException </span>{

    VirtualMachineProfileImpl vmProfile = mock(VirtualMachineProfileImpl<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DataCenterDeployment plan = mock(DataCenterDeployment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ExcludeList avoids = mock(ExcludeList<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    initializeForTest(vmProfile, plan, avoids);

    List&lt;Long&gt; clustersCrossingThreshold = initializeForClusterThresholdDisabled();

    Map&lt;String, String&gt; details = <span class="hljs-keyword">new</span> HashMap&lt;String, String&gt;();

    details.put(<span class="hljs-string">"deployvm"</span>, <span class="hljs-string">"true"</span>);

    when(vmDetailsDao.listDetailsKeyPairs(vmProfile.getVirtualMachine().getId())).thenReturn(details);

    List&lt;Long&gt; clusterList = planner.orderClusters(vmProfile, plan, avoids);

    assertTrue(<span class="hljs-string">"Reordered cluster list have clusters exceeding threshold"</span>, (!clusterList.containsAll(clustersCrossingThreshold)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> ExcludeList avoids;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    avoids = mock(ExcludeList<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// In each test method, replace:</span>
<span class="hljs-comment">//     ExcludeList avoids = mock(ExcludeList.class);</span>
<span class="hljs-comment">// with nothing (the field is initialized in setUp())</span>
<span class="hljs-comment">// and use the field 'avoids' directly.</span>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1193">Test Case ID #cloudstack_Test_119_3</h4>
<h4 id="test-case-name-checkclusterlistbasedonhosttagfile-cjavaprojectsapachecloudstackserversrctestjavacomcloudvmfirstfitplannertestjava">Test Case Name: <code>checkClusterListBasedOnHostTag</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\vm\FirstFitPlannerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-avoids">Mock Object Variable Name: <code>avoids</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void checkClusterListBasedOnHostTag() throws InsufficientServerCapacityException {
     VirtualMachineProfileImpl vmProfile = mock(VirtualMachineProfileImpl.class);
     DataCenterDeployment plan = mock(DataCenterDeployment.class);
<span class="hljs-deletion">-    ExcludeList avoids = mock(ExcludeList.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `avoids`</span>
     initializeForTest(vmProfile, plan, avoids);
     List&lt;Long&gt; matchingClusters = initializeForClusterListBasedOnHostTag(vmProfile.getServiceOffering());
     List&lt;Long&gt; clusterList = planner.orderClusters(vmProfile, plan, avoids);
     assertTrue("Reordered cluster list have clusters which has hosts with specified host tag on offering", (clusterList.containsAll(matchingClusters)));
     assertTrue("Reordered cluster list does not have clusters which don't have hosts with matching host tag on offering", (!clusterList.contains(2L)));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">checkClusterListBasedOnHostTag</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InsufficientServerCapacityException </span>{

    VirtualMachineProfileImpl vmProfile = mock(VirtualMachineProfileImpl<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DataCenterDeployment plan = mock(DataCenterDeployment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ExcludeList avoids = mock(ExcludeList<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    initializeForTest(vmProfile, plan, avoids);

    List&lt;Long&gt; matchingClusters = initializeForClusterListBasedOnHostTag(vmProfile.getServiceOffering());

    List&lt;Long&gt; clusterList = planner.orderClusters(vmProfile, plan, avoids);

    assertTrue(<span class="hljs-string">"Reordered cluster list have clusters which has hosts with specified host tag on offering"</span>, (clusterList.containsAll(matchingClusters)));

    assertTrue(<span class="hljs-string">"Reordered cluster list does not have clusters which don't have hosts with matching host tag on offering"</span>, (!clusterList.contains(<span class="hljs-number">2L</span>)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> ExcludeList avoids;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    avoids = mock(ExcludeList<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// In each test method, replace:</span>
<span class="hljs-comment">//     ExcludeList avoids = mock(ExcludeList.class);</span>
<span class="hljs-comment">// with nothing (the field is initialized in setUp())</span>
<span class="hljs-comment">// and use the field 'avoids' directly.</span>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1194">Test Case ID #cloudstack_Test_119_4</h4>
<h4 id="test-case-name-checkclusterreorderingforstartvmwiththresholdcheckdisabledfile-cjavaprojectsapachecloudstackserversrctestjavacomcloudvmfirstfitplannertestjava">Test Case Name: <code>checkClusterReorderingForStartVMWithThresholdCheckDisabled</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\vm\FirstFitPlannerTest.java</code>)</h4>
<h4 id="mock-object-variable-name-avoids">Mock Object Variable Name: <code>avoids</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void checkClusterReorderingForStartVMWithThresholdCheckDisabled() throws InsufficientServerCapacityException {
     VirtualMachineProfileImpl vmProfile = mock(VirtualMachineProfileImpl.class);
     DataCenterDeployment plan = mock(DataCenterDeployment.class);
<span class="hljs-deletion">-    ExcludeList avoids = mock(ExcludeList.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `avoids`</span>
     initializeForTest(vmProfile, plan, avoids);
     List&lt;Long&gt; clustersCrossingThreshold = initializeForClusterThresholdDisabled();
     List&lt;Long&gt; clusterList = planner.orderClusters(vmProfile, plan, avoids);
     assertTrue("Reordered cluster list does not have clusters exceeding threshold", (clusterList.containsAll(clustersCrossingThreshold)));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">checkClusterReorderingForStartVMWithThresholdCheckDisabled</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InsufficientServerCapacityException </span>{

    VirtualMachineProfileImpl vmProfile = mock(VirtualMachineProfileImpl<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DataCenterDeployment plan = mock(DataCenterDeployment<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ExcludeList avoids = mock(ExcludeList<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    initializeForTest(vmProfile, plan, avoids);

    List&lt;Long&gt; clustersCrossingThreshold = initializeForClusterThresholdDisabled();

    List&lt;Long&gt; clusterList = planner.orderClusters(vmProfile, plan, avoids);

    assertTrue(<span class="hljs-string">"Reordered cluster list does not have clusters exceeding threshold"</span>, (clusterList.containsAll(clustersCrossingThreshold)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> ExcludeList avoids;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    avoids = mock(ExcludeList<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}

<span class="hljs-comment">// In each test method, replace:</span>
<span class="hljs-comment">//     ExcludeList avoids = mock(ExcludeList.class);</span>
<span class="hljs-comment">// with nothing (the field is initialized in setUp())</span>
<span class="hljs-comment">// and use the field 'avoids' directly.</span>
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci120">Mock Clone Instance #cloudstack_MCI_120</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.cloudstack.framework.config.dao.ConfigurationDao</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div>
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest1201">Test Case ID #cloudstack_Test_120_1</h4>
<h4 id="test-case-name-applylbrulesaddrulesuccesstestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenservicetungstenelementtestjava">Test Case Name: <code>applyLBRulesAddRuleSuccessTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\service\TungstenElementTest.java</code>)</h4>
<h4 id="mock-object-variable-name-configdao">Mock Object Variable Name: <code>configDao</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     when(updateTungstenLoadBalancerListenerAnswer.getResult()).thenReturn(true);
     when(updateTungstenHealthMonitorAnswer.getResult()).thenReturn(true);
<span class="hljs-deletion">-    when(configDao.getValue(Config.NetworkLBHaproxyStatsVisbility.key())).thenReturn("enabled");</span>
<span class="hljs-addition">+    // replaced inline stub with helper method for configDao</span>
<span class="hljs-addition">+    configDao = MockConfigurationDao.createMockConfigurationDao("enabled");</span>
     when(tungstenService.updateLoadBalancer(any(), any())).thenReturn(true);
     when(lbDao.listByIpAddress(anyLong())).thenReturn(loadBalancerVOList);
     when(EncryptionUtil.generateSignature(anyString(), anyString())).thenReturn("generatedString");
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">applyLBRulesAddRuleSuccessTest</span><span class="hljs-params">()</span> </span>{

    User caller = mock(User<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Network publicNetwork = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Ip ip = mock(Ip<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    LoadBalancingRule loadBalancingRule1 = mock(LoadBalancingRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    LoadBalancerVMMapVO loadBalancerVMMapVO = mock(LoadBalancerVMMapVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    LoadBalancerVO loadBalancerVO = mock(LoadBalancerVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    LoadBalancingRule.LbStickinessPolicy lbStickinessPolicy = mock(LoadBalancingRule.LbStickinessPolicy<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;LoadBalancingRule&gt; loadBalancingRuleList1 = List.of(loadBalancingRule1);

    List&lt;LoadBalancerVMMapVO&gt; loadBalancerVMMapVOList = List.of(loadBalancerVMMapVO);

    List&lt;LoadBalancingRule.LbStickinessPolicy&gt; lbStickinessPolicyList = List.of(lbStickinessPolicy);

    List&lt;LoadBalancerVO&gt; loadBalancerVOList = List.of(loadBalancerVO);

    TungstenFabricLBHealthMonitorVO tungstenFabricLBHealthMonitorVO = mock(TungstenFabricLBHealthMonitorVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    IPAddressVO ipAddressVO = mock(IPAddressVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenGuestNetworkIpAddressVO tungstenGuestNetworkIpAddressVO = mock(TungstenGuestNetworkIpAddressVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenAnswer createTungstenNetworkLoadbalancerAnswer = mock(TungstenAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenAnswer updateTungstenLoadBalancerPoolAnswer = mock(TungstenAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenAnswer updateTungstenLoadBalancerMemberAnswer = mock(TungstenAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenAnswer updateTungstenLoadBalancerListenerAnswer = mock(TungstenAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenAnswer updateTungstenHealthMonitorAnswer = mock(TungstenAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    LoadBalancingRule.LbSslCert lbSslCert = mock(LoadBalancingRule.LbSslCert<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(lbStickinessPolicy.getMethodName()).thenReturn(<span class="hljs-string">"AppCookie"</span>);

    List&lt;Pair&lt;String, String&gt;&gt; pairList = List.of(<span class="hljs-keyword">new</span> Pair&lt;&gt;(<span class="hljs-string">"cookieName"</span>, <span class="hljs-string">"cookieValue"</span>));

    when(accountMgr.getActiveUser(anyLong())).thenReturn(caller);

    when(caller.getApiKey()).thenReturn(<span class="hljs-string">"apikey"</span>);

    when(caller.getSecretKey()).thenReturn(<span class="hljs-string">"secreatekey"</span>);

    when(lbStickinessPolicy.getParams()).thenReturn(pairList);

    when(loadBalancingRule1.getId()).thenReturn(<span class="hljs-number">1L</span>);

    when(loadBalancingRule1.getState()).thenReturn(FirewallRule.State.Add);

    when(loadBalancingRule1.getAlgorithm()).thenReturn(<span class="hljs-string">"roundrobin"</span>);

    when(loadBalancingRule1.getSourcePortStart()).thenReturn(<span class="hljs-number">443</span>);

    when(loadBalancingRule1.getDefaultPortStart()).thenReturn(<span class="hljs-number">443</span>);

    when(loadBalancingRule1.getStickinessPolicies()).thenReturn(lbStickinessPolicyList);

    when(loadBalancingRule1.getSourceIp()).thenReturn(ip);

    when(loadBalancingRule1.getLbSslCert()).thenReturn(lbSslCert);

    when(loadBalancingRule1.getUuid()).thenReturn(<span class="hljs-string">"loadbalancingruleuuid"</span>);

    when(networkModel.getSystemNetworkByZoneAndTrafficType(anyLong(), any())).thenReturn(publicNetwork);

    when(ipAddressDao.findByIpAndDcId(anyLong(), anyString())).thenReturn(ipAddressVO);

    when(ipAddressVO.getAddress()).thenReturn(ip);

    when(lbVmMapDao.listByLoadBalancerId(anyLong(), anyBoolean())).thenReturn(loadBalancerVMMapVOList);

    when(tungstenGuestNetworkIpAddressVO.getGuestIpAddress()).thenReturn(ip);

    when(ip.addr()).thenReturn(<span class="hljs-string">"10.10.10.10"</span>);

    when(tungstenGuestNetworkIpAddressDao.findByNetworkIdAndPublicIp(anyLong(), anyString())).thenReturn(tungstenGuestNetworkIpAddressVO);

    when(ipAddressMgr.acquireGuestIpAddress(any(), any())).thenReturn(<span class="hljs-string">"192.168.100.100"</span>);

    when(tungstenFabricUtils.sendTungstenCommand(any(CreateTungstenNetworkLoadbalancerCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">createTungstenNetworkLoadbalancerAnswer</span>)</span>;

    when(tungstenFabricUtils.sendTungstenCommand(any(UpdateTungstenLoadBalancerPoolCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">updateTungstenLoadBalancerPoolAnswer</span>)</span>;

    when(tungstenFabricUtils.sendTungstenCommand(any(UpdateTungstenLoadBalancerMemberCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">updateTungstenLoadBalancerMemberAnswer</span>)</span>;

    when(tungstenFabricUtils.sendTungstenCommand(any(UpdateTungstenLoadBalancerListenerCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">updateTungstenLoadBalancerListenerAnswer</span>)</span>;

    when(createTungstenNetworkLoadbalancerAnswer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(updateTungstenLoadBalancerPoolAnswer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(updateTungstenLoadBalancerMemberAnswer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(updateTungstenLoadBalancerListenerAnswer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(updateTungstenHealthMonitorAnswer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(configDao.getValue(Config.NetworkLBHaproxyStatsVisbility.key())).thenReturn(<span class="hljs-string">"enabled"</span>);

    when(tungstenService.updateLoadBalancer(any(), any())).thenReturn(<span class="hljs-keyword">true</span>);

    when(lbDao.listByIpAddress(anyLong())).thenReturn(loadBalancerVOList);

    when(EncryptionUtil.generateSignature(anyString(), anyString())).thenReturn(<span class="hljs-string">"generatedString"</span>);

    when(tungstenFabricLBHealthMonitorDao.findByLbId(anyLong())).thenReturn(tungstenFabricLBHealthMonitorVO);

    when(tungstenFabricUtils.sendTungstenCommand(any(UpdateTungstenLoadBalancerHealthMonitorCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">updateTungstenHealthMonitorAnswer</span>)</span>;

    assertTrue(tungstenElement.applyLBRules(network, loadBalancingRuleList1));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1202">Test Case ID #cloudstack_Test_120_2</h4>
<h4 id="test-case-name-applylbrulesaddrulefailtestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenservicetungstenelementtestjava">Test Case Name: <code>applyLBRulesAddRuleFailTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\service\TungstenElementTest.java</code>)</h4>
<h4 id="mock-object-variable-name-configdao">Mock Object Variable Name: <code>configDao</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     when(updateTungstenLoadBalancerMemberAnswer.getResult()).thenReturn(true);
<span class="hljs-deletion">-    when(configDao.getValue(Config.NetworkLBHaproxyStatsVisbility.key())).thenReturn("disabled");</span>
<span class="hljs-addition">+    // replaced inline stub with helper method for configDao</span>
<span class="hljs-addition">+    configDao = MockConfigurationDao.createMockConfigurationDao("disabled");</span>
     when(tungstenService.updateLoadBalancerSsl(any(), any())).thenReturn(false);
     when(lbDao.listByIpAddress(anyLong())).thenReturn(loadBalancerVOList);
     when(tungstenFabricLBHealthMonitorDao.findByLbId(anyLong())).thenReturn(tungstenFabricLBHealthMonitorVO);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">applyLBRulesAddRuleFailTest</span><span class="hljs-params">()</span> </span>{

    Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Network publicNetwork = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Ip ip = mock(Ip<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    LoadBalancingRule loadBalancingRule1 = mock(LoadBalancingRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    LoadBalancerVMMapVO loadBalancerVMMapVO = mock(LoadBalancerVMMapVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    LoadBalancerVO loadBalancerVO = mock(LoadBalancerVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    LoadBalancingRule.LbStickinessPolicy lbStickinessPolicy = mock(LoadBalancingRule.LbStickinessPolicy<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;LoadBalancingRule&gt; loadBalancingRuleList1 = List.of(loadBalancingRule1);

    List&lt;LoadBalancerVMMapVO&gt; loadBalancerVMMapVOList = List.of(loadBalancerVMMapVO);

    List&lt;LoadBalancingRule.LbStickinessPolicy&gt; lbStickinessPolicyList = List.of(lbStickinessPolicy);

    List&lt;LoadBalancerVO&gt; loadBalancerVOList = List.of(loadBalancerVO);

    IPAddressVO ipAddressVO = mock(IPAddressVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenGuestNetworkIpAddressVO tungstenGuestNetworkIpAddressVO = mock(TungstenGuestNetworkIpAddressVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenAnswer createTungstenNetworkLoadbalancerAnswer = mock(TungstenAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenAnswer updateTungstenLoadBalancerPoolAnswer = mock(TungstenAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenAnswer updateTungstenLoadBalancerMemberAnswer = mock(TungstenAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenAnswer updateTungstenHealthMonitorAnswer = mock(TungstenAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    List&lt;Pair&lt;String, String&gt;&gt; pairList = List.of(<span class="hljs-keyword">new</span> Pair&lt;&gt;(<span class="hljs-string">"cookieName"</span>, <span class="hljs-string">"cookieValue"</span>));

    TungstenFabricLBHealthMonitorVO tungstenFabricLBHealthMonitorVO = mock(TungstenFabricLBHealthMonitorVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(lbStickinessPolicy.getMethodName()).thenReturn(<span class="hljs-string">"AppCookie"</span>);

    when(lbStickinessPolicy.getParams()).thenReturn(pairList);

    when(loadBalancingRule1.getId()).thenReturn(<span class="hljs-number">1L</span>);

    when(loadBalancingRule1.getState()).thenReturn(FirewallRule.State.Add);

    when(loadBalancingRule1.getAlgorithm()).thenReturn(<span class="hljs-string">"roundrobin"</span>);

    when(loadBalancingRule1.getSourcePortStart()).thenReturn(<span class="hljs-number">80</span>);

    when(loadBalancingRule1.getDefaultPortStart()).thenReturn(<span class="hljs-number">443</span>);

    when(loadBalancingRule1.getStickinessPolicies()).thenReturn(lbStickinessPolicyList);

    when(loadBalancingRule1.getSourceIp()).thenReturn(ip);

    when(networkModel.getSystemNetworkByZoneAndTrafficType(anyLong(), any())).thenReturn(publicNetwork);

    when(ipAddressDao.findByIpAndDcId(anyLong(), anyString())).thenReturn(ipAddressVO);

    when(ipAddressVO.getAddress()).thenReturn(ip);

    when(lbVmMapDao.listByLoadBalancerId(anyLong(), anyBoolean())).thenReturn(loadBalancerVMMapVOList);

    when(tungstenGuestNetworkIpAddressVO.getGuestIpAddress()).thenReturn(ip);

    when(ip.addr()).thenReturn(<span class="hljs-string">"10.10.10.10"</span>);

    when(ipAddressMgr.acquireGuestIpAddress(any(), any())).thenReturn(<span class="hljs-string">"192.168.100.100"</span>);

    when(tungstenFabricUtils.sendTungstenCommand(any(CreateTungstenNetworkLoadbalancerCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">createTungstenNetworkLoadbalancerAnswer</span>)</span>;

    when(tungstenFabricUtils.sendTungstenCommand(any(UpdateTungstenLoadBalancerPoolCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">updateTungstenLoadBalancerPoolAnswer</span>)</span>;

    when(tungstenFabricUtils.sendTungstenCommand(any(UpdateTungstenLoadBalancerMemberCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">updateTungstenLoadBalancerMemberAnswer</span>)</span>;

    when(createTungstenNetworkLoadbalancerAnswer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(updateTungstenLoadBalancerPoolAnswer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(updateTungstenLoadBalancerMemberAnswer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(configDao.getValue(Config.NetworkLBHaproxyStatsVisbility.key())).thenReturn(<span class="hljs-string">"disabled"</span>);

    when(tungstenService.updateLoadBalancerSsl(any(), any())).thenReturn(<span class="hljs-keyword">false</span>);

    when(lbDao.listByIpAddress(anyLong())).thenReturn(loadBalancerVOList);

    when(tungstenFabricLBHealthMonitorDao.findByLbId(anyLong())).thenReturn(tungstenFabricLBHealthMonitorVO);

    when(updateTungstenHealthMonitorAnswer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(tungstenFabricUtils.sendTungstenCommand(any(UpdateTungstenLoadBalancerHealthMonitorCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">updateTungstenHealthMonitorAnswer</span>)</span>;

    assertFalse(tungstenElement.applyLBRules(network, loadBalancingRuleList1));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1203">Test Case ID #cloudstack_Test_120_3</h4>
<h4 id="test-case-name-updateloadbalancertestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementstungstensrctestjavaorgapachecloudstacknetworktungstenservicetungstenserviceimpltestjava">Test Case Name: <code>updateLoadBalancerTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\tungsten\src\test\java\org\apache\cloudstack\network\tungsten\service\TungstenServiceImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-configdao">Mock Object Variable Name: <code>configDao</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     when(updateTungstenLoadbalancerSslAnswer.getResult()).thenReturn(true);
<span class="hljs-deletion">-    when(configDao.getValue(Config.NetworkLBHaproxyStatsVisbility.key())).thenReturn("enabled");</span>
<span class="hljs-addition">+    // replaced inline stub with helper method for configDao</span>
<span class="hljs-addition">+    configDao = MockConfigurationDao.createMockConfigurationDao("enabled");</span>
     when(fwRulesDao.listByIpAndPurposeAndNotRevoked(anyLong(), eq(FirewallRule.Purpose.LoadBalancing))).thenReturn(List.of(firewallRuleVO));
     when(lbCertMapDao.findByLbRuleId(anyLong())).thenReturn(loadBalancerCertMapVO);
     when(entityMgr.findById(eq(SslCertVO.class), anyLong())).thenReturn(sslCertVO);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateLoadBalancerTest</span><span class="hljs-params">()</span> </span>{

    Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    LoadBalancingRule loadBalancingRule = mock(LoadBalancingRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Network publicNetwork = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    IPAddressVO ipAddressVO = mock(IPAddressVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    HostVO hostVO = mock(HostVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenAnswer getTungstenLoadBalancerAnswer = mock(TungstenAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenAnswer updateLoadBalancerServiceInstanceAnswer = mock(TungstenAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Answer updateTungstenLoadbalancerStatsAnswer = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Answer updateTungstenLoadbalancerSslAnswer = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    FirewallRuleVO firewallRuleVO = mock(FirewallRuleVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    LoadBalancerCertMapVO loadBalancerCertMapVO = mock(LoadBalancerCertMapVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    SslCertVO sslCertVO = mock(SslCertVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    TungstenGuestNetworkIpAddressVO tungstenGuestNetworkIpAddressVO = mock(TungstenGuestNetworkIpAddressVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Ip ip = mock(Ip<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AccountVO accountVO = mock(AccountVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Loadbalancer loadbalancer = mock(Loadbalancer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(networkModel.getSystemNetworkByZoneAndTrafficType(anyLong(), eq(Networks.TrafficType.Public))).thenReturn(publicNetwork);

    when(ipAddressDao.findByIpAndDcId(anyLong(), anyString())).thenReturn(ipAddressVO);

    when(hostDao.listAllHostsByZoneAndHypervisorType(anyLong(), eq(Hypervisor.HypervisorType.KVM))).thenReturn(List.of(hostVO));

    when(tungstenFabricUtils.sendTungstenCommand(any(GetTungstenLoadBalancerCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">getTungstenLoadBalancerAnswer</span>)</span>;

    when(tungstenFabricUtils.sendTungstenCommand(any(UpdateLoadBalancerServiceInstanceCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">updateLoadBalancerServiceInstanceAnswer</span>)</span>;

    when(agentMgr.easySend(anyLong(), any(UpdateTungstenLoadbalancerStatsCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">updateTungstenLoadbalancerStatsAnswer</span>)</span>;

    when(agentMgr.easySend(anyLong(), any(UpdateTungstenLoadbalancerSslCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">updateTungstenLoadbalancerSslAnswer</span>)</span>;

    when(getTungstenLoadBalancerAnswer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(updateLoadBalancerServiceInstanceAnswer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(updateTungstenLoadbalancerStatsAnswer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(updateTungstenLoadbalancerSslAnswer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(configDao.getValue(Config.NetworkLBHaproxyStatsVisbility.key())).thenReturn(<span class="hljs-string">"enabled"</span>);

    when(fwRulesDao.listByIpAndPurposeAndNotRevoked(anyLong(), eq(FirewallRule.Purpose.LoadBalancing))).thenReturn(List.of(firewallRuleVO));

    when(lbCertMapDao.findByLbRuleId(anyLong())).thenReturn(loadBalancerCertMapVO);

    when(entityMgr.findById(eq(SslCertVO<span class="hljs-class">.<span class="hljs-keyword">class</span>), <span class="hljs-title">anyLong</span>())).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">sslCertVO</span>)</span>;

    when(tungstenGuestNetworkIpAddressDao.findByNetworkIdAndPublicIp(anyLong(), anyString())).thenReturn(tungstenGuestNetworkIpAddressVO);

    when(loadBalancingRule.getSourceIp()).thenReturn(ip);

    when(accountDao.findById(anyLong())).thenReturn(accountVO);

    when(ip.addr()).thenReturn(<span class="hljs-string">"192.168.100.100"</span>);

    when(getTungstenLoadBalancerAnswer.getApiObjectBase()).thenReturn(loadbalancer);

    when(ipAddressVO.getAddress()).thenReturn(ip);

    when(tungstenGuestNetworkIpAddressVO.getGuestIpAddress()).thenReturn(ip);

    assertTrue(tungstenService.updateLoadBalancer(network, loadBalancingRule));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci121">Mock Clone Instance #cloudstack_MCI_121</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>org.apache.cloudstack.engine.subsystem.api.storage.DataObject</code></li>
<li><strong>Test Case Count</strong>: 1</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div>
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest1211">Test Case ID #cloudstack_Test_121_1</h4>
<h4 id="test-case-name-testmixzoneprimarystoragesfile-cjavaprojectsapachecloudstackenginestorageintegration-testsrctestjavaorgapachecloudstackstoragetestendpointselectortestjava">Test Case Name: <code>testMixZonePrimaryStorages</code>(File: <code>C:\Java_projects\Apache\cloudstack\engine\storage\integration-test\src\test\java\org\apache\cloudstack\storage\test\EndpointSelectorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-srcobj">Mock Object Variable Name: <code>srcObj</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     when(destStore.getScope()).thenReturn(srcScope);
     when(destStore.getRole()).thenReturn(DataStoreRole.Image);
     when(destStore.getId()).thenReturn(destStoreId);
<span class="hljs-deletion">-    DataObject srcObj = mock(DataObject.class);</span>
<span class="hljs-deletion">-    DataObject destObj = mock(DataObject.class);</span>
<span class="hljs-deletion">-    when(srcObj.getDataStore()).thenReturn(srcStore);</span>
<span class="hljs-deletion">-    when(destObj.getDataStore()).thenReturn(destStore);</span>
<span class="hljs-addition">+    DataObject srcObj = createMockDataObject(srcStore);</span>
<span class="hljs-addition">+    DataObject destObj = createMockDataObject(destStore);</span>
     EndPoint ep = endPointSelector.select(srcObj, destObj);
     Assert.assertTrue(ep != null);
     Long hostId = ep.getId();
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMixZonePrimaryStorages</span><span class="hljs-params">()</span> </span>{

    Long srcStoreId = <span class="hljs-keyword">null</span>;

    Long destStoreId = imageStore.getId();

    DataStore store = createPrimaryDataStore(ScopeType.ZONE);

    srcStoreId = store.getId();

    HostVO host = createHost(Hypervisor.HypervisorType.VMware);

    addStorageToHost(store, host);

    store = createPrimaryDataStore(ScopeType.ZONE);

    host = createHost(Hypervisor.HypervisorType.VMware);

    addStorageToHost(store, host);

    Long xenStoreId = <span class="hljs-keyword">null</span>;

    store = createPrimaryDataStore(ScopeType.CLUSTER);

    xenStoreId = store.getId();

    host = createHost(Hypervisor.HypervisorType.XenServer);

    addStorageToHost(store, host);

    store = createPrimaryDataStore(ScopeType.CLUSTER);

    host = createHost(Hypervisor.HypervisorType.XenServer);

    addStorageToHost(store, host);

    ZoneScope srcScope = <span class="hljs-keyword">new</span> ZoneScope(dcId);

    DataStore srcStore = mock(DataStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DataStore destStore = mock(DataStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(srcStore.getScope()).thenReturn(srcScope);

    when(srcStore.getRole()).thenReturn(DataStoreRole.Primary);

    when(srcStore.getId()).thenReturn(srcStoreId);

    when(destStore.getScope()).thenReturn(srcScope);

    when(destStore.getRole()).thenReturn(DataStoreRole.Image);

    when(destStore.getId()).thenReturn(destStoreId);

    DataObject srcObj = mock(DataObject<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DataObject destObj = mock(DataObject<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(srcObj.getDataStore()).thenReturn(srcStore);

    when(destObj.getDataStore()).thenReturn(destStore);

    EndPoint ep = endPointSelector.select(srcObj, destObj);

    Assert.assertTrue(ep != <span class="hljs-keyword">null</span>);

    Long hostId = ep.getId();

    HostVO newHost = hostDao.findById(hostId);

    Assert.assertTrue(newHost.getHypervisorType() == Hypervisor.HypervisorType.VMware);

    when(srcStore.getRole()).thenReturn(DataStoreRole.Image);

    when(srcStore.getId()).thenReturn(destStoreId);

    when(destStore.getId()).thenReturn(srcStoreId);

    when(destStore.getRole()).thenReturn(DataStoreRole.Primary);

    ep = endPointSelector.select(srcObj, destObj);

    Assert.assertTrue(ep != <span class="hljs-keyword">null</span>);

    hostId = ep.getId();

    newHost = hostDao.findById(hostId);

    Assert.assertTrue(newHost.getHypervisorType() == Hypervisor.HypervisorType.VMware);

    ClusterScope clusterScope = <span class="hljs-keyword">new</span> ClusterScope(clusterId, podId, dcId);

    when(srcStore.getRole()).thenReturn(DataStoreRole.Primary);

    when(srcStore.getScope()).thenReturn(clusterScope);

    when(srcStore.getId()).thenReturn(xenStoreId);

    ep = endPointSelector.select(srcStore);

    Assert.assertTrue(ep != <span class="hljs-keyword">null</span>);

    newHost = hostDao.findById(ep.getId());

    Assert.assertTrue(newHost.getHypervisorType() == Hypervisor.HypervisorType.XenServer);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1212">Test Case ID #cloudstack_Test_121_2</h4>
<h4 id="test-case-name-testmixzoneprimarystoragesfile-cjavaprojectsapachecloudstackenginestorageintegration-testsrctestjavaorgapachecloudstackstoragetestendpointselectortestjava">Test Case Name: <code>testMixZonePrimaryStorages</code>(File: <code>C:\Java_projects\Apache\cloudstack\engine\storage\integration-test\src\test\java\org\apache\cloudstack\storage\test\EndpointSelectorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-destobj">Mock Object Variable Name: <code>destObj</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     when(destStore.getScope()).thenReturn(srcScope);
     when(destStore.getRole()).thenReturn(DataStoreRole.Image);
     when(destStore.getId()).thenReturn(destStoreId);
<span class="hljs-deletion">-    DataObject srcObj = mock(DataObject.class);</span>
<span class="hljs-deletion">-    DataObject destObj = mock(DataObject.class);</span>
<span class="hljs-deletion">-    when(srcObj.getDataStore()).thenReturn(srcStore);</span>
<span class="hljs-deletion">-    when(destObj.getDataStore()).thenReturn(destStore);</span>
<span class="hljs-addition">+    DataObject srcObj = createMockDataObject(srcStore);</span>
<span class="hljs-addition">+    DataObject destObj = createMockDataObject(destStore);</span>
     EndPoint ep = endPointSelector.select(srcObj, destObj);
     Assert.assertTrue(ep != null);
     Long hostId = ep.getId();
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMixZonePrimaryStorages</span><span class="hljs-params">()</span> </span>{

    Long srcStoreId = <span class="hljs-keyword">null</span>;

    Long destStoreId = imageStore.getId();

    DataStore store = createPrimaryDataStore(ScopeType.ZONE);

    srcStoreId = store.getId();

    HostVO host = createHost(Hypervisor.HypervisorType.VMware);

    addStorageToHost(store, host);

    store = createPrimaryDataStore(ScopeType.ZONE);

    host = createHost(Hypervisor.HypervisorType.VMware);

    addStorageToHost(store, host);

    Long xenStoreId = <span class="hljs-keyword">null</span>;

    store = createPrimaryDataStore(ScopeType.CLUSTER);

    xenStoreId = store.getId();

    host = createHost(Hypervisor.HypervisorType.XenServer);

    addStorageToHost(store, host);

    store = createPrimaryDataStore(ScopeType.CLUSTER);

    host = createHost(Hypervisor.HypervisorType.XenServer);

    addStorageToHost(store, host);

    ZoneScope srcScope = <span class="hljs-keyword">new</span> ZoneScope(dcId);

    DataStore srcStore = mock(DataStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DataStore destStore = mock(DataStore<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(srcStore.getScope()).thenReturn(srcScope);

    when(srcStore.getRole()).thenReturn(DataStoreRole.Primary);

    when(srcStore.getId()).thenReturn(srcStoreId);

    when(destStore.getScope()).thenReturn(srcScope);

    when(destStore.getRole()).thenReturn(DataStoreRole.Image);

    when(destStore.getId()).thenReturn(destStoreId);

    DataObject srcObj = mock(DataObject<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    DataObject destObj = mock(DataObject<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(srcObj.getDataStore()).thenReturn(srcStore);

    when(destObj.getDataStore()).thenReturn(destStore);

    EndPoint ep = endPointSelector.select(srcObj, destObj);

    Assert.assertTrue(ep != <span class="hljs-keyword">null</span>);

    Long hostId = ep.getId();

    HostVO newHost = hostDao.findById(hostId);

    Assert.assertTrue(newHost.getHypervisorType() == Hypervisor.HypervisorType.VMware);

    when(srcStore.getRole()).thenReturn(DataStoreRole.Image);

    when(srcStore.getId()).thenReturn(destStoreId);

    when(destStore.getId()).thenReturn(srcStoreId);

    when(destStore.getRole()).thenReturn(DataStoreRole.Primary);

    ep = endPointSelector.select(srcObj, destObj);

    Assert.assertTrue(ep != <span class="hljs-keyword">null</span>);

    hostId = ep.getId();

    newHost = hostDao.findById(hostId);

    Assert.assertTrue(newHost.getHypervisorType() == Hypervisor.HypervisorType.VMware);

    ClusterScope clusterScope = <span class="hljs-keyword">new</span> ClusterScope(clusterId, podId, dcId);

    when(srcStore.getRole()).thenReturn(DataStoreRole.Primary);

    when(srcStore.getScope()).thenReturn(clusterScope);

    when(srcStore.getId()).thenReturn(xenStoreId);

    ep = endPointSelector.select(srcStore);

    Assert.assertTrue(ep != <span class="hljs-keyword">null</span>);

    newHost = hostDao.findById(ep.getId());

    Assert.assertTrue(newHost.getHypervisorType() == Hypervisor.HypervisorType.XenServer);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div>
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci122">Mock Clone Instance #cloudstack_MCI_122</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>StorageLayer</code></li>
<li><strong>Test Case Count</strong>: 6</li>
<li><strong>MO Count</strong>: 6</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockStorageLayer</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock StorageLayer with stubbed exists and getSize methods.
     *
     * <span class="hljs-doctag">@param</span> mockStorageLayer the mock instance to stub
     * <span class="hljs-doctag">@param</span> existsReturn the boolean value to return from exists()
     * <span class="hljs-doctag">@param</span> getSizeReturn the long value to return from getSize()
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stubExistsAndGetSize</span><span class="hljs-params">(StorageLayer mockStorageLayer, <span class="hljs-keyword">boolean</span> existsReturn, <span class="hljs-keyword">long</span> getSizeReturn)</span> </span>{
        Mockito.when(mockStorageLayer.exists(Mockito.anyString())).thenReturn(existsReturn);
        Mockito.when(mockStorageLayer.getSize(Mockito.anyString())).thenReturn(getSizeReturn);
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest1221">Test Case ID #cloudstack_Test_122_1</h4>
<h4 id="test-case-name-testprocesswhenvirtualsizethrowsexceptionfile-cjavaprojectsapachecloudstackcoresrctestjavacomcloudstoragetemplateovaprocessortestjava">Test Case Name: <code>testProcessWhenVirtualSizeThrowsException</code>(File: <code>C:\Java_projects\Apache\cloudstack\core\src\test\java\com\cloud\storage\template\OVAProcessorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockstoragelayer">Mock Object Variable Name: <code>mockStorageLayer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test(expected = InternalErrorException.class)
 public void testProcessWhenVirtualSizeThrowsException() throws Exception {
     String templatePath = "/tmp";
     String templateName = "template";
<span class="hljs-deletion">-    Mockito.when(mockStorageLayer.exists(Mockito.anyString())).thenReturn(true);</span>
<span class="hljs-deletion">-    Mockito.when(mockStorageLayer.getSize(Mockito.anyString())).thenReturn(1000l);</span>
<span class="hljs-addition">+    mockStorageLayer = MockStorageLayer.createMockStorageLayer(true, 1000L);</span>
     Mockito.doThrow(new InternalErrorException("virtual size calculation failed")).when(processor).getTemplateVirtualSize(Mockito.anyString(), Mockito.anyString());
     Script mockScript = Mockito.mock(Script.class);
     PowerMockito.whenNew(Script.class).withAnyArguments().thenReturn(mockScript);
     PowerMockito.when(mockScript.execute()).thenReturn(null);
     processor.process(templatePath, null, templateName);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>(expected = InternalErrorException<span class="hljs-class">.<span class="hljs-keyword">class</span>)

<span class="hljs-title">public</span> <span class="hljs-title">void</span> <span class="hljs-title">testProcessWhenVirtualSizeThrowsException</span>() <span class="hljs-title">throws</span> <span class="hljs-title">Exception</span> </span>{

    String templatePath = <span class="hljs-string">"/tmp"</span>;

    String templateName = <span class="hljs-string">"template"</span>;

    Mockito.when(mockStorageLayer.exists(Mockito.anyString())).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(mockStorageLayer.getSize(Mockito.anyString())).thenReturn(<span class="hljs-number">1000l</span>);

    Mockito.doThrow(<span class="hljs-keyword">new</span> InternalErrorException(<span class="hljs-string">"virtual size calculation failed"</span>)).when(processor).getTemplateVirtualSize(Mockito.anyString(), Mockito.anyString());

    Script mockScript = Mockito.mock(Script<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    PowerMockito.whenNew(Script<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">withAnyArguments</span>().<span class="hljs-title">thenReturn</span>(<span class="hljs-title">mockScript</span>)</span>;

    PowerMockito.when(mockScript.execute()).thenReturn(<span class="hljs-keyword">null</span>);

    processor.process(templatePath, <span class="hljs-keyword">null</span>, templateName);

}
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    processor = PowerMockito.spy(<span class="hljs-keyword">new</span> OVAProcessor());

    Map&lt;String, Object&gt; params = <span class="hljs-keyword">new</span> HashMap&lt;String, Object&gt;();

    params.put(StorageLayer.InstanceConfigKey, mockStorageLayer);

    processor.configure(<span class="hljs-string">"OVA Processor"</span>, params);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockStorageLayer</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock StorageLayer with stubbed exists and getSize methods.
     *
     * <span class="hljs-doctag">@param</span> mockStorageLayer the mock instance to stub
     * <span class="hljs-doctag">@param</span> existsReturn the boolean value to return from exists()
     * <span class="hljs-doctag">@param</span> getSizeReturn the long value to return from getSize()
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stubExistsAndGetSize</span><span class="hljs-params">(StorageLayer mockStorageLayer, <span class="hljs-keyword">boolean</span> existsReturn, <span class="hljs-keyword">long</span> getSizeReturn)</span> </span>{
        Mockito.when(mockStorageLayer.exists(Mockito.anyString())).thenReturn(existsReturn);
        Mockito.when(mockStorageLayer.getSize(Mockito.anyString())).thenReturn(getSizeReturn);
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1222">Test Case ID #cloudstack_Test_122_2</h4>
<h4 id="test-case-name-testprocessfile-cjavaprojectsapachecloudstackcoresrctestjavacomcloudstoragetemplateovaprocessortestjava">Test Case Name: <code>testProcess</code>(File: <code>C:\Java_projects\Apache\cloudstack\core\src\test\java\com\cloud\storage\template\OVAProcessorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockstoragelayer">Mock Object Variable Name: <code>mockStorageLayer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testProcess() throws Exception {
     String templatePath = "/tmp";
     String templateName = "template";
     long virtualSize = 2000;
     long actualSize = 1000;
<span class="hljs-deletion">-    Mockito.when(mockStorageLayer.exists(Mockito.anyString())).thenReturn(true);</span>
<span class="hljs-deletion">-    Mockito.when(mockStorageLayer.getSize(Mockito.anyString())).thenReturn(actualSize);</span>
<span class="hljs-addition">+    mockStorageLayer = MockStorageLayer.createMockStorageLayer(true, actualSize);</span>
     Mockito.doReturn(virtualSize).when(processor).getTemplateVirtualSize(Mockito.anyString(), Mockito.anyString());
     Script mockScript = Mockito.mock(Script.class);
     PowerMockito.whenNew(Script.class).withAnyArguments().thenReturn(mockScript);
     PowerMockito.when(mockScript.execute()).thenReturn(null);
     Processor.FormatInfo info = processor.process(templatePath, null, templateName);
     Assert.assertEquals(Storage.ImageFormat.OVA, info.format);
     Assert.assertEquals("actual size:", actualSize, info.size);
     Assert.assertEquals("virtual size:", virtualSize, info.virtualSize);
     Assert.assertEquals("template name:", templateName + ".ova", info.filename);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    processor = PowerMockito.spy(<span class="hljs-keyword">new</span> OVAProcessor());

    Map&lt;String, Object&gt; params = <span class="hljs-keyword">new</span> HashMap&lt;String, Object&gt;();

    params.put(StorageLayer.InstanceConfigKey, mockStorageLayer);

    processor.configure(<span class="hljs-string">"OVA Processor"</span>, params);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcess</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String templatePath = <span class="hljs-string">"/tmp"</span>;

    String templateName = <span class="hljs-string">"template"</span>;

    <span class="hljs-keyword">long</span> virtualSize = <span class="hljs-number">2000</span>;

    <span class="hljs-keyword">long</span> actualSize = <span class="hljs-number">1000</span>;

    Mockito.when(mockStorageLayer.exists(Mockito.anyString())).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(mockStorageLayer.getSize(Mockito.anyString())).thenReturn(actualSize);

    Mockito.doReturn(virtualSize).when(processor).getTemplateVirtualSize(Mockito.anyString(), Mockito.anyString());

    Script mockScript = Mockito.mock(Script<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    PowerMockito.whenNew(Script<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">withAnyArguments</span>().<span class="hljs-title">thenReturn</span>(<span class="hljs-title">mockScript</span>)</span>;

    PowerMockito.when(mockScript.execute()).thenReturn(<span class="hljs-keyword">null</span>);

    Processor.FormatInfo info = processor.process(templatePath, <span class="hljs-keyword">null</span>, templateName);

    Assert.assertEquals(Storage.ImageFormat.OVA, info.format);

    Assert.assertEquals(<span class="hljs-string">"actual size:"</span>, actualSize, info.size);

    Assert.assertEquals(<span class="hljs-string">"virtual size:"</span>, virtualSize, info.virtualSize);

    Assert.assertEquals(<span class="hljs-string">"template name:"</span>, templateName + <span class="hljs-string">".ova"</span>, info.filename);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockStorageLayer</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock StorageLayer with stubbed exists and getSize methods.
     *
     * <span class="hljs-doctag">@param</span> mockStorageLayer the mock instance to stub
     * <span class="hljs-doctag">@param</span> existsReturn the boolean value to return from exists()
     * <span class="hljs-doctag">@param</span> getSizeReturn the long value to return from getSize()
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stubExistsAndGetSize</span><span class="hljs-params">(StorageLayer mockStorageLayer, <span class="hljs-keyword">boolean</span> existsReturn, <span class="hljs-keyword">long</span> getSizeReturn)</span> </span>{
        Mockito.when(mockStorageLayer.exists(Mockito.anyString())).thenReturn(existsReturn);
        Mockito.when(mockStorageLayer.getSize(Mockito.anyString())).thenReturn(getSizeReturn);
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1223">Test Case ID #cloudstack_Test_122_3</h4>
<h4 id="test-case-name-testprocesswhenvirtualsizethrowsexceptionfile-cjavaprojectsapachecloudstackcoresrctestjavacomcloudstoragetemplateqcow2processortestjava">Test Case Name: <code>testProcessWhenVirtualSizeThrowsException</code>(File: <code>C:\Java_projects\Apache\cloudstack\core\src\test\java\com\cloud\storage\template\QCOW2ProcessorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockstoragelayer">Mock Object Variable Name: <code>mockStorageLayer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test(expected = InternalErrorException.class)
 public void testProcessWhenVirtualSizeThrowsException() throws Exception {
     String templatePath = "/tmp";
     String templateName = "template";
<span class="hljs-deletion">-    Mockito.when(mockStorageLayer.exists(Mockito.anyString())).thenReturn(true);</span>
     File mockFile = Mockito.mock(File.class);
     Mockito.when(mockStorageLayer.getFile(Mockito.anyString())).thenReturn(mockFile);
<span class="hljs-deletion">-    Mockito.when(mockStorageLayer.getSize(Mockito.anyString())).thenReturn(1000L);</span>
<span class="hljs-addition">+    mockStorageLayer = MockStorageLayer.createMockStorageLayer(true, 1000L);</span>
     Mockito.doThrow(new IOException("virtual size calculation failed")).when(processor).getTemplateVirtualSize((File) Mockito.any());
     processor.process(templatePath, null, templateName);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>(expected = InternalErrorException<span class="hljs-class">.<span class="hljs-keyword">class</span>)

<span class="hljs-title">public</span> <span class="hljs-title">void</span> <span class="hljs-title">testProcessWhenVirtualSizeThrowsException</span>() <span class="hljs-title">throws</span> <span class="hljs-title">Exception</span> </span>{

    String templatePath = <span class="hljs-string">"/tmp"</span>;

    String templateName = <span class="hljs-string">"template"</span>;

    Mockito.when(mockStorageLayer.exists(Mockito.anyString())).thenReturn(<span class="hljs-keyword">true</span>);

    File mockFile = Mockito.mock(File<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(mockStorageLayer.getFile(Mockito.anyString())).thenReturn(mockFile);

    Mockito.when(mockStorageLayer.getSize(Mockito.anyString())).thenReturn(<span class="hljs-number">1000L</span>);

    Mockito.doThrow(<span class="hljs-keyword">new</span> IOException(<span class="hljs-string">"virtual size calculation failed"</span>)).when(processor).getTemplateVirtualSize((File) Mockito.any());

    processor.process(templatePath, <span class="hljs-keyword">null</span>, templateName);

}
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    processor = Mockito.spy(<span class="hljs-keyword">new</span> QCOW2Processor());

    Map&lt;String, Object&gt; params = <span class="hljs-keyword">new</span> HashMap&lt;String, Object&gt;();

    params.put(StorageLayer.InstanceConfigKey, mockStorageLayer);

    processor.configure(<span class="hljs-string">"VHD Processor"</span>, params);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockStorageLayer</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock StorageLayer with stubbed exists and getSize methods.
     *
     * <span class="hljs-doctag">@param</span> mockStorageLayer the mock instance to stub
     * <span class="hljs-doctag">@param</span> existsReturn the boolean value to return from exists()
     * <span class="hljs-doctag">@param</span> getSizeReturn the long value to return from getSize()
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stubExistsAndGetSize</span><span class="hljs-params">(StorageLayer mockStorageLayer, <span class="hljs-keyword">boolean</span> existsReturn, <span class="hljs-keyword">long</span> getSizeReturn)</span> </span>{
        Mockito.when(mockStorageLayer.exists(Mockito.anyString())).thenReturn(existsReturn);
        Mockito.when(mockStorageLayer.getSize(Mockito.anyString())).thenReturn(getSizeReturn);
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1224">Test Case ID #cloudstack_Test_122_4</h4>
<h4 id="test-case-name-testprocessfile-cjavaprojectsapachecloudstackcoresrctestjavacomcloudstoragetemplateqcow2processortestjava">Test Case Name: <code>testProcess</code>(File: <code>C:\Java_projects\Apache\cloudstack\core\src\test\java\com\cloud\storage\template\QCOW2ProcessorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockstoragelayer">Mock Object Variable Name: <code>mockStorageLayer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testProcess() throws Exception {
     String templatePath = "/tmp";
     String templateName = "template";
     long virtualSize = 2000;
     long actualSize = 1000;
<span class="hljs-deletion">-    Mockito.when(mockStorageLayer.exists(Mockito.anyString())).thenReturn(true);</span>
     File mockFile = Mockito.mock(File.class);
     Mockito.when(mockStorageLayer.getFile(Mockito.anyString())).thenReturn(mockFile);
<span class="hljs-deletion">-    Mockito.when(mockStorageLayer.getSize(Mockito.anyString())).thenReturn(actualSize);</span>
<span class="hljs-addition">+    mockStorageLayer = MockStorageLayer.createMockStorageLayer(true, actualSize);</span>
     Mockito.doReturn(virtualSize).when(processor).getTemplateVirtualSize((File) Mockito.any());
     Processor.FormatInfo info = processor.process(templatePath, null, templateName);
     Assert.assertEquals(Storage.ImageFormat.QCOW2, info.format);
     Assert.assertEquals(actualSize, info.size);
     Assert.assertEquals(virtualSize, info.virtualSize);
     Assert.assertEquals(templateName + ".qcow2", info.filename);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcess</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String templatePath = <span class="hljs-string">"/tmp"</span>;

    String templateName = <span class="hljs-string">"template"</span>;

    <span class="hljs-keyword">long</span> virtualSize = <span class="hljs-number">2000</span>;

    <span class="hljs-keyword">long</span> actualSize = <span class="hljs-number">1000</span>;

    Mockito.when(mockStorageLayer.exists(Mockito.anyString())).thenReturn(<span class="hljs-keyword">true</span>);

    File mockFile = Mockito.mock(File<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(mockStorageLayer.getFile(Mockito.anyString())).thenReturn(mockFile);

    Mockito.when(mockStorageLayer.getSize(Mockito.anyString())).thenReturn(actualSize);

    Mockito.doReturn(virtualSize).when(processor).getTemplateVirtualSize((File) Mockito.any());

    Processor.FormatInfo info = processor.process(templatePath, <span class="hljs-keyword">null</span>, templateName);

    Assert.assertEquals(Storage.ImageFormat.QCOW2, info.format);

    Assert.assertEquals(actualSize, info.size);

    Assert.assertEquals(virtualSize, info.virtualSize);

    Assert.assertEquals(templateName + <span class="hljs-string">".qcow2"</span>, info.filename);

}
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    processor = Mockito.spy(<span class="hljs-keyword">new</span> QCOW2Processor());

    Map&lt;String, Object&gt; params = <span class="hljs-keyword">new</span> HashMap&lt;String, Object&gt;();

    params.put(StorageLayer.InstanceConfigKey, mockStorageLayer);

    processor.configure(<span class="hljs-string">"VHD Processor"</span>, params);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockStorageLayer</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock StorageLayer with stubbed exists and getSize methods.
     *
     * <span class="hljs-doctag">@param</span> mockStorageLayer the mock instance to stub
     * <span class="hljs-doctag">@param</span> existsReturn the boolean value to return from exists()
     * <span class="hljs-doctag">@param</span> getSizeReturn the long value to return from getSize()
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stubExistsAndGetSize</span><span class="hljs-params">(StorageLayer mockStorageLayer, <span class="hljs-keyword">boolean</span> existsReturn, <span class="hljs-keyword">long</span> getSizeReturn)</span> </span>{
        Mockito.when(mockStorageLayer.exists(Mockito.anyString())).thenReturn(existsReturn);
        Mockito.when(mockStorageLayer.getSize(Mockito.anyString())).thenReturn(getSizeReturn);
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1225">Test Case ID #cloudstack_Test_122_5</h4>
<h4 id="test-case-name-testprocesswhenvirtualsizethrowsexceptionfile-cjavaprojectsapachecloudstackcoresrctestjavacomcloudstoragetemplatevhdprocessortestjava">Test Case Name: <code>testProcessWhenVirtualSizeThrowsException</code>(File: <code>C:\Java_projects\Apache\cloudstack\core\src\test\java\com\cloud\storage\template\VhdProcessorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockstoragelayer">Mock Object Variable Name: <code>mockStorageLayer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test(expected = InternalErrorException.class)
 public void testProcessWhenVirtualSizeThrowsException() throws Exception {
     String templatePath = "/tmp";
     String templateName = "template";
<span class="hljs-deletion">-    Mockito.when(mockStorageLayer.exists(Mockito.anyString())).thenReturn(true);</span>
     File mockFile = Mockito.mock(File.class);
     Mockito.when(mockStorageLayer.getFile(Mockito.anyString())).thenReturn(mockFile);
<span class="hljs-deletion">-    Mockito.when(mockStorageLayer.getSize(Mockito.anyString())).thenReturn(1000L);</span>
<span class="hljs-addition">+    mockStorageLayer = MockStorageLayer.createMockStorageLayer(true, 1000L);</span>
     Mockito.doThrow(new IOException("virtual size calculation failed")).when(processor).getTemplateVirtualSize((File) Mockito.any());
     processor.process(templatePath, null, templateName);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    processor = Mockito.spy(<span class="hljs-keyword">new</span> VhdProcessor());

    Map&lt;String, Object&gt; params = <span class="hljs-keyword">new</span> HashMap&lt;String, Object&gt;();

    params.put(StorageLayer.InstanceConfigKey, mockStorageLayer);

    processor.configure(<span class="hljs-string">"VHD Processor"</span>, params);

}
<span class="hljs-meta">@Test</span>(expected = InternalErrorException<span class="hljs-class">.<span class="hljs-keyword">class</span>)

<span class="hljs-title">public</span> <span class="hljs-title">void</span> <span class="hljs-title">testProcessWhenVirtualSizeThrowsException</span>() <span class="hljs-title">throws</span> <span class="hljs-title">Exception</span> </span>{

    String templatePath = <span class="hljs-string">"/tmp"</span>;

    String templateName = <span class="hljs-string">"template"</span>;

    Mockito.when(mockStorageLayer.exists(Mockito.anyString())).thenReturn(<span class="hljs-keyword">true</span>);

    File mockFile = Mockito.mock(File<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(mockStorageLayer.getFile(Mockito.anyString())).thenReturn(mockFile);

    Mockito.when(mockStorageLayer.getSize(Mockito.anyString())).thenReturn(<span class="hljs-number">1000L</span>);

    Mockito.doThrow(<span class="hljs-keyword">new</span> IOException(<span class="hljs-string">"virtual size calculation failed"</span>)).when(processor).getTemplateVirtualSize((File) Mockito.any());

    processor.process(templatePath, <span class="hljs-keyword">null</span>, templateName);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockStorageLayer</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock StorageLayer with stubbed exists and getSize methods.
     *
     * <span class="hljs-doctag">@param</span> mockStorageLayer the mock instance to stub
     * <span class="hljs-doctag">@param</span> existsReturn the boolean value to return from exists()
     * <span class="hljs-doctag">@param</span> getSizeReturn the long value to return from getSize()
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stubExistsAndGetSize</span><span class="hljs-params">(StorageLayer mockStorageLayer, <span class="hljs-keyword">boolean</span> existsReturn, <span class="hljs-keyword">long</span> getSizeReturn)</span> </span>{
        Mockito.when(mockStorageLayer.exists(Mockito.anyString())).thenReturn(existsReturn);
        Mockito.when(mockStorageLayer.getSize(Mockito.anyString())).thenReturn(getSizeReturn);
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1226">Test Case ID #cloudstack_Test_122_6</h4>
<h4 id="test-case-name-testprocessfile-cjavaprojectsapachecloudstackcoresrctestjavacomcloudstoragetemplatevhdprocessortestjava">Test Case Name: <code>testProcess</code>(File: <code>C:\Java_projects\Apache\cloudstack\core\src\test\java\com\cloud\storage\template\VhdProcessorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-mockstoragelayer">Mock Object Variable Name: <code>mockStorageLayer</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testProcess() throws Exception {
     String templatePath = "/tmp";
     String templateName = "template";
     long virtualSize = 2000;
     long actualSize = 1000;
<span class="hljs-deletion">-    Mockito.when(mockStorageLayer.exists(Mockito.anyString())).thenReturn(true);</span>
     File mockFile = Mockito.mock(File.class);
     Mockito.when(mockStorageLayer.getFile(Mockito.anyString())).thenReturn(mockFile);
<span class="hljs-deletion">-    Mockito.when(mockStorageLayer.getSize(Mockito.anyString())).thenReturn(actualSize);</span>
<span class="hljs-addition">+    mockStorageLayer = MockStorageLayer.createMockStorageLayer(true, actualSize);</span>
     Mockito.doReturn(virtualSize).when(processor).getTemplateVirtualSize((File) Mockito.any());
     Processor.FormatInfo info = processor.process(templatePath, null, templateName);
     Assert.assertEquals(Storage.ImageFormat.VHD, info.format);
     Assert.assertEquals(actualSize, info.size);
     Assert.assertEquals(virtualSize, info.virtualSize);
     Assert.assertEquals(templateName + ".vhd", info.filename);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Before</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    processor = Mockito.spy(<span class="hljs-keyword">new</span> VhdProcessor());

    Map&lt;String, Object&gt; params = <span class="hljs-keyword">new</span> HashMap&lt;String, Object&gt;();

    params.put(StorageLayer.InstanceConfigKey, mockStorageLayer);

    processor.configure(<span class="hljs-string">"VHD Processor"</span>, params);

}
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcess</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    String templatePath = <span class="hljs-string">"/tmp"</span>;

    String templateName = <span class="hljs-string">"template"</span>;

    <span class="hljs-keyword">long</span> virtualSize = <span class="hljs-number">2000</span>;

    <span class="hljs-keyword">long</span> actualSize = <span class="hljs-number">1000</span>;

    Mockito.when(mockStorageLayer.exists(Mockito.anyString())).thenReturn(<span class="hljs-keyword">true</span>);

    File mockFile = Mockito.mock(File<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(mockStorageLayer.getFile(Mockito.anyString())).thenReturn(mockFile);

    Mockito.when(mockStorageLayer.getSize(Mockito.anyString())).thenReturn(actualSize);

    Mockito.doReturn(virtualSize).when(processor).getTemplateVirtualSize((File) Mockito.any());

    Processor.FormatInfo info = processor.process(templatePath, <span class="hljs-keyword">null</span>, templateName);

    Assert.assertEquals(Storage.ImageFormat.VHD, info.format);

    Assert.assertEquals(actualSize, info.size);

    Assert.assertEquals(virtualSize, info.virtualSize);

    Assert.assertEquals(templateName + <span class="hljs-string">".vhd"</span>, info.filename);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockStorageLayer</span> </span>{
    <span class="hljs-comment">/**
     * Creates a mock StorageLayer with stubbed exists and getSize methods.
     *
     * <span class="hljs-doctag">@param</span> mockStorageLayer the mock instance to stub
     * <span class="hljs-doctag">@param</span> existsReturn the boolean value to return from exists()
     * <span class="hljs-doctag">@param</span> getSizeReturn the long value to return from getSize()
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stubExistsAndGetSize</span><span class="hljs-params">(StorageLayer mockStorageLayer, <span class="hljs-keyword">boolean</span> existsReturn, <span class="hljs-keyword">long</span> getSizeReturn)</span> </span>{
        Mockito.when(mockStorageLayer.exists(Mockito.anyString())).thenReturn(existsReturn);
        Mockito.when(mockStorageLayer.getSize(Mockito.anyString())).thenReturn(getSizeReturn);
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci123">Mock Clone Instance #cloudstack_MCI_123</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>java.util.Date</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> Date startDate;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    startDate = Mockito.mock(Date<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest1231">Test Case ID #cloudstack_Test_123_1</h4>
<h4 id="test-case-name-searchforvmmetricsstatsinternaltestwithapopulatedlistofvmsfile-cjavaprojectsapachecloudstackpluginsmetricssrctestjavaorgapachecloudstackmetricsmetricsserviceimpltestjava">Test Case Name: <code>searchForVmMetricsStatsInternalTestWithAPopulatedListOfVms</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\metrics\src\test\java\org\apache\cloudstack\metrics\MetricsServiceImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-startdate">Mock Object Variable Name: <code>startDate</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void searchForVmMetricsStatsInternalTestWithAPopulatedListOfVms() {
     Mockito.doNothing().when(spy).validateDateParams(Mockito.any(), Mockito.any());
     Mockito.doReturn(new ArrayList&lt;VmStatsVO&gt;()).when(spy).findVmStatsAccordingToDateParams(Mockito.anyLong(), Mockito.any(), Mockito.any());
     Mockito.doReturn(fakeVmId1).when(userVmVOMock).getId();
     Map&lt;Long, List&lt;VmStatsVO&gt;&gt; expected = new HashMap&lt;Long, List&lt;VmStatsVO&gt;&gt;();
     expected.put(fakeVmId1, new ArrayList&lt;VmStatsVO&gt;());
<span class="hljs-deletion">-    Date startDate = Mockito.mock(Date.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `startDate`</span>
     Date endDate = Mockito.mock(Date.class);
     Map&lt;Long, List&lt;VmStatsVO&gt;&gt; result = spy.searchForVmMetricsStatsInternal(startDate, endDate, Arrays.asList(userVmVOMock));
     Mockito.verify(userVmVOMock).getId();
     Mockito.verify(spy).findVmStatsAccordingToDateParams(Mockito.anyLong(), Mockito.any(), Mockito.any());
     Assert.assertEquals(expected, result);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">searchForVmMetricsStatsInternalTestWithAPopulatedListOfVms</span><span class="hljs-params">()</span> </span>{

    Mockito.doNothing().when(spy).validateDateParams(Mockito.any(), Mockito.any());

    Mockito.doReturn(<span class="hljs-keyword">new</span> ArrayList&lt;VmStatsVO&gt;()).when(spy).findVmStatsAccordingToDateParams(Mockito.anyLong(), Mockito.any(), Mockito.any());

    Mockito.doReturn(fakeVmId1).when(userVmVOMock).getId();

    Map&lt;Long, List&lt;VmStatsVO&gt;&gt; expected = <span class="hljs-keyword">new</span> HashMap&lt;Long, List&lt;VmStatsVO&gt;&gt;();

    expected.put(fakeVmId1, <span class="hljs-keyword">new</span> ArrayList&lt;VmStatsVO&gt;());

    Date startDate = Mockito.mock(Date<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Date endDate = Mockito.mock(Date<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Map&lt;Long, List&lt;VmStatsVO&gt;&gt; result = spy.searchForVmMetricsStatsInternal(startDate, endDate, Arrays.asList(userVmVOMock));

    Mockito.verify(userVmVOMock).getId();

    Mockito.verify(spy).findVmStatsAccordingToDateParams(Mockito.anyLong(), Mockito.any(), Mockito.any());

    Assert.assertEquals(expected, result);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> Date startDate;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    startDate = Mockito.mock(Date<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1232">Test Case ID #cloudstack_Test_123_2</h4>
<h4 id="test-case-name-searchforvmmetricsstatsinternaltestwithanemptylistofvmsfile-cjavaprojectsapachecloudstackpluginsmetricssrctestjavaorgapachecloudstackmetricsmetricsserviceimpltestjava">Test Case Name: <code>searchForVmMetricsStatsInternalTestWithAnEmptyListOfVms</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\metrics\src\test\java\org\apache\cloudstack\metrics\MetricsServiceImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-startdate">Mock Object Variable Name: <code>startDate</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void searchForVmMetricsStatsInternalTestWithAnEmptyListOfVms() {
     Mockito.doNothing().when(spy).validateDateParams(Mockito.any(), Mockito.any());
     Map&lt;Long, List&lt;VmStatsVO&gt;&gt; expected = new HashMap&lt;Long, List&lt;VmStatsVO&gt;&gt;();
<span class="hljs-deletion">-    Date startDate = Mockito.mock(Date.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `startDate`</span>
     Date endDate = Mockito.mock(Date.class);
     Map&lt;Long, List&lt;VmStatsVO&gt;&gt; result = spy.searchForVmMetricsStatsInternal(startDate, endDate, new ArrayList&lt;UserVmVO&gt;());
     Mockito.verify(userVmVOMock, Mockito.never()).getId();
     Mockito.verify(spy, Mockito.never()).findVmStatsAccordingToDateParams(Mockito.anyLong(), Mockito.any(), Mockito.any());
     Assert.assertEquals(expected, result);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">searchForVmMetricsStatsInternalTestWithAnEmptyListOfVms</span><span class="hljs-params">()</span> </span>{

    Mockito.doNothing().when(spy).validateDateParams(Mockito.any(), Mockito.any());

    Map&lt;Long, List&lt;VmStatsVO&gt;&gt; expected = <span class="hljs-keyword">new</span> HashMap&lt;Long, List&lt;VmStatsVO&gt;&gt;();

    Date startDate = Mockito.mock(Date<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Date endDate = Mockito.mock(Date<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Map&lt;Long, List&lt;VmStatsVO&gt;&gt; result = spy.searchForVmMetricsStatsInternal(startDate, endDate, <span class="hljs-keyword">new</span> ArrayList&lt;UserVmVO&gt;());

    Mockito.verify(userVmVOMock, Mockito.never()).getId();

    Mockito.verify(spy, Mockito.never()).findVmStatsAccordingToDateParams(Mockito.anyLong(), Mockito.any(), Mockito.any());

    Assert.assertEquals(expected, result);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> Date startDate;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    startDate = Mockito.mock(Date<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci124">Mock Clone Instance #cloudstack_MCI_124</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.cloud.agent.api.to.LoadBalancerTO.AutoScaleVmProfileTO</code></li>
<li><strong>Test Case Count</strong>: 5</li>
<li><strong>MO Count</strong>: 5</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> AutoScaleVmProfileTO profileTO;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    profileTO = Mockito.mock(AutoScaleVmProfileTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest1241">Test Case ID #cloudstack_Test_124_1</h4>
<h4 id="test-case-name-isnativetruefile-cjavaprojectsapachecloudstackserversrctestjavacomcloudnetworkasautoscalemanagerimpltestjava">Test Case Name: <code>isNativeTrue</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\network\as\AutoScaleManagerImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-profileto">Mock Object Variable Name: <code>profileTO</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void isNativeTrue() {
     AutoScaleVmGroupTO groupTO = Mockito.mock(AutoScaleVmGroupTO.class);
     AutoScalePolicyTO policyTO = Mockito.mock(AutoScalePolicyTO.class);
     ConditionTO conditionTO = Mockito.mock(ConditionTO.class);
     CounterTO counterTO = Mockito.mock(CounterTO.class);
<span class="hljs-deletion">-    AutoScaleVmProfileTO profileTO = Mockito.mock(AutoScaleVmProfileTO.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `profileTO`</span>
     when(groupTO.getPolicies()).thenReturn(Arrays.asList(policyTO));
     when(policyTO.getConditions()).thenReturn(Arrays.asList(conditionTO));
     when(conditionTO.getCounter()).thenReturn(counterTO);
     when(counterTO.getSource()).thenReturn(Counter.Source.CPU);
     boolean result = autoScaleManagerImplSpy.isNative(groupTO);
     Assert.assertTrue(result);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">isNativeTrue</span><span class="hljs-params">()</span> </span>{

    AutoScaleVmGroupTO groupTO = Mockito.mock(AutoScaleVmGroupTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AutoScalePolicyTO policyTO = Mockito.mock(AutoScalePolicyTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConditionTO conditionTO = Mockito.mock(ConditionTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    CounterTO counterTO = Mockito.mock(CounterTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AutoScaleVmProfileTO profileTO = Mockito.mock(AutoScaleVmProfileTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(groupTO.getPolicies()).thenReturn(Arrays.asList(policyTO));

    when(policyTO.getConditions()).thenReturn(Arrays.asList(conditionTO));

    when(conditionTO.getCounter()).thenReturn(counterTO);

    when(counterTO.getSource()).thenReturn(Counter.Source.CPU);

    <span class="hljs-keyword">boolean</span> result = autoScaleManagerImplSpy.isNative(groupTO);

    Assert.assertTrue(result);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> AutoScaleVmProfileTO profileTO;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    profileTO = Mockito.mock(AutoScaleVmProfileTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1242">Test Case ID #cloudstack_Test_124_2</h4>
<h4 id="test-case-name-isnativefalsefile-cjavaprojectsapachecloudstackserversrctestjavacomcloudnetworkasautoscalemanagerimpltestjava">Test Case Name: <code>isNativeFalse</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\network\as\AutoScaleManagerImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-profileto">Mock Object Variable Name: <code>profileTO</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void isNativeFalse() {
     AutoScaleVmGroupTO groupTO = Mockito.mock(AutoScaleVmGroupTO.class);
     AutoScalePolicyTO policyTO = Mockito.mock(AutoScalePolicyTO.class);
     ConditionTO conditionTO = Mockito.mock(ConditionTO.class);
     CounterTO counterTO = Mockito.mock(CounterTO.class);
<span class="hljs-deletion">-    AutoScaleVmProfileTO profileTO = Mockito.mock(AutoScaleVmProfileTO.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `profileTO`</span>
     when(groupTO.getPolicies()).thenReturn(Arrays.asList(policyTO));
     when(policyTO.getConditions()).thenReturn(Arrays.asList(conditionTO));
     when(conditionTO.getCounter()).thenReturn(counterTO);
     when(counterTO.getSource()).thenReturn(Counter.Source.VIRTUALROUTER);
     boolean result = autoScaleManagerImplSpy.isNative(groupTO);
     Assert.assertFalse(result);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">isNativeFalse</span><span class="hljs-params">()</span> </span>{

    AutoScaleVmGroupTO groupTO = Mockito.mock(AutoScaleVmGroupTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AutoScalePolicyTO policyTO = Mockito.mock(AutoScalePolicyTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConditionTO conditionTO = Mockito.mock(ConditionTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    CounterTO counterTO = Mockito.mock(CounterTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AutoScaleVmProfileTO profileTO = Mockito.mock(AutoScaleVmProfileTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(groupTO.getPolicies()).thenReturn(Arrays.asList(policyTO));

    when(policyTO.getConditions()).thenReturn(Arrays.asList(conditionTO));

    when(conditionTO.getCounter()).thenReturn(counterTO);

    when(counterTO.getSource()).thenReturn(Counter.Source.VIRTUALROUTER);

    <span class="hljs-keyword">boolean</span> result = autoScaleManagerImplSpy.isNative(groupTO);

    Assert.assertFalse(result);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> AutoScaleVmProfileTO profileTO;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    profileTO = Mockito.mock(AutoScaleVmProfileTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1243">Test Case ID #cloudstack_Test_124_3</h4>
<h4 id="test-case-name-hassourcevirtualroutertruefile-cjavaprojectsapachecloudstackserversrctestjavacomcloudnetworkasautoscalemanagerimpltestjava">Test Case Name: <code>hasSourceVirtualRouterTrue</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\network\as\AutoScaleManagerImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-profileto">Mock Object Variable Name: <code>profileTO</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void hasSourceVirtualRouterTrue() {
     AutoScaleVmGroupTO groupTO = Mockito.mock(AutoScaleVmGroupTO.class);
     AutoScalePolicyTO policyTO = Mockito.mock(AutoScalePolicyTO.class);
     ConditionTO conditionTO = Mockito.mock(ConditionTO.class);
     CounterTO counterTO = Mockito.mock(CounterTO.class);
<span class="hljs-deletion">-    AutoScaleVmProfileTO profileTO = Mockito.mock(AutoScaleVmProfileTO.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `profileTO`</span>
     when(groupTO.getPolicies()).thenReturn(Arrays.asList(policyTO));
     when(policyTO.getConditions()).thenReturn(Arrays.asList(conditionTO));
     when(conditionTO.getCounter()).thenReturn(counterTO);
     when(counterTO.getSource()).thenReturn(Counter.Source.VIRTUALROUTER);
     boolean result = autoScaleManagerImplSpy.hasSourceVirtualRouter(groupTO);
     Assert.assertTrue(result);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">hasSourceVirtualRouterTrue</span><span class="hljs-params">()</span> </span>{

    AutoScaleVmGroupTO groupTO = Mockito.mock(AutoScaleVmGroupTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AutoScalePolicyTO policyTO = Mockito.mock(AutoScalePolicyTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConditionTO conditionTO = Mockito.mock(ConditionTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    CounterTO counterTO = Mockito.mock(CounterTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AutoScaleVmProfileTO profileTO = Mockito.mock(AutoScaleVmProfileTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(groupTO.getPolicies()).thenReturn(Arrays.asList(policyTO));

    when(policyTO.getConditions()).thenReturn(Arrays.asList(conditionTO));

    when(conditionTO.getCounter()).thenReturn(counterTO);

    when(counterTO.getSource()).thenReturn(Counter.Source.VIRTUALROUTER);

    <span class="hljs-keyword">boolean</span> result = autoScaleManagerImplSpy.hasSourceVirtualRouter(groupTO);

    Assert.assertTrue(result);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> AutoScaleVmProfileTO profileTO;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    profileTO = Mockito.mock(AutoScaleVmProfileTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1244">Test Case ID #cloudstack_Test_124_4</h4>
<h4 id="test-case-name-hassourcevirtualrouterfalsefile-cjavaprojectsapachecloudstackserversrctestjavacomcloudnetworkasautoscalemanagerimpltestjava">Test Case Name: <code>hasSourceVirtualRouterFalse</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\network\as\AutoScaleManagerImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-profileto">Mock Object Variable Name: <code>profileTO</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void hasSourceVirtualRouterFalse() {
     AutoScaleVmGroupTO groupTO = Mockito.mock(AutoScaleVmGroupTO.class);
     AutoScalePolicyTO policyTO = Mockito.mock(AutoScalePolicyTO.class);
     ConditionTO conditionTO = Mockito.mock(ConditionTO.class);
     CounterTO counterTO = Mockito.mock(CounterTO.class);
<span class="hljs-deletion">-    AutoScaleVmProfileTO profileTO = Mockito.mock(AutoScaleVmProfileTO.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `profileTO`</span>
     when(groupTO.getPolicies()).thenReturn(Arrays.asList(policyTO));
     when(policyTO.getConditions()).thenReturn(Arrays.asList(conditionTO));
     when(conditionTO.getCounter()).thenReturn(counterTO);
     when(counterTO.getSource()).thenReturn(Counter.Source.CPU);
     boolean result = autoScaleManagerImplSpy.hasSourceVirtualRouter(groupTO);
     Assert.assertFalse(result);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">hasSourceVirtualRouterFalse</span><span class="hljs-params">()</span> </span>{

    AutoScaleVmGroupTO groupTO = Mockito.mock(AutoScaleVmGroupTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AutoScalePolicyTO policyTO = Mockito.mock(AutoScalePolicyTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    ConditionTO conditionTO = Mockito.mock(ConditionTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    CounterTO counterTO = Mockito.mock(CounterTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AutoScaleVmProfileTO profileTO = Mockito.mock(AutoScaleVmProfileTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(groupTO.getPolicies()).thenReturn(Arrays.asList(policyTO));

    when(policyTO.getConditions()).thenReturn(Arrays.asList(conditionTO));

    when(conditionTO.getCounter()).thenReturn(counterTO);

    when(counterTO.getSource()).thenReturn(Counter.Source.CPU);

    <span class="hljs-keyword">boolean</span> result = autoScaleManagerImplSpy.hasSourceVirtualRouter(groupTO);

    Assert.assertFalse(result);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> AutoScaleVmProfileTO profileTO;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    profileTO = Mockito.mock(AutoScaleVmProfileTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1245">Test Case ID #cloudstack_Test_124_5</h4>
<h4 id="test-case-name-updatecountersmapwithinstantdataforcpufile-cjavaprojectsapachecloudstackserversrctestjavacomcloudnetworkasautoscalemanagerimpltestjava">Test Case Name: <code>updateCountersMapWithInstantDataForCPU</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\network\as\AutoScaleManagerImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-profileto">Mock Object Variable Name: <code>profileTO</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void updateCountersMapWithInstantDataForCPU() {
     AutoScaleVmGroupTO groupTO = Mockito.mock(AutoScaleVmGroupTO.class);
<span class="hljs-deletion">-    AutoScaleVmProfileTO profileTO = Mockito.mock(AutoScaleVmProfileTO.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `profileTO`</span>
     when(counterDao.findById(counterId)).thenReturn(counterMock);
     when(counterMock.getSource()).thenReturn(Counter.Source.CPU);
     Map&lt;String, Double&gt; countersMap = new HashMap&lt;&gt;();
     Map&lt;String, Integer&gt; countersNumberMap = new HashMap&lt;&gt;();
     String key = scaleUpPolicyId + "-" + conditionId + "-" + counterId;
     countersMap.put(key, (double) 10);
     countersNumberMap.put(key, 1);
     double value = 0.5;
     autoScaleManagerImplSpy.updateCountersMapWithInstantData(countersMap, countersNumberMap, groupTO, counterId, conditionId, scaleUpPolicyId, value, AutoScaleValueType.INSTANT_VM);
     Assert.assertEquals(1, countersMap.size());
     Assert.assertEquals(1, countersNumberMap.size());
     Assert.assertEquals(60, (double) countersMap.get(key), 0);
     Assert.assertEquals(2, (long) countersNumberMap.get(key));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateCountersMapWithInstantDataForCPU</span><span class="hljs-params">()</span> </span>{

    AutoScaleVmGroupTO groupTO = Mockito.mock(AutoScaleVmGroupTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AutoScaleVmProfileTO profileTO = Mockito.mock(AutoScaleVmProfileTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(counterDao.findById(counterId)).thenReturn(counterMock);

    when(counterMock.getSource()).thenReturn(Counter.Source.CPU);

    Map&lt;String, Double&gt; countersMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    Map&lt;String, Integer&gt; countersNumberMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();

    String key = scaleUpPolicyId + <span class="hljs-string">"-"</span> + conditionId + <span class="hljs-string">"-"</span> + counterId;

    countersMap.put(key, (<span class="hljs-keyword">double</span>) <span class="hljs-number">10</span>);

    countersNumberMap.put(key, <span class="hljs-number">1</span>);

    <span class="hljs-keyword">double</span> value = <span class="hljs-number">0.5</span>;

    autoScaleManagerImplSpy.updateCountersMapWithInstantData(countersMap, countersNumberMap, groupTO, counterId, conditionId, scaleUpPolicyId, value, AutoScaleValueType.INSTANT_VM);

    Assert.assertEquals(<span class="hljs-number">1</span>, countersMap.size());

    Assert.assertEquals(<span class="hljs-number">1</span>, countersNumberMap.size());

    Assert.assertEquals(<span class="hljs-number">60</span>, (<span class="hljs-keyword">double</span>) countersMap.get(key), <span class="hljs-number">0</span>);

    Assert.assertEquals(<span class="hljs-number">2</span>, (<span class="hljs-keyword">long</span>) countersNumberMap.get(key));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> AutoScaleVmProfileTO profileTO;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    profileTO = Mockito.mock(AutoScaleVmProfileTO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci125">Mock Clone Instance #cloudstack_MCI_125</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.cloud.utils.SwiftUtil.SwiftClientCfg</code></li>
<li><strong>Test Case Count</strong>: 9</li>
<li><strong>MO Count</strong>: 9</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SwiftClientCfg <span class="hljs-title">createMockSwiftClientCfg</span><span class="hljs-params">(String endPoint, String account, String userName, String key, String storagePolicy)</span> </span>{
    SwiftClientCfg cfg = mock(SwiftClientCfg<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(cfg.getEndPoint()).willReturn(endPoint);
    given(cfg.getAccount()).willReturn(account);
    given(cfg.getUserName()).willReturn(userName);
    given(cfg.getKey()).willReturn(key);
    given(cfg.getStoragePolicy()).willReturn(storagePolicy);
    <span class="hljs-keyword">return</span> cfg;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest1251">Test Case ID #cloudstack_Test_125_1</h4>
<h4 id="test-case-name-testgetswiftcmdfile-cjavaprojectsapachecloudstackutilssrctestjavacomcloudutilsswiftutiltestjava">Test Case Name: <code>testGetSwiftCmd</code>(File: <code>C:\Java_projects\Apache\cloudstack\utils\src\test\java\com\cloud\utils\SwiftUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-cfg">Mock Object Variable Name: <code>cfg</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testGetSwiftCmd() {
<span class="hljs-deletion">-    SwiftClientCfg cfg = mock(SwiftClientCfg.class);</span>
<span class="hljs-deletion">-    given(cfg.getEndPoint()).willReturn("swift.endpoint");</span>
<span class="hljs-deletion">-    given(cfg.getAccount()).willReturn("cs");</span>
<span class="hljs-deletion">-    given(cfg.getUserName()).willReturn("sec-storage");</span>
<span class="hljs-deletion">-    given(cfg.getKey()).willReturn("mypassword");</span>
<span class="hljs-deletion">-    given(cfg.getStoragePolicy()).willReturn(null);</span>
<span class="hljs-addition">+    SwiftClientCfg cfg = createMockSwiftClientCfg("swift.endpoint", "cs", "sec-storage", "mypassword", null);</span>
     String cmd = SwiftUtil.getSwiftCmd(cfg, "swift", "stat");
     String expected = "/usr/bin/python swift -A swift.endpoint -U cs:sec-storage -K mypassword stat";
     assertThat(cmd, is(equalTo(expected)));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetSwiftCmd</span><span class="hljs-params">()</span> </span>{

    SwiftClientCfg cfg = mock(SwiftClientCfg<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(cfg.getEndPoint()).willReturn(<span class="hljs-string">"swift.endpoint"</span>);

    given(cfg.getAccount()).willReturn(<span class="hljs-string">"cs"</span>);

    given(cfg.getUserName()).willReturn(<span class="hljs-string">"sec-storage"</span>);

    given(cfg.getKey()).willReturn(<span class="hljs-string">"mypassword"</span>);

    given(cfg.getStoragePolicy()).willReturn(<span class="hljs-keyword">null</span>);

    String cmd = SwiftUtil.getSwiftCmd(cfg, <span class="hljs-string">"swift"</span>, <span class="hljs-string">"stat"</span>);

    String expected = <span class="hljs-string">"/usr/bin/python swift -A swift.endpoint -U cs:sec-storage -K mypassword stat"</span>;

    assertThat(cmd, is(equalTo(expected)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SwiftClientCfg <span class="hljs-title">createMockSwiftClientCfg</span><span class="hljs-params">(String endPoint, String account, String userName, String key, String storagePolicy)</span> </span>{
    SwiftClientCfg cfg = mock(SwiftClientCfg<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(cfg.getEndPoint()).willReturn(endPoint);
    given(cfg.getAccount()).willReturn(account);
    given(cfg.getUserName()).willReturn(userName);
    given(cfg.getKey()).willReturn(key);
    given(cfg.getStoragePolicy()).willReturn(storagePolicy);
    <span class="hljs-keyword">return</span> cfg;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1252">Test Case ID #cloudstack_Test_125_2</h4>
<h4 id="test-case-name-testgetswiftobjectcmdfile-cjavaprojectsapachecloudstackutilssrctestjavacomcloudutilsswiftutiltestjava">Test Case Name: <code>testGetSwiftObjectCmd</code>(File: <code>C:\Java_projects\Apache\cloudstack\utils\src\test\java\com\cloud\utils\SwiftUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-cfg">Mock Object Variable Name: <code>cfg</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testGetSwiftObjectCmd() {
<span class="hljs-deletion">-    SwiftClientCfg cfg = mock(SwiftClientCfg.class);</span>
<span class="hljs-deletion">-    given(cfg.getEndPoint()).willReturn("swift.endpoint");</span>
<span class="hljs-deletion">-    given(cfg.getAccount()).willReturn("cs");</span>
<span class="hljs-deletion">-    given(cfg.getUserName()).willReturn("sec-storage");</span>
<span class="hljs-deletion">-    given(cfg.getKey()).willReturn("mypassword");</span>
<span class="hljs-deletion">-    given(cfg.getStoragePolicy()).willReturn(null);</span>
<span class="hljs-addition">+    SwiftClientCfg cfg = createMockSwiftClientCfg("swift.endpoint", "cs", "sec-storage", "mypassword", null);</span>
     String objectCmd = SwiftUtil.getSwiftObjectCmd(cfg, "swift", "delete", "T-123", "template.vhd");
     String expected = "/usr/bin/python swift -A swift.endpoint -U cs:sec-storage -K mypassword delete T-123 template.vhd";
     assertThat(objectCmd, is(equalTo(expected)));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetSwiftObjectCmd</span><span class="hljs-params">()</span> </span>{

    SwiftClientCfg cfg = mock(SwiftClientCfg<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(cfg.getEndPoint()).willReturn(<span class="hljs-string">"swift.endpoint"</span>);

    given(cfg.getAccount()).willReturn(<span class="hljs-string">"cs"</span>);

    given(cfg.getUserName()).willReturn(<span class="hljs-string">"sec-storage"</span>);

    given(cfg.getKey()).willReturn(<span class="hljs-string">"mypassword"</span>);

    given(cfg.getStoragePolicy()).willReturn(<span class="hljs-keyword">null</span>);

    String objectCmd = SwiftUtil.getSwiftObjectCmd(cfg, <span class="hljs-string">"swift"</span>, <span class="hljs-string">"delete"</span>, <span class="hljs-string">"T-123"</span>, <span class="hljs-string">"template.vhd"</span>);

    String expected = <span class="hljs-string">"/usr/bin/python swift -A swift.endpoint -U cs:sec-storage -K mypassword delete T-123 template.vhd"</span>;

    assertThat(objectCmd, is(equalTo(expected)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SwiftClientCfg <span class="hljs-title">createMockSwiftClientCfg</span><span class="hljs-params">(String endPoint, String account, String userName, String key, String storagePolicy)</span> </span>{
    SwiftClientCfg cfg = mock(SwiftClientCfg<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(cfg.getEndPoint()).willReturn(endPoint);
    given(cfg.getAccount()).willReturn(account);
    given(cfg.getUserName()).willReturn(userName);
    given(cfg.getKey()).willReturn(key);
    given(cfg.getStoragePolicy()).willReturn(storagePolicy);
    <span class="hljs-keyword">return</span> cfg;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1253">Test Case ID #cloudstack_Test_125_3</h4>
<h4 id="test-case-name-testgetswiftcontainercmdfile-cjavaprojectsapachecloudstackutilssrctestjavacomcloudutilsswiftutiltestjava">Test Case Name: <code>testGetSwiftContainerCmd</code>(File: <code>C:\Java_projects\Apache\cloudstack\utils\src\test\java\com\cloud\utils\SwiftUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-cfg">Mock Object Variable Name: <code>cfg</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testGetSwiftContainerCmd() {
<span class="hljs-deletion">-    SwiftClientCfg cfg = mock(SwiftClientCfg.class);</span>
<span class="hljs-deletion">-    given(cfg.getEndPoint()).willReturn("swift.endpoint");</span>
<span class="hljs-deletion">-    given(cfg.getAccount()).willReturn("cs");</span>
<span class="hljs-deletion">-    given(cfg.getUserName()).willReturn("sec-storage");</span>
<span class="hljs-deletion">-    given(cfg.getKey()).willReturn("mypassword");</span>
<span class="hljs-deletion">-    given(cfg.getStoragePolicy()).willReturn(null);</span>
<span class="hljs-addition">+    SwiftClientCfg cfg = createMockSwiftClientCfg("swift.endpoint", "cs", "sec-storage", "mypassword", null);</span>
     String containerCmd = SwiftUtil.getSwiftContainerCmd(cfg, "swift", "list", "T-123");
     String expected = "/usr/bin/python swift -A swift.endpoint -U cs:sec-storage -K mypassword list T-123";
     assertThat(containerCmd, is(equalTo(expected)));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetSwiftContainerCmd</span><span class="hljs-params">()</span> </span>{

    SwiftClientCfg cfg = mock(SwiftClientCfg<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(cfg.getEndPoint()).willReturn(<span class="hljs-string">"swift.endpoint"</span>);

    given(cfg.getAccount()).willReturn(<span class="hljs-string">"cs"</span>);

    given(cfg.getUserName()).willReturn(<span class="hljs-string">"sec-storage"</span>);

    given(cfg.getKey()).willReturn(<span class="hljs-string">"mypassword"</span>);

    given(cfg.getStoragePolicy()).willReturn(<span class="hljs-keyword">null</span>);

    String containerCmd = SwiftUtil.getSwiftContainerCmd(cfg, <span class="hljs-string">"swift"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"T-123"</span>);

    String expected = <span class="hljs-string">"/usr/bin/python swift -A swift.endpoint -U cs:sec-storage -K mypassword list T-123"</span>;

    assertThat(containerCmd, is(equalTo(expected)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SwiftClientCfg <span class="hljs-title">createMockSwiftClientCfg</span><span class="hljs-params">(String endPoint, String account, String userName, String key, String storagePolicy)</span> </span>{
    SwiftClientCfg cfg = mock(SwiftClientCfg<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(cfg.getEndPoint()).willReturn(endPoint);
    given(cfg.getAccount()).willReturn(account);
    given(cfg.getUserName()).willReturn(userName);
    given(cfg.getKey()).willReturn(key);
    given(cfg.getStoragePolicy()).willReturn(storagePolicy);
    <span class="hljs-keyword">return</span> cfg;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1254">Test Case ID #cloudstack_Test_125_4</h4>
<h4 id="test-case-name-testgetuploadcmdfile-cjavaprojectsapachecloudstackutilssrctestjavacomcloudutilsswiftutiltestjava">Test Case Name: <code>testGetUploadCmd</code>(File: <code>C:\Java_projects\Apache\cloudstack\utils\src\test\java\com\cloud\utils\SwiftUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-cfg">Mock Object Variable Name: <code>cfg</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testGetUploadCmd() {
<span class="hljs-deletion">-    SwiftClientCfg cfg = mock(SwiftClientCfg.class);</span>
<span class="hljs-deletion">-    given(cfg.getEndPoint()).willReturn("swift.endpoint");</span>
<span class="hljs-deletion">-    given(cfg.getAccount()).willReturn("cs");</span>
<span class="hljs-deletion">-    given(cfg.getUserName()).willReturn("sec-storage");</span>
<span class="hljs-deletion">-    given(cfg.getKey()).willReturn("mypassword");</span>
<span class="hljs-deletion">-    given(cfg.getStoragePolicy()).willReturn(null);</span>
<span class="hljs-addition">+    SwiftClientCfg cfg = createMockSwiftClientCfg("swift.endpoint", "cs", "sec-storage", "mypassword", null);</span>
     String uploadCmd = SwiftUtil.getUploadObjectCommand(cfg, "swift", "T-1", "template.vhd", 1024);
     String expected = "/usr/bin/python swift -A swift.endpoint -U cs:sec-storage -K mypassword upload T-1 template.vhd";
     assertThat(uploadCmd, is(equalTo(expected)));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetUploadCmd</span><span class="hljs-params">()</span> </span>{

    SwiftClientCfg cfg = mock(SwiftClientCfg<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(cfg.getEndPoint()).willReturn(<span class="hljs-string">"swift.endpoint"</span>);

    given(cfg.getAccount()).willReturn(<span class="hljs-string">"cs"</span>);

    given(cfg.getUserName()).willReturn(<span class="hljs-string">"sec-storage"</span>);

    given(cfg.getKey()).willReturn(<span class="hljs-string">"mypassword"</span>);

    given(cfg.getStoragePolicy()).willReturn(<span class="hljs-keyword">null</span>);

    String uploadCmd = SwiftUtil.getUploadObjectCommand(cfg, <span class="hljs-string">"swift"</span>, <span class="hljs-string">"T-1"</span>, <span class="hljs-string">"template.vhd"</span>, <span class="hljs-number">1024</span>);

    String expected = <span class="hljs-string">"/usr/bin/python swift -A swift.endpoint -U cs:sec-storage -K mypassword upload T-1 template.vhd"</span>;

    assertThat(uploadCmd, is(equalTo(expected)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SwiftClientCfg <span class="hljs-title">createMockSwiftClientCfg</span><span class="hljs-params">(String endPoint, String account, String userName, String key, String storagePolicy)</span> </span>{
    SwiftClientCfg cfg = mock(SwiftClientCfg<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(cfg.getEndPoint()).willReturn(endPoint);
    given(cfg.getAccount()).willReturn(account);
    given(cfg.getUserName()).willReturn(userName);
    given(cfg.getKey()).willReturn(key);
    given(cfg.getStoragePolicy()).willReturn(storagePolicy);
    <span class="hljs-keyword">return</span> cfg;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1255">Test Case ID #cloudstack_Test_125_5</h4>
<h4 id="test-case-name-testgetuploadcmdwithsegmentsbecauseofsizefile-cjavaprojectsapachecloudstackutilssrctestjavacomcloudutilsswiftutiltestjava">Test Case Name: <code>testGetUploadCmdWithSegmentsBecauseOfSize</code>(File: <code>C:\Java_projects\Apache\cloudstack\utils\src\test\java\com\cloud\utils\SwiftUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-cfg">Mock Object Variable Name: <code>cfg</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testGetUploadCmdWithSegmentsBecauseOfSize() {
<span class="hljs-deletion">-    SwiftClientCfg cfg = mock(SwiftClientCfg.class);</span>
<span class="hljs-deletion">-    given(cfg.getEndPoint()).willReturn("swift.endpoint");</span>
<span class="hljs-deletion">-    given(cfg.getAccount()).willReturn("cs");</span>
<span class="hljs-deletion">-    given(cfg.getUserName()).willReturn("sec-storage");</span>
<span class="hljs-deletion">-    given(cfg.getKey()).willReturn("mypassword");</span>
<span class="hljs-deletion">-    given(cfg.getStoragePolicy()).willReturn(null);</span>
<span class="hljs-addition">+    SwiftClientCfg cfg = createMockSwiftClientCfg("swift.endpoint", "cs", "sec-storage", "mypassword", null);</span>
     String uploadCmd = SwiftUtil.getUploadObjectCommand(cfg, "swift", "T-1", "template.vhd", 5368709121L);
     String expected = "/usr/bin/python swift -A swift.endpoint -U cs:sec-storage -K mypassword upload T-1 template.vhd -S 5368709120";
     assertThat(uploadCmd, is(equalTo(expected)));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetUploadCmdWithSegmentsBecauseOfSize</span><span class="hljs-params">()</span> </span>{

    SwiftClientCfg cfg = mock(SwiftClientCfg<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(cfg.getEndPoint()).willReturn(<span class="hljs-string">"swift.endpoint"</span>);

    given(cfg.getAccount()).willReturn(<span class="hljs-string">"cs"</span>);

    given(cfg.getUserName()).willReturn(<span class="hljs-string">"sec-storage"</span>);

    given(cfg.getKey()).willReturn(<span class="hljs-string">"mypassword"</span>);

    given(cfg.getStoragePolicy()).willReturn(<span class="hljs-keyword">null</span>);

    String uploadCmd = SwiftUtil.getUploadObjectCommand(cfg, <span class="hljs-string">"swift"</span>, <span class="hljs-string">"T-1"</span>, <span class="hljs-string">"template.vhd"</span>, <span class="hljs-number">5368709121L</span>);

    String expected = <span class="hljs-string">"/usr/bin/python swift -A swift.endpoint -U cs:sec-storage -K mypassword upload T-1 template.vhd -S 5368709120"</span>;

    assertThat(uploadCmd, is(equalTo(expected)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SwiftClientCfg <span class="hljs-title">createMockSwiftClientCfg</span><span class="hljs-params">(String endPoint, String account, String userName, String key, String storagePolicy)</span> </span>{
    SwiftClientCfg cfg = mock(SwiftClientCfg<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(cfg.getEndPoint()).willReturn(endPoint);
    given(cfg.getAccount()).willReturn(account);
    given(cfg.getUserName()).willReturn(userName);
    given(cfg.getKey()).willReturn(key);
    given(cfg.getStoragePolicy()).willReturn(storagePolicy);
    <span class="hljs-keyword">return</span> cfg;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1256">Test Case ID #cloudstack_Test_125_6</h4>
<h4 id="test-case-name-testgetuploadcmdwithstoragepolicyfile-cjavaprojectsapachecloudstackutilssrctestjavacomcloudutilsswiftutiltestjava">Test Case Name: <code>testGetUploadCmdWithStoragePolicy</code>(File: <code>C:\Java_projects\Apache\cloudstack\utils\src\test\java\com\cloud\utils\SwiftUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-cfg">Mock Object Variable Name: <code>cfg</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testGetUploadCmdWithStoragePolicy() {
<span class="hljs-deletion">-    SwiftClientCfg cfg = mock(SwiftClientCfg.class);</span>
<span class="hljs-deletion">-    given(cfg.getEndPoint()).willReturn("swift.endpoint");</span>
<span class="hljs-deletion">-    given(cfg.getAccount()).willReturn("cs");</span>
<span class="hljs-deletion">-    given(cfg.getUserName()).willReturn("sec-storage");</span>
<span class="hljs-deletion">-    given(cfg.getKey()).willReturn("mypassword");</span>
<span class="hljs-deletion">-    given(cfg.getStoragePolicy()).willReturn("policy1");</span>
<span class="hljs-addition">+    SwiftClientCfg cfg = createMockSwiftClientCfg("swift.endpoint", "cs", "sec-storage", "mypassword", "policy1");</span>
     String uploadCmd = SwiftUtil.getUploadObjectCommand(cfg, "swift", "T-1", "template.vhd", 1024L);
     String expected = "/usr/bin/python swift -A swift.endpoint -U cs:sec-storage -K mypassword upload T-1 template.vhd --storage-policy \"policy1\"";
     assertThat(uploadCmd, is(equalTo(expected)));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetUploadCmdWithStoragePolicy</span><span class="hljs-params">()</span> </span>{

    SwiftClientCfg cfg = mock(SwiftClientCfg<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(cfg.getEndPoint()).willReturn(<span class="hljs-string">"swift.endpoint"</span>);

    given(cfg.getAccount()).willReturn(<span class="hljs-string">"cs"</span>);

    given(cfg.getUserName()).willReturn(<span class="hljs-string">"sec-storage"</span>);

    given(cfg.getKey()).willReturn(<span class="hljs-string">"mypassword"</span>);

    given(cfg.getStoragePolicy()).willReturn(<span class="hljs-string">"policy1"</span>);

    String uploadCmd = SwiftUtil.getUploadObjectCommand(cfg, <span class="hljs-string">"swift"</span>, <span class="hljs-string">"T-1"</span>, <span class="hljs-string">"template.vhd"</span>, <span class="hljs-number">1024L</span>);

    String expected = <span class="hljs-string">"/usr/bin/python swift -A swift.endpoint -U cs:sec-storage -K mypassword upload T-1 template.vhd --storage-policy \"policy1\""</span>;

    assertThat(uploadCmd, is(equalTo(expected)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SwiftClientCfg <span class="hljs-title">createMockSwiftClientCfg</span><span class="hljs-params">(String endPoint, String account, String userName, String key, String storagePolicy)</span> </span>{
    SwiftClientCfg cfg = mock(SwiftClientCfg<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(cfg.getEndPoint()).willReturn(endPoint);
    given(cfg.getAccount()).willReturn(account);
    given(cfg.getUserName()).willReturn(userName);
    given(cfg.getKey()).willReturn(key);
    given(cfg.getStoragePolicy()).willReturn(storagePolicy);
    <span class="hljs-keyword">return</span> cfg;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1257">Test Case ID #cloudstack_Test_125_7</h4>
<h4 id="test-case-name-testgetuploadcmdwithsegmentsandstoragepolicyfile-cjavaprojectsapachecloudstackutilssrctestjavacomcloudutilsswiftutiltestjava">Test Case Name: <code>testGetUploadCmdWithSegmentsAndStoragePolicy</code>(File: <code>C:\Java_projects\Apache\cloudstack\utils\src\test\java\com\cloud\utils\SwiftUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-cfg">Mock Object Variable Name: <code>cfg</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testGetUploadCmdWithSegmentsAndStoragePolicy() {
<span class="hljs-deletion">-    SwiftClientCfg cfg = mock(SwiftClientCfg.class);</span>
<span class="hljs-deletion">-    given(cfg.getEndPoint()).willReturn("swift.endpoint");</span>
<span class="hljs-deletion">-    given(cfg.getAccount()).willReturn("cs");</span>
<span class="hljs-deletion">-    given(cfg.getUserName()).willReturn("sec-storage");</span>
<span class="hljs-deletion">-    given(cfg.getKey()).willReturn("mypassword");</span>
<span class="hljs-deletion">-    given(cfg.getStoragePolicy()).willReturn("policy1");</span>
<span class="hljs-addition">+    SwiftClientCfg cfg = createMockSwiftClientCfg("swift.endpoint", "cs", "sec-storage", "mypassword", "policy1");</span>
     String uploadCmd = SwiftUtil.getUploadObjectCommand(cfg, "swift", "T-1", "template.vhd", 5368709121L);
     String expected = "/usr/bin/python swift -A swift.endpoint -U cs:sec-storage -K mypassword upload T-1 template.vhd --storage-policy \"policy1\" -S 5368709120";
     assertThat(uploadCmd, is(equalTo(expected)));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetUploadCmdWithSegmentsAndStoragePolicy</span><span class="hljs-params">()</span> </span>{

    SwiftClientCfg cfg = mock(SwiftClientCfg<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(cfg.getEndPoint()).willReturn(<span class="hljs-string">"swift.endpoint"</span>);

    given(cfg.getAccount()).willReturn(<span class="hljs-string">"cs"</span>);

    given(cfg.getUserName()).willReturn(<span class="hljs-string">"sec-storage"</span>);

    given(cfg.getKey()).willReturn(<span class="hljs-string">"mypassword"</span>);

    given(cfg.getStoragePolicy()).willReturn(<span class="hljs-string">"policy1"</span>);

    String uploadCmd = SwiftUtil.getUploadObjectCommand(cfg, <span class="hljs-string">"swift"</span>, <span class="hljs-string">"T-1"</span>, <span class="hljs-string">"template.vhd"</span>, <span class="hljs-number">5368709121L</span>);

    String expected = <span class="hljs-string">"/usr/bin/python swift -A swift.endpoint -U cs:sec-storage -K mypassword upload T-1 template.vhd --storage-policy \"policy1\" -S 5368709120"</span>;

    assertThat(uploadCmd, is(equalTo(expected)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SwiftClientCfg <span class="hljs-title">createMockSwiftClientCfg</span><span class="hljs-params">(String endPoint, String account, String userName, String key, String storagePolicy)</span> </span>{
    SwiftClientCfg cfg = mock(SwiftClientCfg<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(cfg.getEndPoint()).willReturn(endPoint);
    given(cfg.getAccount()).willReturn(account);
    given(cfg.getUserName()).willReturn(userName);
    given(cfg.getKey()).willReturn(key);
    given(cfg.getStoragePolicy()).willReturn(storagePolicy);
    <span class="hljs-keyword">return</span> cfg;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1258">Test Case ID #cloudstack_Test_125_8</h4>
<h4 id="test-case-name-testlistcontainercmdwithstoragepolicybutnotsupportedbyoperationfile-cjavaprojectsapachecloudstackutilssrctestjavacomcloudutilsswiftutiltestjava">Test Case Name: <code>testListContainerCmdWithStoragePolicyButNotSupportedByOperation</code>(File: <code>C:\Java_projects\Apache\cloudstack\utils\src\test\java\com\cloud\utils\SwiftUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-cfg">Mock Object Variable Name: <code>cfg</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testListContainerCmdWithStoragePolicyButNotSupportedByOperation() {
<span class="hljs-deletion">-    SwiftClientCfg cfg = mock(SwiftClientCfg.class);</span>
<span class="hljs-deletion">-    given(cfg.getEndPoint()).willReturn("swift.endpoint");</span>
<span class="hljs-deletion">-    given(cfg.getAccount()).willReturn("cs");</span>
<span class="hljs-deletion">-    given(cfg.getUserName()).willReturn("sec-storage");</span>
<span class="hljs-deletion">-    given(cfg.getKey()).willReturn("mypassword");</span>
<span class="hljs-deletion">-    given(cfg.getStoragePolicy()).willReturn("policy1");</span>
<span class="hljs-addition">+    SwiftClientCfg cfg = createMockSwiftClientCfg("swift.endpoint", "cs", "sec-storage", "mypassword", "policy1");</span>
     String uploadCmd = SwiftUtil.getSwiftContainerCmd(cfg, "swift", "list", "T-1");
     String expected = "/usr/bin/python swift -A swift.endpoint -U cs:sec-storage -K mypassword list T-1";
     assertThat(uploadCmd, is(equalTo(expected)));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testListContainerCmdWithStoragePolicyButNotSupportedByOperation</span><span class="hljs-params">()</span> </span>{

    SwiftClientCfg cfg = mock(SwiftClientCfg<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(cfg.getEndPoint()).willReturn(<span class="hljs-string">"swift.endpoint"</span>);

    given(cfg.getAccount()).willReturn(<span class="hljs-string">"cs"</span>);

    given(cfg.getUserName()).willReturn(<span class="hljs-string">"sec-storage"</span>);

    given(cfg.getKey()).willReturn(<span class="hljs-string">"mypassword"</span>);

    given(cfg.getStoragePolicy()).willReturn(<span class="hljs-string">"policy1"</span>);

    String uploadCmd = SwiftUtil.getSwiftContainerCmd(cfg, <span class="hljs-string">"swift"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"T-1"</span>);

    String expected = <span class="hljs-string">"/usr/bin/python swift -A swift.endpoint -U cs:sec-storage -K mypassword list T-1"</span>;

    assertThat(uploadCmd, is(equalTo(expected)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SwiftClientCfg <span class="hljs-title">createMockSwiftClientCfg</span><span class="hljs-params">(String endPoint, String account, String userName, String key, String storagePolicy)</span> </span>{
    SwiftClientCfg cfg = mock(SwiftClientCfg<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(cfg.getEndPoint()).willReturn(endPoint);
    given(cfg.getAccount()).willReturn(account);
    given(cfg.getUserName()).willReturn(userName);
    given(cfg.getKey()).willReturn(key);
    given(cfg.getStoragePolicy()).willReturn(storagePolicy);
    <span class="hljs-keyword">return</span> cfg;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1259">Test Case ID #cloudstack_Test_125_9</h4>
<h4 id="test-case-name-testlistcontainercmdwithoutstoragepolicyfile-cjavaprojectsapachecloudstackutilssrctestjavacomcloudutilsswiftutiltestjava">Test Case Name: <code>testListContainerCmdWithoutStoragePolicy</code>(File: <code>C:\Java_projects\Apache\cloudstack\utils\src\test\java\com\cloud\utils\SwiftUtilTest.java</code>)</h4>
<h4 id="mock-object-variable-name-cfg">Mock Object Variable Name: <code>cfg</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testListContainerCmdWithoutStoragePolicy() {
<span class="hljs-deletion">-    SwiftClientCfg cfg = mock(SwiftClientCfg.class);</span>
<span class="hljs-deletion">-    given(cfg.getEndPoint()).willReturn("swift.endpoint");</span>
<span class="hljs-deletion">-    given(cfg.getAccount()).willReturn("cs");</span>
<span class="hljs-deletion">-    given(cfg.getUserName()).willReturn("sec-storage");</span>
<span class="hljs-deletion">-    given(cfg.getKey()).willReturn("mypassword");</span>
<span class="hljs-deletion">-    given(cfg.getStoragePolicy()).willReturn(null);</span>
<span class="hljs-addition">+    SwiftClientCfg cfg = createMockSwiftClientCfg("swift.endpoint", "cs", "sec-storage", "mypassword", null);</span>
     String uploadCmd = SwiftUtil.getSwiftContainerCmd(cfg, "swift", "list", "T-1");
     String expected = "/usr/bin/python swift -A swift.endpoint -U cs:sec-storage -K mypassword list T-1";
     assertThat(uploadCmd, is(equalTo(expected)));
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testListContainerCmdWithoutStoragePolicy</span><span class="hljs-params">()</span> </span>{

    SwiftClientCfg cfg = mock(SwiftClientCfg<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    given(cfg.getEndPoint()).willReturn(<span class="hljs-string">"swift.endpoint"</span>);

    given(cfg.getAccount()).willReturn(<span class="hljs-string">"cs"</span>);

    given(cfg.getUserName()).willReturn(<span class="hljs-string">"sec-storage"</span>);

    given(cfg.getKey()).willReturn(<span class="hljs-string">"mypassword"</span>);

    given(cfg.getStoragePolicy()).willReturn(<span class="hljs-keyword">null</span>);

    String uploadCmd = SwiftUtil.getSwiftContainerCmd(cfg, <span class="hljs-string">"swift"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"T-1"</span>);

    String expected = <span class="hljs-string">"/usr/bin/python swift -A swift.endpoint -U cs:sec-storage -K mypassword list T-1"</span>;

    assertThat(uploadCmd, is(equalTo(expected)));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SwiftClientCfg <span class="hljs-title">createMockSwiftClientCfg</span><span class="hljs-params">(String endPoint, String account, String userName, String key, String storagePolicy)</span> </span>{
    SwiftClientCfg cfg = mock(SwiftClientCfg<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    given(cfg.getEndPoint()).willReturn(endPoint);
    given(cfg.getAccount()).willReturn(account);
    given(cfg.getUserName()).willReturn(userName);
    given(cfg.getKey()).willReturn(key);
    given(cfg.getStoragePolicy()).willReturn(storagePolicy);
    <span class="hljs-keyword">return</span> cfg;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci164">Mock Clone Instance #cloudstack_MCI_164</h2>
<ul>
<li><strong>Scope</strong>: class level</li>
<li><strong>Mocked Class</strong>: <code>AffinityGroupDao</code></li>
<li><strong>Test Case Count</strong>: 6</li>
<li><strong>MO Count</strong>: 6</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockAffinityGroupDao</span> </span>{
    <span class="hljs-comment">/**
     * Stubs affinityGroupDao.findById to return the provided AffinityGroupVO for the given id.
     *
     * <span class="hljs-doctag">@param</span> affinityGroupDao the mock AffinityGroupDao
     * <span class="hljs-doctag">@param</span> affinityGroupId the id to match in findById
     * <span class="hljs-doctag">@param</span> affinityGroupVO the AffinityGroupVO to return
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stubFindById</span><span class="hljs-params">(AffinityGroupDao affinityGroupDao, <span class="hljs-keyword">long</span> affinityGroupId, AffinityGroupVO affinityGroupVO)</span> </span>{
        when(affinityGroupDao.findById(affinityGroupId)).thenReturn(affinityGroupVO);
    }
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest1641">Test Case ID #cloudstack_Test_164_1</h4>
<h4 id="test-case-name-testprocesswithemptyplanfile-cjavaprojectsapachecloudstackpluginsaffinity-group-processorsnon-strict-host-affinitysrctestjavaorgapachecloudstackaffinitynonstricthostaffinityprocessortestjava">Test Case Name: <code>testProcessWithEmptyPlan</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\affinity-group-processors\non-strict-host-affinity\src\test\java\org\apache\cloudstack\affinity\NonStrictHostAffinityProcessorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-affinitygroupdao">Mock Object Variable Name: <code>affinityGroupDao</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     ExcludeList avoid = new ExcludeList();
     AffinityGroupVO affinityGroupVO = Mockito.mock(AffinityGroupVO.class);
<span class="hljs-deletion">-    when(affinityGroupDao.findById(affinityGroupId)).thenReturn(affinityGroupVO);</span>
<span class="hljs-addition">+    MockAffinityGroupDao.stubFindById(affinityGroupDao, affinityGroupId, affinityGroupVO);</span>
     when(affinityGroupVO.getId()).thenReturn(affinityGroupId);
     List&lt;Long&gt; groupVMIds = new ArrayList&lt;&gt;(Arrays.asList(vmId, vm2Id));
     when(_affinityGroupVMMapDao.listVmIdsByAffinityGroup(affinityGroupId)).thenReturn(groupVMIds);
     VMInstanceVO vm2 = new VMInstanceVO();
     when(vmInstanceDao.findById(vm2Id)).thenReturn(vm2);
     vm2.setHostId(host2Id);
     processor.process(vmProfile, plan, avoid);
     Assert.assertEquals(1, plan.getHostPriorities().size());
     Assert.assertNotNull(plan.getHostPriorities().get(host2Id));
     Assert.assertEquals(Integer.valueOf(1), plan.getHostPriorities().get(host2Id));
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcessWithEmptyPlan</span><span class="hljs-params">()</span> </span>{

    VirtualMachine vm = Mockito.mock(VirtualMachine<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vm.getId()).thenReturn(vmId);

    VirtualMachineProfile vmProfile = Mockito.mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vmProfile.getVirtualMachine()).thenReturn(vm);

    List&lt;AffinityGroupVMMapVO&gt; vmGroupMappings = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    vmGroupMappings.add(<span class="hljs-keyword">new</span> AffinityGroupVMMapVO(affinityGroupId, vmId));

    when(_affinityGroupVMMapDao.findByVmIdType(eq(vmId), nullable(String<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">vmGroupMappings</span>)</span>;

    DataCenterDeployment plan = <span class="hljs-keyword">new</span> DataCenterDeployment(zoneId);

    ExcludeList avoid = <span class="hljs-keyword">new</span> ExcludeList();

    AffinityGroupVO affinityGroupVO = Mockito.mock(AffinityGroupVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(affinityGroupDao.findById(affinityGroupId)).thenReturn(affinityGroupVO);

    when(affinityGroupVO.getId()).thenReturn(affinityGroupId);

    List&lt;Long&gt; groupVMIds = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(vmId, vm2Id));

    when(_affinityGroupVMMapDao.listVmIdsByAffinityGroup(affinityGroupId)).thenReturn(groupVMIds);

    VMInstanceVO vm2 = <span class="hljs-keyword">new</span> VMInstanceVO();

    when(vmInstanceDao.findById(vm2Id)).thenReturn(vm2);

    vm2.setHostId(host2Id);

    processor.process(vmProfile, plan, avoid);

    Assert.assertEquals(<span class="hljs-number">1</span>, plan.getHostPriorities().size());

    Assert.assertNotNull(plan.getHostPriorities().get(host2Id));

    Assert.assertEquals(Integer.valueOf(<span class="hljs-number">1</span>), plan.getHostPriorities().get(host2Id));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockAffinityGroupDao</span> </span>{
    <span class="hljs-comment">/**
     * Stubs affinityGroupDao.findById to return the provided AffinityGroupVO for the given id.
     *
     * <span class="hljs-doctag">@param</span> affinityGroupDao the mock AffinityGroupDao
     * <span class="hljs-doctag">@param</span> affinityGroupId the id to match in findById
     * <span class="hljs-doctag">@param</span> affinityGroupVO the AffinityGroupVO to return
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stubFindById</span><span class="hljs-params">(AffinityGroupDao affinityGroupDao, <span class="hljs-keyword">long</span> affinityGroupId, AffinityGroupVO affinityGroupVO)</span> </span>{
        when(affinityGroupDao.findById(affinityGroupId)).thenReturn(affinityGroupVO);
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1642">Test Case ID #cloudstack_Test_164_2</h4>
<h4 id="test-case-name-testprocesswithplanfile-cjavaprojectsapachecloudstackpluginsaffinity-group-processorsnon-strict-host-affinitysrctestjavaorgapachecloudstackaffinitynonstricthostaffinityprocessortestjava">Test Case Name: <code>testProcessWithPlan</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\affinity-group-processors\non-strict-host-affinity\src\test\java\org\apache\cloudstack\affinity\NonStrictHostAffinityProcessorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-affinitygroupdao">Mock Object Variable Name: <code>affinityGroupDao</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     ExcludeList avoid = new ExcludeList();
     AffinityGroupVO affinityGroupVO = Mockito.mock(AffinityGroupVO.class);
<span class="hljs-deletion">-    when(affinityGroupDao.findById(affinityGroupId)).thenReturn(affinityGroupVO);</span>
<span class="hljs-addition">+    MockAffinityGroupDao.stubFindById(affinityGroupDao, affinityGroupId, affinityGroupVO);</span>
     when(affinityGroupVO.getId()).thenReturn(affinityGroupId);
     List&lt;Long&gt; groupVMIds = new ArrayList&lt;&gt;(Arrays.asList(vmId, vm2Id, vm3Id));
     when(_affinityGroupVMMapDao.listVmIdsByAffinityGroup(affinityGroupId)).thenReturn(groupVMIds);
     VMInstanceVO vm2 = new VMInstanceVO();
     when(vmInstanceDao.findById(vm2Id)).thenReturn(vm2);
     vm2.setHostId(host2Id);
     VMInstanceVO vm3 = new VMInstanceVO();
     when(vmInstanceDao.findById(vm3Id)).thenReturn(vm3);
     vm3.setHostId(host3Id);
     processor.process(vmProfile, plan, avoid);
     Assert.assertEquals(2, plan.getHostPriorities().size());
     Assert.assertNotNull(plan.getHostPriorities().get(host2Id));
     Assert.assertEquals(Integer.valueOf(1), plan.getHostPriorities().get(host2Id));
     Assert.assertNotNull(plan.getHostPriorities().get(host3Id));
     Assert.assertEquals(Integer.valueOf(0), plan.getHostPriorities().get(host3Id));
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcessWithPlan</span><span class="hljs-params">()</span> </span>{

    VirtualMachine vm = Mockito.mock(VirtualMachine<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vm.getId()).thenReturn(vmId);

    VirtualMachineProfile vmProfile = Mockito.mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vmProfile.getVirtualMachine()).thenReturn(vm);

    List&lt;AffinityGroupVMMapVO&gt; vmGroupMappings = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    vmGroupMappings.add(<span class="hljs-keyword">new</span> AffinityGroupVMMapVO(affinityGroupId, vmId));

    when(_affinityGroupVMMapDao.findByVmIdType(eq(vmId), nullable(String<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">vmGroupMappings</span>)</span>;

    DataCenterDeployment plan = <span class="hljs-keyword">new</span> DataCenterDeployment(zoneId);

    plan.adjustHostPriority(host2Id, DeploymentPlan.HostPriorityAdjustment.DEFAULT);

    plan.adjustHostPriority(host3Id, DeploymentPlan.HostPriorityAdjustment.LOWER);

    ExcludeList avoid = <span class="hljs-keyword">new</span> ExcludeList();

    AffinityGroupVO affinityGroupVO = Mockito.mock(AffinityGroupVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(affinityGroupDao.findById(affinityGroupId)).thenReturn(affinityGroupVO);

    when(affinityGroupVO.getId()).thenReturn(affinityGroupId);

    List&lt;Long&gt; groupVMIds = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(vmId, vm2Id, vm3Id));

    when(_affinityGroupVMMapDao.listVmIdsByAffinityGroup(affinityGroupId)).thenReturn(groupVMIds);

    VMInstanceVO vm2 = <span class="hljs-keyword">new</span> VMInstanceVO();

    when(vmInstanceDao.findById(vm2Id)).thenReturn(vm2);

    vm2.setHostId(host2Id);

    VMInstanceVO vm3 = <span class="hljs-keyword">new</span> VMInstanceVO();

    when(vmInstanceDao.findById(vm3Id)).thenReturn(vm3);

    vm3.setHostId(host3Id);

    processor.process(vmProfile, plan, avoid);

    Assert.assertEquals(<span class="hljs-number">2</span>, plan.getHostPriorities().size());

    Assert.assertNotNull(plan.getHostPriorities().get(host2Id));

    Assert.assertEquals(Integer.valueOf(<span class="hljs-number">1</span>), plan.getHostPriorities().get(host2Id));

    Assert.assertNotNull(plan.getHostPriorities().get(host3Id));

    Assert.assertEquals(Integer.valueOf(<span class="hljs-number">0</span>), plan.getHostPriorities().get(host3Id));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockAffinityGroupDao</span> </span>{
    <span class="hljs-comment">/**
     * Stubs affinityGroupDao.findById to return the provided AffinityGroupVO for the given id.
     *
     * <span class="hljs-doctag">@param</span> affinityGroupDao the mock AffinityGroupDao
     * <span class="hljs-doctag">@param</span> affinityGroupId the id to match in findById
     * <span class="hljs-doctag">@param</span> affinityGroupVO the AffinityGroupVO to return
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stubFindById</span><span class="hljs-params">(AffinityGroupDao affinityGroupDao, <span class="hljs-keyword">long</span> affinityGroupId, AffinityGroupVO affinityGroupVO)</span> </span>{
        when(affinityGroupDao.findById(affinityGroupId)).thenReturn(affinityGroupVO);
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1643">Test Case ID #cloudstack_Test_164_3</h4>
<h4 id="test-case-name-testprocesswithnotrunningvmfile-cjavaprojectsapachecloudstackpluginsaffinity-group-processorsnon-strict-host-affinitysrctestjavaorgapachecloudstackaffinitynonstricthostaffinityprocessortestjava">Test Case Name: <code>testProcessWithNotRunningVM</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\affinity-group-processors\non-strict-host-affinity\src\test\java\org\apache\cloudstack\affinity\NonStrictHostAffinityProcessorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-affinitygroupdao">Mock Object Variable Name: <code>affinityGroupDao</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     ExcludeList avoid = new ExcludeList();
     AffinityGroupVO affinityGroupVO = Mockito.mock(AffinityGroupVO.class);
<span class="hljs-deletion">-    when(affinityGroupDao.findById(affinityGroupId)).thenReturn(affinityGroupVO);</span>
<span class="hljs-addition">+    MockAffinityGroupDao.stubFindById(affinityGroupDao, affinityGroupId, affinityGroupVO);</span>
     when(affinityGroupVO.getId()).thenReturn(affinityGroupId);
     List&lt;Long&gt; groupVMIds = new ArrayList&lt;&gt;(Arrays.asList(vmId, vm2Id));
     when(_affinityGroupVMMapDao.listVmIdsByAffinityGroup(affinityGroupId)).thenReturn(groupVMIds);
     VMInstanceVO vm2 = Mockito.mock(VMInstanceVO.class);
     when(vmInstanceDao.findById(vm2Id)).thenReturn(vm2);
     when(vm2.getHostId()).thenReturn(null);
     when(vm2.getLastHostId()).thenReturn(host2Id);
     when(vm2.getState()).thenReturn(VirtualMachine.State.Starting);
     when(vm2.getUpdateTime()).thenReturn(new Date());
     ReflectionTestUtils.setField(processor, "vmCapacityReleaseInterval", 3600);
     processor.process(vmProfile, plan, avoid);
     Assert.assertEquals(1, plan.getHostPriorities().size());
     Assert.assertNotNull(plan.getHostPriorities().get(host2Id));
     Assert.assertEquals(Integer.valueOf(1), plan.getHostPriorities().get(host2Id));
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcessWithNotRunningVM</span><span class="hljs-params">()</span> </span>{

    VirtualMachine vm = Mockito.mock(VirtualMachine<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vm.getId()).thenReturn(vmId);

    VirtualMachineProfile vmProfile = Mockito.mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vmProfile.getVirtualMachine()).thenReturn(vm);

    List&lt;AffinityGroupVMMapVO&gt; vmGroupMappings = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    vmGroupMappings.add(<span class="hljs-keyword">new</span> AffinityGroupVMMapVO(affinityGroupId, vmId));

    when(_affinityGroupVMMapDao.findByVmIdType(eq(vmId), nullable(String<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">vmGroupMappings</span>)</span>;

    DataCenterDeployment plan = <span class="hljs-keyword">new</span> DataCenterDeployment(zoneId);

    ExcludeList avoid = <span class="hljs-keyword">new</span> ExcludeList();

    AffinityGroupVO affinityGroupVO = Mockito.mock(AffinityGroupVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(affinityGroupDao.findById(affinityGroupId)).thenReturn(affinityGroupVO);

    when(affinityGroupVO.getId()).thenReturn(affinityGroupId);

    List&lt;Long&gt; groupVMIds = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(vmId, vm2Id));

    when(_affinityGroupVMMapDao.listVmIdsByAffinityGroup(affinityGroupId)).thenReturn(groupVMIds);

    VMInstanceVO vm2 = Mockito.mock(VMInstanceVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vmInstanceDao.findById(vm2Id)).thenReturn(vm2);

    when(vm2.getHostId()).thenReturn(<span class="hljs-keyword">null</span>);

    when(vm2.getLastHostId()).thenReturn(host2Id);

    when(vm2.getState()).thenReturn(VirtualMachine.State.Starting);

    when(vm2.getUpdateTime()).thenReturn(<span class="hljs-keyword">new</span> Date());

    ReflectionTestUtils.setField(processor, <span class="hljs-string">"vmCapacityReleaseInterval"</span>, <span class="hljs-number">3600</span>);

    processor.process(vmProfile, plan, avoid);

    Assert.assertEquals(<span class="hljs-number">1</span>, plan.getHostPriorities().size());

    Assert.assertNotNull(plan.getHostPriorities().get(host2Id));

    Assert.assertEquals(Integer.valueOf(<span class="hljs-number">1</span>), plan.getHostPriorities().get(host2Id));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockAffinityGroupDao</span> </span>{
    <span class="hljs-comment">/**
     * Stubs affinityGroupDao.findById to return the provided AffinityGroupVO for the given id.
     *
     * <span class="hljs-doctag">@param</span> affinityGroupDao the mock AffinityGroupDao
     * <span class="hljs-doctag">@param</span> affinityGroupId the id to match in findById
     * <span class="hljs-doctag">@param</span> affinityGroupVO the AffinityGroupVO to return
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stubFindById</span><span class="hljs-params">(AffinityGroupDao affinityGroupDao, <span class="hljs-keyword">long</span> affinityGroupId, AffinityGroupVO affinityGroupVO)</span> </span>{
        when(affinityGroupDao.findById(affinityGroupId)).thenReturn(affinityGroupVO);
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1644">Test Case ID #cloudstack_Test_164_4</h4>
<h4 id="test-case-name-testprocesswithemptyplanfile-cjavaprojectsapachecloudstackpluginsaffinity-group-processorsnon-strict-host-anti-affinitysrctestjavaorgapachecloudstackaffinitynonstricthostantiaffinityprocessortestjava">Test Case Name: <code>testProcessWithEmptyPlan</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\affinity-group-processors\non-strict-host-anti-affinity\src\test\java\org\apache\cloudstack\affinity\NonStrictHostAntiAffinityProcessorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-affinitygroupdao">Mock Object Variable Name: <code>affinityGroupDao</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     ExcludeList avoid = new ExcludeList();
     AffinityGroupVO affinityGroupVO = Mockito.mock(AffinityGroupVO.class);
<span class="hljs-deletion">-    when(affinityGroupDao.findById(affinityGroupId)).thenReturn(affinityGroupVO);</span>
<span class="hljs-addition">+    MockAffinityGroupDao.stubFindById(affinityGroupDao, affinityGroupId, affinityGroupVO);</span>
     when(affinityGroupVO.getId()).thenReturn(affinityGroupId);
     List&lt;Long&gt; groupVMIds = new ArrayList&lt;&gt;(Arrays.asList(vmId, vm2Id));
     when(_affinityGroupVMMapDao.listVmIdsByAffinityGroup(affinityGroupId)).thenReturn(groupVMIds);
     VMInstanceVO vm2 = new VMInstanceVO();
     when(vmInstanceDao.findById(vm2Id)).thenReturn(vm2);
     vm2.setHostId(host2Id);
     processor.process(vmProfile, plan, avoid);
     Assert.assertEquals(1, plan.getHostPriorities().size());
     Assert.assertNotNull(plan.getHostPriorities().get(host2Id));
     Assert.assertEquals(Integer.valueOf(-1), plan.getHostPriorities().get(host2Id));
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcessWithEmptyPlan</span><span class="hljs-params">()</span> </span>{

    VirtualMachine vm = Mockito.mock(VirtualMachine<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vm.getId()).thenReturn(vmId);

    VirtualMachineProfile vmProfile = Mockito.mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vmProfile.getVirtualMachine()).thenReturn(vm);

    List&lt;AffinityGroupVMMapVO&gt; vmGroupMappings = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    vmGroupMappings.add(<span class="hljs-keyword">new</span> AffinityGroupVMMapVO(affinityGroupId, vmId));

    when(_affinityGroupVMMapDao.findByVmIdType(eq(vmId), nullable(String<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">vmGroupMappings</span>)</span>;

    DataCenterDeployment plan = <span class="hljs-keyword">new</span> DataCenterDeployment(zoneId);

    ExcludeList avoid = <span class="hljs-keyword">new</span> ExcludeList();

    AffinityGroupVO affinityGroupVO = Mockito.mock(AffinityGroupVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(affinityGroupDao.findById(affinityGroupId)).thenReturn(affinityGroupVO);

    when(affinityGroupVO.getId()).thenReturn(affinityGroupId);

    List&lt;Long&gt; groupVMIds = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(vmId, vm2Id));

    when(_affinityGroupVMMapDao.listVmIdsByAffinityGroup(affinityGroupId)).thenReturn(groupVMIds);

    VMInstanceVO vm2 = <span class="hljs-keyword">new</span> VMInstanceVO();

    when(vmInstanceDao.findById(vm2Id)).thenReturn(vm2);

    vm2.setHostId(host2Id);

    processor.process(vmProfile, plan, avoid);

    Assert.assertEquals(<span class="hljs-number">1</span>, plan.getHostPriorities().size());

    Assert.assertNotNull(plan.getHostPriorities().get(host2Id));

    Assert.assertEquals(Integer.valueOf(-<span class="hljs-number">1</span>), plan.getHostPriorities().get(host2Id));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockAffinityGroupDao</span> </span>{
    <span class="hljs-comment">/**
     * Stubs affinityGroupDao.findById to return the provided AffinityGroupVO for the given id.
     *
     * <span class="hljs-doctag">@param</span> affinityGroupDao the mock AffinityGroupDao
     * <span class="hljs-doctag">@param</span> affinityGroupId the id to match in findById
     * <span class="hljs-doctag">@param</span> affinityGroupVO the AffinityGroupVO to return
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stubFindById</span><span class="hljs-params">(AffinityGroupDao affinityGroupDao, <span class="hljs-keyword">long</span> affinityGroupId, AffinityGroupVO affinityGroupVO)</span> </span>{
        when(affinityGroupDao.findById(affinityGroupId)).thenReturn(affinityGroupVO);
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1645">Test Case ID #cloudstack_Test_164_5</h4>
<h4 id="test-case-name-testprocesswithplanfile-cjavaprojectsapachecloudstackpluginsaffinity-group-processorsnon-strict-host-anti-affinitysrctestjavaorgapachecloudstackaffinitynonstricthostantiaffinityprocessortestjava">Test Case Name: <code>testProcessWithPlan</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\affinity-group-processors\non-strict-host-anti-affinity\src\test\java\org\apache\cloudstack\affinity\NonStrictHostAntiAffinityProcessorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-affinitygroupdao">Mock Object Variable Name: <code>affinityGroupDao</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     ExcludeList avoid = new ExcludeList();
     AffinityGroupVO affinityGroupVO = Mockito.mock(AffinityGroupVO.class);
<span class="hljs-deletion">-    when(affinityGroupDao.findById(affinityGroupId)).thenReturn(affinityGroupVO);</span>
<span class="hljs-addition">+    MockAffinityGroupDao.stubFindById(affinityGroupDao, affinityGroupId, affinityGroupVO);</span>
     when(affinityGroupVO.getId()).thenReturn(affinityGroupId);
     List&lt;Long&gt; groupVMIds = new ArrayList&lt;&gt;(Arrays.asList(vmId, vm2Id, vm3Id));
     when(_affinityGroupVMMapDao.listVmIdsByAffinityGroup(affinityGroupId)).thenReturn(groupVMIds);
     VMInstanceVO vm2 = new VMInstanceVO();
     when(vmInstanceDao.findById(vm2Id)).thenReturn(vm2);
     vm2.setHostId(host2Id);
     VMInstanceVO vm3 = new VMInstanceVO();
     when(vmInstanceDao.findById(vm3Id)).thenReturn(vm3);
     vm3.setHostId(host3Id);
     processor.process(vmProfile, plan, avoid);
     Assert.assertEquals(2, plan.getHostPriorities().size());
     Assert.assertNotNull(plan.getHostPriorities().get(host2Id));
     Assert.assertEquals(Integer.valueOf(-1), plan.getHostPriorities().get(host2Id));
     Assert.assertNotNull(plan.getHostPriorities().get(host3Id));
     Assert.assertEquals(Integer.valueOf(0), plan.getHostPriorities().get(host3Id));
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcessWithPlan</span><span class="hljs-params">()</span> </span>{

    VirtualMachine vm = Mockito.mock(VirtualMachine<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vm.getId()).thenReturn(vmId);

    VirtualMachineProfile vmProfile = Mockito.mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vmProfile.getVirtualMachine()).thenReturn(vm);

    List&lt;AffinityGroupVMMapVO&gt; vmGroupMappings = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    vmGroupMappings.add(<span class="hljs-keyword">new</span> AffinityGroupVMMapVO(affinityGroupId, vmId));

    when(_affinityGroupVMMapDao.findByVmIdType(eq(vmId), nullable(String<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">vmGroupMappings</span>)</span>;

    DataCenterDeployment plan = <span class="hljs-keyword">new</span> DataCenterDeployment(zoneId);

    plan.adjustHostPriority(host2Id, DeploymentPlan.HostPriorityAdjustment.DEFAULT);

    plan.adjustHostPriority(host3Id, DeploymentPlan.HostPriorityAdjustment.HIGHER);

    ExcludeList avoid = <span class="hljs-keyword">new</span> ExcludeList();

    AffinityGroupVO affinityGroupVO = Mockito.mock(AffinityGroupVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(affinityGroupDao.findById(affinityGroupId)).thenReturn(affinityGroupVO);

    when(affinityGroupVO.getId()).thenReturn(affinityGroupId);

    List&lt;Long&gt; groupVMIds = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(vmId, vm2Id, vm3Id));

    when(_affinityGroupVMMapDao.listVmIdsByAffinityGroup(affinityGroupId)).thenReturn(groupVMIds);

    VMInstanceVO vm2 = <span class="hljs-keyword">new</span> VMInstanceVO();

    when(vmInstanceDao.findById(vm2Id)).thenReturn(vm2);

    vm2.setHostId(host2Id);

    VMInstanceVO vm3 = <span class="hljs-keyword">new</span> VMInstanceVO();

    when(vmInstanceDao.findById(vm3Id)).thenReturn(vm3);

    vm3.setHostId(host3Id);

    processor.process(vmProfile, plan, avoid);

    Assert.assertEquals(<span class="hljs-number">2</span>, plan.getHostPriorities().size());

    Assert.assertNotNull(plan.getHostPriorities().get(host2Id));

    Assert.assertEquals(Integer.valueOf(-<span class="hljs-number">1</span>), plan.getHostPriorities().get(host2Id));

    Assert.assertNotNull(plan.getHostPriorities().get(host3Id));

    Assert.assertEquals(Integer.valueOf(<span class="hljs-number">0</span>), plan.getHostPriorities().get(host3Id));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockAffinityGroupDao</span> </span>{
    <span class="hljs-comment">/**
     * Stubs affinityGroupDao.findById to return the provided AffinityGroupVO for the given id.
     *
     * <span class="hljs-doctag">@param</span> affinityGroupDao the mock AffinityGroupDao
     * <span class="hljs-doctag">@param</span> affinityGroupId the id to match in findById
     * <span class="hljs-doctag">@param</span> affinityGroupVO the AffinityGroupVO to return
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stubFindById</span><span class="hljs-params">(AffinityGroupDao affinityGroupDao, <span class="hljs-keyword">long</span> affinityGroupId, AffinityGroupVO affinityGroupVO)</span> </span>{
        when(affinityGroupDao.findById(affinityGroupId)).thenReturn(affinityGroupVO);
    }
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1646">Test Case ID #cloudstack_Test_164_6</h4>
<h4 id="test-case-name-testprocesswithnotrunningvmfile-cjavaprojectsapachecloudstackpluginsaffinity-group-processorsnon-strict-host-anti-affinitysrctestjavaorgapachecloudstackaffinitynonstricthostantiaffinityprocessortestjava">Test Case Name: <code>testProcessWithNotRunningVM</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\affinity-group-processors\non-strict-host-anti-affinity\src\test\java\org\apache\cloudstack\affinity\NonStrictHostAntiAffinityProcessorTest.java</code>)</h4>
<h4 id="mock-object-variable-name-affinitygroupdao">Mock Object Variable Name: <code>affinityGroupDao</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     ExcludeList avoid = new ExcludeList();
     AffinityGroupVO affinityGroupVO = Mockito.mock(AffinityGroupVO.class);
<span class="hljs-deletion">-    when(affinityGroupDao.findById(affinityGroupId)).thenReturn(affinityGroupVO);</span>
<span class="hljs-addition">+    MockAffinityGroupDao.stubFindById(affinityGroupDao, affinityGroupId, affinityGroupVO);</span>
     when(affinityGroupVO.getId()).thenReturn(affinityGroupId);
     List&lt;Long&gt; groupVMIds = new ArrayList&lt;&gt;(Arrays.asList(vmId, vm2Id));
     when(_affinityGroupVMMapDao.listVmIdsByAffinityGroup(affinityGroupId)).thenReturn(groupVMIds);
     VMInstanceVO vm2 = Mockito.mock(VMInstanceVO.class);
     when(vmInstanceDao.findById(vm2Id)).thenReturn(vm2);
     when(vm2.getHostId()).thenReturn(null);
     when(vm2.getLastHostId()).thenReturn(host2Id);
     when(vm2.getState()).thenReturn(VirtualMachine.State.Starting);
     when(vm2.getUpdateTime()).thenReturn(new Date());
     ReflectionTestUtils.setField(processor, "vmCapacityReleaseInterval", 3600);
     processor.process(vmProfile, plan, avoid);
     Assert.assertEquals(1, plan.getHostPriorities().size());
     Assert.assertNotNull(plan.getHostPriorities().get(host2Id));
     Assert.assertEquals(Integer.valueOf(-1), plan.getHostPriorities().get(host2Id));
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div>
<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcessWithNotRunningVM</span><span class="hljs-params">()</span> </span>{

    VirtualMachine vm = Mockito.mock(VirtualMachine<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vm.getId()).thenReturn(vmId);

    VirtualMachineProfile vmProfile = Mockito.mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vmProfile.getVirtualMachine()).thenReturn(vm);

    List&lt;AffinityGroupVMMapVO&gt; vmGroupMappings = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    vmGroupMappings.add(<span class="hljs-keyword">new</span> AffinityGroupVMMapVO(affinityGroupId, vmId));

    when(_affinityGroupVMMapDao.findByVmIdType(eq(vmId), nullable(String<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">vmGroupMappings</span>)</span>;

    DataCenterDeployment plan = <span class="hljs-keyword">new</span> DataCenterDeployment(zoneId);

    ExcludeList avoid = <span class="hljs-keyword">new</span> ExcludeList();

    AffinityGroupVO affinityGroupVO = Mockito.mock(AffinityGroupVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(affinityGroupDao.findById(affinityGroupId)).thenReturn(affinityGroupVO);

    when(affinityGroupVO.getId()).thenReturn(affinityGroupId);

    List&lt;Long&gt; groupVMIds = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(vmId, vm2Id));

    when(_affinityGroupVMMapDao.listVmIdsByAffinityGroup(affinityGroupId)).thenReturn(groupVMIds);

    VMInstanceVO vm2 = Mockito.mock(VMInstanceVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vmInstanceDao.findById(vm2Id)).thenReturn(vm2);

    when(vm2.getHostId()).thenReturn(<span class="hljs-keyword">null</span>);

    when(vm2.getLastHostId()).thenReturn(host2Id);

    when(vm2.getState()).thenReturn(VirtualMachine.State.Starting);

    when(vm2.getUpdateTime()).thenReturn(<span class="hljs-keyword">new</span> Date());

    ReflectionTestUtils.setField(processor, <span class="hljs-string">"vmCapacityReleaseInterval"</span>, <span class="hljs-number">3600</span>);

    processor.process(vmProfile, plan, avoid);

    Assert.assertEquals(<span class="hljs-number">1</span>, plan.getHostPriorities().size());

    Assert.assertNotNull(plan.getHostPriorities().get(host2Id));

    Assert.assertEquals(Integer.valueOf(-<span class="hljs-number">1</span>), plan.getHostPriorities().get(host2Id));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MockAffinityGroupDao</span> </span>{
    <span class="hljs-comment">/**
     * Stubs affinityGroupDao.findById to return the provided AffinityGroupVO for the given id.
     *
     * <span class="hljs-doctag">@param</span> affinityGroupDao the mock AffinityGroupDao
     * <span class="hljs-doctag">@param</span> affinityGroupId the id to match in findById
     * <span class="hljs-doctag">@param</span> affinityGroupVO the AffinityGroupVO to return
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stubFindById</span><span class="hljs-params">(AffinityGroupDao affinityGroupDao, <span class="hljs-keyword">long</span> affinityGroupId, AffinityGroupVO affinityGroupVO)</span> </span>{
        when(affinityGroupDao.findById(affinityGroupId)).thenReturn(affinityGroupVO);
    }
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci165">Mock Clone Instance #cloudstack_MCI_165</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.cloud.network.IpAddress</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> IpAddress <span class="hljs-title">createMockIpAddress</span><span class="hljs-params">(Ip ip, Long vlanId)</span> </span>{
    IpAddress ipAddress = mock(IpAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(ipAddress.getAddress()).thenReturn(ip);
    <span class="hljs-keyword">if</span> (vlanId != <span class="hljs-keyword">null</span>) {
        when(ipAddress.getVlanId()).thenReturn(vlanId);
    }
    <span class="hljs-keyword">return</span> ipAddress;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest1651">Test Case ID #cloudstack_Test_165_1</h4>
<h4 id="test-case-name-applyfwrulestestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementscisco-vnmcsrctestjavacomcloudnetworkelementciscovnmcelementtestjava">Test Case Name: <code>applyFWRulesTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\cisco-vnmc\src\test\java\com\cloud\network\element\CiscoVnmcElementTest.java</code>)</h4>
<h4 id="mock-object-variable-name-ipaddress">Mock Object Variable Name: <code>ipAddress</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     Ip ip = mock(Ip.class);
     when(ip.addr()).thenReturn("1.2.3.4");
<span class="hljs-deletion">-    IpAddress ipAddress = mock(IpAddress.class);</span>
<span class="hljs-deletion">-    when(ipAddress.getAddress()).thenReturn(ip);</span>
<span class="hljs-addition">+    IpAddress ipAddress = mock(IpAddress.class);</span>
<span class="hljs-addition">+    when(ipAddress.getAddress()).thenReturn(ip);</span>
     when(_networkModel.getIp(anyLong())).thenReturn(ipAddress);
     when(_networkModel.isProviderSupportServiceInNetwork(network.getId(), Service.Firewall, Provider.CiscoVnmc)).thenReturn(true);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">applyFWRulesTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ResourceUnavailableException </span>{

    URI uri = URI.create(<span class="hljs-string">"vlan://123"</span>);

    Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(network.getId()).thenReturn(<span class="hljs-number">1L</span>);

    when(network.getBroadcastDomainType()).thenReturn(BroadcastDomainType.Vlan);

    when(network.getDataCenterId()).thenReturn(<span class="hljs-number">1L</span>);

    when(network.getBroadcastUri()).thenReturn(uri);

    when(network.getCidr()).thenReturn(<span class="hljs-string">"1.1.1.0/24"</span>);

    when(network.getState()).thenReturn(Network.State.Implemented);

    Ip ip = mock(Ip<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(ip.addr()).thenReturn(<span class="hljs-string">"1.2.3.4"</span>);

    IpAddress ipAddress = mock(IpAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(ipAddress.getAddress()).thenReturn(ip);

    when(_networkModel.getIp(anyLong())).thenReturn(ipAddress);

    when(_networkModel.isProviderSupportServiceInNetwork(network.getId(), Service.Firewall, Provider.CiscoVnmc)).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;CiscoVnmcControllerVO&gt; devices = <span class="hljs-keyword">new</span> ArrayList&lt;CiscoVnmcControllerVO&gt;();

    devices.add(mock(CiscoVnmcControllerVO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    when(_ciscoVnmcDao.listByPhysicalNetwork(network.getPhysicalNetworkId())).thenReturn(devices);

    when(_networkAsa1000vMapDao.findByNetworkId(network.getId())).thenReturn(mock(NetworkAsa1000vMapVO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    HostVO hostVO = mock(HostVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(hostVO.getId()).thenReturn(<span class="hljs-number">1L</span>);

    when(_hostDao.findById(anyLong())).thenReturn(hostVO);

    FirewallRule rule = mock(FirewallRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(rule.getSourceIpAddressId()).thenReturn(<span class="hljs-number">1L</span>);

    List&lt;FirewallRule&gt; rules = <span class="hljs-keyword">new</span> ArrayList&lt;FirewallRule&gt;();

    rules.add(rule);

    Answer answer = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(answer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(_agentMgr.easySend(anyLong(), any(SetFirewallRulesCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">answer</span>)</span>;

    assertTrue(_element.applyFWRules(network, rules));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> IpAddress <span class="hljs-title">createMockIpAddress</span><span class="hljs-params">(Ip ip, Long vlanId)</span> </span>{
    IpAddress ipAddress = mock(IpAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(ipAddress.getAddress()).thenReturn(ip);
    <span class="hljs-keyword">if</span> (vlanId != <span class="hljs-keyword">null</span>) {
        when(ipAddress.getVlanId()).thenReturn(vlanId);
    }
    <span class="hljs-keyword">return</span> ipAddress;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1652">Test Case ID #cloudstack_Test_165_2</h4>
<h4 id="test-case-name-applyprulestestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementscisco-vnmcsrctestjavacomcloudnetworkelementciscovnmcelementtestjava">Test Case Name: <code>applyPRulesTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\cisco-vnmc\src\test\java\com\cloud\network\element\CiscoVnmcElementTest.java</code>)</h4>
<h4 id="mock-object-variable-name-ipaddress">Mock Object Variable Name: <code>ipAddress</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     Ip ip = mock(Ip.class);
     when(ip.addr()).thenReturn("1.2.3.4");
<span class="hljs-deletion">-    IpAddress ipAddress = mock(IpAddress.class);</span>
<span class="hljs-deletion">-    when(ipAddress.getAddress()).thenReturn(ip);</span>
<span class="hljs-deletion">-    when(ipAddress.getVlanId()).thenReturn(1L);</span>
<span class="hljs-addition">+    IpAddress ipAddress = mock(IpAddress.class);</span>
<span class="hljs-addition">+    when(ipAddress.getAddress()).thenReturn(ip);</span>
<span class="hljs-addition">+    when(ipAddress.getVlanId()).thenReturn(1L);</span>
     when(_networkModel.getIp(anyLong())).thenReturn(ipAddress);
     when(_networkModel.isProviderSupportServiceInNetwork(network.getId(), Service.PortForwarding, Provider.CiscoVnmc)).thenReturn(true);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">applyPRulesTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ResourceUnavailableException </span>{

    URI uri = URI.create(<span class="hljs-string">"vlan://123"</span>);

    Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(network.getId()).thenReturn(<span class="hljs-number">1L</span>);

    when(network.getBroadcastDomainType()).thenReturn(BroadcastDomainType.Vlan);

    when(network.getDataCenterId()).thenReturn(<span class="hljs-number">1L</span>);

    when(network.getBroadcastUri()).thenReturn(uri);

    when(network.getCidr()).thenReturn(<span class="hljs-string">"1.1.1.0/24"</span>);

    when(network.getState()).thenReturn(Network.State.Implemented);

    Ip ip = mock(Ip<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(ip.addr()).thenReturn(<span class="hljs-string">"1.2.3.4"</span>);

    IpAddress ipAddress = mock(IpAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(ipAddress.getAddress()).thenReturn(ip);

    when(ipAddress.getVlanId()).thenReturn(<span class="hljs-number">1L</span>);

    when(_networkModel.getIp(anyLong())).thenReturn(ipAddress);

    when(_networkModel.isProviderSupportServiceInNetwork(network.getId(), Service.PortForwarding, Provider.CiscoVnmc)).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;CiscoVnmcControllerVO&gt; devices = <span class="hljs-keyword">new</span> ArrayList&lt;CiscoVnmcControllerVO&gt;();

    devices.add(mock(CiscoVnmcControllerVO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    when(_ciscoVnmcDao.listByPhysicalNetwork(network.getPhysicalNetworkId())).thenReturn(devices);

    when(_networkAsa1000vMapDao.findByNetworkId(network.getId())).thenReturn(mock(NetworkAsa1000vMapVO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    HostVO hostVO = mock(HostVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(hostVO.getId()).thenReturn(<span class="hljs-number">1L</span>);

    when(_hostDao.findById(anyLong())).thenReturn(hostVO);

    VlanVO vlanVO = mock(VlanVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vlanVO.getVlanTag()).thenReturn(<span class="hljs-keyword">null</span>);

    when(_vlanDao.findById(anyLong())).thenReturn(vlanVO);

    PortForwardingRule rule = mock(PortForwardingRule<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(rule.getSourceIpAddressId()).thenReturn(<span class="hljs-number">1L</span>);

    when(rule.getDestinationIpAddress()).thenReturn(ip);

    List&lt;PortForwardingRule&gt; rules = <span class="hljs-keyword">new</span> ArrayList&lt;PortForwardingRule&gt;();

    rules.add(rule);

    Answer answer = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(answer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(_agentMgr.easySend(anyLong(), any(SetPortForwardingRulesCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">answer</span>)</span>;

    assertTrue(_element.applyPFRules(network, rules));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> IpAddress <span class="hljs-title">createMockIpAddress</span><span class="hljs-params">(Ip ip, Long vlanId)</span> </span>{
    IpAddress ipAddress = mock(IpAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(ipAddress.getAddress()).thenReturn(ip);
    <span class="hljs-keyword">if</span> (vlanId != <span class="hljs-keyword">null</span>) {
        when(ipAddress.getVlanId()).thenReturn(vlanId);
    }
    <span class="hljs-keyword">return</span> ipAddress;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1653">Test Case ID #cloudstack_Test_165_3</h4>
<h4 id="test-case-name-applystaticnatstestfile-cjavaprojectsapachecloudstackpluginsnetwork-elementscisco-vnmcsrctestjavacomcloudnetworkelementciscovnmcelementtestjava">Test Case Name: <code>applyStaticNatsTest</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\cisco-vnmc\src\test\java\com\cloud\network\element\CiscoVnmcElementTest.java</code>)</h4>
<h4 id="mock-object-variable-name-ipaddress">Mock Object Variable Name: <code>ipAddress</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     Ip ip = mock(Ip.class);
     when(ip.addr()).thenReturn("1.2.3.4");
<span class="hljs-deletion">-    IpAddress ipAddress = mock(IpAddress.class);</span>
<span class="hljs-deletion">-    when(ipAddress.getAddress()).thenReturn(ip);</span>
<span class="hljs-deletion">-    when(ipAddress.getVlanId()).thenReturn(1L);</span>
<span class="hljs-addition">+    IpAddress ipAddress = mock(IpAddress.class);</span>
<span class="hljs-addition">+    when(ipAddress.getAddress()).thenReturn(ip);</span>
<span class="hljs-addition">+    when(ipAddress.getVlanId()).thenReturn(1L);</span>
     when(_networkModel.getIp(anyLong())).thenReturn(ipAddress);
     when(_networkModel.isProviderSupportServiceInNetwork(network.getId(), Service.StaticNat, Provider.CiscoVnmc)).thenReturn(true);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">applyStaticNatsTest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ResourceUnavailableException </span>{

    URI uri = URI.create(<span class="hljs-string">"vlan://123"</span>);

    Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(network.getId()).thenReturn(<span class="hljs-number">1L</span>);

    when(network.getBroadcastDomainType()).thenReturn(BroadcastDomainType.Vlan);

    when(network.getDataCenterId()).thenReturn(<span class="hljs-number">1L</span>);

    when(network.getBroadcastUri()).thenReturn(uri);

    when(network.getCidr()).thenReturn(<span class="hljs-string">"1.1.1.0/24"</span>);

    when(network.getState()).thenReturn(Network.State.Implemented);

    Ip ip = mock(Ip<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(ip.addr()).thenReturn(<span class="hljs-string">"1.2.3.4"</span>);

    IpAddress ipAddress = mock(IpAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(ipAddress.getAddress()).thenReturn(ip);

    when(ipAddress.getVlanId()).thenReturn(<span class="hljs-number">1L</span>);

    when(_networkModel.getIp(anyLong())).thenReturn(ipAddress);

    when(_networkModel.isProviderSupportServiceInNetwork(network.getId(), Service.StaticNat, Provider.CiscoVnmc)).thenReturn(<span class="hljs-keyword">true</span>);

    List&lt;CiscoVnmcControllerVO&gt; devices = <span class="hljs-keyword">new</span> ArrayList&lt;CiscoVnmcControllerVO&gt;();

    devices.add(mock(CiscoVnmcControllerVO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    when(_ciscoVnmcDao.listByPhysicalNetwork(network.getPhysicalNetworkId())).thenReturn(devices);

    when(_networkAsa1000vMapDao.findByNetworkId(network.getId())).thenReturn(mock(NetworkAsa1000vMapVO<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;

    HostVO hostVO = mock(HostVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(hostVO.getId()).thenReturn(<span class="hljs-number">1L</span>);

    when(_hostDao.findById(anyLong())).thenReturn(hostVO);

    VlanVO vlanVO = mock(VlanVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vlanVO.getVlanTag()).thenReturn(<span class="hljs-keyword">null</span>);

    when(_vlanDao.findById(anyLong())).thenReturn(vlanVO);

    StaticNat rule = mock(StaticNat<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(rule.getSourceIpAddressId()).thenReturn(<span class="hljs-number">1L</span>);

    when(rule.getDestIpAddress()).thenReturn(<span class="hljs-string">"1.2.3.4"</span>);

    when(rule.isForRevoke()).thenReturn(<span class="hljs-keyword">false</span>);

    List&lt;StaticNat&gt; rules = <span class="hljs-keyword">new</span> ArrayList&lt;StaticNat&gt;();

    rules.add(rule);

    Answer answer = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(answer.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(_agentMgr.easySend(anyLong(), any(SetStaticNatRulesCommand<span class="hljs-class">.<span class="hljs-keyword">class</span>))).<span class="hljs-title">thenReturn</span>(<span class="hljs-title">answer</span>)</span>;

    assertTrue(_element.applyStaticNats(network, rules));

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> IpAddress <span class="hljs-title">createMockIpAddress</span><span class="hljs-params">(Ip ip, Long vlanId)</span> </span>{
    IpAddress ipAddress = mock(IpAddress<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(ipAddress.getAddress()).thenReturn(ip);
    <span class="hljs-keyword">if</span> (vlanId != <span class="hljs-keyword">null</span>) {
        when(ipAddress.getVlanId()).thenReturn(vlanId);
    }
    <span class="hljs-keyword">return</span> ipAddress;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci166">Mock Clone Instance #cloudstack_MCI_166</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.cloud.agent.manager.Commands</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Commands <span class="hljs-title">createMockCommandsWithSize</span><span class="hljs-params">(<span class="hljs-keyword">int</span> size)</span> </span>{
    Commands commands = mock(Commands<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(commands.size()).thenReturn(size);
    <span class="hljs-keyword">return</span> commands;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest1661">Test Case ID #cloudstack_Test_166_1</h4>
<h4 id="test-case-name-testsendcommandstorouterfile-cjavaprojectsapachecloudstackserversrctestjavacomcloudnetworkrouternetworkhelperimpltestjava">Test Case Name: <code>testSendCommandsToRouter</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\network\router\NetworkHelperImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-commands">Mock Object Variable Name: <code>commands</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     doReturn(true).when(nwHelperUT).checkRouterVersion(vr);
<span class="hljs-deletion">-    Commands commands = mock(Commands.class);</span>
<span class="hljs-deletion">-    when(commands.size()).thenReturn(3);</span>
<span class="hljs-addition">+    Commands commands = mock(Commands.class); // No reusable helper available for Commands mock</span>
<span class="hljs-addition">+    when(commands.size()).thenReturn(3);</span>
     Answer answer1 = mock(Answer.class);
     Answer answer2 = mock(Answer.class);
     Answer answer3 = mock(Answer.class);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSendCommandsToRouter</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> AgentUnavailableException, OperationTimedoutException, ResourceUnavailableException </span>{

    <span class="hljs-comment">// Prepare</span>

    NetworkHelperImpl nwHelperUT = spy(<span class="hljs-keyword">this</span>.nwHelper);

    VirtualRouter vr = mock(VirtualRouter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vr.getHostId()).thenReturn(HOST_ID);

    doReturn(<span class="hljs-keyword">true</span>).when(nwHelperUT).checkRouterVersion(vr);

    Commands commands = mock(Commands<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(commands.size()).thenReturn(<span class="hljs-number">3</span>);

    Answer answer1 = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Answer answer2 = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Answer answer3 = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// In the second iteration it should match and return, without invoking the third</span>

    Answer[] answers = { answer1, answer2, answer3 };

    when(answer1.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(answer2.getResult()).thenReturn(<span class="hljs-keyword">false</span>);

    lenient().when(answer3.getResult()).thenReturn(<span class="hljs-keyword">false</span>);

    when(<span class="hljs-keyword">this</span>.agentManager.send(HOST_ID, commands)).thenReturn(answers);

    <span class="hljs-comment">// Execute</span>

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> result = nwHelperUT.sendCommandsToRouter(vr, commands);

    <span class="hljs-comment">// Assert</span>

    verify(<span class="hljs-keyword">this</span>.agentManager, times(<span class="hljs-number">1</span>)).send(HOST_ID, commands);

    verify(answer1, times(<span class="hljs-number">1</span>)).getResult();

    verify(answer2, times(<span class="hljs-number">1</span>)).getResult();

    verify(answer3, times(<span class="hljs-number">0</span>)).getResult();

    assertFalse(result);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Commands <span class="hljs-title">createMockCommandsWithSize</span><span class="hljs-params">(<span class="hljs-keyword">int</span> size)</span> </span>{
    Commands commands = mock(Commands<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(commands.size()).thenReturn(size);
    <span class="hljs-keyword">return</span> commands;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1662">Test Case ID #cloudstack_Test_166_2</h4>
<h4 id="test-case-name-testsendcommandstorouterwithtrueresultfile-cjavaprojectsapachecloudstackserversrctestjavacomcloudnetworkrouternetworkhelperimpltestjava">Test Case Name: <code>testSendCommandsToRouterWithTrueResult</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\network\router\NetworkHelperImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-commands">Mock Object Variable Name: <code>commands</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     doReturn(true).when(nwHelperUT).checkRouterVersion(vr);
<span class="hljs-deletion">-    Commands commands = mock(Commands.class);</span>
<span class="hljs-deletion">-    when(commands.size()).thenReturn(3);</span>
<span class="hljs-addition">+    Commands commands = mock(Commands.class); // No reusable helper available for Commands mock</span>
<span class="hljs-addition">+    when(commands.size()).thenReturn(3);</span>
     Answer answer1 = mock(Answer.class);
     Answer answer2 = mock(Answer.class);
     Answer answer3 = mock(Answer.class);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * The only way result can be true is if each and every command receive a true result

 *

 * <span class="hljs-doctag">@throws</span> AgentUnavailableException

 * <span class="hljs-doctag">@throws</span> OperationTimedoutException

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSendCommandsToRouterWithTrueResult</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> AgentUnavailableException, OperationTimedoutException, ResourceUnavailableException </span>{

    <span class="hljs-comment">// Prepare</span>

    NetworkHelperImpl nwHelperUT = spy(<span class="hljs-keyword">this</span>.nwHelper);

    VirtualRouter vr = mock(VirtualRouter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vr.getHostId()).thenReturn(HOST_ID);

    doReturn(<span class="hljs-keyword">true</span>).when(nwHelperUT).checkRouterVersion(vr);

    Commands commands = mock(Commands<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(commands.size()).thenReturn(<span class="hljs-number">3</span>);

    Answer answer1 = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Answer answer2 = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Answer answer3 = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// In the second iteration it should match and return, without invoking the third</span>

    Answer[] answers = { answer1, answer2, answer3 };

    when(answer1.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(answer2.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(answer3.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    when(<span class="hljs-keyword">this</span>.agentManager.send(HOST_ID, commands)).thenReturn(answers);

    <span class="hljs-comment">// Execute</span>

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> result = nwHelperUT.sendCommandsToRouter(vr, commands);

    <span class="hljs-comment">// Assert</span>

    verify(<span class="hljs-keyword">this</span>.agentManager, times(<span class="hljs-number">1</span>)).send(HOST_ID, commands);

    verify(answer1, times(<span class="hljs-number">1</span>)).getResult();

    verify(answer2, times(<span class="hljs-number">1</span>)).getResult();

    verify(answer3, times(<span class="hljs-number">1</span>)).getResult();

    assertTrue(result);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Commands <span class="hljs-title">createMockCommandsWithSize</span><span class="hljs-params">(<span class="hljs-keyword">int</span> size)</span> </span>{
    Commands commands = mock(Commands<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(commands.size()).thenReturn(size);
    <span class="hljs-keyword">return</span> commands;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1663">Test Case ID #cloudstack_Test_166_3</h4>
<h4 id="test-case-name-testsendcommandstorouterwithnoanswersfile-cjavaprojectsapachecloudstackserversrctestjavacomcloudnetworkrouternetworkhelperimpltestjava">Test Case Name: <code>testSendCommandsToRouterWithNoAnswers</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\network\router\NetworkHelperImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-commands">Mock Object Variable Name: <code>commands</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     doReturn(true).when(nwHelperUT).checkRouterVersion(vr);
<span class="hljs-deletion">-    Commands commands = mock(Commands.class);</span>
<span class="hljs-deletion">-    when(commands.size()).thenReturn(3);</span>
<span class="hljs-addition">+    Commands commands = mock(Commands.class); // No reusable helper available for Commands mock</span>
<span class="hljs-addition">+    when(commands.size()).thenReturn(3);</span>
     Answer answer1 = mock(Answer.class);
     Answer answer2 = mock(Answer.class);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-comment">/**

 * If the number of answers is different to the number of commands the result is false

 *

 * <span class="hljs-doctag">@throws</span> AgentUnavailableException

 * <span class="hljs-doctag">@throws</span> OperationTimedoutException

 */</span>

<span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSendCommandsToRouterWithNoAnswers</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> AgentUnavailableException, OperationTimedoutException, ResourceUnavailableException </span>{

    <span class="hljs-comment">// Prepare</span>

    NetworkHelperImpl nwHelperUT = spy(<span class="hljs-keyword">this</span>.nwHelper);

    VirtualRouter vr = mock(VirtualRouter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(vr.getHostId()).thenReturn(HOST_ID);

    doReturn(<span class="hljs-keyword">true</span>).when(nwHelperUT).checkRouterVersion(vr);

    Commands commands = mock(Commands<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(commands.size()).thenReturn(<span class="hljs-number">3</span>);

    Answer answer1 = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Answer answer2 = mock(Answer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">// In the second iteration it should match and return, without invoking the third</span>

    Answer[] answers = { answer1, answer2 };

    when(<span class="hljs-keyword">this</span>.agentManager.send(HOST_ID, commands)).thenReturn(answers);

    <span class="hljs-comment">// Execute</span>

    <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> result = nwHelperUT.sendCommandsToRouter(vr, commands);

    <span class="hljs-comment">// Assert</span>

    verify(<span class="hljs-keyword">this</span>.agentManager, times(<span class="hljs-number">1</span>)).send(HOST_ID, commands);

    verify(answer1, times(<span class="hljs-number">0</span>)).getResult();

    assertFalse(result);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Commands <span class="hljs-title">createMockCommandsWithSize</span><span class="hljs-params">(<span class="hljs-keyword">int</span> size)</span> </span>{
    Commands commands = mock(Commands<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(commands.size()).thenReturn(size);
    <span class="hljs-keyword">return</span> commands;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci167">Mock Clone Instance #cloudstack_MCI_167</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.cloud.agent.manager.Commands</code></li>
<li><strong>Test Case Count</strong>: 2</li>
<li><strong>MO Count</strong>: 2</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Commands <span class="hljs-title">mockCommandsWithCheckSshAnswer</span><span class="hljs-params">(CheckSshAnswer answerMock)</span> </span>{
    Commands cmds = mock(Commands<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(cmds.getAnswer(<span class="hljs-string">"checkSsh"</span>)).thenReturn(answerMock);
    <span class="hljs-keyword">return</span> cmds;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest1671">Test Case ID #cloudstack_Test_167_1</h4>
<h4 id="test-case-name-testfinalizestartwhencmdsanswerisnotnullbutanswerresultisfalsefile-cjavaprojectsapachecloudstackpluginsnetwork-elementselastic-loadbalancersrctestjavacomcloudnetworklbelasticloadbalancermanagerimpltestjava">Test Case Name: <code>testFinalizeStartWhenCmdsAnswerIsNotNullButAnswerResultIsFalse</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\elastic-loadbalancer\src\test\java\com\cloud\network\lb\ElasticLoadBalancerManagerImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-cmds">Mock Object Variable Name: <code>cmds</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testFinalizeStartWhenCmdsAnswerIsNotNullButAnswerResultIsFalse() throws Exception {
     CheckSshAnswer answerMock = mock(CheckSshAnswer.class);
     when(answerMock.getResult()).thenReturn(false);
     VirtualMachineProfile profileMock = mock(VirtualMachineProfile.class);
     long hostId = 1L;
<span class="hljs-deletion">-    Commands cmds = mock(Commands.class);</span>
<span class="hljs-deletion">-    when(cmds.getAnswer("checkSsh")).thenReturn(answerMock);</span>
<span class="hljs-addition">+    Commands cmds = createMockCommandsWithAnswer(answerMock);</span>
     ReservationContext context = mock(ReservationContext.class);
     boolean expected = false;
     boolean actual = elasticLoadBalancerManagerImpl.finalizeStart(profileMock, hostId, cmds, context);
     assertEquals(expected, actual);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFinalizeStartWhenCmdsAnswerIsNotNullButAnswerResultIsFalse</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    CheckSshAnswer answerMock = mock(CheckSshAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(answerMock.getResult()).thenReturn(<span class="hljs-keyword">false</span>);

    VirtualMachineProfile profileMock = mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">long</span> hostId = <span class="hljs-number">1L</span>;

    Commands cmds = mock(Commands<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(cmds.getAnswer(<span class="hljs-string">"checkSsh"</span>)).thenReturn(answerMock);

    ReservationContext context = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">boolean</span> expected = <span class="hljs-keyword">false</span>;

    <span class="hljs-keyword">boolean</span> actual = elasticLoadBalancerManagerImpl.finalizeStart(profileMock, hostId, cmds, context);

    assertEquals(expected, actual);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Commands <span class="hljs-title">mockCommandsWithCheckSshAnswer</span><span class="hljs-params">(CheckSshAnswer answerMock)</span> </span>{
    Commands cmds = mock(Commands<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(cmds.getAnswer(<span class="hljs-string">"checkSsh"</span>)).thenReturn(answerMock);
    <span class="hljs-keyword">return</span> cmds;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1672">Test Case ID #cloudstack_Test_167_2</h4>
<h4 id="test-case-name-testfinalizestartwhencmdsanswerisnotnullandanswerresultistruefile-cjavaprojectsapachecloudstackpluginsnetwork-elementselastic-loadbalancersrctestjavacomcloudnetworklbelasticloadbalancermanagerimpltestjava">Test Case Name: <code>testFinalizeStartWhenCmdsAnswerIsNotNullAndAnswerResultIsTrue</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\elastic-loadbalancer\src\test\java\com\cloud\network\lb\ElasticLoadBalancerManagerImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-cmds">Mock Object Variable Name: <code>cmds</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testFinalizeStartWhenCmdsAnswerIsNotNullAndAnswerResultIsTrue() throws Exception {
     CheckSshAnswer answerMock = mock(CheckSshAnswer.class);
     when(answerMock.getResult()).thenReturn(true);
     VirtualMachineProfile profileMock = mock(VirtualMachineProfile.class);
     long hostId = 1L;
<span class="hljs-deletion">-    Commands cmds = mock(Commands.class);</span>
<span class="hljs-deletion">-    when(cmds.getAnswer("checkSsh")).thenReturn(answerMock);</span>
<span class="hljs-addition">+    Commands cmds = createMockCommandsWithAnswer(answerMock);</span>
     ReservationContext context = mock(ReservationContext.class);
     boolean expected = true;
     boolean actual = elasticLoadBalancerManagerImpl.finalizeStart(profileMock, hostId, cmds, context);
     assertEquals(expected, actual);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFinalizeStartWhenCmdsAnswerIsNotNullAndAnswerResultIsTrue</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{

    CheckSshAnswer answerMock = mock(CheckSshAnswer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(answerMock.getResult()).thenReturn(<span class="hljs-keyword">true</span>);

    VirtualMachineProfile profileMock = mock(VirtualMachineProfile<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">long</span> hostId = <span class="hljs-number">1L</span>;

    Commands cmds = mock(Commands<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(cmds.getAnswer(<span class="hljs-string">"checkSsh"</span>)).thenReturn(answerMock);

    ReservationContext context = mock(ReservationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">boolean</span> expected = <span class="hljs-keyword">true</span>;

    <span class="hljs-keyword">boolean</span> actual = elasticLoadBalancerManagerImpl.finalizeStart(profileMock, hostId, cmds, context);

    assertEquals(expected, actual);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Commands <span class="hljs-title">mockCommandsWithCheckSshAnswer</span><span class="hljs-params">(CheckSshAnswer answerMock)</span> </span>{
    Commands cmds = mock(Commands<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    when(cmds.getAnswer(<span class="hljs-string">"checkSsh"</span>)).thenReturn(answerMock);
    <span class="hljs-keyword">return</span> cmds;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci172">Mock Clone Instance #cloudstack_MCI_172</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.cloud.user.Account</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> Account account;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    account = mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest1721">Test Case ID #cloudstack_Test_172_1</h4>
<h4 id="test-case-name-testdesignfile-cjavaprojectsapachecloudstackpluginsnetwork-elementsnicira-nvpsrctestjavacomcloudnetworkguruniciranvpguestnetworkgurutestjava">Test Case Name: <code>testDesign</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\nicira-nvp\src\test\java\com\cloud\network\guru\NiciraNvpGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-account">Mock Object Variable Name: <code>account</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testDesign() {
     final PhysicalNetworkVO physnet = mock(PhysicalNetworkVO.class);
     when(physnetdao.findById((Long) any())).thenReturn(physnet);
     when(physnet.getIsolationMethods()).thenReturn(Arrays.asList(new String[] { "STT", "VXLAN" }));
     when(physnet.getId()).thenReturn(NETWORK_ID);
     final NiciraNvpDeviceVO device = mock(NiciraNvpDeviceVO.class);
     when(nvpdao.listByPhysicalNetwork(NETWORK_ID)).thenReturn(Arrays.asList(new NiciraNvpDeviceVO[] { device }));
     when(device.getId()).thenReturn(1L);
     final NetworkOffering offering = mock(NetworkOffering.class);
     when(offering.getId()).thenReturn(NETWORK_ID);
     when(offering.getTrafficType()).thenReturn(TrafficType.Guest);
     when(offering.getGuestType()).thenReturn(GuestType.Isolated);
     when(nosd.areServicesSupportedByNetworkOffering(NETWORK_ID, Service.Connectivity)).thenReturn(true);
     when(netmodel.listNetworkOfferingServices(NETWORK_ID)).thenReturn(Arrays.asList(Service.Connectivity));
     final DeploymentPlan plan = mock(DeploymentPlan.class);
     final Network network = mock(Network.class);
<span class="hljs-deletion">-    final Account account = mock(Account.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `account`</span>
     final Network designednetwork = guru.design(offering, plan, network, account);
     assertTrue(designednetwork != null);
     assertTrue(designednetwork.getBroadcastDomainType() == BroadcastDomainType.Lswitch);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDesign</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> PhysicalNetworkVO physnet = mock(PhysicalNetworkVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(physnetdao.findById((Long) any())).thenReturn(physnet);

    when(physnet.getIsolationMethods()).thenReturn(Arrays.asList(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"STT"</span>, <span class="hljs-string">"VXLAN"</span> }));

    when(physnet.getId()).thenReturn(NETWORK_ID);

    <span class="hljs-keyword">final</span> NiciraNvpDeviceVO device = mock(NiciraNvpDeviceVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(nvpdao.listByPhysicalNetwork(NETWORK_ID)).thenReturn(Arrays.asList(<span class="hljs-keyword">new</span> NiciraNvpDeviceVO[] { device }));

    when(device.getId()).thenReturn(<span class="hljs-number">1L</span>);

    <span class="hljs-keyword">final</span> NetworkOffering offering = mock(NetworkOffering<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(offering.getId()).thenReturn(NETWORK_ID);

    when(offering.getTrafficType()).thenReturn(TrafficType.Guest);

    when(offering.getGuestType()).thenReturn(GuestType.Isolated);

    when(nosd.areServicesSupportedByNetworkOffering(NETWORK_ID, Service.Connectivity)).thenReturn(<span class="hljs-keyword">true</span>);

    when(netmodel.listNetworkOfferingServices(NETWORK_ID)).thenReturn(Arrays.asList(Service.Connectivity));

    <span class="hljs-keyword">final</span> DeploymentPlan plan = mock(DeploymentPlan<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Account account = mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network designednetwork = guru.design(offering, plan, network, account);

    assertTrue(designednetwork != <span class="hljs-keyword">null</span>);

    assertTrue(designednetwork.getBroadcastDomainType() == BroadcastDomainType.Lswitch);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> Account account;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    account = mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1722">Test Case ID #cloudstack_Test_172_2</h4>
<h4 id="test-case-name-testdesignnoelementonphysicalnetworkfile-cjavaprojectsapachecloudstackpluginsnetwork-elementsnicira-nvpsrctestjavacomcloudnetworkguruniciranvpguestnetworkgurutestjava">Test Case Name: <code>testDesignNoElementOnPhysicalNetwork</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\nicira-nvp\src\test\java\com\cloud\network\guru\NiciraNvpGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-account">Mock Object Variable Name: <code>account</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testDesignNoElementOnPhysicalNetwork() {
     final PhysicalNetworkVO physnet = mock(PhysicalNetworkVO.class);
     when(physnetdao.findById((Long) any())).thenReturn(physnet);
     when(physnet.getIsolationMethods()).thenReturn(Arrays.asList(new String[] { "STT", "VXLAN" }));
     when(physnet.getId()).thenReturn(NETWORK_ID);
     mock(NiciraNvpDeviceVO.class);
     when(nvpdao.listByPhysicalNetwork(NETWORK_ID)).thenReturn(Collections.&lt;NiciraNvpDeviceVO&gt;emptyList());
     final NetworkOffering offering = mock(NetworkOffering.class);
     when(offering.getId()).thenReturn(NETWORK_ID);
     when(offering.getTrafficType()).thenReturn(TrafficType.Guest);
     when(offering.getGuestType()).thenReturn(GuestType.Isolated);
     final DeploymentPlan plan = mock(DeploymentPlan.class);
     final Network network = mock(Network.class);
<span class="hljs-deletion">-    final Account account = mock(Account.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `account`</span>
     final Network designednetwork = guru.design(offering, plan, network, account);
     assertTrue(designednetwork == null);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDesignNoElementOnPhysicalNetwork</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> PhysicalNetworkVO physnet = mock(PhysicalNetworkVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(physnetdao.findById((Long) any())).thenReturn(physnet);

    when(physnet.getIsolationMethods()).thenReturn(Arrays.asList(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"STT"</span>, <span class="hljs-string">"VXLAN"</span> }));

    when(physnet.getId()).thenReturn(NETWORK_ID);

    mock(NiciraNvpDeviceVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(nvpdao.listByPhysicalNetwork(NETWORK_ID)).thenReturn(Collections.&lt;NiciraNvpDeviceVO&gt;emptyList());

    <span class="hljs-keyword">final</span> NetworkOffering offering = mock(NetworkOffering<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(offering.getId()).thenReturn(NETWORK_ID);

    when(offering.getTrafficType()).thenReturn(TrafficType.Guest);

    when(offering.getGuestType()).thenReturn(GuestType.Isolated);

    <span class="hljs-keyword">final</span> DeploymentPlan plan = mock(DeploymentPlan<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Account account = mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network designednetwork = guru.design(offering, plan, network, account);

    assertTrue(designednetwork == <span class="hljs-keyword">null</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> Account account;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    account = mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1723">Test Case ID #cloudstack_Test_172_3</h4>
<h4 id="test-case-name-testdesignnoisolationmethodsttfile-cjavaprojectsapachecloudstackpluginsnetwork-elementsnicira-nvpsrctestjavacomcloudnetworkguruniciranvpguestnetworkgurutestjava">Test Case Name: <code>testDesignNoIsolationMethodSTT</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\nicira-nvp\src\test\java\com\cloud\network\guru\NiciraNvpGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-account">Mock Object Variable Name: <code>account</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testDesignNoIsolationMethodSTT() {
     final PhysicalNetworkVO physnet = mock(PhysicalNetworkVO.class);
     when(physnetdao.findById((Long) any())).thenReturn(physnet);
     when(physnet.getIsolationMethods()).thenReturn(Arrays.asList(new String[] { "VLAN" }));
     when(physnet.getId()).thenReturn(NETWORK_ID);
     mock(NiciraNvpDeviceVO.class);
     when(nvpdao.listByPhysicalNetwork(NETWORK_ID)).thenReturn(Collections.&lt;NiciraNvpDeviceVO&gt;emptyList());
     final NetworkOffering offering = mock(NetworkOffering.class);
     when(offering.getId()).thenReturn(NETWORK_ID);
     when(offering.getTrafficType()).thenReturn(TrafficType.Guest);
     when(offering.getGuestType()).thenReturn(GuestType.Isolated);
     final DeploymentPlan plan = mock(DeploymentPlan.class);
     final Network network = mock(Network.class);
<span class="hljs-deletion">-    final Account account = mock(Account.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `account`</span>
     final Network designednetwork = guru.design(offering, plan, network, account);
     assertTrue(designednetwork == null);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDesignNoIsolationMethodSTT</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> PhysicalNetworkVO physnet = mock(PhysicalNetworkVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(physnetdao.findById((Long) any())).thenReturn(physnet);

    when(physnet.getIsolationMethods()).thenReturn(Arrays.asList(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"VLAN"</span> }));

    when(physnet.getId()).thenReturn(NETWORK_ID);

    mock(NiciraNvpDeviceVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(nvpdao.listByPhysicalNetwork(NETWORK_ID)).thenReturn(Collections.&lt;NiciraNvpDeviceVO&gt;emptyList());

    <span class="hljs-keyword">final</span> NetworkOffering offering = mock(NetworkOffering<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(offering.getId()).thenReturn(NETWORK_ID);

    when(offering.getTrafficType()).thenReturn(TrafficType.Guest);

    when(offering.getGuestType()).thenReturn(GuestType.Isolated);

    <span class="hljs-keyword">final</span> DeploymentPlan plan = mock(DeploymentPlan<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Account account = mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network designednetwork = guru.design(offering, plan, network, account);

    assertTrue(designednetwork == <span class="hljs-keyword">null</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> Account account;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    account = mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1724">Test Case ID #cloudstack_Test_172_4</h4>
<h4 id="test-case-name-testdesignnoconnectivityinofferingfile-cjavaprojectsapachecloudstackpluginsnetwork-elementsnicira-nvpsrctestjavacomcloudnetworkguruniciranvpguestnetworkgurutestjava">Test Case Name: <code>testDesignNoConnectivityInOffering</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\nicira-nvp\src\test\java\com\cloud\network\guru\NiciraNvpGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-account">Mock Object Variable Name: <code>account</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testDesignNoConnectivityInOffering() {
     final PhysicalNetworkVO physnet = mock(PhysicalNetworkVO.class);
     when(physnetdao.findById((Long) any())).thenReturn(physnet);
     when(physnet.getIsolationMethods()).thenReturn(Arrays.asList(new String[] { "STT", "VXLAN" }));
     when(physnet.getId()).thenReturn(NETWORK_ID);
     final NiciraNvpDeviceVO device = mock(NiciraNvpDeviceVO.class);
     when(nvpdao.listByPhysicalNetwork(NETWORK_ID)).thenReturn(Arrays.asList(new NiciraNvpDeviceVO[] { device }));
     when(device.getId()).thenReturn(1L);
     final NetworkOffering offering = mock(NetworkOffering.class);
     when(offering.getId()).thenReturn(NETWORK_ID);
     when(offering.getTrafficType()).thenReturn(TrafficType.Guest);
     when(offering.getGuestType()).thenReturn(GuestType.Isolated);
     when(nosd.areServicesSupportedByNetworkOffering(NETWORK_ID, Service.Connectivity)).thenReturn(false);
     final DeploymentPlan plan = mock(DeploymentPlan.class);
     final Network network = mock(Network.class);
<span class="hljs-deletion">-    final Account account = mock(Account.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `account`</span>
     final Network designednetwork = guru.design(offering, plan, network, account);
     assertTrue(designednetwork == null);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDesignNoConnectivityInOffering</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> PhysicalNetworkVO physnet = mock(PhysicalNetworkVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(physnetdao.findById((Long) any())).thenReturn(physnet);

    when(physnet.getIsolationMethods()).thenReturn(Arrays.asList(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"STT"</span>, <span class="hljs-string">"VXLAN"</span> }));

    when(physnet.getId()).thenReturn(NETWORK_ID);

    <span class="hljs-keyword">final</span> NiciraNvpDeviceVO device = mock(NiciraNvpDeviceVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(nvpdao.listByPhysicalNetwork(NETWORK_ID)).thenReturn(Arrays.asList(<span class="hljs-keyword">new</span> NiciraNvpDeviceVO[] { device }));

    when(device.getId()).thenReturn(<span class="hljs-number">1L</span>);

    <span class="hljs-keyword">final</span> NetworkOffering offering = mock(NetworkOffering<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(offering.getId()).thenReturn(NETWORK_ID);

    when(offering.getTrafficType()).thenReturn(TrafficType.Guest);

    when(offering.getGuestType()).thenReturn(GuestType.Isolated);

    when(nosd.areServicesSupportedByNetworkOffering(NETWORK_ID, Service.Connectivity)).thenReturn(<span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">final</span> DeploymentPlan plan = mock(DeploymentPlan<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Account account = mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network designednetwork = guru.design(offering, plan, network, account);

    assertTrue(designednetwork == <span class="hljs-keyword">null</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> Account account;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    account = mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci173">Mock Clone Instance #cloudstack_MCI_173</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>com.cloud.user.Account</code></li>
<li><strong>Test Case Count</strong>: 3</li>
<li><strong>MO Count</strong>: 3</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> Account account;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    account = mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest1731">Test Case ID #cloudstack_Test_173_1</h4>
<h4 id="test-case-name-testdesignfile-cjavaprojectsapachecloudstackpluginsnetwork-elementsbrocade-vcssrctestjavacomcloudnetworkgurubrocadevcsguestnetworkgurutestjava">Test Case Name: <code>testDesign</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\brocade-vcs\src\test\java\com\cloud\network\guru\BrocadeVcsGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-account">Mock Object Variable Name: <code>account</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testDesign() {
     final PhysicalNetworkVO physnet = mock(PhysicalNetworkVO.class);
     when(physnetdao.findById((Long) any())).thenReturn(physnet);
     when(physnet.getIsolationMethods()).thenReturn(Arrays.asList(new String[] { "VCS" }));
     when(physnet.getId()).thenReturn(NETWORK_ID);
     final NetworkOffering offering = mock(NetworkOffering.class);
     when(offering.getId()).thenReturn(NETWORK_ID);
     when(offering.getTrafficType()).thenReturn(TrafficType.Guest);
     when(offering.getGuestType()).thenReturn(GuestType.Isolated);
     when(nosd.areServicesSupportedByNetworkOffering(NETWORK_ID, Service.Connectivity)).thenReturn(true);
     when(netmodel.listNetworkOfferingServices(NETWORK_ID)).thenReturn(Arrays.asList(Service.Connectivity));
     final DeploymentPlan plan = mock(DeploymentPlan.class);
     final Network network = mock(Network.class);
<span class="hljs-deletion">-    final Account account = mock(Account.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `account`</span>
     final Network designednetwork = guru.design(offering, plan, network, account);
     assertTrue(designednetwork != null);
     assertTrue(designednetwork.getBroadcastDomainType() == BroadcastDomainType.Vcs);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDesign</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> PhysicalNetworkVO physnet = mock(PhysicalNetworkVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(physnetdao.findById((Long) any())).thenReturn(physnet);

    when(physnet.getIsolationMethods()).thenReturn(Arrays.asList(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"VCS"</span> }));

    when(physnet.getId()).thenReturn(NETWORK_ID);

    <span class="hljs-keyword">final</span> NetworkOffering offering = mock(NetworkOffering<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(offering.getId()).thenReturn(NETWORK_ID);

    when(offering.getTrafficType()).thenReturn(TrafficType.Guest);

    when(offering.getGuestType()).thenReturn(GuestType.Isolated);

    when(nosd.areServicesSupportedByNetworkOffering(NETWORK_ID, Service.Connectivity)).thenReturn(<span class="hljs-keyword">true</span>);

    when(netmodel.listNetworkOfferingServices(NETWORK_ID)).thenReturn(Arrays.asList(Service.Connectivity));

    <span class="hljs-keyword">final</span> DeploymentPlan plan = mock(DeploymentPlan<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Account account = mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network designednetwork = guru.design(offering, plan, network, account);

    assertTrue(designednetwork != <span class="hljs-keyword">null</span>);

    assertTrue(designednetwork.getBroadcastDomainType() == BroadcastDomainType.Vcs);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> Account account;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    account = mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1732">Test Case ID #cloudstack_Test_173_2</h4>
<h4 id="test-case-name-testdesignnoisolationmethodvcsfile-cjavaprojectsapachecloudstackpluginsnetwork-elementsbrocade-vcssrctestjavacomcloudnetworkgurubrocadevcsguestnetworkgurutestjava">Test Case Name: <code>testDesignNoIsolationMethodVCS</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\brocade-vcs\src\test\java\com\cloud\network\guru\BrocadeVcsGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-account">Mock Object Variable Name: <code>account</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testDesignNoIsolationMethodVCS() {
     final PhysicalNetworkVO physnet = mock(PhysicalNetworkVO.class);
     when(physnetdao.findById((Long) any())).thenReturn(physnet);
     when(physnet.getIsolationMethods()).thenReturn(Arrays.asList(new String[] { "VLAN" }));
     when(physnet.getId()).thenReturn(NETWORK_ID);
     final NetworkOffering offering = mock(NetworkOffering.class);
     when(offering.getId()).thenReturn(NETWORK_ID);
     when(offering.getTrafficType()).thenReturn(TrafficType.Guest);
     when(offering.getGuestType()).thenReturn(GuestType.Isolated);
     final DeploymentPlan plan = mock(DeploymentPlan.class);
     final Network network = mock(Network.class);
<span class="hljs-deletion">-    final Account account = mock(Account.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `account`</span>
     final Network designednetwork = guru.design(offering, plan, network, account);
     assertTrue(designednetwork == null);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDesignNoIsolationMethodVCS</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> PhysicalNetworkVO physnet = mock(PhysicalNetworkVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(physnetdao.findById((Long) any())).thenReturn(physnet);

    when(physnet.getIsolationMethods()).thenReturn(Arrays.asList(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"VLAN"</span> }));

    when(physnet.getId()).thenReturn(NETWORK_ID);

    <span class="hljs-keyword">final</span> NetworkOffering offering = mock(NetworkOffering<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(offering.getId()).thenReturn(NETWORK_ID);

    when(offering.getTrafficType()).thenReturn(TrafficType.Guest);

    when(offering.getGuestType()).thenReturn(GuestType.Isolated);

    <span class="hljs-keyword">final</span> DeploymentPlan plan = mock(DeploymentPlan<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Account account = mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network designednetwork = guru.design(offering, plan, network, account);

    assertTrue(designednetwork == <span class="hljs-keyword">null</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> Account account;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    account = mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1733">Test Case ID #cloudstack_Test_173_3</h4>
<h4 id="test-case-name-testdesignnoconnectivityinofferingfile-cjavaprojectsapachecloudstackpluginsnetwork-elementsbrocade-vcssrctestjavacomcloudnetworkgurubrocadevcsguestnetworkgurutestjava">Test Case Name: <code>testDesignNoConnectivityInOffering</code>(File: <code>C:\Java_projects\Apache\cloudstack\plugins\network-elements\brocade-vcs\src\test\java\com\cloud\network\guru\BrocadeVcsGuestNetworkGuruTest.java</code>)</h4>
<h4 id="mock-object-variable-name-account">Mock Object Variable Name: <code>account</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
 @Test
 public void testDesignNoConnectivityInOffering() {
     final PhysicalNetworkVO physnet = mock(PhysicalNetworkVO.class);
     when(physnetdao.findById((Long) any())).thenReturn(physnet);
     when(physnet.getIsolationMethods()).thenReturn(Arrays.asList(new String[] { "VCS" }));
     when(physnet.getId()).thenReturn(NETWORK_ID);
     final NetworkOffering offering = mock(NetworkOffering.class);
     when(offering.getId()).thenReturn(NETWORK_ID);
     when(offering.getTrafficType()).thenReturn(TrafficType.Guest);
     when(offering.getGuestType()).thenReturn(GuestType.Isolated);
     when(nosd.areServicesSupportedByNetworkOffering(NETWORK_ID, Service.Connectivity)).thenReturn(false);
     final DeploymentPlan plan = mock(DeploymentPlan.class);
     final Network network = mock(Network.class);
<span class="hljs-deletion">-    final Account account = mock(Account.class);</span>
<span class="hljs-addition">+    // removed local mock; replaced with global field `account`</span>
     final Network designednetwork = guru.design(offering, plan, network, account);
     assertTrue(designednetwork == null);
 }
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDesignNoConnectivityInOffering</span><span class="hljs-params">()</span> </span>{

    <span class="hljs-keyword">final</span> PhysicalNetworkVO physnet = mock(PhysicalNetworkVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(physnetdao.findById((Long) any())).thenReturn(physnet);

    when(physnet.getIsolationMethods()).thenReturn(Arrays.asList(<span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"VCS"</span> }));

    when(physnet.getId()).thenReturn(NETWORK_ID);

    <span class="hljs-keyword">final</span> NetworkOffering offering = mock(NetworkOffering<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    when(offering.getId()).thenReturn(NETWORK_ID);

    when(offering.getTrafficType()).thenReturn(TrafficType.Guest);

    when(offering.getGuestType()).thenReturn(GuestType.Isolated);

    when(nosd.areServicesSupportedByNetworkOffering(NETWORK_ID, Service.Connectivity)).thenReturn(<span class="hljs-keyword">false</span>);

    <span class="hljs-keyword">final</span> DeploymentPlan plan = mock(DeploymentPlan<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network network = mock(Network<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Account account = mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-keyword">final</span> Network designednetwork = guru.design(offering, plan, network, account);

    assertTrue(designednetwork == <span class="hljs-keyword">null</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-keyword">private</span> Account account;

<span class="hljs-meta">@BeforeEach</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUp</span><span class="hljs-params">()</span> </span>{
    account = mock(Account<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
}
</div></code></pre>
</details>
<hr>
<h2 id="mock-clone-instance-cloudstackmci174">Mock Clone Instance #cloudstack_MCI_174</h2>
<ul>
<li><strong>Scope</strong>: method level</li>
<li><strong>Mocked Class</strong>: <code>java.util.Map&lt;java.lang.String, org.apache.cloudstack.auth.UserTwoFactorAuthenticator&gt;</code></li>
<li><strong>Test Case Count</strong>: 4</li>
<li><strong>MO Count</strong>: 4</li>
</ul>
<h3 id="reusable-method">Reusable Method</h3>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, UserTwoFactorAuthenticator&gt; <span class="hljs-title">createUserTwoFactorAuthenticationProvidersMap</span><span class="hljs-params">(String providerKey, UserTwoFactorAuthenticator providerInstance)</span> </span>{
    Map&lt;String, UserTwoFactorAuthenticator&gt; userTwoFactorAuthenticationProvidersMap = Mockito.mock(HashMap<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(userTwoFactorAuthenticationProvidersMap.containsKey(providerKey)).thenReturn(<span class="hljs-keyword">true</span>);
    Mockito.when(userTwoFactorAuthenticationProvidersMap.get(providerKey)).thenReturn(providerInstance);
    <span class="hljs-keyword">return</span> userTwoFactorAuthenticationProvidersMap;
}
</div></code></pre>
<h3 id="the-refactoring-details-in-each-test-cases">The refactoring details in each test cases</h3>
<hr>
<h4 id="test-case-id-cloudstacktest1741">Test Case ID #cloudstack_Test_174_1</h4>
<h4 id="test-case-name-testenableusertwofactorauthenticationwhenprovidernameisnullexpecteddefaultprovidertotpfile-cjavaprojectsapachecloudstackserversrctestjavacomclouduseraccountmanagerimpltestjava">Test Case Name: <code>testEnableUserTwoFactorAuthenticationWhenProviderNameIsNullExpectedDefaultProviderTOTP</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\user\AccountManagerImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-usertwofactorauthenticationprovidersmap">Mock Object Variable Name: <code>userTwoFactorAuthenticationProvidersMap</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     UserTwoFactorAuthenticator totpProvider = Mockito.mock(UserTwoFactorAuthenticator.class);
<span class="hljs-deletion">-    Map&lt;String, UserTwoFactorAuthenticator&gt; userTwoFactorAuthenticationProvidersMap = Mockito.mock(HashMap.class);</span>
<span class="hljs-deletion">-    Mockito.when(userTwoFactorAuthenticationProvidersMap.containsKey("totp")).thenReturn(true);</span>
<span class="hljs-deletion">-    Mockito.when(userTwoFactorAuthenticationProvidersMap.get("totp")).thenReturn(totpProvider);</span>
<span class="hljs-addition">+    Map&lt;String, UserTwoFactorAuthenticator&gt; userTwoFactorAuthenticationProvidersMap = Mockito.mock(HashMap.class);</span>
<span class="hljs-addition">+    Mockito.when(userTwoFactorAuthenticationProvidersMap.containsKey("totp")).thenReturn(true);</span>
<span class="hljs-addition">+    Mockito.when(userTwoFactorAuthenticationProvidersMap.get("totp")).thenReturn(totpProvider);</span>
     AccountManagerImpl.userTwoFactorAuthenticationProvidersMap = userTwoFactorAuthenticationProvidersMap;
     Mockito.when(totpProvider.setup2FAKey(userAccount)).thenReturn("EUJEAEDVOURFZTE6OGWVTJZMI54QGMIL");
     Mockito.when(userDaoMock.createForUpdate()).thenReturn(userVoMock);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testEnableUserTwoFactorAuthenticationWhenProviderNameIsNullExpectedDefaultProviderTOTP</span><span class="hljs-params">()</span> </span>{

    Long userId = <span class="hljs-number">1L</span>;

    UserAccountVO userAccount = Mockito.mock(UserAccountVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    UserVO userVO = Mockito.mock(UserVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(userAccountDaoMock.findById(userId)).thenReturn(userAccount);

    Mockito.when(userDaoMock.findById(userId)).thenReturn(userVO);

    Mockito.when(userAccount.getDomainId()).thenReturn(<span class="hljs-number">1L</span>);

    ConfigKey&lt;Boolean&gt; enableUserTwoFactorAuthentication = Mockito.mock(ConfigKey<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AccountManagerImpl.enableUserTwoFactorAuthentication = enableUserTwoFactorAuthentication;

    Mockito.when(enableUserTwoFactorAuthentication.valueIn(<span class="hljs-number">1L</span>)).thenReturn(<span class="hljs-keyword">true</span>);

    UserTwoFactorAuthenticator totpProvider = Mockito.mock(UserTwoFactorAuthenticator<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Map&lt;String, UserTwoFactorAuthenticator&gt; userTwoFactorAuthenticationProvidersMap = Mockito.mock(HashMap<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(userTwoFactorAuthenticationProvidersMap.containsKey(<span class="hljs-string">"totp"</span>)).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(userTwoFactorAuthenticationProvidersMap.get(<span class="hljs-string">"totp"</span>)).thenReturn(totpProvider);

    AccountManagerImpl.userTwoFactorAuthenticationProvidersMap = userTwoFactorAuthenticationProvidersMap;

    Mockito.when(totpProvider.setup2FAKey(userAccount)).thenReturn(<span class="hljs-string">"EUJEAEDVOURFZTE6OGWVTJZMI54QGMIL"</span>);

    Mockito.when(userDaoMock.createForUpdate()).thenReturn(userVoMock);

    Mockito.when(userDaoMock.update(userId, userVoMock)).thenReturn(<span class="hljs-keyword">true</span>);

    UserTwoFactorAuthenticationSetupResponse response = accountManagerImpl.enableTwoFactorAuthentication(userId, <span class="hljs-keyword">null</span>);

    Assert.assertEquals(<span class="hljs-string">"EUJEAEDVOURFZTE6OGWVTJZMI54QGMIL"</span>, response.getSecretCode());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, UserTwoFactorAuthenticator&gt; <span class="hljs-title">createUserTwoFactorAuthenticationProvidersMap</span><span class="hljs-params">(String providerKey, UserTwoFactorAuthenticator providerInstance)</span> </span>{
    Map&lt;String, UserTwoFactorAuthenticator&gt; userTwoFactorAuthenticationProvidersMap = Mockito.mock(HashMap<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(userTwoFactorAuthenticationProvidersMap.containsKey(providerKey)).thenReturn(<span class="hljs-keyword">true</span>);
    Mockito.when(userTwoFactorAuthenticationProvidersMap.get(providerKey)).thenReturn(providerInstance);
    <span class="hljs-keyword">return</span> userTwoFactorAuthenticationProvidersMap;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1742">Test Case ID #cloudstack_Test_174_2</h4>
<h4 id="test-case-name-testenableusertwofactorauthenticationfile-cjavaprojectsapachecloudstackserversrctestjavacomclouduseraccountmanagerimpltestjava">Test Case Name: <code>testEnableUserTwoFactorAuthentication</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\user\AccountManagerImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-usertwofactorauthenticationprovidersmap">Mock Object Variable Name: <code>userTwoFactorAuthenticationProvidersMap</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     UserTwoFactorAuthenticator totpProvider = Mockito.mock(UserTwoFactorAuthenticator.class);
<span class="hljs-deletion">-    Map&lt;String, UserTwoFactorAuthenticator&gt; userTwoFactorAuthenticationProvidersMap = Mockito.mock(HashMap.class);</span>
<span class="hljs-deletion">-    Mockito.when(userTwoFactorAuthenticationProvidersMap.containsKey("totp")).thenReturn(true);</span>
<span class="hljs-deletion">-    Mockito.when(userTwoFactorAuthenticationProvidersMap.get("totp")).thenReturn(totpProvider);</span>
<span class="hljs-addition">+    Map&lt;String, UserTwoFactorAuthenticator&gt; userTwoFactorAuthenticationProvidersMap = Mockito.mock(HashMap.class);</span>
<span class="hljs-addition">+    Mockito.when(userTwoFactorAuthenticationProvidersMap.containsKey("totp")).thenReturn(true);</span>
<span class="hljs-addition">+    Mockito.when(userTwoFactorAuthenticationProvidersMap.get("totp")).thenReturn(totpProvider);</span>
     AccountManagerImpl.userTwoFactorAuthenticationProvidersMap = userTwoFactorAuthenticationProvidersMap;
     Mockito.when(totpProvider.setup2FAKey(userAccount)).thenReturn("EUJEAEDVOURFZTE6OGWVTJZMI54QGMIL");
     Mockito.when(userDaoMock.createForUpdate()).thenReturn(userVoMock);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testEnableUserTwoFactorAuthentication</span><span class="hljs-params">()</span> </span>{

    Long userId = <span class="hljs-number">1L</span>;

    UserAccountVO userAccount = Mockito.mock(UserAccountVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    UserVO userVO = Mockito.mock(UserVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(userAccountDaoMock.findById(userId)).thenReturn(userAccount);

    Mockito.when(userDaoMock.findById(userId)).thenReturn(userVO);

    Mockito.when(userAccount.getDomainId()).thenReturn(<span class="hljs-number">1L</span>);

    ConfigKey&lt;Boolean&gt; enableUserTwoFactorAuthentication = Mockito.mock(ConfigKey<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    AccountManagerImpl.enableUserTwoFactorAuthentication = enableUserTwoFactorAuthentication;

    Mockito.when(enableUserTwoFactorAuthentication.valueIn(<span class="hljs-number">1L</span>)).thenReturn(<span class="hljs-keyword">true</span>);

    UserTwoFactorAuthenticator totpProvider = Mockito.mock(UserTwoFactorAuthenticator<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Map&lt;String, UserTwoFactorAuthenticator&gt; userTwoFactorAuthenticationProvidersMap = Mockito.mock(HashMap<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(userTwoFactorAuthenticationProvidersMap.containsKey(<span class="hljs-string">"totp"</span>)).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(userTwoFactorAuthenticationProvidersMap.get(<span class="hljs-string">"totp"</span>)).thenReturn(totpProvider);

    AccountManagerImpl.userTwoFactorAuthenticationProvidersMap = userTwoFactorAuthenticationProvidersMap;

    Mockito.when(totpProvider.setup2FAKey(userAccount)).thenReturn(<span class="hljs-string">"EUJEAEDVOURFZTE6OGWVTJZMI54QGMIL"</span>);

    Mockito.when(userDaoMock.createForUpdate()).thenReturn(userVoMock);

    Mockito.when(userDaoMock.update(userId, userVoMock)).thenReturn(<span class="hljs-keyword">true</span>);

    UserTwoFactorAuthenticationSetupResponse response = accountManagerImpl.enableTwoFactorAuthentication(userId, <span class="hljs-string">"totp"</span>);

    Assert.assertEquals(<span class="hljs-string">"EUJEAEDVOURFZTE6OGWVTJZMI54QGMIL"</span>, response.getSecretCode());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, UserTwoFactorAuthenticator&gt; <span class="hljs-title">createUserTwoFactorAuthenticationProvidersMap</span><span class="hljs-params">(String providerKey, UserTwoFactorAuthenticator providerInstance)</span> </span>{
    Map&lt;String, UserTwoFactorAuthenticator&gt; userTwoFactorAuthenticationProvidersMap = Mockito.mock(HashMap<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(userTwoFactorAuthenticationProvidersMap.containsKey(providerKey)).thenReturn(<span class="hljs-keyword">true</span>);
    Mockito.when(userTwoFactorAuthenticationProvidersMap.get(providerKey)).thenReturn(providerInstance);
    <span class="hljs-keyword">return</span> userTwoFactorAuthenticationProvidersMap;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1743">Test Case ID #cloudstack_Test_174_3</h4>
<h4 id="test-case-name-testverify2facodefile-cjavaprojectsapachecloudstackserversrctestjavacomclouduseraccountmanagerimpltestjava">Test Case Name: <code>testVerify2FAcode</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\user\AccountManagerImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-usertwofactorauthenticationprovidersmap">Mock Object Variable Name: <code>userTwoFactorAuthenticationProvidersMap</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     UserTwoFactorAuthenticator staticpinProvider = Mockito.mock(UserTwoFactorAuthenticator.class);
<span class="hljs-deletion">-    Map&lt;String, UserTwoFactorAuthenticator&gt; userTwoFactorAuthenticationProvidersMap = Mockito.mock(HashMap.class);</span>
<span class="hljs-deletion">-    Mockito.when(userTwoFactorAuthenticationProvidersMap.containsKey("staticpin")).thenReturn(true);</span>
<span class="hljs-deletion">-    Mockito.when(userTwoFactorAuthenticationProvidersMap.get("staticpin")).thenReturn(staticpinProvider);</span>
<span class="hljs-addition">+    Map&lt;String, UserTwoFactorAuthenticator&gt; userTwoFactorAuthenticationProvidersMap = Mockito.mock(HashMap.class);</span>
<span class="hljs-addition">+    Mockito.when(userTwoFactorAuthenticationProvidersMap.containsKey("staticpin")).thenReturn(true);</span>
<span class="hljs-addition">+    Mockito.when(userTwoFactorAuthenticationProvidersMap.get("staticpin")).thenReturn(staticpinProvider);</span>
     AccountManagerImpl.userTwoFactorAuthenticationProvidersMap = userTwoFactorAuthenticationProvidersMap;
     accountManagerImpl.verifyUsingTwoFactorAuthenticationCode("352352", 1L, 1L);
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testVerify2FAcode</span><span class="hljs-params">()</span> </span>{

    AccountVO accountMock = Mockito.mock(AccountVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Account caller = CallContext.current().getCallingAccount();

    Mockito.when(caller.getId()).thenReturn(<span class="hljs-number">1L</span>);

    Mockito.lenient().when(_accountService.getActiveAccountById(<span class="hljs-number">1L</span>)).thenReturn(accountMock);

    Mockito.when(_accountService.getUserAccountById(<span class="hljs-number">1L</span>)).thenReturn(userAccountVO);

    Mockito.when(userAccountVO.isUser2faEnabled()).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(userAccountVO.getUser2faProvider()).thenReturn(<span class="hljs-string">"staticpin"</span>);

    Mockito.when(userAccountVO.getKeyFor2fa()).thenReturn(<span class="hljs-string">"352352"</span>);

    UserTwoFactorAuthenticator staticpinProvider = Mockito.mock(UserTwoFactorAuthenticator<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Map&lt;String, UserTwoFactorAuthenticator&gt; userTwoFactorAuthenticationProvidersMap = Mockito.mock(HashMap<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(userTwoFactorAuthenticationProvidersMap.containsKey(<span class="hljs-string">"staticpin"</span>)).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(userTwoFactorAuthenticationProvidersMap.get(<span class="hljs-string">"staticpin"</span>)).thenReturn(staticpinProvider);

    AccountManagerImpl.userTwoFactorAuthenticationProvidersMap = userTwoFactorAuthenticationProvidersMap;

    accountManagerImpl.verifyUsingTwoFactorAuthenticationCode(<span class="hljs-string">"352352"</span>, <span class="hljs-number">1L</span>, <span class="hljs-number">1L</span>);

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, UserTwoFactorAuthenticator&gt; <span class="hljs-title">createUserTwoFactorAuthenticationProvidersMap</span><span class="hljs-params">(String providerKey, UserTwoFactorAuthenticator providerInstance)</span> </span>{
    Map&lt;String, UserTwoFactorAuthenticator&gt; userTwoFactorAuthenticationProvidersMap = Mockito.mock(HashMap<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(userTwoFactorAuthenticationProvidersMap.containsKey(providerKey)).thenReturn(<span class="hljs-keyword">true</span>);
    Mockito.when(userTwoFactorAuthenticationProvidersMap.get(providerKey)).thenReturn(providerInstance);
    <span class="hljs-keyword">return</span> userTwoFactorAuthenticationProvidersMap;
}
</div></code></pre>
</details>
<hr>
<h4 id="test-case-id-cloudstacktest1744">Test Case ID #cloudstack_Test_174_4</h4>
<h4 id="test-case-name-testenable2facodefile-cjavaprojectsapachecloudstackserversrctestjavacomclouduseraccountmanagerimpltestjava">Test Case Name: <code>testEnable2FAcode</code>(File: <code>C:\Java_projects\Apache\cloudstack\server\src\test\java\com\cloud\user\AccountManagerImplTest.java</code>)</h4>
<h4 id="mock-object-variable-name-usertwofactorauthenticationprovidersmap">Mock Object Variable Name: <code>userTwoFactorAuthenticationProvidersMap</code></h4>
<summary>Suggested Diff</summary>
<pre class="hljs"><code><div>
@@
     UserTwoFactorAuthenticator staticpinProvider = Mockito.mock(UserTwoFactorAuthenticator.class);
<span class="hljs-deletion">-    Map&lt;String, UserTwoFactorAuthenticator&gt; userTwoFactorAuthenticationProvidersMap = Mockito.mock(HashMap.class);</span>
<span class="hljs-deletion">-    Mockito.when(userTwoFactorAuthenticationProvidersMap.containsKey("staticpin")).thenReturn(true);</span>
<span class="hljs-deletion">-    Mockito.when(userTwoFactorAuthenticationProvidersMap.get("staticpin")).thenReturn(staticpinProvider);</span>
<span class="hljs-addition">+    Map&lt;String, UserTwoFactorAuthenticator&gt; userTwoFactorAuthenticationProvidersMap = Mockito.mock(HashMap.class);</span>
<span class="hljs-addition">+    Mockito.when(userTwoFactorAuthenticationProvidersMap.containsKey("staticpin")).thenReturn(true);</span>
<span class="hljs-addition">+    Mockito.when(userTwoFactorAuthenticationProvidersMap.get("staticpin")).thenReturn(staticpinProvider);</span>
     Mockito.when(staticpinProvider.setup2FAKey(userAccountVO)).thenReturn("345543");
     Mockito.when(userDaoMock.createForUpdate()).thenReturn(userVoMock);
     AccountManagerImpl.userTwoFactorAuthenticationProvidersMap = userTwoFactorAuthenticationProvidersMap;
</div></code></pre>
<details><summary>Original Test Code (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-meta">@Test</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testEnable2FAcode</span><span class="hljs-params">()</span> </span>{

    SetupUserTwoFactorAuthenticationCmd cmd = Mockito.mock(SetupUserTwoFactorAuthenticationCmd<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(cmd.getProvider()).thenReturn(<span class="hljs-string">"staticpin"</span>);

    AccountVO accountMock = Mockito.mock(AccountVO<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(callingAccount.getId()).thenReturn(<span class="hljs-number">1L</span>);

    Mockito.when(callingUser.getId()).thenReturn(<span class="hljs-number">1L</span>);

    <span class="hljs-comment">// Calling account is user account i.e normal account</span>

    CallContext.register(callingUser, callingAccount);

    Mockito.lenient().when(_accountService.getActiveAccountById(<span class="hljs-number">1L</span>)).thenReturn(accountMock);

    Mockito.when(userAccountDaoMock.findById(<span class="hljs-number">1L</span>)).thenReturn(userAccountVO);

    Mockito.when(userDaoMock.findById(<span class="hljs-number">1L</span>)).thenReturn(userVoMock);

    Mockito.when(userAccountVO.getDomainId()).thenReturn(<span class="hljs-number">1L</span>);

    Mockito.when(enableUserTwoFactorAuthenticationMock.valueIn(<span class="hljs-number">1L</span>)).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(cmd.getEnable()).thenReturn(<span class="hljs-keyword">true</span>);

    UserTwoFactorAuthenticator staticpinProvider = Mockito.mock(UserTwoFactorAuthenticator<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Map&lt;String, UserTwoFactorAuthenticator&gt; userTwoFactorAuthenticationProvidersMap = Mockito.mock(HashMap<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    Mockito.when(userTwoFactorAuthenticationProvidersMap.containsKey(<span class="hljs-string">"staticpin"</span>)).thenReturn(<span class="hljs-keyword">true</span>);

    Mockito.when(userTwoFactorAuthenticationProvidersMap.get(<span class="hljs-string">"staticpin"</span>)).thenReturn(staticpinProvider);

    Mockito.when(staticpinProvider.setup2FAKey(userAccountVO)).thenReturn(<span class="hljs-string">"345543"</span>);

    Mockito.when(userDaoMock.createForUpdate()).thenReturn(userVoMock);

    AccountManagerImpl.userTwoFactorAuthenticationProvidersMap = userTwoFactorAuthenticationProvidersMap;

    UserTwoFactorAuthenticationSetupResponse response = accountManagerImpl.setupUserTwoFactorAuthentication(cmd);

    Assert.assertEquals(<span class="hljs-string">"345543"</span>, response.getSecretCode());

}
</div></code></pre>
</details>
<details><summary>Reusable Method for MCI (click to expand)</summary>
<pre class="hljs"><code><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, UserTwoFactorAuthenticator&gt; <span class="hljs-title">createUserTwoFactorAuthenticationProvidersMap</span><span class="hljs-params">(String providerKey, UserTwoFactorAuthenticator providerInstance)</span> </span>{
    Map&lt;String, UserTwoFactorAuthenticator&gt; userTwoFactorAuthenticationProvidersMap = Mockito.mock(HashMap<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Mockito.when(userTwoFactorAuthenticationProvidersMap.containsKey(providerKey)).thenReturn(<span class="hljs-keyword">true</span>);
    Mockito.when(userTwoFactorAuthenticationProvidersMap.get(providerKey)).thenReturn(providerInstance);
    <span class="hljs-keyword">return</span> userTwoFactorAuthenticationProvidersMap;
}
</div></code></pre>
</details>
<hr>

</body>
</html>
